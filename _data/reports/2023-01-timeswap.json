{
  "circa": {
    "title": "Timeswap contest",
    "sponsor": "Timeswap",
    "slug": "2023-01-timeswap",
    "date": "2023-03-10",
    "findings": "https://github.com/code-423n4/2023-01-timeswap-findings/issues",
    "contest": 206
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Timeswap smart contract system written in Solidity. The audit contest took place between January 20—January 27 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>59 Wardens contributed reports to the Timeswap contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/0kage_eth\">0Kage</a></li>\n<li>0x1f8b</li>\n<li><a href=\"https://twitter.com/0xAgro\">0xAgro</a></li>\n<li>0xGusMcCrae</li>\n<li><a href=\"https://twitter.com/0xSmartContract\">0xSmartContract</a></li>\n<li>0xackermann</li>\n<li>0xcm</li>\n<li>Awesome</li>\n<li><a href=\"https://github.com/Aymen1001\">Aymen0909</a></li>\n<li>Beepidibop</li>\n<li>Breeje</li>\n<li><a href=\"https://twitter.com/DadeKuma\">DadeKuma</a></li>\n<li>Diana</li>\n<li>Ellar</li>\n<li>IllIllI</li>\n<li>Iurii3</li>\n<li>Josiah</li>\n<li>Moksha</li>\n<li>Rageur</li>\n<li>RaymondFam</li>\n<li>ReyAdmirado</li>\n<li>Rolezn</li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>SaeedAlipoor01988</li>\n<li><a href=\"https://github.com/udsene\">Udsen</a></li>\n<li>Viktor_Cortess</li>\n<li><a href=\"https://twitter.com/WorstNi43511849\">W0RR1O</a></li>\n<li>W_Max</li>\n<li><a href=\"https://github.com/romeroadrian\">adriro</a></li>\n<li>atharvasama</li>\n<li>brgltd</li>\n<li>btk</li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li>chaduke</li>\n<li><a href=\"https://twitter.com/codeIslight\">codeislight</a></li>\n<li>cryptonue</li>\n<li>ddimitrov22</li>\n<li>delfin454000</li>\n<li>descharre</li>\n<li>eierina</li>\n<li><a href=\"https://twitter.com/father0fBl0cks\">fatherOfBlocks</a></li>\n<li><a href=\"https://twitter.com/georgitsoneff\">georgits</a></li>\n<li><a href=\"https://twitter.com/GerdusM\">gerdusx</a></li>\n<li><a href=\"https://twitter.com/hansfriese\">hansfriese</a></li>\n<li><a href=\"https://twitter.com/0xKaden\">kaden</a></li>\n<li>lukris02</li>\n<li>luxartvinsec</li>\n<li><a href=\"https://github.com/martin-petrov03\">martin</a></li>\n<li>matrix_0wl</li>\n<li>mert_eren</li>\n<li>mookimgo</li>\n<li><a href=\"https://twitter.com/nadin20678790\">nadin</a></li>\n<li><a href=\"https://twitter.com/da5e8f4e\">oberon</a></li>\n<li><a href=\"https://twitter.com/@PavanKumarKv2\">pavankv</a></li>\n<li>popular00</li>\n<li>rbserver</li>\n<li>shark</li>\n<li><a href=\"https://twitter.com/0xSorryNotSorry\">sorrynotsorry</a></li>\n<li>tnevler</li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/thePicodes\">Picodes</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/itsmetechjay\">itsmetechjay</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 10 unique vulnerabilities. Of these vulnerabilities, 3 received a risk rating in the category of HIGH severity and 7 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 40 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 24 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-01-timeswap\">C4 Timeswap contest repository</a>, and is composed of 70 smart contracts written in the Solidity programming language and includes 3,605 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"high-risk-findings-3\" style=\"position:relative;\"><a href=\"#high-risk-findings-3\" aria-label=\"high risk findings 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (3)</h1>\n<h2 id=\"h-01-rebalance-logic-is-wrong-and-this-distorts-the-pools-important-states\" style=\"position:relative;\"><a href=\"#h-01-rebalance-logic-is-wrong-and-this-distorts-the-pools-important-states\" aria-label=\"h 01 rebalance logic is wrong and this distorts the pools important states permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/269\">[H-01] Rebalance logic is wrong and this distorts the pool’s important states</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/269\">hansfriese</a></em></p>\n<p>The important states including <code>long0Balance, long1Balance, long1FeeGrowth, long1ProtocolFees</code> are wrongly calculated and it breaks the pool’s invariant.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The protocol provides a rebalancing functionality and the main logic is implemented in the library <code>Pool.sol</code>.\nIf <code>param.isLong0ToLong1</code> is true and the transaction is <code>TimeswapV2PoolRebalance.GivenLong1</code>, the protocol calculates the <code>long1AmountAdjustFees</code> first and the actual <code>long0Amount, longFees</code> and the final <code>long1Balance</code> is decided accordingly.</p>\n<p>The problem is it is using the wrong parameter <code>pool.long0Balance</code> while it is supposed to use <code>pool.long1Balance</code> in the line L679.</p>\n<p>This leads to wrong state calculation in the following logic. (especially L685 is setting the <code>long1Balance</code> to zero).</p>\n<p>Furthermore, the protocol is designed as a permission-less one and anyone can call <code>TimeswapV2Pool.rebalance()</code>.</p>\n<p>An attacker can abuse this to break the pool’s invariant and take profit leveraging that.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">structs</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">Pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">665</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">rebalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Pool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">TimeswapV2PoolRebalanceParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transactionFee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">protocolFee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">666</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">requireLiquidity</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">667</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">668</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">// No need to update short fee growth.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">669</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">670</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">longFees</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">671</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">672</span><span class=\"mtk1\">:             </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">transaction</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">TimeswapV2PoolRebalance</span><span class=\"mtk1\">.</span><span class=\"mtk12\">GivenLong0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">673</span><span class=\"mtk1\">:                 (</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">longFees</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">ConstantSum</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculateGivenLongIn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delta</span><span class=\"mtk1\">, </span><span class=\"mtk12\">transactionFee</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">674</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">675</span><span class=\"mtk1\">:                 </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroOutput</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">676</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">677</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Balance</span><span class=\"mtk1\"> -= (</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">longFees</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">678</span><span class=\"mtk1\">:             } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">transaction</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">TimeswapV2PoolRebalance</span><span class=\"mtk1\">.</span><span class=\"mtk12\">GivenLong1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//************************************************************</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">679</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long1AmountAdjustFees</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FeeCalculation</span><span class=\"mtk1\">.</span><span class=\"mtk11\">removeFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Balance</span><span class=\"mtk1\">, </span><span class=\"mtk12\">transactionFee</span><span class=\"mtk1\">);</span><span class=\"mtk3\">//@audit-info long0Balance -&gt; long1Balance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//************************************************************</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">680</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">681</span><span class=\"mtk1\">:                 </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delta</span><span class=\"mtk1\">) == </span><span class=\"mtk12\">long1AmountAdjustFees</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">682</span><span class=\"mtk1\">:                     </span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ConstantSum</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculateGivenLongOutAlreadyAdjustFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Balance</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">683</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">684</span><span class=\"mtk1\">:                     </span><span class=\"mtk12\">longFees</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Balance</span><span class=\"mtk1\">.</span><span class=\"mtk11\">unsafeSub</span><span class=\"mtk1\">(</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">685</span><span class=\"mtk1\">:                     </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Balance</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">686</span><span class=\"mtk1\">:                 } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">687</span><span class=\"mtk1\">:                     (</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">longFees</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">ConstantSum</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculateGivenLongOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">transactionFee</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">688</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">689</span><span class=\"mtk1\">:                     </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Balance</span><span class=\"mtk1\"> -= (</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">longFees</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">690</span><span class=\"mtk1\">:                 }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">691</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">692</span><span class=\"mtk1\">:                 </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroOutput</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">693</span><span class=\"mtk1\">:             }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">694</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">695</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Balance</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">696</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">697</span><span class=\"mtk1\">:             (</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1FeeGrowth</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1ProtocolFees</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">FeeCalculation</span><span class=\"mtk1\">.</span><span class=\"mtk11\">update</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1FeeGrowth</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1ProtocolFees</span><span class=\"mtk1\">, </span><span class=\"mtk12\">longFees</span><span class=\"mtk1\">, </span><span class=\"mtk12\">protocolFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">698</span><span class=\"mtk1\">:         } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">699</span><span class=\"mtk1\">:             </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">transaction</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">TimeswapV2PoolRebalance</span><span class=\"mtk1\">.</span><span class=\"mtk12\">GivenLong0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">700</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long0AmountAdjustFees</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FeeCalculation</span><span class=\"mtk1\">.</span><span class=\"mtk11\">removeFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Balance</span><span class=\"mtk1\">, </span><span class=\"mtk12\">transactionFee</span><span class=\"mtk1\">);</span><span class=\"mtk3\">//@audit-info</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">701</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">702</span><span class=\"mtk1\">:                 </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delta</span><span class=\"mtk1\">) == </span><span class=\"mtk12\">long0AmountAdjustFees</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">703</span><span class=\"mtk1\">:                     </span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ConstantSum</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculateGivenLongOutAlreadyAdjustFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Balance</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">704</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">705</span><span class=\"mtk1\">:                     </span><span class=\"mtk12\">longFees</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Balance</span><span class=\"mtk1\">.</span><span class=\"mtk11\">unsafeSub</span><span class=\"mtk1\">(</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">706</span><span class=\"mtk1\">:                     </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Balance</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">707</span><span class=\"mtk1\">:                 } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">708</span><span class=\"mtk1\">:                     (</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">longFees</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">ConstantSum</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculateGivenLongOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">transactionFee</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">709</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">710</span><span class=\"mtk1\">:                     </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Balance</span><span class=\"mtk1\"> -= (</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">longFees</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">711</span><span class=\"mtk1\">:                 }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">712</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">713</span><span class=\"mtk1\">:                 </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroOutput</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">714</span><span class=\"mtk1\">:             } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">transaction</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">TimeswapV2PoolRebalance</span><span class=\"mtk1\">.</span><span class=\"mtk12\">GivenLong1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">715</span><span class=\"mtk1\">:                 (</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">longFees</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">ConstantSum</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculateGivenLongIn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delta</span><span class=\"mtk1\">, </span><span class=\"mtk12\">transactionFee</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">716</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">717</span><span class=\"mtk1\">:                 </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroOutput</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">718</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">719</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Balance</span><span class=\"mtk1\"> -= (</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">longFees</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">720</span><span class=\"mtk1\">:             }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">721</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">722</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Balance</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">723</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">724</span><span class=\"mtk1\">:             (</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0FeeGrowth</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0ProtocolFees</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">FeeCalculation</span><span class=\"mtk1\">.</span><span class=\"mtk11\">update</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0FeeGrowth</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0ProtocolFees</span><span class=\"mtk1\">, </span><span class=\"mtk12\">longFees</span><span class=\"mtk1\">, </span><span class=\"mtk12\">protocolFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">725</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">726</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Fix the L679 as below.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long1AmountAdjustFees</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FeeCalculation</span><span class=\"mtk1\">.</span><span class=\"mtk11\">removeFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Balance</span><span class=\"mtk1\">, </span><span class=\"mtk12\">transactionFee</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/269#issuecomment-1422570910\">vhawk19 (Timeswap) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>Fixed here <a href=\"https://github.com/Timeswap-Labs/Timeswap-V2-Monorepo/commit/0010ad05c93a7244387d7a004822b17ec5a48596\">at this commit</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-timeswapv2liquiditytoken-should-not-use-totalsupply1-as-tokenid\" style=\"position:relative;\"><a href=\"#h-02-timeswapv2liquiditytoken-should-not-use-totalsupply1-as-tokenid\" aria-label=\"h 02 timeswapv2liquiditytoken should not use totalsupply1 as tokenid permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/219\">[H-02] TimeswapV2LiquidityToken should not use <code>totalSupply()+1</code> as tokenId</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/219\">mookimgo</a>, also found by <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/251\">hansfriese</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2LiquidityToken.sol#L114\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2LiquidityToken.sol#L114</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2Token.sol#L103\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2Token.sol#L103</a></p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Assuming ERC1155Enumerable is acting normally, there is an <strong>Accounting Issue</strong> about TimeswapV2LiquidityToken and TimeswapV2Token’s tokenId.</p>\n<p>Different liquidities can have the same <code>tokenId</code>, leading to serious balance manipulation.</p>\n<p>I’m submitting this issue as medium because current implementation ERC1155Enumerable is wrong, which exactly mitigates this issue making it not exploitable. But this issue will become dangerous once we fixed ERC1155Enumerable.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In this PoC, the attacker will do these steps:</p>\n<ol>\n<li>Add liquidity of token0 and token1, thus receiving TimeswapV2LiquidityToken tokenId 1.</li>\n<li>Add liquidity of token2 and token3, thus receiving TimeswapV2LiquidityToken tokenId 2.</li>\n<li>Burn his liquidity from step1, which will make totalSupply decrease (if ERC1155Enumerable has been patched).</li>\n<li>Add liquidity of token4 and token5, and receive TimeswapV2LiquidityToken tokenId 2. This is wrong tokenId, which should be 3.</li>\n</ol>\n<p>Explanation:</p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2LiquidityToken.sol#L112\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2LiquidityToken.sol#L112</a></p>\n<p>As the comment said, <code>if the position does not exist, create it</code>, but the new tokenId is set as <code>totalSupply() + 1</code>.</p>\n<p>Function totalSupply is defined in <code>packages/v2-token/src/base/ERC1155Enumerable.sol</code>, which is simply <code>\\_allTokens.length</code>: <a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/base/ERC1155Enumerable.sol#L37-L38\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/base/ERC1155Enumerable.sol#L37-L38</a></p>\n<p><code>\\_allTokens.length</code> can be decreased in <code>_removeTokenFromAllTokensEnumeration</code> function, which is called by <code>_removeTokenEnumeration</code>, and by <code>_afterTokenTransfer</code>. In simple words, when all token amounts for a specific tokenId are burned (<code>_idTotalSupply[id] == 0</code>), totalSupply should be decreased.</p>\n<p>Current implementation of ERC1155Enumerable has a bug, which will never trigger <code>_removeTokenFromAllTokensEnumeration</code>: Calling <code>\\_removeTokenEnumeration needs amount>0</code>, but only <code>_idTotalSupply[id] == 0</code> can trigger <code>\\_removeTokenFromAllTokensEnumeration</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _removeTokenEnumeration(address from, address to, uint256 id, uint256 amount) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (to == address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (_idTotalSupply[id] == 0 &amp;&amp; _additionalConditionRemoveTokenFromAllTokensEnumeration(id)) _removeTokenFromAllTokensEnumeration(id);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _idTotalSupply[id] -= amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p>Once the above code gets fixed (swapping the if line and <code>_idTotalSupply[id] -= amount;</code> line, patch given below), this issue becomes exploitable, making the accounting of LP wrong.</p>\n<hr>\n<p>Proof of Concept steps:</p>\n<p>First, we need to patch two contracts:</p>\n<ul>\n<li>making TimeswapV2LiquidityToken’s <code>\\_timeswapV2LiquidityTokenPositionIds</code> as public for testing, this can be removed when depolying</li>\n<li>ERC1155Enumerable’s <code>\\_removeTokenEnumeration</code> has been patched to behave correctly, which will decrease <code>totalSupply</code> when all token amount of a specific tokenId has been burned.</li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/packages/v2-token/src/TimeswapV2LiquidityToken.sol b/packages/v2-token/src/TimeswapV2LiquidityToken.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index 2f71a25..f3910d9 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/packages/v2-token/src/TimeswapV2LiquidityToken.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/packages/v2-token/src/TimeswapV2LiquidityToken.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -42,7 +42,7 @@ contract TimeswapV2LiquidityToken is ITimeswapV2LiquidityToken, ERC1155Enumerabl</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     mapping(uint256 =&gt; TimeswapV2LiquidityTokenPosition) private _timeswapV2LiquidityTokenPositions;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    mapping(bytes32 =&gt; uint256) private _timeswapV2LiquidityTokenPositionIds;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    mapping(bytes32 =&gt; uint256) public _timeswapV2LiquidityTokenPositionIds;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     mapping(uint256 =&gt; mapping(address =&gt; FeesPosition)) private _feesPositions;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/packages/v2-token/src/base/ERC1155Enumerable.sol b/packages/v2-token/src/base/ERC1155Enumerable.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index 4ec23ff..4f51fb4 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/packages/v2-token/src/base/ERC1155Enumerable.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/packages/v2-token/src/base/ERC1155Enumerable.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -91,8 +91,8 @@ abstract contract ERC1155Enumerable is IERC1155Enumerable, ERC1155 {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     /// @dev Remove token enumeration list if necessary.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     function _removeTokenEnumeration(address from, address to, uint256 id, uint256 amount) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         if (to == address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-            if (_idTotalSupply[id] == 0 &amp;&amp; _additionalConditionRemoveTokenFromAllTokensEnumeration(id)) _removeTokenFromAllTokensEnumeration(id);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             _idTotalSupply[id] -= amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+            if (_idTotalSupply[id] == 0 &amp;&amp; _additionalConditionRemoveTokenFromAllTokensEnumeration(id)) _removeTokenFromAllTokensEnumeration(id);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         if (from != address(0) &amp;&amp; from != to) {</span></span></code></pre>\n<p>Add a new test file in <code>2023-01-timeswap/packages/v2-token/test/TimeswapV2LiquidityToken_MultiMint.t.sol</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// SPDX-License-Identifier: UNLICENSED</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">pragma solidity =0.8.8;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import &quot;forge-std/Test.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import &quot;forge-std/console.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import &quot;../src/TimeswapV2LiquidityToken.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import &quot;@timeswap-labs/v2-option/src/TimeswapV2OptionFactory.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import &quot;@timeswap-labs/v2-option/src/interfaces/ITimeswapV2Option.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {TimeswapV2LiquidityTokenCollectParam} from &quot;../src/structs/Param.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import &quot;@timeswap-labs/v2-pool/src/TimeswapV2PoolFactory.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import &quot;@timeswap-labs/v2-pool/src/interfaces/ITimeswapV2Pool.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {TimeswapV2PoolMintParam} from &quot;@timeswap-labs/v2-pool/src/structs/Param.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {TimeswapV2PoolMintChoiceCallbackParam, TimeswapV2PoolMintCallbackParam} from &quot;@timeswap-labs/v2-pool/src/structs/CallbackParam.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {TimeswapV2OptionMintCallbackParam, TimeswapV2OptionSwapCallbackParam} from &quot;@timeswap-labs/v2-option/src/structs/CallbackParam.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// import &quot;@timeswap-labs/v2-option/src/TimeswapV2OptionFactory.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// // import &quot;@timeswap-labs/v2-option/src/interfaces/ITimeswapV2Option.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import &quot;@openzeppelin/contracts/token/ERC1155/utils/ERC1155Holder.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {TimeswapV2LiquidityTokenPosition, PositionLibrary} from &quot;../src/structs/Position.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {TimeswapV2PoolMint} from &quot;@timeswap-labs/v2-pool/src/enums/Transaction.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {TimeswapV2OptionMint} from &quot;@timeswap-labs/v2-option/src/enums/Transaction.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {StrikeConversion} from &quot;@timeswap-labs/v2-library/src/StrikeConversion.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {DurationCalculation} from &quot;@timeswap-labs/v2-pool/src/libraries/DurationCalculation.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {FullMath} from &quot;@timeswap-labs/v2-library/src/FullMath.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract HelperERC20 is ERC20 {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    constructor(string memory _name, string memory _symbol) ERC20(_name, _symbol) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _mint(msg.sender, type(uint256).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">struct Timestamps {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 maturity;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 timeNow;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">struct MintOutput {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint160 liquidityAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 long0Amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 long1Amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 shortAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes data;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract TimeswapV2LiquidityTokenTest is Test, ERC1155Holder {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ITimeswapV2Option opPair;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ITimeswapV2Option opPair2;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ITimeswapV2Option opPair3;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ITimeswapV2Option opPairCurrent;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    TimeswapV2OptionFactory optionFactory;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    TimeswapV2PoolFactory poolFactory;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ITimeswapV2Pool pool;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ITimeswapV2Pool pool2;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ITimeswapV2Pool pool3;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ITimeswapV2Pool poolCurrent;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    using PositionLibrary for TimeswapV2LiquidityTokenPosition;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 chosenTransactionFee = 5;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 chosenProtocolFee = 4;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    HelperERC20 token0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    HelperERC20 token1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    HelperERC20 token2;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    HelperERC20 token3;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    HelperERC20 token4;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    HelperERC20 token5;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    HelperERC20 token0Current;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    HelperERC20 token1Current;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    TimeswapV2LiquidityToken mockLiquidityToken;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function timeswapV2PoolMintChoiceCallback(TimeswapV2PoolMintChoiceCallbackParam calldata param) external returns (uint256 long0Amount, uint256 long1Amount, bytes memory data) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.assume(param.longAmount &lt; (1 &lt;&lt; 127));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        long0Amount = StrikeConversion.turn(param.longAmount / 2, param.strike, false, true) + 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        long1Amount = StrikeConversion.turn(param.longAmount / 2, param.strike, true, true) + 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.assume(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            param.longAmount &lt; StrikeConversion.combine(long0Amount, long1Amount, param.strike, false) &amp;&amp; param.shortAmount &lt; StrikeConversion.combine(long0Amount, long1Amount, param.strike, false)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function timeswapV2PoolMintCallback(TimeswapV2PoolMintCallbackParam calldata param) external returns (bytes memory data) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // have to transfer param.long0Amount, param.long1Amount and param.short to msg.sender</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(param.long0Amount, param.long1Amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        TimeswapV2OptionMintParam memory mparam = TimeswapV2OptionMintParam({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            strike: param.strike,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            maturity: param.maturity,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            long0To: msg.sender,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            long1To: msg.sender,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            shortTo: msg.sender,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            transaction: TimeswapV2OptionMint.GivenTokensAndLongs,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            amount0: param.long0Amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            amount1: param.long1Amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            data: &quot;&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        opPairCurrent.mint(mparam);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;opPair mint ok&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function timeswapV2OptionMintCallback(TimeswapV2OptionMintCallbackParam calldata param) external returns (bytes memory data) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        data = param.data;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //console.log(&quot;token0 bal:&quot;, token0.balanceOf(address(this)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //console.log(&quot;token1 bal:&quot;, token1.balanceOf(address(this)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        token0Current.transfer(msg.sender, param.token0AndLong0Amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        token1Current.transfer(msg.sender, param.token1AndLong1Amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function timeswapV2LiquidityTokenMintCallback(TimeswapV2LiquidityTokenMintCallbackParam calldata param) external returns (bytes memory data) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        TimeswapV2PoolMintParam memory param1 = TimeswapV2PoolMintParam({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            strike: param.strike, </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            maturity: param.maturity, </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            to: address(this), </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            transaction: TimeswapV2PoolMint.GivenLiquidity, </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            delta: param.liquidityAmount, </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            data: &quot;&quot;}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        poolCurrent.mint(param1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        poolCurrent.transferLiquidity(param.strike, param.maturity, msg.sender, param.liquidityAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        data = bytes(&quot;&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function setUp() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        optionFactory = new TimeswapV2OptionFactory();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        token0 = new HelperERC20(&quot;Token A&quot;, &quot;A&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        token1 = new HelperERC20(&quot;Token B&quot;, &quot;B&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        token2 = new HelperERC20(&quot;Token C&quot;, &quot;C&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        token3 = new HelperERC20(&quot;Token D&quot;, &quot;D&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        token4 = new HelperERC20(&quot;Token E&quot;, &quot;E&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        token5 = new HelperERC20(&quot;Token F&quot;, &quot;F&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (address(token1) &lt; address(token0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            (token0, token1) = (token1, token0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (address(token3) &lt; address(token2)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            (token2, token3) = (token3, token2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (address(token5) &lt; address(token4)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            (token4, token5) = (token5, token4);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address opAddress = optionFactory.create(address(token0), address(token1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        opPair = ITimeswapV2Option(opAddress);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address opAddress2 = optionFactory.create(address(token2), address(token3));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        opPair2 = ITimeswapV2Option(opAddress2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address opAddress3 = optionFactory.create(address(token4), address(token5));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        opPair3 = ITimeswapV2Option(opAddress3);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        poolFactory = new TimeswapV2PoolFactory(address(this), chosenTransactionFee, chosenProtocolFee);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pool = ITimeswapV2Pool(poolFactory.create(opAddress));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pool2 = ITimeswapV2Pool(poolFactory.create(opAddress2));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pool3 = ITimeswapV2Pool(poolFactory.create(opAddress3));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        mockLiquidityToken = new TimeswapV2LiquidityToken(address(optionFactory), address(poolFactory));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function testMint(uint256 strike, uint160 amt, uint256 maturity, uint160 rate, address to) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        setUp();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // vm.assume(strike != 0 &amp;&amp; (maturity &lt; type(uint96).max) &amp;&amp; (maturity &gt; 10000) &amp;&amp; amt &gt; 100 &amp;&amp; delta != 0 &amp;&amp; rate != 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.assume(to != address(0));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.assume(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            maturity &lt; type(uint96).max &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                amt &lt; type(uint160).max &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                amt != 0 &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                to != address(0) &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                strike != 0 &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                maturity &gt; block.timestamp &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                maturity &gt; 10000 &amp;&amp; rate&gt;0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;init&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pool.initialize(strike, maturity, rate);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pool2.initialize(strike, maturity, rate);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pool3.initialize(strike, maturity, rate);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //TimeswapV2PoolMintParam memory param = TimeswapV2PoolMintParam({strike: strike, maturity: maturity, to: address(this), transaction: TimeswapV2PoolMint.GivenLiquidity, delta: amt, data: &quot;&quot;});</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //MintOutput memory response;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //(response.liquidityAmount, response.long0Amount, response.long1Amount, response.shortAmount, response.data) = pool.mint(param);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 id1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 id2;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            token0Current = token0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            token1Current = token1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            poolCurrent = pool;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            opPairCurrent = opPair;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            TimeswapV2LiquidityTokenMintParam memory liqTokenMintParam = TimeswapV2LiquidityTokenMintParam({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                token0: address(token0Current),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                token1: address(token1Current),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                strike: strike,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                maturity: maturity,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                to: address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                liquidityAmount: amt,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                data: &quot;&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            mockLiquidityToken.mint(liqTokenMintParam);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            //console.log(mockLiquidityToken.balanceOf(address(this)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            TimeswapV2LiquidityTokenPosition memory timeswapV2LiquidityTokenPosition = TimeswapV2LiquidityTokenPosition({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                token0: address(token0Current),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                token1: address(token1Current),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                strike: strike,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                maturity: maturity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            bytes32 key1 = timeswapV2LiquidityTokenPosition.toKey();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            id1 = mockLiquidityToken._timeswapV2LiquidityTokenPositionIds(key1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;key1:&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.logBytes32(key1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;id1:&quot;, id1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            assertEq(mockLiquidityToken.balanceOf(address(this), id1), amt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            assertEq(mockLiquidityToken.totalSupply(), 1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            //console.log(&quot;_idTotalSupply id1:&quot;, mockLiquidityToken._idTotalSupply(id1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;========&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            token0Current = token2;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            token1Current = token3;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            poolCurrent = pool2;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            opPairCurrent = opPair2;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            TimeswapV2LiquidityTokenMintParam memory liqTokenMintParam2 = TimeswapV2LiquidityTokenMintParam({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                token0: address(token0Current),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                token1: address(token1Current),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                strike: strike,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                maturity: maturity,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                to: address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                liquidityAmount: amt,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                data: &quot;&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            mockLiquidityToken.mint(liqTokenMintParam2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            //console.log(mockLiquidityToken.balanceOf(address(this)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            TimeswapV2LiquidityTokenPosition memory timeswapV2LiquidityTokenPosition2 = TimeswapV2LiquidityTokenPosition({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                token0: address(token0Current),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                token1: address(token1Current),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                strike: strike,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                maturity: maturity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            bytes32 key2 = timeswapV2LiquidityTokenPosition2.toKey();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            id2 = mockLiquidityToken._timeswapV2LiquidityTokenPositionIds(key2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;key2:&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.logBytes32(key2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;id2:&quot;, id2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            assertEq(mockLiquidityToken.balanceOf(address(this), id2), amt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            assertEq(mockLiquidityToken.totalSupply(), 2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;========&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        TimeswapV2LiquidityTokenBurnParam memory burnParam = TimeswapV2LiquidityTokenBurnParam({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            token0: address(token0),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            token1: address(token1),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            strike: strike,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            maturity: maturity,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            to: address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            liquidityAmount: amt,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            data: &quot;&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        mockLiquidityToken.burn(burnParam);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;balanceOf id1:&quot;, mockLiquidityToken.balanceOf(address(this), id1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //console.log(&quot;_idTotalSupply id1:&quot;, mockLiquidityToken._idTotalSupply(id1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;current totalSupply():&quot;, mockLiquidityToken.totalSupply());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            token0Current = token4;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            token1Current = token5;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            poolCurrent = pool3;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            opPairCurrent = opPair3;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            TimeswapV2LiquidityTokenMintParam memory liqTokenMintParam3 = TimeswapV2LiquidityTokenMintParam({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                token0: address(token0Current),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                token1: address(token1Current),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                strike: strike,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                maturity: maturity,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                to: address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                liquidityAmount: amt,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                data: &quot;&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            mockLiquidityToken.mint(liqTokenMintParam3);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            //console.log(mockLiquidityToken.balanceOf(address(this)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            TimeswapV2LiquidityTokenPosition memory timeswapV2LiquidityTokenPosition3 = TimeswapV2LiquidityTokenPosition({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                token0: address(token0Current),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                token1: address(token1Current),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                strike: strike,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                maturity: maturity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            bytes32 key3 = timeswapV2LiquidityTokenPosition3.toKey();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 id3 = mockLiquidityToken._timeswapV2LiquidityTokenPositionIds(key3);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;key3:&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.logBytes32(key3);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;id3:&quot;, id3);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            //assertEq(mockLiquidityToken.balanceOf(address(this), id3), amt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (id2 == id3) {revert(&quot;id3 should not equal to id2&quot;);}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;========&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(&quot;yo&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Here is the log for the above test: <code>forge test --match-path test/TimeswapV2LiquidityToken_MultiMint.t.sol -vv</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Running 1 test for test/TimeswapV2LiquidityToken.t.sol:TimeswapV2LiquidityTokenTest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[FAIL. Reason: id3 should not equal to id2 Counterexample: calldata=0x31b83c070000000000000000000000000000000000000000000000000000000000000d77000000000000000000000000000000000000000000000000000000000000234100000000000000000000000000000000000000000000000000000000277c306f00000000000000000000000000000000000000000000000000000000000032e0000000000000000000000000000000000000000000000000000000000000025f, args=[3447, 9025, 662450287, 13024, 0x000000000000000000000000000000000000025F]] testMint(uint256,uint160,uint256,uint160,address) (runs: 0, μ: 0, ~: 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  init</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  2709883200956651719220887728062100075977988725238523898809710331 27450636006266724768954781627</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  opPair mint ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  key1:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  0x3ad1cfe6142808456d576d32877db082ef58ce80e40fb5019d9e5f73aebfde46</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  id1: 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ========</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  2709883200956651719220887728062100075977988725238523898809710331 27450636006266724768954781627</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  opPair mint ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  key2:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  0x4b911bdfb2c97775c28fae58288d53335ea7b59d3675acf0460ff4083897e18c</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  id2: 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ========</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  balanceOf id1: 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  current totalSupply(): 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  2709883200956651719220887728062100075977988725238523898809710331 27450636006266724768954781627</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  opPair mint ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  key3:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  0x6b43d3a16273d9e9f13739b825952b03e59127b9d41c4e0d9d58d635e8d2f5d2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  id3: 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Test result: FAILED. 0 passed; 1 failed; finished in 91.76ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Failing tests:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Encountered 1 failing test in test/TimeswapV2LiquidityToken.t.sol:TimeswapV2LiquidityTokenTest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[FAIL. Reason: id3 should not equal to id2 Counterexample: calldata=0x31b83c070000000000000000000000000000000000000000000000000000000000000d77000000000000000000000000000000000000000000000000000000000000234100000000000000000000000000000000000000000000000000000000277c306f00000000000000000000000000000000000000000000000000000000000032e0000000000000000000000000000000000000000000000000000000000000025f, args=[3447, 9025, 662450287, 13024, 0x000000000000000000000000000000000000025F]] testMint(uint256,uint160,uint256,uint160,address) (runs: 0, μ: 0, ~: 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Encountered a total of 1 failing tests, 0 tests succeeded</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Do not use <code>totalSupply()</code> or other maybe-decreasing variables for new tokenId.</p>\n<p>Patch file can be like this:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/packages/v2-token/src/TimeswapV2LiquidityToken.sol b/packages/v2-token/src/TimeswapV2LiquidityToken.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index 2f71a25..94e4006 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/packages/v2-token/src/TimeswapV2LiquidityToken.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/packages/v2-token/src/TimeswapV2LiquidityToken.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -32,6 +32,7 @@ contract TimeswapV2LiquidityToken is ITimeswapV2LiquidityToken, ERC1155Enumerabl</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     address public immutable optionFactory;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     address public immutable poolFactory;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    uint256 public tokenIdCounter;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     constructor(address chosenOptionFactory, address chosenPoolFactory) ERC1155(&quot;Timeswap V2 uint160 address&quot;) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         optionFactory = chosenOptionFactory;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -111,7 +112,7 @@ contract TimeswapV2LiquidityToken is ITimeswapV2LiquidityToken, ERC1155Enumerabl</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         // if the position does not exist, create it</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         if (id == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-            id = totalSupply() + 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+            id = ++tokenIdCounter;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             _timeswapV2LiquidityTokenPositions[id] = timeswapV2LiquidityTokenPosition;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             _timeswapV2LiquidityTokenPositionIds[key] = id;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/219\">Picodes (judge) increased severity to High</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/219#issuecomment-1429307516\">vhawk19 (Timeswap) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>Fixed in <a href=\"https://github.com/Timeswap-Labs/Timeswap-V2-Monorepo/pull/293\">PR</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-03-the-collect-function-will-always-transfer-zero-fees-losing-_feespositions-without-receiving-fees\" style=\"position:relative;\"><a href=\"#h-03-the-collect-function-will-always-transfer-zero-fees-losing-_feespositions-without-receiving-fees\" aria-label=\"h 03 the collect function will always transfer zero fees losing _feespositions without receiving fees permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/121\">[H-03] The <code>collect()</code> function will always TRANSFER ZERO fees, losing _feesPositions without receiving fees!</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/121\">chaduke</a>, also found by <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/153\">Beepidibop</a> and <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/150\">0xcm</a></em></p>\n<p>Detailed description of the impact of this finding.\nThe <code>collect()</code> function will always transfer ZERO fees. At the same time, non-zero <code>_feesPosition</code> will be burned.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">_feesPositions[id][msg.sender].burn(long0Fees, long1Fees, shortFees);</span></span></code></pre>\n<p>As a result, the contracts will be left in an inconsistent state. The user will burn <code>_feesPositions</code> without receiving the fees!</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Provide direct links to all referenced code in GitHub. Add screenshots, logs, or any other relevant proof that illustrates the concept.</p>\n<p>The <code>collect()</code> function will always transfer ZERO fees   in the following line:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"> // transfer the fees amount to the recipient</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ITimeswapV2Pool(poolPair).transferFees(param.strike, param.maturity, param.to, long0Fees, long1Fees, shortFees);</span></span></code></pre>\n<p>This is because, at this moment, the values of  <code>long0Fees</code>, <code>long1Fees</code>, <code>shortFees</code> have not been calculated yet, actually, they will be equal to zero. Therefore, no fees will be transferred. The values of  <code>long0Fees</code>, <code>long1Fees</code>, <code>shortFees</code> are calculated afterwards by the following line:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">(long0Fees, long1Fees, shortFees) = _feesPositions[id][msg.sender].getFees(param.long0FeesDesired, param.long1FeesDesired, param.shortFeesDesired);</span></span></code></pre>\n<p>Therefore, <code>ITimeswapV2Pool(poolPair).transferFees</code> must be called after this line to be correct.</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Remix</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>We moved the line  <code>ITimeswapV2Pool(poolPair).transferFees</code> after <code>long0Fees</code>, <code>long1Fees</code>, <code>shortFees</code> have been calculated first.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function collect(TimeswapV2LiquidityTokenCollectParam calldata param) external returns (uint256 long0Fees, uint256 long1Fees, uint256 shortFees, bytes memory data) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ParamLibrary.check(param);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes32 key = TimeswapV2LiquidityTokenPosition({token0: param.token0, token1: param.token1, strike: param.strike, maturity: param.maturity}).toKey();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // start the reentrancy guard</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        raiseGuard(key);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (, address poolPair) = PoolFactoryLibrary.getWithCheck(optionFactory, poolFactory, param.token0, param.token1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 id = _timeswapV2LiquidityTokenPositionIds[key];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _updateFeesPositions(msg.sender, address(0), id);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (long0Fees, long1Fees, shortFees) = _feesPositions[id][msg.sender].getFees(param.long0FeesDesired, param.long1FeesDesired, param.shortFeesDesired);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (param.data.length != 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            data = ITimeswapV2LiquidityTokenCollectCallback(msg.sender).timeswapV2LiquidityTokenCollectCallback(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                TimeswapV2LiquidityTokenCollectCallbackParam({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    token0: param.token0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    token1: param.token1,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    strike: param.strike,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    maturity: param.maturity,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    long0Fees: long0Fees,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    long1Fees: long1Fees,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    shortFees: shortFees,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    data: param.data</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                })</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                // transfer the fees amount to the recipient</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ITimeswapV2Pool(poolPair).transferFees(param.strike, param.maturity, param.to, long0Fees, long1Fees, shortFees);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // burn the desired fees from the fees position</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _feesPositions[id][msg.sender].burn(long0Fees, long1Fees, shortFees);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (long0Fees != 0 || long1Fees != 0 || shortFees != 0) _removeTokenEnumeration(msg.sender, address(0), id, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // stop the reentrancy guard</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lowerGuard(key);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/121#issuecomment-1422586075\">vhawk19 (Timeswap) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>Fixed in <a href=\"https://github.com/Timeswap-Labs/Timeswap-V2-Monorepo/pull/256\">PR</a>.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-7\" style=\"position:relative;\"><a href=\"#medium-risk-findings-7\" aria-label=\"medium risk findings 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (7)</h1>\n<h2 id=\"m-01-_currentindex-is-incorrectly-updated-breaking-the-erc1155-enumerable-implementation\" style=\"position:relative;\"><a href=\"#m-01-_currentindex-is-incorrectly-updated-breaking-the-erc1155-enumerable-implementation\" aria-label=\"m 01 _currentindex is incorrectly updated breaking the erc1155 enumerable implementation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/272\">[M-01] <code>_currentIndex</code> is incorrectly updated; breaking the ERC1155 enumerable implementation</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/272\">eierina</a>, also found by <a href=\"undefined\">adriro</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/3be51465583552cce76816a05170fda7da68596a/packages/v2-token/src/base/ERC1155Enumerable.sol#L92-L101\">https://github.com/code-423n4/2023-01-timeswap/blob/3be51465583552cce76816a05170fda7da68596a/packages/v2-token/src/base/ERC1155Enumerable.sol#L92-L101</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/3be51465583552cce76816a05170fda7da68596a/packages/v2-token/src/base/ERC1155Enumerable.sol#L116-L121\">https://github.com/code-423n4/2023-01-timeswap/blob/3be51465583552cce76816a05170fda7da68596a/packages/v2-token/src/base/ERC1155Enumerable.sol#L116-L121</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/3be51465583552cce76816a05170fda7da68596a/packages/v2-token/src/base/ERC1155Enumerable.sol#L136-L149\">https://github.com/code-423n4/2023-01-timeswap/blob/3be51465583552cce76816a05170fda7da68596a/packages/v2-token/src/base/ERC1155Enumerable.sol#L136-L149</a></p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>When minting and burning tokens,the ERC1155Enumerable implementation does not correctly update the following states:</p>\n<ul>\n<li>uint256[] private _allTokens;</li>\n<li>mapping(uint256 => uint256) private _allTokensIndex;</li>\n<li>mapping(address => uint256) internal _currentIndex;</li>\n</ul>\n<p>In particular:</p>\n<ul>\n<li>the _allTokens array length (and therefore the totalSupply()) always increases (never decreases)</li>\n<li>the _allTokensIndex[id] always increases</li>\n<li>the _curentIndex[from] always increases</li>\n</ul>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>NOTE: the following test requires some private states of ERC1155Enumerable.sol to be set from private to internal.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">HelperERC1155</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ERC1155Enumerable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ERC1155Holder</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() </span><span class=\"mtk11\">ERC1155</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Test&quot;</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">currentIndex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currentIndex</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">allTokensIndex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_allTokensIndex</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">allTokens</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">idx</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_allTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">idx</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">idTotalSupply</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_idTotalSupply</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BugTest</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Test</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ERC1155Holder</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testImplError</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">HelperERC1155</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">HelperERC1155</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">10</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">+</span><span class=\"mtk12\">i</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">10</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">+</span><span class=\"mtk12\">i</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">idTotalSupply</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// OK</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">allTokensIndex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">), </span><span class=\"mtk12\">i</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// NOT OK (should be 0)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">10</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// NOT OK (should be 0)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">currentIndex</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">10</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// NOT OK (should be 0)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testImplFixed</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">HelperERC1155</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">HelperERC1155</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">10</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">+</span><span class=\"mtk12\">i</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">10</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">+</span><span class=\"mtk12\">i</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">idTotalSupply</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// OK</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">allTokensIndex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// OK</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// OK</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">currentIndex</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// OK</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Before fix <code>forge test --match-contract BugTest -vvv</code> outputs:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Running 2 tests for test/Audit2.t.sol:BugTest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testImplError() (gas: 2490610)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[FAIL. Reason: Assertion failed.] testImplFixed() (gas: 2560628)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Test result: FAILED. 1 passed; 1 failed; finished in 2.05ms</span></span></code></pre>\n<p>After fix <code>forge test --match-contract BugTest -vvv</code> outputs:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Running 2 tests for test/Audit2.t.sol:BugTest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[FAIL. Reason: Assertion failed.] testImplError() (gas: 2558695)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testImplFixed() (gas: 2489080)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Test result: FAILED. 1 passed; 1 failed; finished in 2.22ms</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Correct the implementation to update states correctly. Patch provided below for reference.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">diff</span><span class=\"mtk1\"> --</span><span class=\"mtk12\">git</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\">/</span><span class=\"mtk12\">packages</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">token</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ERC1155Enumerable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\"> </span><span class=\"mtk12\">b</span><span class=\"mtk1\">/</span><span class=\"mtk12\">packages</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">token</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ERC1155Enumerable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">index</span><span class=\"mtk1\"> 4</span><span class=\"mtk12\">ec23ff</span><span class=\"mtk1\">..</span><span class=\"mtk12\">ef67bca</span><span class=\"mtk1\"> </span><span class=\"mtk7\">100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">--- </span><span class=\"mtk12\">a</span><span class=\"mtk1\">/</span><span class=\"mtk12\">packages</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">token</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ERC1155Enumerable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+++ </span><span class=\"mtk12\">b</span><span class=\"mtk1\">/</span><span class=\"mtk12\">packages</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">token</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ERC1155Enumerable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -</span><span class=\"mtk7\">91</span><span class=\"mtk1\">,</span><span class=\"mtk7\">8</span><span class=\"mtk1\"> +</span><span class=\"mtk7\">91</span><span class=\"mtk1\">,</span><span class=\"mtk7\">8</span><span class=\"mtk1\"> @@ </span><span class=\"mtk12\">abstract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ERC1155Enumerable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IERC1155Enumerable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ERC1155</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk3\">/// @dev Remove token enumeration list if necessary.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_removeTokenEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">to</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_idTotalSupply</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">_additionalConditionRemoveTokenFromAllTokensEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id</span><span class=\"mtk1\">)) </span><span class=\"mtk11\">_removeTokenFromAllTokensEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             </span><span class=\"mtk12\">_idTotalSupply</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_idTotalSupply</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">_additionalConditionRemoveTokenFromAllTokensEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id</span><span class=\"mtk1\">)) </span><span class=\"mtk11\">_removeTokenFromAllTokensEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">from</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">to</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -</span><span class=\"mtk7\">114</span><span class=\"mtk1\">,</span><span class=\"mtk7\">8</span><span class=\"mtk1\"> +</span><span class=\"mtk7\">114</span><span class=\"mtk1\">,</span><span class=\"mtk7\">7</span><span class=\"mtk1\"> @@ </span><span class=\"mtk12\">abstract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ERC1155Enumerable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IERC1155Enumerable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ERC1155</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk3\">/// @param to address representing the new owner of the given token ID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk3\">/// @param tokenId uint256 ID of the token to be added to the tokens list of the given address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_addTokenToOwnerEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-        </span><span class=\"mtk12\">_currentIndex</span><span class=\"mtk1\">[</span><span class=\"mtk12\">to</span><span class=\"mtk1\">] += </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">length</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_currentIndex</span><span class=\"mtk1\">[</span><span class=\"mtk12\">to</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">length</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_currentIndex</span><span class=\"mtk1\">[</span><span class=\"mtk12\">to</span><span class=\"mtk1\">]++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         </span><span class=\"mtk12\">_ownedTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">to</span><span class=\"mtk1\">][</span><span class=\"mtk12\">length</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         </span><span class=\"mtk12\">_ownedTokensIndex</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -</span><span class=\"mtk7\">134</span><span class=\"mtk1\">,</span><span class=\"mtk7\">7</span><span class=\"mtk1\"> +</span><span class=\"mtk7\">133</span><span class=\"mtk1\">,</span><span class=\"mtk7\">7</span><span class=\"mtk1\"> @@ </span><span class=\"mtk12\">abstract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ERC1155Enumerable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IERC1155Enumerable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ERC1155</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk3\">/// @param from address representing the previous owner of the given token ID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk3\">/// @param tokenId uint256 ID of the token to be removed from the tokens list of the given address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_removeTokenFromOwnerEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastTokenIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_currentIndex</span><span class=\"mtk1\">[</span><span class=\"mtk12\">from</span><span class=\"mtk1\">] - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastTokenIndex</span><span class=\"mtk1\"> = --</span><span class=\"mtk12\">_currentIndex</span><span class=\"mtk1\">[</span><span class=\"mtk12\">from</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_ownedTokensIndex</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">tokenIndex</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">lastTokenIndex</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/272#issuecomment-1427142843\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>There are 2 bugs highlighted here:</p>\n<ul>\n<li>the check is incorrectly made before the state update in <code>_removeTokenEnumeration</code></li>\n<li>the order in which <code>_currentIndex</code> is updated</li>\n</ul>\n<p>So splitting this finding in 2. <em>(Note: issue title has been updated accordingly. Also, see newly created issue <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/300\"><code>#300</code></a>.)</em></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/272#issuecomment-1434502259\">vhawk19 (Timeswap) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Updated the <a href=\"https://github.com/Timeswap-Labs/Timeswap-V2-Monorepo/blob/devel/packages/v2-token/contracts/base/ERC1155Enumerable.sol\">ERC1155Enumerable.sol</a> implementation, which should resolve these issues. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-burning-a-erc1155enumerable-token-doesnt-remove-it-from-the-enumeration-\" style=\"position:relative;\"><a href=\"#m-02-burning-a-erc1155enumerable-token-doesnt-remove-it-from-the-enumeration-\" aria-label=\"m 02 burning a erc1155enumerable token doesnt remove it from the enumeration  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/248\">[M-02] Burning a <code>ERC1155Enumerable</code> token doesn’t remove it from the enumeration </a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/248\">adriro</a>, also found by <a href=\"undefined\">eierina</a>, <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/252\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/228\">mookimgo</a>, and <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/119\">chaduke</a></em></p>\n<p>The <code>ERC1155Enumerable</code> base contract used in the <code>TimeswapV2Token</code> and <code>TimeswapV2LiquidityToken</code> tokens provides a functionality to enumerate all token ids that have been minted in the contract.</p>\n<p>The logic to remove the token from the enumeration if the last token is burned is implemented in the <code>_afterTokenTransfer</code> hook:</p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/base/ERC1155Enumerable.sol#L81-L101\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/base/ERC1155Enumerable.sol#L81-L101</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_afterTokenTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ids</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">ids</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk11\">_removeTokenEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ids</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @dev Remove token enumeration list if necessary.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_removeTokenEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">to</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_idTotalSupply</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">_additionalConditionRemoveTokenFromAllTokensEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id</span><span class=\"mtk1\">)) </span><span class=\"mtk11\">_removeTokenFromAllTokensEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_idTotalSupply</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">from</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">to</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">) == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">_additionalConditionRemoveTokenFromOwnerEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">)) </span><span class=\"mtk11\">_removeTokenFromOwnerEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The <code>_removeTokenEnumeration</code> condition to check if the supply is 0 happens before the function decreases the burned amount. This will <code>_removeTokenFromAllTokensEnumeration</code> from being called when the last token(s) is(are) burned.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The token isn’t removed from the enumeration since <code>_removeTokenFromAllTokensEnumeration</code> will never be called. This will cause the enumeration to always contain a minted token even though it is burned afterwards. The function <code>totalSupply</code> and <code>tokenByIndex</code> will report wrong values.</p>\n<p>This will also cause the enumeration to contain duplicate values or multiple copies of the same token. If the token is minted again after all tokens were previously burned, the token will be re added to the enumeration.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following test demonstrates the issue. Alice is minted a token and that token is then burned, the token is still present in the enumeration. The token is minted again, causing the enumeration to contain the token by duplicate.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: UNLICENSED</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> =</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">8</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;forge-std/Test.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../src/base/ERC1155Enumerable.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">TestERC1155Enumerable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ERC1155Enumerable</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() </span><span class=\"mtk11\">ERC1155</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AuditTest</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Test</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_ERC1155Enumerable_BadRemoveFromEnumeration</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">TestERC1155Enumerable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">TestERC1155Enumerable</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">alice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;alice&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// tokenByIndex and totalSupply are ok</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">tokenByIndex</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// now we burn the token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// tokenByIndex and totalSupply still report previous values</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// tokenByIndex should throw index out of bounds, and supply should return 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">tokenByIndex</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Now we mint it again, this will re-add the token to the enumeration, duplicating it</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">tokenByIndex</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">tokenByIndex</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">), </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Decrease the amount before checking if the supply is 0.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_removeTokenEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">to</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_idTotalSupply</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_idTotalSupply</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">_additionalConditionRemoveTokenFromAllTokensEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id</span><span class=\"mtk1\">)) </span><span class=\"mtk11\">_removeTokenFromAllTokensEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">from</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">to</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">) == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">_additionalConditionRemoveTokenFromOwnerEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">)) </span><span class=\"mtk11\">_removeTokenFromOwnerEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/248#issuecomment-1434505035\">vhawk19 (Timeswap) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved in <a href=\"https://github.com/Timeswap-Labs/Timeswap-V2-Monorepo/commit/dd7d3c247235f0750516151c44873bbf23377212\">PR</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-fee-on-transfer-tokens-will-not-behave-as-expected\" style=\"position:relative;\"><a href=\"#m-03-fee-on-transfer-tokens-will-not-behave-as-expected\" aria-label=\"m 03 fee on transfer tokens will not behave as expected permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/247\">[M-03] Fee on transfer tokens will not behave as expected</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/247\">RaymondFam</a>, also found by <a href=\"undefined\">rbserver</a>, <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/205\">nadin</a>, <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/164\">kaden</a>, <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/148\">pavankv</a>, <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/106\">mert_eren</a>, <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/57\">SaeedAlipoor01988</a>, and <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/52\">Rolezn</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L145-L148\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L145-L148</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L235\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L235</a></p>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>According to <a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/whitepaper.pdf\">Whitepaper 1.1 Permissionless</a>:</p>\n<p>“In Timeswap, liquidity providers can create pools for any ERC20 pair, without permission. It is designed to be generalized and works\nfor any pair of tokens, at any time frame, and at any market state …</p>\n<p>If fee on transfer token(s) is/are entailed, it will specifically make <code>mint()</code> and <code>swap()</code> revert in TimeswapV2Option.sol when checking if the token0 or token1 balance target is achieved.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L144-L148\">File: TimeswapV2Option.sol#L144-L148</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check if the token0 balance target is achieved.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">currentProcess</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance0Target</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check if the token1 balance target is achieved.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">currentProcess</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance1Target</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L234-L235\">File: TimeswapV2Option.sol#L234-L235</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check if the token0 or token1 balance target is achieved.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">token1</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">token0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">currentProcess</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance1Target</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">currentProcess</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance0Target</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/Error.sol#L148-L153\">File: Error.sol#L148-L153</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @dev Reverts when token amount not received.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param balance The balance amount being subtracted.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param balanceTarget The amount target.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceTarget</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">balanceTarget</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NotEnoughReceived</span><span class=\"mtk1\">(</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk12\">balanceTarget</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>As can be seen from the code blocks above, <code>checkEnough()</code> is meant to be reverting when token amount has not been received. But in the case of deflationary tokens, the error is going to be thrown even though the token amount has been received due to the fee factor making <code>balance &#x3C; balanceTarget</code>, i.e the contract balance of token0 and/or token1 always less than <code>currentProcess.balance0Target</code> or <code>currentProcess.balance1Target</code>.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider:</p>\n<ol>\n<li>Whitelisting token0 and token1 ensuring no fee-on-transfer token is allowed when deploying a new Timeswap V2 Option pair contract, or</li>\n<li>Calculating the balance before and after the <a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L220\">transfer to the recipient</a> during the process, and use the difference between those two balances as the amount received rather than using the input amount (<code>token0AndLong0Amount</code> or <code>token1AndLong1Amount</code>) if deflationary token is going to be allowed in the protocol.</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/247#issuecomment-1430795527\">vhawk19 (Timeswap) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Not supported by design.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-sqrtdiscriminant-can-be-calculated-wrong\" style=\"position:relative;\"><a href=\"#m-04-sqrtdiscriminant-can-be-calculated-wrong\" aria-label=\"m 04 sqrtdiscriminant can be calculated wrong permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/227\">[M-04] sqrtDiscriminant can be calculated wrong</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/227\">sorrynotsorry</a></em></p>\n<p>Due to the wrong calculation of short and long tokens during the <code>leverage</code> and <code>deleverage</code> process, the users can suffer financial loss while the protocol will lose fees.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The protocol uses <code>leverage</code> function to deposit short tokens and receive long tokens. On the opposite, <code>deleverage</code> function serves for depositing long tokens and receiving short tokens.</p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/TimeswapV2Pool.sol#L430-L466\">Leverage Function of TimeswapV2Pool contract</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/TimeswapV2Pool.sol#L377-L418\">Deleverage Function of TimeswapV2Pool contract</a></p>\n<p>Both functions call the PoolLibrary’s <code>leverage</code> and <code>deleverage</code> functions after input sanitization.</p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/structs/Pool.sol#L552-L655\">Leverage Function of PoolLibrary contract</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/structs/Pool.sol#L469-L539\">Deleverage Function of PoolLibrary contract</a></p>\n<p>PoolLibrary’s <code>leverage</code> and <code>deleverage</code> functions update the state of the pool first for the fee growth and compute the <code>long0Amount</code>, <code>long1Amount</code>, and <code>shortAmount</code>. It also checks the transaction type according to the passed parameter types as per the <code>Transaction</code> contract’s enum types below and calls <code>ConstantProduct</code>’s appropriate function accordingly;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @dev The different kind of deleverage transactions.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">enum</span><span class=\"mtk1\"> </span><span class=\"mtk10\">TimeswapV2PoolDeleverage</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">GivenDeltaSqrtInterestRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">GivenLong</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">GivenShort</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">GivenSum</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @dev The different kind of leverage transactions.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">enum</span><span class=\"mtk1\"> </span><span class=\"mtk10\">TimeswapV2PoolLeverage</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">GivenDeltaSqrtInterestRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">GivenLong</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">GivenShort</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">GivenSum</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>If the transaction type is  <code>GivenSum</code>, both <code>leverage</code> and <code>deleverage</code> functions of PoolLibrary call <code>ConstantProduct.updateGivenSumLong</code> for the sum amount of the long position in the base denomination to be withdrawn, and the short position to be deposited.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">transaction</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">TimeswapV2PoolDeleverage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">GivenSum</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sqrtInterestRate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">longAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shortFees</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">ConstantProduct</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateGivenSumLong</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/structs/Pool.sol#L516-L517\">Link</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">transaction</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">TimeswapV2PoolLeverage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">GivenSum</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sqrtInterestRate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">longAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">ConstantProduct</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateGivenSumLong</span><span class=\"mtk1\">(</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/structs/Pool.sol#L602-L603\">Link</a></p>\n<p><code>updateGivenSumLong</code> updates the new square root interest rate given the sum of long positions in base denomination change and short position change;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">updateGivenSumLong</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint160</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint160</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sumAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transactionFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isAdd</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint160</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newRate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">longAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fees</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getShortOrLongFromGivenSum</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">sumAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">transactionFee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">isAdd</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isAdd</span><span class=\"mtk1\">) (</span><span class=\"mtk12\">newRate</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">getNewSqrtInterestRateGivenShort</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newRate</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getNewSqrtInterestRateGivenLong</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">fees</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FeeCalculation</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getFeesRemoval</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">transactionFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">fees</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isAdd</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">longAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">sumAmount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">longAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">sumAmount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">longAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/libraries/ConstantProduct.sol#L230-L253\">Link</a></p>\n<p>And <code>updateGivenSumLong</code> calls <code>getShortOrLongFromGivenSum</code> in order to return the <code>amount</code> which represents the short amount or long amount calculated.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getShortOrLongFromGivenSum</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint160</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint160</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sumAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transactionFee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isShort</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">negativeB</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">calculateNegativeB</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">sumAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">transactionFee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">isShort</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sqrtDiscriminant</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">calculateSqrtDiscriminant</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">sumAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">transactionFee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">negativeB</span><span class=\"mtk1\">, </span><span class=\"mtk12\">isShort</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">negativeB</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">sqrtDiscriminant</span><span class=\"mtk1\">).</span><span class=\"mtk11\">shr</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/libraries/ConstantProduct.sol#L356-L362\">Link</a></p>\n<p>And the formula needs <code>sqrtDiscriminant</code> value to calculate the <code>amount</code> and it calls <code>calculateSqrtDiscriminant</code> <a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/libraries/ConstantProduct.sol#L395\">accordingly</a></p>\n<p><code>calculateSqrtDiscriminant</code> function performs a bunch of checks and carries out mathematical functions to return the SqrtDiscriminant by utilizing FullMath and Math libraries.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">sqrtDiscriminant</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FullMath</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sqrt512</span><span class=\"mtk1\">(</span><span class=\"mtk12\">b0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">b1</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/libraries/ConstantProduct.sol#L430\">Link</a></p>\n<p>The <code>sqrt</code> formula in the Math contract uses the modified version of <a href=\"https://en.wikipedia.org/wiki/Methods_of_computing_square_roots#Babylonian_method\">Babylonian Method</a> when flags are included.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">sqrt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">value</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">result</span><span class=\"mtk1\">) { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">result</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">estimate</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) &gt;&gt; </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">result</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">value</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">while</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">estimate</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">result</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">result</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">estimate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">estimate</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">estimate</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">estimate</span><span class=\"mtk1\">) &gt;&gt; </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">value</span><span class=\"mtk1\"> % </span><span class=\"mtk12\">result</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">result</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-library/src/Math.sol#L69-L79\">Link</a></p>\n<p>However, when the parameter <code>roundUp</code> is passed as <code>true</code>, this results in inconsistent behavior for different values. And it’s being passed as true as can be seen <a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/libraries/ConstantProduct.sol#L430\">here</a>).</p>\n<p>In order to show some examples let’s pass the numbers as values and flag them true by using Math’s <code>sqrt</code> function.</p>\n<table>\n<thead>\n<tr>\n<th>Values</th>\n<th>1</th>\n<th>2</th>\n<th>3</th>\n<th>4</th>\n<th>5</th>\n<th>6</th>\n<th>7</th>\n<th>8</th>\n<th>9</th>\n<th>10</th>\n<th>11</th>\n<th>12</th>\n<th>13</th>\n<th>14</th>\n<th>15</th>\n<th>16</th>\n<th>17</th>\n<th>18</th>\n<th>19</th>\n<th>20</th>\n<th>21</th>\n<th>22</th>\n<th>23</th>\n<th>24</th>\n<th>25</th>\n<th>26</th>\n<th>27</th>\n<th>28</th>\n<th>29</th>\n<th>30</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Results</td>\n<td>1</td>\n<td>1</td>\n<td>1</td>\n<td>2</td>\n<td>3</td>\n<td><strong>2</strong></td>\n<td>3</td>\n<td><strong>2</strong></td>\n<td>3</td>\n<td>4</td>\n<td>4</td>\n<td><strong>3</strong></td>\n<td>4</td>\n<td>4</td>\n<td><strong>3</strong></td>\n<td>4</td>\n<td>5</td>\n<td>5</td>\n<td>5</td>\n<td><strong>4</strong></td>\n<td>5</td>\n<td>5</td>\n<td>5</td>\n<td><strong>4</strong></td>\n<td>5</td>\n<td>6</td>\n<td>6</td>\n<td>6</td>\n<td>6</td>\n<td><strong>5</strong></td>\n</tr>\n</tbody>\n</table>\n<p>As can be seen from the table, the results are not distributed logically. And many times the result is steeply lesser than its neighbor results. (E.g Sqrt(6) ->2, Sqrt(15)->3 etc.)</p>\n<p>The phenomenon occurs most if the values are small numbers.</p>\n<p>So if the parameter  <code>value1</code> in <code>FullMath.sqrt512</code> is passed/calculated as zero value, it has a high chance of providing a wrong calculation as a result with the line below;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">sqrt512</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">value0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">value1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">result</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">value1</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">result</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">value0</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sqrt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>This may lead to the wrong calculation of the <code>sqrtDiscriminant</code>, hence the wrong calculation of short or long amounts for the given transaction. The users might lose financial value due to this. Accordingly, the protocol might lose unspent fees as well.</p>\n<p>While the fewer values are affected more on this one, the pools with fewer token decimals and fewer token amounts are more affected by this error. As an example, a <a href=\"https://coinmarketcap.com/currencies/gemini-dollar/\">Gemini Dollar</a> pool (59th rank on CMC and having 2 decimals) would be subject to false returns.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Remix, Excel</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The team might consider not using <code>true</code> flag for <code>Math.sqrt</code> function.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/227#issuecomment-1422601119\">vhawk19 (Timeswap) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>Fixed in <a href=\"https://github.com/Timeswap-Labs/Timeswap-V2-Monorepo/pull/258\">PR</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-unexpected-overflow-for-fullmathadd512-which-can-result-in-irregular-behavior\" style=\"position:relative;\"><a href=\"#m-05-unexpected-overflow-for-fullmathadd512-which-can-result-in-irregular-behavior\" aria-label=\"m 05 unexpected overflow for fullmathadd512 which can result in irregular behavior permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/182\">[M-05] unexpected overflow for <code>FullMath.add512()</code> which can result in irregular behavior</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/182\">codeislight</a></em></p>\n<p>The vulnerability originates from insufficient checking in add512 function, where the AddOverflow revert gets bypassed, essentially the function assumes that an overflow only happens if (addendA1 > sum1), where in the case that it’s possible for it to overflow in the case that addendA1 == sum1, which can be resulted through assigning a value that makes ( lt(sum0, addendA0) == 1 ) &#x3C;=> sum0 &#x3C; addendA0, which can only be achieved normally by overflowing the least significant addition. Then we can simply break the overflow check by assigning overflowing values which results in add(addendA1, addendB1) > type(256).max &#x26;&#x26; addendA1 &#x3C;= sum1, then we will manage to bypass the revert check and overflow the most significant part of add512 values.</p>\n<p>The previous attack vector can lead to a manipulation in leverage and deleverage functions, in a way that it would result in more tokens for the user.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Inputting the following values results in an overflow:</p>\n<p>uint256 addendA0 = 1</p>\n<p>uint256 addendA1 = 100</p>\n<p>uint256 addendB0 = 115792089237316195423570985008687907853269984665640564039457584007913129639935 (uint256 max value)</p>\n<p>uint256 addendB1 = 115792089237316195423570985008687907853269984665640564039457584007913129639935 (uint256 max value)</p>\n<p>results in:</p>\n<p>sum0 = 0</p>\n<p>sum1 = 100</p>\n<p>The expected behavior is to revert since, A1 + B1 result in a value that overflows, but instead consider it as a valid behavior due to the insufficient checking.</p>\n<p>Abstraction:</p>\n<p>A1 - A0</p>\n<p>+</p>\n<p>B1 - B0</p>\n<p>=</p>\n<p>S1 - S0</p>\n<p>S0 = A0 + B0</p>\n<p>S1 = A1 + B1 + ( if S0 overflows [+ 1])</p>\n<p>ensure A1 &#x3C;= S1</p>\n<p>revert only on A1 > S1</p>\n<p>in the case of S0 overflows:</p>\n<p>S1 = A1 + B1 + 1</p>\n<p>require(A1 &#x3C;= S1) is not most suited check, due to the fact that in the case of A1 == S1 check, it can still overflow if S1 = A1 + B1 + 1 overflows.\nwhich would bypass A1 > S1 revert check.</p>\n<p>The major impact affects the <code>leverage()</code> and <code>deleverage()</code> results in values which are not expected.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add an equality check for if statement in add512 function.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">   function add512(uint256 addendA0, uint256 addendA1, uint256 addendB0, uint256 addendB1) public pure returns (uint256 sum0, uint256 sum1) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assembly {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            sum0 := add(addendA0, addendB0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            carry  := lt(sum0, addendA0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            sum1 := add(add(addendA1, addendB1), carry)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (addendA1 &gt; sum1 ||      ((sum1 == addendA1 || sum1 == addendB1) &amp;&amp; (carry &lt; addendA0 || carry &lt; addendB0))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">) revert AddOverflow(addendA0, addendA1, addendB0, addendB1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/182#issuecomment-1415339789\">Picodes (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>No explanation related to how this could lead to errors in <code>leverage</code> or <code>deleverage</code>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/182#issuecomment-1422675570\">vhawk19 (Timeswap) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>Fixed in <a href=\"https://github.com/Timeswap-Labs/Timeswap-V2-Monorepo/pull/270\">PR</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-_ownedtokensindex-is-shared-by-different-owners-as-a-result-_removetokenfromalltokensenumeration-might-remove-the-wrong-tokenid-\" style=\"position:relative;\"><a href=\"#m-06-_ownedtokensindex-is-shared-by-different-owners-as-a-result-_removetokenfromalltokensenumeration-might-remove-the-wrong-tokenid-\" aria-label=\"m 06 _ownedtokensindex is shared by different owners as a result _removetokenfromalltokensenumeration might remove the wrong tokenid  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/168\">[M-06] <code>_ownedTokensIndex</code> is SHARED by different owners, as a result, <code>_removeTokenFromAllTokensEnumeration</code> might remove the wrong tokenId. </a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/168\">chaduke</a>, also found by <a href=\"undefined\">adriro</a></em></p>\n<p>The data structure <code>_ownedTokensIndex</code> is SHARED by different owners, as a result, <code>_removeTokenFromAllTokensEnumeration()</code> might remove the wrong tokenId.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>_ownedTokensIndex</code> is used to map from token ID to index of the owner tokens list, unfortunately, all owners share the same data structure at the same time (non-fungible tokens). So, the mapping for one owner might be overwritten by another owner when <code>_addTokenToOwnerEnumeration</code> is called: <br><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-token/src/base/ERC1155Enumerable.sol#L116-L121\">https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-token/src/base/ERC1155Enumerable.sol#L116-L121</a>.\nAs a result,    <code>_removeTokenFromOwnerEnumeration()</code> might remove the wrong tokenID.</p>\n<p>Removing the wrong tokenID can happen like the following:</p>\n<ol>\n<li>Suppose Alice owns three tokens A, B, C with indices 1 -> A, 2->B, 3->C</li>\n<li>Suppose Bob owns token D, 1->D, and will add A to his list via <code>_addTokenToOwnerEnumeration()</code>. As a result, we have 1->D, and 2-A, since <code>_ownedTokensIndex</code> is shared, we have A->2 in <code>_ownedTokensIndex</code>.</li>\n<li>\n<p>Next, <code>_removeTokenFromOwnerEnumeration()</code> is called to remove A from Alice. However, <code>tokenIndex</code> will be 2, which points to B, as a result, instead of deleting A, B is deleted from <code>_ownedTokens</code>. Wrong token delete!</p>\n<p>function _removeTokenFromOwnerEnumeration(address from, uint256 tokenId) private {\nuint256 lastTokenIndex = _currentIndex[from] - 1;\nuint256 tokenIndex = _ownedTokensIndex[tokenId];</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (tokenIndex != lastTokenIndex) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 lastTokenId = _ownedTokens[from][lastTokenIndex];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _ownedTokens[from][tokenIndex] = lastTokenId;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _ownedTokensIndex[lastTokenId] = tokenIndex;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    delete _ownedTokensIndex[tokenId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    delete _ownedTokens[from][lastTokenIndex];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n</li>\n</ol>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Remix</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Redefine <code>ownedTokensIndex</code> so that is is not shared:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">mapping(address =&gt; mapping(uint256 =&gt; uint256)) private _ownedTokensIndex;</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/168#issuecomment-1434503390\">vhawk19 (Timeswap) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Updated the <a href=\"https://github.com/Timeswap-Labs/Timeswap-V2-Monorepo/blob/devel/packages/v2-token/contracts/base/ERC1155Enumerable.sol\">ERC1155Enumerable.sol</a> implementation, which should resolve these issues. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-mint-function-does-not-update-liquidityposition-state-of-caller-before-minting-lp-tokens-this-\" style=\"position:relative;\"><a href=\"#m-07-mint-function-does-not-update-liquidityposition-state-of-caller-before-minting-lp-tokens-this-\" aria-label=\"m 07 mint function does not update liquidityposition state of caller before minting lp tokens this  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/158\">[M-07] <code>Mint</code> function does not update <code>LiquidityPosition</code> state of caller before minting LP tokens. This </a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/158\">0Kage</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/structs/Pool.sol#L302\">https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/structs/Pool.sol#L302</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/structs/LiquidityPosition.sol#L60\">https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/structs/LiquidityPosition.sol#L60</a></p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>When a LP mints V2 Pool tokens, <code>mint</code> function in <a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/structs/Pool.sol#L302\">PoolLibrary</a> gets called. Inside this function <code>updateDurationWeightBeforeMaturity</code> updates global <code>short</code>, <code>long0</code> and <code>long1</code> fee growth.</p>\n<p>Change in global fee growth necessitates an update to <code>LiquidityPosition</code> state of caller (specifically updating fees &#x26; fee growth rates) when there are state changes made to that position (in this case, increasing liquidity). This principle is followed in functions such as <code>burn</code>, <code>transferLiquidity</code>, <code>transferFees</code>. However when calling <code>mint</code>, this update is missing. As a result, <code>growth</code> &#x26; <code>fee</code> levels in liquidity position of caller are inconsistent with global fee growth rates.</p>\n<p>Inconsistent state leads to incorrect calculations of long0/long1 and short fees of LP holders which in turn can lead to loss of fees. Since this impacts actual rewards for users, I’ve marked it as MEDIUM risk.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Let’s say, Bob has following sequence of events</p>\n<ul>\n<li>MINT at T0: Bob is a LP who mints N pool tokens at T0</li>\n<li>MINT at T1: Bob mints another M pool tokens at T1. At this point, had the protocol correctly updated fees before minting new pool tokens, Bob’s fees &#x26; growth rate would be a function of current liquidity (N), global updated short fee growth rate at t1 (s<em>t1) and Bob’s previous growth rate at t\\</em>0 (b_t0)</li>\n<li>BURN at T2: Bob burns N + M tokens at T2. At this point, Bob’s fees should be a function of previous liquidity (N+M), global short fee growth rate (s<em>t2) and Bob’s previous growth rate at t\\</em>1(b<em>t1) -> since this update never happened, Bob’s previous growth rate is wrongly referenced b</em>t0 instead of b_t1.</li>\n</ul>\n<p>Bob could collect a lower fees because of this state inconsistency.</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Update the liquidity position state right before minting.</p>\n<p>After <a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/ef4c84fb8535aad8abd6b67cc45d994337ec4514/packages/v2-pool/src/structs/Pool.sol#L302\">line 302 of Pool.sol</a>, update the LiquidityPosition by adding</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  liquidityPosition.update(pool.long0FeeGrowth, pool.long1FeeGrowth, pool.shortFeeGrowth);</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/158\">vhawk19 (Timeswap) confirmed</a></strong></p>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 36 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/293\">report highlighted below</a> by <strong>rbserver</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/286\">ddimitrov22</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/282\">Udsen</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/280\">Breeje</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/273\">matrix_0wl</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/271\">hansfriese</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/267\">0xAgro</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/266\">Josiah</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/256\">luxartvinsec</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/243\">Diana</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/239\">tnevler</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/235\">delfin454000</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/232\">Awesome</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/230\">mookimgo</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/214\">cryptonue</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/199\">shark</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/189\">IllIllI</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/183\">0x1f8b</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/176\">fatherOfBlocks</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/173\">0xSmartContract</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/170\">brgltd</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/169\">oberon</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/163\">lukris02</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/161\">Viktor_Cortess</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/154\">Moksha</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/144\">DadeKuma</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/131\">0xGusMcCrae</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/120\">popular00</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/113\">chaduke</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/112\">georgits</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/111\">descharre</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/101\">martin</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/68\">RaymondFam</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/34\">btk</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/20\">Rolezn</a>, and\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/7\">SaeedAlipoor01988</a>\n.</em></p>\n<h2 id=\"01-user-can-possibly-transfer-no-token0-or-token1-to-timeswapv2option-contract-if-corresponding-token0-or-token1-is-a-rebasing-token\" style=\"position:relative;\"><a href=\"#01-user-can-possibly-transfer-no-token0-or-token1-to-timeswapv2option-contract-if-corresponding-token0-or-token1-is-a-rebasing-token\" aria-label=\"01 user can possibly transfer no token0 or token1 to timeswapv2option contract if corresponding token0 or token1 is a rebasing token permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[01] User can possibly transfer no <code>token0</code> or <code>token1</code> to <code>TimeswapV2Option</code> contract if corresponding <code>token0</code> OR <code>token1</code> is a rebasing token</h2>\n<p>When calling the following <code>TimeswapV2Option.mint</code> function, <code>msg.sender</code> uses the <code>ITimeswapV2OptionMintCallback.timeswapV2OptionMintCallback</code> function to transfer the relevant <code>token0</code> and/or <code>token1</code> to the <code>TimeswapV2Option</code> contract. Similarly, when calling the <code>TimeswapV2Option.swap</code> function below, <code>msg.sender</code> uses the <code>ITimeswapV2OptionSwapCallback.timeswapV2OptionSwapCallback</code> function to transfer the relevant <code>token0</code> or <code>token1</code> to the <code>TimeswapV2Option</code> contract. When <code>token0</code> or <code>token1</code> is a rebasing token, it is possible that the user uses these callback functions to trigger such token’s rebasing event that increases its balance owned by the <code>TimeswapV2Option</code> contract.</p>\n<p>Then, when the <code>TimeswapV2Option.mint</code> and <code>TimeswapV2Option.swap</code> functions call <code>Error.checkEnough</code>, the rebasing token’s balance owned by the <code>TimeswapV2Option</code> contract can possibly exceed the corresponding balance target. As a result, the user is able to mint or swap option positions without sending any of such rebasing token to the <code>TimeswapV2Option</code> contract.</p>\n<p>As a mitigation, this protocol can behave like other protocols that do not support rebasing tokens and use a blocklist to block such tokens from being used as <code>token0</code> or <code>token1</code> for any options.</p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L109-L154\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L109-L154</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">TimeswapV2OptionMintParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">noDelegateCall</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Option</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">option</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">options</span><span class=\"mtk1\">[</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">][</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// does main mint logic calculation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">option</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0To</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1To</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">shortTo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">transaction</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// update token0 and token1 balance target for any previous concurrent option transactions.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">processing</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateProcess</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// add a new process</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// stores the token0 and token1 balance target required from the msg.sender to achieve.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Process</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentProcess</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">processing</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">() = </span><span class=\"mtk11\">Process</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) + </span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) + </span><span class=\"mtk12\">token1AndLong1Amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ask the msg.sender to transfer token0 and/or token1 to this contract.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">data</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2OptionMintCallback</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">).</span><span class=\"mtk11\">timeswapV2OptionMintCallback</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">TimeswapV2OptionMintCallbackParam</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">strike:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">maturity:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">token0AndLong0Amount:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">token1AndLong1Amount:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">shortAmount:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">data:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check if the token0 balance target is achieved.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">currentProcess</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance0Target</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check if the token1 balance target is achieved.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">currentProcess</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance1Target</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L198-L244\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L198-L244</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">swap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2OptionSwapParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">noDelegateCall</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Option</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">option</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">options</span><span class=\"mtk1\">[</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">][</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// does main swap logic calculation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">option</span><span class=\"mtk1\">.</span><span class=\"mtk11\">swap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">longTo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">transaction</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// update token0 and token1 balance target for any previous concurrent option transactions.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">processing</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateProcess</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\">, !</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// add a new process</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// stores the token0 and token1 balance target required from the msg.sender to achieve.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Process</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentProcess</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">processing</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">() = </span><span class=\"mtk11\">Process</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\"> ? </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) - </span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\"> : </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) + </span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\"> ? </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) + </span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\"> : </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) - </span><span class=\"mtk12\">token1AndLong1Amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// transfer token to recipient.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">token0</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenTo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ask the msg.sender to transfer token0 or token1 to this contract.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">data</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2OptionSwapCallback</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">).</span><span class=\"mtk11\">timeswapV2OptionSwapCallback</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">TimeswapV2OptionSwapCallbackParam</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">strike:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">maturity:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">isLong0ToLong1:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">token0AndLong0Amount:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">token1AndLong1Amount:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">data:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check if the token0 or token1 balance target is achieved.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">token1</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">token0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">currentProcess</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance1Target</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">currentProcess</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance0Target</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"02-errorcheckenough-function-does-not-prevent-user-from-sending-too-many-tokens-to-relevant-contract\" style=\"position:relative;\"><a href=\"#02-errorcheckenough-function-does-not-prevent-user-from-sending-too-many-tokens-to-relevant-contract\" aria-label=\"02 errorcheckenough function does not prevent user from sending too many tokens to relevant contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[02] <code>Error.checkEnough</code> function does not prevent user from sending too many tokens to relevant contract</h2>\n<p>When calling functions like <code>TimeswapV2Option.mint</code> or <code>TimeswapV2Option.swap</code>, the user will use the callback function like <code>ITimeswapV2OptionMintCallback.timeswapV2OptionMintCallback</code> or <code>ITimeswapV2OptionSwapCallback.timeswapV2OptionSwapCallback</code> to send some of the corresponding tokens to the relevant contract, such as <code>TimeswapV2Option</code>. Calling functions like <code>TimeswapV2Option.mint</code> or <code>TimeswapV2Option.swap</code> will revert if its call to the following <code>Error.checkEnough</code> function reverts when the token amount transferred through the callback function is not enough. However, if user sends too many tokens through the callback function, the <code>Error.checkEnough</code> function does not revert; when this happens, the extra token amount after the corresponding token balance target is met will be locked in the relevant receiving contract like <code>TimeswapV2Option</code> so the user loses such extra amount.</p>\n<p>As a mitigation, the <code>balance &#x3C; balanceTarget</code> condition in the <code>Error.checkEnough</code> function can be updated to <code>balance != balanceTarget</code>. Alternatively, some logic can be added for returning the sent extra token amount back to the user.</p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/Error.sol#L151-L153\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/Error.sol#L151-L153</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceTarget</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">balanceTarget</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NotEnoughReceived</span><span class=\"mtk1\">(</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk12\">balanceTarget</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"03-pool-considers-option-not-matured-when-its-maturity-and-the-block-timestamp-are-equal\" style=\"position:relative;\"><a href=\"#03-pool-considers-option-not-matured-when-its-maturity-and-the-block-timestamp-are-equal\" aria-label=\"03 pool considers option not matured when its maturity and the block timestamp are equal permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[03] Pool considers option not matured when its maturity and the block timestamp are equal</h2>\n<p>As shown by the following comparisons between the option’s maturity and the block timestamp in the following <code>TimeswapV2Pool.initialize</code> function and the pool’s various <code>ParamLibrary.check</code> functions, the pool considers the corresponding option not matured when its maturity and the block timestamp are equal. However, this is inconsistent with the option’s definition, which considers the option matured when its maturity and the block timestamp are equal as the option’s various <code>ParamLibrary.check</code> functions below show. The <code>TimeswapV2Pool</code> contract’s <code>mint</code>, <code>burn</code>, <code>deleverage</code>, <code>leverage</code>, and <code>rebalance</code> functions all have the <code>can be only called before the maturity</code> comment indicating that these functions are supposed to be callable only when the corresponding option is not matured. Users who checked these comments can believe that these functions are callable when the option’s maturity and the block timestamp are equal; yet, calling these functions at such timing will revert due to the duration to the option’s maturity is already 0 and the inconsistency between the pool and option’s definitions of whether the option is matured. As a result, in this case, the user’s calls of these <code>TimeswapV2Pool</code> contract’s functions will revert unexpectedly with the used gas being wasted, and the user experience becoming degraded.</p>\n<p>As a mitigation, the pool and option’s definitions of whether the option is matured need to be updated to be consistent.</p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/TimeswapV2Pool.sol#L175-L181\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/TimeswapV2Pool.sol#L175-L181</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint160</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rate</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">noDelegateCall</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk11\">blockTimestamp</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">alreadyMatured</span><span class=\"mtk1\">(</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">blockTimestamp</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/structs/Param.sol#L142-L194\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/structs/Param.sol#L142-L194</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">check</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolMintParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">alreadyMatured</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">check</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolBurnParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">alreadyMatured</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">check</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolDeleverageParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">alreadyMatured</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">check</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolLeverageParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">alreadyMatured</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">check</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolRebalanceParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">alreadyMatured</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/structs/Param.sol#L103-L151\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/structs/Param.sol#L103-L151</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">check</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2OptionMintParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">alreadyMatured</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">check</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2OptionBurnParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">alreadyMatured</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">check</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2OptionSwapParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">alreadyMatured</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">check</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2OptionCollectParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stillActive</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"04-pools-paramlibrarycheck-function-for-timeswapv2poolcollectparam-checks-paramstrike--0-less-restrictively-than-pools-other--paramlibrarycheck-functions\" style=\"position:relative;\"><a href=\"#04-pools-paramlibrarycheck-function-for-timeswapv2poolcollectparam-checks-paramstrike--0-less-restrictively-than-pools-other--paramlibrarycheck-functions\" aria-label=\"04 pools paramlibrarycheck function for timeswapv2poolcollectparam checks paramstrike  0 less restrictively than pools other  paramlibrarycheck functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[04] Pool’s <code>ParamLibrary.check</code> function for <code>TimeswapV2PoolCollectParam</code> checks <code>param.strike == 0</code> less restrictively than pool’s other  <code>ParamLibrary.check</code> functions</h2>\n<p>As shown below, calling the pool’s <code>ParamLibrary.check</code> function for <code>TimeswapV2PoolCollectParam</code> will not revert when <code>param.strike</code> is 0 while one or more of <code>param.long0Requested</code>, <code>param.long1Requested</code>, or <code>param.shortRequested</code> is not 0. However, calling the pool’s other <code>ParamLibrary.check</code> functions for other <code>param</code> will revert whenever <code>param.strike == 0</code> is true. To handle the <code>param.strike == 0</code> check consistently, please consider updating the <code>&#x26;&#x26; param.strike == 0</code> condition to <code>|| param.strike == 0</code> in the pool’s <code>ParamLibrary.check</code> function for <code>TimeswapV2PoolCollectParam</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/structs/Param.sol#L133-L194\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/structs/Param.sol#L133-L194</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">check</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolCollectParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Requested</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Requested</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">shortRequested</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroInput</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">check</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolMintParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delta</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroInput</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">check</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolBurnParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delta</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroInput</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">check</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolDeleverageParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delta</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroInput</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">check</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolLeverageParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delta</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroInput</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">check</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolRebalanceParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blockTimestamp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delta</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroInput</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"05-redundant-named-returns\" style=\"position:relative;\"><a href=\"#05-redundant-named-returns\" aria-label=\"05 redundant named returns permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[05] Redundant named returns</h2>\n<p>When a function has unused named returns and used return statements, these named returns become redundant. To improve readability and maintainability, these variables for the named returns can be removed while keeping the return statements for the functions associated with the following lines.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2Pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">240</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolMintParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint160</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidityAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">248</span><span class=\"mtk1\">: ) </span><span class=\"mtk12\">external</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint160</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidityAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">305</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolBurnParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint160</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidityAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">313</span><span class=\"mtk1\">: ) </span><span class=\"mtk12\">external</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint160</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidityAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<h2 id=\"06-wordtyping-typos\" style=\"position:relative;\"><a href=\"#06-wordtyping-typos\" aria-label=\"06 wordtyping typos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[06] Word/typing typos</h2>\n<p><code>ot</code> can be changed to <code>to</code> in the following comment.</p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/StrikeConversion.sol#L22\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/StrikeConversion.sol#L22</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param amount The amount ot be converted. Token0 amount when zeroToOne. Token1 amount when oneToZero.</span></span></span></code></pre>\n<p><code>overidden</code> can be changed to <code>overridden</code> in the following comment.</p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L69\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L69</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Can be overidden for testing purposes.</span></span></span></code></pre>\n<p><code>positionss</code> can be changed to <code>positions</code> in the following comment.</p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/interfaces/callbacks/ITimeswapV2PoolMintCallback.sol#L10\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/interfaces/callbacks/ITimeswapV2PoolMintCallback.sol#L10</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @dev The liquidity positionss will already be minted to the receipient.</span></span></span></code></pre>\n<h2 id=\"07-confusing-natspec-param-usage\" style=\"position:relative;\"><a href=\"#07-confusing-natspec-param-usage\" aria-label=\"07 confusing natspec param usage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[07] Confusing NatSpec <code>@param</code> usage</h2>\n<p>Because <code>data</code> is the returned variable of the following functions, <code>@return</code> can be used instead of <code>@param</code> in the corresponding NatSpec comment to avoid confusion.</p>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/interfaces/callbacks/ITimeswapV2PoolMintCallback.sol#L13-L14\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/interfaces/callbacks/ITimeswapV2PoolMintCallback.sol#L13-L14</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param data The bytes of data to be sent to msg.sender.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">timeswapV2PoolMintChoiceCallback</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolMintChoiceCallbackParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/interfaces/callbacks/ITimeswapV2PoolMintCallback.sol#L17-L18\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/interfaces/callbacks/ITimeswapV2PoolMintCallback.sol#L17-L18</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param data The bytes of data to be sent to msg.sender.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">timeswapV2PoolMintCallback</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolMintCallbackParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"08-incomplete-natspec-comments\" style=\"position:relative;\"><a href=\"#08-incomplete-natspec-comments\" aria-label=\"08 incomplete natspec comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[08] Incomplete NatSpec Comments</h2>\n<p>NatSpec comments provide rich code documentation. The following functions are some examples that miss the <code>@param</code> and/or <code>@return</code> comments.</p>\n<p> Please consider completing the NatSpec comments for functions like these.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">library</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">125</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">inactiveOptionChoice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">library</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">StrikeConversion</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">16</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">convert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">zeroToOne</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">26</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">turn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">toOne</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">35</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">combine</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">option</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">ITimeswapV2Option</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">169</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2OptionBurnParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">);  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">190</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">collect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2OptionCollectParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token1Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">);  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">option</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">ITimeswapV2OptionFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">28</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getByIndex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">callbacks</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">ITimeswapV2PoolBurnCallback</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">13</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">timeswapV2PoolBurnChoiceCallback</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolBurnChoiceCallbackParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">callbacks</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">ITimeswapV2PoolMintCallback</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">14</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">timeswapV2PoolMintChoiceCallback</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolMintChoiceCallbackParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">18</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">timeswapV2PoolMintCallback</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolMintCallbackParam</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">); </span></span></span></code></pre>\n<h2 id=\"09-missing-natspec-comments\" style=\"position:relative;\"><a href=\"#09-missing-natspec-comments\" aria-label=\"09 missing natspec comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[09] Missing NatSpec comments</h2>\n<p>NatSpec comments provide rich code documentation. The following functions are some examples that miss NatSpec comments. Please consider adding NatSpec comments for functions like these.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">option</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2Option</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">56</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addOptionEnumerationIfNecessary</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">70</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">blockTimestamp</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint96</span><span class=\"mtk1\">) {  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2Pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">57</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addPoolEnumerationIfNecessary</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">66</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">raiseGuard</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">71</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">lowerGuard</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">82</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">blockTimestamp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">durationForward</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint96</span><span class=\"mtk1\">) {    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">252</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\TimeswapV2PoolDeployer.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  25: </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">poolFactory</span><span class=\"mtk1\">, </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">optionPair</span><span class=\"mtk1\">, </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">transactionFee</span><span class=\"mtk1\">, </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">protocolFee</span><span class=\"mtk1\">) </span><span class=\"mtk10\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk10\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">poolPair</span><span class=\"mtk1\">) { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk10\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk10\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk10\">structs</span><span class=\"mtk1\">\\</span><span class=\"mtk10\">LiquidityPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">85</span><span class=\"mtk1\">: </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">collectTransactionFees</span><span class=\"mtk1\">(    </span></span></span></code></pre>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 24 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/294\">report highlighted below</a> by <strong>0xSmartContract</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/290\">Rageur</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/289\">atharvasama</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/284\">Udsen</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/281\">c3phas</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/264\">Aymen0909</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/244\">matrix_0wl</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/216\">W_Max</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/209\">shark</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/193\">IllIllI</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/181\">0x1f8b</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/178\">0xackermann</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/175\">fatherOfBlocks</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/167\">kaden</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/157\">ReyAdmirado</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/156\">Beepidibop</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/155\">Viktor_Cortess</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/134\">Iurii3</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/110\">descharre</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/86\">chaduke</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/66\">RaymondFam</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/26\">W0RR1O</a>,\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/21\">Rolezn</a>, and\n<a href=\"https://github.com/code-423n4/2023-01-timeswap-findings/issues/6\">SaeedAlipoor01988</a>\n.</em></p>\n<h2 id=\"gas-optimizations-summary\" style=\"position:relative;\"><a href=\"#gas-optimizations-summary\" aria-label=\"gas optimizations summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations Summary</h2>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Number</th>\n<th align=\"left\">Optimization Details</th>\n<th align=\"center\">Context</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">[G-01]</td>\n<td align=\"left\">Gas saving is achieved by removing the <code>delete</code> keyword (~60k)</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[G-02]</td>\n<td align=\"left\">Remove <code>checkDoesNotExist</code> function</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[G-03]</td>\n<td align=\"left\">Avoid using <code>state variable</code> in emit (130 gas)</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[G-04]</td>\n<td align=\"left\">Change <code>public</code> state variable visibility to <code>private</code></td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td align=\"center\">[G-05]</td>\n<td align=\"left\">Save gas with the use of the import statement</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[G-06]</td>\n<td align=\"left\">Gas savings can be achieved by changing the model for assigning value to the structure (260 gas)</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td align=\"center\">[G-07]</td>\n<td align=\"left\">Using <code>delete</code>  instead of setting struct <code>0</code> saves gas</td>\n<td align=\"center\">10</td>\n</tr>\n<tr>\n<td align=\"center\">[G-08]</td>\n<td align=\"left\">In <code>div 512</code> function, <code>quotient 0</code> aggregate operation is used with unchecked to save gas</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[G-09]</td>\n<td align=\"left\">Avoid using external call</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[G-10]</td>\n<td align=\"left\">Gas overflow during iteration (DoS)</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[G-11]</td>\n<td align=\"left\">Move owner checks to a modifier for gas efficant</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td align=\"center\">[G-12]</td>\n<td align=\"left\">Use a more recent version of solidity</td>\n<td align=\"center\">All contracts</td>\n</tr>\n<tr>\n<td align=\"center\">[G-13]</td>\n<td align=\"left\">Use nested if and, avoid multiple check combinations</td>\n<td align=\"center\">19</td>\n</tr>\n<tr>\n<td align=\"center\">[G-14]</td>\n<td align=\"left\">] Sort Solidity operations using short-circuit mode</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td align=\"center\">[G-15]</td>\n<td align=\"left\"><code>>=</code> costs less gas than <code>></code></td>\n<td align=\"center\">4</td>\n</tr>\n<tr>\n<td align=\"center\">[G-16]</td>\n<td align=\"left\">Using UniswapV3 <code>mulDiv</code> function is gas-optimized</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[G-17]</td>\n<td align=\"left\">Using Openzeppelin Ownable2Step.sol is gas efficient</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[G-18]</td>\n<td align=\"left\">OpenZeppelin’s ReentrancyGuard contract is gas-optimized</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">[G-19]</td>\n<td align=\"left\">Save gas with the use of the import statement</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">[G-20]</td>\n<td align=\"left\">Remove import <code>forge-std/console.sol</code></td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[G-21]</td>\n<td align=\"left\">Usage of uints/ints smaller than 32 bytes (256 bits) incurs overhead</td>\n<td align=\"center\">23</td>\n</tr>\n<tr>\n<td align=\"center\">[G-22]</td>\n<td align=\"left\">Use <code>assembly</code> to write <em>address storage values</em></td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td align=\"center\">[G-23]</td>\n<td align=\"left\">Setting the <em>constructor</em> to <code>payable</code></td>\n<td align=\"center\">8</td>\n</tr>\n<tr>\n<td align=\"center\">[G-24]</td>\n<td align=\"left\">Avoid contract existence checks by using solidity version 0.8.10 or later</td>\n<td align=\"center\">57</td>\n</tr>\n<tr>\n<td align=\"center\">[G-25]</td>\n<td align=\"left\">Optimize names to save gas</td>\n<td align=\"center\">All contracts</td>\n</tr>\n<tr>\n<td align=\"center\">[G-26]</td>\n<td align=\"left\">Upgrade Solidity’s optimizer</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td align=\"center\">[G-27]</td>\n<td align=\"left\">Open the optimizer</td>\n<td align=\"center\">1</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 27 issues</p>\n<h2 id=\"g-01-gas-saving-is-achieved-by-removing-the-delete-keyword-60k\" style=\"position:relative;\"><a href=\"#g-01-gas-saving-is-achieved-by-removing-the-delete-keyword-60k\" aria-label=\"g 01 gas saving is achieved by removing the delete keyword 60k permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Gas saving is achieved by removing the <code>delete</code> keyword (~60k)</h2>\n<p>30k gas savings were made by removing the <code>delete</code> keyword. The reason for using the <code>delete</code> keyword here is to reset the struct values (set to default value) in every operation. However, the struct values do not need to be zero each time the function is run. Therefore, the <code></code>delete” key word is unnecessary. If it is removed, around 30k gas savings will be achieved.</p>\n<p>There are two instances of the subject:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">packages\\v2-option\\src\\TimeswapV2OptionDeployer.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  31      /// @return optionPair The address of the newly deployed TimeswapV2Option contract.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  32:     function deploy(address optionFactory, address token0, address token1) internal returns (address optionPair) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  33:         parameter = Parameter({optionFactory: optionFactory, token0: token0, token1: token1});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  34: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  35:         optionPair = address(new TimeswapV2Option{salt: keccak256(abi.encode(token0, token1))}());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  36: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  37:         // save gas.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 38:         delete parameter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  39:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  40  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">packages\\v2-pool\\src\\TimeswapV2PoolDeployer.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  24  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  25:     function deploy(address poolFactory, address optionPair, uint256 transactionFee, uint256 protocolFee) internal returns (address poolPair) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  26:         parameter = Parameter({poolFactory: poolFactory, optionPair: optionPair, transactionFee: transactionFee, protocolFee: protocolFee});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  27: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  28:         poolPair = address(new TimeswapV2Pool{salt: keccak256(abi.encode(optionPair))}());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  29: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 30:         delete parameter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  31:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  32  }</span></span></span></code></pre>\n<h2 id=\"g-02-remove-checkdoesnotexist-function\" style=\"position:relative;\"><a href=\"#g-02-remove-checkdoesnotexist-function\" aria-label=\"g 02 remove checkdoesnotexist function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Remove <code>checkDoesNotExist</code> function</h2>\n<p>Using separate internal functions for non-repeating if blocks in more than one function wastes gas.</p>\n<p>The <code>checkDoesNotExist</code> <em>internal</em> function in the <code>OptionPair.sol</code> contract is only used in the <code>create</code> function of the <code>TimeswapV2OptionFactory.sol</code> contract.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">option</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2OptionFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">43</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">create</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">44</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">token0</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">45</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">token1</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">46</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">OptionPairLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkCorrectFormat</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">47</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">48</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">optionPairs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">][</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">49</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">OptionPairLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkDoesNotExist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">50</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">51</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">token0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">52</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">53</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">optionPairs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">][</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">54</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">55</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Create</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">56</span><span class=\"mtk1\">:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">57</span><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2OptionFactory.sol#L43-L57\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2OptionFactory.sol#L43-L57</a></p>\n<p><strong>Recommendation:</strong></p>\n<p>I suggest that the check on line 50 be done by adding the <strong>if</strong> block as follows.</p>\n<p><strong><em>packages\\v2-option\\src\\TimeswapV2OptionFactory.sol</em></strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  43:     function create(address token0, address token1) external override returns (address optionPair) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  44:         if (token0 == address(0)) Error.zeroAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  45:         if (token1 == address(0)) Error.zeroAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  46:         OptionPairLibrary.checkCorrectFormat(token0, token1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  47: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  48:         optionPair = optionPairs[token0][token1];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 49:         OptionPairLibrary.checkDoesNotExist(token0, token1, optionPair);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                   if (optionPair != address(0)) revert OptionPairAlreadyExisted(token0, token1, optionPair);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  50: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  51:         optionPair = deploy(address(this), token0, token1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  52: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  53:         optionPairs[token0][token1] = optionPair;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  54: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  55:         emit Create(msg.sender, token0, token1, optionPair);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  56:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  57  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2OptionFactory.sol#L43-L57\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2OptionFactory.sol#L43-L57</a></p>\n<h2 id=\"g-03-avoid-using-state-variable-in-emit-130-gas\" style=\"position:relative;\"><a href=\"#g-03-avoid-using-state-variable-in-emit-130-gas\" aria-label=\"g 03 avoid using state variable in emit 130 gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Avoid using <code>state variable</code> in emit (130 gas)</h2>\n<p>Using a state variable in <code>SetOwner</code> emits wastes gas.</p>\n<p>1 result - 1 file:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">base</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">OwnableTwoSteps</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">23</span><span class=\"mtk1\">     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPendingOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chosenPendingOwner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">24</span><span class=\"mtk1\">         </span><span class=\"mtk12\">Ownership</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkIfOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">25</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">26</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">chosenPendingOwner</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">27</span><span class=\"mtk1\">         </span><span class=\"mtk12\">chosenPendingOwner</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkIfAlreadyOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">28</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">29</span><span class=\"mtk1\">         </span><span class=\"mtk12\">pendingOwner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">chosenPendingOwner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">30</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">31</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SetOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pendingOwner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">32</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/base/OwnableTwoSteps.sol#L31\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/base/OwnableTwoSteps.sol#L31</a></p>\n<p>If the following recommendation is taken into account, 130 gas is saved.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">packages\\v2-pool\\src\\base\\OwnableTwoSteps.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> 23     function setPendingOwner(address chosenPendingOwner) external override {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  24         Ownership.checkIfOwner(owner);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  25 </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  26         if (chosenPendingOwner == address(0)) Error.zeroAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  27         chosenPendingOwner.checkIfAlreadyOwner(owner);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  28 </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 31:         emit SetOwner(chosenPendingOwner);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  29         pendingOwner = chosenPendingOwner;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  30 </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 31:         emit SetOwner(pendingOwner);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  32     }</span></span></span></code></pre>\n<h2 id=\"g-04-change-public-state-variable-visibility-to-private\" style=\"position:relative;\"><a href=\"#g-04-change-public-state-variable-visibility-to-private\" aria-label=\"g 04 change public state variable visibility to private permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Change <code>public</code> state variable visibility to <code>private</code></h2>\n<p>If it is preferred to change the visibility of the <code>owner</code> and <code>pendingOwnerstate</code> state variables to <code>private</code>, this will save significant gas.</p>\n<p>2 result - 1 file:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">base</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">OwnableTwoSteps</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">14</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">16</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pendingOwner</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/base/OwnableTwoSteps.sol#L14-L16\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/base/OwnableTwoSteps.sol#L14-L16</a></p>\n<h2 id=\"g-05-save-gas-with-the-use-of-the-import-statement\" style=\"position:relative;\"><a href=\"#g-05-save-gas-with-the-use-of-the-import-statement\" aria-label=\"g 05 save gas with the use of the import statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Save gas with the use of the import statement</h2>\n<p>While the following two critical fee values are assigned in the constructor, there is no zero value control. This means that if both state variables are started with a possible value of <code>0</code>, the contract must be deployed again. This possibility means gas consumption.</p>\n<p>Zero value control is the most error-prone value control since zero value is assigned in case of no value entry due to EVM design.</p>\n<p>In addition, since the immutable value will be changed once, adding a zero value control does not cause high gas consumption.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2PoolFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">37</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chosenOwner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chosenTransactionFee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chosenProtocolFee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">OwnableTwoSteps</span><span class=\"mtk1\">(</span><span class=\"mtk12\">chosenOwner</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">38</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">chosenTransactionFee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IncorrectFeeInitialization</span><span class=\"mtk1\">(</span><span class=\"mtk12\">chosenTransactionFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">39</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">chosenProtocolFee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IncorrectFeeInitialization</span><span class=\"mtk1\">(</span><span class=\"mtk12\">chosenProtocolFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">40</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">41</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">transactionFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">chosenTransactionFee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">42</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">protocolFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">chosenProtocolFee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">43</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/TimeswapV2PoolFactory.sol#L37-L43\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/TimeswapV2PoolFactory.sol#L37-L43</a></p>\n<p><strong>Recommendation:</strong></p>\n<p>It is recommended to perform a zero value check for critical value assignments.</p>\n<p>Add zero check for immutable values when assigning values in critical constructor.</p>\n<h2 id=\"g-06-gas-savings-can-be-achieved-by-changing-the-model-for-assigning-value-to-the-structure-260-gas\" style=\"position:relative;\"><a href=\"#g-06-gas-savings-can-be-achieved-by-changing-the-model-for-assigning-value-to-the-structure-260-gas\" aria-label=\"g 06 gas savings can be achieved by changing the model for assigning value to the structure 260 gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Gas savings can be achieved by changing the model for assigning value to the structure (260 gas)</h2>\n<p>By changing the pattern of assigning value to the structure, gas savings of <code>~130</code> per instance are achieved. In addition, this use will provide significant savings in distribution costs.</p>\n<p>There are two examples of this issue:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2PoolDeployer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">25</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">distribution</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Factory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">option</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pair</span><span class=\"mtk1\"> </span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transaction</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Fee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">protocol</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Fee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">poolPair</span><span class=\"mtk1\"> </span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">26</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">parameter</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Parameter</span><span class=\"mtk1\">({</span><span class=\"mtk12\">poolFactory:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolFactory</span><span class=\"mtk1\">, </span><span class=\"mtk12\">optionPair:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">, </span><span class=\"mtk12\">transactionFees:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transactionFees</span><span class=\"mtk1\">, </span><span class=\"mtk12\">protocolFees:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">protocolFees</span><span class=\"mtk1\">});</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">option</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2OptionDeployer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">32</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">optionFactory</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">identifier0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">identifier1</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">33</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">parameter</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Parameter</span><span class=\"mtk1\">({</span><span class=\"mtk12\">optionFactory:optionFactory</span><span class=\"mtk1\">, </span><span class=\"mtk12\">symbol0:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">symbol0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">symbol1:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">symbol1</span><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>The following model, which is more gas efficient, can be preferred to assign value to the building elements.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">packages\\v2-option\\src\\TimeswapV2OptionDeployer.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  32:     function deploy(address optionFactory, address identifier0, address identifier1) internal returns (address optionPair) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 33:         parameter = Parameter({optionFactory: optionsFactory, token0: token0, token1: token1});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+              parameter.optionFactory = optionFactory;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+              parameter.token0 = token0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+              parameter.token1 = token1;</span></span></span></code></pre>\n<h2 id=\"g-07-using-delete--instead-of-setting-struct-0-saves-gas\" style=\"position:relative;\"><a href=\"#g-07-using-delete--instead-of-setting-struct-0-saves-gas\" aria-label=\"g 07 using delete  instead of setting struct 0 saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] Using <code>delete</code>  instead of setting struct <code>0</code> saves gas</h2>\n<p>10 results - 2 files:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">structs</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">LiquidityPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">93</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">liquidityPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Fees</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">101</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">liquidityPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Fees</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">109</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">liquidityPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">shortFees</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/structs/LiquidityPosition.sol#L93\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/structs/LiquidityPosition.sol#L93</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">structs</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">Pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">228</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0ProtocolFees</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">236</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1ProtocolFees</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">244</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">shortProtocolFees</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">633</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Balance</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">646</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Balance</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">685</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Balance</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">706</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Balance</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/structs/Pool.sol#L228\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/structs/Pool.sol#L228</a></p>\n<p><strong>Recommendation code:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">packages\\v2-pool\\src\\structs\\Pool.sol#L228</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  228:    pool.long0ProtocolFees = 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 228:    delete pool.long0ProtocolFees;</span></span></span></code></pre>\n<h2 id=\"g-08-in-div-512-function-quotient-0-aggregate-operation-is-used-with-unchecked-to-save-gas\" style=\"position:relative;\"><a href=\"#g-08-in-div-512-function-quotient-0-aggregate-operation-is-used-with-unchecked-to-save-gas\" aria-label=\"g 08 in div 512 function quotient 0 aggregate operation is used with unchecked to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] In <code>div 512</code> function, <code>quotient 0</code> aggregate operation is used with unchecked to save gas</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">packages/v2-library/src/FullMath.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  158:     function div512(uint256 dividend0, uint256 dividend1, uint256 divisor, bool roundUp) internal pure returns (uint256 quotient0, uint256 quotient1) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  159:         (quotient0, quotient1) = div512(dividend0, dividend1, divisor);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  160: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  161:         if (roundUp) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  162:             (uint256 productA0, uint256 productA1) = mul512(quotient0, divisor);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  163:             productA1 += (quotient1 * divisor);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  164:             if (dividend1 &gt; productA1 || dividend0 &gt; productA0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  165:                 if (quotient0 == type(uint256).max) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  166:                     quotient0 = 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  167:                     quotient1++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 168:                 } else quotient0++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 168:                 } else </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                         unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                          quotient0++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                         } </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  169:             }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  170:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  171:     }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/FullMath.sol#L165-L168\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/FullMath.sol#L165-L168</a></p>\n<h2 id=\"g-09-avoid-using-external-call\" style=\"position:relative;\"><a href=\"#g-09-avoid-using-external-call\" aria-label=\"g 09 avoid using external call permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] Avoid using external call</h2>\n<p>An if block check can be added as follows. With this control, gas saving is achieved by avoiding the use of external calls.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">packages/v2-pool/src/base/OwnableTwoSteps.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  22      /// @inheritdoc IOwnableTwoSteps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  23:     function setPendingOwner(address chosenPendingOwner) external override {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 24:         Ownership.checkIfOwner(owner);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 24:         if (msg.sender == owner) revert NotOwner();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  25: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  26:         if (chosenPendingOwner == address(0)) Error.zeroAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  27:         chosenPendingOwner.checkIfAlreadyOwner(owner);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  28: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  29:         pendingOwner = chosenPendingOwner;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  30: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  31:         emit SetOwner(pendingOwner);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  32:     }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/base/OwnableTwoSteps.sol#L24\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/base/OwnableTwoSteps.sol#L24</a></p>\n<h2 id=\"g-10-gas-overflow-during-iteration-dos\" style=\"position:relative;\"><a href=\"#g-10-gas-overflow-during-iteration-dos\" aria-label=\"g 10 gas overflow during iteration dos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10] Gas overflow during iteration (DoS)</h2>\n<p>Each iteration of the cycle requires a gas flow. A moment may come when more gas is required than it is allocated to record one block. In this case, all iterations of the loop will fail.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">packages/v2-option/src/structs/Process.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  32      /// @param isAddToken1 IsAddToken1 if true. IsSubToken0 if false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  33:     function updateProcess(Process[] storage processing, uint256 token0Amount, uint256 token1Amount, bool isAddToken0, bool isAddToken1) internal {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+              require(processing.length.length() &lt; maxProcessingLengt, &quot;max length&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  34:         for (uint256 i; i &lt; processing.length; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  35:             Process storage process = processing[i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  36: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  37:             if (token0Amount != 0) process.balance0Target = isAddToken0 ? process.balance0Target + token0Amount : process.balance0Target - token0Amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  38: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  39:             if (token1Amount != 0) process.balance1Target = isAddToken1 ? process.balance1Target + token1Amount : process.balance1Target - token1Amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  40: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  41:             unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  42:                 i++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  43:             }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  44:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  45:      }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/structs/Process.sol#L33-L45\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/structs/Process.sol#L33-L45</a></p>\n<h2 id=\"g-11-move-owner-checks-to-a-modifier-for-gas-efficant\" style=\"position:relative;\"><a href=\"#g-11-move-owner-checks-to-a-modifier-for-gas-efficant\" aria-label=\"g 11 move owner checks to a modifier for gas efficant permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-11] Move owner checks to a modifier for gas efficant</h2>\n<p>It’s better to use a modifier for simple owner checks for an easier inspection of functions. This is also more gas efficient as it does not control with external call.</p>\n<p><strong>The part where <code>owner</code> is defined:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">library</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Ownership</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">22</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">checkIfOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">23</span><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NotTheOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/Ownership.sol#L22-L23\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/Ownership.sol#L22-L23</a></p>\n<p>2 results 2 files:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TimeswapV2Pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">189</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">ITimeswapV2PoolFactory</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolFactory</span><span class=\"mtk1\">).</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">().</span><span class=\"mtk11\">checkIfOwner</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/TimeswapV2Pool.sol#L189\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/TimeswapV2Pool.sol#L189</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">base</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OwnableTwoSteps</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">23</span><span class=\"mtk1\">      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPendingOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chosenPendingOwner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">24</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">Ownership</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkIfOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/base/OwnableTwoSteps.sol#L23-L24\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/base/OwnableTwoSteps.sol#L23-L24</a></p>\n<h2 id=\"g-12-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#g-12-use-a-more-recent-version-of-solidity\" aria-label=\"g 12 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-12] Use a more recent version of solidity</h2>\n<blockquote>\n<p>Solidity 0.8.10 has a useful change that reduced gas costs of external calls which expect a return value. </p>\n<p>In 0.8.15 the conditions necessary for inlining are relaxed. Benchmarks show that the change significantly decreases the bytecode size (which impacts the deployment cost) while the effect on the runtime gas usage is smaller.</p>\n<p>In 0.8.17 prevent the incorrect removal of storage writes before calls to Yul functions that conditionally terminate the external EVM call; Simplify the starting offset of zero-length operations to zero. More efficient overflow checks for multiplication.</p>\n</blockquote>\n<p>The version of 70 contracts included in the scope is <code>0.8.8</code>. I recommend that you upgrade the versions of all contracts in scope to the latest version of robustness, ‘0.8.17’.</p>\n<h2 id=\"g-13-use-nested-if-and-avoid-multiple-check-combinations\" style=\"position:relative;\"><a href=\"#g-13-use-nested-if-and-avoid-multiple-check-combinations\" aria-label=\"g 13 use nested if and avoid multiple check combinations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-13] Use nested if and, avoid multiple check combinations</h2>\n<p>Using nested is cheaper than using &#x26;&#x26; multiple check combinations. There are more advantages, such as easier to read code and better coverage reports.</p>\n<p>19 results - 9 files:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">library</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">CatchError</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">15</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">4</span><span class=\"mtk1\">) % </span><span class=\"mtk7\">32</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">bytes4</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reason</span><span class=\"mtk1\">) == </span><span class=\"mtk12\">selector</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BytesLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">slice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reason</span><span class=\"mtk1\">, </span><span class=\"mtk7\">4</span><span class=\"mtk1\">, </span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">4</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/CatchError.sol#L15\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/CatchError.sol#L15</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">library</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">FullMath</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">257</span><span class=\"mtk1\">:   </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">mulmod</span><span class=\"mtk1\">(</span><span class=\"mtk12\">multiplicand</span><span class=\"mtk1\">, </span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\">, </span><span class=\"mtk12\">divisor</span><span class=\"mtk1\">) != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">result</span><span class=\"mtk1\">++;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/FullMath.sol#L257\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/FullMath.sol#L257</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">library</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">51</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">dividend</span><span class=\"mtk1\"> % </span><span class=\"mtk12\">divisor</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">quotient</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">62</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">dividend</span><span class=\"mtk1\"> % (</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> &lt;&lt; </span><span class=\"mtk12\">divisorBit</span><span class=\"mtk1\">) != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">quotient</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">81</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">value</span><span class=\"mtk1\"> % </span><span class=\"mtk12\">result</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">result</span><span class=\"mtk1\">++;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/Math.sol#L51\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/Math.sol#L51</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">option</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">structs</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">Param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">111</span><span class=\"mtk1\">:   </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount0</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount1</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroInput</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">124</span><span class=\"mtk1\">:   </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount0</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount1</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroInput</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/structs/Param.sol#L111\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/structs/Param.sol#L111</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2Pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">167</span><span class=\"mtk1\">:   </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">long0Fees</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">long1Fees</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">shortFees</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroInput</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/TimeswapV2Pool.sol#L167\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/TimeswapV2Pool.sol#L167</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"73\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">ConstantProduct</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">411</span><span class=\"mtk1\">:   </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">a11</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">a01</span><span class=\"mtk1\">.</span><span class=\"mtk11\">unsafeAdd</span><span class=\"mtk1\">(</span><span class=\"mtk12\">a10</span><span class=\"mtk1\">) &gt;= </span><span class=\"mtk12\">a01</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/libraries/ConstantProduct.sol#L411\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/libraries/ConstantProduct.sol#L411</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"74\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">structs</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">Param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">136</span><span class=\"mtk1\">:   </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Requested</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Requested</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">shortRequested</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroInput</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/structs/Param.sol#L136\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/structs/Param.sol#L136</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"75\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">token</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">base</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">ERC1155Enumerable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">60</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_idTotalSupply</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">_additionalConditionAddTokenToAllTokensEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id</span><span class=\"mtk1\">)) </span><span class=\"mtk11\">_addTokenToAllTokensEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">64</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">to</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">to</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">from</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">65</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">) == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">_additionalConditionAddTokenToOwnerEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">)) </span><span class=\"mtk11\">_addTokenToOwnerEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">94</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_idTotalSupply</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">_additionalConditionRemoveTokenFromAllTokensEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id</span><span class=\"mtk1\">)) </span><span class=\"mtk11\">_removeTokenFromAllTokensEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">98</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">from</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">to</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">99</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">) == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">_additionalConditionRemoveTokenFromOwnerEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">)) </span><span class=\"mtk11\">_removeTokenFromOwnerEnumeration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/base/ERC1155Enumerable.sol#L60\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/base/ERC1155Enumerable.sol#L60</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"76\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">token</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">structs</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">Param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">121</span><span class=\"mtk1\">:   </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroInput</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">128</span><span class=\"mtk1\">:   </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroInput</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">149</span><span class=\"mtk1\">:   </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0FeesDesired</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1FeesDesired</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">shortFeesDesired</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">zeroInput</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/structs/Param.sol#L121\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/structs/Param.sol#L121</a></p>\n<p><strong>Recomendation Code:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"77\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">protocol\\contracts\\plugins\\aave\\StaticATokenLM.sol#L422:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 149:   if (param.long0FeesDesired == 0 &amp;&amp; param.long1FeesDesired == 0 &amp;&amp; param.shortFeesDesired == 0) Error.zeroInput();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           if (param.long0FeesDesired == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+               if (param.long1FeesDesired == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                   if (param.shortFeesDesired == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                       Error.zeroInput();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+               }                                   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           }                                     </span></span></span></code></pre>\n<h2 id=\"g-14-sort-solidity-operations-using-short-circuit-mode\" style=\"position:relative;\"><a href=\"#g-14-sort-solidity-operations-using-short-circuit-mode\" aria-label=\"g 14 sort solidity operations using short circuit mode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-14] Sort Solidity operations using short-circuit mode</h2>\n<p>Short-circuiting is a solidity contract development model that uses <code>OR/AND</code> logic to sequence different cost operations. It puts low gas cost operations in the front and high gas cost operations in the back, so that if the front is low, if the cost operation is feasible, you can skip (short-circuit) the subsequent high-cost Ethereum virtual machine operation.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"78\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">//f(x) is a low gas cost operation </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">//g(y) is a high gas cost operation </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">//Sort operations with different gas costs as follows </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">f(x) || g(y) </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">f(x) &amp;&amp; g(y)</span></span></code></pre>\n<p>3 results - 3 files:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"79\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">ConstantProduct</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">298</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">product</span><span class=\"mtk1\">.</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">longAmount</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">) != </span><span class=\"mtk12\">rate</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">product</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">numerator</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NotEnoughLiquidityToBorrow</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/libraries/ConstantProduct.sol#L298\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/libraries/ConstantProduct.sol#L298</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"80\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">library</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">CatchError</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">15</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">4</span><span class=\"mtk1\">) % </span><span class=\"mtk7\">32</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">bytes4</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reason</span><span class=\"mtk1\">) == </span><span class=\"mtk12\">selector</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BytesLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">slice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reason</span><span class=\"mtk1\">, </span><span class=\"mtk7\">4</span><span class=\"mtk1\">, </span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">4</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/CatchError.sol#L15\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/CatchError.sol#L15</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"81\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">library</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">FullMath</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">68</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">subtrahend1</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">minuend1</span><span class=\"mtk1\"> || (</span><span class=\"mtk12\">subtrahend1</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">minuend1</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">subtrahend0</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">minuend0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SubUnderflow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minuend0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minuend1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">subtrahend0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">subtrahend1</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/FullMath.sol#L68\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/FullMath.sol#L68</a></p>\n<h2 id=\"g-15--costs-less-gas-than-\" style=\"position:relative;\"><a href=\"#g-15--costs-less-gas-than-\" aria-label=\"g 15  costs less gas than  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-15] <code>>=</code> costs less gas than <code>></code></h2>\n<p>The compiler uses opcodes GT and ISZERO for solidity code that uses >, but only requires LT for >=, which saves 3 gas</p>\n<p>4 results - 2 files:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"82\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">library</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">89</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">value1</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">value2</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">value1</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">value2</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/Math.sol#L89\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/Math.sol#L89</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"83\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">library</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">StrikeConversion</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">27</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\"> ? (</span><span class=\"mtk12\">toOne</span><span class=\"mtk1\"> ? </span><span class=\"mtk11\">convert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">) : </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) : (</span><span class=\"mtk12\">toOne</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> : </span><span class=\"mtk11\">convert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">36</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">amount0</span><span class=\"mtk1\"> + </span><span class=\"mtk11\">convert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">) : </span><span class=\"mtk12\">amount1</span><span class=\"mtk1\"> + </span><span class=\"mtk11\">convert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">48</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">49</span><span class=\"mtk1\">                 ? (</span><span class=\"mtk12\">zeroToOne</span><span class=\"mtk1\"> ? </span><span class=\"mtk11\">convert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">base</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">) : </span><span class=\"mtk12\">base</span><span class=\"mtk1\"> - </span><span class=\"mtk11\">convert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, !</span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">50</span><span class=\"mtk1\">                 : (</span><span class=\"mtk12\">zeroToOne</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">base</span><span class=\"mtk1\"> - </span><span class=\"mtk11\">convert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, !</span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">) : </span><span class=\"mtk11\">convert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">base</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/StrikeConversion.sol#L27\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/StrikeConversion.sol#L27</a></p>\n<h2 id=\"g-16-using-uniswapv3-muldiv-function-is-gas-optimized\" style=\"position:relative;\"><a href=\"#g-16-using-uniswapv3-muldiv-function-is-gas-optimized\" aria-label=\"g 16 using uniswapv3 muldiv function is gas optimized permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-16] Using UniswapV3 <code>mulDiv</code> function is gas-optimized</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"84\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">library</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FullMath</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">180</span><span class=\"mtk1\">      </span><span class=\"mtk3\">/// @return result The result.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">181</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">multiplicand</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">divisor</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">result</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">182</span><span class=\"mtk1\">         (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">product0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">product1</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">mul512</span><span class=\"mtk1\">(</span><span class=\"mtk12\">multiplicand</span><span class=\"mtk1\">, </span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">183</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">184</span><span class=\"mtk1\">         </span><span class=\"mtk3\">// Handle non-overflow cases, 256 by 256 division</span></span></span></code></pre>\n<p>Reference: <a href=\"https://github.com/Uniswap/v3-core/blob/412d9b236a1e75a98568d49b1aeb21e3a1430544/contracts/libraries/FullMath.sol#L14\">https://github.com/Uniswap/v3-core/blob/412d9b236a1e75a98568d49b1aeb21e3a1430544/contracts/libraries/FullMath.sol#L14</a></p>\n<p>Reference: <a href=\"https://xn--2-umb.com/21/muldiv/\">https://xn—2-umb.com/21/muldiv/</a></p>\n<h2 id=\"g-17-using-openzeppelin-ownable2stepsol-is-gas-efficient\" style=\"position:relative;\"><a href=\"#g-17-using-openzeppelin-ownable2stepsol-is-gas-efficient\" aria-label=\"g 17 using openzeppelin ownable2stepsol is gas efficient permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-17] Using Openzeppelin Ownable2Step.sol is gas efficient</h2>\n<p>The project makes secure Owner changes with OwnableTwoStep.</p>\n<p>The project’s <code>acceptOwner()</code> function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"85\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">base</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">OwnableTwoSteps</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">34</span><span class=\"mtk1\">      </span><span class=\"mtk3\">/// @inheritdoc IOwnableTwoSteps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">35</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">acceptOwner</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">36</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkIfPendingOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pendingOwner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">37</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">38</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">39</span><span class=\"mtk1\">:         </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pendingOwner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">40</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">41</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AcceptOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">42</span><span class=\"mtk1\">:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">43</span><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/base/OwnableTwoSteps.sol#L35-L43\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/base/OwnableTwoSteps.sol#L35-L43</a></p>\n<p>However, I recommend using the more gas-optimized Openzeppelin in Ownable2Step.sol.</p>\n<p>Openzeppelin acceptOwner() function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"86\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">acceptOwnership</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">pendingOwner</span><span class=\"mtk1\">() == </span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Ownable2Step: caller is not the new owner&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_transferOwnership</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/Ownable2Step.sol\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/Ownable2Step.sol</a></p>\n<h2 id=\"g-18-openzeppelins-reentrancyguard-contract-is-gas-optimized\" style=\"position:relative;\"><a href=\"#g-18-openzeppelins-reentrancyguard-contract-is-gas-optimized\" aria-label=\"g 18 openzeppelins reentrancyguard contract is gas optimized permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-18] OpenZeppelin’s ReentrancyGuard contract is gas-optimized</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"87\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ReentrancyGuard</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">11</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">/// @dev The initial state which must be change to NOT_ENTERED when first interacting.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">12</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">NOT_INTERACTED</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">13</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">14</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">/// @dev The initial and ending state of balanceTarget in the Option struct.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">15</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">NOT_ENTERED</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">16</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">17</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">/// @dev The state where the contract is currently being interacted with.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">18</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ENTERED</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/libraries/ReentrancyGuard.sol#L12-L18\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/libraries/ReentrancyGuard.sol#L12-L18</a></p>\n<p>I recommend using the gas-optimized OpenZeppelin ReentrancyGuard.sol contract.</p>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/security/ReentrancyGuard.sol\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/security/ReentrancyGuard.sol</a></p>\n<h2 id=\"g-19-save-gas-with-the-use-of-the-import-statement\" style=\"position:relative;\"><a href=\"#g-19-save-gas-with-the-use-of-the-import-statement\" aria-label=\"g 19 save gas with the use of the import statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-19] Save gas with the use of the import statement</h2>\n<p>With the import statement, it saves gas to specifically import only the parts of the contracts, not the complete ones.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"88\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">token</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IERC1155Enumerable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">6</span><span class=\"mtk1\">: </span><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/token/ERC1155/IERC1155.sol&quot;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><strong>Description:</strong></p>\n<p>Solidity code is also cleaner in another way that might not be noticeable: the struct Point. We were importing it previously with global import but not using it. The Point struct <code>polluted the source code</code> with an unnecessary object we were not using because we did not need it. </p>\n<p>This was breaking the rule of modularity and modular programming: <code>only import what you need</code> Specific imports with curly braces allow us to apply this rule better.</p>\n<p><strong>Recommendation:</strong></p>\n<p><code>import {contract1 , contract2} from \"filename.sol\";</code></p>\n<p>A good example from the ArtGobblers project;</p>\n<p>import {Owned} from “solmate/auth/Owned.sol”;</p>\n<p>import {ERC721} from “solmate/tokens/ERC721.sol”;</p>\n<p>import {LibString} from “solmate/utils/LibString.sol”;</p>\n<p>import {MerkleProofLib} from “solmate/utils/MerkleProofLib.sol”;</p>\n<p>import {FixedPointMathLib} from “solmate/utils/FixedPointMathLib.sol”;</p>\n<p>import {ERC1155, ERC1155TokenReceiver} from “solmate/tokens/ERC1155.sol”;</p>\n<p>import {toWadUnsafe, toDaysWadUnsafe} from “solmate/utils/SignedWadMath.sol”;</p>\n<h2 id=\"g-20-remove-import-forge-stdconsolesol\" style=\"position:relative;\"><a href=\"#g-20-remove-import-forge-stdconsolesol\" aria-label=\"g 20 remove import forge stdconsolesol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-20] Remove import <code>forge-std/console.sol</code></h2>\n<p>It’s used to print the values of variables while running tests to help debug and see what’s happening inside your contracts But since it’s a development tool, it serves no purpose on mainnet. </p>\n<p>1 result - 1 file:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"89\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">token</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2Token</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">5</span><span class=\"mtk1\">: </span><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;forge-std/console.sol&quot;</span><span class=\"mtk1\">; </span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2Token.sol#L5\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2Token.sol#L5</a></p>\n<p>Also, the following code block should be removed along with the removal of <code>forge-std/console.sol</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"90\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">/</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">token</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TimeswapV2Token</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">109</span><span class=\"mtk1\">:             </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;reaches right before mint in timeswapv2Tokne::mint&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong>Recommendation:</strong></p>\n<p>Use only for tests</p>\n<h2 id=\"g-21-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" style=\"position:relative;\"><a href=\"#g-21-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" aria-label=\"g 21 usage of uintsints smaller than 32 bytes 256 bits incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-21] Usage of uints/ints smaller than 32 bytes (256 bits) incurs overhead</h2>\n<p>When using elements that are smaller than 32 bytes, your contracts gas usage may be higher. This is because the EVM operates on 32 bytes at a time. Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.</p>\n<p><a href=\"https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html\">https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html</a> </p>\n<p>Use a larger size then downcast where needed.</p>\n<p>23 results - 4 files:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"91\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">library</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">20</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">result</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint16</span><span class=\"mtk1\">(</span><span class=\"mtk12\">value</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">38</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">result</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint160</span><span class=\"mtk1\">(</span><span class=\"mtk12\">value</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/SafeCast.sol#L20\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-library/src/SafeCast.sol#L20</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"92\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2Pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">104</span><span class=\"mtk1\">:   </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pools</span><span class=\"mtk1\">[</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">][</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">].</span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">109</span><span class=\"mtk1\">:   </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pools</span><span class=\"mtk1\">[</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">][</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">].</span><span class=\"mtk12\">sqrtInterestRate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">114</span><span class=\"mtk1\">:   </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pools</span><span class=\"mtk1\">[</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">][</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">].</span><span class=\"mtk12\">liquidityPositions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">].</span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/TimeswapV2Pool.sol#L104\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/TimeswapV2Pool.sol#L104</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"93\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">ConstantProduct</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">67</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">liquidityAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getLiquidityGivenLong</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">longAmount</span><span class=\"mtk1\">, !</span><span class=\"mtk12\">isAdd</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">82</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">liquidityAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getLiquidityGivenShort</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, !</span><span class=\"mtk12\">isAdd</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">104</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">liquidityAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getLiquidityGivenLong</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, !</span><span class=\"mtk12\">isAdd</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">110</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">liquidityAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getLiquidityGivenShort</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, !</span><span class=\"mtk12\">isAdd</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">142</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">newRate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">isAdd</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">rate</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">deltaRate</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">rate</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">deltaRate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">174</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">newRate</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getNewSqrtInterestRateGivenLong</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">longAmount</span><span class=\"mtk1\"> + (</span><span class=\"mtk12\">isAdd</span><span class=\"mtk1\"> ? </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">fees</span><span class=\"mtk1\">), </span><span class=\"mtk12\">isAdd</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">206</span><span class=\"mtk1\">:   (</span><span class=\"mtk12\">newRate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">deltaRate</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">getNewSqrtInterestRateGivenShort</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\"> + (</span><span class=\"mtk12\">isAdd</span><span class=\"mtk1\"> ? </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">fees</span><span class=\"mtk1\">), </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">isAdd</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">260</span><span class=\"mtk1\">:   </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FullMath</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">), </span><span class=\"mtk12\">longAmount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">) &lt;&lt; </span><span class=\"mtk7\">96</span><span class=\"mtk1\">, </span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">).</span><span class=\"mtk11\">toUint160</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">269</span><span class=\"mtk1\">:   </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FullMath</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">) &lt;&lt; </span><span class=\"mtk7\">192</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">).</span><span class=\"mtk11\">unsafeMul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">duration</span><span class=\"mtk1\">), </span><span class=\"mtk12\">roundUp</span><span class=\"mtk1\">).</span><span class=\"mtk11\">toUint160</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">296</span><span class=\"mtk1\">:   </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">numerator</span><span class=\"mtk1\">.</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">denominator2</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">).</span><span class=\"mtk11\">toUint160</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">316</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">deltaRate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FullMath</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">) &lt;&lt; </span><span class=\"mtk7\">192</span><span class=\"mtk1\">, </span><span class=\"mtk12\">denominator</span><span class=\"mtk1\">, !</span><span class=\"mtk12\">isAdd</span><span class=\"mtk1\">).</span><span class=\"mtk11\">toUint160</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/libraries/ConstantProduct.sol#L67\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/libraries/ConstantProduct.sol#L67</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"94\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">structs</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">LiquidityPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">66</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">liquidityPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">liquidityAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">76</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">liquidityPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">liquidityAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">207</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sqrtInterestRate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">308</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">liquidityAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delta</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint160</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">398</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">liquidityAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delta</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint160</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">486</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delta</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint160</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">572</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delta</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint160</span><span class=\"mtk1\">(),</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/structs/LiquidityPosition.sol#L66\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/structs/LiquidityPosition.sol#L66</a></p>\n<h2 id=\"g-22-use-assembly-to-write-address-storage-values\" style=\"position:relative;\"><a href=\"#g-22-use-assembly-to-write-address-storage-values\" aria-label=\"g 22 use assembly to write address storage values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-22] Use <code>assembly</code> to write <em>address storage values</em></h2>\n<p>2 results - 2 files:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"95\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">base</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">OwnableTwoSteps</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">18</span><span class=\"mtk1\">     </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chosenOwner</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">19</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">chosenOwner</span><span class=\"mtk1\">;</span><span class=\"mtk8\">```</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"19\"></span><span class=\"grvsc-source\"><span class=\"mtk8\">https:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"20\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"21\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"22\"></span><span class=\"grvsc-source\"><span class=\"mtk8\">```</span><span class=\"mtk12\">solidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"23\"></span><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">token</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2Token</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"24\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">41</span><span class=\"mtk1\">     </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chosenOptionFactory</span><span class=\"mtk1\">) </span><span class=\"mtk11\">ERC1155</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Timeswap V2 address&quot;</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"25\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">42</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">optionFactory</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">chosenOptionFactory</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2Token.sol#L42\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2Token.sol#L42</a></p>\n<p><strong>Recommendation Code:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"96\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  41     constructor(address chosenOptionFactory) ERC1155(&quot;Timeswap V2 address&quot;) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 42:           optionFactory = chosenOptionFactory;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                  assembly {                      </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                      sstore(optionFactory.slot, chosenOptionFactory)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                  }                               </span></span></span></code></pre>\n<h2 id=\"g-23-setting-the-constructor-to-payable\" style=\"position:relative;\"><a href=\"#g-23-setting-the-constructor-to-payable\" aria-label=\"g 23 setting the constructor to payable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-23] Setting the <em>constructor</em> to <code>payable</code></h2>\n<p>You can cut out 10 opcodes in the creation-time EVM bytecode if you declare a constructor payable. Making the constructor payable eliminates the need for an initial check of <code>msg.value == 0</code> and saves <code>13 gas</code> on deployment with no security risks.</p>\n<p>8 results - 8 files:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"97\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">option</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">NoDelegateCall</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">19</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/NoDelegateCall.sol#L19\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/NoDelegateCall.sol#L19</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"98\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">option</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2Option</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">65</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() </span><span class=\"mtk11\">NoDelegateCall</span><span class=\"mtk1\">() {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L65\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L65</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"99\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">NoDelegateCall</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">19</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/NoDelegateCall.sol#L19\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/NoDelegateCall.sol#L19</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"100\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2Pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">77</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() </span><span class=\"mtk11\">NoDelegateCall</span><span class=\"mtk1\">() {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/TimeswapV2Pool.sol#L77\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/TimeswapV2Pool.sol#L77</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"101\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2PoolFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">37</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chosenOwner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chosenTransactionFee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chosenProtocolFee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">OwnableTwoSteps</span><span class=\"mtk1\">(</span><span class=\"mtk12\">chosenOwner</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/TimeswapV2PoolFactory.sol#L37\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/TimeswapV2PoolFactory.sol#L37</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"102\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">base</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">OwnableTwoSteps</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">18</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chosenOwner</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/base/OwnableTwoSteps.sol#L18\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/base/OwnableTwoSteps.sol#L18</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"103\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">token</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2LiquidityToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">36</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chosenOptionFactory</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chosenPoolFactory</span><span class=\"mtk1\">) </span><span class=\"mtk11\">ERC1155</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Timeswap V2 uint160 address&quot;</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2LiquidityToken.sol#L36\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2LiquidityToken.sol#L36</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"104\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">token</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2Token</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">41</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chosenOptionFactory</span><span class=\"mtk1\">) </span><span class=\"mtk11\">ERC1155</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Timeswap V2 address&quot;</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2Token.sol#L41\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2Token.sol#L41</a></p>\n<p><strong>Recommendation:</strong></p>\n<p>Set the constructor to <code>payable</code></p>\n<h2 id=\"g-24-avoid-contract-existence-checks-by-using-solidity-version-0810-or-later\" style=\"position:relative;\"><a href=\"#g-24-avoid-contract-existence-checks-by-using-solidity-version-0810-or-later\" aria-label=\"g 24 avoid contract existence checks by using solidity version 0810 or later permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-24] Avoid contract existence checks by using solidity version 0.8.10 or later</h2>\n<p>Prior to 0.8.10 the compiler inserted extra code, including EXTCODESIZE (100 gas), to check for contract existence for external calls. In more recent solidity versions, the compiler will not insert these checks if the external call has a return value</p>\n<p>57 results - 6 files:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"105\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">token</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2LiquidityToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">66</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_timeswapV2LiquidityTokenPositionIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">timeswapV2LiquidityTokenPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toKey</span><span class=\"mtk1\">()]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">71</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_timeswapV2LiquidityTokenPositionIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">timeswapV2LiquidityTokenPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toKey</span><span class=\"mtk1\">()], </span><span class=\"mtk12\">liquidityAmount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">81</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_timeswapV2LiquidityTokenPositionIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toKey</span><span class=\"mtk1\">()];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">109</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">key</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">timeswapV2LiquidityTokenPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toKey</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">153</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">key</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">TimeswapV2LiquidityTokenPosition</span><span class=\"mtk1\">({</span><span class=\"mtk12\">token0:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">strike:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">maturity:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">}).</span><span class=\"mtk11\">toKey</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">185</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">key</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">TimeswapV2LiquidityTokenPosition</span><span class=\"mtk1\">({</span><span class=\"mtk12\">token0:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">strike:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">maturity:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">}).</span><span class=\"mtk11\">toKey</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">125</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint160</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidityBalanceTarget</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">liquidityOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) + </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">liquidityAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">143</span><span class=\"mtk1\">:    </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ITimeswapV2Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">liquidityOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">liquidityBalanceTarget</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">125</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint160</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidityBalanceTarget</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">liquidityOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) + </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">liquidityAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">143</span><span class=\"mtk1\">:    </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ITimeswapV2Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">liquidityOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">liquidityBalanceTarget</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">131</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">data</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2LiquidityTokenMintCallback</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">).</span><span class=\"mtk11\">timeswapV2LiquidityTokenMintCallback</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">163</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">data</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2LiquidityTokenBurnCallback</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">).</span><span class=\"mtk11\">timeswapV2LiquidityTokenBurnCallback</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">160</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">ITimeswapV2Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transferLiquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">liquidityAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">193</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">ITimeswapV2Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transferFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">long0Fees</span><span class=\"mtk1\">, </span><span class=\"mtk12\">long1Fees</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shortFees</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2LiquidityToken.sol#L66\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2LiquidityToken.sol#L66</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"106\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">token</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2Token</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">67</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ERC1155</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_timeswapV2TokenPositionIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">timeswapV2TokenPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toKey</span><span class=\"mtk1\">()]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">72</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_timeswapV2TokenPositionIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">timeswapV2TokenPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toKey</span><span class=\"mtk1\">()], (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">), </span><span class=\"mtk11\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">97</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">key</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">timeswapV2TokenPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toKey</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">127</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">key</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">timeswapV2TokenPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toKey</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">156</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">key</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">timeswapV2TokenPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toKey</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">240</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_timeswapV2TokenPositionIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">timeswapV2TokenPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toKey</span><span class=\"mtk1\">()], </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">254</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_timeswapV2TokenPositionIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">timeswapV2TokenPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toKey</span><span class=\"mtk1\">()], </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">268</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_timeswapV2TokenPositionIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">timeswapV2TokenPosition</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toKey</span><span class=\"mtk1\">()], </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">87</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">long0BalanceTarget</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Long0</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">117</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">long1BalanceTarget</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Long1</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">146</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">shortBalanceTarget</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Short</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">186</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Long0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">long0BalanceTarget</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">189</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Long1</span><span class=\"mtk1\">), </span><span class=\"mtk12\">long1BalanceTarget</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">192</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Short</span><span class=\"mtk1\">), </span><span class=\"mtk12\">shortBalanceTarget</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2Token.sol#L67\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-token/src/TimeswapV2Token.sol#L67</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"107\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2Pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">189</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">ITimeswapV2PoolFactory</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolFactory</span><span class=\"mtk1\">).</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">().</span><span class=\"mtk11\">checkIfOwner</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">267</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">long0BalanceTarget</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Long0</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">271</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">long1BalanceTarget</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Long1</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">274</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shortBalanceTarget</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Short</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">293</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Long0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">long0BalanceTarget</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">295</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Long1</span><span class=\"mtk1\">), </span><span class=\"mtk12\">long1BalanceTarget</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">297</span><span class=\"mtk1\">:    </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Short</span><span class=\"mtk1\">), </span><span class=\"mtk12\">shortBalanceTarget</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">393</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">long0BalanceTarget</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Long0</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">397</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">long1BalanceTarget</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Long1</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">411</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">long0Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Long0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">long0BalanceTarget</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">413</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">long1Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Long1</span><span class=\"mtk1\">), </span><span class=\"mtk12\">long1BalanceTarget</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">444</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceTarget</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Short</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">shortAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">461</span><span class=\"mtk1\">:    </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Short</span><span class=\"mtk1\">), </span><span class=\"mtk12\">balanceTarget</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">479</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceTarget</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">511</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">ITimeswapV2Option</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positionOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maturity</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Long0</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">TimeswapV2OptionPosition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Long1</span><span class=\"mtk1\">),</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/TimeswapV2Pool.sol#L189\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/TimeswapV2Pool.sol#L189</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"108\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">option</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">OptionFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">28</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2OptionFactory</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionFactory</span><span class=\"mtk1\">).</span><span class=\"mtk11\">get</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/libraries/OptionFactory.sol#L28\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/libraries/OptionFactory.sol#L28</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"109\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">PoolFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">32</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">poolPair</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2PoolFactory</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolFactory</span><span class=\"mtk1\">).</span><span class=\"mtk11\">get</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">46</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">poolPair</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ITimeswapV2PoolFactory</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolFactory</span><span class=\"mtk1\">).</span><span class=\"mtk11\">get</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPair</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/libraries/PoolFactory.sol#L32\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-pool/src/libraries/PoolFactory.sol#L32</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"110\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">option</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">src</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TimeswapV2Option</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">128</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) + </span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">129</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) + </span><span class=\"mtk12\">token1AndLong1Amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">145</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">currentProcess</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance0Target</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">148</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk10\">Error</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkEnough</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">currentProcess</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance1Target</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">215</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\"> ? </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) - </span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\"> : </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) + </span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">216</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\"> ? </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) + </span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\"> : </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) - </span><span class=\"mtk12\">token1AndLong1Amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">172</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token0To</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">175</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token1To</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">220</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">token0</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenTo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong0ToLong1</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">token0AndLong0Amount</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">token1AndLong1Amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">259</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">token0Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token0To</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token0Amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">262</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">token1Amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">param</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token1To</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token1Amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L128\">https://github.com/code-423n4/2023-01-timeswap/blob/main/packages/v2-option/src/TimeswapV2Option.sol#L128</a></p>\n<h2 id=\"g-25-optimize-names-to-save-gas\" style=\"position:relative;\"><a href=\"#g-25-optimize-names-to-save-gas\" aria-label=\"g 25 optimize names to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-25] Optimize names to save gas</h2>\n<p>Contracts most called functions could simply save gas by function ordering via <code>Method ID</code>. Calling a function at runtime will be cheaper if the function is positioned earlier in the order (has a relatively lower Method ID) because <code>22 gas</code> are added to the cost of a function for every position that came before it. The caller can save on gas if you prioritize most called functions. </p>\n<p><strong>Context:</strong> </p>\n<p>All Contracts</p>\n<p><strong>Recommendation:</strong> </p>\n<p>Find a lower <code>method ID</code> name for the most called functions for example Call() vs. Call1() is cheaper by <code>22 gas</code>.</p>\n<p>For example, the function IDs in the <code>TimeswapV2Pool.sol</code> contract will be the most used; A lower method ID may be given.</p>\n<p><strong>Proof of Concept:</strong></p>\n<p><a href=\"https://medium.com/joyso/solidity-how-does-function-name-affect-gas-consumption-in-smart-contract-47d270d8ac92\">https://medium.com/joyso/solidity-how-does-function-name-affect-gas-consumption-in-smart-contract-47d270d8ac92</a></p>\n<p>TimeswapV2Pool.sol function names can be named and sorted according to METHOD ID</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"111\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Sighash</span><span class=\"mtk1\">   |   </span><span class=\"mtk10\">Function</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Signature</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">========================</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">fbddf051</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">addPoolEnumerationIfNecessary</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1</span><span class=\"mtk12\">ea3a4eb</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">raiseGuard</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">3</span><span class=\"mtk12\">a9e8dd9</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">lowerGuard</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">f4f89897</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">blockTimestamp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint96</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">2</span><span class=\"mtk12\">d883a73</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">getByIndex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">6</span><span class=\"mtk12\">f682a53</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">numberOfPools</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">5</span><span class=\"mtk12\">c81c9b8</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">hasLiquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">b15044ac</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">totalLiquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">a8f403b7</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">sqrtInterestRate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">f78333a3</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">liquidityOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">647284</span><span class=\"mtk12\">f5</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">feeGrowth</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">6</span><span class=\"mtk12\">c867790</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">feesEarnedOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">72</span><span class=\"mtk12\">f8f85c</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">protocolFeesEarned</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">7</span><span class=\"mtk12\">ffd3a70</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">totalLongBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">3</span><span class=\"mtk12\">a9d71e7</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">totalLongBalanceAdjustFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">8</span><span class=\"mtk12\">fdc5c99</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">totalPositions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">c0e0c4c6</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">transferLiquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint160</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">d7e2c24a</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">transferFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">ad118b02</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint160</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">47</span><span class=\"mtk12\">b46959</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">collectProtocolFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolCollectParam</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">53</span><span class=\"mtk12\">fa956e</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">collectTransactionFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolCollectParam</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">55</span><span class=\"mtk12\">e305f3</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">collect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">0150</span><span class=\"mtk12\">ca41</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolMintParam</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">6</span><span class=\"mtk12\">da9a2a4</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolMintParam</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint96</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">df52795d</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolMintParam</span><span class=\"mtk1\">,</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint96</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">13576</span><span class=\"mtk12\">d77</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolBurnParam</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">731</span><span class=\"mtk12\">d4f67</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolBurnParam</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint96</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bd4952bd</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolBurnParam</span><span class=\"mtk1\">,</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint96</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">5</span><span class=\"mtk12\">d0ea1f5</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">deleverage</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolDeleverageParam</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">2</span><span class=\"mtk12\">e1b22ce</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">deleverage</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolDeleverageParam</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint96</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">cde7bf11</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">deleverage</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolDeleverageParam</span><span class=\"mtk1\">,</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint96</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">a97a4f78</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">leverage</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolLeverageParam</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">37</span><span class=\"mtk12\">aaeff8</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">leverage</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolLeverageParam</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint96</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">b8be2a15</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">leverage</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolLeverageParam</span><span class=\"mtk1\">,</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">,</span><span class=\"mtk12\">uint96</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">c993c3fa</span><span class=\"mtk1\">  </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\">  </span><span class=\"mtk11\">rebalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeswapV2PoolRebalanceParam</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<h2 id=\"g-26-upgrade-soliditys-optimizer\" style=\"position:relative;\"><a href=\"#g-26-upgrade-soliditys-optimizer\" aria-label=\"g 26 upgrade soliditys optimizer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-26] Upgrade Solidity’s optimizer</h2>\n<p>Make sure Solidity’s optimizer is enabled. It reduces gas costs. If you want to gas optimize for contract deployment (costs less to deploy a contract) then set the Solidity optimizer at a low number. If you want to optimize for run-time gas costs (when functions are called on a contract) then set the optimizer to a high number.</p>\n<p>Set the optimization value higher than 800 in your hardhat.config.ts file.</p>\n<p>3 results - 3 files:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"112\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">option</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">hardhat</span><span class=\"mtk1\">.</span><span class=\"mtk12\">config</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ts</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">27</span><span class=\"mtk1\">: </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">config</span><span class=\"mtk1\">: </span><span class=\"mtk10\">HardhatUserConfig</span><span class=\"mtk1\"> = {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">28</span><span class=\"mtk12\">:</span><span class=\"mtk1\">   </span><span class=\"mtk12\">paths</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">29</span><span class=\"mtk12\">:</span><span class=\"mtk1\">     </span><span class=\"mtk12\">sources</span><span class=\"mtk1\">: </span><span class=\"mtk8\">&quot;./src&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">30</span><span class=\"mtk12\">:</span><span class=\"mtk1\">   },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">31</span><span class=\"mtk12\">:</span><span class=\"mtk1\">   </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">32</span><span class=\"mtk12\">:</span><span class=\"mtk1\">     </span><span class=\"mtk12\">version</span><span class=\"mtk1\">: </span><span class=\"mtk8\">&quot;0.8.8&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">33</span><span class=\"mtk12\">:</span><span class=\"mtk1\">     </span><span class=\"mtk12\">settings</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">34</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       </span><span class=\"mtk12\">optimizer</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">35</span><span class=\"mtk12\">:</span><span class=\"mtk1\">         </span><span class=\"mtk12\">enabled</span><span class=\"mtk1\">: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">36</span><span class=\"mtk12\">:</span><span class=\"mtk1\">         </span><span class=\"mtk12\">runs</span><span class=\"mtk1\">: </span><span class=\"mtk7\">200</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">37</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">38</span><span class=\"mtk12\">:</span><span class=\"mtk1\">     },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">39</span><span class=\"mtk12\">:</span><span class=\"mtk1\">   },</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"113\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">hardhat</span><span class=\"mtk1\">.</span><span class=\"mtk12\">config</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ts</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">26</span><span class=\"mtk1\">: </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">config</span><span class=\"mtk1\">: </span><span class=\"mtk10\">HardhatUserConfig</span><span class=\"mtk1\"> = {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">27</span><span class=\"mtk12\">:</span><span class=\"mtk1\">   </span><span class=\"mtk12\">paths</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">28</span><span class=\"mtk12\">:</span><span class=\"mtk1\">     </span><span class=\"mtk12\">sources</span><span class=\"mtk1\">: </span><span class=\"mtk8\">&quot;./src&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">29</span><span class=\"mtk12\">:</span><span class=\"mtk1\">   },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">30</span><span class=\"mtk12\">:</span><span class=\"mtk1\">   </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">31</span><span class=\"mtk12\">:</span><span class=\"mtk1\">     </span><span class=\"mtk12\">version</span><span class=\"mtk1\">: </span><span class=\"mtk8\">&quot;0.8.8&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">32</span><span class=\"mtk12\">:</span><span class=\"mtk1\">     </span><span class=\"mtk12\">settings</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">33</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       </span><span class=\"mtk12\">optimizer</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">34</span><span class=\"mtk12\">:</span><span class=\"mtk1\">         </span><span class=\"mtk12\">enabled</span><span class=\"mtk1\">: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">35</span><span class=\"mtk12\">:</span><span class=\"mtk1\">         </span><span class=\"mtk12\">runs</span><span class=\"mtk1\">: </span><span class=\"mtk7\">200</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">36</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">37</span><span class=\"mtk12\">:</span><span class=\"mtk1\">     },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">38</span><span class=\"mtk12\">:</span><span class=\"mtk1\">   },</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"114\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">packages</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">v2</span><span class=\"mtk1\">-</span><span class=\"mtk12\">token</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">hardhat</span><span class=\"mtk1\">.</span><span class=\"mtk12\">config</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ts</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">26</span><span class=\"mtk1\">: </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">config</span><span class=\"mtk1\">: </span><span class=\"mtk10\">HardhatUserConfig</span><span class=\"mtk1\"> = {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">27</span><span class=\"mtk12\">:</span><span class=\"mtk1\">   </span><span class=\"mtk12\">paths</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">28</span><span class=\"mtk12\">:</span><span class=\"mtk1\">     </span><span class=\"mtk12\">sources</span><span class=\"mtk1\">: </span><span class=\"mtk8\">&quot;./src&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">29</span><span class=\"mtk12\">:</span><span class=\"mtk1\">   },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">30</span><span class=\"mtk12\">:</span><span class=\"mtk1\">   </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">31</span><span class=\"mtk12\">:</span><span class=\"mtk1\">     </span><span class=\"mtk12\">version</span><span class=\"mtk1\">: </span><span class=\"mtk8\">&quot;0.8.8&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">32</span><span class=\"mtk12\">:</span><span class=\"mtk1\">     </span><span class=\"mtk12\">settings</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">33</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       </span><span class=\"mtk12\">optimizer</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">34</span><span class=\"mtk12\">:</span><span class=\"mtk1\">         </span><span class=\"mtk12\">enabled</span><span class=\"mtk1\">: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">35</span><span class=\"mtk12\">:</span><span class=\"mtk1\">         </span><span class=\"mtk12\">runs</span><span class=\"mtk1\">: </span><span class=\"mtk7\">200</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">36</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">37</span><span class=\"mtk12\">:</span><span class=\"mtk1\">     },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">38</span><span class=\"mtk12\">:</span><span class=\"mtk1\">   },</span></span></span></code></pre>\n<h2 id=\"g-27-open-the-optimizer\" style=\"position:relative;\"><a href=\"#g-27-open-the-optimizer\" aria-label=\"g 27 open the optimizer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-27] Open the optimizer</h2>\n<p>Always use the Solidity optimizer to optimize gas costs. It’s good practice to set the optimizer as high as possible until it no longer helps reduce gas costs in function calls. This is advisable since function calls are intended to be executed many more times than contract deployment, which only happens once.</p>\n<p>In the light of this information, I suggest you to open the optimizer for <code>v2-library</code>.</p>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-3\">High Risk Findings (3)</a></p>\n<ul>\n<li><a href=\"#h-01-rebalance-logic-is-wrong-and-this-distorts-the-pools-important-states\">[H-01] Rebalance logic is wrong and this distorts the pool’s important states</a></li>\n<li><a href=\"#h-02-timeswapv2liquiditytoken-should-not-use-totalsupply1-as-tokenid\">[H-02] TimeswapV2LiquidityToken should not use <code>totalSupply()+1</code> as tokenId</a></li>\n<li><a href=\"#h-03-the-collect-function-will-always-transfer-zero-fees-losing-_feespositions-without-receiving-fees\">[H-03] The <code>collect()</code> function will always TRANSFER ZERO fees, losing _feesPositions without receiving fees!</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-7\">Medium Risk Findings (7)</a></p>\n<ul>\n<li><a href=\"#m-01-_currentindex-is-incorrectly-updated-breaking-the-erc1155-enumerable-implementation\">[M-01] <code>_currentIndex</code> is incorrectly updated; breaking the ERC1155 enumerable implementation</a></li>\n<li><a href=\"#m-02-burning-a-erc1155enumerable-token-doesnt-remove-it-from-the-enumeration-\">[M-02] Burning a <code>ERC1155Enumerable</code> token doesn’t remove it from the enumeration </a></li>\n<li><a href=\"#m-03-fee-on-transfer-tokens-will-not-behave-as-expected\">[M-03] Fee on transfer tokens will not behave as expected</a></li>\n<li><a href=\"#m-04-sqrtdiscriminant-can-be-calculated-wrong\">[M-04] sqrtDiscriminant can be calculated wrong</a></li>\n<li><a href=\"#m-05-unexpected-overflow-for-fullmathadd512-which-can-result-in-irregular-behavior\">[M-05] unexpected overflow for <code>FullMath.add512()</code> which can result in irregular behavior</a></li>\n<li><a href=\"#m-06-_ownedtokensindex-is-shared-by-different-owners-as-a-result-_removetokenfromalltokensenumeration-might-remove-the-wrong-tokenid-\">[M-06] <code>_ownedTokensIndex</code> is SHARED by different owners, as a result, <code>_removeTokenFromAllTokensEnumeration</code> might remove the wrong tokenId. </a></li>\n<li><a href=\"#m-07-mint-function-does-not-update-liquidityposition-state-of-caller-before-minting-lp-tokens-this-\">[M-07] <code>Mint</code> function does not update <code>LiquidityPosition</code> state of caller before minting LP tokens. This </a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#01-user-can-possibly-transfer-no-token0-or-token1-to-timeswapv2option-contract-if-corresponding-token0-or-token1-is-a-rebasing-token\">01 User can possibly transfer no <code>token0</code> or <code>token1</code> to <code>TimeswapV2Option</code> contract if corresponding <code>token0</code> OR <code>token1</code> is a rebasing token</a></li>\n<li><a href=\"#02-errorcheckenough-function-does-not-prevent-user-from-sending-too-many-tokens-to-relevant-contract\">02 <code>Error.checkEnough</code> function does not prevent user from sending too many tokens to relevant contract</a></li>\n<li><a href=\"#03-pool-considers-option-not-matured-when-its-maturity-and-the-block-timestamp-are-equal\">03 Pool considers option not matured when its maturity and the block timestamp are equal</a></li>\n<li><a href=\"#04-pools-paramlibrarycheck-function-for-timeswapv2poolcollectparam-checks-paramstrike--0-less-restrictively-than-pools-other--paramlibrarycheck-functions\">04 Pool’s <code>ParamLibrary.check</code> function for <code>TimeswapV2PoolCollectParam</code> checks <code>param.strike == 0</code> less restrictively than pool’s other  <code>ParamLibrary.check</code> functions</a></li>\n<li><a href=\"#05-redundant-named-returns\">05 Redundant named returns</a></li>\n<li><a href=\"#06-wordtyping-typos\">06 Word/typing typos</a></li>\n<li><a href=\"#07-confusing-natspec-param-usage\">07 Confusing NatSpec <code>@param</code> usage</a></li>\n<li><a href=\"#08-incomplete-natspec-comments\">08 Incomplete NatSpec Comments</a></li>\n<li><a href=\"#09-missing-natspec-comments\">09 Missing NatSpec comments</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#gas-optimizations-summary\">Gas Optimizations Summary</a></li>\n<li><a href=\"#g-01-gas-saving-is-achieved-by-removing-the-delete-keyword-60k\">G-01 Gas saving is achieved by removing the <code>delete</code> keyword (~60k)</a></li>\n<li><a href=\"#g-02-remove-checkdoesnotexist-function\">G-02 Remove <code>checkDoesNotExist</code> function</a></li>\n<li><a href=\"#g-03-avoid-using-state-variable-in-emit-130-gas\">G-03 Avoid using <code>state variable</code> in emit (130 gas)</a></li>\n<li><a href=\"#g-04-change-public-state-variable-visibility-to-private\">G-04 Change <code>public</code> state variable visibility to <code>private</code></a></li>\n<li><a href=\"#g-05-save-gas-with-the-use-of-the-import-statement\">G-05 Save gas with the use of the import statement</a></li>\n<li><a href=\"#g-06-gas-savings-can-be-achieved-by-changing-the-model-for-assigning-value-to-the-structure-260-gas\">G-06 Gas savings can be achieved by changing the model for assigning value to the structure (260 gas)</a></li>\n<li><a href=\"#g-07-using-delete--instead-of-setting-struct-0-saves-gas\">G-07 Using <code>delete</code>  instead of setting struct <code>0</code> saves gas</a></li>\n<li><a href=\"#g-08-in-div-512-function-quotient-0-aggregate-operation-is-used-with-unchecked-to-save-gas\">G-08 In <code>div 512</code> function, <code>quotient 0</code> aggregate operation is used with unchecked to save gas</a></li>\n<li><a href=\"#g-09-avoid-using-external-call\">G-09 Avoid using external call</a></li>\n<li><a href=\"#g-10-gas-overflow-during-iteration-dos\">G-10 Gas overflow during iteration (DoS)</a></li>\n<li><a href=\"#g-11-move-owner-checks-to-a-modifier-for-gas-efficant\">G-11 Move owner checks to a modifier for gas efficant</a></li>\n<li><a href=\"#g-12-use-a-more-recent-version-of-solidity\">G-12 Use a more recent version of solidity</a></li>\n<li><a href=\"#g-13-use-nested-if-and-avoid-multiple-check-combinations\">G-13 Use nested if and, avoid multiple check combinations</a></li>\n<li><a href=\"#g-14-sort-solidity-operations-using-short-circuit-mode\">G-14 Sort Solidity operations using short-circuit mode</a></li>\n<li><a href=\"#g-15--costs-less-gas-than-\">G-15 <code>>=</code> costs less gas than <code>></code></a></li>\n<li><a href=\"#g-16-using-uniswapv3-muldiv-function-is-gas-optimized\">G-16 Using UniswapV3 <code>mulDiv</code> function is gas-optimized</a></li>\n<li><a href=\"#g-17-using-openzeppelin-ownable2stepsol-is-gas-efficient\">G-17 Using Openzeppelin Ownable2Step.sol is gas efficient</a></li>\n<li><a href=\"#g-18-openzeppelins-reentrancyguard-contract-is-gas-optimized\">G-18 OpenZeppelin’s ReentrancyGuard contract is gas-optimized</a></li>\n<li><a href=\"#g-19-save-gas-with-the-use-of-the-import-statement\">G-19 Save gas with the use of the import statement</a></li>\n<li><a href=\"#g-20-remove-import-forge-stdconsolesol\">G-20 Remove import <code>forge-std/console.sol</code></a></li>\n<li><a href=\"#g-21-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\">G-21 Usage of uints/ints smaller than 32 bytes (256 bits) incurs overhead</a></li>\n<li><a href=\"#g-22-use-assembly-to-write-address-storage-values\">G-22 Use <code>assembly</code> to write <em>address storage values</em></a></li>\n<li><a href=\"#g-23-setting-the-constructor-to-payable\">G-23 Setting the <em>constructor</em> to <code>payable</code></a></li>\n<li><a href=\"#g-24-avoid-contract-existence-checks-by-using-solidity-version-0810-or-later\">G-24 Avoid contract existence checks by using solidity version 0.8.10 or later</a></li>\n<li><a href=\"#g-25-optimize-names-to-save-gas\">G-25 Optimize names to save gas</a></li>\n<li><a href=\"#g-26-upgrade-soliditys-optimizer\">G-26 Upgrade Solidity’s optimizer</a></li>\n<li><a href=\"#g-27-open-the-optimizer\">G-27 Open the optimizer</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}