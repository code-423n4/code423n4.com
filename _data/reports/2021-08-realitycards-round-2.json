{
  "circa": {
    "title": "Reality Cards (round 2)",
    "sponsor": "Reality Cards",
    "slug": "2021-08-realitycards",
    "date": "2021-09-21",
    "findings": "https://github.com/code-423n4/2021-08-realitycards-findings/issues",
    "contest": 26
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code 432n4 (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the code contest outlined in this document, C4 conducted an analysis of the Reality Cards smart contract system written in Solidity. The code contest took place between August 18—August 25 2021.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>11 Wardens contributed reports to the Reality Cards (round 2) code contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/gpersoon\">gpersoon</a></li>\n<li><a href=\"https://twitter.com/Tensors8\">tensors</a></li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li><a href=\"https://twitter.com/liam_eastwood13\">leastwood</a></li>\n<li><a href=\"https://twitter.com/MukeshJ_eth\">Jmukesh</a></li>\n<li><a href=\"https://twitter.com/HickupH\">hickuphh3</a></li>\n<li><a href=\"https://github.com/x9453\">shw</a></li>\n<li><a href=\"https://twitter.com/0xImpostor\">0xImpostor</a></li>\n<li><a href=\"https://github.com/0xsanson\">0xsanson</a></li>\n<li><a href=\"https://twitter.com/qedk\">qedk</a></li>\n<li><a href=\"https://twitter.com/PierrickGT\">PierrickGT</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://github.com/0xean\" title=\"judge\">0xean</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/money_lego\">moneylegobatman</a> and <a href=\"https://twitter.com/_ninek_\">ninek</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 30 unique vulnerabilities. All of the issues presented here are linked back to their original finding</p>\n<p>Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity, 3 received a risk rating in the category of MEDIUM severity, and 25 received a risk rating in the category of LOW severity.</p>\n<p>C4 analysis also identified 11 non-critical recommendations and 9 gas optimizations.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2021-08-realitycards\">C4 Reality Cards (Round 2) code contest repository</a> is comprised of 26 smart contracts written in the Solidity programming language and includes 7,770 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-2\" style=\"position:relative;\"><a href=\"#high-risk-findings-2\" aria-label=\"high risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (2)</h1>\n<h2 id=\"h-01-findnewowner-edgecase\" style=\"position:relative;\"><a href=\"#h-01-findnewowner-edgecase\" aria-label=\"h 01 findnewowner edgecase permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/27\">[H-01] <code>findNewOwner</code> edgecase</a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<p>In the function <code>findNewOwner</code> of <code>RCOrderbook</code>, as loop is done which included the check  <code>_loopCounter &#x3C; maxDeletions</code>\nAfterwards, a check is done for  “(<em>loopCounter != maxDeletions)” to determine if the processing is finished.\nIf `</em>loopCounter == maxDeletions` then the conclusion is that it isn’t finished yet.</p>\n<p>However, there is the edgecase that the processing might just be finished at the same time as <code>_loopCounter == maxDeletions</code>.</p>\n<p>You can see this the best if you assume <code>maxDeletions==1</code>, in that case it will never draw the conclusion it is finished.\nOf course having <code>maxDeletions==1</code> is very unlikely in practice.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"549\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"550\"></span><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">findNewOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_card</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_timeOwnershipChanged</span><span class=\"mtk1\">)  </span><span class=\"mtk11\">external</span><span class=\"mtk1\">  </span><span class=\"mtk11\">override</span><span class=\"mtk1\">  </span><span class=\"mtk11\">onlyMarkets</span><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"551\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"552\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// delete current owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"553\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">do</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"554\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_newPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_removeBidFromOrderbookIgnoreOwner</span><span class=\"mtk1\">( </span><span class=\"mtk12\">_head</span><span class=\"mtk1\">.</span><span class=\"mtk12\">next</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_market</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_card</span><span class=\"mtk1\"> );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"555\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_loopCounter</span><span class=\"mtk1\">++;             </span><span class=\"mtk3\">// delete next bid if foreclosed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"556\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">while</span><span class=\"mtk1\"> (    </span><span class=\"mtk12\">treasury</span><span class=\"mtk1\">.</span><span class=\"mtk11\">foreclosureTimeUser</span><span class=\"mtk1\">( </span><span class=\"mtk12\">_head</span><span class=\"mtk1\">.</span><span class=\"mtk12\">next</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_newPrice</span><span class=\"mtk1\">,  </span><span class=\"mtk12\">_timeOwnershipChanged</span><span class=\"mtk1\"> ) &lt;  </span><span class=\"mtk12\">minimumTimeToOwnTo</span><span class=\"mtk1\"> &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"557\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_loopCounter</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">maxDeletions</span><span class=\"mtk1\"> );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"558\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"559\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_loopCounter</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">maxDeletions</span><span class=\"mtk1\">) {   </span><span class=\"mtk3\">// the old owner is dead, long live the new owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"560\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_newOwner</span><span class=\"mtk1\"> = ....</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"561\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"562\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"563\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// we hit the limit, save the old owner, we&#39;ll try again next time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"564\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"565\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"566\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Recommend using a different way to determine that the processing is done. This could save some gas.\nNote: the additional check also costs gas, so you have to verify the end result.</p>\n<p>Perhaps in <code>setDeletionLimit</code>, doublecheck that <code>_deletionLimit</code> > 1.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/27#issuecomment-905499584\">Splidge (Reality Cards) confirmed and disagreed with severity</a>:</strong></p>\n<blockquote>\n<p>oh wow, this is actually a really big problem. It’s easier to see it if <code>maxDeletions</code> is 1 but it exists with any size of <code>maxDeletions</code>.\nWhenever we find a valid owner on the final iteration of the loop the if statement will simply check if it was the final loop. That valid owner is then assumed to be invalid and saved for the next transaction to try and find a new owner. When that next transaction happens the valid owner is immediately deleted and not given any ownership of the card at all.\nI think this just falls short of 3 (High risk) because I don’t think it’d be possible for an attacker to engineer the situation to have a particular user deleted without ownership. But I believe this would count as 2 (Med risk) because the protocol <a href=\"https://docs.code4rena.com/roles/wardens/judging-criteria#estimating-risk-tl-dr\">“availability could be impacted”</a> for the user that is deleted.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/27#issuecomment-905523120\">Splidge (Reality Cards) commented</a>:</strong></p>\n<blockquote>\n<p>I have since thought of an attack that could have used this and might raise it to 3 (High risk).</p>\n<p>Due to the difficultly of monitoring which cards you own all the time a valid strategy which some users employ is to bid high enough to scare off other users (usually bidding significantly beyond the 10% minimum increase). Suppose Alice employs this strategy by bidding $100 on a card that was previously only $10.\nMal (our attacker) wishes to rent the card but wants to pay less than $100. Mal could use Sybil accounts to place <code>maxDeletions - 1</code> bids all for the minimum rental duration (only funding the accounts for the minimum duration). Mal would then need to wait for the minimum duration of all these bids to expire, <code>(maxDeletions - 1 ) * minimumRentalDuration</code>\nOnce this has completed Mal can place a bid at $11, this will trigger a rent collection which will attempt to <code>findNewOwner</code>, Alice being the user that was found on the last iteration of the loop would be considered as invalid. There will not be a change of ownership or any events emitted about this until the next rent collection is triggered.\nThis means that the UI would still consider Alice to be the owner of card (Mals’ Sybil bids having had <code>LogRemoveFromOrderbook</code> and <code>LogUserForeclosed</code> events emitted) and other users might not consider trying to outbid this, whereas actually Mal is accruing time at a significantly cheaper rate.</p>\n<p>Thinking about it, this doesn’t really even need Alice at all, Mal could have placed all the higher bids to simultaneously scare off other users while renting at a lower price.</p>\n<p>I think the fix is relatively simple, by checking if we found a valid user OR hit the deletion limit we can make it so that we don’t skip any bids. This would then leave Alice (or Mal in the other version) correctly having to pay for the time at the higher price.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/27#issuecomment-911673904\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>upgrading based on sponsors analysis</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/27#issuecomment-914180653\">Splidge (Reality Cards) patched</a>:</strong></p>\n<blockquote>\n<p>Fixed <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/9f81f683ea0d2ab41ab91ba9188baf594012c295\">here</a></p>\n</blockquote>\n<h2 id=\"h-02-uberowner-has-too-much-power\" style=\"position:relative;\"><a href=\"#h-02-uberowner-has-too-much-power\" aria-label=\"h 02 uberowner has too much power permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/74\">[H-02] <code>UberOwner</code> has too much power</a></h2>\n<p><em>Submitted by tensors</em></p>\n<p>The Uber Owner has too much power within the system. This makes the protocol closer to a centralized prediction market whose rules are determined by the Uber Owner. See issue page for referenced code</p>\n<p>The above functions can be used by the Uber Owner to completely change the functionality of the system.\nThis goes well beyond simple setting new constants and fees, the Uber Owner can basically reprogram how the entire protocol works. Not to mention if the address falls into the wrong hands.</p>\n<p>Recommend limiting the permission of the Uber Owner to something more manageable and trustable. If upgrades to underlying contracts are required they can be done through a proxy instead, in the standard way.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/74#issuecomment-906225388\">mcplums (Reality Cards) disputed</a>:</strong></p>\n<blockquote>\n<p>This is a subjective opinion- there is always going to be a compromise between decentralisation and the ability to respond to potential problems. The latter is especially important with a protocol that is so new.</p>\n<p>There is no correct answer here, but the current abilities of <code>uberOwner</code> were decided after a lot of thought and are in line with other DeFi protocols.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/74#issuecomment-906236023\">Splidge (Reality Cards) commented</a>:</strong></p>\n<blockquote>\n<p>I’d just like to add that we did recognize the power of the UberOwner which is why it is separated from the Owner specifically so that we can add additional security to it (in the form of a multisig) and so that we can relinquish this control at the appropriate time.\nThis was covered in the <a href=\"https://github.com/code-423n4/2021-08-realitycards#mortar_board-governance-mortar_board\">readme</a>.\nAnd also <a href=\"https://github.com/code-423n4/2021-08-realitycards/blob/39d711fdd762c32378abf50dc56ec51a21592917/contracts/RCTreasury.sol#L288-L291\">commented </a>in the code.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/74#issuecomment-911717998\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I think the warden(s) have a valid point here. This is an incredible amount of power for a single address to yield over the protocol, even if backed by a multi-sig.</p>\n<p>Is it no an option to 1) pause all activity, and unlock all funds allowing users to withdraw their own funds or 2) pause all activity besides withdraws and implement a time delay between that and the “rug pull” function being called.</p>\n<p>The readme also states</p>\n<p><code>Alternatively we may wish for this to be a multisig but the normal owner to not be, for convenience.</code></p>\n<p>Without a multisig, I believe this absolutely qualifies as a high severity issue as a compromise of a single end user address compromises the entire system, with a multisig it potentially lowers the severity down to a medium, but its still a risk that is worth highlighting in the system and for the sponsor to scrutinize if there are indeed other mitigation paths that could be taken.</p>\n</blockquote>\n<h1 id=\"medium-risk-findings-3\" style=\"position:relative;\"><a href=\"#medium-risk-findings-3\" aria-label=\"medium risk findings 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (3)</h1>\n<h2 id=\"m-01-uninitialized-variable-marketwhitelist-in-rctreasurysol\" style=\"position:relative;\"><a href=\"#m-01-uninitialized-variable-marketwhitelist-in-rctreasurysol\" aria-label=\"m 01 uninitialized variable marketwhitelist in rctreasurysol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/18\">[M-01] Uninitialized Variable <code>marketWhitelist</code> in <code>RCTreasury.sol</code></a></h2>\n<p><em>Submitted by leastwood, also found by 0xsanson, gpersoon, hickuphh3 and JMukesh</em></p>\n<p>The variable, <code>marketWhitelist</code>, is never initialized in the contract <code>RCTreasury.sol</code>. As a result, the function <code>marketWhitelistCheck()</code>  does not perform a proper check on whitelisted users for a restricted market. Additionally, the function will always return <code>true</code>, even if a market wishes to restrict its users to a specific role.</p>\n<p>The initial state variable is defined in <a href=\"https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCTreasury.sol#L75\"><code>RCTreasury.sol</code> L75</a>.</p>\n<p>The state variable <code>marketWhitelist</code> is accessed in the function <code>RCTreasury.marketWhitelistCheck()</code> at <a href=\"https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCTreasury.sol#L269-L281\"><code>RCTreasury.sol</code> L269-L281</a>.</p>\n<p>The function <code>RCTreasury.marketWhitelistCheck()</code> is called in <code>RCMarket.newRental()</code> at <a href=\"https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCMarket.sol#L758-L761\"><code>RCMarket.sol</code> L758-L761</a>. The comment indicates that there should be some ability to restrict certain markets to specific whitelists, however, there are no methods in <code>RCTreasury</code> that allow a market creator to enable this functionality.</p>\n<p>Recommend ensuring this behavior is intended. If this is not the case, consider adding a function that enables a market creator to restrict their market to a specific role by whitelisting users.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/18#issuecomment-905413207\">Splidge (Reality Cards) confirmed and disagreed with severity</a>:</strong></p>\n<blockquote>\n<p>I think the severity could be double-checked on this one.\nIt’s a close one but I’d be tempted to put it under 1 (low risk) as a “Function incorrect to spec”.\nRegardless, this will be fixed.</p>\n<p>Edit: I notice the duplicates were both marked as 1 (low risk).</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/18#issuecomment-910962066\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>based on ” but the function of the protocol or its availability could be impacted” in the code4 docs, I am going to agree with warden and leave this as a 2.  The function of the protocol is certainly impacted in a case where the whitelist if not working correctly.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/18#issuecomment-914175471\">Splidge (Reality Cards) patched</a>:</strong></p>\n<blockquote>\n<p>Fixed <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/1515f87e97be1ed09316340e19caea5c12242c17\">here</a></p>\n</blockquote>\n<h2 id=\"m-02-parameter-updates-not-propagated\" style=\"position:relative;\"><a href=\"#m-02-parameter-updates-not-propagated\" aria-label=\"m 02 parameter updates not propagated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/30\">[M-02] Parameter updates not propagated</a></h2>\n<p><em>Submitted by gpersoon, also found by cmichel</em></p>\n<p>There are several functions to update parameters. However these parameters are only updated on the top level and not propagated to the other contracts. This could lead to various unpredictable results.\nExamples are:</p>\n<ul>\n<li><code>setNftHubAddress</code> of <code>RCFactory</code></li>\n<li><code>setOrderbookAddress</code> of <code>RCFactory</code></li>\n<li><code>setLeaderboardAddress</code> of <code>RCFactory</code></li>\n<li><code>setMinRental</code> of <code>RCTreasury</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"586\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"587\"></span><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setNftHubAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IRCNftHubL2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newAddress</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyUberOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"588\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_newAddress</span><span class=\"mtk1\">) != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Must set Address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"589\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">nfthub</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_newAddress</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"590\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"591\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"592\"></span><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setOrderbookAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IRCOrderbook</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newOrderbook</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"593\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">( </span><span class=\"mtk12\">treasury</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkPermission</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TREASURY</span><span class=\"mtk1\">, </span><span class=\"mtk11\">msgSender</span><span class=\"mtk1\">()), </span><span class=\"mtk8\">&quot;Not approved&quot;</span><span class=\"mtk1\"> );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"594\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">orderbook</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_newOrderbook</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"595\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"596\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"597\"></span><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setLeaderboardAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IRCLeaderboard</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newLeaderboard</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"598\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">( </span><span class=\"mtk12\">treasury</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkPermission</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TREASURY</span><span class=\"mtk1\">, </span><span class=\"mtk11\">msgSender</span><span class=\"mtk1\">()), </span><span class=\"mtk8\">&quot;Not approved&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"599\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">leaderboard</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_newLeaderboard</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"600\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"601\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"188\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"189\"></span><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setMinRental</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newDivisor</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">OWNER</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"190\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minRentalDayDivisor</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_newDivisor</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"191\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Recommend implementing a way to notify the underlying contracts of the updates.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/30#issuecomment-904726786\">Splidge (Reality Cards) acknowledged</a>:</strong></p>\n<blockquote>\n<p>We have come to realise that it is very unlikely we will be able to change certain contracts once they are in-use, the exception being the market where a new reference could be deployed.\nIn practice we do use <code>setNftHubAddress</code> shortly after deploying new contracts, this is so that we can continue to use an existing NFT hub that has already been put through Matic Mintable Asset mapping, but changing this while a market is active would cause problems.\nWhile we accept that changing these parameters on active contracts may be troublesome we will not be making changes at this time, partly because it’s useful to be able to change these before the contracts are in use but also due to the potential risk of introducing new problems at this stage in the project.</p>\n</blockquote>\n<h2 id=\"m-03-deposits-dont-work-with-fee-on-transfer-tokens\" style=\"position:relative;\"><a href=\"#m-03-deposits-dont-work-with-fee-on-transfer-tokens\" aria-label=\"m 03 deposits dont work with fee on transfer tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/58\">[M-03] Deposits don’t work with fee-on transfer tokens</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>There are ERC20 tokens that may make certain customizations to their ERC20 contracts.\nOne type of these tokens is deflationary tokens that charge a certain fee for every <code>transfer()</code> or <code>transferFrom()</code>.\nOthers are rebasing tokens that increase in value over time like Aave’s aTokens (<code>balanceOf</code> changes over time).</p>\n<p>The <code>RCTreasury.deposit()</code> function will credit more deposits than the contract actually received:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">erc20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk11\">msgSender</span><span class=\"mtk1\">(), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">user</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_user</span><span class=\"mtk1\">].</span><span class=\"mtk12\">deposit</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Recommend ensuring that the <code>erc20</code> token does not implement any customizations.\nAlternatively, a mitigation is to measure the asset change right before and after the asset-transferring routines</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/58#issuecomment-906322667\">Splidge (Reality Cards) acknowledged</a>:</strong></p>\n<blockquote>\n<p>The issue that <a href=\"https://github.com/code-423n4/2021-06-realitycards-findings/issues/152\">keeps on giving..</a></p>\n<p><img src=\"https://user-images.githubusercontent.com/73956628/130954991-f6f29f54-926f-4e68-b4cb-f73ed1dc3c95.jpg\" alt=\"takemymoney\"></p>\n</blockquote>\n<h1 id=\"low-risk-findings-25\" style=\"position:relative;\"><a href=\"#low-risk-findings-25\" aria-label=\"low risk findings 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Findings (25)</h1>\n<h2 id=\"l-01-cant-retrieve-all-data-with-getmarketinfo-\" style=\"position:relative;\"><a href=\"#l-01-cant-retrieve-all-data-with-getmarketinfo-\" aria-label=\"l 01 cant retrieve all data with getmarketinfo  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/14\">[L-01] Can’t retrieve all data with <code>getMarketInfo</code> </a></h2>\n<p><em>Submitted by gpersoon, also found by hickuphh3 and cmichel</em></p>\n<p>The function <code>getMarketInfo</code> of <code>RCFactory</code> only can give results back in the range 0…<code>marketInfoResults</code>\nSupplying <code>_skipResults</code> doesn’t help, it then just skips the first <code>_skipResults</code>  records.</p>\n<p>Assume <code>marketInfoResults</code> == 10 and <code>_skipResults</code> == 20:\nThen no result will be given back because ”<code>_resultNumber</code> &#x3C; <code>marketInfoResults</code>” will never allow <code>_resultNumber</code>  to be bigger than 10</p>\n<p>Note: this is low risk because <code>getMarketInfo</code> is a backup function (although you maybe want the backup to function as expected)</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"227\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"228\"></span><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getMarketInfo</span><span class=\"mtk1\">( IRCMarket.Mode </span><span class=\"mtk12\">_mode</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_state</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_skipResults</span><span class=\"mtk1\">  )  </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"229\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> ( </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">, </span><span class=\"mtk12\">string</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">, </span><span class=\"mtk12\">string</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"230\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    ..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"231\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_resultNumber</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"232\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    ..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"233\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">while</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_resultNumber</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">marketInfoResults</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_marketIndex</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"234\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"235\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_resultNumber</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_skipResults</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"236\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_resultNumber</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"237\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"238\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_marketAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_resultNumber</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_market</span><span class=\"mtk1\">;   </span><span class=\"mtk3\">// will never reach this part if _skipResults &gt;= marketInfoResults</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"239\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">                ....</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"240\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_resultNumber</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"241\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"242\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"243\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"244\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_marketAddresses</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_ipfsHashes</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_slugs</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_potSizes</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Recommend updating the code to something like the following:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">idx</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">while</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">idx</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">marketInfoResults</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_marketIndex</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_marketIndex</span><span class=\"mtk1\">--;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_market</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">marketAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_mode</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_marketIndex</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">IRCMarket</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">).</span><span class=\"mtk11\">state</span><span class=\"mtk1\">() == </span><span class=\"mtk12\">IRCMarket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">States</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_state</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_resultNumber</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_skipResults</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_resultNumber</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_marketAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">idx</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_market</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_ipfsHashes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">idx</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">ipfsHash</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_slugs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">idx</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">addressToSlug</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_potSizes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">idx</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">IRCMarket</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">).</span><span class=\"mtk11\">totalRentCollected</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">idx</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/14#issuecomment-904562553\">Splidge (Reality Cards) confirmed</a>:</strong></p>\n<blockquote>\n<p>Yep, this was a last minute untested addition.\nIn implementing your recommended fix I hit “Stack too deep” problems, so have split the function in two with one being internal. Firstly <code>getMarketInfo</code> will get the market addresses required and then <code>_getMarketInfo</code> will get the additional info required. This change has allowed me to remove the separate <code>marketResults</code> variable and pass the required number of results directly to <code>getMarketInfo</code>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/14#issuecomment-914174309\">Splidge (Reality Cards) patched</a>:</strong></p>\n<blockquote>\n<p>Fixed <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/65e7ed4266ee6b329e134e3b392c5210b1e767b6\">here</a></p>\n</blockquote>\n<h2 id=\"l-02-return-value-of-erc20approve-is-unchecked\" style=\"position:relative;\"><a href=\"#l-02-return-value-of-erc20approve-is-unchecked\" aria-label=\"l 02 return value of erc20approve is unchecked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/64\">[L-02] Return value of <code>erc20.approve</code> is unchecked</a></h2>\n<p><em>Submitted by shw</em></p>\n<p>The <code>SafeERC20</code> library is used in the <code>RCTreasury</code> contract to handle the transfer of tokens that are not compliant with the ERC20 specification. However, in <a href=\"https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCTreasury.sol#L347\">line 347</a>, the <code>approve</code> function is used instead of the <code>safeApprove</code> function. Tokens not compliant with the ERC20 specification could return <code>false</code> from the <code>approve</code> function call to indicate the approval fails, while the calling contract would not notice the failure if the return value is not checked.</p>\n<p>Recommend using the <code>safeApprove</code> function instead, which reverts the transaction with a proper error message when the return value of <code>approve</code> is <code>false</code>. A better approach is to use the <code>safeIncreaseAllowance</code> function, which mitigates the multiple withdrawal attack on ERC20 tokens.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/64#issuecomment-906277076\">Splidge (Reality Cards) disputed</a>:</strong></p>\n<blockquote>\n<p>I do not think using <code>safeApprove</code> would help here.\nGiven the premise that the ERC20 in use is non-compliant and the approval fails, does it matter if the contracts are made aware of this or not? In either case transfers to the bridge contract would not be possible. The solution therefore isn’t a different approval but using a different ERC20 which is compliant. Using a different ERC20 isn’t necessary as the one we have chosen, USDC, is compliant.</p>\n<p><code>safeIncreaseAllowance</code> wouldn’t make any difference either, we are approving the transfer of more tokens than exist, it’d be pretty impressive to see a multiple withdrawal attack manage to withdraw enough tokens to warrant using the additional approval. A rough calculation shows that if you moved the entire USDC supply on Polygon in a single transaction (assuming the lower end gas 50k) it’d still take <code>2.89*10^23</code> blocks filled with transfers before you get to the limit of a <code>type(uin256).max</code> approval, even if we sped Polygon up to 10 blocks/second that’d still take 67,000 x the age of the universe to process 🤯, but certainly after that we wouldn’t want anybody using the extra approval.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/64#issuecomment-911037276\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with warden that it would be better to use safeApprove and revert the setBridge call with a reasonable error message than fail silently.  The safeIncreaseAllowance doesn’t <em>need</em> to be implemented based on the use case. Using safeERC20 calls in a contract that are imports the library seems like a no brainer even if the expected use case doesn’t require it.  These contracts will potentially persist much longer past everyone remembering all the nuances of which ERC20 tokens work and which might not.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/64#issuecomment-911588412\">Splidge (Reality Cards) acknowldeged</a>:</strong></p>\n<blockquote>\n<p>Understood, changing to Acknowledged as for this use case there is no impact and any further changes will delay other audits and our time to launch.</p>\n</blockquote>\n<h2 id=\"l-03-direct-usage-of-ecrecover-allows-signature-malleability\" style=\"position:relative;\"><a href=\"#l-03-direct-usage-of-ecrecover-allows-signature-malleability\" aria-label=\"l 03 direct usage of ecrecover allows signature malleability permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/63\">[L-03] Direct usage of <code>ecrecover</code> allows signature malleability</a></h2>\n<p><em>Submitted by shw</em></p>\n<p>The <code>verify</code> function of <code>NativeMetaTransaction</code> calls the Solidity <code>ecrecover</code> function directly to verify the given signature. However, the <code>ecrecover</code> EVM opcode allows for malleable (non-unique) signatures and thus is susceptible to replay attacks. Although a replay attack on this contract is not possible since each user’s nonce is used only once, rejecting malleable signatures is considered a best practice.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/lib/NativeMetaTransaction.sol#L97\">NativeMetaTransaction.sol#L97</a></li>\n<li><a href=\"https://swcregistry.io/docs/SWC-117\">SWC-117: Signature Malleability</a></li>\n<li><a href=\"https://swcregistry.io/docs/SWC-121\">SWC-121: Missing Protection against Signature Replay Attacks</a></li>\n</ul>\n<p>Recommend using the <code>recover</code> function from <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/cryptography/ECDSA.sol\">OpenZeppelin’s ECDSA library</a> for signature verification.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/63#issuecomment-906293560\">Splidge (Reality Cards) disputed</a>:</strong></p>\n<blockquote>\n<p>This is a <a href=\"https://github.com/code-423n4/2021-06-realitycards-findings/issues/66\">duplicate </a>of an issue found in the last contest.</p>\n<p>It was not solved last time because we didn’t want to risk introducing problems by completely rewriting our own version of the MetaTx contract (the version we are using is from a trusted source and working in many production environments that have been audited), so instead of writing our own version I attempted to use the OpenZeppelin version. We need to use the upgradable versions of the OpenZeppelin contracts because we clone RCMarket.sol, however there was an incompatibility between ERC2771Context.sol which uses an <code>immutable</code> variable in the constructor and AccessControl.sol which calls _msgSender() in the constructor. Details on this can be found in <a href=\"https://forum.openzeppelin.com/t/erc2771context-typeerror-immutable-variables-cannot-be-read-during-contract-creation-time/8513/7\">this thread.</a>.</p>\n<p>As you can see in that thread the incompatibility has apparently been fixed, however this was done only 5 hours before the start of this contest (and after we had submitted the code for the contest), so it wasn’t practical to implement this solution for this contest. Regardless as you say this attack is “not possible since each user’s nonce is used only once”.</p>\n<p>I’ll mark this as ‘disputed’ for now, if the judges decide that we should have re-written our own version (or discovered time-travel and implemented the OpenZeppelin version that’s now availiable) then I’d be happy to change it to ‘acknowledged’ as we will not be making changes to such a sensitive area at this stage in the project.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/63#issuecomment-911050685\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Regardless of the solution and the mitigation steps the team is willing or not willing to take, I think highlighting the malleability issue is a valid 1 (Low Risk) issue that may not be worth fixing based on other risks as mentioned by @Splidge (Reality Cards)</p>\n</blockquote>\n<h2 id=\"l-04-return-value-is-not-validated\" style=\"position:relative;\"><a href=\"#l-04-return-value-is-not-validated\" aria-label=\"l 04 return value is not validated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/24\">[L-04] Return Value is Not Validated</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p>The <code>circuitBreaker()</code> function in <code>RCMarket.sol</code> is utilised in the event an oracle never provides a response to a RealityCards question. The function makes an external call to the <code>RCOrderbook.sol</code> contract through the <code>closeMarket()</code> function. If for some reason the orderbook was unable to be closed, this would never be checked in the <code>circuitBreaker()</code> function. See <a href=\"https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCMarket.sol#L1215-L1223\"><code>RCMarket.sol</code> L1215-L1223</a>.</p>\n<p>Recommend ensuring this is intended behavior, or otherwise validate the response of <code>orderbook.closeMarket()</code>. Another option would be to emit the result of the external call in the <code>LogStateChange</code> event, alongside the state change.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/24#issuecomment-906415282\">Splidge (Reality Cards) confirmed</a>:</strong></p>\n<blockquote>\n<p>We have decided that given the extra complexity added to the contracts since the <code>circuitBreaker</code> was first implemented it will no longer be able to perform all the required functions and so it will be removed.\nIf this call to the orderbook fails (or is removed) then users would not have their rentalRates reduced and so their funds would slowly be drained until the foreclose.\nWe also have <code>setAmicableResolution</code> which can be used in the event of an oracle failure.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/24#issuecomment-914179983\">Splidge (Reality Cards) patched</a>:</strong></p>\n<blockquote>\n<p><code>circuitBreaker</code> removed <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/ef67ce7410e08d97e909f899d73bbd337303ccc6\">here</a></p>\n</blockquote>\n<h2 id=\"l-05-external-call-made-before-state-change\" style=\"position:relative;\"><a href=\"#l-05-external-call-made-before-state-change\" aria-label=\"l 05 external call made before state change permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/23\">[L-05] External Call Made Before State Change</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p>There are a number of functions in <code>RCTreasury.sol</code> which make external calls to another contract before updating the underlying market balances. More specifically, these affected functions are <code>deposit()</code>, <code>sponsor()</code>, and <code>topupMarketBalance()</code>. As a result, these functions would be prone to reentrancy exploits. However, as <code>safeTransferFrom()</code> operates on a trusted ERC20 token (RealityCard’s token), this issue is of low severity. See issue page for reference code.</p>\n<p>Recommend modifying the aforementioned functions such that all state changes are made before a call to the ERC20 token using the <code>safeTransferFrom()</code> function.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/23#issuecomment-914179322\">Splidge (Reality Cards) confirmed and patched</a>:</strong></p>\n<blockquote>\n<p>Fixed <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/073164c1967ccde38f3d6be73608f99c0011c793\">here</a></p>\n</blockquote>\n<h2 id=\"l-06-test-coverage-improvements\" style=\"position:relative;\"><a href=\"#l-06-test-coverage-improvements\" aria-label=\"l 06 test coverage improvements permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/15\">[L-06] Test Coverage Improvements</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p>Adequate test coverage and regular reporting is an essential process in ensuring the codebase works as intended. Insufficient code coverage may lead to unexpected issues and regressions arising due to changes in the underlying smart contract implementation.</p>\n<p><img src=\"https://i.imgur.com/Seur7Fg.png\"></p>\n<p>Image above showcases total test coverage of the target contracts.</p>\n<p>Recommend ensuring the coverage report produced via <code>npx hardhat coverage</code> covers all functions within Reality Card’s smart contract suite.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/15#issuecomment-904563411\">Splidge (Reality Cards) acknowledged</a>:</strong></p>\n<blockquote>\n<p>We acknowledge further testing is important and will continue to improve the test coverage going forward.</p>\n</blockquote>\n<h2 id=\"l-07-rcfactory-solve-stack-too-deep-for-getmarketinfo\" style=\"position:relative;\"><a href=\"#l-07-rcfactory-solve-stack-too-deep-for-getmarketinfo\" aria-label=\"l 07 rcfactory solve stack too deep for getmarketinfo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/41\">[L-07] <code>RCFactory</code>: Solve stack too deep for <code>getMarketInfo()</code></a></h2>\n<p><em>Submitted by hickuphh3</em></p>\n<p>The <code>marketInfoResults</code> is a parameter used by <code>getMarketInfo()</code> to determine the length of results to return. As the <code>setMarketInfoResults()</code> comments state, “(it) would be better to pass this as a parameter in <code>getMarketInfo</code>.. however we are limited because of stack too deep errors”.</p>\n<p>This limitation can be overcome by defining the return array variables as the function output, as suggested below.</p>\n<p>The need for <code>marketInfoResults</code> and its setter function is then made redundant, whilst making querying results of possibly varying lengths more convenient.</p>\n<p>Recommend the following:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getMarketInfo</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  IRCMarket.Mode </span><span class=\"mtk12\">_mode</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_state</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_skipResults</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_numResults</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// equivalent of marketInfoResults</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_marketAddresses</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">string</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_ipfsHashes</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">string</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_slugs</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_potSizes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_marketIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">marketAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_mode</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t  </span><span class=\"mtk12\">_marketAddresses</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">_numResults</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t  </span><span class=\"mtk12\">_ipfsHashes</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">string</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">_numResults</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t  </span><span class=\"mtk12\">_slugs</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">string</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">_numResults</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t  </span><span class=\"mtk12\">_potSizes</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">_numResults</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/41#issuecomment-905468807\">Splidge (Reality Cards) confirmed</a>:</strong></p>\n<blockquote>\n<p>I wish I saw this before I did the fix to issue #14 , in implementing that fix I split <code>getMarketInfo()</code> in half making part of it internal which has managed to get around the “Stack too deep” problem and so I was able to get rid of <code>marketInfoResults</code> at the same time.\nStill this is useful to keep in mind for the future. 👍</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/41#issuecomment-914192246\">Splidge (Reality Cards) patched</a>:</strong></p>\n<blockquote>\n<p>Fixed alongside issue #14  <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/65e7ed4266ee6b329e134e3b392c5210b1e767b6\">here</a></p>\n</blockquote>\n<h2 id=\"l-08-rcfactory-do-multiplication-instead-of-division-for-length-checks\" style=\"position:relative;\"><a href=\"#l-08-rcfactory-do-multiplication-instead-of-division-for-length-checks\" aria-label=\"l 08 rcfactory do multiplication instead of division for length checks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/39\">[L-08] <code>RCFactory</code>: Do multiplication instead of division for length checks</a></h2>\n<p><em>Submitted by hickuphh3, also found by leastwood</em></p>\n<p>Solidity division rounds down, so doing <code>M / 2 &#x3C;= N</code> checks mean that <code>M</code> can be at most <code>2N + 1</code>.</p>\n<p>This affects the following checks:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t(</span><span class=\"mtk12\">_tokenURIs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">) &lt;= </span><span class=\"mtk12\">cardLimit</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk8\">&quot;Too many tokens to mint&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">_cardAffiliateAddresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t  </span><span class=\"mtk12\">_cardAffiliateAddresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == (</span><span class=\"mtk12\">_tokenURIs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk8\">&quot;Card Affiliate Length Error&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>Note that with the current implementation, if <code>_tokenURIs</code> is of odd length, its last element will be  redundant, but market creation will not revert.</p>\n<p>The stricter checks will partially mitigate <code>_tokenURIs</code> having odd length because <code>_cardAffiliateAddresses</code> is now required to be exactly twice that of <code>_tokenURIs</code>.</p>\n<p>These checks should be modified to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">_tokenURIs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">cardLimit</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">2</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk8\">&quot;Too many tokens to mint&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">_cardAffiliateAddresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t  </span><span class=\"mtk12\">_cardAffiliateAddresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_tokenURIs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk8\">&quot;Card Affiliate Length Error&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>In addition, consider adding a check for <code>_tokenURIs</code> to strictly be of even length.</p>\n<p><code>require(_tokenURIs.length % 2 == 0, \"TokenURI Length Error\");</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/39#issuecomment-914191597\">Splidge (Reality Cards) confirmed and patched</a>:</strong></p>\n<blockquote>\n<p>Fixed <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/3990f28f1f17aaf0b8df7b556d2976d8c6f8e2b5\">here</a></p>\n</blockquote>\n<h2 id=\"l-09-safer-implementation-of-tokenexists\" style=\"position:relative;\"><a href=\"#l-09-safer-implementation-of-tokenexists\" aria-label=\"l 09 safer implementation of tokenexists permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/8\">[L-09] safer implementation of <code>tokenExists</code></a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<p>The function <code>tokenExists</code> does only limited checks on the existence of cards.\nIt doesn’t doublecheck that <code>tokenIds[_card]</code> != 0\nThis is relevant because 0 is the default value of empty array elements. Although this isn’t a problem in the current code,\nfuture changes might accidentally introduce vulnerabilities.</p>\n<p>Also cards are only valid if they are below <code>numberOfCards</code>. This has led to vulnerabilities in previous versions of the contract\n(e.g. previous contest)</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"1139\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"1140\"></span><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">tokenExists</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_card</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"1141\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_card</span><span class=\"mtk1\">] != </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"1142\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Recommend changing the function to something like the following:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">tokenExists</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_card</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_cardId</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">numberOfCards</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">tokenIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_card</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_card</span><span class=\"mtk1\">] != </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/8#issuecomment-903581778\">Splidge (Reality Cards) confirmed</a>:</strong></p>\n<blockquote>\n<p>Obviously I didn’t learn my lesson from the last contest, I’ve added in the check that the card Id is less than the <code>numberOfCards</code>.</p>\n<p>However, I’m reluctant to disallow the use of tokenId 0. This would mean that the first NFT we mint wouldn’t be usable in a market, so we would need to create a dead market just to get rid of that first NFT. All things going well the first NFT minted could end up being a valuable one, who knows..? 🚀\nAn alternative would be for the factory to start minting from index 1 but this would mean instead of using the <code>totalSupply()</code> as the next token to mint, we would need to use <code>totalSupply() + 1</code> , I’m unsure how this would affect integration with services such as opensea where they may expect the first NFT to have index 0, I feel like at this late stage it’s too much of a change that could introduce other issues later, and so for now I’ll not be adding <code>if (tokenIds[_card] == 0) return false;</code></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/8#issuecomment-911826176\">Splidge (Reality Cards) patched</a>:</strong></p>\n<blockquote>\n<p>Fix to the check that the <code>_card</code> is a valid card number added in <a href=\"https://github.com/RealityCards/RealityCards-Contracts/pull/124/commits/315d2d12e461c2ddcffb20dbc5e9a97436d6eb2a\">this </a>commit</p>\n</blockquote>\n<h2 id=\"l-10-uint32-conversion-doesnt-work-as-expected\" style=\"position:relative;\"><a href=\"#l-10-uint32-conversion-doesnt-work-as-expected\" aria-label=\"l 10 uint32 conversion doesnt work as expected permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/28\">[L-10] <code>uint32</code> conversion doesn’t work as expected.</a></h2>\n<p><em>Submitted by gpersoon, also found by 0xsanson</em></p>\n<p>The <code>uint32</code> conversion in <code>setWinner</code> of the <code>RCMarket</code> doesn’t work as expected.\nThe first statement: ”<code>uint32(block.timestamp)</code>” already first the <code>block.timestamp</code> in a <code>uint32</code>.\nIf it is larger than <code>type(uint32).max</code> it wraps around and starts with 0 again\nThe testcode below shows this.</p>\n<p>Check for ”<code>&#x3C;= type(uint32).max</code>” in the second statement is useless because <code>_blockTimestamp</code> is always  &#x3C;= <code>type(uint32).max</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"507\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"508\"></span><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setWinner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_winningOutcome</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"509\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"510\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_blockTimestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"511\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_blockTimestamp</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint32</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Overflow&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"512\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"513\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"514\"></span><span class=\"grvsc-source\"><span class=\"mtk3\">//Testcode:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"515\"></span><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">7</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"516\"></span><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Convert</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"517\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">( </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint32</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\"> )+</span><span class=\"mtk7\">1</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// a==4294967296</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"518\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\">  </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">b</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">a</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// b==0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"519\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">c</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">a</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// c==0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"520\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Recommend doing the <code>require</code> first (without a typecast to <code>uint32</code>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">( </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint32</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Overflow&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_blockTimestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/28#issuecomment-905304973\">Splidge (Reality Cards) confirmed</a>:</strong></p>\n<blockquote>\n<p>Good to know about this. My assumption would have been that this overflow should have been guarded against with the inbuilt SafeMath with Solidity ^0.8.\nI suppose I put it right there in comments that this should have used SafeCast and not SafeMath 🤦‍♂️</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/28#issuecomment-914181238\">Splidge (Reality Cards) patched</a>:</strong></p>\n<blockquote>\n<p>Fixed <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/0724bc0c5b79682e0aaf461b33fa6b67156fa1bc\">here</a></p>\n</blockquote>\n<h2 id=\"l-11-msgsender-or-_msgsender\" style=\"position:relative;\"><a href=\"#l-11-msgsender-or-_msgsender\" aria-label=\"l 11 msgsender or _msgsender permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/22\">[L-11] <code>msgSender()</code> or <code>_msgSender()</code></a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<p>The code has two implementations of <code>msgSender</code>:</p>\n<ul>\n<li><code>msgSender()</code> => uses meta transaction signer</li>\n<li><code>_msgSender()</code> => maps to <code>msg.sender</code></li>\n</ul>\n<p><code>_msgSender()</code> is used in a few locations</p>\n<ul>\n<li>when using <code>_setupRole</code>, this seems legitimate</li>\n<li>in function <code>withdraw</code> (whereas the similar function <code>withdrawWithMetadata</code> uses <code>msgSender()</code> )</li>\n</ul>\n<p>It is confusing to have multiple functions with almost the same name, this could easily lead to mistakes.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"105\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"106\"></span><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">msgSender</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"107\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"108\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {   sender := </span><span class=\"mtk11\">shr</span><span class=\"mtk1\">(</span><span class=\"mtk7\">96</span><span class=\"mtk1\">, </span><span class=\"mtk11\">calldataload</span><span class=\"mtk1\">(</span><span class=\"mtk11\">sub</span><span class=\"mtk1\">(</span><span class=\"mtk11\">calldatasize</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">20</span><span class=\"mtk1\">)))   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"109\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"110\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"111\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"112\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sender</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"113\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Context.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"164\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"165\"></span><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"166\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(  </span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">() == </span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;ChildMintableERC721: INVALID_TOKEN_OWNER&quot;</span><span class=\"mtk1\"> ); </span><span class=\"mtk3\">// _msgSender()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"167\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">withdrawnTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"168\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"169\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawWithMetadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">( </span><span class=\"mtk11\">msgSender</span><span class=\"mtk1\">() == </span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;ChildMintableERC721: INVALID_TOKEN_OWNER&quot;</span><span class=\"mtk1\"> );  </span><span class=\"mtk3\">// msgSender()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">withdrawnTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Encoding metadata associated with tokenId &amp; emitting event</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TransferWithMetadata</span><span class=\"mtk1\">( </span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeTokenMetadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">) );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">RCNftHubL1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">_setupRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DEFAULT_ADMIN_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">RCNftHubL2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">_setupRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DEFAULT_ADMIN_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">RCTreasury</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">_setupRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DEFAULT_ADMIN_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">RCTreasury</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">_setupRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">UBER_OWNER</span><span class=\"mtk1\">,               </span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">RCTreasury</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">_setupRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">OWNER</span><span class=\"mtk1\">,                         </span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">RCTreasury</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">_setupRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">GOVERNOR</span><span class=\"mtk1\">,                   </span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">RCTreasury</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">_setupRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">WHITELIST</span><span class=\"mtk1\">,                    </span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">());</span></span></span></code></pre>\n<p>Recommend double-checking the use of  <code>_msgSender()</code> in withdraw and adjust if necessary. Also, adding comments when using  <code>_msgSender()</code>. And finally consider overriding <code>_msgSender()</code>, as is done in the example <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/metatx/ERC2771Context.sol\">here</a>:</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/22#issuecomment-903838922\">Splidge (Reality Cards) confirmed</a>:</strong></p>\n<blockquote>\n<p>I’m not sure this would have caused problems because we never intend to use <code>withdraw</code>, it’s simply there as a requirement for Matic Mintable Asset Mapping. But as we stated in the readme all functions should use <code>msgSender()</code> I have removed all instances of <code>_msgSender()</code></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/22#issuecomment-914177875\">Splidge (Reality Cards) patched</a>:</strong></p>\n<blockquote>\n<p>Fixed <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/7cf45e7e6730f733039e70be052088b91723dd6c\">here</a></p>\n</blockquote>\n<h2 id=\"l-12-rentallcards-dont-have-to-pay-for-card-you-already-own\" style=\"position:relative;\"><a href=\"#l-12-rentallcards-dont-have-to-pay-for-card-you-already-own\" aria-label=\"l 12 rentallcards dont have to pay for card you already own permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/21\">[L-12] <code>rentAllCards</code>: don’t have to pay for card you already own</a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<p>The function <code>rentAllCards</code> of <code>RCMarket</code> checks for <code>_maxSumOfPrices</code> to see you are not paying more that you want.</p>\n<p>However, the first part of the calculations (which calculate <code>_actualSumOfPrices</code> ), do not take in account the fact that you might\nalready own a card. (while the second part of the code does). If you already own the card you don’t have to pay for it and you certainly don’t have to pay the extra <code>minimumPriceIncreasePercent</code>.</p>\n<p>The code at “Proof of Concept” shows a refactored version of the code (see other issue “make code of <code>rentAllCards</code> easier to read”).\nThis immediately shows the issue.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCMarket.sol#L691 ==&gt; simplified version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">calc</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MIN_RENTAL_VALUE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\"> *(</span><span class=\"mtk12\">minimumPriceIncreasePercent</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">100</span><span class=\"mtk1\">)) / </span><span class=\"mtk7\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">rentAllCards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxSumOfPrices</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_actualSumOfPrices</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numberOfCards</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_actualSumOfPrices</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">calc</span><span class=\"mtk1\">(</span><span class=\"mtk12\">card</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">cardPrice</span><span class=\"mtk1\">);   </span><span class=\"mtk3\">// no check for  (ownerOf(i) != msgSender()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_actualSumOfPrices</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">_maxSumOfPrices</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Prices too high&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numberOfCards</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) != </span><span class=\"mtk11\">msgSender</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newPrice</span><span class=\"mtk1\">=</span><span class=\"mtk11\">calc</span><span class=\"mtk1\">(</span><span class=\"mtk12\">card</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">cardPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">newRental</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_newPrice</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">i</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Add ”<code>if (ownerOf(i) != msgSender()) {</code>” also in the first part of the code of <code>rentAllCards</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_actualSumOfPrices</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numberOfCards</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) != </span><span class=\"mtk11\">msgSender</span><span class=\"mtk1\">()) {              </span><span class=\"mtk3\">// extra if statement</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_actualSumOfPrices</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">calc</span><span class=\"mtk1\">(</span><span class=\"mtk12\">card</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">cardPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/21#issuecomment-914177127\">Splidge (Reality Cards) confirmed and patched</a>:</strong></p>\n<blockquote>\n<p>Fixed in the same commits as issue #20\n<a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/e01dbf4de444e2fc6446e49c8e2a942af635aa91\">Here </a>and <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/56a190eb7249882ccc1c75f73770d878b0c8e4cb\">here</a></p>\n</blockquote>\n<h2 id=\"l-13-getmostrecentmarket-can-revert\" style=\"position:relative;\"><a href=\"#l-13-getmostrecentmarket-can-revert\" aria-label=\"l 13 getmostrecentmarket can revert permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/13\">[L-13] <code>getMostRecentMarket</code> can revert</a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<p>The function <code>getMostRecentMarket</code> of <code>RCFactory.sol</code> will revert if no markets of the specific mode are created yet.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"171\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"172\"></span><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getMostRecentMarket</span><span class=\"mtk1\">(IRCMarket.Mode </span><span class=\"mtk12\">_mode</span><span class=\"mtk1\">)  </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\">  </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"173\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"174\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">marketAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_mode</span><span class=\"mtk1\">][</span><span class=\"mtk12\">marketAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_mode</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - (</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"175\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Recommend changing the function <code>getMostRecentMarket</code> to something like:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getMostRecentMarket</span><span class=\"mtk1\">(IRCMarket.Mode </span><span class=\"mtk12\">_mode</span><span class=\"mtk1\">)  </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\">  </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ( </span><span class=\"mtk12\">marketAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_mode</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> ==</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">marketAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_mode</span><span class=\"mtk1\">][</span><span class=\"mtk12\">marketAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_mode</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - (</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/13#issuecomment-914173966\">Splidge (Reality Cards) confirmed and patched</a>:</strong></p>\n<blockquote>\n<p>Fixed <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/4b30c9d0c9dec9316ffa2b23a39c791c0ee42efa\">here</a></p>\n</blockquote>\n<h2 id=\"l-14-updatetokenuri-doesnt-call-settokenuri-\" style=\"position:relative;\"><a href=\"#l-14-updatetokenuri-doesnt-call-settokenuri-\" aria-label=\"l 14 updatetokenuri doesnt call settokenuri  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/12\">[L-14] <code>updateTokenURI</code> doesn’t call <code>setTokenURI</code> </a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<p>The function <code>updateTokenURI</code> of <code>RCFactory.sol</code> doesn’t update the uris of <code>RCNftHubL2</code>.\nE.g. it doesn’t call <code>setTokenURI</code> to try and update the already created NFT’s.\nThis way the URIs of already minted tokens are not updated.</p>\n<p>See issue page for referenced code.</p>\n<p>Recommend also calling <code>setTokenURI</code> of <code>RCNftHubL2</code>. Or, restricting <code>updateTokenURI</code> to the phase where no NFT’s are minted yet. Or, at least add comments to <code>updateTokenURI</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/12#issuecomment-903624339\">Splidge (Reality Cards) confirmed</a>:</strong></p>\n<blockquote>\n<p>The reason behind <code>updateTokenURI</code> is because in some early markets we found that the artwork used had copyright or trademark infringements. It was recommended from a legal point of view that we should have a mechanism for removing/amending the artwork. The end goal would be to decentralize the whole project and at that stage this legal issue disappears along with the need to change the tokenURI.</p>\n<blockquote>\n<p>Also call setTokenURI of RCNftHubL2</p>\n</blockquote>\n<p>This could prove difficult as we haven’t settled on a maximum number of NFTs we can award from the leaderboard and so there could be gas limits around updating all the tokenURIs for already minted tokens. There also exists the potential that the user has upgraded the NFT to the mainnet. Given how infrequently (ideally never) we plan to use this feature it seemed reasonable to be able to call <code>updateTokenURI</code> so all new NFTs are minted with the updated metadata and then call <code>setTokenURI</code> (on either layer 1 or layer 2) to update all the already minted tokens.</p>\n<blockquote>\n<p>Or restrict updateTokenURI to the phase where no NFT’s are minted yet.</p>\n</blockquote>\n<p>This would only work if we knew before we minted anything that there was a legal infringement, in which case we wouldn’t use the art to begin with.</p>\n<blockquote>\n<p>Or at least add comments to updateTokenURI</p>\n</blockquote>\n<p>I will add some comments to clarify the reasons for <code>updateTokenURI</code> and why we don’t update already minted tokens.</p>\n<p>I also notice while writing this out that if we intend to relinquish the ability to <code>updateTokenURI</code> then this power should be given to the UBER_OWNER and not the OWNER. I will change this.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/12#issuecomment-914173342\">Splidge (Reality Cards) patched</a>:</strong></p>\n<blockquote>\n<p>Fixed <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/832e640c3e401c4647d3f9524d42f0b4ded4d449\">here</a></p>\n</blockquote>\n<h2 id=\"l-15-rctreasury-accesscontrol-diagram-contains-leaderboard-but-it-has-no-role\" style=\"position:relative;\"><a href=\"#l-15-rctreasury-accesscontrol-diagram-contains-leaderboard-but-it-has-no-role\" aria-label=\"l 15 rctreasury accesscontrol diagram contains leaderboard but it has no role permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/44\">[L-15] <code>RCTreasury</code>: <code>AccessControl</code> diagram contains Leaderboard, but it has no role</a></h2>\n<p><em>Submitted by hickuphh3, also found by leastwood and cmichel</em></p>\n<p>See issue page for diagram and discussion.</p>\n<h2 id=\"l-16-rcleaderboardmarket-storage-variable-is-not-used\" style=\"position:relative;\"><a href=\"#l-16-rcleaderboardmarket-storage-variable-is-not-used\" aria-label=\"l 16 rcleaderboardmarket storage variable is not used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/55\">[L-16] <code>RCLeaderboard.market</code> storage variable is not used</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>RCLeaderboard.market</code> storage variable is never used. Instead, the <code>MARKET</code> role seems to be used to implement authentication.</p>\n<p>Unused code can hint at programming or architectural errors.</p>\n<p>Recommend using it or remove it.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/55#issuecomment-906326040\">Splidge (Reality Cards) confirmed</a>:</strong></p>\n<blockquote>\n<p>Removed it.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/55#issuecomment-914209526\">Splidge (Reality Cards) patched</a>:</strong></p>\n<blockquote>\n<p>Fixed <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/2f5f3a69556581534850d6e7f5764803657bca46\">here</a></p>\n</blockquote>\n<h2 id=\"l-17-markets-can-start-in-the-past\" style=\"position:relative;\"><a href=\"#l-17-markets-can-start-in-the-past\" aria-label=\"l 17 markets can start in the past permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/54\">[L-17] Markets can start in the past</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>RCFactory._checkTimestamps</code> function only checks that the start timestamp (<code>_timestamps[0]</code>) is not in the past if <code>advancedWarning != 0</code>.</p>\n<p>Markets can be created that already started in the past. I’m not sure if this is intended.</p>\n<p>Recommend always performing the <code>require(_timestamps[0] >= block.timestamp, \"Market opening time not set\");</code> check, not only in the <code>advancedWarning != 0</code> case.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/54#issuecomment-906328308\">Splidge (Reality Cards) disputed</a>:</strong></p>\n<blockquote>\n<p>In the case where we want to open a market immediately it would be difficult to do so without allowing timestamps in the past because we can’t say what time the transaction will be mined and so what the <code>block.timestamp</code> would be.\nBy not checking this we can open markets immediately with ease.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/54#issuecomment-911595969\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The check could allow for some expected amount of time slippage due to mining to have transpired and potentially still be useful to avoid errors.  I think it’s a valid point by the warden.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/54#issuecomment-914209029\">Splidge (Reality Cards) acknowledged</a>:</strong></p>\n<blockquote>\n<p>Changing to acknowledged based on the judges assessment.</p>\n</blockquote>\n<h2 id=\"l-18-add-zero-address-validation-in-constructor\" style=\"position:relative;\"><a href=\"#l-18-add-zero-address-validation-in-constructor\" aria-label=\"l 18 add zero address validation in constructor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/61\">[L-18] add zero address validation in constructor</a></h2>\n<p><em>Submitted by JMukesh, also found by cmichel</em></p>\n<p>since the parameter in the constructor are used to initialize the state variable , proper check up should be done , other wise error in these state variable  can lead to redeployment of contract. See issue page for referenced code.</p>\n<p>Recommend adding zero address validation.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/61#issuecomment-906312328\">Splidge (Reality Cards) confirmed</a>:</strong></p>\n<blockquote>\n<p>RCOrderbook and RCTreasury both have setter functions where an incorrectly initialized variable could be set after deployment. It’s unlikely for these to be set incorrectly because of the deployment script we use, however I’ll add a setter to the RCLeaderboard so we can set the address afterwards.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/61#issuecomment-911974255\">Splidge (Reality Cards) patched</a>:</strong></p>\n<blockquote>\n<p>Treasury setter in RCLeaderboard added <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/da990810844966f3841b41b31db696ae2961e701\">here</a></p>\n</blockquote>\n<h2 id=\"l-19-use-of-array-without-checking-its-length\" style=\"position:relative;\"><a href=\"#l-19-use-of-array-without-checking-its-length\" aria-label=\"l 19 use of array without checking its length permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/60\">[L-19] use of array without checking its length</a></h2>\n<p><em>Submitted by JMukesh</em></p>\n<p>Since no limit is mentioned in <code>batchWhitelist()</code> for the input of <code>_users</code> array , it may run out of gas if array length become large. See <a href=\"https://github.com/code-423n4/2021-08-realitycards/blob/39d711fdd762c32378abf50dc56ec51a21592917/contracts/RCTreasury.sol#L249\"><code>RCTreasury.sol</code> L249</a>.</p>\n<p>Recommend adding a limitation for which , this number of address can be whitelisted at a time.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/60#issuecomment-906314633\">Splidge (Reality Cards) acknowledged</a>:</strong></p>\n<blockquote>\n<p>This whitelist is a temporary measure to be used in the Beta and the run-up to launch, after launch it will be disabled. As such we will not be making changes to a feature that will not be used going forward.</p>\n</blockquote>\n<h2 id=\"l-20-no-check-for-the-referencecontractaddress-in-createmarket\" style=\"position:relative;\"><a href=\"#l-20-no-check-for-the-referencecontractaddress-in-createmarket\" aria-label=\"l 20 no check for the referencecontractaddress in createmarket permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/50\">[L-20] No check for the <code>referenceContractAddress</code> in <code>createMarket()</code></a></h2>\n<p><em>Submitted by JMukesh</em></p>\n<p> <code>referenceContractAddress</code> is used in <code>createMarket()</code> to create <code>newAddress</code>  for the market , a necessary check should be there that <code>referenceContractAddress</code> exist or not, because if <code>createMarket()</code> is called before <code>setReferenceContractAddress()</code>, <code>address(0)</code> will be passed as <code>referenceContractAddress</code> , since <code>addMarket()</code> of <code>treasury</code> and <code>nfthub</code> does not have address validation for the market. See <a href=\"https://github.com/code-423n4/2021-08-realitycards/blob/39d711fdd762c32378abf50dc56ec51a21592917/contracts/RCFactory.sol#L714\"><code>RCFactory.sol</code> L714</a>.</p>\n<p>Recommend adding a condition to check the <code>referenceContractAddress</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/50#issuecomment-914206143\">Splidge (Reality Cards) confirmed and patched</a>:</strong></p>\n<blockquote>\n<p>Fixed <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/88bf46cea4e239a44054c6dfad481cad0bf262c3\">here</a></p>\n</blockquote>\n<h2 id=\"l-21-no-time-restriction-in-setmarkettimerestrictions\" style=\"position:relative;\"><a href=\"#l-21-no-time-restriction-in-setmarkettimerestrictions\" aria-label=\"l 21 no time restriction in setmarkettimerestrictions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/49\">[L-21] no time restriction in <code>setMarketTimeRestrictions</code>()</a></h2>\n<p><em>Submitted by JMukesh</em></p>\n<p>As mentioned in the comment, time must be at least this many seconds, but it lack a check that given time is <code>atleast >= someTime</code> , as a result\n<code>minimumDuration</code> and <code>maximumDuration</code> are directly initialized without any check. See <a href=\"https://github.com/code-423n4/2021-08-realitycards/blob/39d711fdd762c32378abf50dc56ec51a21592917/contracts/RCFactory.sol#L431\"><code>RCFactory.sol</code> L431</a>.</p>\n<p>Recommend adding require condition to check those value before setting it.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/49#issuecomment-905292773\">Splidge (Reality Cards) confirmed</a>:</strong></p>\n<blockquote>\n<p>This is just poor commenting from when <code>advancedWarning</code>, <code>minimumDuration</code> and <code>maximumDuration</code> each had their own setter functions. They were combined to avoid the Factory going over the contract size limit. However the comments weren’t combined correctly.\n0 seconds is a valid <code>advancedWarning</code> if you want the market to open immediately.\n0 seconds for <code>maximumDuration</code> may also be used if we <a href=\"https://github.com/code-423n4/2021-08-realitycards/blob/39d711fdd762c32378abf50dc56ec51a21592917/contracts/RCFactory.sol#L785\">don’t want to set a maximum</a>.</p>\n<p>I’ll not be adding in the checks but I will update the comments.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/49#issuecomment-914205286\">Splidge (Reality Cards) acknowledged</a>:</strong></p>\n<blockquote>\n<p>On looking back through this I may have misunderstood what the warden was proposing here. I thought the warden wanted a zero value check, but they could have been asking for the <code>minimumDuration</code> &#x3C; <code>maximumDuration</code> check.\nThis would make more sense as if the maximum was less than the minimum it wouldn’t be possible to create a new market. The same problem would happen if <code>advancedWarning</code> was set to be greater than the <code>maximumDuration</code>.\nUnfortunately the Factory is right on the size limit and adding these checks would require other changes to the contract which pose the risk of introducing more problems. Given how infrequently we expect to change these values, and the fact they can be changed back again should a mistake be made, I’ll be marking this issue as acknowledged.\nInitial fix to add more comments was implemented <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/35ef821e97dccea294b61af37a07bf7af335866d\">here</a></p>\n</blockquote>\n<h2 id=\"l-22-transfercard-should-be-done-after-treasury-is-updated\" style=\"position:relative;\"><a href=\"#l-22-transfercard-should-be-done-after-treasury-is-updated\" aria-label=\"l 22 transfercard should be done after treasury is updated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/35\">[L-22] <code>transferCard</code> should be done after treasury is updated.</a></h2>\n<p><em>Submitted by 0xImpostor</em></p>\n<p>When the current owner of the card is still the new owner of the card, <code>transferCard</code> is called before the treasury is updated. While this does not currently pose a risk, it is not aligned with best practices of <a href=\"https://fravoll.github.io/solidity-patterns/checks_effects_interactions.html\">check-effect-interations</a> and opens your code to a potential re-entrancy attack in the future.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// line 381</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">treasury</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateRentalRate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_oldOwner</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">user</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_oldOwner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">index</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_oldOwner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_card</span><span class=\"mtk1\">]].</span><span class=\"mtk12\">price</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_price</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">transferCard</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_card</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_oldOwner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_price</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// line 449</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">treasury</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateRentalRate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_price</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_currUser</span><span class=\"mtk1\">.</span><span class=\"mtk12\">price</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">transferCard</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_market</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_card</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_currUser</span><span class=\"mtk1\">.</span><span class=\"mtk12\">price</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/35#issuecomment-914190673\">Splidge (Reality Cards) commented</a>:</strong></p>\n<blockquote>\n<p>Fixed <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/2660831497b3596c4438f434aaa49f280a58063a\">here</a></p>\n</blockquote>\n<h2 id=\"l-23-inaccurate-comment\" style=\"position:relative;\"><a href=\"#l-23-inaccurate-comment\" aria-label=\"l 23 inaccurate comment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/16\">[L-23] Inaccurate Comment</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p>This issue has no direct security implications, however, there may be some confusion when understanding what the <code>RCFactory.createMarket()</code> function actually does. See <a href=\"https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCFactory.sol#L625\"><code>RCFactory.sol</code> L625</a>.</p>\n<p>Recommend updating the line (linked above) to include the <code>SAFE_MODE</code> option outline in the <code>enum</code> type in <code>IRCMarket.sol</code>. For example, the line <code>/// @param _mode 0 = normal, 1 = winner takes all</code> could be updated to <code>/// @param _mode 0 = normal, 1 = winner takes all, 2 = SAFE_MODE</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/16#issuecomment-911628107\">0xean (judge) confirmed</a>:</strong></p>\n<blockquote>\n<p>Based on C4’s docs - Comment issues are 1, bumping to 1.</p>\n<p>“1 — Low: Low: Assets are not at risk. State handling, function incorrect as to spec, issues with comments.”</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/16#issuecomment-914174809\">Splidge (Reality Cards patched</a>:</strong></p>\n<blockquote>\n<p>Fixed <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/0ef0e52b2e1ec82a1c9d02ea6e0990e41afdcc37\">here</a></p>\n</blockquote>\n<h2 id=\"l-24-rcleaderboard-erroneous-comment\" style=\"position:relative;\"><a href=\"#l-24-rcleaderboard-erroneous-comment\" aria-label=\"l 24 rcleaderboard erroneous comment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/43\">[L-24] <code>RCLeaderboard</code>: Erroneous comment</a></h2>\n<p><em>Submitted by hickuphh3</em></p>\n<p>The comments above the event declarations were probably copied over from <code>RCOrderbook</code>. They should be modified to refer to the leaderboard.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @dev emitted every time a user is added to the leaderboard</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogAddToLeaderboard</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_market</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_card</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @dev emitted every time a user is removed from the leaderboard</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogRemoveFromLeaderboard</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_market</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_card</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/43#issuecomment-905457111\">Splidge (Reality Cards) confirmed</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>probably copied over from RCOrderbook</p>\n</blockquote>\n<p>Exactly. I’ll correct this.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/43#issuecomment-911630908\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">1 — Low: Low: Assets are not at risk. State handling, function incorrect as to spec, issues with comments.</span></span></code></pre>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/43#issuecomment-914192628\">Splidge (Reality Cards) patched</a>:</strong></p>\n<blockquote>\n<p>Fixed <a href=\"https://github.com/RealityCards/RealityCards-Contracts/commit/f5fa3b32fb5bdd6aafba0a6d5279eae43f27df24\">here</a></p>\n</blockquote>\n<h2 id=\"l-25-use-_safetransfer-when-transferring-nfts\" style=\"position:relative;\"><a href=\"#l-25-use-_safetransfer-when-transferring-nfts\" aria-label=\"l 25 use _safetransfer when transferring nfts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/65\">[L-25] Use <code>_safeTransfer</code> when transferring NFTs</a></h2>\n<p><em>Submitted by shw</em></p>\n<p>The <code>transferNft</code> function of <code>RCNftHubL2</code> is called when transferring the card to the final winner. However, this function does not check whether the recipient is aware of the ERC721 protocol and calls <code>_transfer</code> directly. If the recipient is a contract not aware of incoming NFTs, then the transferred NFT would be locked in the recipient forever. See <a href=\"https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/nfthubs/RCNftHubL2.sol#L135\"><code>RCNftHubL2.sol</code> L135</a>.</p>\n<p>Recommend using the <a href=\"(https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC721/ERC721.sol#L205-L213)\"><code>_safeTransfer</code></a> function instead, which checks if the recipient contract implements the <code>onERC721Received</code> interface to avoid loss of NFTs.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/65#issuecomment-906259629\">Splidge (Reality Cards) disputed</a>:</strong></p>\n<blockquote>\n<p>This transfer function is just for the market to move the NFTs while the market is operational, during this phase it doesn’t matter if the NFT is given to a non-compliant contract as the market is in control of moving the NFT and will simply give it to the next user that makes a rental.\nUsing <code>_safeTransfer</code> would be dangerous as it would give an attacker the opportunity to take part in a market via a contract that is not ERC721 compliant, when the market attempts to pass ownership to this contract the transfer would revert and the market would become locked.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/65#issuecomment-911750645\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p><code>claimCard</code> in RCMarket.sol also calls the transfer method to claim the card, which could result in the situation outlined by the warden.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/65#issuecomment-911817656\">Splidge (Reality Cards) commented</a>:</strong></p>\n<blockquote>\n<p>Ahh sorry, I missed the key part in the wardens impact “when transferring the card to the final winner”.</p>\n<p>I still think this isn’t an issue as if the destination is a non-compliant contract, when using <code>_safeTransfer</code> the <code>claimCard</code> call would revert. The NFT is permanently stuck on either the market or on the non-compliant contract.\nAt least the person who wrote the contract, funded it, used it to place bids, win the NFT and make the <code>claimCard</code> call would still get it transferred to their contract to use as a trophy cabinet of sorts. Maybe that person didn’t implement <code>onERC721Received</code>?\nThis check would be too little too late.</p>\n<p>Maybe we could check when the first rental is made that the sender is eligible? Although that would deviate slightly from the standard as <code>onERC721Received</code> is supposed to be called after the transfer.</p>\n</blockquote>\n<h1 id=\"non-critical-findings-11\" style=\"position:relative;\"><a href=\"#non-critical-findings-11\" aria-label=\"non critical findings 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Findings (11)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/62\">[N-01] Unable to Recover Improperly Transferred Tokens</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/71\">[N-02] User can deposit more than <code>maxContractBalance</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/25\">[N-03] Divide Before Multiply</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/48\">[N-04] Remove hardhat console import</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/47\">[N-05] <code>RCTreasury</code>: Spelling Errors</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/45\">[N-06] <code>RCTreasury</code>: new <code>hasRole()</code> function with string role</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/42\">[N-07] <code>RCFactory</code>: Unnecessary casting in <code>updateTokenURI()</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/38\">[N-08] Access Control Constants</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/9\">[N-09] <code>tokenExists</code> ==> <code>cardExists</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/11\">[N-10] remove <code>addMarket</code> from <code>RCNftHubL2</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/10\">[N-11] remove unused modifiers</a></li>\n</ul>\n<h1 id=\"gas-optimizations-9\" style=\"position:relative;\"><a href=\"#gas-optimizations-9\" aria-label=\"gas optimizations 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations (9)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/17\">[G-01] Overflow in <code>Mode</code> Type</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/68\">[G-02] gas saving in <code>_processRentCollection</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/6\">[G-03] <code>RCMarket.sol</code> - Gas optimization in <code>_payoutWinnings</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/5\">[G-04] <code>RCMarket.sol</code> - Gas optimization in <code>claimCard</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/19\">[G-05] optimize `_beforeTokenTransfer</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/20\">[G-06] make code of <code>rentAllCards</code> easier to read and maintain</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/32\">[G-07] Tight Variable Packing</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/7\">[G-08] Allowance checks are not required</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/72\">[G-09] Gas optimization in <code>RCMarket.sol</code> and other files</a></li>\n</ul>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-2\">High Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#h-01-findnewowner-edgecase\">[H-01] <code>findNewOwner</code> edgecase</a></li>\n<li><a href=\"#h-02-uberowner-has-too-much-power\">[H-02] <code>UberOwner</code> has too much power</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-3\">Medium Risk Findings (3)</a></p>\n<ul>\n<li><a href=\"#m-01-uninitialized-variable-marketwhitelist-in-rctreasurysol\">[M-01] Uninitialized Variable <code>marketWhitelist</code> in <code>RCTreasury.sol</code></a></li>\n<li><a href=\"#m-02-parameter-updates-not-propagated\">[M-02] Parameter updates not propagated</a></li>\n<li><a href=\"#m-03-deposits-dont-work-with-fee-on-transfer-tokens\">[M-03] Deposits don’t work with fee-on transfer tokens</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-findings-25\">Low Risk Findings (25)</a></p>\n<ul>\n<li><a href=\"#l-01-cant-retrieve-all-data-with-getmarketinfo-\">[L-01] Can’t retrieve all data with <code>getMarketInfo</code> </a></li>\n<li><a href=\"#l-02-return-value-of-erc20approve-is-unchecked\">[L-02] Return value of <code>erc20.approve</code> is unchecked</a></li>\n<li><a href=\"#l-03-direct-usage-of-ecrecover-allows-signature-malleability\">[L-03] Direct usage of <code>ecrecover</code> allows signature malleability</a></li>\n<li><a href=\"#l-04-return-value-is-not-validated\">[L-04] Return Value is Not Validated</a></li>\n<li><a href=\"#l-05-external-call-made-before-state-change\">[L-05] External Call Made Before State Change</a></li>\n<li><a href=\"#l-06-test-coverage-improvements\">[L-06] Test Coverage Improvements</a></li>\n<li><a href=\"#l-07-rcfactory-solve-stack-too-deep-for-getmarketinfo\">[L-07] <code>RCFactory</code>: Solve stack too deep for <code>getMarketInfo()</code></a></li>\n<li><a href=\"#l-08-rcfactory-do-multiplication-instead-of-division-for-length-checks\">[L-08] <code>RCFactory</code>: Do multiplication instead of division for length checks</a></li>\n<li><a href=\"#l-09-safer-implementation-of-tokenexists\">[L-09] safer implementation of <code>tokenExists</code></a></li>\n<li><a href=\"#l-10-uint32-conversion-doesnt-work-as-expected\">[L-10] <code>uint32</code> conversion doesn’t work as expected.</a></li>\n<li><a href=\"#l-11-msgsender-or-_msgsender\">[L-11] <code>msgSender()</code> or <code>_msgSender()</code></a></li>\n<li><a href=\"#l-12-rentallcards-dont-have-to-pay-for-card-you-already-own\">[L-12] <code>rentAllCards</code>: don’t have to pay for card you already own</a></li>\n<li><a href=\"#l-13-getmostrecentmarket-can-revert\">[L-13] <code>getMostRecentMarket</code> can revert</a></li>\n<li><a href=\"#l-14-updatetokenuri-doesnt-call-settokenuri-\">[L-14] <code>updateTokenURI</code> doesn’t call <code>setTokenURI</code> </a></li>\n<li><a href=\"#l-15-rctreasury-accesscontrol-diagram-contains-leaderboard-but-it-has-no-role\">[L-15] <code>RCTreasury</code>: <code>AccessControl</code> diagram contains Leaderboard, but it has no role</a></li>\n<li><a href=\"#l-16-rcleaderboardmarket-storage-variable-is-not-used\">[L-16] <code>RCLeaderboard.market</code> storage variable is not used</a></li>\n<li><a href=\"#l-17-markets-can-start-in-the-past\">[L-17] Markets can start in the past</a></li>\n<li><a href=\"#l-18-add-zero-address-validation-in-constructor\">[L-18] add zero address validation in constructor</a></li>\n<li><a href=\"#l-19-use-of-array-without-checking-its-length\">[L-19] use of array without checking its length</a></li>\n<li><a href=\"#l-20-no-check-for-the-referencecontractaddress-in-createmarket\">[L-20] No check for the <code>referenceContractAddress</code> in <code>createMarket()</code></a></li>\n<li><a href=\"#l-21-no-time-restriction-in-setmarkettimerestrictions\">[L-21] no time restriction in <code>setMarketTimeRestrictions</code>()</a></li>\n<li><a href=\"#l-22-transfercard-should-be-done-after-treasury-is-updated\">[L-22] <code>transferCard</code> should be done after treasury is updated.</a></li>\n<li><a href=\"#l-23-inaccurate-comment\">[L-23] Inaccurate Comment</a></li>\n<li><a href=\"#l-24-rcleaderboard-erroneous-comment\">[L-24] <code>RCLeaderboard</code>: Erroneous comment</a></li>\n<li><a href=\"#l-25-use-_safetransfer-when-transferring-nfts\">[L-25] Use <code>_safeTransfer</code> when transferring NFTs</a></li>\n</ul>\n</li>\n<li><a href=\"#non-critical-findings-11\">Non-Critical Findings (11)</a></li>\n<li><a href=\"#gas-optimizations-9\">Gas Optimizations (9)</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode 432n4 (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the code contest outlined in this document, C4 conducted an analysis of the Reality Cards smart contract system written in Solidity. The code contest took place between August 18—August 25 2021.\n\n## Wardens\n\n11 Wardens contributed reports to the Reality Cards (round 2) code contest:\n\n1. [gpersoon](https://twitter.com/gpersoon)\n2. [tensors](https://twitter.com/Tensors8)\n3. [cmichel](https://twitter.com/cmichelio)\n4. [leastwood](https://twitter.com/liam_eastwood13)\n5. [Jmukesh](https://twitter.com/MukeshJ_eth)\n6. [hickuphh3](https://twitter.com/HickupH)\n7. [shw](https://github.com/x9453)\n8. [0xImpostor](https://twitter.com/0xImpostor)\n9. [0xsanson](https://github.com/0xsanson)\n10. [qedk](https://twitter.com/qedk)\n11. [PierrickGT](https://twitter.com/PierrickGT)\n\nThis contest was judged by [0xean](https://github.com/0xean (judge)).\n\nFinal report assembled by [moneylegobatman](https://twitter.com/money_lego) and [ninek](https://twitter.com/_ninek_).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 30 unique vulnerabilities. All of the issues presented here are linked back to their original finding\n\nOf these vulnerabilities, 2 received a risk rating in the category of HIGH severity, 3 received a risk rating in the category of MEDIUM severity, and 25 received a risk rating in the category of LOW severity.\n\nC4 analysis also identified 11 non-critical recommendations and 9 gas optimizations.\n\n# Scope\n\nThe code under review can be found within the [C4 Reality Cards (Round 2) code contest repository](https://github.com/code-423n4/2021-08-realitycards) is comprised of 26 smart contracts written in the Solidity programming language and includes 7,770 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code423n4.com).\n\n# High Risk Findings (2)\n\n## [[H-01] `findNewOwner` edgecase](https://github.com/code-423n4/2021-08-realitycards-findings/issues/27)\n_Submitted by gpersoon_\n\nIn the function `findNewOwner` of `RCOrderbook`, as loop is done which included the check  `_loopCounter < maxDeletions`\nAfterwards, a check is done for  \"(_loopCounter != maxDeletions)\" to determine if the processing is finished.\nIf `_loopCounter == maxDeletions` then the conclusion is that it isn't finished yet.\n\nHowever, there is the edgecase that the processing might just be finished at the same time as `_loopCounter == maxDeletions`.\n\nYou can see this the best if you assume `maxDeletions==1`, in that case it will never draw the conclusion it is finished.\nOf course having `maxDeletions==1` is very unlikely in practice.\n\n```solidity\n// https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCOrderbook.sol#L549\n function findNewOwner(uint256 _card, uint256 _timeOwnershipChanged)  external  override  onlyMarkets  {\n...\n    // delete current owner\n    do {\n        _newPrice = _removeBidFromOrderbookIgnoreOwner( _head.next, _market, _card );\n        _loopCounter++;             // delete next bid if foreclosed\n    } while (    treasury.foreclosureTimeUser( _head.next, _newPrice,  _timeOwnershipChanged ) <  minimumTimeToOwnTo &&\n            _loopCounter < maxDeletions );\n\n    if (_loopCounter != maxDeletions) {   // the old owner is dead, long live the new owner\n        _newOwner = ....\n        ...\n    } else {\n        // we hit the limit, save the old owner, we'll try again next time\n        ...\n    }\n}\n```\n\nRecommend using a different way to determine that the processing is done. This could save some gas.\nNote: the additional check also costs gas, so you have to verify the end result.\n\nPerhaps in `setDeletionLimit`, doublecheck that `_deletionLimit` > 1.\n\n**[Splidge (Reality Cards) confirmed and disagreed with severity](https://github.com/code-423n4/2021-08-realitycards-findings/issues/27#issuecomment-905499584):**\n > oh wow, this is actually a really big problem. It's easier to see it if `maxDeletions` is 1 but it exists with any size of `maxDeletions`.\n> Whenever we find a valid owner on the final iteration of the loop the if statement will simply check if it was the final loop. That valid owner is then assumed to be invalid and saved for the next transaction to try and find a new owner. When that next transaction happens the valid owner is immediately deleted and not given any ownership of the card at all.\n> I think this just falls short of 3 (High risk) because I don't think it'd be possible for an attacker to engineer the situation to have a particular user deleted without ownership. But I believe this would count as 2 (Med risk) because the protocol [\"availability could be impacted\"](https://docs.code4rena.com/roles/wardens/judging-criteria#estimating-risk-tl-dr) for the user that is deleted.\n\n**[Splidge (Reality Cards) commented](https://github.com/code-423n4/2021-08-realitycards-findings/issues/27#issuecomment-905523120):**\n > I have since thought of an attack that could have used this and might raise it to 3 (High risk).\n>\n> Due to the difficultly of monitoring which cards you own all the time a valid strategy which some users employ is to bid high enough to scare off other users (usually bidding significantly beyond the 10% minimum increase). Suppose Alice employs this strategy by bidding \\$100 on a card that was previously only \\$10.\n> Mal (our attacker) wishes to rent the card but wants to pay less than \\$100. Mal could use Sybil accounts to place `maxDeletions - 1` bids all for the minimum rental duration (only funding the accounts for the minimum duration). Mal would then need to wait for the minimum duration of all these bids to expire, `(maxDeletions - 1 ) * minimumRentalDuration`\n> Once this has completed Mal can place a bid at \\$11, this will trigger a rent collection which will attempt to `findNewOwner`, Alice being the user that was found on the last iteration of the loop would be considered as invalid. There will not be a change of ownership or any events emitted about this until the next rent collection is triggered.\n> This means that the UI would still consider Alice to be the owner of card (Mals' Sybil bids having had `LogRemoveFromOrderbook` and `LogUserForeclosed` events emitted) and other users might not consider trying to outbid this, whereas actually Mal is accruing time at a significantly cheaper rate.\n>\n> Thinking about it, this doesn't really even need Alice at all, Mal could have placed all the higher bids to simultaneously scare off other users while renting at a lower price.\n>\n> I think the fix is relatively simple, by checking if we found a valid user OR hit the deletion limit we can make it so that we don't skip any bids. This would then leave Alice (or Mal in the other version) correctly having to pay for the time at the higher price.\n\n**[0xean (judge) commented](https://github.com/code-423n4/2021-08-realitycards-findings/issues/27#issuecomment-911673904):**\n > upgrading based on sponsors analysis\n\n**[Splidge (Reality Cards) patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/27#issuecomment-914180653):**\n > Fixed [here](https://github.com/RealityCards/RealityCards-Contracts/commit/9f81f683ea0d2ab41ab91ba9188baf594012c295)\n\n## [[H-02] `UberOwner` has too much power](https://github.com/code-423n4/2021-08-realitycards-findings/issues/74)\n_Submitted by tensors_\n\nThe Uber Owner has too much power within the system. This makes the protocol closer to a centralized prediction market whose rules are determined by the Uber Owner. See issue page for referenced code\n\nThe above functions can be used by the Uber Owner to completely change the functionality of the system.\nThis goes well beyond simple setting new constants and fees, the Uber Owner can basically reprogram how the entire protocol works. Not to mention if the address falls into the wrong hands.\n\nRecommend limiting the permission of the Uber Owner to something more manageable and trustable. If upgrades to underlying contracts are required they can be done through a proxy instead, in the standard way.\n\n**[mcplums (Reality Cards) disputed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/74#issuecomment-906225388):**\n > This is a subjective opinion- there is always going to be a compromise between decentralisation and the ability to respond to potential problems. The latter is especially important with a protocol that is so new.\n>\n> There is no correct answer here, but the current abilities of `uberOwner` were decided after a lot of thought and are in line with other DeFi protocols.\n\n**[Splidge (Reality Cards) commented](https://github.com/code-423n4/2021-08-realitycards-findings/issues/74#issuecomment-906236023):**\n > I'd just like to add that we did recognize the power of the UberOwner which is why it is separated from the Owner specifically so that we can add additional security to it (in the form of a multisig) and so that we can relinquish this control at the appropriate time.\n> This was covered in the [readme](https://github.com/code-423n4/2021-08-realitycards#mortar_board-governance-mortar_board).\n> And also [commented ](https://github.com/code-423n4/2021-08-realitycards/blob/39d711fdd762c32378abf50dc56ec51a21592917/contracts/RCTreasury.sol#L288-L291)in the code.\n\n**[0xean (judge) commented](https://github.com/code-423n4/2021-08-realitycards-findings/issues/74#issuecomment-911717998):**\n > I think the warden(s) have a valid point here. This is an incredible amount of power for a single address to yield over the protocol, even if backed by a multi-sig.\n>\n> Is it no an option to 1) pause all activity, and unlock all funds allowing users to withdraw their own funds or 2) pause all activity besides withdraws and implement a time delay between that and the \"rug pull\" function being called.\n>\n> The readme also states\n>\n> ```Alternatively we may wish for this to be a multisig but the normal owner to not be, for convenience.```\n>\n> Without a multisig, I believe this absolutely qualifies as a high severity issue as a compromise of a single end user address compromises the entire system, with a multisig it potentially lowers the severity down to a medium, but its still a risk that is worth highlighting in the system and for the sponsor to scrutinize if there are indeed other mitigation paths that could be taken.\n\n# Medium Risk Findings (3)\n\n## [[M-01] Uninitialized Variable `marketWhitelist` in `RCTreasury.sol`](https://github.com/code-423n4/2021-08-realitycards-findings/issues/18)\n_Submitted by leastwood, also found by 0xsanson, gpersoon, hickuphh3 and JMukesh_\n\nThe variable, `marketWhitelist`, is never initialized in the contract `RCTreasury.sol`. As a result, the function `marketWhitelistCheck()`  does not perform a proper check on whitelisted users for a restricted market. Additionally, the function will always return `true`, even if a market wishes to restrict its users to a specific role.\n\nThe initial state variable is defined in [`RCTreasury.sol` L75](https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCTreasury.sol#L75).\n\n\nThe state variable `marketWhitelist` is accessed in the function `RCTreasury.marketWhitelistCheck()` at [`RCTreasury.sol` L269-L281](https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCTreasury.sol#L269-L281).\n\nThe function `RCTreasury.marketWhitelistCheck()` is called in `RCMarket.newRental()` at [`RCMarket.sol` L758-L761](https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCMarket.sol#L758-L761). The comment indicates that there should be some ability to restrict certain markets to specific whitelists, however, there are no methods in `RCTreasury` that allow a market creator to enable this functionality.\n\nRecommend ensuring this behavior is intended. If this is not the case, consider adding a function that enables a market creator to restrict their market to a specific role by whitelisting users.\n\n**[Splidge (Reality Cards) confirmed and disagreed with severity](https://github.com/code-423n4/2021-08-realitycards-findings/issues/18#issuecomment-905413207):**\n > I think the severity could be double-checked on this one.\n> It's a close one but I'd be tempted to put it under 1 (low risk) as a \"Function incorrect to spec\".\n> Regardless, this will be fixed.\n>\n> Edit: I notice the duplicates were both marked as 1 (low risk).\n\n**[0xean (judge) commented](https://github.com/code-423n4/2021-08-realitycards-findings/issues/18#issuecomment-910962066):**\n > based on \" but the function of the protocol or its availability could be impacted\" in the code4 docs, I am going to agree with warden and leave this as a 2.  The function of the protocol is certainly impacted in a case where the whitelist if not working correctly.\n\n\n**[Splidge (Reality Cards) patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/18#issuecomment-914175471):**\n > Fixed [here](https://github.com/RealityCards/RealityCards-Contracts/commit/1515f87e97be1ed09316340e19caea5c12242c17)\n\n## [[M-02] Parameter updates not propagated](https://github.com/code-423n4/2021-08-realitycards-findings/issues/30)\n_Submitted by gpersoon, also found by cmichel_\n\nThere are several functions to update parameters. However these parameters are only updated on the top level and not propagated to the other contracts. This could lead to various unpredictable results.\nExamples are:\n- `setNftHubAddress` of `RCFactory`\n- `setOrderbookAddress` of `RCFactory`\n- `setLeaderboardAddress` of `RCFactory`\n- `setMinRental` of `RCTreasury`\n\n```solidity\n// https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCFactory.sol#L586\nfunction setNftHubAddress(IRCNftHubL2 _newAddress) external override onlyUberOwner {\n    require(address(_newAddress) != address(0), \"Must set Address\");\n    nfthub = _newAddress;\n}\n\nfunction setOrderbookAddress(IRCOrderbook _newOrderbook) external override {\n    require( treasury.checkPermission(TREASURY, msgSender()), \"Not approved\" );\n    orderbook = _newOrderbook;\n}\n\nfunction setLeaderboardAddress(IRCLeaderboard _newLeaderboard) external override {\n    require( treasury.checkPermission(TREASURY, msgSender()), \"Not approved\");\n    leaderboard = _newLeaderboard;\n}\n\n//https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCTreasury.sol#L188\nfunction setMinRental(uint256 _newDivisor) public override onlyRole(OWNER) {\n    minRentalDayDivisor = _newDivisor;\n}\n```\n\nRecommend implementing a way to notify the underlying contracts of the updates.\n\n**[Splidge (Reality Cards) acknowledged](https://github.com/code-423n4/2021-08-realitycards-findings/issues/30#issuecomment-904726786):**\n > We have come to realise that it is very unlikely we will be able to change certain contracts once they are in-use, the exception being the market where a new reference could be deployed.\n> In practice we do use `setNftHubAddress` shortly after deploying new contracts, this is so that we can continue to use an existing NFT hub that has already been put through Matic Mintable Asset mapping, but changing this while a market is active would cause problems.\n> While we accept that changing these parameters on active contracts may be troublesome we will not be making changes at this time, partly because it's useful to be able to change these before the contracts are in use but also due to the potential risk of introducing new problems at this stage in the project.\n\n## [[M-03] Deposits don't work with fee-on transfer tokens](https://github.com/code-423n4/2021-08-realitycards-findings/issues/58)\n_Submitted by cmichel_\n\nThere are ERC20 tokens that may make certain customizations to their ERC20 contracts.\nOne type of these tokens is deflationary tokens that charge a certain fee for every `transfer()` or `transferFrom()`.\nOthers are rebasing tokens that increase in value over time like Aave's aTokens (`balanceOf` changes over time).\n\nThe `RCTreasury.deposit()` function will credit more deposits than the contract actually received:\n\n```solidity\nerc20.safeTransferFrom(msgSender(), address(this), _amount);\nuser[_user].deposit += SafeCast.toUint128(_amount);\n```\n\nRecommend ensuring that the `erc20` token does not implement any customizations.\nAlternatively, a mitigation is to measure the asset change right before and after the asset-transferring routines\n\n**[Splidge (Reality Cards) acknowledged](https://github.com/code-423n4/2021-08-realitycards-findings/issues/58#issuecomment-906322667):**\n > The issue that [keeps on giving..](https://github.com/code-423n4/2021-06-realitycards-findings/issues/152)\n>\n> ![takemymoney](https://user-images.githubusercontent.com/73956628/130954991-f6f29f54-926f-4e68-b4cb-f73ed1dc3c95.jpg)\n>\n\n# Low Risk Findings (25)\n\n## [[L-01] Can't retrieve all data with `getMarketInfo` ](https://github.com/code-423n4/2021-08-realitycards-findings/issues/14)\n_Submitted by gpersoon, also found by hickuphh3 and cmichel_\n\nThe function `getMarketInfo` of `RCFactory` only can give results back in the range 0...`marketInfoResults`\nSupplying `_skipResults` doesn't help, it then just skips the first `_skipResults`  records.\n\nAssume `marketInfoResults` == 10 and `_skipResults` == 20:\nThen no result will be given back because \"`_resultNumber` < `marketInfoResults`\" will never allow `_resultNumber`  to be bigger than 10\n\nNote: this is low risk because `getMarketInfo` is a backup function (although you maybe want the backup to function as expected)\n\n```solidity\n// https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCFactory.sol#L227\nfunction getMarketInfo( IRCMarket.Mode _mode, uint256 _state, uint256 _skipResults  )  external view\n    returns ( address[] memory, string[] memory, string[] memory, uint256[] memory ) {\n    ..\n    uint256 _resultNumber = 0;\n    ..\n    while (_resultNumber < marketInfoResults && _marketIndex > 1) {\n        ...\n            if (_resultNumber < _skipResults) {\n                _resultNumber++;\n            } else {\n                _marketAddresses[_resultNumber] = _market;   // will never reach this part if _skipResults >= marketInfoResults\n                ....\n                _resultNumber++;\n            }\n        }\n    }\n    return (_marketAddresses, _ipfsHashes, _slugs, _potSizes);\n```\n\nRecommend updating the code to something like the following:\n```solidity\nuint idx;\nwhile (idx < marketInfoResults && _marketIndex > 1) {\n    _marketIndex--;\n    address _market = marketAddresses[_mode][_marketIndex];\n    if (IRCMarket(_market).state() == IRCMarket.States(_state)) {\n        if (_resultNumber < _skipResults) {\n            _resultNumber++;\n        } else {\n            _marketAddresses[idx] = _market;\n            _ipfsHashes[idx] = ipfsHash[_market];\n            _slugs[idx] = addressToSlug[_market];\n            _potSizes[idx] = IRCMarket(_market).totalRentCollected();\n            idx++;\n        }\n    }\n}\n```\n\n**[Splidge (Reality Cards) confirmed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/14#issuecomment-904562553):**\n > Yep, this was a last minute untested addition.\n> In implementing your recommended fix I hit \"Stack too deep\" problems, so have split the function in two with one being internal. Firstly `getMarketInfo` will get the market addresses required and then `_getMarketInfo` will get the additional info required. This change has allowed me to remove the separate `marketResults` variable and pass the required number of results directly to `getMarketInfo`.\n\n**[Splidge (Reality Cards) patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/14#issuecomment-914174309):**\n > Fixed [here](https://github.com/RealityCards/RealityCards-Contracts/commit/65e7ed4266ee6b329e134e3b392c5210b1e767b6)\n\n## [[L-02] Return value of `erc20.approve` is unchecked](https://github.com/code-423n4/2021-08-realitycards-findings/issues/64)\n_Submitted by shw_\n\nThe `SafeERC20` library is used in the `RCTreasury` contract to handle the transfer of tokens that are not compliant with the ERC20 specification. However, in [line 347](https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCTreasury.sol#L347), the `approve` function is used instead of the `safeApprove` function. Tokens not compliant with the ERC20 specification could return `false` from the `approve` function call to indicate the approval fails, while the calling contract would not notice the failure if the return value is not checked.\n\nRecommend using the `safeApprove` function instead, which reverts the transaction with a proper error message when the return value of `approve` is `false`. A better approach is to use the `safeIncreaseAllowance` function, which mitigates the multiple withdrawal attack on ERC20 tokens.\n\n**[Splidge (Reality Cards) disputed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/64#issuecomment-906277076):**\n > I do not think using `safeApprove` would help here.\n> Given the premise that the ERC20 in use is non-compliant and the approval fails, does it matter if the contracts are made aware of this or not? In either case transfers to the bridge contract would not be possible. The solution therefore isn't a different approval but using a different ERC20 which is compliant. Using a different ERC20 isn't necessary as the one we have chosen, USDC, is compliant.\n>\n> `safeIncreaseAllowance` wouldn't make any difference either, we are approving the transfer of more tokens than exist, it'd be pretty impressive to see a multiple withdrawal attack manage to withdraw enough tokens to warrant using the additional approval. A rough calculation shows that if you moved the entire USDC supply on Polygon in a single transaction (assuming the lower end gas 50k) it'd still take `2.89*10^23` blocks filled with transfers before you get to the limit of a `type(uin256).max` approval, even if we sped Polygon up to 10 blocks/second that'd still take 67,000 x the age of the universe to process 🤯, but certainly after that we wouldn't want anybody using the extra approval.\n\n**[0xean (judge) commented](https://github.com/code-423n4/2021-08-realitycards-findings/issues/64#issuecomment-911037276):**\n > Agree with warden that it would be better to use safeApprove and revert the setBridge call with a reasonable error message than fail silently.  The safeIncreaseAllowance doesn't _need_ to be implemented based on the use case. Using safeERC20 calls in a contract that are imports the library seems like a no brainer even if the expected use case doesn't require it.  These contracts will potentially persist much longer past everyone remembering all the nuances of which ERC20 tokens work and which might not.\n\n**[Splidge (Reality Cards) acknowldeged](https://github.com/code-423n4/2021-08-realitycards-findings/issues/64#issuecomment-911588412):**\n > Understood, changing to Acknowledged as for this use case there is no impact and any further changes will delay other audits and our time to launch.\n\n## [[L-03] Direct usage of `ecrecover` allows signature malleability](https://github.com/code-423n4/2021-08-realitycards-findings/issues/63)\n_Submitted by shw_\n\nThe `verify` function of `NativeMetaTransaction` calls the Solidity `ecrecover` function directly to verify the given signature. However, the `ecrecover` EVM opcode allows for malleable (non-unique) signatures and thus is susceptible to replay attacks. Although a replay attack on this contract is not possible since each user's nonce is used only once, rejecting malleable signatures is considered a best practice.\n* [NativeMetaTransaction.sol#L97](https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/lib/NativeMetaTransaction.sol#L97)\n* [SWC-117: Signature Malleability](https://swcregistry.io/docs/SWC-117)\n* [SWC-121: Missing Protection against Signature Replay Attacks](https://swcregistry.io/docs/SWC-121)\n\nRecommend using the `recover` function from [OpenZeppelin's ECDSA library](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/cryptography/ECDSA.sol) for signature verification.\n\n**[Splidge (Reality Cards) disputed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/63#issuecomment-906293560):**\n > This is a [duplicate ](https://github.com/code-423n4/2021-06-realitycards-findings/issues/66)of an issue found in the last contest.\n>\n> It was not solved last time because we didn't want to risk introducing problems by completely rewriting our own version of the MetaTx contract (the version we are using is from a trusted source and working in many production environments that have been audited), so instead of writing our own version I attempted to use the OpenZeppelin version. We need to use the upgradable versions of the OpenZeppelin contracts because we clone RCMarket.sol, however there was an incompatibility between ERC2771Context.sol which uses an `immutable` variable in the constructor and AccessControl.sol which calls _msgSender() in the constructor. Details on this can be found in [this thread.](https://forum.openzeppelin.com/t/erc2771context-typeerror-immutable-variables-cannot-be-read-during-contract-creation-time/8513/7).\n>\n> As you can see in that thread the incompatibility has apparently been fixed, however this was done only 5 hours before the start of this contest (and after we had submitted the code for the contest), so it wasn't practical to implement this solution for this contest. Regardless as you say this attack is \"not possible since each user's nonce is used only once\".\n>\n> I'll mark this as 'disputed' for now, if the judges decide that we should have re-written our own version (or discovered time-travel and implemented the OpenZeppelin version that's now availiable) then I'd be happy to change it to 'acknowledged' as we will not be making changes to such a sensitive area at this stage in the project.\n\n**[0xean (judge) commented](https://github.com/code-423n4/2021-08-realitycards-findings/issues/63#issuecomment-911050685):**\n > Regardless of the solution and the mitigation steps the team is willing or not willing to take, I think highlighting the malleability issue is a valid 1 (Low Risk) issue that may not be worth fixing based on other risks as mentioned by @Splidge (Reality Cards)\n\n## [[L-04] Return Value is Not Validated](https://github.com/code-423n4/2021-08-realitycards-findings/issues/24)\n_Submitted by leastwood_\n\nThe `circuitBreaker()` function in `RCMarket.sol` is utilised in the event an oracle never provides a response to a RealityCards question. The function makes an external call to the `RCOrderbook.sol` contract through the `closeMarket()` function. If for some reason the orderbook was unable to be closed, this would never be checked in the `circuitBreaker()` function. See [`RCMarket.sol` L1215-L1223](https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCMarket.sol#L1215-L1223).\n\nRecommend ensuring this is intended behavior, or otherwise validate the response of `orderbook.closeMarket()`. Another option would be to emit the result of the external call in the `LogStateChange` event, alongside the state change.\n\n**[Splidge (Reality Cards) confirmed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/24#issuecomment-906415282):**\n > We have decided that given the extra complexity added to the contracts since the `circuitBreaker` was first implemented it will no longer be able to perform all the required functions and so it will be removed.\n> If this call to the orderbook fails (or is removed) then users would not have their rentalRates reduced and so their funds would slowly be drained until the foreclose.\n> We also have `setAmicableResolution` which can be used in the event of an oracle failure.\n\n**[Splidge (Reality Cards) patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/24#issuecomment-914179983):**\n > `circuitBreaker` removed [here](https://github.com/RealityCards/RealityCards-Contracts/commit/ef67ce7410e08d97e909f899d73bbd337303ccc6)\n\n## [[L-05] External Call Made Before State Change](https://github.com/code-423n4/2021-08-realitycards-findings/issues/23)\n_Submitted by leastwood_\n\nThere are a number of functions in `RCTreasury.sol` which make external calls to another contract before updating the underlying market balances. More specifically, these affected functions are `deposit()`, `sponsor()`, and `topupMarketBalance()`. As a result, these functions would be prone to reentrancy exploits. However, as `safeTransferFrom()` operates on a trusted ERC20 token (RealityCard's token), this issue is of low severity. See issue page for reference code.\n\nRecommend modifying the aforementioned functions such that all state changes are made before a call to the ERC20 token using the `safeTransferFrom()` function.\n\n**[Splidge (Reality Cards) confirmed and patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/23#issuecomment-914179322):**\n > Fixed [here](https://github.com/RealityCards/RealityCards-Contracts/commit/073164c1967ccde38f3d6be73608f99c0011c793)\n\n## [[L-06] Test Coverage Improvements](https://github.com/code-423n4/2021-08-realitycards-findings/issues/15)\n_Submitted by leastwood_\n\nAdequate test coverage and regular reporting is an essential process in ensuring the codebase works as intended. Insufficient code coverage may lead to unexpected issues and regressions arising due to changes in the underlying smart contract implementation.\n\n![](https://i.imgur.com/Seur7Fg.png)\n\nImage above showcases total test coverage of the target contracts.\n\nRecommend ensuring the coverage report produced via `npx hardhat coverage` covers all functions within Reality Card's smart contract suite.\n\n**[Splidge (Reality Cards) acknowledged](https://github.com/code-423n4/2021-08-realitycards-findings/issues/15#issuecomment-904563411):**\n > We acknowledge further testing is important and will continue to improve the test coverage going forward.\n\n## [[L-07] `RCFactory`: Solve stack too deep for `getMarketInfo()`](https://github.com/code-423n4/2021-08-realitycards-findings/issues/41)\n_Submitted by hickuphh3_\n\nThe `marketInfoResults` is a parameter used by `getMarketInfo()` to determine the length of results to return. As the `setMarketInfoResults()` comments state, \"(it) would be better to pass this as a parameter in `getMarketInfo`.. however we are limited because of stack too deep errors\".\n\nThis limitation can be overcome by defining the return array variables as the function output, as suggested below.\n\nThe need for `marketInfoResults` and its setter function is then made redundant, whilst making querying results of possibly varying lengths more convenient.\n\nRecommend the following:\n\n```jsx\nfunction getMarketInfo(\n  IRCMarket.Mode _mode,\n  uint256 _state,\n  uint256 _skipResults,\n  uint256 _numResults // equivalent of marketInfoResults\n)\n  external\n  view\n  returns (\n    address[] memory _marketAddresses,\n    string[] memory _ipfsHashes,\n    string[] memory _slugs,\n    uint256[] memory _potSizes\n\t)\n {\n\t  uint256 _marketIndex = marketAddresses[_mode].length;\n\n\t  _marketAddresses = new address[](_numResults);\n\t  _ipfsHashes = new string[](_numResults);\n\t  _slugs = new string[](_numResults);\n\t  _potSizes = new uint256[](_numResults);\n\t\t...\n}\n```\n\n**[Splidge (Reality Cards) confirmed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/41#issuecomment-905468807):**\n > I wish I saw this before I did the fix to issue #14 , in implementing that fix I split `getMarketInfo()` in half making part of it internal which has managed to get around the \"Stack too deep\" problem and so I was able to get rid of `marketInfoResults` at the same time.\n> Still this is useful to keep in mind for the future. 👍\n\n**[Splidge (Reality Cards) patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/41#issuecomment-914192246):**\n > Fixed alongside issue #14  [here](https://github.com/RealityCards/RealityCards-Contracts/commit/65e7ed4266ee6b329e134e3b392c5210b1e767b6)\n\n## [[L-08] `RCFactory`: Do multiplication instead of division for length checks](https://github.com/code-423n4/2021-08-realitycards-findings/issues/39)\n_Submitted by hickuphh3, also found by leastwood_\n\nSolidity division rounds down, so doing `M / 2 <= N` checks mean that `M` can be at most `2N + 1`.\n\nThis affects the following checks:\n\n```jsx\nrequire(\n\t(_tokenURIs.length / 2) <= cardLimit,\n\t\"Too many tokens to mint\"\n);\n\nrequire(\n  _cardAffiliateAddresses.length == 0 ||\n\t  _cardAffiliateAddresses.length == (_tokenURIs.length / 2),\n  \"Card Affiliate Length Error\"\n)\n```\n\nNote that with the current implementation, if `_tokenURIs` is of odd length, its last element will be  redundant, but market creation will not revert.\n\nThe stricter checks will partially mitigate `_tokenURIs` having odd length because `_cardAffiliateAddresses` is now required to be exactly twice that of `_tokenURIs`.\n\nThese checks should be modified to:\n\n```jsx\nrequire(\n\t_tokenURIs.length <= cardLimit * 2,\n\t\"Too many tokens to mint\"\n);\n\nrequire(\n  _cardAffiliateAddresses.length == 0 ||\n\t  _cardAffiliateAddresses.length * 2 == _tokenURIs.length,\n  \"Card Affiliate Length Error\"\n);\n```\n\nIn addition, consider adding a check for `_tokenURIs` to strictly be of even length.\n\n`require(_tokenURIs.length % 2 == 0, \"TokenURI Length Error\");`\n\n**[Splidge (Reality Cards) confirmed and patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/39#issuecomment-914191597):**\n > Fixed [here](https://github.com/RealityCards/RealityCards-Contracts/commit/3990f28f1f17aaf0b8df7b556d2976d8c6f8e2b5)\n\n## [[L-09] safer implementation of `tokenExists`](https://github.com/code-423n4/2021-08-realitycards-findings/issues/8)\n_Submitted by gpersoon_\n\nThe function `tokenExists` does only limited checks on the existence of cards.\nIt doesn't doublecheck that `tokenIds[_card]` != 0\nThis is relevant because 0 is the default value of empty array elements. Although this isn't a problem in the current code,\nfuture changes might accidentally introduce vulnerabilities.\n\nAlso cards are only valid if they are below `numberOfCards`. This has led to vulnerabilities in previous versions of the contract\n(e.g. previous contest)\n\n```solidity\n// https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCMarket.sol#L1139\nfunction tokenExists(uint256 _card) internal view returns (bool) {\n        return tokenIds[_card] != type(uint256).max;\n}\n```\n\nRecommend changing the function to something like the following:\n```solidity\nfunction tokenExists(uint256 _card) internal view returns (bool) {\n    if (_cardId >= numberOfCards) return false;\n    if (tokenIds[_card] == 0) return false;\n    return tokenIds[_card] != type(uint256).max;\n}\n```\n\n**[Splidge (Reality Cards) confirmed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/8#issuecomment-903581778):**\n > Obviously I didn't learn my lesson from the last contest, I've added in the check that the card Id is less than the `numberOfCards`.\n>\n> However, I'm reluctant to disallow the use of tokenId 0. This would mean that the first NFT we mint wouldn't be usable in a market, so we would need to create a dead market just to get rid of that first NFT. All things going well the first NFT minted could end up being a valuable one, who knows..? 🚀\n> An alternative would be for the factory to start minting from index 1 but this would mean instead of using the `totalSupply()` as the next token to mint, we would need to use `totalSupply() + 1` , I'm unsure how this would affect integration with services such as opensea where they may expect the first NFT to have index 0, I feel like at this late stage it's too much of a change that could introduce other issues later, and so for now I'll not be adding `if (tokenIds[_card] == 0) return false;`\n\n**[Splidge (Reality Cards) patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/8#issuecomment-911826176):**\n > Fix to the check that the `_card` is a valid card number added in [this ](https://github.com/RealityCards/RealityCards-Contracts/pull/124/commits/315d2d12e461c2ddcffb20dbc5e9a97436d6eb2a)commit\n\n## [[L-10] `uint32` conversion doesn't work as expected.](https://github.com/code-423n4/2021-08-realitycards-findings/issues/28)\n_Submitted by gpersoon, also found by 0xsanson_\n\nThe `uint32` conversion in `setWinner` of the `RCMarket` doesn't work as expected.\nThe first statement: \"`uint32(block.timestamp)`\" already first the `block.timestamp` in a `uint32`.\nIf it is larger than `type(uint32).max` it wraps around and starts with 0 again\nThe testcode below shows this.\n\nCheck for \"`<= type(uint32).max`\" in the second statement is useless because `_blockTimestamp` is always  <= `type(uint32).max`\n\n```solidity\n// https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCMarket.sol#L507\n function setWinner(uint256 _winningOutcome) internal {\n...\n    uint256 _blockTimestamp = uint32(block.timestamp);\n    require(_blockTimestamp <= type(uint32).max, \"Overflow\");\n\n\n//Testcode:\npragma solidity 0.8.7;\ncontract Convert {\n   uint256 public a = uint256( type(uint32).max )+1; // a==4294967296\n   uint32  public b = uint32(a); // b==0\n   uint256 public c = uint32(a); // c==0\n}\n```\n\nRecommend doing the `require` first (without a typecast to `uint32`):\n```solidity\n    require( block.timestamp <= type(uint32).max, \"Overflow\");\n    uint256 _blockTimestamp = uint32(block.timestamp);\n```\n\n**[Splidge (Reality Cards) confirmed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/28#issuecomment-905304973):**\n > Good to know about this. My assumption would have been that this overflow should have been guarded against with the inbuilt SafeMath with Solidity ^0.8.\n> I suppose I put it right there in comments that this should have used SafeCast and not SafeMath 🤦‍♂️\n\n**[Splidge (Reality Cards) patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/28#issuecomment-914181238):**\n > Fixed [here](https://github.com/RealityCards/RealityCards-Contracts/commit/0724bc0c5b79682e0aaf461b33fa6b67156fa1bc)\n\n## [[L-11] `msgSender()` or `_msgSender()`](https://github.com/code-423n4/2021-08-realitycards-findings/issues/22)\n_Submitted by gpersoon_\n\nThe code has two implementations of `msgSender`:\n-   `msgSender()` => uses meta transaction signer\n-  `_msgSender()` => maps to `msg.sender`\n\n`_msgSender()` is used in a few locations\n- when using `_setupRole`, this seems legitimate\n- in function `withdraw` (whereas the similar function `withdrawWithMetadata` uses `msgSender()` )\n\nIt is confusing to have multiple functions with almost the same name, this could easily lead to mistakes.\n\n```solidity\n// https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/lib/NativeMetaTransaction.sol#L105\nfunction msgSender() internal view returns (address payable sender) {\n    if (msg.sender == address(this)) {\n        assembly {   sender := shr(96, calldataload(sub(calldatasize(), 20)))   }\n    } else {\n            sender = payable(msg.sender);\n    }\n    return sender;\n}\n```\n```solidity\n// https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Context.sol\nfunction _msgSender() internal view virtual returns (address) {\n    return msg.sender;\n}\n```\n```solidity\n//https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/nfthubs/RCNftHubL2.sol#L164\nfunction withdraw(uint256 tokenId) external override {\n    require(  _msgSender() == ownerOf(tokenId), \"ChildMintableERC721: INVALID_TOKEN_OWNER\" ); // _msgSender()\n    withdrawnTokens[tokenId] = true;\n    _burn(tokenId);\n}\n```\n```solidity\nfunction withdrawWithMetadata(uint256 tokenId) external override {\n    require( msgSender() == ownerOf(tokenId), \"ChildMintableERC721: INVALID_TOKEN_OWNER\" );  // msgSender()\n    withdrawnTokens[tokenId] = true;\n    // Encoding metadata associated with tokenId & emitting event\n    emit TransferWithMetadata( ownerOf(tokenId), address(0), tokenId, this.encodeTokenMetadata(tokenId) );\n    _burn(tokenId);\n}\n```\n```solidity\nRCNftHubL1.sol:      _setupRole(DEFAULT_ADMIN_ROLE, _msgSender());\nRCNftHubL2.sol:      _setupRole(DEFAULT_ADMIN_ROLE, _msgSender());\nRCTreasury.sol:        _setupRole(DEFAULT_ADMIN_ROLE, _msgSender());\nRCTreasury.sol:        _setupRole(UBER_OWNER,               _msgSender());\nRCTreasury.sol:        _setupRole(OWNER,                         _msgSender());\nRCTreasury.sol:        _setupRole(GOVERNOR,                   _msgSender());\nRCTreasury.sol:        _setupRole(WHITELIST,                    _msgSender());\n```\n\nRecommend double-checking the use of  `_msgSender()` in withdraw and adjust if necessary. Also, adding comments when using  `_msgSender()`. And finally consider overriding `_msgSender()`, as is done in the example [here](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/metatx/ERC2771Context.sol):\n\n**[Splidge (Reality Cards) confirmed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/22#issuecomment-903838922):**\n > I'm not sure this would have caused problems because we never intend to use `withdraw`, it's simply there as a requirement for Matic Mintable Asset Mapping. But as we stated in the readme all functions should use `msgSender()` I have removed all instances of `_msgSender()`\n\n**[Splidge (Reality Cards) patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/22#issuecomment-914177875):**\n > Fixed [here](https://github.com/RealityCards/RealityCards-Contracts/commit/7cf45e7e6730f733039e70be052088b91723dd6c)\n\n## [[L-12] `rentAllCards`: don't have to pay for card you already own](https://github.com/code-423n4/2021-08-realitycards-findings/issues/21)\n_Submitted by gpersoon_\n\nThe function `rentAllCards` of `RCMarket` checks for `_maxSumOfPrices` to see you are not paying more that you want.\n\nHowever, the first part of the calculations (which calculate `_actualSumOfPrices` ), do not take in account the fact that you might\nalready own a card. (while the second part of the code does). If you already own the card you don't have to pay for it and you certainly don't have to pay the extra `minimumPriceIncreasePercent`.\n\nThe code at \"Proof of Concept\" shows a refactored version of the code (see other issue \"make code of `rentAllCards` easier to read\").\nThis immediately shows the issue.\n\n```solidity\n// https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCMarket.sol#L691 ==> simplified version\nfunction calc(uint256 currentPrice) returns(uint256) {\n    if (currentPrice == 0)\n        return MIN_RENTAL_VALUE;\n    return (currentPrice *(minimumPriceIncreasePercent + 100)) / 100;\n}\n\nfunction rentAllCards(uint256 _maxSumOfPrices) external override {\n    ..\n    uint256 _actualSumOfPrices = 0;\n    for (uint256 i = 0; i < numberOfCards; i++) {\n        _actualSumOfPrices += calc(card[i].cardPrice);   // no check for  (ownerOf(i) != msgSender()) {\n    }\n    require(_actualSumOfPrices <= _maxSumOfPrices, \"Prices too high\");\n\n    for (uint256 i = 0; i < numberOfCards; i++) {\n        if (ownerOf(i) != msgSender()) {\n            uint256 _newPrice=calc(card[i].cardPrice);\n            newRental(_newPrice, 0, address(0), i);\n        }\n    }\n}\n```\n\nAdd \"`if (ownerOf(i) != msgSender()) {`\" also in the first part of the code of `rentAllCards`\n```solidity\nuint256 _actualSumOfPrices = 0;\nfor (uint256 i = 0; i < numberOfCards; i++) {\n    if (ownerOf(i) != msgSender()) {              // extra if statement\n        _actualSumOfPrices += calc(card[i].cardPrice);\n    }\n}\n```\n\n**[Splidge (Reality Cards) confirmed and patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/21#issuecomment-914177127):**\n > Fixed in the same commits as issue #20\n> [Here ](https://github.com/RealityCards/RealityCards-Contracts/commit/e01dbf4de444e2fc6446e49c8e2a942af635aa91)and [here](https://github.com/RealityCards/RealityCards-Contracts/commit/56a190eb7249882ccc1c75f73770d878b0c8e4cb)\n\n## [[L-13] `getMostRecentMarket` can revert](https://github.com/code-423n4/2021-08-realitycards-findings/issues/13)\n_Submitted by gpersoon_\n\nThe function `getMostRecentMarket` of `RCFactory.sol` will revert if no markets of the specific mode are created yet.\n\n```solidity\n// https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCFactory.sol#L171\nfunction getMostRecentMarket(IRCMarket.Mode _mode)  external view override  returns (address)\n{\n    return marketAddresses[_mode][marketAddresses[_mode].length - (1)];\n}\n```\n\nRecommend changing the function `getMostRecentMarket` to something like:\n```solidity\nfunction getMostRecentMarket(IRCMarket.Mode _mode)  external view override  returns (address) {\n    if ( marketAddresses[_mode].length ==0) return address(0);\n    return marketAddresses[_mode][marketAddresses[_mode].length - (1)];\n}\n```\n\n**[Splidge (Reality Cards) confirmed and patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/13#issuecomment-914173966):**\n > Fixed [here](https://github.com/RealityCards/RealityCards-Contracts/commit/4b30c9d0c9dec9316ffa2b23a39c791c0ee42efa)\n\n## [[L-14] `updateTokenURI` doesn't call `setTokenURI` ](https://github.com/code-423n4/2021-08-realitycards-findings/issues/12)\n_Submitted by gpersoon_\n\nThe function `updateTokenURI` of `RCFactory.sol` doesn't update the uris of `RCNftHubL2`.\nE.g. it doesn't call `setTokenURI` to try and update the already created NFT's.\nThis way the URIs of already minted tokens are not updated.\n\nSee issue page for referenced code.\n\nRecommend also calling `setTokenURI` of `RCNftHubL2`. Or, restricting `updateTokenURI` to the phase where no NFT's are minted yet. Or, at least add comments to `updateTokenURI`.\n\n**[Splidge (Reality Cards) confirmed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/12#issuecomment-903624339):**\n > The reason behind `updateTokenURI` is because in some early markets we found that the artwork used had copyright or trademark infringements. It was recommended from a legal point of view that we should have a mechanism for removing/amending the artwork. The end goal would be to decentralize the whole project and at that stage this legal issue disappears along with the need to change the tokenURI.\n>\n> > Also call setTokenURI of RCNftHubL2\n>\n> This could prove difficult as we haven't settled on a maximum number of NFTs we can award from the leaderboard and so there could be gas limits around updating all the tokenURIs for already minted tokens. There also exists the potential that the user has upgraded the NFT to the mainnet. Given how infrequently (ideally never) we plan to use this feature it seemed reasonable to be able to call `updateTokenURI` so all new NFTs are minted with the updated metadata and then call `setTokenURI` (on either layer 1 or layer 2) to update all the already minted tokens.\n>\n> > Or restrict updateTokenURI to the phase where no NFT's are minted yet.\n>\n> This would only work if we knew before we minted anything that there was a legal infringement, in which case we wouldn't use the art to begin with.\n>\n> > Or at least add comments to updateTokenURI\n>\n> I will add some comments to clarify the reasons for `updateTokenURI` and why we don't update already minted tokens.\n>\n> I also notice while writing this out that if we intend to relinquish the ability to `updateTokenURI` then this power should be given to the UBER_OWNER and not the OWNER. I will change this.\n\n**[Splidge (Reality Cards) patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/12#issuecomment-914173342):**\n > Fixed [here](https://github.com/RealityCards/RealityCards-Contracts/commit/832e640c3e401c4647d3f9524d42f0b4ded4d449)\n\n## [[L-15] `RCTreasury`: `AccessControl` diagram contains Leaderboard, but it has no role](https://github.com/code-423n4/2021-08-realitycards-findings/issues/44)\n_Submitted by hickuphh3, also found by leastwood and cmichel_\n\nSee issue page for diagram and discussion.\n\n## [[L-16] `RCLeaderboard.market` storage variable is not used](https://github.com/code-423n4/2021-08-realitycards-findings/issues/55)\n_Submitted by cmichel_\n\nThe `RCLeaderboard.market` storage variable is never used. Instead, the `MARKET` role seems to be used to implement authentication.\n\nUnused code can hint at programming or architectural errors.\n\nRecommend using it or remove it.\n\n**[Splidge (Reality Cards) confirmed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/55#issuecomment-906326040):**\n > Removed it.\n\n**[Splidge (Reality Cards) patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/55#issuecomment-914209526):**\n > Fixed [here](https://github.com/RealityCards/RealityCards-Contracts/commit/2f5f3a69556581534850d6e7f5764803657bca46)\n\n## [[L-17] Markets can start in the past](https://github.com/code-423n4/2021-08-realitycards-findings/issues/54)\n_Submitted by cmichel_\n\nThe `RCFactory._checkTimestamps` function only checks that the start timestamp (`_timestamps[0]`) is not in the past if `advancedWarning != 0`.\n\nMarkets can be created that already started in the past. I'm not sure if this is intended.\n\nRecommend always performing the `require(_timestamps[0] >= block.timestamp, \"Market opening time not set\");` check, not only in the `advancedWarning != 0` case.\n\n**[Splidge (Reality Cards) disputed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/54#issuecomment-906328308):**\n > In the case where we want to open a market immediately it would be difficult to do so without allowing timestamps in the past because we can't say what time the transaction will be mined and so what the `block.timestamp` would be.\n> By not checking this we can open markets immediately with ease.\n\n**[0xean (judge) commented](https://github.com/code-423n4/2021-08-realitycards-findings/issues/54#issuecomment-911595969):**\n > The check could allow for some expected amount of time slippage due to mining to have transpired and potentially still be useful to avoid errors.  I think it's a valid point by the warden.\n\n**[Splidge (Reality Cards) acknowledged](https://github.com/code-423n4/2021-08-realitycards-findings/issues/54#issuecomment-914209029):**\n > Changing to acknowledged based on the judges assessment.\n\n## [[L-18] add zero address validation in constructor](https://github.com/code-423n4/2021-08-realitycards-findings/issues/61)\n_Submitted by JMukesh, also found by cmichel_\n\nsince the parameter in the constructor are used to initialize the state variable , proper check up should be done , other wise error in these state variable  can lead to redeployment of contract. See issue page for referenced code.\n\nRecommend adding zero address validation.\n\n**[Splidge (Reality Cards) confirmed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/61#issuecomment-906312328):**\n > RCOrderbook and RCTreasury both have setter functions where an incorrectly initialized variable could be set after deployment. It's unlikely for these to be set incorrectly because of the deployment script we use, however I'll add a setter to the RCLeaderboard so we can set the address afterwards.\n\n**[Splidge (Reality Cards) patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/61#issuecomment-911974255):**\n > Treasury setter in RCLeaderboard added [here](https://github.com/RealityCards/RealityCards-Contracts/commit/da990810844966f3841b41b31db696ae2961e701)\n\n## [[L-19] use of array without checking its length](https://github.com/code-423n4/2021-08-realitycards-findings/issues/60)\n_Submitted by JMukesh_\n\nSince no limit is mentioned in `batchWhitelist()` for the input of `_users` array , it may run out of gas if array length become large. See [`RCTreasury.sol` L249](https://github.com/code-423n4/2021-08-realitycards/blob/39d711fdd762c32378abf50dc56ec51a21592917/contracts/RCTreasury.sol#L249).\n\nRecommend adding a limitation for which , this number of address can be whitelisted at a time.\n\n**[Splidge (Reality Cards) acknowledged](https://github.com/code-423n4/2021-08-realitycards-findings/issues/60#issuecomment-906314633):**\n > This whitelist is a temporary measure to be used in the Beta and the run-up to launch, after launch it will be disabled. As such we will not be making changes to a feature that will not be used going forward.\n\n## [[L-20] No check for the `referenceContractAddress` in `createMarket()`](https://github.com/code-423n4/2021-08-realitycards-findings/issues/50)\n_Submitted by JMukesh_\n\n `referenceContractAddress` is used in `createMarket()` to create `newAddress`  for the market , a necessary check should be there that `referenceContractAddress` exist or not, because if `createMarket()` is called before `setReferenceContractAddress()`, `address(0)` will be passed as `referenceContractAddress` , since `addMarket()` of `treasury` and `nfthub` does not have address validation for the market. See [`RCFactory.sol` L714](https://github.com/code-423n4/2021-08-realitycards/blob/39d711fdd762c32378abf50dc56ec51a21592917/contracts/RCFactory.sol#L714).\n\nRecommend adding a condition to check the `referenceContractAddress`\n\n**[Splidge (Reality Cards) confirmed and patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/50#issuecomment-914206143):**\n > Fixed [here](https://github.com/RealityCards/RealityCards-Contracts/commit/88bf46cea4e239a44054c6dfad481cad0bf262c3)\n\n## [[L-21] no time restriction in `setMarketTimeRestrictions`()](https://github.com/code-423n4/2021-08-realitycards-findings/issues/49)\n_Submitted by JMukesh_\n\nAs mentioned in the comment, time must be at least this many seconds, but it lack a check that given time is `atleast >= someTime` , as a result\n `minimumDuration` and `maximumDuration` are directly initialized without any check. See [`RCFactory.sol` L431](https://github.com/code-423n4/2021-08-realitycards/blob/39d711fdd762c32378abf50dc56ec51a21592917/contracts/RCFactory.sol#L431).\n\nRecommend adding require condition to check those value before setting it.\n\n**[Splidge (Reality Cards) confirmed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/49#issuecomment-905292773):**\n > This is just poor commenting from when `advancedWarning`, `minimumDuration` and `maximumDuration` each had their own setter functions. They were combined to avoid the Factory going over the contract size limit. However the comments weren't combined correctly.\n> 0 seconds is a valid `advancedWarning` if you want the market to open immediately.\n> 0 seconds for `maximumDuration` may also be used if we [don't want to set a maximum](https://github.com/code-423n4/2021-08-realitycards/blob/39d711fdd762c32378abf50dc56ec51a21592917/contracts/RCFactory.sol#L785).\n>\n> I'll not be adding in the checks but I will update the comments.\n\n**[Splidge (Reality Cards) acknowledged](https://github.com/code-423n4/2021-08-realitycards-findings/issues/49#issuecomment-914205286):**\n > On looking back through this I may have misunderstood what the warden was proposing here. I thought the warden wanted a zero value check, but they could have been asking for the `minimumDuration` < `maximumDuration` check.\n> This would make more sense as if the maximum was less than the minimum it wouldn't be possible to create a new market. The same problem would happen if `advancedWarning` was set to be greater than the `maximumDuration`.\n> Unfortunately the Factory is right on the size limit and adding these checks would require other changes to the contract which pose the risk of introducing more problems. Given how infrequently we expect to change these values, and the fact they can be changed back again should a mistake be made, I'll be marking this issue as acknowledged.\n> Initial fix to add more comments was implemented [here](https://github.com/RealityCards/RealityCards-Contracts/commit/35ef821e97dccea294b61af37a07bf7af335866d)\n\n## [[L-22] `transferCard` should be done after treasury is updated.](https://github.com/code-423n4/2021-08-realitycards-findings/issues/35)\n_Submitted by 0xImpostor_\n\nWhen the current owner of the card is still the new owner of the card, `transferCard` is called before the treasury is updated. While this does not currently pose a risk, it is not aligned with best practices of [check-effect-interations](https://fravoll.github.io/solidity-patterns/checks_effects_interactions.html) and opens your code to a potential re-entrancy attack in the future.\n\n```jsx\n// line 381\ntreasury.updateRentalRate(\n    _oldOwner,\n    _user,\n    user[_oldOwner][index[_oldOwner][_market][_card]].price,\n    _price,\n    block.timestamp\n);\ntransferCard(_market, _card, _oldOwner, _user, _price);\n...\n// line 449\ntreasury.updateRentalRate(\n    _user,\n    _user,\n    _price,\n    _currUser.price,\n    block.timestamp\n);\ntransferCard(_market, _card, _user, _user, _currUser.price);\n```\n\n**[Splidge (Reality Cards) commented](https://github.com/code-423n4/2021-08-realitycards-findings/issues/35#issuecomment-914190673):**\n > Fixed [here](https://github.com/RealityCards/RealityCards-Contracts/commit/2660831497b3596c4438f434aaa49f280a58063a)\n\n\n## [[L-23] Inaccurate Comment](https://github.com/code-423n4/2021-08-realitycards-findings/issues/16)\n_Submitted by leastwood_\n\nThis issue has no direct security implications, however, there may be some confusion when understanding what the `RCFactory.createMarket()` function actually does. See [`RCFactory.sol` L625](https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/RCFactory.sol#L625).\n\nRecommend updating the line (linked above) to include the `SAFE_MODE` option outline in the `enum` type in `IRCMarket.sol`. For example, the line `/// @param _mode 0 = normal, 1 = winner takes all` could be updated to `/// @param _mode 0 = normal, 1 = winner takes all, 2 = SAFE_MODE`\n\n**[0xean (judge) confirmed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/16#issuecomment-911628107):**\n > Based on C4's docs - Comment issues are 1, bumping to 1.\n>\n> \"1 — Low: Low: Assets are not at risk. State handling, function incorrect as to spec, issues with comments.\"\n\n**[Splidge (Reality Cards patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/16#issuecomment-914174809):**\n > Fixed [here](https://github.com/RealityCards/RealityCards-Contracts/commit/0ef0e52b2e1ec82a1c9d02ea6e0990e41afdcc37)\n\n## [[L-24] `RCLeaderboard`: Erroneous comment](https://github.com/code-423n4/2021-08-realitycards-findings/issues/43)\n_Submitted by hickuphh3_\n\nThe comments above the event declarations were probably copied over from `RCOrderbook`. They should be modified to refer to the leaderboard.\n\n```jsx\n/// @dev emitted every time a user is added to the leaderboard\nevent LogAddToLeaderboard(address _user, address _market, uint256 _card);\n/// @dev emitted every time a user is removed from the leaderboard\nevent LogRemoveFromLeaderboard(\n    address _user,\n    address _market,\n    uint256 _card\n);\n```\n\n**[Splidge (Reality Cards) confirmed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/43#issuecomment-905457111):**\n > > probably copied over from RCOrderbook\n>\n> Exactly. I'll correct this.\n\n**[0xean (judge) commented](https://github.com/code-423n4/2021-08-realitycards-findings/issues/43#issuecomment-911630908):**\n > ```\n> 1 — Low: Low: Assets are not at risk. State handling, function incorrect as to spec, issues with comments.\n> ```\n\n**[Splidge (Reality Cards) patched](https://github.com/code-423n4/2021-08-realitycards-findings/issues/43#issuecomment-914192628):**\n > Fixed [here](https://github.com/RealityCards/RealityCards-Contracts/commit/f5fa3b32fb5bdd6aafba0a6d5279eae43f27df24)\n\n## [[L-25] Use `_safeTransfer` when transferring NFTs](https://github.com/code-423n4/2021-08-realitycards-findings/issues/65)\n_Submitted by shw_\n\nThe `transferNft` function of `RCNftHubL2` is called when transferring the card to the final winner. However, this function does not check whether the recipient is aware of the ERC721 protocol and calls `_transfer` directly. If the recipient is a contract not aware of incoming NFTs, then the transferred NFT would be locked in the recipient forever. See [`RCNftHubL2.sol` L135](https://github.com/code-423n4/2021-08-realitycards/blob/main/contracts/nfthubs/RCNftHubL2.sol#L135).\n\nRecommend using the [`_safeTransfer`]((https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC721/ERC721.sol#L205-L213)) function instead, which checks if the recipient contract implements the `onERC721Received` interface to avoid loss of NFTs.\n\n**[Splidge (Reality Cards) disputed](https://github.com/code-423n4/2021-08-realitycards-findings/issues/65#issuecomment-906259629):**\n > This transfer function is just for the market to move the NFTs while the market is operational, during this phase it doesn't matter if the NFT is given to a non-compliant contract as the market is in control of moving the NFT and will simply give it to the next user that makes a rental.\n> Using `_safeTransfer` would be dangerous as it would give an attacker the opportunity to take part in a market via a contract that is not ERC721 compliant, when the market attempts to pass ownership to this contract the transfer would revert and the market would become locked.\n\n**[0xean (judge) commented](https://github.com/code-423n4/2021-08-realitycards-findings/issues/65#issuecomment-911750645):**\n > `claimCard` in RCMarket.sol also calls the transfer method to claim the card, which could result in the situation outlined by the warden.\n\n**[Splidge (Reality Cards) commented](https://github.com/code-423n4/2021-08-realitycards-findings/issues/65#issuecomment-911817656):**\n > Ahh sorry, I missed the key part in the wardens impact \"when transferring the card to the final winner\".\n>\n> I still think this isn't an issue as if the destination is a non-compliant contract, when using `_safeTransfer` the `claimCard` call would revert. The NFT is permanently stuck on either the market or on the non-compliant contract.\n> At least the person who wrote the contract, funded it, used it to place bids, win the NFT and make the `claimCard` call would still get it transferred to their contract to use as a trophy cabinet of sorts. Maybe that person didn't implement `onERC721Received`?\n> This check would be too little too late.\n>\n> Maybe we could check when the first rental is made that the sender is eligible? Although that would deviate slightly from the standard as `onERC721Received` is supposed to be called after the transfer.\n\n# Non-Critical Findings (11)\n\n- [[N-01] Unable to Recover Improperly Transferred Tokens](https://github.com/code-423n4/2021-08-realitycards-findings/issues/62)\n- [[N-02] User can deposit more than `maxContractBalance`](https://github.com/code-423n4/2021-08-realitycards-findings/issues/71)\n- [[N-03] Divide Before Multiply](https://github.com/code-423n4/2021-08-realitycards-findings/issues/25)\n- [[N-04] Remove hardhat console import](https://github.com/code-423n4/2021-08-realitycards-findings/issues/48)\n- [[N-05] ``RCTreasury``: Spelling Errors](https://github.com/code-423n4/2021-08-realitycards-findings/issues/47)\n- [[N-06] ``RCTreasury``: new `hasRole()` function with string role](https://github.com/code-423n4/2021-08-realitycards-findings/issues/45)\n- [[N-07] `RCFactory`: Unnecessary casting in `updateTokenURI()`](https://github.com/code-423n4/2021-08-realitycards-findings/issues/42)\n- [[N-08] Access Control Constants](https://github.com/code-423n4/2021-08-realitycards-findings/issues/38)\n- [[N-09] `tokenExists` ==> `cardExists`](https://github.com/code-423n4/2021-08-realitycards-findings/issues/9)\n- [[N-10] remove `addMarket` from `RCNftHubL2`](https://github.com/code-423n4/2021-08-realitycards-findings/issues/11)\n- [[N-11] remove unused modifiers](https://github.com/code-423n4/2021-08-realitycards-findings/issues/10)\n\n# Gas Optimizations (9)\n\n- [[G-01] Overflow in `Mode` Type](https://github.com/code-423n4/2021-08-realitycards-findings/issues/17)\n- [[G-02] gas saving in `_processRentCollection`](https://github.com/code-423n4/2021-08-realitycards-findings/issues/68)\n- [[G-03] `RCMarket.sol` - Gas optimization in `_payoutWinnings`](https://github.com/code-423n4/2021-08-realitycards-findings/issues/6)\n- [[G-04] `RCMarket.sol` - Gas optimization in `claimCard`](https://github.com/code-423n4/2021-08-realitycards-findings/issues/5)\n- [[G-05] optimize `_beforeTokenTransfer](https://github.com/code-423n4/2021-08-realitycards-findings/issues/19)\n- [[G-06] make code of `rentAllCards` easier to read and maintain](https://github.com/code-423n4/2021-08-realitycards-findings/issues/20)\n- [[G-07] Tight Variable Packing](https://github.com/code-423n4/2021-08-realitycards-findings/issues/32)\n- [[G-08] Allowance checks are not required](https://github.com/code-423n4/2021-08-realitycards-findings/issues/7)\n- [[G-09] Gas optimization in `RCMarket.sol` and other files](https://github.com/code-423n4/2021-08-realitycards-findings/issues/72)\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}