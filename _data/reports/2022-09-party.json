{
  "circa": {
    "title": "PartyDAO contest",
    "sponsor": "PartyDAO",
    "slug": "2022-09-party",
    "date": "2022-11-17",
    "findings": "https://github.com/code-423n4/2022-09-party-findings/issues",
    "contest": 160
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the PartyDAO smart contract system written in Solidity. The audit contest took place between September 12—September 19 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>119 Wardens contributed reports to the PartyDAO contest:</p>\n<ol>\n<li>Lambda</li>\n<li><a href=\"https://twitter.com/trust__90\">Trust</a></li>\n<li>0x52</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li>cccz</li>\n<li><a href=\"https://twitter.com/8olidity\">8olidity</a></li>\n<li><a href=\"https://twitter.com/bin2chen\">bin2chen</a></li>\n<li><a href=\"https://twitter.com/0xhyh\">hyh</a></li>\n<li>ladboy233</li>\n<li>CertoraInc (egjlmn1, <a href=\"https://twitter.com/ori_dabush\">OriDabush</a>, ItayG, shakedwinder and RoiEvenHaim)</li>\n<li><a href=\"https://github.com/SmilingHeretic\">smiling_heretic</a></li>\n<li>V_B (Barichek and vlad_bochok)</li>\n<li>rvierdiiev</li>\n<li>0xA5DF</li>\n<li><a href=\"https://twitter.com/0xch301\">Ch_301</a></li>\n<li><a href=\"https://jeiwan.net\">Jeiwan</a></li>\n<li><a href=\"https://twitter.com/0xSmartContract\">0xSmartContract</a></li>\n<li>tonisives</li>\n<li>rbserver</li>\n<li><a href=\"https://chom.dev\">Chom</a></li>\n<li><a href=\"https://t.me/pfahard\">pfapostol</a></li>\n<li>brgltd</li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li><a href=\"https://twitter.com/0xNazgul\">0xNazgul</a></li>\n<li><a href=\"https://t.me/Road220\">m_Rassska</a></li>\n<li><a href=\"https://twitter.com/sm4rtcontr4ct\">JC</a></li>\n<li><a href=\"https://twitter.com/Deivitto\">Deivitto</a></li>\n<li>CodingNameKiki</li>\n<li>ayeslick</li>\n<li><a href=\"https://milotruck.github.io/\">MiloTruck</a></li>\n<li>ReyAdmirado</li>\n<li><a href=\"https://www.linkedin.com/in/georgi-nikolaev-georgiev-978253219\">gogo</a></li>\n<li>0x1f8b</li>\n<li>CRYP70</li>\n<li>asutorufos</li>\n<li>bulej93</li>\n<li>RaymondFam</li>\n<li>erictee</li>\n<li>leosathya</li>\n<li>__141345__</li>\n<li><a href=\"https://github.com/Aymen1001\">Aymen0909</a></li>\n<li><a href=\"https://twitter.com/father0fBl0cks\">fatherOfBlocks</a></li>\n<li>lukris02</li>\n<li><a href=\"https://instagram.com/vanensurya\">Funen</a></li>\n<li>malinariy</li>\n<li>0x5rings</li>\n<li>PaludoX0</li>\n<li>ch0bu</li>\n<li>ChristianKuri</li>\n<li>slowmoses</li>\n<li>delfin454000</li>\n<li>djxploit</li>\n<li><a href=\"https://github.com/martin-petrov03\">martin</a></li>\n<li><a href=\"https://tom-sol.notion.site/Who-am-I-3b4dc28e77b647eb90794735a94dd38e\">Tomo</a></li>\n<li>Olivierdem</li>\n<li>0x4non</li>\n<li>tnevler</li>\n<li>B2</li>\n<li>StevenL</li>\n<li>d3e4</li>\n<li>cryptphi</li>\n<li>R2</li>\n<li>0xbepresent</li>\n<li><a href=\"https://twitter.com/hansfriese\">hansfriese</a></li>\n<li>pedr02b2</li>\n<li>wagmi</li>\n<li>KIntern_NA (TrungOre and duc)</li>\n<li>The<em>GUILD ([David</em>](<a href=\"https://twitter.com/davidpius10\">https://twitter.com/davidpius10</a>), <a href=\"https://twitter.com/iamephraim_js\">Ephraim</a>, LeoGold, and greatsamist)</li>\n<li>Anth3m</li>\n<li><a href=\"https://twitter.com/DanielCawleyDev\">0xDanielC</a></li>\n<li><a href=\"https://www.linkedin.com/in/jansen-moreira/?locale=en_US\">JansenC</a></li>\n<li>MasterCookie</li>\n<li><a href=\"https://twitter.com/krenkmet\">indijanc</a></li>\n<li>Rolezn</li>\n<li>0xkatana</li>\n<li>JAGADESH</li>\n<li><a href=\"https://twitter.com/Sm4rty_\">Sm4rty</a></li>\n<li>ajtra</li>\n<li>peiw</li>\n<li>SnowMan</li>\n<li><a href=\"https://twitter.com/prasantgupta52\">prasantgupta52</a></li>\n<li><a href=\"https://twitter.com/ROHANJH56009256\">Rohan16</a></li>\n<li>Bnke0x0</li>\n<li>gianganhnguyen</li>\n<li>karanctf</li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li>sryysryy</li>\n<li><a href=\"https://twitter.com/0xheynacho\">ignacio</a></li>\n<li>Metatron</li>\n<li>Waze</li>\n<li>robee</li>\n<li>Saintcode_</li>\n<li>jag</li>\n<li>got_targ</li>\n<li>Amithuddar</li>\n<li><a href=\"https://twitter.com/fitraldys\">Fitraldys</a></li>\n<li>LeoS</li>\n<li><a href=\"https://twitter.com/natzuu33\">natzuu</a></li>\n<li>simon135</li>\n<li>Diraco</li>\n<li>francoHacker</li>\n<li>Noah3o6</li>\n<li><a href=\"https://twitter.com/bluenights004\">Ocean_Sky</a></li>\n<li><a href=\"https://twitter.com/im_Dharma09\">dharma09</a></li>\n<li><a href=\"https://twitter.com/AdonaiR6\">IgnacioB</a></li>\n<li>peanuts</li>\n<li>0x85102</li>\n<li>aysha</li>\n<li>Matin</li>\n<li>pashov</li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/HardlyDifficult\">HardlyDifficult</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/itsmetechjay\">itsmetechjay</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 19 unique vulnerabilities. Of these vulnerabilities, 7 received a risk rating in the category of HIGH severity and 12 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 67 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 82 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-09-party\">C4 PartyDAO contest repository</a>, and is composed of 46 smart contracts written in the Solidity programming language and includes 3,995 lines of Solidity code. For the purposes of the audit contest, the code was forked into a new repo from its main location in the PartyDAO party-protocol repo at this commit hash: <a href=\"https://github.com/PartyDAO/party-protocol/tree/1eb4909a2f568d910e70e2db1b487a0236fbe10b\">1eb4909a2f568d910e70e2db1b487a0236fbe10b</a>.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-7\" style=\"position:relative;\"><a href=\"#high-risk-findings-7\" aria-label=\"high risk findings 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (7)</h1>\n<h2 id=\"h-01-partygovernance-can-vote-multiple-times-by-transferring-nft-in-same-block-as-proposal\" style=\"position:relative;\"><a href=\"#h-01-partygovernance-can-vote-multiple-times-by-transferring-nft-in-same-block-as-proposal\" aria-label=\"h 01 partygovernance can vote multiple times by transferring nft in same block as proposal permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/113\">[H-01] PartyGovernance: Can vote multiple times by transferring NFT in same block as proposal</a></h2>\n<p><em>Submitted by Lambda, also found by Trust</em></p>\n<p><code>PartyGovernanceNFT</code> uses the voting power at the time of proposal when calling <code>accept</code>. The problem with that is that a user can vote, transfer the NFT (and the voting power) to a different wallet, and then vote from this second wallet again during the same block that the proposal was created.\nThis can also be repeated multiple times to get an arbitrarily high voting power and pass every proposal unanimously.</p>\n<p>The consequences of this are very severe. Any user (no matter how small his voting power is) can propose and pass arbitrary proposals animously and therefore steal all assets (including the precious tokens) out of the party.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof Of Concept</h3>\n<p>This diff shows how a user with a voting power of 50/100 gets a voting power of 100/100 by transferring the NFT to a second wallet that he owns and voting from that one:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/sol-tests/party/PartyGovernanceUnit.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/sol-tests/party/PartyGovernanceUnit.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -762,6 +762,7 @@ contract PartyGovernanceUnitTest is Test, TestUtils {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         TestablePartyGovernance gov =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             _createGovernance(100e18, preciousTokens, preciousTokenIds);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address undelegatedVoter = _randomAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        address recipient = _randomAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // undelegatedVoter has 50/100 intrinsic VP (delegated to no one/self)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         gov.rawAdjustVotingPower(undelegatedVoter, 50e18, address(0));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -772,38 +773,13 @@ contract PartyGovernanceUnitTest is Test, TestUtils {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Undelegated voter submits proposal.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         vm.prank(undelegatedVoter);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         assertEq(gov.propose(proposal, 0), proposalId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        // Try to execute proposal (fail).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        vm.expectRevert(abi.encodeWithSelector(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            PartyGovernance.BadProposalStatusError.selector,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            PartyGovernance.ProposalStatus.Voting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        ));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        vm.prank(undelegatedVoter);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        gov.execute(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            proposalId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            proposal,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            preciousTokens,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            preciousTokenIds,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            &quot;&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            &quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        // Skip past execution delay.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        skip(defaultGovernanceOpts.executionDelay);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        // Try again (fail).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        vm.expectRevert(abi.encodeWithSelector(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            PartyGovernance.BadProposalStatusError.selector,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            PartyGovernance.ProposalStatus.Voting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        ));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        vm.prank(undelegatedVoter);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        gov.execute(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            proposalId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            proposal,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            preciousTokens,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            preciousTokenIds,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            &quot;&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            &quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        (, PartyGovernance.ProposalStateValues memory valuesPrev) = gov.getProposalStateInfo(proposalId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assertEq(valuesPrev.votes, 50e18);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        gov.transferVotingPower(undelegatedVoter, recipient, 50e18); //Simulate NFT transfer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        vm.prank(recipient);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        gov.accept(proposalId, 0);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        (, PartyGovernance.ProposalStateValues memory valuesAfter) = gov.getProposalStateInfo(proposalId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assertEq(valuesAfter.votes, 100e18);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>You should query the voting power at <code>values.proposedTime - 1</code>. This value is already finalized when the proposal is created and therefore cannot be manipulated by repeatedly transferring the voting power to different wallets.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/113#issuecomment-1254200841\">merklejerk (PartyDAO) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This is our favorite find and want to call it out specifically. We would consider this critical.</p>\n<p>We will implement the suggested fix in this PR and use <code>proposedTime - 1</code> for voting power calculations.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/113#issuecomment-1262756331\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with High risk - any user with a non-zero voting power can pass a proposal &#x26; steal assets.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/113#issuecomment-1264675378\">0xble (PartyDAO) resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved: <a href=\"https://github.com/PartyDAO/partybidV2/pull/130\">https://github.com/PartyDAO/partybidV2/pull/130</a></p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-possibility-to-burn-all-eth-in-crowdfund-under-some-circumstances\" style=\"position:relative;\"><a href=\"#h-02-possibility-to-burn-all-eth-in-crowdfund-under-some-circumstances\" aria-label=\"h 02 possibility to burn all eth in crowdfund under some circumstances permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/105\">[H-02] Possibility to burn all ETH in Crowdfund under some circumstances</a></h2>\n<p><em>Submitted by Lambda, also found by 8olidity</em></p>\n<p>If <code>opts.initialContributor</code> is set to <code>address(0)</code> (and <code>opts.initialDelegate</code> is not), there are two problems:\n1.) If the crowdfund succeeds, the initial balance will be lost. It is still accredited to <code>address(0)</code>, but it is not retrievable.\n2.) If the crowdfund does not succeed, anyone can completely drain the contract by repeatedly calling <code>burn</code> with <code>address(0)</code>. This will always succeed because <code>CrowdfundNFT._burn</code> can be called multiple times for <code>address(0)</code>. Every call will cause the initial balance to be burned (transferred to <code>address(0)</code>).</p>\n<p>Issue 1 is somewhat problematic, but issue 2 is very problematic, because all funds of a crowdfund are burned and an attacker can specifically set up such a deployment (and the user would not notice anything special, after all these are parameters that the protocol accepts).</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof Of Concept</h3>\n<p>This diff illustrates scenario 2, i.e. where a malicious deployer burns all contributions (1 ETH) of <code>contributor</code>. He loses 0.25ETH for the attack, but this could be reduced significantly (with more <code>burn(payable(address(0)))</code> calls:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/sol-tests/crowdfund/BuyCrowdfund.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/sol-tests/crowdfund/BuyCrowdfund.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -36,9 +36,9 @@ contract BuyCrowdfundTest is Test, TestUtils {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     string defaultSymbol = &#39;PBID&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint40 defaultDuration = 60 * 60;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint96 defaultMaxPrice = 10e18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    address payable defaultSplitRecipient = payable(0);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    address payable defaultSplitRecipient = payable(address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint16 defaultSplitBps = 0.1e4;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    address defaultInitialDelegate;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    address defaultInitialDelegate = address(this);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     IGateKeeper defaultGateKeeper;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     bytes12 defaultGateKeeperId;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     Crowdfund.FixedGovernanceOpts defaultGovernanceOpts;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -78,7 +78,7 @@ contract BuyCrowdfundTest is Test, TestUtils {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     maximumPrice: defaultMaxPrice,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     splitRecipient: defaultSplitRecipient,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     splitBps: defaultSplitBps,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                    initialContributor: address(this),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                    initialContributor: address(0),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     initialDelegate: defaultInitialDelegate,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     gateKeeper: defaultGateKeeper,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     gateKeeperId: defaultGateKeeperId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -111,40 +111,26 @@ contract BuyCrowdfundTest is Test, TestUtils {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function testHappyPath() public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 tokenId = erc721Vault.mint();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Create a BuyCrowdfund instance.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        BuyCrowdfund pb = _createCrowdfund(tokenId, 0);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        BuyCrowdfund pb = _createCrowdfund(tokenId, 0.25e18);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Contribute and delegate.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address payable contributor = _randomAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address delegate = _randomAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         vm.deal(contributor, 1e18);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         vm.prank(contributor);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         pb.contribute{ value: contributor.balance }(delegate, &quot;&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        // Buy the token.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        vm.expectEmit(false, false, false, true);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        emit MockPartyFactoryCreateParty(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            address(pb),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            address(pb),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            _createExpectedPartyOptions(0.5e18),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            _toERC721Array(erc721Vault.token()),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            _toUint256Array(tokenId)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        Party party_ = pb.buy(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            payable(address(erc721Vault)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            0.5e18,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            abi.encodeCall(erc721Vault.claim, (tokenId)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            defaultGovernanceOpts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        assertEq(address(party), address(party_));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        // Burn contributor&#39;s NFT, mock minting governance tokens and returning</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        // unused contribution.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        vm.expectEmit(false, false, false, true);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        emit MockMint(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            address(pb),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            contributor,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            0.5e18,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            delegate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        pb.burn(contributor);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        assertEq(contributor.balance, 0.5e18);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        vm.warp(block.timestamp + defaultDuration + 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // The auction was not won, we can now burn all ETH from contributor...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assertEq(address(pb).balance, 1.25e18);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        pb.burn(payable(address(0)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assertEq(address(pb).balance, 1e18);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        pb.burn(payable(address(0)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assertEq(address(pb).balance, 0.75e18);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        pb.burn(payable(address(0)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assertEq(address(pb).balance, 0.5e18);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        pb.burn(payable(address(0)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assertEq(address(pb).balance, 0.25e18);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        pb.burn(payable(address(0)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assertEq(address(pb).balance, 0);</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Do not allow an initial contribution when <code>opts.initialContributor</code> is not set.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/105#issuecomment-1254181677\">merklejerk (PartyDAO) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Excellent catch. We will implement the fix from <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/238\">#238</a> and prevent minting to <code>address(0)</code>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/105#issuecomment-1262738133\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with High risk - a crowdfund’s initial configuration could lead to the loss of user funds.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/105#issuecomment-1264675679\">0xble (PartyDAO) resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved: <a href=\"https://github.com/PartyDAO/partybidV2/pull/127\">https://github.com/PartyDAO/partybidV2/pull/127</a></p>\n</blockquote>\n<hr>\n<h2 id=\"h-03-a-majority-attack-can-easily-bypass-zora-auction-stage-in-openseaproposal-and-steal-the-nft-from-the-party\" style=\"position:relative;\"><a href=\"#h-03-a-majority-attack-can-easily-bypass-zora-auction-stage-in-openseaproposal-and-steal-the-nft-from-the-party\" aria-label=\"h 03 a majority attack can easily bypass zora auction stage in openseaproposal and steal the nft from the party permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/264\">[H-03] A majority attack can easily bypass Zora auction stage in OpenseaProposal and steal the NFT from the party.</a></h2>\n<p><em>Submitted by Trust</em></p>\n<p>The PartyGovernance system has many defenses in place to protect against a majority holder stealing the NFT. One of the main protections is that before listing the NFT on Opensea for a proposal-supplied price, it must first try to be auctioned off on Zora. To move from Zora stage to Opensea stage, <code>\\_settleZoraAuction()</code> is called when executing ListedOnZora step in ListOnOpenseaProposal.sol. If the function returns false, the next step is executed which lists the item on Opensea. It is assumed that if majority attack proposal reaches this stage, it can steal the NFT for free, because it can list the item for negligible price and immediately purchase it from a contract that executes the Opensea proposal.</p>\n<p>Indeed, attacker can always make <code>settleZoraAuction()</code> return false. Looking at  the code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">try ZORA.endAuction(auctionId) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Check whether auction cancelled due to a failed transfer during</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // settlement by seeing if we now possess the NFT.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (token.safeOwnerOf(tokenId) == address(this)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                emit ZoraAuctionFailed(auctionId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                return false;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } catch (bytes memory errData) {</span></span></code></pre>\n<p>As the comment already hints, an auction can be cancelled if the NFT transfer to the bidder fails. This is the relevant AuctionHouse code (endAuction):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // transfer the token to the winner and pay out the participants below</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            try IERC721(auctions[auctionId].tokenContract).safeTransferFrom(address(this), auctions[auctionId].bidder, auctions[auctionId].tokenId) {} catch {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                _handleOutgoingBid(auctions[auctionId].bidder, auctions[auctionId].amount, auctions[auctionId].auctionCurrency);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                _cancelAuction(auctionId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> }</span></span></code></pre>\n<p>As most NFTs inherit from OpenZeppelin’s ERC721.sol code, safeTransferFrom will run:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _safeTransfer(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address from,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address to,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 tokenId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes memory data</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) internal virtual {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _transfer(from, to, tokenId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(_checkOnERC721Received(from, to, tokenId, data), &quot;ERC721: transfer to non ERC721Receiver implementer&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>So, attacker can bid a very high amount on the NFT to ensure it is the winning bid. When AuctionHouse tries to send the NFT to attacker, the safeTransferFrom will fail because attack will not implement an ERC721Receiver. This will force the AuctionHouse to return the bid amount to the bidder and cancel the auction. Importantly, it will lead to a graceful return from <code>endAuction()</code>, which will make <code>settleZoraAuction()</code> return false and progress to the OpenSea stage.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>A majority attack can easily bypass Zora auction stage and steal the NFT from the party.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Pass a ListOnOpenseaProposal with a tiny list price and execute it</li>\n<li>Create an attacker contract which bids on the NFT an overpriced amount, but does not implement ERC721Receiver. Call its bid() function</li>\n<li>Wait for the auction to end ( timeout after the bid() call)</li>\n<li>Create a contract with a function which calls execute() on the proposal and immediately buys the item on Seaport. Call the attack function.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p><code>\\_settleZoraAuction</code> is called from both ListOnZoraProposal and ListOnOpenseaProposal. If the auction was cancelled due to a failed transfer, as is described in the comment, we would like to handle it differently for each proposal type. For ListOnZoraProposal, it should indeed return false, in order to finish executing the proposal and not to hang the engine. For ListOnOpenseaProposal, the desired behavior is to <em>revert</em> in the case of a failed transfer. This is because the next stage is risky and defense against the mentioned attack is required. Therefore, pass a revertOnFail flag to <code>\\_settleZoraAuction</code>, which will be used like so:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// Check whether auction cancelled due to a failed transfer during</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// settlement by seeing if we now possess the NFT.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (token.safeOwnerOf(tokenId) == address(this)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tif (revertOnFail) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\trevert(&quot;Zora auction failed because of transfer to bidder&quot;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">           emit ZoraAuctionFailed(auctionId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">           return false;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/264#issuecomment-1255311135\">merklejerk (PartyDAO) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Great find. We will modify <code>_settleZoraAuction()</code> to return some auction status to be communicated up to the Opensea proposal.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/264#issuecomment-1262795619\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>TIL. While digging into this I noticed that Zora changed this logic in their V3 implementation, avoiding this scenario - but there may be reasons to prefer the auction house contract.</p>\n<p>Agree with High risk - the auction safeguard can be bypassed, allowing a majority owner to steal from the rest of the party.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/264#issuecomment-1264680120\">0xble (PartyDAO) resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved: <a href=\"https://github.com/PartyDAO/partybidV2/pull/137\">https://github.com/PartyDAO/partybidV2/pull/137</a></p>\n</blockquote>\n<hr>\n<h2 id=\"h-04-tokendistributor-erc777-tokenstosend-hook-can-be-exploited-to-drain-contract\" style=\"position:relative;\"><a href=\"#h-04-tokendistributor-erc777-tokenstosend-hook-can-be-exploited-to-drain-contract\" aria-label=\"h 04 tokendistributor erc777 tokenstosend hook can be exploited to drain contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/120\">[H-04] TokenDistributor: ERC777 tokensToSend hook can be exploited to drain contract</a></h2>\n<p><em>Submitted by Lambda</em></p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/distribution/TokenDistributor.sol#L131\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/distribution/TokenDistributor.sol#L131</a></p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/distribution/TokenDistributor.sol#L386\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/distribution/TokenDistributor.sol#L386</a></p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p><code>TokenDistributor.createERC20Distribution</code> can be used to create token distributions for ERC777 tokens (which are backwards-compatible with ERC20). However, this introduces a reentrancy vulnerability which allows a party to get the tokens of another party. The problem is the <code>tokensToSend</code> hook which is executed BEFORE balance updates happens (see <a href=\"https://eips.ethereum.org/EIPS/eip-777\">https://eips.ethereum.org/EIPS/eip-777</a>). When this hook is executed, <code>token.balanceOf(address(this))</code> therefore still returns the old value, but <code>_storedBalances[balanceID]</code> was already decreased.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof Of Concept</h3>\n<p>Party A and Party B have a balance of 1,000,000 tokens (of some arbitrary ERC777 token) in the distributor. Let’s say for the sake of simplicity that both parties only have one user (user A in party A, user B in party B). User A (or rather his smart contract) performs the following attack:</p>\n<ul>\n<li>He calls <code>claim</code>, which transfers 1,000,000 tokens to his contract address. In <code>_transfer</code>, <code>_storedBalances[balanceId]</code> is decreased by 1,000,000 and therefore now has a value of 1,000,000.</li>\n<li>In the <code>tokensToSend</code> hook, he initiates another distribution for his party A by calling <code>PartyGovernance.distribute</code> which calls <code>TokenDistributor.createERC20Distribution</code> (we assume for the sake of simplicity that the party does not have more of these tokens, so the call transfers 0 tokens to the distributor). <code>TokenDistributor.createERC20Distribution</code> passes <code>token.balanceOf(address(this))</code> to <code>_createDistribution</code>. Note that this is still 2,000,000 because we are in the <code>tokensToSend</code> hook.</li>\n<li>The supply of this distribution is calculated as <code>(args.currentTokenBalance - _storedBalances[balanceId]) = 2,000,000 - 1,000,000 = 1,000,000</code>.</li>\n<li>When the <code>tokensToSend</code> hook is exited (and the first transfer has finished), he can retrieve the tokens of the second distribution (that was created in the hook) to steal the 1,000,000 tokens of party B.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Do not allow reentrancy in these functions.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/120#issuecomment-1254239231\">merklejerk (PartyDAO) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Very few legitimate ERC777s so we think the probability of this happening to a party is somewhat low. Also, it only impacts distributions for that token. However, we will be implementing a reentrancy guard to fix it.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/120#issuecomment-1262875715\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree that it does not seem very probable - but if 777 assets are distributed, it does appear to be a way of stealing from other users in the party and therefore High risk.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/120#issuecomment-1264678026\">0xble (PartyDAO) resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved: <a href=\"https://github.com/PartyDAO/partybidV2/pull/132\">https://github.com/PartyDAO/partybidV2/pull/132</a></p>\n</blockquote>\n<hr>\n<h2 id=\"h-05-arbitrarycallsproposalsol-and-listonopenseaproposalsol-safeguards-can-be-bypassed-by-cancelling-in-progress-proposal-allowing-the-majority-to-steal-nft\" style=\"position:relative;\"><a href=\"#h-05-arbitrarycallsproposalsol-and-listonopenseaproposalsol-safeguards-can-be-bypassed-by-cancelling-in-progress-proposal-allowing-the-majority-to-steal-nft\" aria-label=\"h 05 arbitrarycallsproposalsol and listonopenseaproposalsol safeguards can be bypassed by cancelling in progress proposal allowing the majority to steal nft permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/153\">[H-05] ArbitraryCallsProposal.sol and ListOnOpenseaProposal.sol safeguards can be bypassed by cancelling in-progress proposal allowing the majority to steal NFT</a></h2>\n<p><em>Submitted by 0x52</em></p>\n<p>Note: PartyDAO acknowledges that “canceling an InProgress proposal (mid-step) can leave the governance party in a vulnerable or undesirable state because there is no cleanup logic run during a cancel” in the “Known Issues / Topics” section of the contest readme. I still believe that this vulnerability needs to be mitigated as it can directly lead to loss of user funds.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Majority vote can abuse cancel functionality to steal an NFT owned by the party.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>ArbitraryCallsProposal.sol implements the following safeguards for arbitrary proposals that are not unanimous:</p>\n<ol>\n<li>Prevents the ownership of any NFT changing during the call. It does this by checking the the ownership of all NFTs before and after the call.</li>\n<li>Prevents calls that would change the approval status of any NFT. This is done by disallowing the “approve” and “setApprovalForAll” function selectors.</li>\n</ol>\n<p>Additionally ListOnOpenseaProposal.sol implements the following safeguards:</p>\n<ol>\n<li>NFTs are first listed for auction on Zora so that if they are listed for a very low price then the auction will keep them from being purchased at such a low price.</li>\n<li>At the end of the auction the approval is revoked when <code>\\_cleanUpListing</code> is called.</li>\n</ol>\n<p>These safeguards are ultimately ineffective though. The majority could use the following steps to steal the NFT:</p>\n<ol>\n<li>Create ListOnOpenseaProposal with high sell price and short cancel delay</li>\n<li>Vote to approve proposal with majority vote</li>\n<li>Execute first step of proposal, listing NFT on Zora auction for high price</li>\n<li>Wait for Zora auction to end since the auction price is so high that no one will buy it</li>\n<li>Execute next step, listing the NFT on Opensea. During this step the contract grants approval of the NFT to the Opensea contract</li>\n<li>Wait for cancelDelay to expire</li>\n<li>Call PartyGovernance.sol#cancel. This will immediately terminate the Opensea bypassing <code>\\_cleanUpListing</code> and keeping the approval to the Opensea contract.</li>\n<li>Create ArbitraryCallsProposal.sol that lists the NFT on Opensea for virtually nothing. Since only approval selectors have been blacklisted and the NFT does not change ownership, the proposal does not need to be unanimous to execute.</li>\n<li>Approve proposal and execute.</li>\n<li>Buy NFT.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>When a proposal is canceled, it should call a proposal specific function that makes sure everything is cleaned up. NFTs delisted, approvals revoked, etc.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/153#issuecomment-1255135044\">merklejerk (PartyDAO) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>We will block calls to <code>opensea.validate()</code> in Arbitrary call proposals.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/153#issuecomment-1262889443\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with High risk - in this scenario a majority owner could steal the asset from others in the party.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/153#issuecomment-1264688086\">0xble (PartyDAO) resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved: <a href=\"https://github.com/PartyDAO/partybidV2/pull/139\">https://github.com/PartyDAO/partybidV2/pull/139</a></p>\n</blockquote>\n<hr>\n<h2 id=\"h-06--a-majority-attack-can-steal-precious-nft-from-the-party-by-crafting-and-chaining-two-proposals\" style=\"position:relative;\"><a href=\"#h-06--a-majority-attack-can-steal-precious-nft-from-the-party-by-crafting-and-chaining-two-proposals\" aria-label=\"h 06  a majority attack can steal precious nft from the party by crafting and chaining two proposals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/277\">[H-06]  A majority attack can steal precious NFT from the party by crafting and chaining two proposals</a></h2>\n<p><em>Submitted by Trust, also found by ladboy233 and Lambda</em></p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/proposals/ProposalExecutionEngine.sol#L116\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/proposals/ProposalExecutionEngine.sol#L116</a></p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/proposals/FractionalizeProposal.sol#L54-L62\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/proposals/FractionalizeProposal.sol#L54-L62</a></p>\n<h3 id=\"description\" style=\"position:relative;\"><a href=\"#description\" aria-label=\"description permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>The PartyGovernance system has many defenses in place to protect against a majority holder stealing the NFT. Majority cannot exfiltrate the ETH gained from selling precious NFT via any proposal, and it’s impossible to sell NFT for any asset except ETH. If the party were to be compensated via an ERC20 token, majority could pass an ArbitraryCallsProposal to transfer these tokens to an attacker wallet. Unfortunately, FractionalizeProposal is vulnerable to this attack. Attackers could pass two proposals and wait for them to be ready for execution. Firstly, a FractionalizeProposal to fractionalize the NFT and mint totalVotingPower amount of ERC20 tokens of the created vault. Secondly, an ArbitraryCallsProposal to transfer the entire ERC20 token supply to an attacker address. At this point, attacker can call <code>vault.redeem()</code> to burn the outstanding token supply and receive the NFT back.</p>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>A 51% majority could steal the precious NFT from the party and leave it empty.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The only non-trivial component of this attack is that the created vault, whose tokens we wish to transfer out, has an undetermined address until <code>VAULT_FACTORY.mint()</code> is called, which creates it. The opcode which creates the vault contract is CREATE, which calculates the address with <code>keccak256(VAULT_FACTORY, nonce)</code>. Nonce will keep changing while new, unrelated NFTs are fractionalized. The attack needs to prepare both FractionalizedProposal and ArbitraryCallsProposal ahead of time, so that they could be chained immediately, meaning there would be no time for other members to call <code>distribute()</code> on the party, which would store the fractionalized tokens safely in the distributor.\nIn order to solve this chicken and the egg problem, we will use a technique taken from traditional low-level exploitation called heap feng shui.</p>\n<p>Firstly, calculate off-chain, the rate new NFTs are fractionalized, and multiple by a safety factor (like 1.2X), and multiply again by the proposal execution delay. This number, added to the current <code>VAULT_FACTORY</code> nonce, will be our <code>target_nonce</code>. Calculate <code>target_vault = keccak256(VAULT_FACTORY, target_nonce)</code>, <code>before_target_vault = keccak256(VAULT_FACTORY, target_nonce-1)</code></p>\n<p>Firstly, we will create a contract which has an attack function that:</p>\n<ol>\n<li>Loop while before<em>target</em>vault != created<em>vault:\n• Mint new dummy attacker</em>NFT\n• created<em>vault = VAULT</em>FACTORY.mint(attacker_NFT…)</li>\n<li><code>Call execute()</code> on the FractionalizedProposal  // We will feed the execute() parameters to the contract in a separate contract setter. Note that this is guaranteed to create target_vault on the correct address.</li>\n<li><code>Call execute()</code> on the ArbitraryCallsProposal</li>\n</ol>\n<p>Then, we propose the two proposals:</p>\n<ol>\n<li>Propose a FractionalizedProposal, with any list price and the precious NFT as parameter</li>\n<li>Propose an ArbitraryCallsProposal, with target = target_vault, data = transfer(ATTACKER, totalVotingPower)</li>\n</ol>\n<p>Then, we set the <code>execute()</code> parameters passed in step 2 and 3 of the attack contract using the proposalID allocated for them.</p>\n<p>Then, we wait for execution delay to finish.</p>\n<p>Finally, run the <code>attack()</code> function prepared earlier. This will increment the <code>VAULT_FACTORY</code> nonce until it is the one we count on during the ArbitraryCallsProposal. Pass enough gas to be able to burn enough nonces.</p>\n<p>At this point, attacker has all the vault tokens, so he may call vault.redeem() and receive the precious NFT.</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ol>\n<li>Enforce a minimum cooldown between proposals. This will mitigate additional weaknesses of the proposal structure. Here, this will give users the opportunity to call <code>distribute()</code> to put the vault tokens safe in distributor.</li>\n<li>A specific fix here would be to call <code>distribute()</code> at the end of FractionalizeProposal so that there is no window to steal the funds.</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/277#issuecomment-1254233443\">merklejerk (PartyDAO) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Will fix by creating an automatic distribution at the end of a successful fractionalize proposal.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/277#issuecomment-1263543589\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with High risk - this scenario allows a majority owner to steal from others in the party.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/277#issuecomment-1264677841\">0xble (PartyDAO) resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved: <a href=\"https://github.com/PartyDAO/partybidV2/pull/131\">https://github.com/PartyDAO/partybidV2/pull/131</a></p>\n</blockquote>\n<hr>\n<h2 id=\"h-07-attacker-can-dos-private-party-by-donating-eth-then-calling-buy\" style=\"position:relative;\"><a href=\"#h-07-attacker-can-dos-private-party-by-donating-eth-then-calling-buy\" aria-label=\"h 07 attacker can dos private party by donating eth then calling buy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/196\">[H-07] Attacker can DOS private party by donating ETH then calling buy</a></h2>\n<p><em>Submitted by 0x52</em></p>\n<p>Party is DOS’d and may potentially lose access to NFT.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L280-L298\">Crowdfund.sol#L280-L298</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">party = party_ = partyFactory</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    .createParty(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Party.PartyOptions({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            name: name,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            symbol: symbol,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            governance: PartyGovernance.GovernanceOpts({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                hosts: governanceOpts.hosts,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                voteDuration: governanceOpts.voteDuration,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                executionDelay: governanceOpts.executionDelay,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                passThresholdBps: governanceOpts.passThresholdBps,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                totalVotingPower: _getFinalPrice().safeCastUint256ToUint96(),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                feeBps: governanceOpts.feeBps,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                feeRecipient: governanceOpts.feeRecipient</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            })</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        preciousTokens,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        preciousTokenIds</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span></code></pre>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/BuyCrowdfundBase.sol#L166-L173\">BuyCrowdfundBase.sol#L166-L173</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _getFinalPrice()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    internal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    override</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    view</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    returns (uint256)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return settledPrice;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>When BuyCrowdFund.sol successfully completes a buy, totalVotingPower is set to <code>\\_getFinalPrice</code> which in the case of BuyCrowdFundBase.sol returns the price at which the NFT was purchased. totalVotingPower is used by the governance contract to determine the number of votes needed for a proposal to pass. If there are not enough claimable votes to meet that threshold then the party is softlocked because it can’t pass any proposals. An attacker could exploit this to DOS even a private party with the following steps:</p>\n<ol>\n<li>Wait for party to be filled to just under quorum threshold</li>\n<li>Donate ETH to the crowdfund contract</li>\n<li>Call BuyCrowdFund.sol#buy. Since it is unpermissioned even for parties with a gatekeeper, the call won’t revert</li>\n</ol>\n<p>Since the voting power for the final amount of ETH cannot be claimed, the party is now softlocked. If emergencyExecuteDisabled is true then the party will be permanantly locked and the NFT would effectively be burned. If emergencyExecuteDisabled is false then users would have to wait for PartyDAO to reclaim the NFT.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Permission to call BuyCrowdFund.sol#buy should be gated if there is a gatekeeper.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/196#issuecomment-1255178995\">merklejerk (PartyDAO) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Theoretically possible but there doesn’t seem to be much upside for the attacker. We do think it’s unusual that buy()/bid() can be called by a non-member for a private/gatekept party, so we will add gatekeeping logic there to fix this. We will also cap the callValue (and therefore final price) to <code>totalContributions</code>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/196#issuecomment-1264679039\">0xble (PartyDAO) resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved: <a href=\"https://github.com/PartyDAO/partybidV2/pull/133\">https://github.com/PartyDAO/partybidV2/pull/133</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/196#issuecomment-1266670432\">HardlyDifficult (judge) increased severity to High and commented</a>:</strong></p>\n<blockquote>\n<p>Although it’s without upside, it is a path for the attacker to potentially lock the NFT. Since it can cause a loss of asset for users, this seems to be a High risk issue.</p>\n<p>Let me know if I misunderstood.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/196#issuecomment-1267180017\">merklejerk (PartyDAO) commented</a>:</strong></p>\n<blockquote>\n<p>~Don’t consider it high because there is a much more straightforward way to softlock a party: contribute normally and don’t ever participate in governance.~ Oh nvm, this is the private party one. Yeah I’m fine with high.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-12\" style=\"position:relative;\"><a href=\"#medium-risk-findings-12\" aria-label=\"medium risk findings 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (12)</h1>\n<h2 id=\"m-01-attacker-can-list-an-nft-they-own-and-inflate-to-zero-all-users-contributions-keeping-the-nft-and-all-the-money\" style=\"position:relative;\"><a href=\"#m-01-attacker-can-list-an-nft-they-own-and-inflate-to-zero-all-users-contributions-keeping-the-nft-and-all-the-money\" aria-label=\"m 01 attacker can list an nft they own and inflate to zero all users contributions keeping the nft and all the money permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/213\">[M-01] Attacker can list an NFT they own and inflate to zero all users’ contributions, keeping the NFT and all the money</a></h2>\n<p><em>Submitted by Trust, also found by smiling\\</em>heretic_</p>\n<p>Crowdfunds split the voting power and distribution of profits rights according to the percentage used to purchase the NFT. When an attacker lists his own NFT for sale and contributes to it, any sum he contributes will return to him once the sell is executed. This behavior is fine so long as the sell price is fair, as other contributors will receive a fair portion of voting power and equity.  Therefore, when a maximum price is defined, it is not considered a vulnerability that an attacker can contribute <code>maximumPrice - totalContributions</code> and take a potentially large stake of the Crowdfund, as user’s have contributed knowing the potential maximum price.</p>\n<p>However, when maximum price is zero, which is allowed in BuyCrowdfund and CollectionBuyCrowdfund, the lister of the NFT can always steal the entirety of the fund and keep the NFT. Attacker can send a massive contribution, buy the NFT and pass a unanimous proposal to approve the NFT to his wallet. Attacker can use a flash loan to finance the initial contribution, which is easily paid back from the NFT lister wallet.</p>\n<p>It is important to note that there is no way for the system to know if the Crowdfund creator and the NFT owner are the same entity, and therefore it is critical for the platform to defend users against this scenario.</p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Any crowdfund with zero maximumPrice configured is subject to NFT lister rug pull and complete takeover of the contribution funds.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>\n<p>Suppose totalContributions=X. Attacker will prepare flashloan callback which does:</p>\n<ul>\n<li><code>contribute()</code> with the borrowed funds</li>\n<li>call BuyCrowdfund’s <code>buy()</code> with a contract that will purchase the NFT using the large sum</li>\n<li>call NFT lister contract’s sendProfit() function which will send attacker the NFT sell amount</li>\n<li>pay back the flash loan</li>\n</ul>\n</li>\n<li>Attacker will call flashloan(10,000X) to buy his own NFT and take unanimous holding of created party</li>\n<li>Attacker will create ArbitraryCallsProposal with a single call to token.approve(ATTACKER, token_id). It is immediately ready for execution because attacker has > 99.99% of votes. Precious approve() is allowed in unanimous proposals.</li>\n<li>Attacker calls NFT’s <code>transferFrom()</code> to take back control of the NFT, leaving with the Crowdfund’s contribution and the listed NFT.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Disable the option to have unlimited maximumPrice for BuyCrowdfund and CollectionBuyCrowdfund contracts. AuctionCrowdfund is already safe by not allowing a zero maximumBid.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/213#issuecomment-1254016870\">merklejerk (PartyDAO) commented</a>:</strong></p>\n<blockquote>\n<p>Duplicate of <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/17\">#17</a> </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/213#issuecomment-1272553754\">HardlyDifficult (judge) decreased severity to QA and commented</a>:</strong></p>\n<blockquote>\n<p>See dupe for context. Merging with <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/198\">#198</a>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/213#issuecomment-1274201301\">Trust (warden) commented</a>:</strong></p>\n<blockquote>\n<p>TBH I don’t see enough resemblance to #17 for it to be dupped. This submission discusses specifically maximumPrice = 0 which allows attacker to always claim the entire contribution pool to themselves. Would appreciate a second look.\n@HardlyDifficult\ndisclaimer - this is my submission.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/213#issuecomment-1274662744\">HardlyDifficult (judge) increased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Yes that is fair. This seems to fall under the known issue “It is possible that someone could manipulate parties by contributing ETH and then buying their NFT that they own.” - although an extreme example and a unique take on that scenario. However given the apparent ease and impact of this attack it seems we can bump this to Medium risk - would be high if not for the general known issue here.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/213#issuecomment-1275265841\">smiling_heretic (warden) commented</a>:</strong></p>\n<blockquote>\n<p>The same is true for <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/206\">206</a> (disclaimer: it’s my submission) so I think it should be marked as duplicate of this finding and also upgraded to medium. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/213#issuecomment-1275269089\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree, thanks @SmilingHeretic.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-previously-nominated-delegate-can-reset-the-delegation\" style=\"position:relative;\"><a href=\"#m-02-previously-nominated-delegate-can-reset-the-delegation\" aria-label=\"m 02 previously nominated delegate can reset the delegation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/361\">[M-02] Previously nominated delegate can reset the delegation</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p><code>burn()</code> allows for previously recorded delegate to set himself to be contributor’s delegate even if another one was already chosen.</p>\n<p>This can be quite material as owner choice for the whole voting power is being reset this way to favor the old delegate.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>\\_burn()</code> can be invoked by anyone on the behalf of any <code>contributor</code>:</p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L167-L171\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L167-L171</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contributor</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contributor</span><span class=\"mtk1\">, </span><span class=\"mtk11\">getCrowdfundLifecycle</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">party</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>It mints the governance NFT for the contributor whenever he has voting power:</p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L471-L485\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L471-L485</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Get the address to delegate voting power to. If null, delegate to self.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegationsByContributor</span><span class=\"mtk1\">[</span><span class=\"mtk12\">contributor</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">delegate</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// Delegate can be unset for the split recipient if they never</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// contribute. Self-delegate if this occurs.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">contributor</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Mint governance NFT for the contributor.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">party_</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">contributor</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">delegate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>Now <code>mint()</code> calls <code>\\_adjustVotingPower()</code> with a new delegate, redirecting all the intristic power, not just one for that id, ignoring the delegation the <code>owner</code> might already have:</p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernanceNFT.sol#L120-L133\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernanceNFT.sol#L120-L133</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlyMinter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlyDelegateCall</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\"> = ++</span><span class=\"mtk12\">tokenCount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">votingPowerByTokenId</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_adjustVotingPower</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeCastUint256ToInt192</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>I.e. Bob the contributor can take part in the crowdfunding with <code>contribute()</code> with small <code>0.01 ETH</code> stake, stating Mike as the delegate of his choice with <code>contribute(Mike, ...)</code>:</p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L189-L208\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L189-L208</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param delegate The address to delegate to for the governance phase.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param gateData Data to pass to the gatekeeper to prove eligibility.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">contribute</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">gateData</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">payable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_contribute</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeCastUint256ToUint96</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// We cannot use `address(this).balance - msg.value` as the previous</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// total contributions in case someone forces (suicides) ETH into this</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// contract. This wouldn&#39;t be such a big deal for open crowdfunds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// but private ones (protected by a gatekeeper) could be griefed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// because it would ultimately result in governance power that</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// is unattributed/unclaimable, meaning that party will never be</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// able to reach 100% consensus.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">totalContributions</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">gateData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span></code></pre>\n<p>Then crowdfund was a success, party was created, and Melany, who also participated, per off-chain arrangement has transferred to Bob a <code>tokenId</code> with big voting power (say it is <code>100 ETH</code> and the majority of voting power):</p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernanceNFT.sol#L146-L155\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernanceNFT.sol#L146-L155</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @inheritdoc ERC721</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlyDelegateCall</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Transfer voting along with token.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_transferVotingPower</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">votingPowerByTokenId</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">super</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernance.sol#L879-L887\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernance.sol#L879-L887</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Transfers some voting power of `from` to `to`. The total voting power of</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// their respective delegates will be updated as well.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transferVotingPower</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">power</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">int192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">powerI192</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">power</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeCastUint256ToInt192</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_adjustVotingPower</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, -</span><span class=\"mtk12\">powerI192</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_adjustVotingPower</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">powerI192</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Bob don’t care about his early small contribution and focuses on managing the one that Melany transferred instead as he simply doesn’t need the voting power from the initial <code>0.01 ETH</code> contribution anymore.</p>\n<p>The actual delegate for Bob at the moment is Linda, while his business with Mike is over. So Bob sets her address there, calling <code>delegateVotingPower(Linda)</code>:</p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernance.sol#L448-L454\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernance.sol#L448-L454</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @notice Pledge your intrinsic voting power to a new delegate, removing it from</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">///         the old one (if any).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param delegate The address to delegating voting power to.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">delegateVotingPower</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyDelegateCall</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_adjustVotingPower</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">VotingPowerDelegated</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Now, Mike can unilaterally delegate to himself the whole voting power with <code>burn(Bob)</code> as mint() just resets the delegation with the previously recorded value with <code>_adjustVotingPower(owner, votingPower.safeCastUint256ToInt192(), delegate)</code>.</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The issue is that <code>mint()</code> always assumes that it is the first operation for the <code>owner</code>, which might not always be the case.</p>\n<p>Consider not changing the delegate on <code>mint</code> if one is set already:</p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernanceNFT.sol#L120-L133\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernanceNFT.sol#L120-L133</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlyMinter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlyDelegateCall</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\"> = ++</span><span class=\"mtk12\">tokenCount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">votingPowerByTokenId</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+       </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">actualDelegate</span><span class=\"mtk1\"> = </span><span class=\"mtk17\">&lt;</span><span class=\"mtk10\">get_current_delegate</span><span class=\"mtk17\">&gt;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+       if (actualDelegate == address(0)) actualDelegate = delegate;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-       _adjustVotingPower(owner, votingPower.safeCastUint256ToInt192(), delegate);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+       _adjustVotingPower(owner, votingPower.safeCastUint256ToInt192(), actualDelegate);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        _mint(owner, tokenId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>More complicated version might be the one with tracking the most recent request via <code>contribute()/delegateVotingPower()</code> calls timestamps. Here we assume that the <code>delegateVotingPower()</code> holds more information as in the majority of practical cases it occurs after initial <code>contribute()</code> and it is a direct voluntary call from the owner.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/361#issuecomment-1255353936\">merklejerk (PartyDAO) confirmed, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Unusual and interesting, but we think this should be Medium risk since the setup is somewhat exotic and still not a guarantee that assets would be at risk. We will implement the fix suggested.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/361#issuecomment-1262817269\">HardlyDifficult (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Agree with downgrading to Medium risk. This scenario can result in redirecting voting power to the wrong account, but is a nuanced scenario that would be difficult to target as an attack.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/361#issuecomment-1264679379\">0xble (PartyDAO) resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved: <a href=\"https://github.com/PartyDAO/partybidV2/pull/134\">https://github.com/PartyDAO/partybidV2/pull/134</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-only-part-of-keccak256-is-used-as-hash-making-it-susceptible-to-collision-attacks\" style=\"position:relative;\"><a href=\"#m-03-only-part-of-keccak256-is-used-as-hash-making-it-susceptible-to-collision-attacks\" aria-label=\"m 03 only part of keccak256 is used as hash making it susceptible to collision attacks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/231\">[M-03] Only part of <code>keccak256()</code> is used as hash, making it susceptible to collision attacks</a></h2>\n<p><em>Submitted by 0xA5DF, also found by Lambda and V\\</em>B_</p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L275\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L275</a></p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L325\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L325</a></p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/distribution/TokenDistributor.sol#L26\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/distribution/TokenDistributor.sol#L26</a></p>\n<h3 id=\"vulnerability-details\" style=\"position:relative;\"><a href=\"#vulnerability-details\" aria-label=\"vulnerability details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability Details</h3>\n<p>At 2 places in the code only part of the output of <code>keccak256()</code> is used as the hash:</p>\n<ul>\n<li>\n<p>At <code>TokenDistributor</code> - <code>DistributionState.distributionHash15</code> - uses only a 15 bytes as a hash</p>\n<ul>\n<li>This one is intended to save storage</li>\n</ul>\n</li>\n<li>\n<p>At <code>Crowdfund.governanceOptsHash</code> a 16 bytes is used as hash</p>\n<ul>\n<li>This one has no benefit at all as it doesn’t save on storage</li>\n</ul>\n</li>\n</ul>\n<p>15/16 bytes hash is already not very high to begin with (as explained below). On top of that, using a non standard hash can be unsafe. Since diverging from the standard can break things.</p>\n<h3 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>For the <code>FixedGovernanceOpts</code> an attacker can create a legitimate party, and then when running <code>buy()</code> use the malicious hash to:</p>\n<ul>\n<li>include himself in the hosts (DoS-ing the party by vetoing every vote)</li>\n<li>reduce the <code>passThresholdBps</code> (allowing him to pass any vote, including sending funds from the Party)</li>\n<li>Setting himself as <code>feeRecipient</code> and increasing the fee</li>\n</ul>\n<p>For the <code>DistributionInfo</code> struct - an attacker can easily drain all funds from the token distribution contract, by using the legitimate hash to create a distribution with a malicious ERC20 token (and a malicious party contract), and then using the malicious hash to claim assets of a legitimate token.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<h4 id=\"the-attack\" style=\"position:relative;\"><a href=\"#the-attack\" aria-label=\"the attack permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The attack</h4>\n<p>Using the birthday attack, for a 50% chance with a 15 bytes hash, the number of hashes needed to generate is 1.4e18 (<code>(ln(1/0.5) *2) ** 0.5 * (2 ** 60)</code>).</p>\n<ul>\n<li>For 16 bytes that would be 2.2e19</li>\n</ul>\n<p>An attacker can create 2 different structs, a legitimate and a malicious one, while modifying at each iteration only the last bits</p>\n<ul>\n<li>For the <code>FixedGovernanceOpts</code> the last bits would be the <code>feeRecipient</code> field</li>\n<li>For the <code>DistributionInfo</code> struct that would be the <code>fee</code> field (and then exploit it via the <code>claim()</code> function which doesn’t validate the <code>fee</code> field)</li>\n</ul>\n<p>The attacker will than generate half of the hashes from the malicious one, and half from the legitimate ones, so in case of a collision there’s a 50% chance it’d be between the legitimate and malicious struct.</p>\n<h4 id=\"cpu\" style=\"position:relative;\"><a href=\"#cpu\" aria-label=\"cpu permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CPU</h4>\n<ul>\n<li>In the <code>DistributionInfo</code> we have 224 bytes (and for <code>FixedGovernanceOpts</code> 192 bytes if we precalculate the hosts hash)</li>\n<li>A computer needs about 11 cycles per byte</li>\n<li>An avg home PC can do ~3e9 cycles per seconds</li>\n<li>There are ~8.6e4 seconds a day</li>\n<li>Putting it all together <code>1.4e18 * 11 * 224 / (3e9*8.6e4)</code> = ~1.3e8</li>\n<li>Note that we can further optimize it (by 10 times at least), since we’re using the same input and only modifying the last bits every time (the <code>fee</code> field)</li>\n</ul>\n<h4 id=\"storage\" style=\"position:relative;\"><a href=\"#storage\" aria-label=\"storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Storage</h4>\n<p>32 * 1.4e18 = ~4.5e19 bytes is needed, while an affordable drive can be 8TB=~8e12 bytes.\nThat puts it about 5e6 times away from and affordable attack.</p>\n<h4 id=\"overall-risk\" style=\"position:relative;\"><a href=\"#overall-risk\" aria-label=\"overall risk permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overall Risk</h4>\n<p>The calculations above are for basic equipment, an attacker can be spending more on equipment to get closer (I’d say you can easily multiply that by 100 for a medium size attacker + running the computations for more than one day).\nCombining that with the fact that a non-standard hash is used, and that in general hashes can have small vulnerabilities that lower a bit their strength - I’d argue it’s not very safe to be ~1e4 (for a medium size attacker; ~1.5e5 for 16 bytes) away from a practical attack.</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use the standard, 32-bytes, output of <code>keccak256()</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/231#issuecomment-1255266728\">merklejerk (PartyDAO) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>At first we dismissed this as being really impractical but the more we thought of what an attack would actually look like, the more practical (if still improbable) it would be. We will extend both hashes to full-width (32 bytes).</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/231#issuecomment-1262839129\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with Medium risk. This attack seems unlikely but may be within the realm of possible when high value is at stake.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/231#issuecomment-1264680753\">0xble (PartyDAO) resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved: <a href=\"https://github.com/PartyDAO/partybidV2/pull/138\">https://github.com/PartyDAO/partybidV2/pull/138</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-nft-owner-can-stuck-crowdfund-user-funds\" style=\"position:relative;\"><a href=\"#m-04-nft-owner-can-stuck-crowdfund-user-funds\" aria-label=\"m 04 nft owner can stuck crowdfund user funds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/197\">[M-04] NFT Owner can stuck Crowdfund user funds</a></h2>\n<p><em>Submitted by csanuragjain</em></p>\n<p>Consider a scenario where few users contributed in auction but no one has placed any bid due to reason like NFT price crash etc. So there was 0 bid, the NFT owner could seize the crowdfund users fund until they pay a ransom amount as shown below.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>NFT N auction is going on</li>\n<li>CrowdFund users have contributed 100 amount for this auction</li>\n<li>Bidding has not been done yet</li>\n<li>A news came for this NFT owner which leads to crashing of this NFT price</li>\n<li>CrowdFund users are happy that they have not bided and are just waiting for auction to complete so that they can get there refund</li>\n<li>NFT owner realizing this blackmails the CrowdFund users to send him amount 50 or else he would send this worthless NFT to the Crowdfund Auction contract basically stucking all crowdfund users fund. CrowdFund users ignore this and simply wait for auction to end</li>\n<li>Once auction completes <a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/crowdfund/AuctionCrowdfund.sol#L196\">finalize function</a> is called</li>\n</ol>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function finalize(FixedGovernanceOpts memory governanceOpts)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        onlyDelegateCall</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        returns (Party party_)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> if (nftContract.safeOwnerOf(nftTokenId) == address(this)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (lastBid_ == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                // The NFT was gifted to us. Everyone who contributed wins.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                lastBid_ = totalContributions;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                if (lastBid_ == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    // Nobody ever contributed. The NFT is effectively burned.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    revert NoContributionsError();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                lastBid = lastBid_;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Create a governance party around the NFT.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            party_ = _createParty(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                _getPartyFactory(),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                governanceOpts,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                nftContract,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                nftTokenId</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            emit Won(lastBid_, party_);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<ol start=\"8\">\n<li>Before calling finalize the lastBid was 0 since no one has bid on this auction but lets see what happens on calling finalize</li>\n<li>Since NFT owner has transferred NFT to this contract so below statement holds true and <code>lastBid\\_</code> is also 0 since no one has bidded</li>\n</ol>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (lastBid_ == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                lastBid_ = totalContributions;</span></span></code></pre>\n<ol start=\"10\">\n<li>This means now <code>lastBid\\_</code> is changed to totalContributions which is 100 so crowdfund users funds will not be refunded and they will end up with non needed NFT.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Remove the line <code>lastBid\\_ = totalContributions;</code> and let it be the last bid amount which crowdfund users actually bided with.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/197#issuecomment-1254404973\">merklejerk (PartyDAO) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>This is working as designed. Contributors to a crowdfund essentially enter an agreement to pay up to a maximum price of their combined contributions for an NFT.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/197#issuecomment-1257223437\">csanuragjain (warden) commented</a>:</strong></p>\n<blockquote>\n<p>@merklejerk But in this case it is not “up to a maximum price” but rather always the maximum price using the PoC.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/197#issuecomment-1257279270\">merklejerk (PartyDAO) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Hmm. I reread the PoC and now I’m converting this to confirmed. The real issue here is not so much that the party is paying maximum price, but that the party did not ever bid on the item but also paid maximum price. :facepalm: </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/197#issuecomment-1257281234\">merklejerk (PartyDAO) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Still disagree with severity since this is unlikely to happen with a legitimate collection. It should be Medium at most.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/197#issuecomment-1263529444\">HardlyDifficult (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Agree with Medium risk here. This could be a violation of party user expectations since auctions generally target the min possible bid - a form of leaking value.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/197#issuecomment-1264679164\">0xble (PartyDAO) resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved: <a href=\"https://github.com/PartyDAO/partybidV2/pull/133\">https://github.com/PartyDAO/partybidV2/pull/133</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-the-settledprice-maybe-exceed-maximumprice\" style=\"position:relative;\"><a href=\"#m-05-the-settledprice-maybe-exceed-maximumprice\" aria-label=\"m 05 the settledprice maybe exceed maximumprice permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/201\">[M-05] The settledPrice maybe exceed maximumPrice</a></h2>\n<p><em>Submitted by bin2chen</em></p>\n<p><code>BuyCrowdfundBase.sol \\_buy()</code>\nWhen callValue = 0 is settledPrice to totalContributions ignoring whether totalContributions > maximumPrice\nresulting in the minimum proportion of participants expected to become smaller</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _buy(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC721 token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 tokenId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address payable callTarget,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint96 callValue,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes calldata callData,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        FixedGovernanceOpts memory governanceOpts</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            settledPrice_ = callValue == 0 ? totalContributions : callValue;  //**** not check totalContributions&gt;maximumPrice****//</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (settledPrice_ == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                // Still zero, which means no contributions.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                revert NoContributionsError();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            settledPrice = settledPrice_;    </span></span></code></pre>\n<p>(AuctionCrowdfund.sol finalize()  similar)</p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>add check</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _buy(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC721 token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 tokenId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address payable callTarget,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint96 callValue,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes calldata callData,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        FixedGovernanceOpts memory governanceOpts</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            settledPrice_ = callValue == 0 ? totalContributions : callValue;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (settledPrice_ == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                // Still zero, which means no contributions.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                revert NoContributionsError();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++         if (maximumPrice_ != 0 &amp;&amp; settledPrice_ &gt; maximumPrice_) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++                settledPrice_ = maximumPrice_;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            settledPrice = settledPrice_;    </span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/201#issuecomment-1255183114\">merklejerk (PartyDAO) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>We will cap the callValue to maximumPrice.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/201#issuecomment-1264678963\">0xble (PartyDAO) resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved: <a href=\"https://github.com/PartyDAO/partybidV2/pull/133\">https://github.com/PartyDAO/partybidV2/pull/133</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/201#issuecomment-1266706257\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This is a potential violation of user expectations - agree with Medium risk.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-auctioncrowdfund-if-the-contract-was-bid-on-before-the-nft-was-gifted-to-the-contract-lastbid-will-not-be-totalcontributions\" style=\"position:relative;\"><a href=\"#m-06-auctioncrowdfund-if-the-contract-was-bid-on-before-the-nft-was-gifted-to-the-contract-lastbid-will-not-be-totalcontributions\" aria-label=\"m 06 auctioncrowdfund if the contract was bid on before the nft was gifted to the contract lastbid will not be totalcontributions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/147\">[M-06] AuctionCrowdfund: If the contract was bid on before the NFT was gifted to the contract, lastBid will not be totalContributions</a></h2>\n<p><em>Submitted by cccz</em></p>\n<p>In the finalize function of the AuctionCrowdfund contract, when the contract gets NFT and lastBid_ == 0, it is considered that NFT is gifted to the contract and everyone who contributed wins.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (nftContract.safeOwnerOf(nftTokenId) == address(this)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (lastBid_ == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                // The NFT was gifted to us. Everyone who contributed wins.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                lastBid_ = totalContributions;</span></span></code></pre>\n<p>But if the contract was bid before the NFT was gifted to the contract, then since lastBid_ ! = 0, only the user who contributed at the beginning will win.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/AuctionCrowdfund.sol#L233-L242\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/AuctionCrowdfund.sol#L233-L242</a></p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/AuctionCrowdfund.sol#L149-L175\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/AuctionCrowdfund.sol#L149-L175</a></p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Whether or not NFT is free to get should be determined using whether the contract balance is greater than totalContributions.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/147#issuecomment-1254403120\">merklejerk (PartyDAO) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Gifted NFTs are expected to be an extremely exceptional (if ever) case, but we do want to make a best effort to make these situations somewhat fair to contributors.  We will implement the recommendation and check that <code>this.balance >= totalContributions</code> to see if the NFT was acquired for free.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/147#issuecomment-1264678161\">0xble (PartyDAO) resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved: <a href=\"https://github.com/PartyDAO/partybidV2/pull/133\">https://github.com/PartyDAO/partybidV2/pull/133</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/147#issuecomment-1267170378\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This could be seen as a form of leaking value, agree with Medium risk.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-attacker-can-force-auctioncrowdfunds-to-bid-their-entire-contribution-up-to-maxbid\" style=\"position:relative;\"><a href=\"#m-07-attacker-can-force-auctioncrowdfunds-to-bid-their-entire-contribution-up-to-maxbid\" aria-label=\"m 07 attacker can force auctioncrowdfunds to bid their entire contribution up to maxbid permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/220\">[M-07] Attacker can force AuctionCrowdfunds to bid their entire contribution up to maxBid</a></h2>\n<p><em>Submitted by Trust, also found by cccz</em></p>\n<p>AuctionCrowdfund’s <code>bid()</code> allows any user to compete on an auction on the party’s behalf. The code in <code>bid()</code> forbids placing a bid if party is already winning the auction:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (market.getCurrentHighestBidder(auctionId_) == address(this)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            revert AlreadyHighestBidderError();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p>However, it does not account for attackers placing bids from their own wallet, and then immediately overbidding them using the party’s funds. This can be used in two ways:</p>\n<ol>\n<li>Attacker which lists an NFT, can force the party to spend all its funds up to maxBid on the auction, even if the party could have purchased the NFT for much less.</li>\n<li>Attackers can grief random auctions, making them pay the absolute maximum for the item. Attackers can use this to drive the prices of NFT items up, profiting from this using secondary markets.</li>\n</ol>\n<h3 id=\"impact-6\" style=\"position:relative;\"><a href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Parties can be stopped from buying items at a good value without any risk to the attacker.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Attacker places an NFT for sale, valued at X</li>\n<li>Attacker creates an AuctionCrowdfund, with maxBid = Y such that Y = 2X</li>\n<li>Current bid for the NFT is X - AUCTION_STEP</li>\n<li>Users contribute to the fund, which now has 1.5X</li>\n<li>Users call <code>bid()</code> to bid X  for the NFT</li>\n<li>Attacker bids for the item externally for 1.5X - AUCTION_STEP</li>\n<li>Attacker calls <code>bid()</code> to bid 1.5X for the NFT</li>\n<li>Attacker sells his NFT for 1.5X although no one apart from the party was interested in buying it above price X</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Introduce a new option variable to AuctionCrowdfunds called speedBump. Inside the <code>bid()</code> function, calculate seconds since last bid, multiplied by the price change factor. This product must be smaller than the chosen speedBump. Using this scheme, the protocol would have resistance to sudden bid spikes. Optionally, allow a majority funder to override the speed bump.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/220#issuecomment-1254406481\">merklejerk (PartyDAO) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>This is a known limitation of crowdfunds. We will allow some parties to restrict who can call <code>buy()</code> or <code>bid()</code> to hosts, which will mitigate this.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/220#issuecomment-1267209362\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This is a fair concern, a form of potentially leaking value so agree with Medium risk. Not sure I agree with the recommendation here, but restricting to hosts does help mitigate by putting risk on the attacker.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/220#issuecomment-1276604774\">0xble (PartyDAO) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>Mitigated by: <a href=\"https://github.com/PartyDAO/partybidV2/pull/140\">https://github.com/PartyDAO/partybidV2/pull/140</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-early-contributor-can-always-become-majority-of-crowdfund-leading-to-rugging-risks\" style=\"position:relative;\"><a href=\"#m-08-early-contributor-can-always-become-majority-of-crowdfund-leading-to-rugging-risks\" aria-label=\"m 08 early contributor can always become majority of crowdfund leading to rugging risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/284\">[M-08] Early contributor can always become majority of crowdfund leading to rugging risks.</a></h2>\n<p><em>Submitted by Trust, also found by cccz and rvierdiiev</em></p>\n<p>Voting power is distributed to crowdfund contributors according to the amount contributed divided by NFT purchase price. Attacker can call the <code>buy()</code> function of BuyCrowdfund / CollectionBuyCrowdfund, and use only the first X amount of contribution from the crowdfund, such that attacker’s contribution > X/2. He will pass his contract to the buy call, which will receive X and will need to add some additional funds, to purchase the NFT. If the purchase is successful, attacker will have majority rule in the created party. If the party does not do anything malicious, this is a losing move for attacker, because the funds they added on top of X to compensate for the NFT price will eventually be split between group members. However, with majority rule there are various different exploitation vectors attacker may use to steal the NFT from the party ( detailed in separate reports). Because it is accepted that single actor majority is dangerous, but without additional vulnerabilities attacker cannot take ownership of the party’s assets, I classify this as a Medium. The point is that users were not aware they could become minority under this attack flow.</p>\n<h3 id=\"impact-7\" style=\"position:relative;\"><a href=\"#impact-7\" aria-label=\"impact 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Early contributor can always become majority of crowdfund leading to rugging risks.</p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Victim A opens BuyCrowdfund and deposits 20 ETH</li>\n<li>Attacker deposits 30 ETH</li>\n<li>Victim B deposits 50 ETH</li>\n<li>Suppose NFT costs 100 ETH</li>\n<li>Attacker will call <code>buy()</code>, requesting 59ETH buy price. His contract will add 41 additional ETH and buy the NFT.</li>\n<li>Voting power distributed will be: 20 / 59 for Victim A, 30 / 59 for Attacker, 9 / 59 for Victim B. Attacker has majority.</li>\n<li>User can use some majority attack to take control of the NFT, netting 100 (NFT value) - 41 (external contribution) - 30 (own contribution) = 29 ETH</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a Crowdfund property called minimumPrice, which will be visible to all. <code>Buy()</code> function should not accept NFT price &#x3C; minimumPrice. Users now have assurances that are not susceptible to majority rule if they deposited enough ETH below the minimumPrice.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/284#issuecomment-1256420138\">merklejerk (PartyDAO) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>We want to avoid requiring a minimum price for now as it’s difficult to choose a value that would allow a crowdfund to respond to price drops as well as price increases. Instead we’re opting to harden defenses against majority attacks, which would minimize the desirability of this vector, and we’re introducing optional host-only and gatekeeper restrictions on <code>buy()/bid()</code> functions. We will keep an eye out for this behavior and reassess if it comes up.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/284#issuecomment-1268507970\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Gifting can lead to incorrect voting power distribution. Agree with Medium risk.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/284#issuecomment-1276602578\">0xble (PartyDAO) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>Mitigated by: <a href=\"https://github.com/PartyDAO/partybidV2/pull/140\">https://github.com/PartyDAO/partybidV2/pull/140</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-calling-transfereth-function-can-revert-if-receiver-input-corresponds-to-a-contract-that-is-unable-to-receive-eth-through-its-receive-or-fallback-function\" style=\"position:relative;\"><a href=\"#m-09-calling-transfereth-function-can-revert-if-receiver-input-corresponds-to-a-contract-that-is-unable-to-receive-eth-through-its-receive-or-fallback-function\" aria-label=\"m 09 calling transfereth function can revert if receiver input corresponds to a contract that is unable to receive eth through its receive or fallback function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/212\">[M-09] Calling <code>transferEth</code> function can revert if <code>receiver</code> input corresponds to a contract that is unable to receive ETH through its <code>receive</code> or <code>fallback</code> function</a></h2>\n<p><em>Submitted by rbserver, also found by CertoraInc, Jeiwan, and tonisives</em></p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/utils/LibAddress.sol#L8-L15\">https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/utils/LibAddress.sol#L8-L15</a></p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/crowdfund/Crowdfund.sol#L444-L489\">https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/crowdfund/Crowdfund.sol#L444-L489</a></p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/distribution/TokenDistributor.sol#L371-L388\">https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/distribution/TokenDistributor.sol#L371-L388</a></p>\n<h3 id=\"impact-8\" style=\"position:relative;\"><a href=\"#impact-8\" aria-label=\"impact 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The following <code>transferEth</code> function is called when calling the <code>_burn</code> or <code>_transfer</code> function below. If the <code>receiver</code> input for the <code>transferEth</code> function corresponds to a contract, it is possible that the receiver contract does not, intentionally or unintentionally, implement the <code>receive</code> or <code>fallback</code> function in a way that supports receiving ETH or that calling the receiver contract’s <code>receive</code> or <code>fallback</code> function executes complicated logics that cost much gas, which could cause calling <code>transferEth</code> to revert. For example, when calling <code>transferEth</code> reverts, calling <code>_burn</code> also reverts; this means that the receiver contract would not be able to get the voting power and receive the extra contribution it made after the crowdfunding finishes; yet, the receiver contract deserves these voting power and contribution refund. Hence, the receiver contract loses valuables that it deserves, which is unfair to the users who controls it.</p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/utils/LibAddress.sol#L8-L15\">https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/utils/LibAddress.sol#L8-L15</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferEth</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">s</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">r</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">.</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">s</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">EthTransferFailed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">r</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/crowdfund/Crowdfund.sol#L444-L489\">https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/crowdfund/Crowdfund.sol#L444-L489</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contributor</span><span class=\"mtk1\">, </span><span class=\"mtk12\">CrowdfundLifecycle</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lc</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Party</span><span class=\"mtk1\"> </span><span class=\"mtk12\">party_</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// If the CF has won, a party must have been created prior.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">lc</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">CrowdfundLifecycle</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Won</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">party_</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">Party</span><span class=\"mtk1\">(</span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">))) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NoPartyError</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">lc</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">CrowdfundLifecycle</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Lost</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Otherwise it must have lost.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">WrongLifecycleError</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lc</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Split recipient can burn even if they don&#39;t have a token.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">contributor</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">splitRecipient</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_splitRecipientHasBurned</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SplitRecipientAlreadyBurnedError</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_splitRecipientHasBurned</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Revert if already burned or does not exist.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">splitRecipient</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">contributor</span><span class=\"mtk1\"> || </span><span class=\"mtk11\">_doesTokenExistFor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contributor</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">CrowdfundNFT</span><span class=\"mtk1\">.</span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contributor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Compute the contributions used and owed to the contributor, along</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// with the voting power they&#39;ll have in the governance stage.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethUsed</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethOwed</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">) =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_getFinalContribution</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contributor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Get the address to delegate voting power to. If null, delegate to self.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegationsByContributor</span><span class=\"mtk1\">[</span><span class=\"mtk12\">contributor</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">delegate</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// Delegate can be unset for the split recipient if they never</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// contribute. Self-delegate if this occurs.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">contributor</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Mint governance NFT for the contributor.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">party_</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">contributor</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">delegate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Refund any ETH owed back to the contributor.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">contributor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferEth</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ethOwed</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Burned</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contributor</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ethUsed</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ethOwed</span><span class=\"mtk1\">, </span><span class=\"mtk12\">votingPower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/distribution/TokenDistributor.sol#L371-L388\">https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/distribution/TokenDistributor.sol#L371-L388</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">TokenType</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenType</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceId</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getBalanceId</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Reduce stored token balance.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_storedBalances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">balanceId</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">tokenType</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">TokenType</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Native</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferEth</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenType</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">TokenType</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Erc20</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">compatTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Please add the following <code>error</code> and append the test in <code>sol-tests\\crowdfund\\BuyCrowdfund.t.sol</code>. This test will pass to demonstrate the described scenario.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">error</span><span class=\"mtk1\"> </span><span class=\"mtk11\">EthTransferFailed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">errData</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testContributorContractFailsToReceiveETH</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">erc721Vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">BuyCrowdfund</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pb</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_createCrowdfund</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// This contract is used to simulate a contract that does not implement the receive or fallback function for the purpose of receiving ETH.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contributorContract</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contributorContract</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_randomAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// contributorContract contributes 1e18.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contributorContract</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pb</span><span class=\"mtk1\">.</span><span class=\"mtk12\">contribute</span><span class=\"mtk1\">{ value: </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\"> }(</span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// The price of the NFT of interest is 0.5e18.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Party</span><span class=\"mtk1\"> </span><span class=\"mtk12\">party_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pb</span><span class=\"mtk1\">.</span><span class=\"mtk11\">buy</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc721Vault</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0.5e18</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeCall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc721Vault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">claim</span><span class=\"mtk1\">, (</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">defaultGovernanceOpts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// After calling the buy function, the party is created with the NFT.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">party</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">party_</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pb</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getCrowdfundLifecycle</span><span class=\"mtk1\">() == </span><span class=\"mtk12\">Crowdfund</span><span class=\"mtk1\">.</span><span class=\"mtk12\">CrowdfundLifecycle</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Won</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pb</span><span class=\"mtk1\">.</span><span class=\"mtk11\">settledPrice</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">0.5e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pb</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalContributions</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pb</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">0.5e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Calling the burn function reverts because contributorContract cannot receive ETH through the receive or fallback function</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">EthTransferFailed</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">contributorContract</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pb</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contributorContract</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// contributorContract does not receive 0.5e18 back from the BuyCrowdfund contract.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contributorContract</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>When calling the <code>transferEth</code> function, if the receiver contract is unable to receive ETH through its <code>receive</code> or <code>fallback</code> function, WETH can be used to deposit the corresponding ETH amount, and the deposited amount can be transferred to the receiver contract.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/212#issuecomment-1255144719\">merklejerk (PartyDAO) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>We will mitigate this by escrowing the ETH refund and/or the governance NFT to be claimed by the contributor later (possibly to a different address) if either transfer fails.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/212#issuecomment-1264675601\">0xble (PartyDAO) resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved: <a href=\"https://github.com/PartyDAO/partybidV2/pull/126\">https://github.com/PartyDAO/partybidV2/pull/126</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/212#issuecomment-1268532848\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>A contract contributor may revert on <code>burn</code>, preventing full voting power distribution. Agree with Medium risk.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-possible-that-unanimous-votes-is-unachievable\" style=\"position:relative;\"><a href=\"#m-10-possible-that-unanimous-votes-is-unachievable\" aria-label=\"m 10 possible that unanimous votes is unachievable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/114\">[M-10] Possible that unanimous votes is unachievable</a></h2>\n<p><em>Submitted by Lambda, also found by CertoraInc</em></p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L370\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L370</a></p>\n<p><a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernance.sol#L1066\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernance.sol#L1066</a></p>\n<h3 id=\"impact-9\" style=\"position:relative;\"><a href=\"#impact-9\" aria-label=\"impact 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Currently, the <code>votingPower</code> calculation rounds down for every user except the <code>splitRecipient</code>. This can cause situations where 99.99% of votes (i.e., an unanimous vote) are not achieved, even if all vote in favor of a proposal. This can be very bad for a party, as certain proposals (transferring precious tokens out) require an unanimous vote and are therefore not executable.</p>\n<h3 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof Of Concept</h3>\n<p>Let’s say for the sake of simplicity that 100 persons contribute 2 wei and <code>splitBps</code> is 10 (1%). <code>votingPower</code> for all users that contributed will be 1 and 2 for the <code>splitRecipient</code>, meaning the maximum achievable vote percentage is 102 / 200 = 51%.</p>\n<p>Of course, this is an extreme example, but it shows that the current calculation can introduce siginificant rounding errors that impact the functionality of the protocol.</p>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Instead of requiring more than 99.99% of the votes, ensure that the individual votingPower sum to the total contribution. For instance, one user (e.g., the last one to claim) could receive all the remaining votingPower, which would require a running sum of the already claimed votingPower.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/114#issuecomment-1254203278\">merklejerk (PartyDAO) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>We consider it highly unlikely that an NFT would be crowdfunded for dust amounts so we don’t think this would actually occur in the wild.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/114#issuecomment-1268541357\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Rounding error could prevent unanimous votes.. agree with Medium risk.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-maximum-bid-will-always-be-used-in-auction\" style=\"position:relative;\"><a href=\"#m-11-maximum-bid-will-always-be-used-in-auction\" aria-label=\"m 11 maximum bid will always be used in auction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/179\">[M-11] Maximum bid will always be used in Auction</a></h2>\n<p><em>Submitted by csanuragjain, also found by Lambda</em></p>\n<p>AuctionCrowdfund contract is designed in a way to allow bidding max upto maximumBid. But due to a flaw, anyone (including NFT seller) can make sure that CrowdFund bid always remain equal to maximumBid thus removing the purpose of maximumBid. This also causes loss to Party participating in this Auction as the auction will always end up with maximumBid even when it could have stopped with lower bid as shown in POC.</p>\n<h3 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>An auction is started for NFT N in the market</li>\n<li>Party Users P1 starts an AuctionCrowdfund with maximumBid as 100 for this auction.</li>\n</ol>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function initialize(AuctionCrowdfundOptions memory opts)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        payable</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        onlyConstructor</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">maximumBid = opts.maximumBid;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<ol start=\"3\">\n<li>P1 bids amount 10 for the NFT N using <a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/crowdfund/AuctionCrowdfund.sol#L149\">bid function</a></li>\n<li>Some bad news arrives for the NFT collection including NFT N reducing its price</li>\n<li>P1 decides not to bid more than amount 10 due to this news</li>\n<li>NFT collection owner who is watching this AuctionCrowdfund observes that bidding is only 10 but Party users have maximumBid of 100</li>\n<li>NFT collection owner  asks his friend to bid on this NFT in the auction market (different from crowd fund)</li>\n<li>NFT collection owner now takes advantage of same and himself calls the bid function of AuctionCrowdfund via Proxy</li>\n</ol>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function bid() external onlyDelegateCall {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<ol start=\"9\">\n<li>Now since last bid belongs to collection owner friend, so AuctionCrowdfund contract simply extends its bid further</li>\n</ol>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (market.getCurrentHighestBidder(auctionId_) == address(this)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            revert AlreadyHighestBidderError();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Get the minimum necessary bid to be the highest bidder.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint96 bidAmount = market.getMinimumBid(auctionId_).safeCastUint256ToUint96();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Make sure the bid is less than the maximum bid.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (bidAmount &gt; maximumBid) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            revert ExceedsMaximumBidError(bidAmount, maximumBid);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lastBid = bidAmount;</span></span></code></pre>\n<ol start=\"10\">\n<li>NFT collection owner keeps repeating step 7-9 until AuctionCrowdfund reaches the final maximum bid of 100</li>\n<li>After auction completes, collection owner gets 100 amount instead of 10 even though crowd fund users never bidded for amount 100</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>maximumbid concept can easily be bypassed as shown above and will not make sense. Either remove it completely</p>\n<p>OR</p>\n<p>bid function should only be callable via crowdfund members then attacker would be afraid if new bid will come or not and there should be a consensus between crowdfund members before bidding which will protect this scenario.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/179#issuecomment-1255154999\">merklejerk (PartyDAO) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>While it doesn’t solve it for all crowdfunds, we will allow some crowdfunds to restrict who can call their <code>bid()</code> function to host-only.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/179#issuecomment-1269948984\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This is a form of leaking value - agree with Medium risk.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/179#issuecomment-1276607530\">0xble (PartyDAO) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>Mitigated by: <a href=\"https://github.com/PartyDAO/partybidV2/pull/140\">https://github.com/PartyDAO/partybidV2/pull/140</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-12-excess-eth-is-not-refunded\" style=\"position:relative;\"><a href=\"#m-12-excess-eth-is-not-refunded\" aria-label=\"m 12 excess eth is not refunded permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/186\">[M-12] Excess eth is not refunded</a></h2>\n<p><em>Submitted by csanuragjain</em></p>\n<p>The ArbitraryCallsProposal contract requires sender to provide eth(msg.value) for each call. Now if user has provided more eth than combined call.value then this excess eth is not refunded back to user.</p>\n<h3 id=\"proof-of-concept-18\" style=\"position:relative;\"><a href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Observe the <a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/proposals/ArbitraryCallsProposal.sol#L37\">_executeArbitraryCalls function</a></li>\n</ol>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _executeArbitraryCalls(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IProposalExecutionEngine.ExecuteProposalParams memory params</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        internal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        returns (bytes memory nextProgressData)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 ethAvailable = msg.value;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint256 i = 0; i &lt; calls.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Execute an arbitrary call.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _executeSingleArbitraryCall(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                i,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                calls[i],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                params.preciousTokens,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                params.preciousTokenIds,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                isUnanimous,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                ethAvailable</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Update the amount of ETH available for the subsequent calls.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ethAvailable -= calls[i].value;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            emit ArbitraryCallExecuted(params.proposalId, i, calls.length);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">....</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<ol start=\"2\">\n<li>As we can see user provided msg.value is deducted with each calls[i].value</li>\n<li>Assume user provided 5 amount as msg.value and made a single call with calls[0].value as 4</li>\n<li>This means after calls have been completed ethAvailable will become 5-4=1</li>\n<li>Ideally this 1 eth should be refunded back to user but there is no provision for same and the fund will remain in contract</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>At the end of <code>\\_executeArbitraryCalls</code> function, refund the remaining ethAvailable back to the user.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/186#issuecomment-1255157023\">merklejerk (PartyDAO) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Will refund unused ETH at the end of executing arbitrary calls.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/186#issuecomment-1264679434\">0xble (PartyDAO) resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved: <a href=\"https://github.com/PartyDAO/partybidV2/pull/135\">https://github.com/PartyDAO/partybidV2/pull/135</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/186#issuecomment-1269951162\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This is a form of leaking value - agree with Medium risk.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 67 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/101\">report highlighted below</a> by <strong>Lambda</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/293\">Ch_301</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/125\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/254\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/344\">brgltd</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/280\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/84\">ayeslick</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/191\">0x52</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/75\">CodingNameKiki</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/261\">CertoraInc</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/308\">cryptphi</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/198\">Trust</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/302\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/350\">Deivitto</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/122\">R2</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/151\">pfapostol</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/250\">CRYP70</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/342\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/209\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/317\">asutorufos</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/47\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/80\">bulej93</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/259\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/128\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/59\">RaymondFam</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/158\">gogo</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/295\">leosathya</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/347\">pedr02b2</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/296\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/182\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/160\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/312\">wagmi</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/203\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/228\">lukris02</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/248\">KIntern_NA</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/313\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/54\">ReyAdmirado</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/235\">0x5rings</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/188\">Jeiwan</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/223\">PaludoX0</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/15\">ChristianKuri</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/294\">smiling_heretic</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/200\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/260\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/219\">slowmoses</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/90\">malinariy</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/142\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/325\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/145\">martin</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/352\">The_GUILD</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/51\">Anth3m</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/163\">0xDanielC</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/4\">erictee</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/328\">0x4non</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/177\">Tomo</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/168\">JansenC</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/72\">MasterCookie</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/236\">djxploit</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/55\">ch0bu</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/170\">Olivierdem</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/318\">tnevler</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/94\">B2</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/66\">StevenL</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/332\">JC</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/348\">V_B</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/322\">indijanc</a>, and <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/338\">d3e4</a>.</em></p>\n<h2 id=\"low-risk-issues\" style=\"position:relative;\"><a href=\"#low-risk-issues\" aria-label=\"low risk issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Issues</h2>\n<ul>\n<li>After a <code>FractionalizeProposal</code> was executed succesfully and the tokens were distributed, it will not be possible to get the NFT back by calling <code>redeem</code> in practice. This function requires that the sender (the party in this case) owns all tokens, which would require that all users transfer them back again. However, transferring them to the party would be very risky when you do not if all other participants also do that (as the tokens are lost when one user does not transfer them) and some users may have sold them. This behavior may be desired (although it is a bit against the general philosophy were the tokens are protected IMO), but it should be documented that this is a destructive action.</li>\n<li><code>FoundationMarketWrapper.auctionIdMatchesToken</code> returns <code>true</code> for auctionId 0 and <code>isFinalized</code> also returns <code>true</code>. Because of that, it is possible to create an auction with ID 0 where no one can bid because it is immediately finalized.</li>\n<li><code>ZoraMarketWrapper.auctionIDMatchesToken</code> returns <code>true</code> for auctionId 0 and <code>nftContract = address(0)</code>, and <code>isFinalized</code> als returns <code>true</code>. Because of that, it is possible to create an auction with ID 0 and <code>address(0)</code> where no one can bid because it is immediately finalized.</li>\n<li><code>BuyCrowdfund</code> cannot retrieve ETH, but certain contracts that are called by it (e.g., NFT marketplaces) might return additional ETH when too much is paid. In such scenarios, the whole transaction would fail.</li>\n</ul>\n<h2 id=\"non-critical-issues\" style=\"position:relative;\"><a href=\"#non-critical-issues\" aria-label=\"non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Issues</h2>\n<ul>\n<li>In <code>PartyGovernance._getProposalStatus</code>, the constant <code>VETO_VALUE</code> is not used (<a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernance.sol#L1033\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernance.sol#L1033</a>), whereas it is used when performing the veto (<a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernance.sol#L634\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernance.sol#L634</a>). While this is not a problem currently (the values are identical), it can be dangerous when this value is updated at one point, because updating <code>_getProposalStatus</code> might get forgotten. Consider using the constant consistently.</li>\n<li>The link for FractionalizeProposal (<a href=\"https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/proposals/FractionalizeProposal.sol#L30\">https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/proposals/FractionalizeProposal.sol#L30</a>) is wrong. It links to the source code of the vault, but the variable points to the factory. The correct link is <a href=\"https://github.com/fractional-company/contracts/blob/master/src/ERC721VaultFactory.sol\">https://github.com/fractional-company/contracts/blob/master/src/ERC721VaultFactory.sol</a></li>\n<li>For Nouns, it is only possible to deploy the auction when the desired ID is for sale. However, it might be desired to create an auction in advance (e.g., for token ID 7 when the current ID is 5), such that there is more time to collect funds. For a system like Nouns this would work nicely, because it is (roughly) known in advance when an auction for a token will start.</li>\n<li><code>CrowdfundNFT</code>, the implementation of a soulbound NFT, is a bit too simplistic in my opinion. One problem with soulbound NFTs is wallet recovery. In such situations, you want to be able to transfer the NFT to another wallet (but of course, this should not be possible without prior checks, otherwise they would not be soulbound). There are different standards like <a href=\"https://eips.ethereum.org/EIPS/eip-4671\">EIP 4671</a> that address soulbound NFTs (and the mentioned problems), consider implementing one of them.</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/101#issuecomment-1257370626\">0xble (PartyDAO) commented</a>:</strong></p>\n<blockquote>\n<p>The first two Non-Critical suggestions we’ll change, the rest are interesting and we acknowledge them. Great suggestions overall.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/101#issuecomment-1266689622\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Merging with <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/109\">109</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/103\">103</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/106\">106</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/108\">108</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/115\">115</a>, and <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/116\">116</a> which are all Low Risk issues.</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 82 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/272\">report highlighted below</a> by <strong>CertoraInc</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/301\">m_Rassska</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/97\">pfapostol</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/304\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/331\">JC</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/346\">Deivitto</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/297\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/53\">ReyAdmirado</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/126\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/157\">gogo</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/68\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/210\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/50\">0xkatana</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/214\">JAGADESH</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/305\">Sm4rty</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/267\">ajtra</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/360\">peiw</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/62\">SnowMan</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/345\">brgltd</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/3\">erictee</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/307\">prasantgupta52</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/323\">Rohan16</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/8\">Bnke0x0</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/199\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/326\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/28\">gianganhnguyen</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/190\">karanctf</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/262\">Tomio</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/165\">sryysryy</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/279\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/178\">ignacio</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/230\">lukris02</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/61\">RaymondFam</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/100\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/89\">malinariy</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/52\">ch0bu</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/14\">Metatron</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/133\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/234\">0x5rings</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/229\">djxploit</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/161\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/298\">leosathya</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/6\">robee</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/12\">Saintcode_</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/88\">jag</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/144\">martin</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/227\">slowmoses</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/176\">Tomo</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/269\">got_targ</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/169\">Olivierdem</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/327\">0x4non</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/266\">Amithuddar</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/333\">asutorufos</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/91\">B2</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/270\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/19\">ChristianKuri</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/253\">CRYP70</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/258\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/337\">Fitraldys</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/127\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/152\">LeoS</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/324\">natzuu</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/174\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/316\">tnevler</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/349\">V_B</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/79\">bulej93</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/185\">Diraco</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/321\">francoHacker</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/57\">Noah3o6</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/256\">Ocean_Sky</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/339\">d3e4</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/22\">dharma09</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/187\">IgnacioB</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/319\">peanuts</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/65\">0x85102</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/357\">aysha</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/78\">CodingNameKiki</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/314\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/124\">Matin</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/222\">PaludoX0</a>, <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/273\">pashov</a>, and <a href=\"https://github.com/code-423n4/2022-09-party-findings/issues/67\">StevenL</a>.</em></p>\n<ul>\n<li>\n<p>Use the old <code>oldHostsFieldValue</code> value in the <code>Crowdfund._hashFixedGovernanceOpts</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oldHostsFieldValue</span><span class=\"mtk1\"> := </span><span class=\"mtk10\">mload</span><span class=\"mtk1\">(</span><span class=\"mtk10\">opts</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk12\">opts</span><span class=\"mtk1\">, </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk11\">mload</span><span class=\"mtk1\">(</span><span class=\"mtk12\">opts</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0x20</span><span class=\"mtk1\">), </span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk11\">mload</span><span class=\"mtk1\">(</span><span class=\"mtk11\">mload</span><span class=\"mtk1\">(</span><span class=\"mtk12\">opts</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">32</span><span class=\"mtk1\">)))</span></span></span></code></pre>\n</li>\n<li>\n<p>Use unchecked on this part of the <code>Crowdfund._getFinalContribution</code> function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// This contribution was partially used.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">partialEthUsed</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalEthUsed</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">c</span><span class=\"mtk1\">.</span><span class=\"mtk12\">previousTotalContributions</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ethUsed</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">partialEthUsed</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// this doesn&#39;t need to be unchecked</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ethOwed</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">c</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">partialEthUsed</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The code will look like this:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// This contribution was partially used.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">partialEthUsed</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalEthUsed</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">c</span><span class=\"mtk1\">.</span><span class=\"mtk12\">previousTotalContributions</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ethOwed</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">c</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">partialEthUsed</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ethUsed</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">partialEthUsed</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// this doesn&#39;t need to be unchecked</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</li>\n<li>\n<p>Use > 0 instead of >= 1, use unchecked and cache the expression’s result instead of calculating it twice (in the <code>Crowdfund._contribute</code> function):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">numContributions</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Contribution</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastContribution</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">contributions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">numContributions</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">lastContribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">previousTotalContributions</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">previousTotalContributions</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// No one else has contributed since so just reuse the last entry.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">lastContribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">contributions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">numContributions</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">lastContribution</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The code will look like this:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">numContributions</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">numContributions</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Contribution</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastContribution</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">contributions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">lastIndex</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">lastContribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">previousTotalContributions</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">previousTotalContributions</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// No one else has contributed since so just reuse the last entry.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">lastContribution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">contributions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">lastIndex</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">lastContribution</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</li>\n<li>Cache <code>splitRecipient</code> in the <code>Crowdfund._burn()</code> function</li>\n<li>If the amount is 0, don’t perform the low level call in <code>LibAddress.transferETH()</code></li>\n</ul>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk17 { color: #808080; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-7\">High Risk Findings (7)</a></p>\n<ul>\n<li><a href=\"#h-01-partygovernance-can-vote-multiple-times-by-transferring-nft-in-same-block-as-proposal\">[H-01] PartyGovernance: Can vote multiple times by transferring NFT in same block as proposal</a></li>\n<li><a href=\"#h-02-possibility-to-burn-all-eth-in-crowdfund-under-some-circumstances\">[H-02] Possibility to burn all ETH in Crowdfund under some circumstances</a></li>\n<li><a href=\"#h-03-a-majority-attack-can-easily-bypass-zora-auction-stage-in-openseaproposal-and-steal-the-nft-from-the-party\">[H-03] A majority attack can easily bypass Zora auction stage in OpenseaProposal and steal the NFT from the party.</a></li>\n<li><a href=\"#h-04-tokendistributor-erc777-tokenstosend-hook-can-be-exploited-to-drain-contract\">[H-04] TokenDistributor: ERC777 tokensToSend hook can be exploited to drain contract</a></li>\n<li><a href=\"#h-05-arbitrarycallsproposalsol-and-listonopenseaproposalsol-safeguards-can-be-bypassed-by-cancelling-in-progress-proposal-allowing-the-majority-to-steal-nft\">[H-05] ArbitraryCallsProposal.sol and ListOnOpenseaProposal.sol safeguards can be bypassed by cancelling in-progress proposal allowing the majority to steal NFT</a></li>\n<li><a href=\"#h-06--a-majority-attack-can-steal-precious-nft-from-the-party-by-crafting-and-chaining-two-proposals\">[H-06]  A majority attack can steal precious NFT from the party by crafting and chaining two proposals</a></li>\n<li><a href=\"#h-07-attacker-can-dos-private-party-by-donating-eth-then-calling-buy\">[H-07] Attacker can DOS private party by donating ETH then calling buy</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-12\">Medium Risk Findings (12)</a></p>\n<ul>\n<li><a href=\"#m-01-attacker-can-list-an-nft-they-own-and-inflate-to-zero-all-users-contributions-keeping-the-nft-and-all-the-money\">[M-01] Attacker can list an NFT they own and inflate to zero all users’ contributions, keeping the NFT and all the money</a></li>\n<li><a href=\"#m-02-previously-nominated-delegate-can-reset-the-delegation\">[M-02] Previously nominated delegate can reset the delegation</a></li>\n<li><a href=\"#m-03-only-part-of-keccak256-is-used-as-hash-making-it-susceptible-to-collision-attacks\">[M-03] Only part of <code>keccak256()</code> is used as hash, making it susceptible to collision attacks</a></li>\n<li><a href=\"#m-04-nft-owner-can-stuck-crowdfund-user-funds\">[M-04] NFT Owner can stuck Crowdfund user funds</a></li>\n<li><a href=\"#m-05-the-settledprice-maybe-exceed-maximumprice\">[M-05] The settledPrice maybe exceed maximumPrice</a></li>\n<li><a href=\"#m-06-auctioncrowdfund-if-the-contract-was-bid-on-before-the-nft-was-gifted-to-the-contract-lastbid-will-not-be-totalcontributions\">[M-06] AuctionCrowdfund: If the contract was bid on before the NFT was gifted to the contract, lastBid will not be totalContributions</a></li>\n<li><a href=\"#m-07-attacker-can-force-auctioncrowdfunds-to-bid-their-entire-contribution-up-to-maxbid\">[M-07] Attacker can force AuctionCrowdfunds to bid their entire contribution up to maxBid</a></li>\n<li><a href=\"#m-08-early-contributor-can-always-become-majority-of-crowdfund-leading-to-rugging-risks\">[M-08] Early contributor can always become majority of crowdfund leading to rugging risks.</a></li>\n<li><a href=\"#m-09-calling-transfereth-function-can-revert-if-receiver-input-corresponds-to-a-contract-that-is-unable-to-receive-eth-through-its-receive-or-fallback-function\">[M-09] Calling <code>transferEth</code> function can revert if <code>receiver</code> input corresponds to a contract that is unable to receive ETH through its <code>receive</code> or <code>fallback</code> function</a></li>\n<li><a href=\"#m-10-possible-that-unanimous-votes-is-unachievable\">[M-10] Possible that unanimous votes is unachievable</a></li>\n<li><a href=\"#m-11-maximum-bid-will-always-be-used-in-auction\">[M-11] Maximum bid will always be used in Auction</a></li>\n<li><a href=\"#m-12-excess-eth-is-not-refunded\">[M-12] Excess eth is not refunded</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#low-risk-issues\">Low Risk Issues</a></li>\n<li><a href=\"#non-critical-issues\">Non-Critical Issues</a></li>\n</ul>\n</li>\n<li><a href=\"#gas-optimizations\">Gas Optimizations</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the PartyDAO smart contract system written in Solidity. The audit contest took place between September 12—September 19 2022.\n\n## Wardens\n\n119 Wardens contributed reports to the PartyDAO contest:\n\n  1. Lambda\n  1. [Trust](https://twitter.com/trust__90)\n  1. 0x52\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. cccz\n  1. [8olidity](https://twitter.com/8olidity)\n  1. [bin2chen](https://twitter.com/bin2chen)\n  1. [hyh](https://twitter.com/0xhyh)\n  1. ladboy233\n  1. CertoraInc (egjlmn1, [OriDabush](https://twitter.com/ori_dabush), ItayG, shakedwinder and RoiEvenHaim)\n  1. [smiling\\_heretic](https://github.com/SmilingHeretic)\n  1. V\\_B (Barichek and vlad\\_bochok)\n  1. rvierdiiev\n  1. 0xA5DF\n  1. [Ch\\_301](https://twitter.com/0xch301)\n  1. [Jeiwan](https://jeiwan.net)\n  1. [0xSmartContract](https://twitter.com/0xSmartContract)\n  1. tonisives\n  1. rbserver\n  1. [Chom](https://chom.dev)\n  1. [pfapostol](https://t.me/pfahard)\n  1. brgltd\n  1. [c3phas](https://twitter.com/c3ph_)\n  1. [0xNazgul](https://twitter.com/0xNazgul)\n  1. [m\\_Rassska](https://t.me/Road220)\n  1. [JC](https://twitter.com/sm4rtcontr4ct)\n  1. [Deivitto](https://twitter.com/Deivitto)\n  1. CodingNameKiki\n  1. ayeslick\n  1. [MiloTruck](https://milotruck.github.io/)\n  1. ReyAdmirado\n  1. [gogo](https://www.linkedin.com/in/georgi-nikolaev-georgiev-978253219)\n  1. 0x1f8b\n  1. CRYP70\n  1. asutorufos\n  1. bulej93\n  1. RaymondFam\n  1. erictee\n  1. leosathya\n  1. \\_\\_141345\\_\\_\n  1. [Aymen0909](https://github.com/Aymen1001)\n  1. [fatherOfBlocks](https://twitter.com/father0fBl0cks)\n  1. lukris02\n  1. [Funen](https://instagram.com/vanensurya)\n  1. malinariy\n  1. 0x5rings\n  1. PaludoX0\n  1. ch0bu\n  1. ChristianKuri\n  1. slowmoses\n  1. delfin454000\n  1. djxploit\n  1. [martin](https://github.com/martin-petrov03)\n  1. [Tomo](https://tom-sol.notion.site/Who-am-I-3b4dc28e77b647eb90794735a94dd38e)\n  1. Olivierdem\n  1. 0x4non\n  1. tnevler\n  1. B2\n  1. StevenL\n  1. d3e4\n  1. cryptphi\n  1. R2\n  1. 0xbepresent\n  1. [hansfriese](https://twitter.com/hansfriese)\n  1. pedr02b2\n  1. wagmi\n  1. KIntern\\_NA (TrungOre and duc)\n  1. The_GUILD ([David_](https://twitter.com/davidpius10), [Ephraim](https://twitter.com/iamephraim_js), LeoGold, and greatsamist)\n  1. Anth3m\n  1. [0xDanielC](https://twitter.com/DanielCawleyDev)\n  1. [JansenC](https://www.linkedin.com/in/jansen-moreira/?locale&#x3D;en_US)\n  1. MasterCookie\n  1. [indijanc](https://twitter.com/krenkmet)\n  1. Rolezn\n  1. 0xkatana\n  1. JAGADESH\n  1. [Sm4rty](https://twitter.com/Sm4rty_)\n  1. ajtra\n  1. peiw\n  1. SnowMan\n  1. [prasantgupta52](https://twitter.com/prasantgupta52)\n  1. [Rohan16](https://twitter.com/ROHANJH56009256)\n  1. Bnke0x0\n  1. gianganhnguyen\n  1. karanctf\n  1. [Tomio](https://twitter.com/meidhiwirara)\n  1. sryysryy\n  1. [ignacio](https://twitter.com/0xheynacho)\n  1. Metatron\n  1. Waze\n  1. robee\n  1. Saintcode\\_\n  1. jag\n  1. got\\_targ\n  1. Amithuddar\n  1. [Fitraldys](https://twitter.com/fitraldys)\n  1. LeoS\n  1. [natzuu](https://twitter.com/natzuu33)\n  1. simon135\n  1. Diraco\n  1. francoHacker\n  1. Noah3o6\n  1. [Ocean\\_Sky](https://twitter.com/bluenights004)\n  1. [dharma09](https://twitter.com/im_Dharma09)\n  1. [IgnacioB](https://twitter.com/AdonaiR6)\n  1. peanuts\n  1. 0x85102\n  1. aysha\n  1. Matin\n  1. pashov\n\nThis contest was judged by [HardlyDifficult](https://twitter.com/HardlyDifficult).\n\nFinal report assembled by [itsmetechjay](https://twitter.com/itsmetechjay).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 19 unique vulnerabilities. Of these vulnerabilities, 7 received a risk rating in the category of HIGH severity and 12 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 67 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 82 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 PartyDAO contest repository](https://github.com/code-423n4/2022-09-party), and is composed of 46 smart contracts written in the Solidity programming language and includes 3,995 lines of Solidity code. For the purposes of the audit contest, the code was forked into a new repo from its main location in the PartyDAO party-protocol repo at this commit hash: [1eb4909a2f568d910e70e2db1b487a0236fbe10b](https://github.com/PartyDAO/party-protocol/tree/1eb4909a2f568d910e70e2db1b487a0236fbe10b).\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# High Risk Findings (7)\n## [[H-01] PartyGovernance: Can vote multiple times by transferring NFT in same block as proposal](https://github.com/code-423n4/2022-09-party-findings/issues/113)\n_Submitted by Lambda, also found by Trust_\n\n`PartyGovernanceNFT` uses the voting power at the time of proposal when calling `accept`. The problem with that is that a user can vote, transfer the NFT (and the voting power) to a different wallet, and then vote from this second wallet again during the same block that the proposal was created.\nThis can also be repeated multiple times to get an arbitrarily high voting power and pass every proposal unanimously.\n\nThe consequences of this are very severe. Any user (no matter how small his voting power is) can propose and pass arbitrary proposals animously and therefore steal all assets (including the precious tokens) out of the party.\n\n### Proof Of Concept\n\nThis diff shows how a user with a voting power of 50/100 gets a voting power of 100/100 by transferring the NFT to a second wallet that he owns and voting from that one:\n\n```diff\n--- a/sol-tests/party/PartyGovernanceUnit.t.sol\n+++ b/sol-tests/party/PartyGovernanceUnit.t.sol\n@@ -762,6 +762,7 @@ contract PartyGovernanceUnitTest is Test, TestUtils {\n         TestablePartyGovernance gov =\n             _createGovernance(100e18, preciousTokens, preciousTokenIds);\n         address undelegatedVoter = _randomAddress();\n+        address recipient = _randomAddress();\n         // undelegatedVoter has 50/100 intrinsic VP (delegated to no one/self)\n         gov.rawAdjustVotingPower(undelegatedVoter, 50e18, address(0));\n \n@@ -772,38 +773,13 @@ contract PartyGovernanceUnitTest is Test, TestUtils {\n         // Undelegated voter submits proposal.\n         vm.prank(undelegatedVoter);\n         assertEq(gov.propose(proposal, 0), proposalId);\n-\n-        // Try to execute proposal (fail).\n-        vm.expectRevert(abi.encodeWithSelector(\n-            PartyGovernance.BadProposalStatusError.selector,\n-            PartyGovernance.ProposalStatus.Voting\n-        ));\n-        vm.prank(undelegatedVoter);\n-        gov.execute(\n-            proposalId,\n-            proposal,\n-            preciousTokens,\n-            preciousTokenIds,\n-            \"\",\n-            \"\"\n-        );\n-\n-        // Skip past execution delay.\n-        skip(defaultGovernanceOpts.executionDelay);\n-        // Try again (fail).\n-        vm.expectRevert(abi.encodeWithSelector(\n-            PartyGovernance.BadProposalStatusError.selector,\n-            PartyGovernance.ProposalStatus.Voting\n-        ));\n-        vm.prank(undelegatedVoter);\n-        gov.execute(\n-            proposalId,\n-            proposal,\n-            preciousTokens,\n-            preciousTokenIds,\n-            \"\",\n-            \"\"\n-        );\n+        (, PartyGovernance.ProposalStateValues memory valuesPrev) = gov.getProposalStateInfo(proposalId);\n+        assertEq(valuesPrev.votes, 50e18);\n+        gov.transferVotingPower(undelegatedVoter, recipient, 50e18); //Simulate NFT transfer\n+        vm.prank(recipient);\n+        gov.accept(proposalId, 0);\n+        (, PartyGovernance.ProposalStateValues memory valuesAfter) = gov.getProposalStateInfo(proposalId);\n+        assertEq(valuesAfter.votes, 100e18);\n     }\n```\n\n### Recommended Mitigation Steps\n\nYou should query the voting power at `values.proposedTime - 1`. This value is already finalized when the proposal is created and therefore cannot be manipulated by repeatedly transferring the voting power to different wallets.\n\n**[merklejerk (PartyDAO) confirmed and commented](https://github.com/code-423n4/2022-09-party-findings/issues/113#issuecomment-1254200841):**\n > This is our favorite find and want to call it out specifically. We would consider this critical.\n> \n> We will implement the suggested fix in this PR and use `proposedTime - 1` for voting power calculations.\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/113#issuecomment-1262756331):**\n > Agree with High risk - any user with a non-zero voting power can pass a proposal & steal assets.\n\n**[0xble (PartyDAO) resolved](https://github.com/code-423n4/2022-09-party-findings/issues/113#issuecomment-1264675378):**\n > Resolved: https://github.com/PartyDAO/partybidV2/pull/130\n\n\n\n***\n\n## [[H-02] Possibility to burn all ETH in Crowdfund under some circumstances](https://github.com/code-423n4/2022-09-party-findings/issues/105)\n_Submitted by Lambda, also found by 8olidity_\n\nIf `opts.initialContributor` is set to `address(0)` (and `opts.initialDelegate` is not), there are two problems:\n1.) If the crowdfund succeeds, the initial balance will be lost. It is still accredited to `address(0)`, but it is not retrievable.\n2.) If the crowdfund does not succeed, anyone can completely drain the contract by repeatedly calling `burn` with `address(0)`. This will always succeed because `CrowdfundNFT._burn` can be called multiple times for `address(0)`. Every call will cause the initial balance to be burned (transferred to `address(0)`).\n\nIssue 1 is somewhat problematic, but issue 2 is very problematic, because all funds of a crowdfund are burned and an attacker can specifically set up such a deployment (and the user would not notice anything special, after all these are parameters that the protocol accepts).\n\n### Proof Of Concept\n\nThis diff illustrates scenario 2, i.e. where a malicious deployer burns all contributions (1 ETH) of `contributor`. He loses 0.25ETH for the attack, but this could be reduced significantly (with more `burn(payable(address(0)))` calls:\n\n```diff\n--- a/sol-tests/crowdfund/BuyCrowdfund.t.sol\n+++ b/sol-tests/crowdfund/BuyCrowdfund.t.sol\n@@ -36,9 +36,9 @@ contract BuyCrowdfundTest is Test, TestUtils {\n     string defaultSymbol = 'PBID';\n     uint40 defaultDuration = 60 * 60;\n     uint96 defaultMaxPrice = 10e18;\n-    address payable defaultSplitRecipient = payable(0);\n+    address payable defaultSplitRecipient = payable(address(this));\n     uint16 defaultSplitBps = 0.1e4;\n-    address defaultInitialDelegate;\n+    address defaultInitialDelegate = address(this);\n     IGateKeeper defaultGateKeeper;\n     bytes12 defaultGateKeeperId;\n     Crowdfund.FixedGovernanceOpts defaultGovernanceOpts;\n@@ -78,7 +78,7 @@ contract BuyCrowdfundTest is Test, TestUtils {\n                     maximumPrice: defaultMaxPrice,\n                     splitRecipient: defaultSplitRecipient,\n                     splitBps: defaultSplitBps,\n-                    initialContributor: address(this),\n+                    initialContributor: address(0),\n                     initialDelegate: defaultInitialDelegate,\n                     gateKeeper: defaultGateKeeper,\n                     gateKeeperId: defaultGateKeeperId,\n@@ -111,40 +111,26 @@ contract BuyCrowdfundTest is Test, TestUtils {\n     function testHappyPath() public {\n         uint256 tokenId = erc721Vault.mint();\n         // Create a BuyCrowdfund instance.\n-        BuyCrowdfund pb = _createCrowdfund(tokenId, 0);\n+        BuyCrowdfund pb = _createCrowdfund(tokenId, 0.25e18);\n         // Contribute and delegate.\n         address payable contributor = _randomAddress();\n         address delegate = _randomAddress();\n         vm.deal(contributor, 1e18);\n         vm.prank(contributor);\n         pb.contribute{ value: contributor.balance }(delegate, \"\");\n-        // Buy the token.\n-        vm.expectEmit(false, false, false, true);\n-        emit MockPartyFactoryCreateParty(\n-            address(pb),\n-            address(pb),\n-            _createExpectedPartyOptions(0.5e18),\n-            _toERC721Array(erc721Vault.token()),\n-            _toUint256Array(tokenId)\n-        );\n-        Party party_ = pb.buy(\n-            payable(address(erc721Vault)),\n-            0.5e18,\n-            abi.encodeCall(erc721Vault.claim, (tokenId)),\n-            defaultGovernanceOpts\n-        );\n-        assertEq(address(party), address(party_));\n-        // Burn contributor's NFT, mock minting governance tokens and returning\n-        // unused contribution.\n-        vm.expectEmit(false, false, false, true);\n-        emit MockMint(\n-            address(pb),\n-            contributor,\n-            0.5e18,\n-            delegate\n-        );\n-        pb.burn(contributor);\n-        assertEq(contributor.balance, 0.5e18);\n+        vm.warp(block.timestamp + defaultDuration + 1);\n+        // The auction was not won, we can now burn all ETH from contributor...\n+        assertEq(address(pb).balance, 1.25e18);\n+        pb.burn(payable(address(0)));\n+        assertEq(address(pb).balance, 1e18);\n+        pb.burn(payable(address(0)));\n+        assertEq(address(pb).balance, 0.75e18);\n+        pb.burn(payable(address(0)));\n+        assertEq(address(pb).balance, 0.5e18);\n+        pb.burn(payable(address(0)));\n+        assertEq(address(pb).balance, 0.25e18);\n+        pb.burn(payable(address(0)));\n+        assertEq(address(pb).balance, 0);\n```\n\n### Recommended Mitigation Steps\n\nDo not allow an initial contribution when `opts.initialContributor` is not set.\n\n**[merklejerk (PartyDAO) confirmed and commented](https://github.com/code-423n4/2022-09-party-findings/issues/105#issuecomment-1254181677):**\n > Excellent catch. We will implement the fix from [#238](https://github.com/code-423n4/2022-09-party-findings/issues/238) and prevent minting to `address(0)`.\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/105#issuecomment-1262738133):**\n > Agree with High risk - a crowdfund's initial configuration could lead to the loss of user funds.\n\n**[0xble (PartyDAO) resolved](https://github.com/code-423n4/2022-09-party-findings/issues/105#issuecomment-1264675679):**\n > Resolved: https://github.com/PartyDAO/partybidV2/pull/127\n\n\n\n***\n\n## [[H-03] A majority attack can easily bypass Zora auction stage in OpenseaProposal and steal the NFT from the party.](https://github.com/code-423n4/2022-09-party-findings/issues/264)\n_Submitted by Trust_\n\nThe PartyGovernance system has many defenses in place to protect against a majority holder stealing the NFT. One of the main protections is that before listing the NFT on Opensea for a proposal-supplied price, it must first try to be auctioned off on Zora. To move from Zora stage to Opensea stage, `\\_settleZoraAuction()` is called when executing ListedOnZora step in ListOnOpenseaProposal.sol. If the function returns false, the next step is executed which lists the item on Opensea. It is assumed that if majority attack proposal reaches this stage, it can steal the NFT for free, because it can list the item for negligible price and immediately purchase it from a contract that executes the Opensea proposal.\n\nIndeed, attacker can always make `settleZoraAuction()` return false. Looking at  the code:\n\n    try ZORA.endAuction(auctionId) {\n                // Check whether auction cancelled due to a failed transfer during\n                // settlement by seeing if we now possess the NFT.\n                if (token.safeOwnerOf(tokenId) == address(this)) {\n                    emit ZoraAuctionFailed(auctionId);\n                    return false;\n                }\n            } catch (bytes memory errData) {\n\nAs the comment already hints, an auction can be cancelled if the NFT transfer to the bidder fails. This is the relevant AuctionHouse code (endAuction):\n\n    {\n                // transfer the token to the winner and pay out the participants below\n                try IERC721(auctions[auctionId].tokenContract).safeTransferFrom(address(this), auctions[auctionId].bidder, auctions[auctionId].tokenId) {} catch {\n                    _handleOutgoingBid(auctions[auctionId].bidder, auctions[auctionId].amount, auctions[auctionId].auctionCurrency);\n                    _cancelAuction(auctionId);\n                    return;\n     }\n\nAs most NFTs inherit from OpenZeppelin's ERC721.sol code, safeTransferFrom will run:\n\n        function _safeTransfer(\n            address from,\n            address to,\n            uint256 tokenId,\n            bytes memory data\n        ) internal virtual {\n            _transfer(from, to, tokenId);\n            require(_checkOnERC721Received(from, to, tokenId, data), \"ERC721: transfer to non ERC721Receiver implementer\");\n        }\n\nSo, attacker can bid a very high amount on the NFT to ensure it is the winning bid. When AuctionHouse tries to send the NFT to attacker, the safeTransferFrom will fail because attack will not implement an ERC721Receiver. This will force the AuctionHouse to return the bid amount to the bidder and cancel the auction. Importantly, it will lead to a graceful return from `endAuction()`, which will make `settleZoraAuction()` return false and progress to the OpenSea stage.\n\n### Impact\n\nA majority attack can easily bypass Zora auction stage and steal the NFT from the party.\n\n### Proof of Concept\n\n1.  Pass a ListOnOpenseaProposal with a tiny list price and execute it\n2.  Create an attacker contract which bids on the NFT an overpriced amount, but does not implement ERC721Receiver. Call its bid() function\n3.  Wait for the auction to end ( timeout after the bid() call)\n4.  Create a contract with a function which calls execute() on the proposal and immediately buys the item on Seaport. Call the attack function.\n\n### Recommended Mitigation Steps\n\n`\\_settleZoraAuction` is called from both ListOnZoraProposal and ListOnOpenseaProposal. If the auction was cancelled due to a failed transfer, as is described in the comment, we would like to handle it differently for each proposal type. For ListOnZoraProposal, it should indeed return false, in order to finish executing the proposal and not to hang the engine. For ListOnOpenseaProposal, the desired behavior is to *revert* in the case of a failed transfer. This is because the next stage is risky and defense against the mentioned attack is required. Therefore, pass a revertOnFail flag to `\\_settleZoraAuction`, which will be used like so:\n\n    // Check whether auction cancelled due to a failed transfer during\n    // settlement by seeing if we now possess the NFT.\n    if (token.safeOwnerOf(tokenId) == address(this)) {\n    \tif (revertOnFail) {\n    \t\trevert(\"Zora auction failed because of transfer to bidder\")\n    \t}\n               emit ZoraAuctionFailed(auctionId);\n               return false;\n    }\n\n**[merklejerk (PartyDAO) confirmed and commented](https://github.com/code-423n4/2022-09-party-findings/issues/264#issuecomment-1255311135):**\n > Great find. We will modify `_settleZoraAuction()` to return some auction status to be communicated up to the Opensea proposal.\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/264#issuecomment-1262795619):**\n > TIL. While digging into this I noticed that Zora changed this logic in their V3 implementation, avoiding this scenario - but there may be reasons to prefer the auction house contract.\n> \n> Agree with High risk - the auction safeguard can be bypassed, allowing a majority owner to steal from the rest of the party.\n\n**[0xble (PartyDAO) resolved](https://github.com/code-423n4/2022-09-party-findings/issues/264#issuecomment-1264680120):**\n > Resolved: https://github.com/PartyDAO/partybidV2/pull/137\n\n\n\n***\n\n## [[H-04] TokenDistributor: ERC777 tokensToSend hook can be exploited to drain contract](https://github.com/code-423n4/2022-09-party-findings/issues/120)\n_Submitted by Lambda_\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/distribution/TokenDistributor.sol#L131>\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/distribution/TokenDistributor.sol#L386>\n\n### Impact\n\n`TokenDistributor.createERC20Distribution` can be used to create token distributions for ERC777 tokens (which are backwards-compatible with ERC20). However, this introduces a reentrancy vulnerability which allows a party to get the tokens of another party. The problem is the `tokensToSend` hook which is executed BEFORE balance updates happens (see <https://eips.ethereum.org/EIPS/eip-777>). When this hook is executed, `token.balanceOf(address(this))` therefore still returns the old value, but `_storedBalances[balanceID]` was already decreased.\n\n### Proof Of Concept\n\nParty A and Party B have a balance of 1,000,000 tokens (of some arbitrary ERC777 token) in the distributor. Let's say for the sake of simplicity that both parties only have one user (user A in party A, user B in party B). User A (or rather his smart contract) performs the following attack:\n\n*   He calls `claim`, which transfers 1,000,000 tokens to his contract address. In `_transfer`, `_storedBalances[balanceId]` is decreased by 1,000,000 and therefore now has a value of 1,000,000.\n*   In the `tokensToSend` hook, he initiates another distribution for his party A by calling `PartyGovernance.distribute` which calls `TokenDistributor.createERC20Distribution` (we assume for the sake of simplicity that the party does not have more of these tokens, so the call transfers 0 tokens to the distributor). `TokenDistributor.createERC20Distribution` passes `token.balanceOf(address(this))` to `_createDistribution`. Note that this is still 2,000,000 because we are in the `tokensToSend` hook.\n*   The supply of this distribution is calculated as `(args.currentTokenBalance - _storedBalances[balanceId]) = 2,000,000 - 1,000,000 = 1,000,000`.\n*   When the `tokensToSend` hook is exited (and the first transfer has finished), he can retrieve the tokens of the second distribution (that was created in the hook) to steal the 1,000,000 tokens of party B.\n\n### Recommended Mitigation Steps\n\nDo not allow reentrancy in these functions.\n\n**[merklejerk (PartyDAO) confirmed and commented](https://github.com/code-423n4/2022-09-party-findings/issues/120#issuecomment-1254239231):**\n > Very few legitimate ERC777s so we think the probability of this happening to a party is somewhat low. Also, it only impacts distributions for that token. However, we will be implementing a reentrancy guard to fix it.\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/120#issuecomment-1262875715):**\n > Agree that it does not seem very probable - but if 777 assets are distributed, it does appear to be a way of stealing from other users in the party and therefore High risk.\n\n**[0xble (PartyDAO) resolved](https://github.com/code-423n4/2022-09-party-findings/issues/120#issuecomment-1264678026):**\n > Resolved: https://github.com/PartyDAO/partybidV2/pull/132\n\n\n\n***\n\n## [[H-05] ArbitraryCallsProposal.sol and ListOnOpenseaProposal.sol safeguards can be bypassed by cancelling in-progress proposal allowing the majority to steal NFT](https://github.com/code-423n4/2022-09-party-findings/issues/153)\n_Submitted by 0x52_\n\nNote: PartyDAO acknowledges that \"canceling an InProgress proposal (mid-step) can leave the governance party in a vulnerable or undesirable state because there is no cleanup logic run during a cancel\" in the \"Known Issues / Topics\" section of the contest readme. I still believe that this vulnerability needs to be mitigated as it can directly lead to loss of user funds.\n\n### Impact\n\nMajority vote can abuse cancel functionality to steal an NFT owned by the party.\n\n### Proof of Concept\n\nArbitraryCallsProposal.sol implements the following safeguards for arbitrary proposals that are not unanimous:\n\n1.  Prevents the ownership of any NFT changing during the call. It does this by checking the the ownership of all NFTs before and after the call.\n\n2.  Prevents calls that would change the approval status of any NFT. This is done by disallowing the \"approve\" and \"setApprovalForAll\" function selectors.\n\nAdditionally ListOnOpenseaProposal.sol implements the following safeguards:\n\n1.  NFTs are first listed for auction on Zora so that if they are listed for a very low price then the auction will keep them from being purchased at such a low price.\n\n2.  At the end of the auction the approval is revoked when `\\_cleanUpListing` is called.\n\nThese safeguards are ultimately ineffective though. The majority could use the following steps to steal the NFT:\n\n1.  Create ListOnOpenseaProposal with high sell price and short cancel delay\n\n2.  Vote to approve proposal with majority vote\n\n3.  Execute first step of proposal, listing NFT on Zora auction for high price\n\n4.  Wait for Zora auction to end since the auction price is so high that no one will buy it\n\n5.  Execute next step, listing the NFT on Opensea. During this step the contract grants approval of the NFT to the Opensea contract\n\n6.  Wait for cancelDelay to expire\n\n7.  Call PartyGovernance.sol#cancel. This will immediately terminate the Opensea bypassing `\\_cleanUpListing` and keeping the approval to the Opensea contract.\n\n8.  Create ArbitraryCallsProposal.sol that lists the NFT on Opensea for virtually nothing. Since only approval selectors have been blacklisted and the NFT does not change ownership, the proposal does not need to be unanimous to execute.\n\n9.  Approve proposal and execute.\n\n10. Buy NFT.\n\n### Recommended Mitigation Steps\n\nWhen a proposal is canceled, it should call a proposal specific function that makes sure everything is cleaned up. NFTs delisted, approvals revoked, etc.\n\n**[merklejerk (PartyDAO) confirmed and commented](https://github.com/code-423n4/2022-09-party-findings/issues/153#issuecomment-1255135044):**\n > We will block calls to `opensea.validate()` in Arbitrary call proposals.\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/153#issuecomment-1262889443):**\n > Agree with High risk - in this scenario a majority owner could steal the asset from others in the party.\n\n**[0xble (PartyDAO) resolved](https://github.com/code-423n4/2022-09-party-findings/issues/153#issuecomment-1264688086):**\n > Resolved: https://github.com/PartyDAO/partybidV2/pull/139\n\n\n\n***\n\n## [[H-06]  A majority attack can steal precious NFT from the party by crafting and chaining two proposals](https://github.com/code-423n4/2022-09-party-findings/issues/277)\n_Submitted by Trust, also found by ladboy233 and Lambda_\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/proposals/ProposalExecutionEngine.sol#L116>\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/proposals/FractionalizeProposal.sol#L54-L62>\n\n### Description\n\nThe PartyGovernance system has many defenses in place to protect against a majority holder stealing the NFT. Majority cannot exfiltrate the ETH gained from selling precious NFT via any proposal, and it's impossible to sell NFT for any asset except ETH. If the party were to be compensated via an ERC20 token, majority could pass an ArbitraryCallsProposal to transfer these tokens to an attacker wallet. Unfortunately, FractionalizeProposal is vulnerable to this attack. Attackers could pass two proposals and wait for them to be ready for execution. Firstly, a FractionalizeProposal to fractionalize the NFT and mint totalVotingPower amount of ERC20 tokens of the created vault. Secondly, an ArbitraryCallsProposal to transfer the entire ERC20 token supply to an attacker address. At this point, attacker can call `vault.redeem()` to burn the outstanding token supply and receive the NFT back.\n\n### Impact\n\nA 51% majority could steal the precious NFT from the party and leave it empty.\n\n### Proof of Concept\n\nThe only non-trivial component of this attack is that the created vault, whose tokens we wish to transfer out, has an undetermined address until `VAULT_FACTORY.mint()` is called, which creates it. The opcode which creates the vault contract is CREATE, which calculates the address with `keccak256(VAULT_FACTORY, nonce)`. Nonce will keep changing while new, unrelated NFTs are fractionalized. The attack needs to prepare both FractionalizedProposal and ArbitraryCallsProposal ahead of time, so that they could be chained immediately, meaning there would be no time for other members to call `distribute()` on the party, which would store the fractionalized tokens safely in the distributor.\nIn order to solve this chicken and the egg problem, we will use a technique taken from traditional low-level exploitation called heap feng shui.\n\nFirstly, calculate off-chain, the rate new NFTs are fractionalized, and multiple by a safety factor (like 1.2X), and multiply again by the proposal execution delay. This number, added to the current `VAULT_FACTORY` nonce, will be our `target_nonce`. Calculate `target_vault = keccak256(VAULT_FACTORY, target_nonce)`, `before_target_vault = keccak256(VAULT_FACTORY, target_nonce-1)`\n\nFirstly, we will create a contract which has an attack function that:\n\n1.  Loop while before_target_vault != created_vault:\n    • Mint new dummy attacker_NFT\n    • created_vault = VAULT_FACTORY.mint(attacker_NFT…)\n2.  `Call execute()` on the FractionalizedProposal  // We will feed the execute() parameters to the contract in a separate contract setter. Note that this is guaranteed to create target_vault on the correct address.\n3.  `Call execute()` on the ArbitraryCallsProposal\n\nThen, we propose the two proposals:\n\n1.  Propose a FractionalizedProposal, with any list price and the precious NFT as parameter\n2.  Propose an ArbitraryCallsProposal, with target = target_vault, data = transfer(ATTACKER, totalVotingPower)\n\nThen, we set the `execute()` parameters passed in step 2 and 3 of the attack contract using the proposalID allocated for them.\n\nThen, we wait for execution delay to finish.\n\nFinally, run the `attack()` function prepared earlier. This will increment the `VAULT_FACTORY` nonce until it is the one we count on during the ArbitraryCallsProposal. Pass enough gas to be able to burn enough nonces.\n\nAt this point, attacker has all the vault tokens, so he may call vault.redeem() and receive the precious NFT.\n\n### Recommended Mitigation Steps\n\n1.  Enforce a minimum cooldown between proposals. This will mitigate additional weaknesses of the proposal structure. Here, this will give users the opportunity to call `distribute()` to put the vault tokens safe in distributor.\n2.  A specific fix here would be to call `distribute()` at the end of FractionalizeProposal so that there is no window to steal the funds.\n\n**[merklejerk (PartyDAO) confirmed and commented](https://github.com/code-423n4/2022-09-party-findings/issues/277#issuecomment-1254233443):**\n > Will fix by creating an automatic distribution at the end of a successful fractionalize proposal.\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/277#issuecomment-1263543589):**\n > Agree with High risk - this scenario allows a majority owner to steal from others in the party.\n\n**[0xble (PartyDAO) resolved](https://github.com/code-423n4/2022-09-party-findings/issues/277#issuecomment-1264677841):**\n > Resolved: https://github.com/PartyDAO/partybidV2/pull/131\n\n\n\n***\n\n## [[H-07] Attacker can DOS private party by donating ETH then calling buy](https://github.com/code-423n4/2022-09-party-findings/issues/196)\n_Submitted by 0x52_\n\nParty is DOS'd and may potentially lose access to NFT.\n\n### Proof of Concept\n\n[Crowdfund.sol#L280-L298](https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L280-L298)\n\n    party = party_ = partyFactory\n        .createParty(\n            address(this),\n            Party.PartyOptions({\n                name: name,\n                symbol: symbol,\n                governance: PartyGovernance.GovernanceOpts({\n                    hosts: governanceOpts.hosts,\n                    voteDuration: governanceOpts.voteDuration,\n                    executionDelay: governanceOpts.executionDelay,\n                    passThresholdBps: governanceOpts.passThresholdBps,\n                    totalVotingPower: _getFinalPrice().safeCastUint256ToUint96(),\n                    feeBps: governanceOpts.feeBps,\n                    feeRecipient: governanceOpts.feeRecipient\n                })\n            }),\n            preciousTokens,\n            preciousTokenIds\n        );\n\n[BuyCrowdfundBase.sol#L166-L173](https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/BuyCrowdfundBase.sol#L166-L173)\n\n    function _getFinalPrice()\n        internal\n        override\n        view\n        returns (uint256)\n    {\n        return settledPrice;\n    }\n\nWhen BuyCrowdFund.sol successfully completes a buy, totalVotingPower is set to `\\_getFinalPrice` which in the case of BuyCrowdFundBase.sol returns the price at which the NFT was purchased. totalVotingPower is used by the governance contract to determine the number of votes needed for a proposal to pass. If there are not enough claimable votes to meet that threshold then the party is softlocked because it can't pass any proposals. An attacker could exploit this to DOS even a private party with the following steps:\n\n1.  Wait for party to be filled to just under quorum threshold\n2.  Donate ETH to the crowdfund contract\n3.  Call BuyCrowdFund.sol#buy. Since it is unpermissioned even for parties with a gatekeeper, the call won't revert\n\nSince the voting power for the final amount of ETH cannot be claimed, the party is now softlocked. If emergencyExecuteDisabled is true then the party will be permanantly locked and the NFT would effectively be burned. If emergencyExecuteDisabled is false then users would have to wait for PartyDAO to reclaim the NFT.\n\n### Recommended Mitigation Steps\n\nPermission to call BuyCrowdFund.sol#buy should be gated if there is a gatekeeper.\n\n**[merklejerk (PartyDAO) confirmed and commented](https://github.com/code-423n4/2022-09-party-findings/issues/196#issuecomment-1255178995):**\n > Theoretically possible but there doesn't seem to be much upside for the attacker. We do think it's unusual that buy()/bid() can be called by a non-member for a private/gatekept party, so we will add gatekeeping logic there to fix this. We will also cap the callValue (and therefore final price) to `totalContributions`.\n\n**[0xble (PartyDAO) resolved](https://github.com/code-423n4/2022-09-party-findings/issues/196#issuecomment-1264679039):**\n > Resolved: https://github.com/PartyDAO/partybidV2/pull/133\n\n**[HardlyDifficult (judge) increased severity to High and commented](https://github.com/code-423n4/2022-09-party-findings/issues/196#issuecomment-1266670432):**\n > Although it's without upside, it is a path for the attacker to potentially lock the NFT. Since it can cause a loss of asset for users, this seems to be a High risk issue.\n> \n> Let me know if I misunderstood.\n\n**[merklejerk (PartyDAO) commented](https://github.com/code-423n4/2022-09-party-findings/issues/196#issuecomment-1267180017):**\n > ~Don't consider it high because there is a much more straightforward way to softlock a party: contribute normally and don't ever participate in governance.~ Oh nvm, this is the private party one. Yeah I'm fine with high.\n\n\n\n***\n\n \n# Medium Risk Findings (12)\n## [[M-01] Attacker can list an NFT they own and inflate to zero all users' contributions, keeping the NFT and all the money](https://github.com/code-423n4/2022-09-party-findings/issues/213)\n_Submitted by Trust, also found by smiling\\_heretic_\n\nCrowdfunds split the voting power and distribution of profits rights according to the percentage used to purchase the NFT. When an attacker lists his own NFT for sale and contributes to it, any sum he contributes will return to him once the sell is executed. This behavior is fine so long as the sell price is fair, as other contributors will receive a fair portion of voting power and equity.  Therefore, when a maximum price is defined, it is not considered a vulnerability that an attacker can contribute `maximumPrice - totalContributions` and take a potentially large stake of the Crowdfund, as user's have contributed knowing the potential maximum price.\n\nHowever, when maximum price is zero, which is allowed in BuyCrowdfund and CollectionBuyCrowdfund, the lister of the NFT can always steal the entirety of the fund and keep the NFT. Attacker can send a massive contribution, buy the NFT and pass a unanimous proposal to approve the NFT to his wallet. Attacker can use a flash loan to finance the initial contribution, which is easily paid back from the NFT lister wallet.\n\nIt is important to note that there is no way for the system to know if the Crowdfund creator and the NFT owner are the same entity, and therefore it is critical for the platform to defend users against this scenario.\n\n### Impact\n\nAny crowdfund with zero maximumPrice configured is subject to NFT lister rug pull and complete takeover of the contribution funds.\n\n### Proof of Concept\n\n1.  Suppose totalContributions=X. Attacker will prepare flashloan callback which does:\n    *   `contribute()` with the borrowed funds\n    *   call BuyCrowdfund's `buy()` with a contract that will purchase the NFT using the large sum\n    *   call NFT lister contract's sendProfit() function which will send attacker the NFT sell amount\n    *   pay back the flash loan\n2.  Attacker will call flashloan(10,000X) to buy his own NFT and take unanimous holding of created party\n3.  Attacker will create ArbitraryCallsProposal with a single call to token.approve(ATTACKER, token_id). It is immediately ready for execution because attacker has > 99.99% of votes. Precious approve() is allowed in unanimous proposals.\n4.  Attacker calls NFT's `transferFrom()` to take back control of the NFT, leaving with the Crowdfund's contribution and the listed NFT.\n\n### Recommended Mitigation Steps\n\nDisable the option to have unlimited maximumPrice for BuyCrowdfund and CollectionBuyCrowdfund contracts. AuctionCrowdfund is already safe by not allowing a zero maximumBid.\n\n\n**[merklejerk (PartyDAO) commented](https://github.com/code-423n4/2022-09-party-findings/issues/213#issuecomment-1254016870):**\n > Duplicate of [#17](https://github.com/code-423n4/2022-09-party-findings/issues/17) \n\n**[HardlyDifficult (judge) decreased severity to QA and commented](https://github.com/code-423n4/2022-09-party-findings/issues/213#issuecomment-1272553754):**\n > See dupe for context. Merging with [#198](https://github.com/code-423n4/2022-09-party-findings/issues/198).\n\n**[Trust (warden) commented](https://github.com/code-423n4/2022-09-party-findings/issues/213#issuecomment-1274201301):**\n > TBH I don't see enough resemblance to #17 for it to be dupped. This submission discusses specifically maximumPrice = 0 which allows attacker to always claim the entire contribution pool to themselves. Would appreciate a second look.\n> @HardlyDifficult \n> disclaimer - this is my submission.\n\n**[HardlyDifficult (judge) increased severity to Medium and commented](https://github.com/code-423n4/2022-09-party-findings/issues/213#issuecomment-1274662744):**\n> Yes that is fair. This seems to fall under the known issue \"It is possible that someone could manipulate parties by contributing ETH and then buying their NFT that they own.\" - although an extreme example and a unique take on that scenario. However given the apparent ease and impact of this attack it seems we can bump this to Medium risk - would be high if not for the general known issue here.\n\n**[smiling\\_heretic (warden) commented](https://github.com/code-423n4/2022-09-party-findings/issues/213#issuecomment-1275265841):**\n > The same is true for [206](https://github.com/code-423n4/2022-09-party-findings/issues/206) (disclaimer: it's my submission) so I think it should be marked as duplicate of this finding and also upgraded to medium. \n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/213#issuecomment-1275269089):**\n > Agree, thanks @SmilingHeretic.\n\n\n\n***\n\n## [[M-02] Previously nominated delegate can reset the delegation](https://github.com/code-423n4/2022-09-party-findings/issues/361)\n_Submitted by hyh_\n\n`burn()` allows for previously recorded delegate to set himself to be contributor's delegate even if another one was already chosen.\n\nThis can be quite material as owner choice for the whole voting power is being reset this way to favor the old delegate.\n\n### Proof of Concept\n\n`\\_burn()` can be invoked by anyone on the behalf of any `contributor`:\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L167-L171>\n\n```solidity\n    function burn(address payable contributor)\n        public\n    {\n        return _burn(contributor, getCrowdfundLifecycle(), party);\n    }\n```\n\nIt mints the governance NFT for the contributor whenever he has voting power:\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L471-L485>\n\n```solidity\n        if (votingPower > 0) {\n            // Get the address to delegate voting power to. If null, delegate to self.\n            address delegate = delegationsByContributor[contributor];\n            if (delegate == address(0)) {\n                // Delegate can be unset for the split recipient if they never\n                // contribute. Self-delegate if this occurs.\n                delegate = contributor;\n            }\n            // Mint governance NFT for the contributor.\n            party_.mint(\n                contributor,\n                votingPower,\n                delegate\n            );\n        }\n```\n\nNow `mint()` calls `\\_adjustVotingPower()` with a new delegate, redirecting all the intristic power, not just one for that id, ignoring the delegation the `owner` might already have:\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernanceNFT.sol#L120-L133>\n\n```solidity\n    function mint(\n        address owner,\n        uint256 votingPower,\n        address delegate\n    )\n        external\n        onlyMinter\n        onlyDelegateCall\n    {\n        uint256 tokenId = ++tokenCount;\n        votingPowerByTokenId[tokenId] = votingPower;\n        _adjustVotingPower(owner, votingPower.safeCastUint256ToInt192(), delegate);\n        _mint(owner, tokenId);\n    }\n```\n\nI.e. Bob the contributor can take part in the crowdfunding with `contribute()` with small `0.01 ETH` stake, stating Mike as the delegate of his choice with `contribute(Mike, ...)`:\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L189-L208>\n\n```solidity\n    /// @param delegate The address to delegate to for the governance phase.\n    /// @param gateData Data to pass to the gatekeeper to prove eligibility.\n    function contribute(address delegate, bytes memory gateData)\n        public\n        payable\n    {\n        _contribute(\n            msg.sender,\n            msg.value.safeCastUint256ToUint96(),\n            delegate,\n            // We cannot use `address(this).balance - msg.value` as the previous\n            // total contributions in case someone forces (suicides) ETH into this\n            // contract. This wouldn't be such a big deal for open crowdfunds\n            // but private ones (protected by a gatekeeper) could be griefed\n            // because it would ultimately result in governance power that\n            // is unattributed/unclaimable, meaning that party will never be\n            // able to reach 100% consensus.\n            totalContributions,\n            gateData\n        );\n```\n\nThen crowdfund was a success, party was created, and Melany, who also participated, per off-chain arrangement has transferred to Bob a `tokenId` with big voting power (say it is `100 ETH` and the majority of voting power):\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernanceNFT.sol#L146-L155>\n\n```solidity\n    /// @inheritdoc ERC721\n    function safeTransferFrom(address owner, address to, uint256 tokenId)\n        public\n        override\n        onlyDelegateCall\n    {\n        // Transfer voting along with token.\n        _transferVotingPower(owner, to, votingPowerByTokenId[tokenId]);\n        super.safeTransferFrom(owner, to, tokenId);\n    }\n```\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernance.sol#L879-L887>\n\n```solidity\n    // Transfers some voting power of `from` to `to`. The total voting power of\n    // their respective delegates will be updated as well.\n    function _transferVotingPower(address from, address to, uint256 power)\n        internal\n    {\n        int192 powerI192 = power.safeCastUint256ToInt192();\n        _adjustVotingPower(from, -powerI192, address(0));\n        _adjustVotingPower(to, powerI192, address(0));\n    }\n```\n\nBob don't care about his early small contribution and focuses on managing the one that Melany transferred instead as he simply doesn't need the voting power from the initial `0.01 ETH` contribution anymore.\n\nThe actual delegate for Bob at the moment is Linda, while his business with Mike is over. So Bob sets her address there, calling `delegateVotingPower(Linda)`:\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernance.sol#L448-L454>\n\n```solidity\n    /// @notice Pledge your intrinsic voting power to a new delegate, removing it from\n    ///         the old one (if any).\n    /// @param delegate The address to delegating voting power to.\n    function delegateVotingPower(address delegate) external onlyDelegateCall {\n        _adjustVotingPower(msg.sender, 0, delegate);\n        emit VotingPowerDelegated(msg.sender, delegate);\n    }\n```\n\nNow, Mike can unilaterally delegate to himself the whole voting power with `burn(Bob)` as mint() just resets the delegation with the previously recorded value with `_adjustVotingPower(owner, votingPower.safeCastUint256ToInt192(), delegate)`.\n\n### Recommended Mitigation Steps\n\nThe issue is that `mint()` always assumes that it is the first operation for the `owner`, which might not always be the case.\n\nConsider not changing the delegate on `mint` if one is set already:\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernanceNFT.sol#L120-L133>\n\n```solidity\n    function mint(\n        address owner,\n        uint256 votingPower,\n        address delegate\n    )\n        external\n        onlyMinter\n        onlyDelegateCall\n    {\n        uint256 tokenId = ++tokenCount;\n        votingPowerByTokenId[tokenId] = votingPower;\n+       address actualDelegate = <get_current_delegate>;\n+       if (actualDelegate == address(0)) actualDelegate = delegate;\n-       _adjustVotingPower(owner, votingPower.safeCastUint256ToInt192(), delegate);\n+       _adjustVotingPower(owner, votingPower.safeCastUint256ToInt192(), actualDelegate);\n        _mint(owner, tokenId);\n    }\n```\n\nMore complicated version might be the one with tracking the most recent request via `contribute()/delegateVotingPower()` calls timestamps. Here we assume that the `delegateVotingPower()` holds more information as in the majority of practical cases it occurs after initial `contribute()` and it is a direct voluntary call from the owner.\n\n**[merklejerk (PartyDAO) confirmed, but disagreed with severity and commented](https://github.com/code-423n4/2022-09-party-findings/issues/361#issuecomment-1255353936):**\n > Unusual and interesting, but we think this should be Medium risk since the setup is somewhat exotic and still not a guarantee that assets would be at risk. We will implement the fix suggested.\n\n**[HardlyDifficult (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-09-party-findings/issues/361#issuecomment-1262817269):**\n > Agree with downgrading to Medium risk. This scenario can result in redirecting voting power to the wrong account, but is a nuanced scenario that would be difficult to target as an attack.\n\n**[0xble (PartyDAO) resolved](https://github.com/code-423n4/2022-09-party-findings/issues/361#issuecomment-1264679379):**\n > Resolved: https://github.com/PartyDAO/partybidV2/pull/134\n\n\n\n***\n\n## [[M-03] Only part of `keccak256()` is used as hash, making it susceptible to collision attacks](https://github.com/code-423n4/2022-09-party-findings/issues/231)\n_Submitted by 0xA5DF, also found by Lambda and V\\_B_\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L275>\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L325>\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/distribution/TokenDistributor.sol#L26>\n\n### Vulnerability Details\n\nAt 2 places in the code only part of the output of `keccak256()` is used as the hash:\n\n*   At `TokenDistributor` - `DistributionState.distributionHash15` - uses only a 15 bytes as a hash\n    *   This one is intended to save storage\n*   At `Crowdfund.governanceOptsHash` a 16 bytes is used as hash\n    *   This one has no benefit at all as it doesn't save on storage\n\n15/16 bytes hash is already not very high to begin with (as explained below). On top of that, using a non standard hash can be unsafe. Since diverging from the standard can break things.\n\n### Impact\n\nFor the `FixedGovernanceOpts` an attacker can create a legitimate party, and then when running `buy()` use the malicious hash to:\n\n*   include himself in the hosts (DoS-ing the party by vetoing every vote)\n*   reduce the `passThresholdBps` (allowing him to pass any vote, including sending funds from the Party)\n*   Setting himself as `feeRecipient` and increasing the fee\n\nFor the `DistributionInfo` struct - an attacker can easily drain all funds from the token distribution contract, by using the legitimate hash to create a distribution with a malicious ERC20 token (and a malicious party contract), and then using the malicious hash to claim assets of a legitimate token.\n\n### Proof of Concept\n\n#### The attack\n\nUsing the birthday attack, for a 50% chance with a 15 bytes hash, the number of hashes needed to generate is 1.4e18 (`(ln(1/0.5) *2) ** 0.5 * (2 ** 60)`).\n\n*   For 16 bytes that would be 2.2e19\n\nAn attacker can create 2 different structs, a legitimate and a malicious one, while modifying at each iteration only the last bits\n\n*   For the `FixedGovernanceOpts` the last bits would be the `feeRecipient` field\n*   For the `DistributionInfo` struct that would be the `fee` field (and then exploit it via the `claim()` function which doesn't validate the `fee` field)\n\nThe attacker will than generate half of the hashes from the malicious one, and half from the legitimate ones, so in case of a collision there's a 50% chance it'd be between the legitimate and malicious struct.\n\n#### CPU\n\n*   In the `DistributionInfo` we have 224 bytes (and for `FixedGovernanceOpts` 192 bytes if we precalculate the hosts hash)\n\n*   A computer needs about 11 cycles per byte\n\n*   An avg home PC can do \\~3e9 cycles per seconds\n\n*   There are \\~8.6e4 seconds a day\n\n*   Putting it all together `1.4e18 * 11 * 224 / (3e9*8.6e4)` = \\~1.3e8\n\n*   Note that we can further optimize it (by 10 times at least), since we're using the same input and only modifying the last bits every time (the `fee` field)\n\n#### Storage\n\n32 &ast; 1.4e18 = \\~4.5e19 bytes is needed, while an affordable drive can be 8TB=\\~8e12 bytes.\nThat puts it about 5e6 times away from and affordable attack.\n\n#### Overall Risk\n\nThe calculations above are for basic equipment, an attacker can be spending more on equipment to get closer (I'd say you can easily multiply that by 100 for a medium size attacker + running the computations for more than one day).\nCombining that with the fact that a non-standard hash is used, and that in general hashes can have small vulnerabilities that lower a bit their strength - I'd argue it's not very safe to be \\~1e4 (for a medium size attacker; \\~1.5e5 for 16 bytes) away from a practical attack.\n\n### Recommended Mitigation Steps\n\nUse the standard, 32-bytes, output of `keccak256()`.\n\n**[merklejerk (PartyDAO) confirmed and commented](https://github.com/code-423n4/2022-09-party-findings/issues/231#issuecomment-1255266728):**\n > At first we dismissed this as being really impractical but the more we thought of what an attack would actually look like, the more practical (if still improbable) it would be. We will extend both hashes to full-width (32 bytes).\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/231#issuecomment-1262839129):**\n > Agree with Medium risk. This attack seems unlikely but may be within the realm of possible when high value is at stake.\n\n**[0xble (PartyDAO) resolved](https://github.com/code-423n4/2022-09-party-findings/issues/231#issuecomment-1264680753):**\n > Resolved: https://github.com/PartyDAO/partybidV2/pull/138\n\n\n\n***\n\n## [[M-04] NFT Owner can stuck Crowdfund user funds](https://github.com/code-423n4/2022-09-party-findings/issues/197)\n_Submitted by csanuragjain_\n\nConsider a scenario where few users contributed in auction but no one has placed any bid due to reason like NFT price crash etc. So there was 0 bid, the NFT owner could seize the crowdfund users fund until they pay a ransom amount as shown below.\n\n### Proof of Concept\n\n1.  NFT N auction is going on\n2.  CrowdFund users have contributed 100 amount for this auction\n3.  Bidding has not been done yet\n4.  A news came for this NFT owner which leads to crashing of this NFT price\n5.  CrowdFund users are happy that they have not bided and are just waiting for auction to complete so that they can get there refund\n6.  NFT owner realizing this blackmails the CrowdFund users to send him amount 50 or else he would send this worthless NFT to the Crowdfund Auction contract basically stucking all crowdfund users fund. CrowdFund users ignore this and simply wait for auction to end\n7.  Once auction completes [finalize function](https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/crowdfund/AuctionCrowdfund.sol#L196) is called\n\n<!---->\n\n    function finalize(FixedGovernanceOpts memory governanceOpts)\n            external\n            onlyDelegateCall\n            returns (Party party_)\n        {\n    ...\n     if (nftContract.safeOwnerOf(nftTokenId) == address(this)) {\n                if (lastBid_ == 0) {\n                    // The NFT was gifted to us. Everyone who contributed wins.\n                    lastBid_ = totalContributions;\n                    if (lastBid_ == 0) {\n                        // Nobody ever contributed. The NFT is effectively burned.\n                        revert NoContributionsError();\n                    }\n                    lastBid = lastBid_;\n                }\n                // Create a governance party around the NFT.\n                party_ = _createParty(\n                    _getPartyFactory(),\n                    governanceOpts,\n                    nftContract,\n                    nftTokenId\n                );\n                emit Won(lastBid_, party_);\n            } \n    ...\n    }\n\n8. Before calling finalize the lastBid was 0 since no one has bid on this auction but lets see what happens on calling finalize\n\n9. Since NFT owner has transferred NFT to this contract so below statement holds true and `lastBid\\_` is also 0 since no one has bidded\n\n<!---->\n\n    if (lastBid_ == 0) {\n                    lastBid_ = totalContributions;\n\n10. This means now `lastBid\\_` is changed to totalContributions which is 100 so crowdfund users funds will not be refunded and they will end up with non needed NFT.\n\n### Recommended Mitigation Steps\n\nRemove the line `lastBid\\_ = totalContributions;` and let it be the last bid amount which crowdfund users actually bided with.\n\n**[merklejerk (PartyDAO) disputed and commented](https://github.com/code-423n4/2022-09-party-findings/issues/197#issuecomment-1254404973):**\n > This is working as designed. Contributors to a crowdfund essentially enter an agreement to pay up to a maximum price of their combined contributions for an NFT.\n\n**[csanuragjain (warden) commented](https://github.com/code-423n4/2022-09-party-findings/issues/197#issuecomment-1257223437):**\n > @merklejerk But in this case it is not \"up to a maximum price\" but rather always the maximum price using the PoC.\n\n**[merklejerk (PartyDAO) confirmed and commented](https://github.com/code-423n4/2022-09-party-findings/issues/197#issuecomment-1257279270):**\n> Hmm. I reread the PoC and now I'm converting this to confirmed. The real issue here is not so much that the party is paying maximum price, but that the party did not ever bid on the item but also paid maximum price. :facepalm: \n\n**[merklejerk (PartyDAO) disagreed with severity and commented](https://github.com/code-423n4/2022-09-party-findings/issues/197#issuecomment-1257281234):**\n > Still disagree with severity since this is unlikely to happen with a legitimate collection. It should be Medium at most.\n\n**[HardlyDifficult (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-09-party-findings/issues/197#issuecomment-1263529444):**\n > Agree with Medium risk here. This could be a violation of party user expectations since auctions generally target the min possible bid - a form of leaking value.\n\n**[0xble (PartyDAO) resolved](https://github.com/code-423n4/2022-09-party-findings/issues/197#issuecomment-1264679164):**\n > Resolved: https://github.com/PartyDAO/partybidV2/pull/133\n\n\n\n***\n\n## [[M-05] The settledPrice maybe exceed maximumPrice](https://github.com/code-423n4/2022-09-party-findings/issues/201)\n_Submitted by bin2chen_\n\n`BuyCrowdfundBase.sol \\_buy()`\nWhen callValue = 0 is settledPrice to totalContributions ignoring whether totalContributions > maximumPrice\nresulting in the minimum proportion of participants expected to become smaller\n\n### Proof of Concept\n\n        function _buy(\n            IERC721 token,\n            uint256 tokenId,\n            address payable callTarget,\n            uint96 callValue,\n            bytes calldata callData,\n            FixedGovernanceOpts memory governanceOpts\n        )\n        ...\n                settledPrice_ = callValue == 0 ? totalContributions : callValue;  //**** not check totalContributions>maximumPrice****//\n                if (settledPrice_ == 0) {\n                    // Still zero, which means no contributions.\n                    revert NoContributionsError();\n                }\n                settledPrice = settledPrice_;    \n\n(AuctionCrowdfund.sol finalize()  similar)\n\n### Recommended Mitigation Steps\n\nadd check\n\n        function _buy(\n            IERC721 token,\n            uint256 tokenId,\n            address payable callTarget,\n            uint96 callValue,\n            bytes calldata callData,\n            FixedGovernanceOpts memory governanceOpts\n        )\n        ...\n                settledPrice_ = callValue == 0 ? totalContributions : callValue;\n                if (settledPrice_ == 0) {\n                    // Still zero, which means no contributions.\n                    revert NoContributionsError();\n                }\n\n    +++         if (maximumPrice_ != 0 && settledPrice_ > maximumPrice_) {\n    +++                settledPrice_ = maximumPrice_;\n    +++         }\n\n                settledPrice = settledPrice_;    \n\n**[merklejerk (PartyDAO) confirmed and commented](https://github.com/code-423n4/2022-09-party-findings/issues/201#issuecomment-1255183114):**\n > We will cap the callValue to maximumPrice.\n\n**[0xble (PartyDAO) resolved](https://github.com/code-423n4/2022-09-party-findings/issues/201#issuecomment-1264678963):**\n > Resolved: https://github.com/PartyDAO/partybidV2/pull/133\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/201#issuecomment-1266706257):**\n > This is a potential violation of user expectations - agree with Medium risk.\n\n\n\n***\n\n## [[M-06] AuctionCrowdfund: If the contract was bid on before the NFT was gifted to the contract, lastBid will not be totalContributions](https://github.com/code-423n4/2022-09-party-findings/issues/147)\n_Submitted by cccz_\n\nIn the finalize function of the AuctionCrowdfund contract, when the contract gets NFT and lastBid\\_ == 0, it is considered that NFT is gifted to the contract and everyone who contributed wins.\n\n            if (nftContract.safeOwnerOf(nftTokenId) == address(this)) {\n                if (lastBid_ == 0) {\n                    // The NFT was gifted to us. Everyone who contributed wins.\n                    lastBid_ = totalContributions;\n\nBut if the contract was bid before the NFT was gifted to the contract, then since lastBid\\_ ! = 0, only the user who contributed at the beginning will win.\n\n### Proof of Concept\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/AuctionCrowdfund.sol#L233-L242>\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/AuctionCrowdfund.sol#L149-L175>\n\n### Recommended Mitigation Steps\n\nWhether or not NFT is free to get should be determined using whether the contract balance is greater than totalContributions.\n\n**[merklejerk (PartyDAO) confirmed and commented](https://github.com/code-423n4/2022-09-party-findings/issues/147#issuecomment-1254403120):**\n > Gifted NFTs are expected to be an extremely exceptional (if ever) case, but we do want to make a best effort to make these situations somewhat fair to contributors.  We will implement the recommendation and check that `this.balance >= totalContributions` to see if the NFT was acquired for free.\n\n**[0xble (PartyDAO) resolved](https://github.com/code-423n4/2022-09-party-findings/issues/147#issuecomment-1264678161):**\n > Resolved: https://github.com/PartyDAO/partybidV2/pull/133\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/147#issuecomment-1267170378):**\n > This could be seen as a form of leaking value, agree with Medium risk.\n\n\n\n***\n\n## [[M-07] Attacker can force AuctionCrowdfunds to bid their entire contribution up to maxBid](https://github.com/code-423n4/2022-09-party-findings/issues/220)\n_Submitted by Trust, also found by cccz_\n\nAuctionCrowdfund's `bid()` allows any user to compete on an auction on the party's behalf. The code in `bid()` forbids placing a bid if party is already winning the auction:\n\n    if (market.getCurrentHighestBidder(auctionId_) == address(this)) {\n                revert AlreadyHighestBidderError();\n            }\n\nHowever, it does not account for attackers placing bids from their own wallet, and then immediately overbidding them using the party's funds. This can be used in two ways:\n\n1.  Attacker which lists an NFT, can force the party to spend all its funds up to maxBid on the auction, even if the party could have purchased the NFT for much less.\n2.  Attackers can grief random auctions, making them pay the absolute maximum for the item. Attackers can use this to drive the prices of NFT items up, profiting from this using secondary markets.\n\n### Impact\n\nParties can be stopped from buying items at a good value without any risk to the attacker.\n\n### Proof of Concept\n\n1.  Attacker places an NFT for sale, valued at X\n2.  Attacker creates an AuctionCrowdfund, with maxBid = Y such that Y = 2X\n3.  Current bid for the NFT is X - AUCTION_STEP\n4.  Users contribute to the fund, which now has 1.5X\n5.  Users call `bid()` to bid X  for the NFT\n6.  Attacker bids for the item externally for 1.5X - AUCTION_STEP\n7.  Attacker calls `bid()` to bid 1.5X for the NFT\n8.  Attacker sells his NFT for 1.5X although no one apart from the party was interested in buying it above price X\n\n### Recommended Mitigation Steps\n\nIntroduce a new option variable to AuctionCrowdfunds called speedBump. Inside the `bid()` function, calculate seconds since last bid, multiplied by the price change factor. This product must be smaller than the chosen speedBump. Using this scheme, the protocol would have resistance to sudden bid spikes. Optionally, allow a majority funder to override the speed bump.\n\n**[merklejerk (PartyDAO) acknowledged and commented](https://github.com/code-423n4/2022-09-party-findings/issues/220#issuecomment-1254406481):**\n > This is a known limitation of crowdfunds. We will allow some parties to restrict who can call `buy()` or `bid()` to hosts, which will mitigate this.\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/220#issuecomment-1267209362):**\n > This is a fair concern, a form of potentially leaking value so agree with Medium risk. Not sure I agree with the recommendation here, but restricting to hosts does help mitigate by putting risk on the attacker.\n\n**[0xble (PartyDAO) confirmed and resolved](https://github.com/code-423n4/2022-09-party-findings/issues/220#issuecomment-1276604774):**\n > Mitigated by: https://github.com/PartyDAO/partybidV2/pull/140\n\n\n\n***\n\n## [[M-08] Early contributor can always become majority of crowdfund leading to rugging risks.](https://github.com/code-423n4/2022-09-party-findings/issues/284)\n_Submitted by Trust, also found by cccz and rvierdiiev_\n\nVoting power is distributed to crowdfund contributors according to the amount contributed divided by NFT purchase price. Attacker can call the `buy()` function of BuyCrowdfund / CollectionBuyCrowdfund, and use only the first X amount of contribution from the crowdfund, such that attacker's contribution > X/2. He will pass his contract to the buy call, which will receive X and will need to add some additional funds, to purchase the NFT. If the purchase is successful, attacker will have majority rule in the created party. If the party does not do anything malicious, this is a losing move for attacker, because the funds they added on top of X to compensate for the NFT price will eventually be split between group members. However, with majority rule there are various different exploitation vectors attacker may use to steal the NFT from the party ( detailed in separate reports). Because it is accepted that single actor majority is dangerous, but without additional vulnerabilities attacker cannot take ownership of the party's assets, I classify this as a Medium. The point is that users were not aware they could become minority under this attack flow.\n\n### Impact\n\nEarly contributor can always become majority of crowdfund leading to rugging risks.\n\n### Proof of Concept\n\n1.  Victim A opens BuyCrowdfund and deposits 20 ETH\n\n2.  Attacker deposits 30 ETH\n\n3.  Victim B deposits 50 ETH\n\n4.  Suppose NFT costs 100 ETH\n\n5.  Attacker will call `buy()`, requesting 59ETH buy price. His contract will add 41 additional ETH and buy the NFT.\n\n6.  Voting power distributed will be: 20 / 59 for Victim A, 30 / 59 for Attacker, 9 / 59 for Victim B. Attacker has majority.\n\n7.  User can use some majority attack to take control of the NFT, netting 100 (NFT value) - 41 (external contribution) - 30 (own contribution) = 29 ETH\n\n\n### Recommended Mitigation Steps\n\nAdd a Crowdfund property called minimumPrice, which will be visible to all. `Buy()` function should not accept NFT price < minimumPrice. Users now have assurances that are not susceptible to majority rule if they deposited enough ETH below the minimumPrice.\n\n**[merklejerk (PartyDAO) acknowledged and commented](https://github.com/code-423n4/2022-09-party-findings/issues/284#issuecomment-1256420138):**\n > We want to avoid requiring a minimum price for now as it's difficult to choose a value that would allow a crowdfund to respond to price drops as well as price increases. Instead we're opting to harden defenses against majority attacks, which would minimize the desirability of this vector, and we're introducing optional host-only and gatekeeper restrictions on `buy()/bid()` functions. We will keep an eye out for this behavior and reassess if it comes up.\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/284#issuecomment-1268507970):**\n > Gifting can lead to incorrect voting power distribution. Agree with Medium risk.\n\n**[0xble (PartyDAO) confirmed and resolved](https://github.com/code-423n4/2022-09-party-findings/issues/284#issuecomment-1276602578):**\n > Mitigated by: https://github.com/PartyDAO/partybidV2/pull/140\n\n\n\n***\n\n## [[M-09] Calling `transferEth` function can revert if `receiver` input corresponds to a contract that is unable to receive ETH through its `receive` or `fallback` function](https://github.com/code-423n4/2022-09-party-findings/issues/212)\n_Submitted by rbserver, also found by CertoraInc, Jeiwan, and tonisives_\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/utils/LibAddress.sol#L8-L15>\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/crowdfund/Crowdfund.sol#L444-L489>\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/distribution/TokenDistributor.sol#L371-L388>\n\n### Impact\n\nThe following `transferEth` function is called when calling the `_burn` or `_transfer` function below. If the `receiver` input for the `transferEth` function corresponds to a contract, it is possible that the receiver contract does not, intentionally or unintentionally, implement the `receive` or `fallback` function in a way that supports receiving ETH or that calling the receiver contract's `receive` or `fallback` function executes complicated logics that cost much gas, which could cause calling `transferEth` to revert. For example, when calling `transferEth` reverts, calling `_burn` also reverts; this means that the receiver contract would not be able to get the voting power and receive the extra contribution it made after the crowdfunding finishes; yet, the receiver contract deserves these voting power and contribution refund. Hence, the receiver contract loses valuables that it deserves, which is unfair to the users who controls it.\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/utils/LibAddress.sol#L8-L15>\n\n```solidity\n    function transferEth(address payable receiver, uint256 amount)\n        internal\n    {\n        (bool s, bytes memory r) = receiver.call{value: amount}(\"\");\n        if (!s) {\n            revert EthTransferFailed(receiver, r);\n        }\n    }\n```\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/crowdfund/Crowdfund.sol#L444-L489>\n\n```solidity\n    function _burn(address payable contributor, CrowdfundLifecycle lc, Party party_)\n        private\n    {\n        // If the CF has won, a party must have been created prior.\n        if (lc == CrowdfundLifecycle.Won) {\n            if (party_ == Party(payable(0))) {\n                revert NoPartyError();\n            }\n        } else if (lc != CrowdfundLifecycle.Lost) {\n            // Otherwise it must have lost.\n            revert WrongLifecycleError(lc);\n        }\n        // Split recipient can burn even if they don't have a token.\n        if (contributor == splitRecipient) {\n            if (_splitRecipientHasBurned) {\n                revert SplitRecipientAlreadyBurnedError();\n            }\n            _splitRecipientHasBurned = true;\n        }\n        // Revert if already burned or does not exist.\n        if (splitRecipient != contributor || _doesTokenExistFor(contributor)) {\n            CrowdfundNFT._burn(contributor);\n        }\n        // Compute the contributions used and owed to the contributor, along\n        // with the voting power they'll have in the governance stage.\n        (uint256 ethUsed, uint256 ethOwed, uint256 votingPower) =\n            _getFinalContribution(contributor);\n        if (votingPower > 0) {\n            // Get the address to delegate voting power to. If null, delegate to self.\n            address delegate = delegationsByContributor[contributor];\n            if (delegate == address(0)) {\n                // Delegate can be unset for the split recipient if they never\n                // contribute. Self-delegate if this occurs.\n                delegate = contributor;\n            }\n            // Mint governance NFT for the contributor.\n            party_.mint(\n                contributor,\n                votingPower,\n                delegate\n            );\n        }\n        // Refund any ETH owed back to the contributor.\n        contributor.transferEth(ethOwed);\n        emit Burned(contributor, ethUsed, ethOwed, votingPower);\n    }\n```\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/distribution/TokenDistributor.sol#L371-L388>\n\n```solidity\n    function _transfer(\n        TokenType tokenType,\n        address token,\n        address payable recipient,\n        uint256 amount\n    )\n        private\n    {\n        bytes32 balanceId = _getBalanceId(tokenType, token);\n        // Reduce stored token balance.\n        _storedBalances[balanceId] -= amount;\n        if (tokenType == TokenType.Native) {\n            recipient.transferEth(amount);\n        } else {\n            assert(tokenType == TokenType.Erc20);\n            IERC20(token).compatTransfer(recipient, amount);\n        }\n    }\n```\n\n### Proof of Concept\n\nPlease add the following `error` and append the test in `sol-tests\\crowdfund\\BuyCrowdfund.t.sol`. This test will pass to demonstrate the described scenario.\n\n```solidity\n    error EthTransferFailed(address receiver, bytes errData);\n\n    function testContributorContractFailsToReceiveETH() public {\n        uint256 tokenId = erc721Vault.mint();\n        BuyCrowdfund pb = _createCrowdfund(tokenId, 0);\n\n        // This contract is used to simulate a contract that does not implement the receive or fallback function for the purpose of receiving ETH.\n        address payable contributorContract = payable(address(this));\n        vm.deal(contributorContract, 1e18);\n\n        address delegate = _randomAddress();\n\n        // contributorContract contributes 1e18.\n        vm.prank(contributorContract);\n        pb.contribute{ value: 1e18 }(delegate, \"\");\n\n        // The price of the NFT of interest is 0.5e18.\n        Party party_ = pb.buy(\n            payable(address(erc721Vault)),\n            0.5e18,\n            abi.encodeCall(erc721Vault.claim, (tokenId)),\n            defaultGovernanceOpts\n        );\n\n        // After calling the buy function, the party is created with the NFT.\n        assertEq(address(party), address(party_));\n        assertTrue(pb.getCrowdfundLifecycle() == Crowdfund.CrowdfundLifecycle.Won);\n        assertEq(pb.settledPrice(), 0.5e18);\n        assertEq(pb.totalContributions(), 1e18);\n        assertEq(address(pb).balance, 1e18 - 0.5e18);\n\n        // Calling the burn function reverts because contributorContract cannot receive ETH through the receive or fallback function\n        vm.expectRevert(abi.encodeWithSelector(\n            EthTransferFailed.selector,\n            contributorContract,\n            \"\"\n        ));\n        pb.burn(contributorContract);\n\n        // contributorContract does not receive 0.5e18 back from the BuyCrowdfund contract.\n        assertEq(contributorContract.balance, 0);\n    }\n```\n\n### Tools Used\n\nVSCode\n\n### Recommended Mitigation Steps\n\nWhen calling the `transferEth` function, if the receiver contract is unable to receive ETH through its `receive` or `fallback` function, WETH can be used to deposit the corresponding ETH amount, and the deposited amount can be transferred to the receiver contract.\n\n**[merklejerk (PartyDAO) confirmed and commented](https://github.com/code-423n4/2022-09-party-findings/issues/212#issuecomment-1255144719):**\n > We will mitigate this by escrowing the ETH refund and/or the governance NFT to be claimed by the contributor later (possibly to a different address) if either transfer fails.\n\n**[0xble (PartyDAO) resolved](https://github.com/code-423n4/2022-09-party-findings/issues/212#issuecomment-1264675601):**\n > Resolved: https://github.com/PartyDAO/partybidV2/pull/126\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/212#issuecomment-1268532848):**\n > A contract contributor may revert on `burn`, preventing full voting power distribution. Agree with Medium risk.\n\n\n\n***\n\n## [[M-10] Possible that unanimous votes is unachievable](https://github.com/code-423n4/2022-09-party-findings/issues/114)\n_Submitted by Lambda, also found by CertoraInc_\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/crowdfund/Crowdfund.sol#L370>\n\n<https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernance.sol#L1066>\n\n### Impact\n\nCurrently, the `votingPower` calculation rounds down for every user except the `splitRecipient`. This can cause situations where 99.99% of votes (i.e., an unanimous vote) are not achieved, even if all vote in favor of a proposal. This can be very bad for a party, as certain proposals (transferring precious tokens out) require an unanimous vote and are therefore not executable.\n\n### Proof Of Concept\n\nLet's say for the sake of simplicity that 100 persons contribute 2 wei and `splitBps` is 10 (1%). `votingPower` for all users that contributed will be 1 and 2 for the `splitRecipient`, meaning the maximum achievable vote percentage is 102 / 200 = 51%.\n\nOf course, this is an extreme example, but it shows that the current calculation can introduce siginificant rounding errors that impact the functionality of the protocol.\n\n### Recommended Mitigation Steps\n\nInstead of requiring more than 99.99% of the votes, ensure that the individual votingPower sum to the total contribution. For instance, one user (e.g., the last one to claim) could receive all the remaining votingPower, which would require a running sum of the already claimed votingPower.\n\n**[merklejerk (PartyDAO) acknowledged and commented](https://github.com/code-423n4/2022-09-party-findings/issues/114#issuecomment-1254203278):**\n > We consider it highly unlikely that an NFT would be crowdfunded for dust amounts so we don't think this would actually occur in the wild.\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/114#issuecomment-1268541357):**\n > Rounding error could prevent unanimous votes.. agree with Medium risk.\n\n\n\n***\n\n## [[M-11] Maximum bid will always be used in Auction](https://github.com/code-423n4/2022-09-party-findings/issues/179)\n_Submitted by csanuragjain, also found by Lambda_\n\nAuctionCrowdfund contract is designed in a way to allow bidding max upto maximumBid. But due to a flaw, anyone (including NFT seller) can make sure that CrowdFund bid always remain equal to maximumBid thus removing the purpose of maximumBid. This also causes loss to Party participating in this Auction as the auction will always end up with maximumBid even when it could have stopped with lower bid as shown in POC.\n\n### Proof of Concept\n\n1.  An auction is started for NFT N in the market\n2.  Party Users P1 starts an AuctionCrowdfund with maximumBid as 100 for this auction.\n\n<!---->\n\n    function initialize(AuctionCrowdfundOptions memory opts)\n            external\n            payable\n            onlyConstructor\n        {\n    ...\n    maximumBid = opts.maximumBid;\n    ...\n    }\n\n3.  P1 bids amount 10 for the NFT N using [bid function](https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/crowdfund/AuctionCrowdfund.sol#L149)\n4.  Some bad news arrives for the NFT collection including NFT N reducing its price\n5.  P1 decides not to bid more than amount 10 due to this news\n6.  NFT collection owner who is watching this AuctionCrowdfund observes that bidding is only 10 but Party users have maximumBid of 100\n7.  NFT collection owner  asks his friend to bid on this NFT in the auction market (different from crowd fund)\n8.  NFT collection owner now takes advantage of same and himself calls the bid function of AuctionCrowdfund via Proxy\n\n<!---->\n\n    function bid() external onlyDelegateCall {\n    ...\n    }\n\n9.  Now since last bid belongs to collection owner friend, so AuctionCrowdfund contract simply extends its bid further\n\n<!---->\n\n    if (market.getCurrentHighestBidder(auctionId_) == address(this)) {\n                revert AlreadyHighestBidderError();\n            }\n            // Get the minimum necessary bid to be the highest bidder.\n            uint96 bidAmount = market.getMinimumBid(auctionId_).safeCastUint256ToUint96();\n            // Make sure the bid is less than the maximum bid.\n            if (bidAmount > maximumBid) {\n                revert ExceedsMaximumBidError(bidAmount, maximumBid);\n            }\n            lastBid = bidAmount;\n\n10. NFT collection owner keeps repeating step 7-9 until AuctionCrowdfund reaches the final maximum bid of 100\n11. After auction completes, collection owner gets 100 amount instead of 10 even though crowd fund users never bidded for amount 100\n\n### Recommended Mitigation Steps\n\nmaximumbid concept can easily be bypassed as shown above and will not make sense. Either remove it completely\n\nOR\n\nbid function should only be callable via crowdfund members then attacker would be afraid if new bid will come or not and there should be a consensus between crowdfund members before bidding which will protect this scenario.\n\n**[merklejerk (PartyDAO) acknowledged and commented](https://github.com/code-423n4/2022-09-party-findings/issues/179#issuecomment-1255154999):**\n > While it doesn't solve it for all crowdfunds, we will allow some crowdfunds to restrict who can call their `bid()` function to host-only.\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/179#issuecomment-1269948984):**\n > This is a form of leaking value - agree with Medium risk.\n\n**[0xble (PartyDAO) confirmed and resolved](https://github.com/code-423n4/2022-09-party-findings/issues/179#issuecomment-1276607530):**\n > Mitigated by: https://github.com/PartyDAO/partybidV2/pull/140\n\n\n\n***\n\n## [[M-12] Excess eth is not refunded](https://github.com/code-423n4/2022-09-party-findings/issues/186)\n_Submitted by csanuragjain_\n\nThe ArbitraryCallsProposal contract requires sender to provide eth(msg.value) for each call. Now if user has provided more eth than combined call.value then this excess eth is not refunded back to user.\n\n### Proof of Concept\n\n1.  Observe the [\\_executeArbitraryCalls function](https://github.com/PartyDAO/party-contracts-c4/blob/main/contracts/proposals/ArbitraryCallsProposal.sol#L37)\n\n<!---->\n\n    function _executeArbitraryCalls(\n            IProposalExecutionEngine.ExecuteProposalParams memory params\n        )\n            internal\n            returns (bytes memory nextProgressData)\n        {\n\n    ...\n    uint256 ethAvailable = msg.value;\n            for (uint256 i = 0; i < calls.length; ++i) {\n                // Execute an arbitrary call.\n                _executeSingleArbitraryCall(\n                    i,\n                    calls[i],\n                    params.preciousTokens,\n                    params.preciousTokenIds,\n                    isUnanimous,\n                    ethAvailable\n                );\n                // Update the amount of ETH available for the subsequent calls.\n                ethAvailable -= calls[i].value;\n                emit ArbitraryCallExecuted(params.proposalId, i, calls.length);\n            }\n    ....\n    }\n\n2.  As we can see user provided msg.value is deducted with each calls\\[i].value\n3.  Assume user provided 5 amount as msg.value and made a single call with calls\\[0].value as 4\n4.  This means after calls have been completed ethAvailable will become 5-4=1\n5.  Ideally this 1 eth should be refunded back to user but there is no provision for same and the fund will remain in contract\n\n### Recommended Mitigation Steps\n\nAt the end of `\\_executeArbitraryCalls` function, refund the remaining ethAvailable back to the user.\n\n**[merklejerk (PartyDAO) confirmed and commented](https://github.com/code-423n4/2022-09-party-findings/issues/186#issuecomment-1255157023):**\n > Will refund unused ETH at the end of executing arbitrary calls.\n\n**[0xble (PartyDAO) resolved](https://github.com/code-423n4/2022-09-party-findings/issues/186#issuecomment-1264679434):**\n > Resolved: https://github.com/PartyDAO/partybidV2/pull/135\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/186#issuecomment-1269951162):**\n > This is a form of leaking value - agree with Medium risk.\n\n\n\n***\n\n\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 67 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-09-party-findings/issues/101) by **Lambda** received the top score from the judge.\n\n*The following wardens also submitted reports: [Ch\\_301](https://github.com/code-423n4/2022-09-party-findings/issues/293), [0xSmartContract](https://github.com/code-423n4/2022-09-party-findings/issues/125), [Chom](https://github.com/code-423n4/2022-09-party-findings/issues/254), [brgltd](https://github.com/code-423n4/2022-09-party-findings/issues/344), [0xNazgul](https://github.com/code-423n4/2022-09-party-findings/issues/280), [ayeslick](https://github.com/code-423n4/2022-09-party-findings/issues/84), [0x52](https://github.com/code-423n4/2022-09-party-findings/issues/191), [CodingNameKiki](https://github.com/code-423n4/2022-09-party-findings/issues/75), [CertoraInc](https://github.com/code-423n4/2022-09-party-findings/issues/261), [cryptphi](https://github.com/code-423n4/2022-09-party-findings/issues/308), [Trust](https://github.com/code-423n4/2022-09-party-findings/issues/198), [c3phas](https://github.com/code-423n4/2022-09-party-findings/issues/302), [Deivitto](https://github.com/code-423n4/2022-09-party-findings/issues/350), [R2](https://github.com/code-423n4/2022-09-party-findings/issues/122), [pfapostol](https://github.com/code-423n4/2022-09-party-findings/issues/151), [CRYP70](https://github.com/code-423n4/2022-09-party-findings/issues/250), [0xbepresent](https://github.com/code-423n4/2022-09-party-findings/issues/342), [0x1f8b](https://github.com/code-423n4/2022-09-party-findings/issues/209), [asutorufos](https://github.com/code-423n4/2022-09-party-findings/issues/317), [rvierdiiev](https://github.com/code-423n4/2022-09-party-findings/issues/47), [bulej93](https://github.com/code-423n4/2022-09-party-findings/issues/80), [hansfriese](https://github.com/code-423n4/2022-09-party-findings/issues/259), [ladboy233](https://github.com/code-423n4/2022-09-party-findings/issues/128), [RaymondFam](https://github.com/code-423n4/2022-09-party-findings/issues/59), [gogo](https://github.com/code-423n4/2022-09-party-findings/issues/158), [leosathya](https://github.com/code-423n4/2022-09-party-findings/issues/295), [pedr02b2](https://github.com/code-423n4/2022-09-party-findings/issues/347), [MiloTruck](https://github.com/code-423n4/2022-09-party-findings/issues/296), [csanuragjain](https://github.com/code-423n4/2022-09-party-findings/issues/182), [fatherOfBlocks](https://github.com/code-423n4/2022-09-party-findings/issues/160), [wagmi](https://github.com/code-423n4/2022-09-party-findings/issues/312), [bin2chen](https://github.com/code-423n4/2022-09-party-findings/issues/203), [lukris02](https://github.com/code-423n4/2022-09-party-findings/issues/228), [KIntern\\_NA](https://github.com/code-423n4/2022-09-party-findings/issues/248), [Funen](https://github.com/code-423n4/2022-09-party-findings/issues/313), [ReyAdmirado](https://github.com/code-423n4/2022-09-party-findings/issues/54), [0x5rings](https://github.com/code-423n4/2022-09-party-findings/issues/235), [Jeiwan](https://github.com/code-423n4/2022-09-party-findings/issues/188), [PaludoX0](https://github.com/code-423n4/2022-09-party-findings/issues/223), [ChristianKuri](https://github.com/code-423n4/2022-09-party-findings/issues/15), [smiling\\_heretic](https://github.com/code-423n4/2022-09-party-findings/issues/294), [\\_\\_141345\\_\\_](https://github.com/code-423n4/2022-09-party-findings/issues/200), [delfin454000](https://github.com/code-423n4/2022-09-party-findings/issues/260), [slowmoses](https://github.com/code-423n4/2022-09-party-findings/issues/219), [malinariy](https://github.com/code-423n4/2022-09-party-findings/issues/90), [cccz](https://github.com/code-423n4/2022-09-party-findings/issues/142), [Aymen0909](https://github.com/code-423n4/2022-09-party-findings/issues/325), [martin](https://github.com/code-423n4/2022-09-party-findings/issues/145), [The\\_GUILD](https://github.com/code-423n4/2022-09-party-findings/issues/352), [Anth3m](https://github.com/code-423n4/2022-09-party-findings/issues/51), [0xDanielC](https://github.com/code-423n4/2022-09-party-findings/issues/163), [erictee](https://github.com/code-423n4/2022-09-party-findings/issues/4), [0x4non](https://github.com/code-423n4/2022-09-party-findings/issues/328), [Tomo](https://github.com/code-423n4/2022-09-party-findings/issues/177), [JansenC](https://github.com/code-423n4/2022-09-party-findings/issues/168), [MasterCookie](https://github.com/code-423n4/2022-09-party-findings/issues/72), [djxploit](https://github.com/code-423n4/2022-09-party-findings/issues/236), [ch0bu](https://github.com/code-423n4/2022-09-party-findings/issues/55), [Olivierdem](https://github.com/code-423n4/2022-09-party-findings/issues/170), [tnevler](https://github.com/code-423n4/2022-09-party-findings/issues/318), [B2](https://github.com/code-423n4/2022-09-party-findings/issues/94), [StevenL](https://github.com/code-423n4/2022-09-party-findings/issues/66), [JC](https://github.com/code-423n4/2022-09-party-findings/issues/332), [V\\_B](https://github.com/code-423n4/2022-09-party-findings/issues/348), [indijanc](https://github.com/code-423n4/2022-09-party-findings/issues/322), and [d3e4](https://github.com/code-423n4/2022-09-party-findings/issues/338).*\n\n## Low Risk Issues\n\n- After a `FractionalizeProposal` was executed succesfully and the tokens were distributed, it will not be possible to get the NFT back by calling `redeem` in practice. This function requires that the sender (the party in this case) owns all tokens, which would require that all users transfer them back again. However, transferring them to the party would be very risky when you do not if all other participants also do that (as the tokens are lost when one user does not transfer them) and some users may have sold them. This behavior may be desired (although it is a bit against the general philosophy were the tokens are protected IMO), but it should be documented that this is a destructive action.\n\n- `FoundationMarketWrapper.auctionIdMatchesToken` returns `true` for auctionId 0 and `isFinalized` also returns `true`. Because of that, it is possible to create an auction with ID 0 where no one can bid because it is immediately finalized.\n\n- `ZoraMarketWrapper.auctionIDMatchesToken` returns `true` for auctionId 0 and `nftContract = address(0)`, and `isFinalized` als returns `true`. Because of that, it is possible to create an auction with ID 0 and `address(0)` where no one can bid because it is immediately finalized.\n\n- `BuyCrowdfund` cannot retrieve ETH, but certain contracts that are called by it (e.g., NFT marketplaces) might return additional ETH when too much is paid. In such scenarios, the whole transaction would fail.\n\n## Non-Critical Issues\n\n- In `PartyGovernance._getProposalStatus`, the constant `VETO_VALUE` is not used (https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernance.sol#L1033), whereas it is used when performing the veto (https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/party/PartyGovernance.sol#L634). While this is not a problem currently (the values are identical), it can be dangerous when this value is updated at one point, because updating `_getProposalStatus` might get forgotten. Consider using the constant consistently.\n\n- The link for FractionalizeProposal (https://github.com/PartyDAO/party-contracts-c4/blob/3896577b8f0fa16cba129dc2867aba786b730c1b/contracts/proposals/FractionalizeProposal.sol#L30) is wrong. It links to the source code of the vault, but the variable points to the factory. The correct link is https://github.com/fractional-company/contracts/blob/master/src/ERC721VaultFactory.sol\n\n- For Nouns, it is only possible to deploy the auction when the desired ID is for sale. However, it might be desired to create an auction in advance (e.g., for token ID 7 when the current ID is 5), such that there is more time to collect funds. For a system like Nouns this would work nicely, because it is (roughly) known in advance when an auction for a token will start.\n\n- `CrowdfundNFT`, the implementation of a soulbound NFT, is a bit too simplistic in my opinion. One problem with soulbound NFTs is wallet recovery. In such situations, you want to be able to transfer the NFT to another wallet (but of course, this should not be possible without prior checks, otherwise they would not be soulbound). There are different standards like [EIP 4671](https://eips.ethereum.org/EIPS/eip-4671) that address soulbound NFTs (and the mentioned problems), consider implementing one of them.\n\n\n**[0xble (PartyDAO) commented](https://github.com/code-423n4/2022-09-party-findings/issues/101#issuecomment-1257370626):**\n > The first two Non-Critical suggestions we'll change, the rest are interesting and we acknowledge them. Great suggestions overall.\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-09-party-findings/issues/101#issuecomment-1266689622):**\n > Merging with [109](https://github.com/code-423n4/2022-09-party-findings/issues/109), [103](https://github.com/code-423n4/2022-09-party-findings/issues/103), [106](https://github.com/code-423n4/2022-09-party-findings/issues/106), [108](https://github.com/code-423n4/2022-09-party-findings/issues/108), [115](https://github.com/code-423n4/2022-09-party-findings/issues/115), and [116](https://github.com/code-423n4/2022-09-party-findings/issues/116) which are all Low Risk issues.\n\n***\n\n# Gas Optimizations\n\nFor this contest, 82 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-09-party-findings/issues/272) by **CertoraInc** received the top score from the judge.\n\n*The following wardens also submitted reports: [m\\_Rassska](https://github.com/code-423n4/2022-09-party-findings/issues/301), [pfapostol](https://github.com/code-423n4/2022-09-party-findings/issues/97), [c3phas](https://github.com/code-423n4/2022-09-party-findings/issues/304), [JC](https://github.com/code-423n4/2022-09-party-findings/issues/331), [Deivitto](https://github.com/code-423n4/2022-09-party-findings/issues/346), [MiloTruck](https://github.com/code-423n4/2022-09-party-findings/issues/297), [ReyAdmirado](https://github.com/code-423n4/2022-09-party-findings/issues/53), [0xSmartContract](https://github.com/code-423n4/2022-09-party-findings/issues/126), [gogo](https://github.com/code-423n4/2022-09-party-findings/issues/157), [Rolezn](https://github.com/code-423n4/2022-09-party-findings/issues/68), [0x1f8b](https://github.com/code-423n4/2022-09-party-findings/issues/210), [0xkatana](https://github.com/code-423n4/2022-09-party-findings/issues/50), [JAGADESH](https://github.com/code-423n4/2022-09-party-findings/issues/214), [Sm4rty](https://github.com/code-423n4/2022-09-party-findings/issues/305), [ajtra](https://github.com/code-423n4/2022-09-party-findings/issues/267), [peiw](https://github.com/code-423n4/2022-09-party-findings/issues/360), [SnowMan](https://github.com/code-423n4/2022-09-party-findings/issues/62), [brgltd](https://github.com/code-423n4/2022-09-party-findings/issues/345), [erictee](https://github.com/code-423n4/2022-09-party-findings/issues/3), [prasantgupta52](https://github.com/code-423n4/2022-09-party-findings/issues/307), [Rohan16](https://github.com/code-423n4/2022-09-party-findings/issues/323), [Bnke0x0](https://github.com/code-423n4/2022-09-party-findings/issues/8), [\\_\\_141345\\_\\_](https://github.com/code-423n4/2022-09-party-findings/issues/199), [Aymen0909](https://github.com/code-423n4/2022-09-party-findings/issues/326), [gianganhnguyen](https://github.com/code-423n4/2022-09-party-findings/issues/28), [karanctf](https://github.com/code-423n4/2022-09-party-findings/issues/190), [Tomio](https://github.com/code-423n4/2022-09-party-findings/issues/262), [sryysryy](https://github.com/code-423n4/2022-09-party-findings/issues/165), [0xNazgul](https://github.com/code-423n4/2022-09-party-findings/issues/279), [ignacio](https://github.com/code-423n4/2022-09-party-findings/issues/178), [lukris02](https://github.com/code-423n4/2022-09-party-findings/issues/230), [RaymondFam](https://github.com/code-423n4/2022-09-party-findings/issues/61), [Lambda](https://github.com/code-423n4/2022-09-party-findings/issues/100), [malinariy](https://github.com/code-423n4/2022-09-party-findings/issues/89), [ch0bu](https://github.com/code-423n4/2022-09-party-findings/issues/52), [Metatron](https://github.com/code-423n4/2022-09-party-findings/issues/14), [Waze](https://github.com/code-423n4/2022-09-party-findings/issues/133), [0x5rings](https://github.com/code-423n4/2022-09-party-findings/issues/234), [djxploit](https://github.com/code-423n4/2022-09-party-findings/issues/229), [fatherOfBlocks](https://github.com/code-423n4/2022-09-party-findings/issues/161), [leosathya](https://github.com/code-423n4/2022-09-party-findings/issues/298), [robee](https://github.com/code-423n4/2022-09-party-findings/issues/6), [Saintcode\\_](https://github.com/code-423n4/2022-09-party-findings/issues/12), [jag](https://github.com/code-423n4/2022-09-party-findings/issues/88), [martin](https://github.com/code-423n4/2022-09-party-findings/issues/144), [slowmoses](https://github.com/code-423n4/2022-09-party-findings/issues/227), [Tomo](https://github.com/code-423n4/2022-09-party-findings/issues/176), [got\\_targ](https://github.com/code-423n4/2022-09-party-findings/issues/269), [Olivierdem](https://github.com/code-423n4/2022-09-party-findings/issues/169), [0x4non](https://github.com/code-423n4/2022-09-party-findings/issues/327), [Amithuddar](https://github.com/code-423n4/2022-09-party-findings/issues/266), [asutorufos](https://github.com/code-423n4/2022-09-party-findings/issues/333), [B2](https://github.com/code-423n4/2022-09-party-findings/issues/91), [Chom](https://github.com/code-423n4/2022-09-party-findings/issues/270), [ChristianKuri](https://github.com/code-423n4/2022-09-party-findings/issues/19), [CRYP70](https://github.com/code-423n4/2022-09-party-findings/issues/253), [delfin454000](https://github.com/code-423n4/2022-09-party-findings/issues/258), [Fitraldys](https://github.com/code-423n4/2022-09-party-findings/issues/337), [ladboy233](https://github.com/code-423n4/2022-09-party-findings/issues/127), [LeoS](https://github.com/code-423n4/2022-09-party-findings/issues/152), [natzuu](https://github.com/code-423n4/2022-09-party-findings/issues/324), [simon135](https://github.com/code-423n4/2022-09-party-findings/issues/174), [tnevler](https://github.com/code-423n4/2022-09-party-findings/issues/316), [V\\_B](https://github.com/code-423n4/2022-09-party-findings/issues/349), [bulej93](https://github.com/code-423n4/2022-09-party-findings/issues/79), [Diraco](https://github.com/code-423n4/2022-09-party-findings/issues/185), [francoHacker](https://github.com/code-423n4/2022-09-party-findings/issues/321), [Noah3o6](https://github.com/code-423n4/2022-09-party-findings/issues/57), [Ocean\\_Sky](https://github.com/code-423n4/2022-09-party-findings/issues/256), [d3e4](https://github.com/code-423n4/2022-09-party-findings/issues/339), [dharma09](https://github.com/code-423n4/2022-09-party-findings/issues/22), [IgnacioB](https://github.com/code-423n4/2022-09-party-findings/issues/187), [peanuts](https://github.com/code-423n4/2022-09-party-findings/issues/319), [0x85102](https://github.com/code-423n4/2022-09-party-findings/issues/65), [aysha](https://github.com/code-423n4/2022-09-party-findings/issues/357), [CodingNameKiki](https://github.com/code-423n4/2022-09-party-findings/issues/78), [Funen](https://github.com/code-423n4/2022-09-party-findings/issues/314), [Matin](https://github.com/code-423n4/2022-09-party-findings/issues/124), [PaludoX0](https://github.com/code-423n4/2022-09-party-findings/issues/222), [pashov](https://github.com/code-423n4/2022-09-party-findings/issues/273), and [StevenL](https://github.com/code-423n4/2022-09-party-findings/issues/67).*\n\n* Use the old `oldHostsFieldValue` value in the `Crowdfund._hashFixedGovernanceOpts`\n    ```sol\n    let oldHostsFieldValue := mload(opts)\n    mstore(opts, keccak256(add(mload(opts), 0x20), mul(mload(mload(opts)), 32)))\n    ```\n\n* Use unchecked on this part of the `Crowdfund._getFinalContribution` function:\n    ```sol\n    ...\n    } else {\n        // This contribution was partially used.\n        uint256 partialEthUsed = totalEthUsed - c.previousTotalContributions;\n        ethUsed += partialEthUsed; // this doesn't need to be unchecked\n        ethOwed = c.amount - partialEthUsed;\n    }\n    ```\n    The code will look like this:\n    ```sol\n    ...\n    } else {\n        // This contribution was partially used.\n        unchecked {\n            uint256 partialEthUsed = totalEthUsed - c.previousTotalContributions;\n            ethOwed = c.amount - partialEthUsed;\n        }\n        ethUsed += partialEthUsed; // this doesn't need to be unchecked\n    }\n    ```\n\n* Use > 0 instead of >= 1, use unchecked and cache the expression's result instead of calculating it twice (in the `Crowdfund._contribute` function):\n    ```sol\n    if (numContributions >= 1) {\n        Contribution memory lastContribution = contributions[numContributions - 1];\n        if (lastContribution.previousTotalContributions == previousTotalContributions) {\n            // No one else has contributed since so just reuse the last entry.\n            lastContribution.amount += amount;\n            contributions[numContributions - 1] = lastContribution;\n            return;\n        }\n    }\n    ```\n    The code will look like this:\n    ```sol\n    if (numContributions > 0) {\n        unchecked {\n            uint lastIndex = numContributions - 1;\n        }\n        Contribution memory lastContribution = contributions[lastIndex];\n        if (lastContribution.previousTotalContributions == previousTotalContributions) {\n            // No one else has contributed since so just reuse the last entry.\n            lastContribution.amount += amount;\n            contributions[lastIndex] = lastContribution;\n            return;\n        }\n    }\n    ```\n\n* Cache `splitRecipient` in the `Crowdfund._burn()` function\n\n* If the amount is 0, don't perform the low level call in `LibAddress.transferETH()`\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}