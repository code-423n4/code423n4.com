{
  "circa": {
    "title": "PoolTogether TWAB Delegator contest",
    "sponsor": "PoolTogether",
    "slug": "2022-02-pooltogether",
    "date": "2022-04-19",
    "findings": "https://github.com/code-423n4/2022-02-pooltogether-findings/issues",
    "contest": 93
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the PoolTogether TWAB Delegator smart contract system written in Solidity. The audit contest took place between February 22—February 24 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>29 Wardens contributed reports to the PoolTogether TWAB Delegator contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/omikomikomik\">Omik</a></li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li><a href=\"https://twitter.com/kirkthebaird\">kirk-baird</a></li>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li>CertoraInc (<a href=\"https://twitter.com/danbinnun\">danb</a>, egjlmn1, <a href=\"https://twitter.com/ori_dabush\">OriDabush</a>, ItayG, and shakedwinder)</li>\n<li><a href=\"https://twitter.com/HickupH\">hickuphh3</a></li>\n<li><a href=\"https://twitter.com/JustDravee\">Dravee</a></li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li><a href=\"https://twitter.com/rhynorater\">Rhynorater</a></li>\n<li>robee</li>\n<li>chunter</li>\n<li>nascent (<a href=\"https://twitter.com/brockjelmore\">brock</a>, <a href=\"https://twitter.com/andreasbigger\">0xAndreas</a>, and <a href=\"https://twitter.com/Chris_8086\">chris_nascent</a>)</li>\n<li>jayjonah8</li>\n<li>IllIllI</li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li>sorrynotsorry</li>\n<li>kenta</li>\n<li><a href=\"https://www.instagram.com/riyan_rfa/\">rfa</a></li>\n<li><a href=\"https://github.com/z3s/\">z3s</a></li>\n<li>0x1f8b</li>\n<li><a href=\"https://twitter.com/_ye0lde\">ye0lde</a></li>\n<li>pedroais</li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/liam_eastwood13\">0xleastwood</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded 1 unique MEDIUM severity vulnerability. Additionally, the analysis included 9 reports detailing issues with a risk rating of LOW severity or non-critical as well as 17 reports recommending gas optimizations. All of the issues presented here are linked back to their original finding.</p>\n<p>Notably, 0 vulnerabilities were found during this audit contest that received a risk rating in the category of HIGH severity.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-02-pooltogether\">C4 PoolTogether TWAB Delegator contest repository</a>, and is composed of 4 smart contracts written in the Solidity programming language and includes 420 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"medium-risk-findings-1\" style=\"position:relative;\"><a href=\"#medium-risk-findings-1\" aria-label=\"medium risk findings 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (1)</h1>\n<h2 id=\"m-01-permitandmulticall-may-be-used-to-steal-funds-or-as-a-denial-of-service-if-_from-is-not-the-message-sender\" style=\"position:relative;\"><a href=\"#m-01-permitandmulticall-may-be-used-to-steal-funds-or-as-a-denial-of-service-if-_from-is-not-the-message-sender\" aria-label=\"m 01 permitandmulticall may be used to steal funds or as a denial of service if _from is not the message sender permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/20\">[M-01] <code>permitAndMulticall()</code> May Be Used to Steal Funds Or as a Denial Of Service if <code>_from</code> Is Not The Message Sender</a></h2>\n<p><em>Submitted by kirk-baird, also found by cmichel and Omik</em></p>\n<h3 id=\"line-references\" style=\"position:relative;\"><a href=\"#line-references\" aria-label=\"line references permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/pooltogether/v4-twab-delegator/blob/2b6d42506187dd7096043e2dfec65fa06ab18577/contracts/PermitAndMulticall.sol#L46-L64\">PermitAndMulticall.sol#L46-L64</a><br>\n<a href=\"https://github.com/pooltogether/v4-twab-delegator/blob/2b6d42506187dd7096043e2dfec65fa06ab18577/contracts/PermitAndMulticall.sol#L31-L37\">PermitAndMulticall.sol#L31-L37</a><br>\n<a href=\"https://github.com/pooltogether/v4-twab-delegator/blob/2b6d42506187dd7096043e2dfec65fa06ab18577/contracts/TWABDelegator.sol#L438-L445\">TWABDelegator.sol#L438-L445</a></p>\n<h3 id=\"vulnerability-details\" style=\"position:relative;\"><a href=\"#vulnerability-details\" aria-label=\"vulnerability details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability details</h3>\n<p>When the <code>_from</code> address is not the <code>msg.sender</code> <code>_multiCall()</code> will be made on behalf of the <code>msg.sender</code>. As a result each of the functions called by <code>multiCall()</code> will be made on behalf of <code>msg.sender</code> and not <code>_from</code>.</p>\n<p>If functions such as <code>transfer()</code> or <code>unstake()</code> are called <code>msg.sender</code> will be the original caller which would transfer the attacker the funds if the <code>to</code> field is set to an attackers address.</p>\n<p>Furthermore, if an attacker we to call <code>permitAndMulticall()</code> before the <code>_from</code> user they may use their signature and nonce combination. As a nonce is only allowe to be used once the siganture will no longer be valid and <code>_permitToken.permit()</code> will fail on the second call.</p>\n<p>An attacker may use this as a Denial of Service (DoS) attack by continually front-running <code>permitAndCall()</code> using other users signatures.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_multicall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_data</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">results</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">results</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">_data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">results</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">Address</span><span class=\"mtk1\">.</span><span class=\"mtk11\">functionDelegateCall</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_data</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">results</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_permitAndMulticall</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">IERC20Permit</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_permitToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_from</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">Signature</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_permitSignature</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">_permitToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">permit</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_from</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_permitSignature</span><span class=\"mtk1\">.</span><span class=\"mtk12\">deadline</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_permitSignature</span><span class=\"mtk1\">.</span><span class=\"mtk12\">v</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_permitSignature</span><span class=\"mtk1\">.</span><span class=\"mtk12\">r</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_permitSignature</span><span class=\"mtk1\">.</span><span class=\"mtk12\">s</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">_multicall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_data</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider updating the <code>_from</code> field to be the <code>msg.sender</code> in <code>permitAndMulticall()</code> (or alternatively do this in <code>_permitAndMulticall()</code> to save some gas).</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">permitAndMulticall</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">Signature</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_permitSignature</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">_permitAndMulticall</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20Permit</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ticket</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_permitSignature</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_data</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/20#issuecomment-1057474934\">PierrickGT (PoolTogether) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/pooltogether/v4-twab-delegator/pull/29\">https://github.com/pooltogether/v4-twab-delegator/pull/29</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/20#issuecomment-1058307757\">PierrickGT (PoolTogether) disagreed with Medium severity and commented</a>:</strong></p>\n<blockquote>\n<p>Should be labelled as a 3 (High Risk) issue because an attacker could steal the funds.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/20#issuecomment-1060617163\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I’m not exactly sure how this might be abused to steal funds. By front-running a call <code>permitAndMulticall()</code> with the same <code>_from</code> account, an attacker is able to use up the user’s nonce and DoS their transactions. However, an attacker CAN control the <code>_data</code> parsed to the <code>_multicall()</code> function and delegate call to the <code>TWABDelegator.sol</code> contract. Although, in this case <code>msg.sender</code> will be the attacker and not the delegatee.</p>\n<p>As such, any call to transfer a delegation to another account will fail as the delegation is computed based off <code>msg.sender</code> and <code>_slot</code>.</p>\n<p>Could you confirm if there is a viable attack vector that would result in lost funds? @PierrickGT </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/20#issuecomment-1061952284\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>You are right, the only attack vector possible would be with the <code>updateDelegatee</code> function since an attacker could pass a <code>_delegatee</code> address and we compute the delegation with the passed <code>_delegator</code> param.\n<a href=\"https://github.com/pooltogether/v4-twab-delegator/blob/60ae14e11947f8c896c1fef8f4d19ee714719383/contracts/TWABDelegator.sol#L265\">https://github.com/pooltogether/v4-twab-delegator/blob/60ae14e11947f8c896c1fef8f4d19ee714719383/contracts/TWABDelegator.sol#L265</a></p>\n<p>Funds wouldn’t be at risk but delegated to the attacker address.\nSo I think the <code>2 (Med Risk)</code> label makes sense in this case since funds are not directly at risk but the attacker would enjoy better odds of winning.\nI’ve removed the <code>disagree with severity</code> label.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/20#issuecomment-1062612286\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>As per the above comment, I will leave this as <code>2 (Med Risk)</code>. The exploit does not lead to a loss of funds but can be abused to DoS this functionality and enjoy better odds of winning.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 9 reports were submitted by wardens detailing low risk and non-critical issues. The reports highlighted below received the top 3 scores from the judge and are by the following wardens/teams: 1) <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/27\">WatchPug</a>; 2) <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/10\">CertoraInc</a>; and 3) <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16\">hickuphh3</a>.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/28\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/40\">Rhynorater</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/35\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/19\">chunter</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/1\">jayjonah8</a>, and <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/14\">robee</a>.</em></p>\n<h2 id=\"l-01-delegator-andor-representative-should-be-allowed-for-arbitrary-code-execution-besides-restricted-operations-during-unlocked-period\" style=\"position:relative;\"><a href=\"#l-01-delegator-andor-representative-should-be-allowed-for-arbitrary-code-execution-besides-restricted-operations-during-unlocked-period\" aria-label=\"l 01 delegator andor representative should be allowed for arbitrary code execution besides restricted operations during unlocked period permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/27\">[L-01] delegator and/or representative should be allowed for arbitrary code execution besides restricted operations during unlocked period</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<h3 id=\"line-references-1\" style=\"position:relative;\"><a href=\"#line-references-1\" aria-label=\"line references 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/pooltogether/v4-twab-delegator/blob/21bb53b2ea54a248bbd1d3170dbadd3a0c83d874/contracts/Delegation.sol#L39-L46\">Delegation.sol#L39-L46</a></p>\n<h3 id=\"vulnerability-details-1\" style=\"position:relative;\"><a href=\"#vulnerability-details-1\" aria-label=\"vulnerability details 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability details</h3>\n<p><code>Delegation</code> is a contract deployed dedicated to holding the <code>ticket</code> tokens for the <code>delegator</code> and they can then be <code>delegate</code> to a <code>delegatee</code>.</p>\n<p>On the <code>Delegation</code> contract, there is a method named <code>executeCalls()</code> designed for “Executes calls on behalf of this contract” which allows arbitrary code execution for the owner.</p>\n<p>However, we found that the owner of <code>Delegation</code> will always be <code>TWABDelegator</code>, and the <code>TWABDelegator</code> will only use <code>Delegation.sol#executeCalls()</code> to call one particular address: the <code>ticket</code> address, and for only two methods: <code>transfer()</code> and <code>delegate()</code>.</p>\n<p>Furthermore, even though in <code>Delegation.sol#executeCalls()</code>, <code>calls[i].value</code> is used, the function is not being marked as <code>payable</code>, that makes it hard for calls that requires eth payments.</p>\n<p><a href=\"https://github.com/pooltogether/v4-twab-delegator/blob/21bb53b2ea54a248bbd1d3170dbadd3a0c83d874/contracts/Delegation.sol#L39-L46\">Delegation.sol#L39-L46</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">executeCalls</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Call</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calls</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">response</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">calls</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">calls</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">response</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">_executeCall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">calls</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">calls</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">value</span><span class=\"mtk1\">, </span><span class=\"mtk12\">calls</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">data</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">response</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>While the <code>ticket</code> is being delegated through <code>TWABDelegator</code>, they won’t be able to retrieve the tickets back until the <code>lockUntil</code>, without the ability to make arbitrary code execution, the <code>delegator</code> may miss some of the potential benefits as a holder of the <code>ticket</code> tokens, for example, an airdrop to all holders of the <code>ticket</code> tokens, or an NFT made mintable only for certain ticket holders.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding a new method on <code>TWABDelegator</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">executeCalls</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_slot</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Delegation.Call[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calls</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">_requireDelegatorOrRepresentative</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">Delegation</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegation</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Delegation</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_computeAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_slot</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_delegation</span><span class=\"mtk1\">.</span><span class=\"mtk11\">lockUntil</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">calls</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">calls</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">to</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ticket</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;TWABDelegator/delegation-locked&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegation</span><span class=\"mtk1\">.</span><span class=\"mtk12\">executeCalls</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">_calls</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And also, consider making <code>Delegation.sol#executeCalls()</code> a <code>payable</code> method.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/27#issuecomment-1058241764\">PierrickGT (PoolTogether) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>The issue outlined by the warden is relevant but users won’t need to execute arbitrary calls cause potential rewards given out to ticket holders will be handled by our TWABRewards contract.\nThis contract retrieves users TWAB (Time-Weighted Average Balance) for a given period of time and calculate the amount of rewards they are eligible to.\nUsers can then <code>claimRewards</code> on behalf of others. So delegatees will be able to claim their rewards and delegators could claim on their behalf.</p>\n<p><a href=\"https://github.com/pooltogether/v4-periphery/blob/348d2bf7cfcf5750bad4aae63b8ade5a2a45f188/contracts/TwabRewards.sol#L410\">TwabRewards.sol#L410</a><br>\n<a href=\"https://github.com/pooltogether/v4-periphery/blob/348d2bf7cfcf5750bad4aae63b8ade5a2a45f188/contracts/interfaces/ITwabRewards.sol#L94\">ITwabRewards.sol#L94</a><br></p>\n<p>For more informations about how the TWAB works, here is some documentation:</p>\n<ul>\n<li><a href=\"https://dev.pooltogether.com/protocol/architecture/time-weighted-average-balance\">Time-Weighted Average Balance</a></li>\n<li><a href=\"https://medium.com/pooltogether/better-reward-distribution-65d900f3cef0\">Better Reward Distribution</a></li>\n</ul>\n<p>Also, by restricting calls to the <code>transfer</code> and delegate` methods on the ticket, we limit the attack surface and any attack vector we may not have thought about.</p>\n<p>For the reasons above, I’ve acknowledged the issue but we won’t implement the proposed solution</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/27#issuecomment-1062705166\">0xleastwood (judge) decreased severity to Low and commented</a>:</strong></p>\n<blockquote>\n<p>I don’t really see a case where <code>_delegateCall()</code> or <code>_transferCall()</code> will need to have some ETH attached with it. They are solely dealing with the Ticket ERC20 token and updating delegation data. Considering the fact that rewards are handled by a separate contract, I think its fair to downgrade this to <code>1 (Low Risk)</code>.</p>\n</blockquote>\n<hr>\n<h2 id=\"n-01-tickets-can-get-locked\" style=\"position:relative;\"><a href=\"#n-01-tickets-can-get-locked\" aria-label=\"n 01 tickets can get locked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/10\">[N-01] Tickets can get locked</a></h2>\n<p><em>Submitted by CertoraInc</em></p>\n<p>if a user calls <code>transferDelegationTo</code> with the address of the <code>TWABDelegator</code> contract as the <code>to</code> parameter, the tokens will be transferred to the address without minting the user the stake token, so maybe you can think of adding this functionality. I know that there is the <code>withdrawDelegationToStake</code> function for that, but that can be nice to enable it that way too.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/10#issuecomment-1057131932\">PierrickGT (PoolTogether) confirmed, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>The tickets would actually get stuck in the contract. I’ve added a require to avoid transferring directly to the contract.</p>\n<p>Based on the severity criteria, I think this one should be labelled as a 2 (Med Risk) issue. Would be an error from the user interacting with the functions but funds would indeed be at risk, not direct but at risk.</p>\n<p>PR: pooltogether/v4-twab-delegator#27</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/10#issuecomment-1066030370\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I think the issue highlighted is more in-line with incorrect state handling, so I’ll leave the severity as is.</p>\n</blockquote>\n<hr>\n<h2 id=\"l-02-incorrect-comment-on-transferdelegationto\" style=\"position:relative;\"><a href=\"#l-02-incorrect-comment-on-transferdelegationto\" aria-label=\"l 02 incorrect comment on transferdelegationto permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16\">[L-02] Incorrect comment on <code>transferDelegationTo()</code></a></h2>\n<p><em>Submitted by hickuphh3</em></p>\n<h3 id=\"line-references-2\" style=\"position:relative;\"><a href=\"#line-references-2\" aria-label=\"line references 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/pooltogether/v4-twab-delegator/blob/master/contracts/TWABDelegator.sol#L370-L371\">TWABDelegator.sol#L370-L371</a></p>\n<h3 id=\"description\" style=\"position:relative;\"><a href=\"#description\" aria-label=\"description permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>The comments say that the withdrawn tickets are transferred to the caller / delegator wallet, but are actually transferred to the <code>_to</code> address.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">* @notice Withdraw an `_amount` of tickets from a delegation. The delegator is assumed to be the caller.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">* @dev Tickets are sent directly to the passed `_to` address</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16#issuecomment-1054830545\">PierrickGT (PoolTogether) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/pooltogether/v4-twab-delegator/pull/21\">pooltogether/v4-twab-delegator#21</a></p>\n</blockquote>\n<hr>\n<h2 id=\"l-03-incorrect-comment-on-transferreddelegation-event\" style=\"position:relative;\"><a href=\"#l-03-incorrect-comment-on-transferreddelegation-event\" aria-label=\"l 03 incorrect comment on transferreddelegation event permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16\">[L-03] Incorrect comment on <code>TransferredDelegation</code> event</a></h2>\n<p><em>Submitted by hickuphh3</em></p>\n<h3 id=\"line-references-3\" style=\"position:relative;\"><a href=\"#line-references-3\" aria-label=\"line references 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/pooltogether/v4-twab-delegator/blob/master/contracts/TWABDelegator.sol#L125-L136\">TWABDelegator.sol#L125-L136</a></p>\n<h3 id=\"description-1\" style=\"position:relative;\"><a href=\"#description-1\" aria-label=\"description 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>In relation to L03, the <code>TransferredDelegation</code> event</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">- is incorrectly commented that the withdrawn tickets are transferred to the caller / delegator wallet</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">- lacks a description about the `to` indexed parameter.</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Emitted when a delegator withdraws an amount of tickets from a delegation to a specified wallet.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">delegator</span><span class=\"mtk3\"> Address of the delegator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">slot</span><span class=\"mtk3\">  Slot of the delegation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk3\"> Amount of tickets withdrawn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> * </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">to</span><span class=\"mtk3\"> Recipient address of withdrawn tickets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TransferredDelegation</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegator</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">slot</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16#issuecomment-1054830545\">PierrickGT (PoolTogether) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/pooltogether/v4-twab-delegator/pull/21\">pooltogether/v4-twab-delegator#21</a></p>\n</blockquote>\n<hr>\n<h2 id=\"l-04-incorrect-comment-on-delegationfundedfromstake-event\" style=\"position:relative;\"><a href=\"#l-04-incorrect-comment-on-delegationfundedfromstake-event\" aria-label=\"l 04 incorrect comment on delegationfundedfromstake event permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16\">[L-04] Incorrect comment on <code>DelegationFundedFromStake</code> event</a></h2>\n<p><em>Submitted by hickuphh3</em></p>\n<h3 id=\"line-references-4\" style=\"position:relative;\"><a href=\"#line-references-4\" aria-label=\"line references 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/pooltogether/v4-twab-delegator/blob/master/contracts/TWABDelegator.sol#L102\">TWABDelegator.sol#L102</a></p>\n<h3 id=\"description-2\" style=\"position:relative;\"><a href=\"#description-2\" aria-label=\"description 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>The <code>DelegationFundedFromStake()</code> allows a representative or delegator himself to fund a delegation contract using the delegator’s stake. The <code>user</code> in the <code>DelegationFundedFromStake</code> event refers to <code>msg.sender</code>. Since the funds are coming solely from the delegator, its description isn’t entirely correct.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p><code>@param user Address of the user who pulled funds from the delegator to the delegation</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16#issuecomment-1054830545\">PierrickGT (PoolTogether) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/pooltogether/v4-twab-delegator/pull/21\">pooltogether/v4-twab-delegator#21</a></p>\n</blockquote>\n<hr>\n<h2 id=\"n-02-extra-whitespace-in-slot-description-of-withdrewdelegationtostake-event\" style=\"position:relative;\"><a href=\"#n-02-extra-whitespace-in-slot-description-of-withdrewdelegationtostake-event\" aria-label=\"n 02 extra whitespace in slot description of withdrewdelegationtostake event permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16\">[N-02] Extra whitespace in slot description of <code>WithdrewDelegationToStake()</code> event</a></h2>\n<p><em>Submitted by hickuphh3</em></p>\n<h3 id=\"line-references-5\" style=\"position:relative;\"><a href=\"#line-references-5\" aria-label=\"line references 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/pooltogether/v4-twab-delegator/blob/master/contracts/TWABDelegator.sol#L114\">TWABDelegator.sol#L114</a></p>\n<h3 id=\"description-3\" style=\"position:relative;\"><a href=\"#description-3\" aria-label=\"description 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>There is an additional spacing between <code>slot</code> and <code>Slot</code>.</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Remove the spacing to become: <code>* @param slot Slot of the delegation</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16#issuecomment-1054830545\">PierrickGT (PoolTogether) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/pooltogether/v4-twab-delegator/pull/21\">pooltogether/v4-twab-delegator#21</a></p>\n</blockquote>\n<hr>\n<h2 id=\"n-03-twabdelegator-consider-renaming-_delegatecall-to-_setdelegateecall\" style=\"position:relative;\"><a href=\"#n-03-twabdelegator-consider-renaming-_delegatecall-to-_setdelegateecall\" aria-label=\"n 03 twabdelegator consider renaming _delegatecall to _setdelegateecall permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16\">[N-03] TWABDelegator: Consider renaming <code>_delegateCall()</code> to <code>_setDelegateeCall()</code></a></h2>\n<p><em>Submitted by hickuphh3</em></p>\n<h3 id=\"line-references-6\" style=\"position:relative;\"><a href=\"#line-references-6\" aria-label=\"line references 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/pooltogether/v4-twab-delegator/blob/master/contracts/TWABDelegator.sol#L519\">TWABDelegator.sol#L519</a></p>\n<h3 id=\"description-4\" style=\"position:relative;\"><a href=\"#description-4\" aria-label=\"description 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p><code>_delegateCall()</code> could easily be confused for the inbuilt <code>delegatecall()</code> method. I recommend renaming it to something more distinguishable like <code>_setDelegateeCall()</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16#issuecomment-1054830545\">PierrickGT (PoolTogether) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/pooltogether/v4-twab-delegator/pull/21\">pooltogether/v4-twab-delegator#21</a></p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 17 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/9\">report highlighted below</a> by warden team <strong>CertoraInc</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/36\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/33\">nascent</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/38\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/31\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/15\">robee</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/32\">Tomio</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/22\">sorrynotsorry</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/41\">kenta</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/30\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/44\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/25\">z3s</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/45\">Omik</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/37\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/39\">ye0lde</a>, <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/48\">pedroais</a>, and <a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/17\">hickuphh3</a>.</em></p>\n<h2 id=\"g-01-loop-in-delegation-and-permitandmulticall-contracts\" style=\"position:relative;\"><a href=\"#g-01-loop-in-delegation-and-permitandmulticall-contracts\" aria-label=\"g 01 loop in delegation and permitandmulticall contracts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Loop in <code>Delegation</code> and <code>PermitAndMulticall</code> contracts</h2>\n<p>Loops can be optimized in several ways. Let’s take for example the loop in the <code>executeCalls</code> function of the <code>Delegation</code> contract.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">executeCalls</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Call</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calls</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">response</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">calls</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">calls</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">response</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">_executeCall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">calls</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">calls</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">value</span><span class=\"mtk1\">, </span><span class=\"mtk12\">calls</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">data</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">response</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>To optimize this loop and make it consume less gas, we can do the foloowing things:</p>\n<ol>\n<li>Use ++i instead of i++, which is a cheaper operation (in this case there is no difference between i++ and ++i because we dont use the return value of this expression, which is the only difference between these two expression).</li>\n<li>Save the <code>calls</code> array length in a local variable instead of accessing it in every iteration.</li>\n<li>Save <code>calls[i]</code> in a local variable instead of accessing it 3 times in every iteration. This will save accssing the array’s ith element 3 times in every iteration ,which requires an address calculation.</li>\n<li>There’s no need to initialize i to its default value, it will be done automatically and it will consume more gas if it will be done (I know, sounds stupid, but trust me - it works).</li>\n</ol>\n<p>So after applying all these changes, the loop will look something like this:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">executeCalls</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Call</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calls</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">response</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">calls</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">length</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">calls</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">Call</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">call</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">call</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">calls</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">response</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">_executeCall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">call</span><span class=\"mtk1\">.</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">call</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">, </span><span class=\"mtk12\">call</span><span class=\"mtk1\">.</span><span class=\"mtk12\">data</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">response</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 id=\"g-02-inline-all-these-little-functions\" style=\"position:relative;\"><a href=\"#g-02-inline-all-these-little-functions\" aria-label=\"g 02 inline all these little functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Inline all these little functions</h2>\n<p>Defining all these little functions cause 2 things:</p>\n<ol>\n<li>contract’s code size gets bigger</li>\n<li>the function calls consumes more gas than exectuing it as an inlined function (part of the code, without the function call)</li>\n</ol>\n<p>So in order to save gas, I would recommend to inline these functions.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_computeAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_slot</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_computeAddress</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_computeSalt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">, </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_slot</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_computeLockUntil</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_lockDuration</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint96</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uint96</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">_lockDuration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_requireDelegatorOrRepresentative</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">representatives</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&quot;TWABDelegator/not-delegator-or-rep&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_requireDelegateeNotZeroAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegatee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_delegatee</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;TWABDelegator/dlgt-not-zero-adr&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_requireAmountGtZero</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;TWABDelegator/amount-gt-zero&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_requireDelegatorNotZeroAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;TWABDelegator/dlgtr-not-zero-adr&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_requireRecipientNotZeroAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_to</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;TWABDelegator/to-not-zero-addr&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_requireDelegationUnlocked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Delegation</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegation</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">_delegation</span><span class=\"mtk1\">.</span><span class=\"mtk11\">lockUntil</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">&quot;TWABDelegator/delegation-locked&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_requireContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_address</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isContract</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">&quot;TWABDelegator/not-a-contract&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_requireLockDuration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_lockDuration</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_lockDuration</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">MAX_LOCK</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;TWABDelegator/lock-too-long&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-pooltogether-findings/issues/9#issuecomment-1054644165\">PierrickGT (PoolTogether) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/pooltogether/v4-twab-delegator/pull/18\">pooltogether/v4-twab-delegator/pull#18</a></p>\n<p>We’ve implemented the different fixes regarding the for loops, except for the <code>++i</code> recommendation, we kept <code>i++</code> for better code clarity.\nAbout the inline suggestion, we prefer to keep the code in reusable functions to keep a more readable and easier to update codebase than if we had to repeat our code through inlining.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#medium-risk-findings-1\">Medium Risk Findings (1)</a></p>\n<ul>\n<li><a href=\"#m-01-permitandmulticall-may-be-used-to-steal-funds-or-as-a-denial-of-service-if-_from-is-not-the-message-sender\">[M-01] <code>permitAndMulticall()</code> May Be Used to Steal Funds Or as a Denial Of Service if <code>_from</code> Is Not The Message Sender</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#l-01-delegator-andor-representative-should-be-allowed-for-arbitrary-code-execution-besides-restricted-operations-during-unlocked-period\">[L-01] delegator and/or representative should be allowed for arbitrary code execution besides restricted operations during unlocked period</a></li>\n<li><a href=\"#n-01-tickets-can-get-locked\">[N-01] Tickets can get locked</a></li>\n<li><a href=\"#l-02-incorrect-comment-on-transferdelegationto\">[L-02] Incorrect comment on <code>transferDelegationTo()</code></a></li>\n<li><a href=\"#l-03-incorrect-comment-on-transferreddelegation-event\">[L-03] Incorrect comment on <code>TransferredDelegation</code> event</a></li>\n<li><a href=\"#l-04-incorrect-comment-on-delegationfundedfromstake-event\">[L-04] Incorrect comment on <code>DelegationFundedFromStake</code> event</a></li>\n<li><a href=\"#n-02-extra-whitespace-in-slot-description-of-withdrewdelegationtostake-event\">[N-02] Extra whitespace in slot description of <code>WithdrewDelegationToStake()</code> event</a></li>\n<li><a href=\"#n-03-twabdelegator-consider-renaming-_delegatecall-to-_setdelegateecall\">[N-03] TWABDelegator: Consider renaming <code>_delegateCall()</code> to <code>_setDelegateeCall()</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-loop-in-delegation-and-permitandmulticall-contracts\">G-01 Loop in <code>Delegation</code> and <code>PermitAndMulticall</code> contracts</a></li>\n<li><a href=\"#g-02-inline-all-these-little-functions\">G-02 Inline all these little functions</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the PoolTogether TWAB Delegator smart contract system written in Solidity. The audit contest took place between February 22—February 24 2022.\n\n## Wardens\n\n29 Wardens contributed reports to the PoolTogether TWAB Delegator contest:\n\n  1. [Omik](https://twitter.com/omikomikomik)\n  1. [cmichel](https://twitter.com/cmichelio)\n  1. [kirk-baird](https://twitter.com/kirkthebaird)\n  1. WatchPug ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n  1. CertoraInc ([danb](https://twitter.com/danbinnun), egjlmn1, [OriDabush](https://twitter.com/ori_dabush), ItayG, and shakedwinder)\n  1. [hickuphh3](https://twitter.com/HickupH)\n  1. [Dravee](https://twitter.com/JustDravee)\n  1. [gzeon](https://twitter.com/gzeon)\n  1. [Rhynorater](https://twitter.com/rhynorater)\n  1. robee\n  1. chunter\n  1. nascent ([brock](https://twitter.com/brockjelmore), [0xAndreas](https://twitter.com/andreasbigger), and [chris_nascent](https://twitter.com/Chris_8086))\n  1. jayjonah8\n  1. IllIllI\n  1. [Tomio](https://twitter.com/meidhiwirara)\n  1. sorrynotsorry\n  1. kenta\n  1. [rfa](https://www.instagram.com/riyan_rfa/)\n  1. [z3s](https://github.com/z3s/)\n  1. 0x1f8b\n  1. [ye0lde](https://twitter.com/_ye0lde)\n  1. pedroais\n\nThis contest was judged by [0xleastwood](https://twitter.com/liam_eastwood13).\n\nFinal report assembled by [liveactionllama](https://twitter.com/liveactionllama).\n\n# Summary\n\nThe C4 analysis yielded 1 unique MEDIUM severity vulnerability. Additionally, the analysis included 9 reports detailing issues with a risk rating of LOW severity or non-critical as well as 17 reports recommending gas optimizations. All of the issues presented here are linked back to their original finding.\n\nNotably, 0 vulnerabilities were found during this audit contest that received a risk rating in the category of HIGH severity.\n\n# Scope\n\nThe code under review can be found within the [C4 PoolTogether TWAB Delegator contest repository](https://github.com/code-423n4/2022-02-pooltogether), and is composed of 4 smart contracts written in the Solidity programming language and includes 420 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code423n4.com).\n\n# Medium Risk Findings (1)\n## [[M-01] `permitAndMulticall()` May Be Used to Steal Funds Or as a Denial Of Service if `_from` Is Not The Message Sender](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/20)\n_Submitted by kirk-baird, also found by cmichel and Omik_\n\n### Line References\n\n[PermitAndMulticall.sol#L46-L64](https://github.com/pooltogether/v4-twab-delegator/blob/2b6d42506187dd7096043e2dfec65fa06ab18577/contracts/PermitAndMulticall.sol#L46-L64)<br>\n[PermitAndMulticall.sol#L31-L37](https://github.com/pooltogether/v4-twab-delegator/blob/2b6d42506187dd7096043e2dfec65fa06ab18577/contracts/PermitAndMulticall.sol#L31-L37)<br>\n[TWABDelegator.sol#L438-L445](https://github.com/pooltogether/v4-twab-delegator/blob/2b6d42506187dd7096043e2dfec65fa06ab18577/contracts/TWABDelegator.sol#L438-L445)\n\n### Vulnerability details\n\nWhen the `_from` address is not the `msg.sender` `_multiCall()` will be made on behalf of the `msg.sender`. As a result each of the functions called by `multiCall()` will be made on behalf of `msg.sender` and not `_from`.\n\nIf functions such as `transfer()` or `unstake()` are called `msg.sender` will be the original caller which would transfer the attacker the funds if the `to` field is set to an attackers address.\n\nFurthermore, if an attacker we to call `permitAndMulticall()` before the `_from` user they may use their signature and nonce combination. As a nonce is only allowe to be used once the siganture will no longer be valid and `_permitToken.permit()` will fail on the second call.\n\nAn attacker may use this as a Denial of Service (DoS) attack by continually front-running `permitAndCall()` using other users signatures.\n\n### Proof of Concept\n```solidity\nfunction _multicall(bytes[] calldata _data) internal virtual returns (bytes[] memory results) {\n  results = new bytes[](_data.length);\n  for (uint256 i = 0; i < _data.length; i++) {\n    results[i] = Address.functionDelegateCall(address(this), _data[i]);\n  }\n  return results;\n}\n```\n```solidity\nfunction _permitAndMulticall(\n  IERC20Permit _permitToken,\n  address _from,\n  uint256 _amount,\n  Signature calldata _permitSignature,\n  bytes[] calldata _data\n) internal {\n  _permitToken.permit(\n    _from,\n    address(this),\n    _amount,\n    _permitSignature.deadline,\n    _permitSignature.v,\n    _permitSignature.r,\n    _permitSignature.s\n  );\n\n  _multicall(_data);\n}\n```\n\n### Recommended Mitigation Steps\n\nConsider updating the `_from` field to be the `msg.sender` in `permitAndMulticall()` (or alternatively do this in `_permitAndMulticall()` to save some gas).\n```solidity\nfunction permitAndMulticall(\n  uint256 _amount,\n  Signature calldata _permitSignature,\n  bytes[] calldata _data\n) external {\n  _permitAndMulticall(IERC20Permit(address(ticket)), msg.sender, _amount, _permitSignature, _data);\n}\n```\n\n**[PierrickGT (PoolTogether) confirmed and resolved](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/20#issuecomment-1057474934):**\n > PR: https://github.com/pooltogether/v4-twab-delegator/pull/29\n\n**[PierrickGT (PoolTogether) disagreed with Medium severity and commented](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/20#issuecomment-1058307757):**\n > Should be labelled as a 3 (High Risk) issue because an attacker could steal the funds.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/20#issuecomment-1060617163):**\n > I'm not exactly sure how this might be abused to steal funds. By front-running a call `permitAndMulticall()` with the same `_from` account, an attacker is able to use up the user's nonce and DoS their transactions. However, an attacker CAN control the `_data` parsed to the `_multicall()` function and delegate call to the `TWABDelegator.sol` contract. Although, in this case `msg.sender` will be the attacker and not the delegatee.\n >\n > As such, any call to transfer a delegation to another account will fail as the delegation is computed based off `msg.sender` and `_slot`.\n >\n > Could you confirm if there is a viable attack vector that would result in lost funds? @PierrickGT \n\n**[PierrickGT (PoolTogether) commented](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/20#issuecomment-1061952284):**\n> You are right, the only attack vector possible would be with the `updateDelegatee` function since an attacker could pass a `_delegatee` address and we compute the delegation with the passed `_delegator` param.\n> https://github.com/pooltogether/v4-twab-delegator/blob/60ae14e11947f8c896c1fef8f4d19ee714719383/contracts/TWABDelegator.sol#L265\n> \n> Funds wouldn't be at risk but delegated to the attacker address.\n> So I think the `2 (Med Risk)` label makes sense in this case since funds are not directly at risk but the attacker would enjoy better odds of winning.\n> I've removed the `disagree with severity` label.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/20#issuecomment-1062612286):**\n > As per the above comment, I will leave this as `2 (Med Risk)`. The exploit does not lead to a loss of funds but can be abused to DoS this functionality and enjoy better odds of winning.\n\n\n\n***\n\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 9 reports were submitted by wardens detailing low risk and non-critical issues. The reports highlighted below received the top 3 scores from the judge and are by the following wardens/teams: 1) [WatchPug](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/27); 2) [CertoraInc](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/10); and 3) [hickuphh3](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16).\n\n_The following wardens also submitted reports: [gzeon](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/28), [Rhynorater](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/40), [Dravee](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/35), [chunter](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/19), [jayjonah8](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/1), and [robee](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/14)._\n\n## [[L-01] delegator and/or representative should be allowed for arbitrary code execution besides restricted operations during unlocked period](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/27)\n_Submitted by WatchPug_\n\n### Line References\n\n[Delegation.sol#L39-L46](https://github.com/pooltogether/v4-twab-delegator/blob/21bb53b2ea54a248bbd1d3170dbadd3a0c83d874/contracts/Delegation.sol#L39-L46)\n\n### Vulnerability details\n\n`Delegation` is a contract deployed dedicated to holding the `ticket` tokens for the `delegator` and they can then be `delegate` to a `delegatee`.\n\nOn the `Delegation` contract, there is a method named `executeCalls()` designed for \"Executes calls on behalf of this contract\" which allows arbitrary code execution for the owner.\n\nHowever, we found that the owner of `Delegation` will always be `TWABDelegator`, and the `TWABDelegator` will only use `Delegation.sol#executeCalls()` to call one particular address: the `ticket` address, and for only two methods: `transfer()` and `delegate()`.\n\nFurthermore, even though in `Delegation.sol#executeCalls()`, `calls[i].value` is used, the function is not being marked as `payable`, that makes it hard for calls that requires eth payments.\n\n[Delegation.sol#L39-L46](https://github.com/pooltogether/v4-twab-delegator/blob/21bb53b2ea54a248bbd1d3170dbadd3a0c83d874/contracts/Delegation.sol#L39-L46)\n\n```solidity\nfunction executeCalls(Call[] calldata calls) external onlyOwner returns (bytes[] memory) {\n  bytes[] memory response = new bytes[](calls.length);\n  for (uint256 i = 0; i < calls.length; i++) {\n    response[i] = _executeCall(calls[i].to, calls[i].value, calls[i].data);\n  }\n  return response;\n}\n```\n\nWhile the `ticket` is being delegated through `TWABDelegator`, they won't be able to retrieve the tickets back until the `lockUntil`, without the ability to make arbitrary code execution, the `delegator` may miss some of the potential benefits as a holder of the `ticket` tokens, for example, an airdrop to all holders of the `ticket` tokens, or an NFT made mintable only for certain ticket holders.\n\n### Recommended Mitigation Steps\n\nConsider adding a new method on `TWABDelegator`:\n\n```solidity\nfunction executeCalls(\n  address _delegator,\n  uint256 _slot,\n  Delegation.Call[] memory calls\n) external payable returns (bytes[] memory) {\n  _requireDelegatorOrRepresentative(_delegator);\n  Delegation _delegation = Delegation(_computeAddress(_delegator, _slot));\n\n  if (block.timestamp < _delegation.lockUntil()) {\n    for (uint256 i = 0; i < calls.length; i++) {\n      if (calls[i].to == address(ticket)) {\n        revert(\"TWABDelegator/delegation-locked\");\n      }\n    }\n  }\n\n  return _delegation.executeCalls{value: msg.value}(_calls);\n}\n```\n\nAnd also, consider making `Delegation.sol#executeCalls()` a `payable` method.\n\n**[PierrickGT (PoolTogether) acknowledged and commented](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/27#issuecomment-1058241764):**\n > The issue outlined by the warden is relevant but users won't need to execute arbitrary calls cause potential rewards given out to ticket holders will be handled by our TWABRewards contract.\n> This contract retrieves users TWAB (Time-Weighted Average Balance) for a given period of time and calculate the amount of rewards they are eligible to. \n> Users can then `claimRewards` on behalf of others. So delegatees will be able to claim their rewards and delegators could claim on their behalf.\n> \n> [TwabRewards.sol#L410](https://github.com/pooltogether/v4-periphery/blob/348d2bf7cfcf5750bad4aae63b8ade5a2a45f188/contracts/TwabRewards.sol#L410)<br>\n> [ITwabRewards.sol#L94](https://github.com/pooltogether/v4-periphery/blob/348d2bf7cfcf5750bad4aae63b8ade5a2a45f188/contracts/interfaces/ITwabRewards.sol#L94)<br>\n> \n> For more informations about how the TWAB works, here is some documentation:\n> - [Time-Weighted Average Balance](https://dev.pooltogether.com/protocol/architecture/time-weighted-average-balance)\n> - [Better Reward Distribution](https://medium.com/pooltogether/better-reward-distribution-65d900f3cef0)\n> \n> Also, by restricting calls to the `transfer` and delegate` methods on the ticket, we limit the attack surface and any attack vector we may not have thought about.\n> \n> For the reasons above, I've acknowledged the issue but we won't implement the proposed solution\n\n**[0xleastwood (judge) decreased severity to Low and commented](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/27#issuecomment-1062705166):**\n > I don't really see a case where `_delegateCall()` or `_transferCall()` will need to have some ETH attached with it. They are solely dealing with the Ticket ERC20 token and updating delegation data. Considering the fact that rewards are handled by a separate contract, I think its fair to downgrade this to `1 (Low Risk)`.\n\n\n\n***\n\n## [[N-01] Tickets can get locked](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/10)\n_Submitted by CertoraInc_\n\nif a user calls `transferDelegationTo` with the address of the `TWABDelegator` contract as the `to` parameter, the tokens will be transferred to the address without minting the user the stake token, so maybe you can think of adding this functionality. I know that there is the `withdrawDelegationToStake` function for that, but that can be nice to enable it that way too.\n\n**[PierrickGT (PoolTogether) confirmed, but disagreed with severity and commented](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/10#issuecomment-1057131932):**\n> The tickets would actually get stuck in the contract. I've added a require to avoid transferring directly to the contract.\n>\n> Based on the severity criteria, I think this one should be labelled as a 2 (Med Risk) issue. Would be an error from the user interacting with the functions but funds would indeed be at risk, not direct but at risk.\n>\n> PR: pooltogether/v4-twab-delegator#27\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/10#issuecomment-1066030370):**\n> I think the issue highlighted is more in-line with incorrect state handling, so I'll leave the severity as is.\n\n\n\n***\n\n## [[L-02] Incorrect comment on `transferDelegationTo()`](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16)\n_Submitted by hickuphh3_\n\n### Line References\n[TWABDelegator.sol#L370-L371](https://github.com/pooltogether/v4-twab-delegator/blob/master/contracts/TWABDelegator.sol#L370-L371)\n\n### Description\nThe comments say that the withdrawn tickets are transferred to the caller / delegator wallet, but are actually transferred to the `_to` address.\n\n### Recommended Mitigation Steps\n```\n* @notice Withdraw an `_amount` of tickets from a delegation. The delegator is assumed to be the caller.\n* @dev Tickets are sent directly to the passed `_to` address\n```\n\n**[PierrickGT (PoolTogether) confirmed and commented](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16#issuecomment-1054830545):**\n> PR: [pooltogether/v4-twab-delegator#21](https://github.com/pooltogether/v4-twab-delegator/pull/21)\n\n\n\n***\n\n## [[L-03] Incorrect comment on `TransferredDelegation` event](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16)\n_Submitted by hickuphh3_\n\n### Line References\n[TWABDelegator.sol#L125-L136](https://github.com/pooltogether/v4-twab-delegator/blob/master/contracts/TWABDelegator.sol#L125-L136)\n\n### Description\nIn relation to L03, the `TransferredDelegation` event\n\n    - is incorrectly commented that the withdrawn tickets are transferred to the caller / delegator wallet\n    - lacks a description about the `to` indexed parameter.\n\n### Recommended Mitigation Steps\n```solidity\n/**\n * @notice Emitted when a delegator withdraws an amount of tickets from a delegation to a specified wallet.\n * @param delegator Address of the delegator\n * @param slot  Slot of the delegation\n * @param amount Amount of tickets withdrawn\n * @param to Recipient address of withdrawn tickets\n */\n  event TransferredDelegation(\n    address indexed delegator,\n    uint256 indexed slot,\n    uint256 amount,\n    address indexed to\n  );\n```\n\n**[PierrickGT (PoolTogether) confirmed and commented](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16#issuecomment-1054830545):**\n> PR: [pooltogether/v4-twab-delegator#21](https://github.com/pooltogether/v4-twab-delegator/pull/21)\n\n\n\n***\n\n## [[L-04] Incorrect comment on `DelegationFundedFromStake` event](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16)\n_Submitted by hickuphh3_\n\n### Line References\n[TWABDelegator.sol#L102](https://github.com/pooltogether/v4-twab-delegator/blob/master/contracts/TWABDelegator.sol#L102)\n\n### Description\nThe `DelegationFundedFromStake()` allows a representative or delegator himself to fund a delegation contract using the delegator’s stake. The `user` in the `DelegationFundedFromStake` event refers to `msg.sender`. Since the funds are coming solely from the delegator, its description isn’t entirely correct.\n\n### Recommended Mitigation Steps\n`@param user Address of the user who pulled funds from the delegator to the delegation`\n\n**[PierrickGT (PoolTogether) confirmed and commented](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16#issuecomment-1054830545):**\n> PR: [pooltogether/v4-twab-delegator#21](https://github.com/pooltogether/v4-twab-delegator/pull/21)\n\n\n\n***\n\n## [[N-02] Extra whitespace in slot description of `WithdrewDelegationToStake()` event](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16)\n_Submitted by hickuphh3_\n\n### Line References\n[TWABDelegator.sol#L114](https://github.com/pooltogether/v4-twab-delegator/blob/master/contracts/TWABDelegator.sol#L114)\n\n### Description\nThere is an additional spacing between `slot` and `Slot`.\n\n### Recommended Mitigation Steps\nRemove the spacing to become: `* @param slot Slot of the delegation`\n\n**[PierrickGT (PoolTogether) confirmed and commented](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16#issuecomment-1054830545):**\n> PR: [pooltogether/v4-twab-delegator#21](https://github.com/pooltogether/v4-twab-delegator/pull/21)\n\n\n\n***\n\n## [[N-03] TWABDelegator: Consider renaming `_delegateCall()` to `_setDelegateeCall()`](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16)\n_Submitted by hickuphh3_\n\n### Line References\n[TWABDelegator.sol#L519](https://github.com/pooltogether/v4-twab-delegator/blob/master/contracts/TWABDelegator.sol#L519)\n\n### Description\n`_delegateCall()` could easily be confused for the inbuilt `delegatecall()` method. I recommend renaming it to something more distinguishable like `_setDelegateeCall()`.\n\n**[PierrickGT (PoolTogether) confirmed and commented](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/16#issuecomment-1054830545):**\n> PR: [pooltogether/v4-twab-delegator#21](https://github.com/pooltogether/v4-twab-delegator/pull/21)\n\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 17 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/9) by warden team **CertoraInc** received the top score from the judge.\n\n_The following wardens also submitted reports: [Dravee](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/36), [nascent](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/33), [IllIllI](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/38), [WatchPug](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/31), [robee](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/15), [Tomio](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/32), [sorrynotsorry](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/22), [kenta](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/41), [gzeon](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/30), [rfa](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/44), [z3s](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/25), [Omik](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/45), [0x1f8b](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/37), [ye0lde](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/39), [pedroais](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/48), and [hickuphh3](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/17)._\n\n## [G-01] Loop in `Delegation` and `PermitAndMulticall` contracts\n\nLoops can be optimized in several ways. Let's take for example the loop in the `executeCalls` function of the `Delegation` contract.\n\n```solidity\nfunction executeCalls(Call[] calldata calls) external onlyOwner returns (bytes[] memory) {\n  bytes[] memory response = new bytes[](calls.length);\n  for (uint256 i = 0; i < calls.length; i++) {\n    response[i] = _executeCall(calls[i].to, calls[i].value, calls[i].data);\n  }\n  return response;\n}\n```\n\nTo optimize this loop and make it consume less gas, we can do the foloowing things:\n\n1.  Use ++i instead of i++, which is a cheaper operation (in this case there is no difference between i++ and ++i because we dont use the return value of this expression, which is the only difference between these two expression).\n2.  Save the `calls` array length in a local variable instead of accessing it in every iteration.\n3.  Save `calls[i]` in a local variable instead of accessing it 3 times in every iteration. This will save accssing the array's ith element 3 times in every iteration ,which requires an address calculation.\n4.  There's no need to initialize i to its default value, it will be done automatically and it will consume more gas if it will be done (I know, sounds stupid, but trust me - it works).\n\nSo after applying all these changes, the loop will look something like this:\n\n```solidity\nfunction executeCalls(Call[] calldata calls) external onlyOwner returns (bytes[] memory) {\n  bytes[] memory response = new bytes[](calls.length);\n  uint256 length = calls.length;\n  Call memory call;\n  for (uint256 i; i < length; ++i) {\n    call = calls[i];\n    response[i] = _executeCall(call.to, call.value, call.data);\n  }\n  return response;\n}\n```\n\n## [G-02] Inline all these little functions\n\nDefining all these little functions cause 2 things:\n\n1.  contract's code size gets bigger\n2.  the function calls consumes more gas than exectuing it as an inlined function (part of the code, without the function call)\n\nSo in order to save gas, I would recommend to inline these functions.\n\n```solidity\nfunction _computeAddress(address _delegator, uint256 _slot) internal view returns (address) {\n  return _computeAddress(_computeSalt(_delegator, bytes32(_slot)));\n}\n\nfunction _computeLockUntil(uint96 _lockDuration) internal view returns (uint96) {\n  return uint96(block.timestamp) + _lockDuration;\n}\n\nfunction _requireDelegatorOrRepresentative(address _delegator) internal view {\n  require(\n    _delegator == msg.sender || representatives[_delegator][msg.sender] == true,\n    \"TWABDelegator/not-delegator-or-rep\"\n  );\n}\n\nfunction _requireDelegateeNotZeroAddress(address _delegatee) internal pure {\n  require(_delegatee != address(0), \"TWABDelegator/dlgt-not-zero-adr\");\n}\n\nfunction _requireAmountGtZero(uint256 _amount) internal pure {\n  require(_amount > 0, \"TWABDelegator/amount-gt-zero\");\n}\n\nfunction _requireDelegatorNotZeroAddress(address _delegator) internal pure {\n  require(_delegator != address(0), \"TWABDelegator/dlgtr-not-zero-adr\");\n}\n\nfunction _requireRecipientNotZeroAddress(address _to) internal pure {\n  require(_to != address(0), \"TWABDelegator/to-not-zero-addr\");\n}\n\nfunction _requireDelegationUnlocked(Delegation _delegation) internal view {\n  require(block.timestamp >= _delegation.lockUntil(), \"TWABDelegator/delegation-locked\");\n}\n\nfunction _requireContract(address _address) internal view {\n  require(_address.isContract(), \"TWABDelegator/not-a-contract\");\n}\n\nfunction _requireLockDuration(uint256 _lockDuration) internal pure {\n  require(_lockDuration <= MAX_LOCK, \"TWABDelegator/lock-too-long\");\n}\n```\n\n**[PierrickGT (PoolTogether) confirmed and commented](https://github.com/code-423n4/2022-02-pooltogether-findings/issues/9#issuecomment-1054644165):**\n > PR: [pooltogether/v4-twab-delegator/pull#18](https://github.com/pooltogether/v4-twab-delegator/pull/18)\n> \n> We've implemented the different fixes regarding the for loops, except for the `++i` recommendation, we kept `i++` for better code clarity.\n> About the inline suggestion, we prefer to keep the code in reusable functions to keep a more readable and easier to update codebase than if we had to repeat our code through inlining.\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}