{
  "circa": {
    "title": "Reserve Protocol - Invitational",
    "sponsor": "Reserve",
    "slug": "2023-06-reserve",
    "date": "2023-11-13",
    "findings": "https://github.com/code-423n4/2023-06-reserve-findings/issues",
    "contest": 248
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the Reserve Protocol smart contract system written in Solidity. The audit took place between June 15—June 29 2023.</p>\n<p>Following the C4 audit, 3 wardens (0xA5DF, ronnyx2017, and rvierdiiev) reviewed the mitigations for all identified issues; the <a href=\"#mitigation-review\">mitigation review report</a> is appended below the audit report.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>In Code4rena’s Invitational audits, the competition is limited to a small group of wardens; for this audit, 6 wardens contributed reports:</p>\n<ol>\n<li>0xA5DF</li>\n<li>ronnyx2017</li>\n<li>rvierdiiev</li>\n<li>RaymondFam</li>\n<li><a href=\"https://twitter.com/carlitox477\">carlitox477</a></li>\n<li><a href=\"https://twitter.com/henryxf3\">hihen</a></li>\n</ol>\n<p>This Audit was judged by <a href=\"https://github.com/0xean\">0xean</a>.</p>\n<p>Final report assembled by PaperParachute and <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 14 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 12 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 6 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 4 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-06-reserve\">C4 Reserve Protocol repository</a>, and is composed of 12 smart contracts written in the Solidity programming language and includes 2126 lines of Solidity code.</p>\n<p>In addition to the known issues identified by the project team, the C4udit tool was ran prior to the audit launch. This generated the <a href=\"https://gist.github.com/carlitox477/35963b3c46ebd25927c41ce368b8e10c\">Automated Findings report</a> and all findings therein were classified as out of scope.</p>\n<p><em>Note: the automated findings report also included <a href=\"https://gist.github.com/carlitox477/35963b3c46ebd25927c41ce368b8e10c#M-1\">one medium-severity finding</a> that has been acknowledged by the sponsor and confirmed by the judge.</em></p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"high-risk-findings-2\" style=\"position:relative;\"><a href=\"#high-risk-findings-2\" aria-label=\"high risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (2)</h1>\n<h2 id=\"h-01-custom-redemption-might-revert-if-old-assets-were-unregistered\" style=\"position:relative;\"><a href=\"#h-01-custom-redemption-might-revert-if-old-assets-were-unregistered\" aria-label=\"h 01 custom redemption might revert if old assets were unregistered permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/4\">[H-01] Custom redemption might revert if old assets were unregistered</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/4\">0xA5DF</a></em></p>\n<p><code>quoteCustomRedemption()</code> works under the assumption that the maximum size of the <code>erc20sAll</code> should be <code>assetRegistry.size()</code>, however there can be cases where an asset was unregistered but still exists in an old basket, making the size of the old basket greater than <code>assetRegistry.size()</code>. In that case the function will revert with an index out of bounds error.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Users might not be able to use <code>redeemCustom</code> when needed.</p>\n<p>I think this should be considered high severity, since being able to redeem the token at all time is an essential feature for the protocol that’s allowed also while frozen.\nNot being able to redeem can result in a depeg or in governance becoming malicious and stealing RToken collateral.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Consider the following scenario:</p>\n<ul>\n<li>RToken deployed with 0.9 USDC, 0.05 USDT, 0.05 DAI</li>\n<li>Governance passed a vote to change it to 0.9 DAI and 0.1 USDC and un-register USDT</li>\n<li>Trading is paused before execution, so the basket switch occurs but the re-balance can’t be executed. Meaning the actual assets that the backing manager holds are in accordance with the old basket</li>\n<li>A user wants to redeem using the old basket, but custom redemption reverts</li>\n</ul>\n<p>As for the revert:</p>\n<ul>\n<li><code>erc20sAll</code> is created <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/BasketHandler.sol#L391-L392\">here</a> with the length of <code>assetRegistry.size()</code>, which is 2 in our case.</li>\n<li>Then in <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/BasketHandler.sol#L397-L428\">this loop</a> the function tries to push 3 assets into <code>erc20sAll</code> which will result in an index-out-of-bonds error</li>\n</ul>\n<p>(the function doesn’t include in the final results assets that aren’t registered, but it does push them too into <code>erc20sAll</code>)</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Allow the user to specify the length of the array <code>erc20sAll</code> to avoid this revert</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/4#issuecomment-1586269794\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I believe this to be a stretch for high severity. It has several pre-conditions to end up in the proposed state and I do believe it would be entirely possible for governance to change back to the original state (USDC, USDT, DAI), so assets wouldn’t be lost and the impact would more be along the lines of a temporary denial of service.</p>\n<p>Look forward to warden and sponsor comments. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/4#issuecomment-1587948710\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>@0xA5DF - nice find! Thoughts on an alternative mitigation?</p>\n<ul>\n<li>Could move L438 to just after L417, so that <code>erc20sAll</code> never includes unregistered ERC20s</li>\n<li>Would probably have to cache the assets as <code>assetsAll</code> for re-use around L438</li>\n<li>Has side-effect of making the ERC20 return list never include unregistered ERC20s. Current implementation can return a 0 value for an unregistered ERC20. This is properly handled by the RToken contract, but still, nice-to-have.</li>\n</ul>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/4#issuecomment-1587988163\">0xA5DF (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Hey @tbrent -<br>\nThat can work as well, the only downside I can think of is that in case there’s an asset that’s not registered and is repeated across different baskets - the <code>toAsset()</code> would be called multiple times for that asset (while under the current implementation and under the mitigation I’ve suggested it’ll be called only once), this would cost about 300 gas units per additional call (100 for the call, 2 <code>sload</code>s to a warm slot inside the call itself)</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/4#issuecomment-1588023172\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>@0xA5DF - Noted, good point.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/4#issuecomment-1620824425\">tbrent (Reserve) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/4#issuecomment-1632948695\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@tbrent - do you care to comment on your thoughts on severity? I am leaning towards M on this, but it sounds like you believe it is correct as labeled (high). </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/4#issuecomment-1632984393\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>@0xean - Correct, I think high is appropriate. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation#individual-prs\">Reserve mitigated</a>:</strong></p>\n<blockquote>\n<p>Fix <code>redeemCustom</code>.<br>\nPR: <a href=\"https://github.com/reserve-protocol/protocol/pull/857\">https://github.com/reserve-protocol/protocol/pull/857</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/7\">ronnyx2017</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/30\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/3\">rvierdiiev</a> - and also shared below in the <a href=\"#mitigation-review\">Mitigation Review</a> section.</p>\n<hr>\n<h2 id=\"h-02-a-new-era-might-be-triggered-despite-a-significant-value-being-held-in-the-previous-era\" style=\"position:relative;\"><a href=\"#h-02-a-new-era-might-be-triggered-despite-a-significant-value-being-held-in-the-previous-era\" aria-label=\"h 02 a new era might be triggered despite a significant value being held in the previous era permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/2\">[H-02] A new era might be triggered despite a significant value being held in the previous era</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/2\">0xA5DF</a></em></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/StRSR.sol#L441-L444\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/StRSR.sol#L441-L444</a> <br><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/StRSR.sol#L457-L460\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/StRSR.sol#L457-L460</a></p>\n<p>When RSR seizure occurs the staking and drafting rate is adjusted accordingly, if any of those rates is above some threshold then a new era begins (draft or staking era accordingly), wiping out all of the holdings of the current era.\nThe assumption is that if the rate is above the threshold then there’s not much staking or drafts left after the seizure (and therefore it makes sense to begin a new era).\nHowever, there might be a case where a previous seizure has increased the staking/draft rate close to the threshold, and then even a small seizure would make it cross this threshold. In that case the total value of staking or drafts can be very high, and they will all be wiped out by starting a new era.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Stakers will lose their holdings or pending drafts.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Consider the following scenario:</p>\n<ul>\n<li>Max stake rate is 1e9</li>\n<li>A seizure occurs and the new rate is now 91e7</li>\n<li>Not much staking is left after the seizure, but as time passes users keep staking bring back the total stakes to a significant value</li>\n<li>A 10% seizure occurs, this causes the staking rate to cross the threshold (getting to 1.01e9) and start a new era</li>\n</ul>\n<p>This means the stakings were wiped out despite holding a significant amount of value, causing a loss for the holders.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>This one is a bit difficult to mitigate.\nOne way I can think of is to add a ‘migration’ feature, where in such cases a new era would be created but users would be able to transfer the funds that they held in the previous era into the new era. But this would require some significant code changes and checking that this doesn’t break anything or introduces new bugs.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/2#issuecomment-1588260840\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>@0xA5DF thoughts on a governance function that requires the ratio be out of bounds, that does <code>beginEra()</code> and/or <code>beginDraftEra()</code>? </p>\n<p>The idea is that stakers can mostly withdraw, and since governance thresholds are all percentage, vote to immolate themselves and re-start the staking pool. I think it should treat <code>beginEra()</code> and <code>beginDraftEra()</code> separately, but I’m not confident in that yet. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/2#issuecomment-1620824773\">tbrent (Reserve) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>We’re still not sure how to mitigate this one. Agree it should be considered HIGH and a new issue.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation#individual-prs\">Reserve mitigated</a>:</strong></p>\n<blockquote>\n<p>Adds governance function to manually push the era forward.<br>\nPR: <a href=\"https://github.com/reserve-protocol/protocol/pull/888\">https://github.com/reserve-protocol/protocol/pull/888</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/31\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/8\">ronnyx2017</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/11\">rvierdiiev</a> - and also shared below in the <a href=\"#mitigation-review\">Mitigation Review</a> section.</p>\n<hr>\n<h1 id=\"medium-risk-findings-12\" style=\"position:relative;\"><a href=\"#medium-risk-findings-12\" aria-label=\"medium risk findings 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (12)</h1>\n<h2 id=\"m-01-a-dutch-trade-could-end-up-with-an-unintended-lower-closing-price\" style=\"position:relative;\"><a href=\"#m-01-a-dutch-trade-could-end-up-with-an-unintended-lower-closing-price\" aria-label=\"m 01 a dutch trade could end up with an unintended lower closing price permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/48\">[M-01] A Dutch trade could end up with an unintended lower closing price</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/48\">RaymondFam</a></em></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/plugins/trading/DutchTrade.sol#L160\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/plugins/trading/DutchTrade.sol#L160</a> <br><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/RevenueTrader.sol#L46\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/RevenueTrader.sol#L46</a> <br><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/BackingManager.sol#L81\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/BackingManager.sol#L81</a></p>\n<p><code>notTradingPausedOrFrozen</code> that is turned on and off during an open Dutch trade could have the auction closed with a lower price depending on the timimg, leading to lesser capability to boost the Rtoken and/or stRSR exchange rates as well as a weakened recollaterization.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Here’s the scenario:</p>\n<ol>\n<li>A 30 minute Dutch trade is opened by the Revenue trader selling a suplus token for Rtoken.</li>\n<li>Shortly after the price begins to decrease linearly, Alice calls <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/plugins/trading/DutchTrade.sol#L146-L164\"><code>bid()</code></a>. As can be seen in line 160 of the code block below, <code>settleTrade()</code> is externally called on the <code>origin</code>, RevenueTrader.sol in this case:</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">bid</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;bid already received&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// {qBuyTok}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">bidAmount</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint48</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// enforces auction ongoing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Transfer in buy tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidder</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">buy</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// status must begin OPEN</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">TradeStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">OPEN</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// settle() via callback</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">160</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">origin</span><span class=\"mtk1\">.</span><span class=\"mtk11\">settleTrade</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sell</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// confirm callback succeeded</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">TradeStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">CLOSED</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<ol start=\"3\">\n<li>However, her call is preceded by <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/mixins/Auth.sol#L169-L172\"><code>pauseTrading()</code></a> invoked by a <code>PAUSER</code>, and denied on line 46 of the function below:</li>\n</ol>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/RevenueTrader.sol#L43-L52\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/RevenueTrader.sol#L43-L52</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">settleTrade</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sell</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">override</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ITrading</span><span class=\"mtk1\">, </span><span class=\"mtk12\">TradingP1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">46:        </span><span class=\"mtk11\">notTradingPausedOrFrozen</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">ITrade</span><span class=\"mtk1\"> </span><span class=\"mtk12\">trade</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">trade</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">super</span><span class=\"mtk1\">.</span><span class=\"mtk11\">settleTrade</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sell</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">distributeTokenToBuy</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// unlike BackingManager, do _not_ chain trades; b2b trades of the same token are unlikely</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<ol start=\"4\">\n<li>As the auction is nearing to <code>endTime</code>, the <code>PAUSER</code> calls <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/mixins/Auth.sol#L176-L179\"><code>unpauseIssuance()</code></a>.</li>\n<li>Bob, the late comer, upon seeing this, proceeds to calling <code>bid()</code> and gets the sell token for a price much lower than he would initially expect before the trading pause.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider removing <code>notTradingPausedOrFrozen</code> from the function visibility of <code>RevenueTrader.settleTrade</code> and <code>BackingManager.settleTrade</code>. This will also have a good side effect of allowing the settling of a Gnosis trade if need be. Collectively, the settled trades could at least proceed to helping boost the RToken and/or stRSR exchange rates that is conducive to the token holders redeeming and withdrawing. The same shall apply to enhancing recollaterization, albeit future tradings will be halted if the trading pause is still enabled.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/48#issuecomment-1613819858\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This also seems like QA.  It outlines a very specific set of events that are very unlikely to occur during production scenarios and would additionally come down to admin misconfiguration / mismanagement.  will wait for sponsor comment, but most likely downgrade to QA.</p>\n</blockquote>\n<blockquote>\n<blockquote>\n<ul>\n<li>The PAUSER role should be assigned to an address that is able to act quickly in response to off-chain events, such as a Chainlink feed failing. It is acceptable for there to be false positives, since redemption remains enabled.</li>\n</ul>\n</blockquote>\n<p>It is good to consider this quote from the documentation stating that pausing may have false positives. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/48#issuecomment-1618926905\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>@0xean - We believe a malicious pauser attack vector is dangerous enough that the issue is Medium and deserves a mitigation. Agree with suggested mitigation.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation#individual-prs\">Reserve mitigated</a>:</strong></p>\n<blockquote>\n<p>Allow settle trade when paused or frozen.<br>\nPR: <a href=\"https://github.com/reserve-protocol/protocol/pull/876\">https://github.com/reserve-protocol/protocol/pull/876</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/5\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/32\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/9\">ronnyx2017</a> - and also shared below in the <a href=\"#mitigation-review\">Mitigation Review</a> section.</p>\n<hr>\n<h2 id=\"m-02-the-broker-should-not-be-fully-disabled-by-gnosistradereportviolation\" style=\"position:relative;\"><a href=\"#m-02-the-broker-should-not-be-fully-disabled-by-gnosistradereportviolation\" aria-label=\"m 02 the broker should not be fully disabled by gnosistradereportviolation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/47\">[M-02] The broker should not be fully disabled by GnosisTrade.reportViolation</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/47\">RaymondFam</a></em></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/plugins/trading/GnosisTrade.sol#L202\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/plugins/trading/GnosisTrade.sol#L202</a> <br><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/Broker.sol#L119-L123\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/Broker.sol#L119-L123</a></p>\n<p>GnosisTrade and DutchTrade are two separate auction systems where the failing of either system should not affect the other one. The current design will have <code>Broker.sol</code> disabled when <code>reportViolation</code> is invoked by <code>GnosisTrade.settle()</code> if the auction’s clearing price was below what we assert it should be.</p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/plugins/trading/GnosisTrade.sol#L202\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/plugins/trading/GnosisTrade.sol#L202</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">broker</span><span class=\"mtk1\">.</span><span class=\"mtk11\">reportViolation</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/Broker.sol#L119-L123\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/Broker.sol#L119-L123</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">reportViolation</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">notTradingPausedOrFrozen</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">trades</span><span class=\"mtk1\">[</span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">()], </span><span class=\"mtk8\">&quot;unrecognized trade contract&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">DisabledSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">disabled</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">disabled</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Consequently, both <code>BackingManager</code> and <code>RevenueTrader (rsrTrader and rTokenTrader)</code> will not be able to call <code>openTrade()</code>:</p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/Broker.sol#L97-L98\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/Broker.sol#L97-L98</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"soliidty\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function openTrade(TradeKind kind, TradeRequest memory req) external returns (ITrade) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(!disabled, &quot;broker disabled&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ...</span></span></code></pre>\n<p>till it’s resolved by the governance:</p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/Broker.sol#L180-L183\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/Broker.sol#L180-L183</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setDisabled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">disabled_</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">governance</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">DisabledSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">disabled</span><span class=\"mtk1\">, </span><span class=\"mtk12\">disabled_</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">disabled</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">disabled_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following <code>Trading.trytrade()</code> as inherited by <code>BackingManager</code> and <code>RevenueTrader</code> will be denied on line 121, deterring recollaterization and boosting of Rtoken and stRSR exchange rate. The former deterrence will have <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/RToken.sol#L190\"><code>Rtoken.redeemTo</code></a> and <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/StRSR.sol#L335\"><code>StRSR.withdraw</code></a> (both <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/RToken.sol#L190\">requiring</a> <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/StRSR.sol#L335\"><code>fullyCollateralized</code></a>) denied whereas the latter will have the Rtoken and stRSR holders divested of intended gains.</p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/mixins/Trading.sol#L113-L126\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/mixins/Trading.sol#L113-L126</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidty\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function tryTrade(TradeKind kind, TradeRequest memory req) internal returns (ITrade trade) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /*  */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20 sell = req.sell.erc20();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assert(address(trades[sell]) == address(0));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20Upgradeable(address(sell)).safeApprove(address(broker), 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20Upgradeable(address(sell)).safeApprove(address(broker), req.sellAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">121:        trade = broker.openTrade(kind, req);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        trades[sell] = trade;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        tradesOpen++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit TradeStarted(trade, sell, req.buy.erc20(), req.sellAmount, req.minBuyAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider having the affected code refactored as follows:</p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/Broker.sol#L97-L113\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/Broker.sol#L97-L113</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function openTrade(TradeKind kind, TradeRequest memory req) external returns (ITrade) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        require(!disabled, &quot;broker disabled&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address caller = _msgSender();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        require(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            caller == address(backingManager) ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                caller == address(rsrTrader) ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                caller == address(rTokenTrader),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            &quot;only traders&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // Must be updated when new TradeKinds are created</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (kind == TradeKind.BATCH_AUCTION) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            require(!disabled, &quot;Gnosis Trade disabled&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            return newBatchAuction(req, caller);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        return newDutchAuction(req, ITrading(caller));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>This will have the Gnosis Trade conditionally denied while still allowing the opening of Dutch Trade.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/47#issuecomment-1613867516\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This currently mostly reads like a design suggestion. I can see the merits of disabling the entire broker in the scenario where the invariant has been violated. Probably best as QA, but will allow for sponsor comment before downgrading. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/47#issuecomment-1618919354\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>@0xean - We think this should be kept as Medium. It’s a good design suggestion that otherwise could lead to the protocol not trading for the length of the governance cycle. This matters when it comes to selling defaulted collateral. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation#individual-prs\">Reserve mitigated</a>:</strong></p>\n<blockquote>\n<p>Disable dutch auctions on a per-collateral basis, use 4-step dutch trade curve.<br>\nPRs:<br></p>\n<ul>\n<li><a href=\"https://github.com/reserve-protocol/protocol/pull/873\">https://github.com/reserve-protocol/protocol/pull/873</a><br></li>\n<li><a href=\"https://github.com/reserve-protocol/protocol/pull/869\">https://github.com/reserve-protocol/protocol/pull/869</a><br></li>\n</ul>\n</blockquote>\n<p><strong>Status:</strong> Two mitigation errors. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/20\">ronnyx2017</a> and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/40\">0xA5DF</a> - and also shared below in the <a href=\"#mitigation-review\">Mitigation Review</a> section.</p>\n<hr>\n<h2 id=\"m-03-in-case-distributorsetdistribution-use-revenue-from-rtoken-revenuetrader-and-rsr-token-revenuetrader-should-be-distributed\" style=\"position:relative;\"><a href=\"#m-03-in-case-distributorsetdistribution-use-revenue-from-rtoken-revenuetrader-and-rsr-token-revenuetrader-should-be-distributed\" aria-label=\"m 03 in case distributorsetdistribution use revenue from rtoken revenuetrader and rsr token revenuetrader should be distributed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/34\">[M-03] In case <code>Distributor.setDistribution</code> use, revenue from rToken RevenueTrader and rsr token RevenueTrader should be distributed</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/34\">rvierdiiev</a></em></p>\n<p>In case Distributor.setDistribution use, revenue from rToken RevenueTrader and rsr token RevenueTrader should be distributed. Otherwise wrong distribution will be used.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>BackingManager.forwardRevenue</code> function sends revenue amount to the <code>rsrTrader</code> and <code>rTokenTrader</code> contracts, <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/BackingManager.sol#L236-L249\">according to the distribution inside <code>Distributor</code> contract</a>. For example it can <code>50%</code>/<code>50%</code>. In case if we have 2 destinations in Distributor: strsr and furnace, that means that half of revenue will be received by strsr stakers as rewards.</p>\n<p>This distribution <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/Distributor.sol#L61-L65\">can be changed</a> at any time.<br>\nThe job of <code>RevenueTrader</code> is to sell provided token for a <code>tokenToBuy</code> and then distribute it using <code>Distributor.distribute</code> function. There are 2 ways of auction that are used: dutch and gnosis. Dutch auction will call <code>RevenueTrader.settleTrade</code>, which <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/RevenueTrader.sol#L50\">will initiate distribution</a>. But Gnosis trade will not do that and user should call <code>distributeTokenToBuy</code> manually, after auction is settled.</p>\n<p>The problem that I want to discuss is next.<br>\nSuppose, that governance at the beginning set distribution as 50/50 between 2 destinations: strsr and furnace. And then later <code>forwardRevenue</code> sent some tokens to the rsrTrader and rTokenTrader. Then, when trade was active to exchange some token to rsr token, <code>Distributor.setDistribution</code> was set in order to make strsr share to 0, so now everything goes to Furnace only. As result, when trade will be finished in the rsrTrader and <code>Distributor.distribute</code> will be called, then those tokens will not be sent to the strsr contract, because their share is 0 now.\nThey will be stuck inside rsrTrader.</p>\n<p>Another problem here is that strsr holders should receive all revenue from the time, where they distribution were created. What i mean is if in time 0, rsr share was 50% and in time 10 rsr share is 10%, then <code>BackingManager.forwardRevenue</code> should be called for all tokens that has surplus, because if that will be done after changing to 10%, then strsr stakers will receive less revenue.</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VsCode</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>You need to think how to guarantee fair distribution to the strsr stakers, when distribution params are changed.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/34#issuecomment-1620796074\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This is a good find. The mitigation we have in mind is adding a new function to the <code>RevenueTrader</code> that allows anyone to transfer a registered ERC20 back to the <code>BackingManager</code>, as long as the current distribution for that <code>tokenToBuy</code> is 0%. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation#individual-prs\">Reserve mitigated</a>:</strong></p>\n<blockquote>\n<p>Distribute revenue in <code>setDistribution</code>.<br>\nPR: <a href=\"https://github.com/reserve-protocol/protocol/pull/878\">https://github.com/reserve-protocol/protocol/pull/878</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation error. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/36\">0xA5DF</a> and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/10\">rvierdiiev</a> - and also shared below in the <a href=\"#mitigation-review\">Mitigation Review</a> section.</p>\n<hr>\n<h2 id=\"m-04-furnacep1setratio-will-work-incorrectly-after-call-when-frozen-\" style=\"position:relative;\"><a href=\"#m-04-furnacep1setratio-will-work-incorrectly-after-call-when-frozen-\" aria-label=\"m 04 furnacep1setratio will work incorrectly after call when frozen  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/29\">[M-04] FurnaceP1.setRatio will work incorrectly after call when frozen </a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/29\">rvierdiiev</a></em></p>\n<p><code>FurnaceP1.setRatio</code> will not update <code>lastPayout</code> when called in frozen state, which means that after component will be unfrozen, melting will be incorrect.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>melt</code> function should burn some amount of tokens from <code>lastPayoutBal</code>. It depends of <code>lastPayout</code> and <code>ratio</code> variables. The more time has passed, the more tokens will be burnt.</p>\n<p>When <code>setRatio</code> function is called, then <code>melt</code> function <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/Furnace.sol#L86\">is tried to be executed</a>, because new ratio is provided and it should not be used for previous time ranges.\nIn case if everything is ok, then <code>lastPayout</code> and <code>lastPayoutBal</code> will be updated, so it’s safe to update <code>ratio</code> now.\nBut it’s possible that <code>melt</code> function will revert in case if <code>notFrozen</code> modifier is not passed. As result <code>lastPayout</code> and <code>lastPayoutBal</code> will not be updated, but ratio will be. Because of that, when <code>Furnace</code> will be unfrozen, then melting rate can be much more, then it should be, because <code>lastPayout</code> wasn’t updated.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VsCode</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>In case of <code>catch</code> case, you can update <code>lastPayout</code> and <code>lastPayoutBal</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/29#issuecomment-1620802303\">tbrent (Reserve) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation#individual-prs\">Reserve mitigated</a>:</strong></p>\n<blockquote>\n<p>Update payout variables if melt fails during <code>setRatio</code>.<br>\nPR: <a href=\"https://github.com/reserve-protocol/protocol/pull/885\">https://github.com/reserve-protocol/protocol/pull/885</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation error. Full details in report from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/37\">0xA5DF</a> - and also shared below in the <a href=\"#mitigation-review\">Mitigation Review</a> section.</p>\n<hr>\n<h2 id=\"m-05-lack-of-claimrewards-when-managetoken-in-revenuetrader\" style=\"position:relative;\"><a href=\"#m-05-lack-of-claimrewards-when-managetoken-in-revenuetrader\" aria-label=\"m 05 lack of claimrewards when managetoken in revenuetrader permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/16\">[M-05] Lack of claimRewards when manageToken in RevenueTrader</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/16\">ronnyx2017</a></em></p>\n<p>There is a dev comment in the Assert.sol:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">DEPRECATED: claimRewards() will be removed from all assets and collateral plugins</span></span></code></pre>\n<p>The claimRewards is moved to the <code>TradingP1.claimRewards/claimRewardsSingle</code>.</p>\n<p>But when the <code>RevenueTraderP1</code> trade and distribute revenues by <code>manageToken</code>, it only calls the refresh function of the asserts:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (erc20 != IERC20(address(rToken)) &amp;&amp; tokenToBuy != IERC20(address(rToken))) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IAsset sell_ = assetRegistry.toAsset(erc20);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IAsset buy_ = assetRegistry.toAsset(tokenToBuy);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (sell_.lastSave() != uint48(block.timestamp)) sell_.refresh();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (buy_.lastSave() != uint48(block.timestamp)) buy_.refresh();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>The claimRewards is left out.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Potential loss of rewards.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add claimRewardsSingle when refresh assert in the <code>manageToken</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/16#issuecomment-1588019948\">tbrent (Reserve) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>This is similar to an (unmitigated) issue from an earlier audit: <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/22\">https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/22</a></p>\n<p>However in this case it has to do with <code>RevenueTraderP1.manageToken()</code>, as opposed to <code>BackingManagerP1.manageTokens()</code>. </p>\n<p>I think that difference matters, because the loss of the rewards <em>for this auction</em> does not have serious long-term consequences. This is not like the BackingManager where it’s important that all capital always be available else an unnecessarily large haircut could occur. Instead, the worst that can happen is for the revenue auction to complete at high slippage, and for a second reward token revenue auction to complete afterwards at high slippage yet again, when it could have been a single revenue auction with less slippage. </p>\n<p>The recommended mitigation would not succeed, because recall, we may be selling token X but any number of additional assets could have token X as a reward token. We would need to call <code>claimRewards()</code>, which is simply too gas-costly to do everytime for revenue auctions.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/16#issuecomment-1633111555\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>Instead, the worst that can happen is for the revenue auction to complete at high slippage, and for a second reward token revenue auction to complete afterwards at high slippage yet again, when it could have been a single revenue auction with less slippage.</p>\n</blockquote>\n<p>@tbrent - The impact sounds like a “leak of value” and therefore I think Medium is the correct severity per the c4 docs. (cc @tbrent - open to additional comment here) </p>\n</blockquote>\n<hr>\n<h2 id=\"m-06--oracle-timeout-at-rebalance-will-result-in-a-sell-off-of-all-rsrs-at-0-price\" style=\"position:relative;\"><a href=\"#m-06--oracle-timeout-at-rebalance-will-result-in-a-sell-off-of-all-rsrs-at-0-price\" aria-label=\"m 06  oracle timeout at rebalance will result in a sell off of all rsrs at 0 price permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/15\">[M-06]  Oracle timeout at rebalance will result in a sell-off of all RSRs at 0 price</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/15\">ronnyx2017</a></em></p>\n<p>When creating the trade for rebalance, the <code>RecollateralizationLibP1.nextTradePair</code> uses <code>(uint192 low, uint192 high) = rsrAsset.price(); // {UoA/tok}</code> to get the rsr sell price. And the rsr assert is a pure Assert contract, which <code>price()</code> function will just return (0, FIX_MAX) if oracle is timeout:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function price() public view virtual returns (uint192, uint192) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    try this.tryPrice() returns (uint192 low, uint192 high, uint192) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assert(low &lt;= high);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return (low, high);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } catch (bytes memory errData) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return (0, FIX_MAX);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>The <code>trade.sellAmount</code> will be all the rsr in the <code>BackingManager</code> and <code>stRSR</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint192 rsrAvailable = rsrAsset.bal(address(ctx.bm)).plus(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    rsrAsset.bal(address(ctx.stRSR))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">trade.sellAmount = rsrAvailable;</span></span></code></pre>\n<p>It will be cut down to a normal amount fit for buying UoA amount in the <code>trade.prepareTradeToCoverDeficit</code> function.</p>\n<p>But if the rsr oracle is timeout and returns a 0 low price. The trade req will be made by <code>trade.prepareTradeSell</code>, which will sell all the available rsr at 0 price.</p>\n<p>Note that the SOUND colls won’t be affected by the issue because the sell amount has already been cut down by basketsNeeded.</p>\n<p>Loss huge amount of rsr in the auction. When huge amounts of assets are auctioned off at zero, panic and insufficient liquidity make the outcome unpredictable.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>POC git diff test/Recollateralization.test.ts</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"patch\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/test/Recollateralization.test.ts b/test/Recollateralization.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 86cd3e88..15639916 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/test/Recollateralization.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/Recollateralization.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -51,7 +51,7 @@ import {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import snapshotGasCost from &#39;./utils/snapshotGasCost&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { expectTrade, getTrade, dutchBuyAmount } from &#39;./utils/trades&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { withinQuad } from &#39;./utils/matchers&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-import { expectRTokenPrice, setOraclePrice } from &#39;./utils/oracles&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+import { expectRTokenPrice, setInvalidOracleTimestamp, setOraclePrice } from &#39;./utils/oracles&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { useEnv } from &#39;#/utils/env&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { mintCollaterals } from &#39;./utils/tokens&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -797,6 +797,166 @@ describe(`Recollateralization - P${IMPLEMENTATION}`, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   describe(&#39;Recollateralization&#39;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    context(&#39;With simple Basket - Two stablecoins&#39;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      let issueAmount: BigNumber</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      let stakeAmount: BigNumber</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      beforeEach(async function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Issue some RTokens to user</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        issueAmount = bn(&#39;100e18&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        stakeAmount = bn(&#39;10000e18&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Setup new basket with token0 &amp; token1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await basketHandler.connect(owner).setPrimeBasket([token0.address, token1.address], [fp(&#39;0.5&#39;), fp(&#39;0.5&#39;)])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await basketHandler.connect(owner).refreshBasket()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Provide approvals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await token0.connect(addr1).approve(rToken.address, initialBal)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await token1.connect(addr1).approve(rToken.address, initialBal)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Issue rTokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await rToken.connect(addr1).issue(issueAmount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Stake some RSR</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await rsr.connect(owner).mint(addr1.address, initialBal)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await rsr.connect(addr1).approve(stRSR.address, stakeAmount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await stRSR.connect(addr1).stake(stakeAmount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      it(&#39;C4M7&#39;, async () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Register Collateral</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await assetRegistry.connect(owner).register(backupCollateral1.address)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Set backup configuration - USDT as backup</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await basketHandler</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          .connect(owner)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          .setBackupConfig(ethers.utils.formatBytes32String(&#39;USD&#39;), bn(1), [backupToken1.address])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Set Token0 to default - 50% price reduction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await setOraclePrice(collateral0.address, bn(&#39;0.5e8&#39;))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Mark default as probable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await assetRegistry.refresh()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Advance time post collateral&#39;s default delay</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await advanceTime((await collateral0.delayUntilDefault()).toString())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Confirm default and trigger basket switch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await basketHandler.refreshBasket()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Advance time post warmup period - SOUND just regained</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await advanceTime(Number(config.warmupPeriod) + 1)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        const initToken1B = await token1.balanceOf(backingManager.address);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // rebalance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        const token1Decimal = 6;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        const sellAmt: BigNumber = await token0.balanceOf(backingManager.address)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        const buyAmt: BigNumber = sellAmt.div(2)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await facadeTest.runAuctionsForAllTraders(rToken.address);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // bid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await backupToken1.connect(addr1).approve(gnosis.address, sellAmt)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await gnosis.placeBid(0, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          bidder: addr1.address,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          sellAmount: sellAmt,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          buyAmount: buyAmt,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await advanceTime(config.batchAuctionLength.add(100).toString())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // await facadeTest.runAuctionsForAllTraders(rToken.address);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        const rsrAssert = await assetRegistry.callStatic.toAsset(rsr.address);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await setInvalidOracleTimestamp(rsrAssert);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await expectEvents(facadeTest.runAuctionsForAllTraders(rToken.address), [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            contract: backingManager,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            name: &#39;TradeSettled&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            args: [anyValue, token0.address, backupToken1.address, sellAmt, buyAmt],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            emitted: true,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            contract: backingManager,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            name: &#39;TradeStarted&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            args: [anyValue, rsr.address, backupToken1.address, stakeAmount, anyValue], // sell 25762677277828792981</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            emitted: true,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        ])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // check</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        console.log(await token0.balanceOf(backingManager.address));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        const currentToken1B = await token1.balanceOf(backingManager.address);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        console.log(currentToken1B);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        console.log(await backupToken1.balanceOf(backingManager.address));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        const rsrB = await rsr.balanceOf(stRSR.address);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        console.log(rsrB);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // expect</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        expect(rsrB).to.eq(0);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     context(&#39;With very simple Basket - Single stablecoin&#39;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       let issueAmount: BigNumber</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       let stakeAmount: BigNumber</span></span></span></code></pre>\n<p>run test:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">PROTO_IMPL=1 npx hardhat test --grep &#39;C4M7&#39; test/Recollateralization.test.ts</span></span></code></pre>\n<p>log:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  Recollateralization - P1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Recollateralization</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      With simple Basket - Two stablecoins</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">BigNumber { value: &quot;0&quot; }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">BigNumber { value: &quot;50000000&quot; }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">BigNumber { value: &quot;25000000000000000000&quot; }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">BigNumber { value: &quot;0&quot; }</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Using lotPrice or just revert for rsr oracle timeout might be a good idea.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/15#issuecomment-1588048139\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Hmm, interesting case.</p>\n<p>There are two types of auctions that can occur: batch auctions via <code>GnosisTrade</code>, and dutch auctions via <code>DutchTrade</code>. </p>\n<p>Batch auctions via <code>GnosisTrade</code> are good at discovering prices when price is unknown. It would require self-interested parties to be offline for the entire duration of the batch auction (default: 15 minutes) in order for someone to get away with buying the RSR for close to 0. </p>\n<p>Dutch auctions via <code>DutchTrade</code> do not have this problem because of an assert that reverts at the top of the contract.</p>\n<p>I’m inclined to dispute validity, but I also agree it might be strictly better to use the <code>lotPrice()</code>. When trading out backing collateral it is important to sell it quickly and not have to wait for <code>lotPrice()</code> to decay sufficiently, but this is not true with RSR. For RSR it might be fine to wait as long as a week for the <code>lotPrice()</code> to fall to near 0. </p>\n<p>This would then allow dutch auctions via <code>DutchTrade</code> to be used when RSR’s oracle is offline.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation#individual-prs\">Reserve mitigated</a>:</strong></p>\n<blockquote>\n<p>Use <code>lotPrice()</code>.<br>\nPR: <a href=\"https://github.com/reserve-protocol/protocol-private/pull/15\">https://github.com/reserve-protocol/protocol-private/pull/15</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/13\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/41\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/23\">ronnyx2017</a> - and also shared below in the <a href=\"#mitigation-review\">Mitigation Review</a> section.</p>\n<hr>\n<h2 id=\"m-07-sell-reward-rtokens-at-low-price-because-of-skiping-furnacemelt\" style=\"position:relative;\"><a href=\"#m-07-sell-reward-rtokens-at-low-price-because-of-skiping-furnacemelt\" aria-label=\"m 07 sell reward rtokens at low price because of skiping furnacemelt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/13\">[M-07] Sell reward <code>rTokens</code> at low price because of skiping <code>furnace.melt</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/13\">ronnyx2017</a></em></p>\n<p>The reward rToken sent to RevenueTrader will be sold at a low price. RSR stakers will lose some of their profits.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>RevenueTraderP1.manageToken</code> function is used to launch auctions for any erc20 tokens sent to it. For the RevenueTrader of the rsr stake, the <code>tokenToBuy</code> is rsr and the token to sell is reward rtoken.</p>\n<p>There is the refresh code in the <code>manageToken</code> function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">} else if (assetRegistry.lastRefresh() != uint48(block.timestamp)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Refresh everything only if RToken is being traded</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assetRegistry.refresh();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    furnace.melt();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>It refreshes only when the assetRegistry has not been refreshed in the same block.</p>\n<p>So if the actor calls the <code>assetRegistry.refresh()</code> before calling <code>manageToken</code> function, the <code>furnace.melt()</code> won’t been called. And the BU exchange rate of the RToken will be lower than actual value. So the sellPrice is also going to be smaller.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">(uint192 sellPrice, ) = sell.price(); // {UoA/tok}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">TradeInfo memory trade = TradeInfo({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    sell: sell,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    buy: buy,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    sellAmount: sell.bal(address(this)),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    buyAmount: 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    sellPrice: sellPrice,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    buyPrice: buyPrice</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">});</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Refresh everything before sell rewards.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/13#issuecomment-1620818933\">tbrent (Reserve) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation#individual-prs\">Reserve mitigated</a>:</strong></p>\n<blockquote>\n<p>Refresh before selling rewards, refactor revenue &#x26; distro.<br>\nPR: <a href=\"https://github.com/reserve-protocol/protocol-private/pull/7\">https://github.com/reserve-protocol/protocol-private/pull/7</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/24\">ronnyx2017</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/34\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/14\">rvierdiiev</a> - and also shared below in the <a href=\"#mitigation-review\">Mitigation Review</a> section.</p>\n<hr>\n<h2 id=\"m-08-stake-before-unfreeze-can-take-away-most-of-rsr-rewards-in-the-freeze-period\" style=\"position:relative;\"><a href=\"#m-08-stake-before-unfreeze-can-take-away-most-of-rsr-rewards-in-the-freeze-period\" aria-label=\"m 08 stake before unfreeze can take away most of rsr rewards in the freeze period permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/11\">[M-08] Stake before unfreeze can take away most of rsr rewards in the freeze period</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/11\">ronnyx2017</a>, also found by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/43\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-05-reserve-findings/issues/24\">0xA5DF</a></em></p>\n<p>If the system is frozen, the only allowed operation is <code>stRST.stake</code>. And the <code>_payoutRewards</code> is not called during freeze period:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (!main.frozen()) _payoutRewards();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function payoutRewards() external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    requireNotFrozen();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _payoutRewards();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>So the <code>payoutLastPaid</code> stays before the freeze period. But when the system is unfreezed, accumulated rewards will be released all at once because the block.timestamp leapt the whole freeze period.</p>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>A front runner can stake huge proportion rsr before admin unfreezes the system. And the attacker can get most of rsr rewards in the next block. And he only takes the risk of the <code>unstakingDelay</code> period.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Assumption: there are 2000 rsr stake in the stRSR, and there are 1000 rsr rewards in the <code>rsrRewardsAtLastPayout</code> with a 1 year half-life period.</p>\n<p>And at present, the LONG_FREEZER <code>freezeLong</code> system for 1 year(default).</p>\n<p>After 1 year, at the unfreeze point, a front runner stake 2000 rsr into stRSR. And then the system is unfreeze. And in the next blcok,the front runner unstakes all the stRSR he has for <code>2250 rsr = 2000 principal + 1000 / 2 / 2 rsr rewards</code>.</p>\n<p>The only risk he took is <code>unstakingDelay</code>. The original rsr stakers took the risk of the whole freeze period + <code>unstakingDelay</code> but only got a part of rewards back.</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>payoutRewards before freeze and update payoutLastPaid before unfreeze.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/24\">tbrent (Reserve) confirmed via duplicate issue #24</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation#individual-prs\">Reserve mitigated</a>:</strong></p>\n<blockquote>\n<p><code>payoutRewards</code> before freeze and update <code>payoutLastPaid</code> before unfreeze.<br>\nPR: <a href=\"https://github.com/reserve-protocol/protocol/pull/857\">https://github.com/reserve-protocol/protocol/pull/857</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/15\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/38\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/25\">ronnyx2017</a> - and also shared below in the <a href=\"#mitigation-review\">Mitigation Review</a> section.</p>\n<hr>\n<h2 id=\"m-09-cancelunstake-lack-payoutrewards-before-mint-shares\" style=\"position:relative;\"><a href=\"#m-09-cancelunstake-lack-payoutrewards-before-mint-shares\" aria-label=\"m 09 cancelunstake lack payoutrewards before mint shares permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/10\">[M-09] <code>cancelUnstake</code> lack <code>payoutRewards</code> before mint shares</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/10\">ronnyx2017</a>, also found by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/39\">rvierdiiev</a> and <a href=\"https://github.com/code-423n4/2023-05-reserve-findings/issues/5\">0xA5DF</a></em></p>\n<p><code>cancelUnstake</code> will cancel the withdrawal request in the queue can mint shares as the current <code>stakeRate</code>. But it doesn’t <code>payoutRewards</code> before <code>mintStakes</code>. Therefor it will mint stRsr as a lower rate, which means it will get more rsr.</p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Withdrawers in the unstake queue can <code>cancelUnstake</code> without calling <code>payoutRewards</code> to get more rsr rewards that should not belong to them.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>POC test/ZZStRSR.test.ts git patch</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"patch\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/test/ZZStRSR.test.ts b/test/ZZStRSR.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index ecc31f68..b2809129 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/test/ZZStRSR.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/ZZStRSR.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -1333,6 +1333,46 @@ describe(`StRSRP${IMPLEMENTATION} contract`, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       expect(await stRSR.exchangeRate()).to.be.gt(initialRate)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    it(&#39;cancelUnstake&#39;, async () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      const amount: BigNumber = bn(&#39;10e18&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      // Stake</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await rsr.connect(addr1).approve(stRSR.address, amount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await stRSR.connect(addr1).stake(amount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await rsr.connect(addr2).approve(stRSR.address, amount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await stRSR.connect(addr2).stake(amount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await rsr.connect(addr3).approve(stRSR.address, amount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await stRSR.connect(addr3).stake(amount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      const  initExchangeRate = await stRSR.exchangeRate();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      console.log(initExchangeRate);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      // Unstake addr2 &amp; addr3 at same time (Although in different blocks, but timestamp only 1s)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await stRSR.connect(addr2).unstake(amount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await stRSR.connect(addr3).unstake(amount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      // skip 1000 block PERIOD / 12000s</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await setNextBlockTimestamp(Number(ONE_PERIOD.mul(1000).add(await getLatestBlockTimestamp())))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      // Let&#39;s cancel the unstake in normal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await expect(stRSR.connect(addr2).cancelUnstake(1)).to.emit(stRSR, &#39;UnstakingCancelled&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      let exchangeRate = await stRSR.exchangeRate();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      expect(exchangeRate).to.equal(initExchangeRate)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      // addr3 cancelUnstake after payoutRewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await stRSR.payoutRewards()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await expect(stRSR.connect(addr3).cancelUnstake(1)).to.emit(stRSR, &#39;UnstakingCancelled&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      // Check balances addr2 &amp; addr3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      exchangeRate = await stRSR.exchangeRate();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      expect(exchangeRate).to.be.gt(initExchangeRate)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      const addr2NowAmount = exchangeRate.mul(await stRSR.balanceOf(addr2.address)).div(bn(&#39;1e18&#39;));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      console.log(&quot;addr2&quot;, addr2NowAmount.toString());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      const addr3NowAmount = exchangeRate.mul(await stRSR.balanceOf(addr3.address)).div(bn(&#39;1e18&#39;));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      console.log(&quot;addr3&quot;,addr3NowAmount.toString());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      expect(addr2NowAmount).to.gt(addr3NowAmount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     it(&#39;Rewards should not be handed out when paused but staking should still work&#39;, async () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       await main.connect(owner).pauseTrading()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       await setNextBlockTimestamp(Number(ONE_PERIOD.add(await getLatestBlockTimestamp())))</span></span></span></code></pre>\n<p>The test simulates two users unstake and cancelUnstake operations at the same time.But the addr2 calls payoutRewards after his cancelUnstake. And addr3 calls cancelUnstake after payoutRewards. Addr2 gets more rsr than addr3 in the end.</p>\n<p>run test:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">PROTO_IMPL=1 npx hardhat test --grep cancelUnstake test/ZZStRSR.test.ts</span></span></code></pre>\n<p>log:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  StRSRP1 contract</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Add RSR / Rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">BigNumber { value: &quot;1000000000000000000&quot; }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">addr2 10005345501258588240</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">addr3 10000000000000000013</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Call <code>_payoutRewards</code> before mint shares.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/10#issuecomment-1589913989\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Agree with severity and proposed mitigation.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation#individual-prs\">Reserve mitigated</a>:</strong></p>\n<blockquote>\n<p>Payout rewards during cancelUnstake.<br>\nPR: <a href=\"https://github.com/reserve-protocol/protocol-private/pull/3\">https://github.com/reserve-protocol/protocol-private/pull/3</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/16\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/33\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/26\">ronnyx2017</a> - and also shared below in the <a href=\"#mitigation-review\">Mitigation Review</a> section.</p>\n<hr>\n<h2 id=\"m-10-an-oracle-deprecation-might-lead-the-protocol-to-sell-assets-for-a-low-price\" style=\"position:relative;\"><a href=\"#m-10-an-oracle-deprecation-might-lead-the-protocol-to-sell-assets-for-a-low-price\" aria-label=\"m 10 an oracle deprecation might lead the protocol to sell assets for a low price permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/8\">[M-10] An oracle deprecation might lead the protocol to sell assets for a low price</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/8\">0xA5DF</a></em></p>\n<p>During a Dutch Auction, if a user places a bid, the trade is settled in the same transaction. As part of this process, the backing manager tries to call the <code>rebalance()</code> function again.\nThe call to <code>rebalance()</code> is wrapped in a try-catch block, if an error occurs and the error data is empty, the function will revert.</p>\n<p>The assumption is that if the error data is empty that means it was due to an out-of-gas error, this assumption isn’t always true as mentioned in a <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/234\">previous issue</a> (that wasn’t mitigated).\nIn the case of this issue, this can result in a case where users can’t bid on an auction for some time, ending up selling an asset for a price lower than the market price.</p>\n<h3 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Protocol’s assets will be auctioned for a price lower than the market price.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Consider the following scenario:</p>\n<ul>\n<li>Chainlink announces that an oracle will get deprecated</li>\n<li>Governance passes a proposal to update the asset registry with a new oracle</li>\n<li>A re-balancing is required and executed with a Dutch Auction</li>\n<li>The oracle deprecation happens before the auction price reaches a reasonable value</li>\n<li>Any bid while the oracle is deprecated will revert</li>\n<li>Right before the auction ends the proposal to update the asset becomes available for execution (after the timelock delay has passed). Somebody executes it, bids, and enjoys the low price of the auction.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>On top of checking that the error data is empty, compare the gas before and after to ensure this is an out-of-gas error.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/8#issuecomment-1586331887\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>On the fence on this one, it is based off a known issue from a previous Audit but does show a new problem stemming from the same problem of oracle deprecation. </p>\n<p>Look forward to sponsor comment. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/8#issuecomment-1589910605\">tbrent (Reserve) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>The PoC does not function as specified. Specifically, <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/plugins/trading/DutchTrade.sol#L146\">bidding on an auction</a> does not involve the price at the time of the tx. The price is set at the beginning of the dutch auction in the <code>init()</code> function. Therefore, it is the starting of new auctions that will revert while the oracle is deprecated, while bids will succeed and simply fail to start the next auction. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/8#issuecomment-1633780455\">0xA5DF (warden) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>Therefore, it is the starting of new auctions that will revert while the oracle is deprecated, while bids will succeed and simply fail to start the next auction.</p>\n</blockquote>\n<p>Hey @tbrent -\nI didn’t quite understand the dispute here, if starting the next auction will fail/revert then the bid will revert too.<br>\n<code>bid()</code> calls <code>origin.settleTrade()</code> and <code>settleTrade()</code> calls <code>rebalance()</code>.<br>\nIf <code>rebalance()</code> reverts due to a deprecated oracle then <code>settleTrade()</code> will revert too (<code>rebalance()</code> will revert with empty data, and therefore the catch block will trigger a revert <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/BackingManager.sol#L94\">here</a>).</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/8#issuecomment-1636182107\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>@0xA5DF - Ah, understood now. Agree this is Medium and think it should be counted as a new finding since the consequence (dutch auction economics break) is novel. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/8#issuecomment-1662674844\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>Hey @0xa5df — we’re having some confusion around exactly what happens when a chainlink oracle is deprecated. Do you have details to share about what this ends up looking like? </p>\n<p>We’re having trouble finding documentation on this, and it feels like the aggregator contract should just stay there and return a stale value. Is that not right? Has this happened in the past or has Chainlink committed to a particular approach for deprecating?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/8#issuecomment-1662876091\">0xA5DF (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Hey - It’s a bit difficult to track deprecated Chainlink oracles since Chainlink removes the announcement once they’re deprecated.<br>\nI was able to track one Oracle that was deprecated during the first audit, from the original issue this seems to be <a href=\"https://polygonscan.com/address/0x2E5B04aDC0A3b7dB5Fd34AE817c7D0993315A8a6#readContract#F10\">this one</a>.<br>\nIt seems that what happens is that Chainlink sets the aggregator address to the zero address, which makes the call to <code>latestRoundData()</code> to revert without any data (I guess this is due to the way Solidity handles calls to a non-contract address).<br>\nSee also the PoC in the <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/234\">original issue</a> in the January audit.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/8#issuecomment-1662939816\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>Got it, checks out. Thanks!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation#individual-prs\">Reserve mitigated</a>:</strong></p>\n<blockquote>\n<p>Add oracle deprecation check.<br>\nPR: <a href=\"https://github.com/reserve-protocol/protocol/pull/886\">https://github.com/reserve-protocol/protocol/pull/886</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/35\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/28\">ronnyx2017</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/17\">rvierdiiev</a> - and also shared below in the <a href=\"#mitigation-review\">Mitigation Review</a> section.</p>\n<hr>\n<h2 id=\"m-11-attacker-can-disable-basket-during-un-registration-which-can-cause-an-unnecessary-trade-in-some-cases\" style=\"position:relative;\"><a href=\"#m-11-attacker-can-disable-basket-during-un-registration-which-can-cause-an-unnecessary-trade-in-some-cases\" aria-label=\"m 11 attacker can disable basket during un registration which can cause an unnecessary trade in some cases permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/7\">[M-11] Attacker can disable basket during un-registration, which can cause an unnecessary trade in some cases</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/7\">0xA5DF</a>, also found by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/35\">rvierdiiev</a></em></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/AssetRegistry.sol#L89-L93\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/AssetRegistry.sol#L89-L93</a> <br><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/AssetRegistry.sol#L106-L110\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/AssetRegistry.sol#L106-L110</a></p>\n<p>At the mitigation audit there was an issue regarding the <code>basketHandler.quantity()</code> call at the unregistration process taking up all gas.\nAs a mitigation to that issue the devs set aside some gas and use the remaining to do that call.\nThis opens up to a new kind of attack, where a attacker can cause the call to revert by not supplying enough gas to it.</p>\n<h3 id=\"impact-6\" style=\"position:relative;\"><a href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>This can cause the basket to get disabled, which would require a basket refresh.</p>\n<p>After a basket refresh is done, an additional warmup period has to pass for some functionality to be available again (issuance, rebalancing and forwarding revenue).</p>\n<p>In some cases this might trigger a basket switch that would require the protocol to rebalance via trading, trading can have some slippage which can cause a loss for the protocol.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>quantity()</code> function is being called with the amount of gas that <code>_reserveGas()</code> returns</p>\n<p>If an attacker causes the gas to be just right above <code>GAS_TO_RESERVE</code> the function would be called with 1 unit of gas, causing it to revert:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_reserveGas</span><span class=\"mtk1\">() </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">gas</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">gasleft</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gas</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">GAS_TO_RESERVE</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;not enough gas to unregister safely&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">gas</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">GAS_TO_RESERVE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Regarding the unnecessary trade, consider the following scenario:</p>\n<ul>\n<li>The basket has USDC as the main asset and DAI as a backup token</li>\n<li>A proposal to replace the backup token with USDT was raised</li>\n<li>A proposal to unregister BUSD (which isn’t part of the basket) was raised too</li>\n<li>USDC defaults and DAI kicks in as the backup token</li>\n<li>Both proposals are now ready to execute and the attacker executes the backup proposal first, then the unregister while disabling the basket using the bug in question</li>\n<li>Now, when the basket is refreshed DAI will be replaced with USDT, making the protocol to trade DAI for USDT</li>\n</ul>\n<p>The refresh was unnecessary and therefore the trade too.</p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Reserve gas for the call as well:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function _reserveGas() private view returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 gas = gasleft();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        require(gas &gt; GAS_TO_RESERVE, &quot;not enough gas to unregister safely&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        require(gas &gt;= GAS_TO_RESERVE + MIN_GAS_FOR_EXECUTION, &quot;not enough gas to unregister safely&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        return gas - GAS_TO_RESERVE;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Disclosure: this issue was <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/73#issuecomment-1435483929\">mentioned in the comments</a> to the issue in the mitigation audit; however, since this wasn’t noticed by the devs and isn’t part of the submission, I don’t think this should be considered a known issue.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/7#issuecomment-1586332703\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Applaud @0xA5DF for highlighting this on their own issue.</p>\n<blockquote>\n<p><em>Disclosure: this issue was <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/73#issuecomment-1435483929\">mentioned in the comments</a> to the issue in the mitigation audit, however since this wasn’t noticed by the devs and isn’t part of the submission I don’t think this should be considered a known issue</em></p>\n</blockquote>\n<p>Look forward to discussion with sponsor. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/7#issuecomment-1589904155\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>We’ve discussed and agree with with the warden that this should not be considered a known issue. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation#individual-prs\">Reserve mitigated</a>:</strong></p>\n<blockquote>\n<p>Change gas reservation policy in <code>AssetRegistry</code>.<br>\nPR: <a href=\"https://github.com/reserve-protocol/protocol/pull/857\">https://github.com/reserve-protocol/protocol/pull/857</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/27\">ronnyx2017</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/39\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/18\">rvierdiiev</a> - and also shared below in the <a href=\"#mitigation-review\">Mitigation Review</a> section.</p>\n<hr>\n<h2 id=\"m-12-custom-redemption-can-be-used-to-get-more-than-rtoken-value-when-an-upwards-depeg-occurs\" style=\"position:relative;\"><a href=\"#m-12-custom-redemption-can-be-used-to-get-more-than-rtoken-value-when-an-upwards-depeg-occurs\" aria-label=\"m 12 custom redemption can be used to get more than rtoken value when an upwards depeg occurs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/6\">[M-12] Custom redemption can be used to get more than RToken value, when an upwards depeg occurs</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/6\">0xA5DF</a></em></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/RToken.sol#L245-L338\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/RToken.sol#L245-L338</a> <br><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/BasketHandler.sol#L437-L440\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/BasketHandler.sol#L437-L440</a></p>\n<p>Custom redemption allows to redeem RToken in exchange of a mix of previous baskets (as long as it’s not more than the prorata share of the redeemer).\nThe assumption is that previous baskets aren’t worth more than the target value of the basket.\nHowever, a previous basket can contain a collateral that depegged upwards and is now actually worth more than its target.</p>\n<h3 id=\"impact-7\" style=\"position:relative;\"><a href=\"#impact-7\" aria-label=\"impact 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Funds that are supposed to go revenue traders would be taken by an attacker redeeming RToken.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/plugins/assets/FiatCollateral.sol#L142-L148\">following code</a> shows that when a depeg occurs the collateral becomes IFFY (which means it’ll be disabled after a certain delay):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// If the price is below the default-threshold price, default eventually</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// uint192(+/-) is the same as Fix.plus/minus</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pegPrice</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">pegBottom</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">pegPrice</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">pegTop</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">low</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">markStatus</span><span class=\"mtk1\">(</span><span class=\"mtk12\">CollateralStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">IFFY</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">markStatus</span><span class=\"mtk1\">(</span><span class=\"mtk12\">CollateralStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">SOUND</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span></code></pre>\n<p>Consider the following scenario:</p>\n<ul>\n<li>Basket contains token X which is supposed to be pegged to c</li>\n<li>Token X depegs upwards and is now worth 2c</li>\n<li>After <code>delayUntilDefault</code> passes the basket gets disabled</li>\n<li>A basket refresh is executed (can be done by anybody) and token Y kicks in as the backup token</li>\n<li>Half of token X is now traded for the required Y tokens</li>\n<li>The other half should go to revenue traders (rsr trader and Furnace), but before anyone calls ‘forewardRevenue’ the attacker calls custom redemption with half from the current basket and half of the previous one</li>\n<li>The user would get 0.5X+0.5Y per each RToken which is worth 1.5c</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>When doing custom redemption check that the collateral used is sound or at least check that the price isn’t higher then the peg price.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/6#issuecomment-1620823067\">tbrent (Reserve) acknowledged, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>This is also true of normal redemption via <code>redeem()</code> until <code>refreshBasket()</code> is called after the collateral has cycled from IFFY to DISABLED. </p>\n<p>It only checks <code>basketHandler.fullyCollateralized()</code>, not <code>basketHandler.isReady()</code>. This is intended. It is important to not disallow redemption, and using USD prices to determine redemption quantities is opposite to the fundamental design of the protocol. </p>\n<p>Agree that the behavior is as the warden indicates. All alternatives seem worse, however. I think this is probably not HIGH. We do not expect to make any change to the behavior. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/6#issuecomment-1632945825\">0xean (judge) reduced severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I think Medium seems like the correct severity here.  There are pre-conditions for this to occur and in addition the likelihood doesn’t seem very high.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this Audit, 6 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/25\">report highlighted below</a> by <strong>0xA5DF</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/56\">hihen</a>,\n<a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/49\">RaymondFam</a>,\n<a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/28\">rvierdiiev</a>,\n<a href=\"https://github.com/code-423n4/2023-05-reserve-findings/issues/26\">carlitox477</a>, and\n<a href=\"https://github.com/code-423n4/2023-05-reserve-findings/issues/21\">ronnyx2017</a>.</em></p>\n<h2 id=\"01-a-redeemer-might-get-front-run-by-a-freezer\" style=\"position:relative;\"><a href=\"#01-a-redeemer-might-get-front-run-by-a-freezer\" aria-label=\"01 a redeemer might get front run by a freezer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[01] A redeemer might get ‘front-run’ by a freezer</h2>\n<p>Before redemption <code>furnace.melt()</code> is called, which increases a bit the amount of assets the redeemer gets in return.\nWhile frozen the <code>melt()</code> call will revert, but since the call is surrounded by a try-catch block the redemption will continue.</p>\n<p>This can lead to a case where a user sends out a redeem tx, expecting melt to be called by the redeem function,  but before the tx is executed the protocol gets frozen. This means the user wouldn’t get the additional value they expected to get from melting (and that they can get if they choose to wait till after the freeze is over).</p>\n<p>If the last time <code>melt()</code> was called wasn’t long enough then the additional value from melting wouldn’t be that significant. But there can be cases where it can be longer - e.g. low activity or after a freeze (meaning there are 2 freezes one after the other and a user is attempting to redeem between them).</p>\n<p>As a mitigation allow the user to specify if they’re ok with skipping the call to <code>melt()</code>, if they didn’t specifically allow it then revert.</p>\n<h2 id=\"02-leaky-refresh-math-is-incorrect\" style=\"position:relative;\"><a href=\"#02-leaky-refresh-math-is-incorrect\" aria-label=\"02 leaky refresh math is incorrect permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[02] Leaky refresh math is incorrect</h2>\n<p><code>leakyRefresh()</code> keeps track of the percentage that was withdrawn since last refresh by adding up the current percentage that’s being withdrawn each time.\nHowever, the current percentage is being calculated as part of the current <code>totalRSR</code>, which doesn’t account for the already withdrawn drafts.</p>\n<p>This will trigger the <code>withdrawalLeak</code> threshold earlier than expected.\nE.g. if the threshold is set to <code>25%</code> and 26 users try to withdraw <code>1%</code> each - the leaky refresh would be triggered by the 23rd person rather than by the 26th.</p>\n<h2 id=\"03-reorg-attack\" style=\"position:relative;\"><a href=\"#03-reorg-attack\" aria-label=\"03 reorg attack permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[03] Reorg attack</h2>\n<p>Reorg attacks aren’t very common on mainnet (but more common on L2s if the protocol intends to ever launch on them), but they can still happen (there was <a href=\"https://decrypt.co/101390/ethereum-beacon-chain-blockchain-reorg\">a 7 blocks reorg</a> on the Beacon chain before the merge).\nIt can be relevant in the following cases (I’ve reported a med separately, the followings are the ones I consider low):</p>\n<ul>\n<li>RToken deployment - a user might mint right after the RToken was deployed, a reorg might be used to deploy a different RToken and trap the users’ funds in it (since the deployer becomes the owner).</li>\n<li>Dutch Auction - a reorg might switch the addresses of 2 auctions, causing the user to bid on the wrong auction </li>\n<li>Gnosis auctions - this can also cause the user to bid on the wrong auction (it’s more relevant for the <code>EasyAuction</code> contract which is OOS)</li>\n</ul>\n<p>As a mitigation - make sure to deploy all contracts with <code>create2</code> using a salt that’s unique to the features of the contract, that will ensure that even in the case of a reorg it wouldn’t be deployed to the same address as before.</p>\n<h2 id=\"04-distributetokentobuy-can-be-called-while-pausedfrozen\" style=\"position:relative;\"><a href=\"#04-distributetokentobuy-can-be-called-while-pausedfrozen\" aria-label=\"04 distributetokentobuy can be called while pausedfrozen permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[04] <code>distributeTokenToBuy()</code> can be called while paused/frozen</h2>\n<p>Due to the removal of <code>notPausedOrFrozen</code> from <code>Distributor.distribute()</code> it’s now possible to execute <code>RevenueTrader.distributeTokenToBuy()</code> while paused or frozen.</p>\n<p>This is relevant when <code>tokensToBuy</code> is sent directly to the revenue trader: RSR sent to RSRTrader or RToken sent directly to RTokenTrader</p>\n<h2 id=\"05-redeemcustom-allows-the-use-of-the-zero-basket\" style=\"position:relative;\"><a href=\"#05-redeemcustom-allows-the-use-of-the-zero-basket\" aria-label=\"05 redeemcustom allows the use of the zero basket permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[05] <code>redeemCustom</code> allows the use of the zero basket</h2>\n<p>The basket with nonce <code>#0</code> is an empty basket, <code>redeemCustom</code> allows to specify that basket for redemption, which will result in a loss for the redeemer.</p>\n<h2 id=\"06-refreshbasket-can-be-called-before-the-first-prime-basket-was-set\" style=\"position:relative;\"><a href=\"#06-refreshbasket-can-be-called-before-the-first-prime-basket-was-set\" aria-label=\"06 refreshbasket can be called before the first prime basket was set permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[06] <code>refreshBasket</code> can be called before the first prime basket was set</h2>\n<p>This will result in an event being emitted but will not impact the contract’s state.</p>\n<h2 id=\"07-min_auction_length-seems-too-low\" style=\"position:relative;\"><a href=\"#07-min_auction_length-seems-too-low\" aria-label=\"07 min_auction_length seems too low permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[07] <code>MIN_AUCTION_LENGTH</code> seems too low</h2>\n<p>The current <code>MIN_AUCTION_LENGTH</code> is set to 2 blocks.\nThis seems a bit too low since the price is time-dependant that means there would be only 3 price options for the auctions, and the final price wouldn’t necessarily be the optimal price for the protocol.</p>\n<h2 id=\"08-if-a-token-that-yields-rsr-would-be-used-as-collateral-then-100-of-the-yield-would-go-to-strsr\" style=\"position:relative;\"><a href=\"#08-if-a-token-that-yields-rsr-would-be-used-as-collateral-then-100-of-the-yield-would-go-to-strsr\" aria-label=\"08 if a token that yields rsr would be used as collateral then 100 of the yield would go to strsr permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[08] If a token that yields RSR would be used as collateral then 100% of the yield would go to StRSR</h2>\n<p>This isn’t very likely to happen (currently the only token that yields RSR is StRSR of another RToken) but it’s worth keeping an eye on it.</p>\n<h2 id=\"09-protocol-might-not-be-able-to-compromise-basket-when-needed\" style=\"position:relative;\"><a href=\"#09-protocol-might-not-be-able-to-compromise-basket-when-needed\" aria-label=\"09 protocol might not be able to compromise basket when needed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[09] Protocol might not be able to compromise basket when needed</h2>\n<p>Consider the following scenario:</p>\n<ul>\n<li>Protocol suffers from some loss and compromises the basket to a 1.1e9 ratio</li>\n<li>Months pass by and users mint new tokens and increase the TVL</li>\n<li>A small compromise is required (12%), this brings the ratio to below 1e9 and reverts the compromise</li>\n<li>Protocol is now disabled despite holding a significant amount of value, and users can only redeem for their prorata share of the assets,</li>\n</ul>\n<p>This might be intended design, but worth taking this scenario into account.</p>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this Audit, 4 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/3\">report highlighted below</a> by <strong>0xA5DF</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/55\">hihen</a>,\n<a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/50\">RaymondFam</a>, and\n<a href=\"https://github.com/code-423n4/2023-05-reserve-findings/issues/27\">carlitox477</a>.</em></p>\n<h2 id=\"g-01-at-tocoll-and-toasset-use-the-mapping-to-check-if-asset-exists\" style=\"position:relative;\"><a href=\"#g-01-at-tocoll-and-toasset-use-the-mapping-to-check-if-asset-exists\" aria-label=\"g 01 at tocoll and toasset use the mapping to check if asset exists permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] At <code>toColl()</code> and <code>toAsset()</code> use the mapping to check if asset exists</h2>\n<p>Savings: ~2.1K per call</p>\n<p>Notice this is a function that’s being called frequently, and many times per tx.</p>\n<p><strong>Overall this can save a few thousands of gas units per tx for the most common txs (e.g. issuance, redemption)</strong></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/AssetRegistry.sol#L120-L132\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/AssetRegistry.sol#L120-L132</a></p>\n<p>At <code>toColl()</code> and <code>toAsset()</code> instead of using the EnumberableSet to check that the erc20 is registered just check that the value returned from the mapping isn’t zero (this is supposed to be equivalent as long as the governance doesn’t register the zero address as an asset contract - maybe add a check for that at <code>register()</code>).</p>\n<p>Proposed changes:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// Return the Asset registered for erc20; revert if erc20 is not registered.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// checks: erc20 in assets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// returns: assets[erc20]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">toAsset</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">IAsset</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IAsset</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">IAsset</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)), </span><span class=\"mtk8\">&quot;erc20 unregistered&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// Return the Collateral registered for erc20; revert if erc20 is not registered as Collateral</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// checks: erc20 in assets, assets[erc20].isCollateral()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// returns: assets[erc20]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">toColl</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">ICollateral</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IAsset</span><span class=\"mtk1\"> </span><span class=\"mtk12\">coll</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">coll</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">IAsset</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)), </span><span class=\"mtk8\">&quot;erc20 unregistered&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">coll</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isCollateral</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">&quot;erc20 is not collateral&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ICollateral</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">coll</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"g-02-get-targetindex-from-mapping-instead-of-iterating\" style=\"position:relative;\"><a href=\"#g-02-get-targetindex-from-mapping-instead-of-iterating\" aria-label=\"g 02 get targetindex from mapping instead of iterating permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Get <code>targetIndex</code> from mapping instead of iterating</h2>\n<p>Gas savings: a few thousands (see below)</p>\n<p>The following code is used at the <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/mixins/BasketLib.sol#L196-L198\">BasketLib</a> to find the index of a value inside an <code>EnumerableSet</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">targetIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">targetIndex</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">targetsLength</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">targetIndex</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">targetNames</span><span class=\"mtk1\">.</span><span class=\"mtk11\">at</span><span class=\"mtk1\">(</span><span class=\"mtk12\">targetIndex</span><span class=\"mtk1\">) == </span><span class=\"mtk12\">config</span><span class=\"mtk1\">.</span><span class=\"mtk12\">targetNames</span><span class=\"mtk1\">[</span><span class=\"mtk12\">config</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc20s</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]]) </span><span class=\"mtk15\">break</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span></code></pre>\n<p>However the index can be fetched directly from the <code>_indexed</code> mapping:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/p1/mixins/BasketLib.sol b/contracts/p1/mixins/BasketLib.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index bc52d1c6..ce56c715 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/p1/mixins/BasketLib.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/p1/mixins/BasketLib.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -192,10 +192,8 @@ library BasketLibP1 {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // For each prime collateral token:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         for (uint256 i = 0; i &lt; config.erc20s.length; ++i) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // Find collateral&#39;s targetName index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            uint256 targetIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            for (targetIndex = 0; targetIndex &lt; targetsLength; ++targetIndex) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                if (targetNames.at(targetIndex) == config.targetNames[config.erc20s[i]]) break;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            uint256 targetIndex = targetNames._inner._indexes[config.targetNames[config.erc20s[i]]] -1 ;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             assert(targetIndex &lt; targetsLength);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // now, targetNames[targetIndex] == config.targetNames[erc20]</span></span></span></code></pre>\n<p>Gas savings:</p>\n<ul>\n<li>The <code>_indexes</code> keys are considered warm since all values were inserted in the current tx</li>\n<li>Total saving is the sum of the index of the target names per each erc20 minus 1</li>\n<li>\n<p>on average (depends on the location of the target in the set for each erc20): <code>(config.erc20s.length)*(targetsLength-1)/2*100</code></p>\n<ul>\n<li>E.g. for target length of 5 and 10 ERC20 that would save on average <code>10*4/2*100=2K</code></li>\n</ul>\n</li>\n</ul>\n<h2 id=\"g-03-use-furnace-instead-of-mainfurnace\" style=\"position:relative;\"><a href=\"#g-03-use-furnace-instead-of-mainfurnace\" aria-label=\"g 03 use furnace instead of mainfurnace permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Use <code>furnace</code> instead of <code>main.furnace()</code></h2>\n<p>Gas savings: ~2.6K</p>\n<p>Code: <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/RToken.sol#L184\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/RToken.sol#L184</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/RToken.sol#L257\">https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/RToken.sol#L257</a></p>\n<p>At <code>RToken.redeemTo()</code> and <code>redeemCustom()</code> furnace is being called using <code>main.furnace()</code> instead of using the <code>furnace</code> variable.</p>\n<p>The call to <code>main.furnace()</code> costs both the cold storage variable read at <code>main.furnace()</code> and an external call to a cold address while using the <code>furnace</code> variable of the current contract costs only the cold storage read.</p>\n<p>The additional cold call would cost ~2.6K.</p>\n<p>To my understanding both of the values should be equal at all times so there shouldn’t be an issue with the replacement.</p>\n<h2 id=\"g-04-deployerimplementations-can-be-immutable\" style=\"position:relative;\"><a href=\"#g-04-deployerimplementations-can-be-immutable\" aria-label=\"g 04 deployerimplementations can be immutable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Deployer.implementations can be immutable</h2>\n<p>Gas saved: ~28K per RToken deployment</p>\n<p>The struct itself can’t be immutable, but you can save the values of the fields (and fields of the <code>components</code>) as immutable variables, and use an internal function to build the struct out of those immutable variables.</p>\n<p>This would save ~2.1K per field, with 13 fields that brings us to ~28K of units saved.</p>\n<h2 id=\"g-05-update-lastwithdrawrefresh-only-if-it-has-changed\" style=\"position:relative;\"><a href=\"#g-05-update-lastwithdrawrefresh-only-if-it-has-changed\" aria-label=\"g 05 update lastwithdrawrefresh only if it has changed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Update <code>lastWithdrawRefresh</code> only if it has changed</h2>\n<p>Gas saved: ~100</p>\n<p>At <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/StRSR.sol#L674\"><code>leakyRefresh()</code></a> <code>lastWithdrawRefresh</code> gets updated even if didn’t change, that costs an additional 100 gas units.</p>\n<p>Proposed change:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        leaked = lastWithdrawRefresh != lastRefresh ? withdrawal : leaked + withdrawal;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        lastWithdrawRefresh = lastRefresh;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if(lastWithdrawRefresh != lastRefresh){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                leaked =  withdrawal;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                lastWithdrawRefresh = lastRefresh;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        } else{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                leaked = leaked + withdrawal;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        }</span></span></span></code></pre>\n<h2 id=\"g-06-require-array-to-be-sorted-and-use-sortedandallunique-at-backingmanagerforwardrevenue\" style=\"position:relative;\"><a href=\"#g-06-require-array-to-be-sorted-and-use-sortedandallunique-at-backingmanagerforwardrevenue\" aria-label=\"g 06 require array to be sorted and use sortedandallunique at backingmanagerforwardrevenue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Require array to be sorted and use <code>sortedAndAllUnique</code> at <code>BackingManager.forwardRevenue()</code></h2>\n<p>Estimated savings: <code>~n^2*10</code> where n is the length of the asset.<br>\nFor example for 20 assets that would save ~4K.</p>\n<h2 id=\"g-07-caching-storage-variable-and-function-calls\" style=\"position:relative;\"><a href=\"#g-07-caching-storage-variable-and-function-calls\" aria-label=\"g 07 caching storage variable and function calls permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] Caching storage variable and function calls</h2>\n<p>This is one of the most common ways to save a nice amount of gas. Every additional read costs 100 gas units (when it comes to mapping or arrays there’s additional cost), and each additional function call costs at least 100 gas units (usually much more).</p>\n<p>I’ve noticed a few instances where a storage variable read or a view-function call can be cached to memory to save gas, I’m pretty sure there are many more instances that I didn’t notice.</p>\n<h2 id=\"g-08basketlibnextbasket-refactoring\" style=\"position:relative;\"><a href=\"#g-08basketlibnextbasket-refactoring\" aria-label=\"g 08basketlibnextbasket refactoring permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08]<code>BasketLib.nextBasket()</code> refactoring</h2>\n<p>Gas saved: a few thousand</p>\n<p>The following refactoring saves a few thousands of gas mostly by preventing:</p>\n<ol>\n<li>Double call to <code>goodCollateral</code></li>\n<li>\n<p>The second iteration over the whole <code>backup.erc20s</code> array </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/p1/mixins/BasketLib.sol b/contracts/p1/mixins/BasketLib.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index bc52d1c6..7ab9c48b 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/p1/mixins/BasketLib.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/p1/mixins/BasketLib.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -192,10 +192,8 @@ library BasketLibP1 {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // For each prime collateral token:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     for (uint256 i = 0; i &lt; config.erc20s.length; ++i) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Find collateral&#39;s targetName index</span></span></span></code></pre>\n</li>\n<li>uint256 targetIndex;</li>\n<li>for (targetIndex = 0; targetIndex &#x3C; targetsLength; ++targetIndex) {</li>\n<li>if (targetNames.at(targetIndex) == config.targetNames[config.erc20s[i]]) break;</li>\n<li>}</li>\n<li>uint256 targetIndex = targetNames.<em>inner.</em>indexes[config.targetNames[config.erc20s[i]]] -1 ;</li>\n<li>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">     assert(targetIndex &lt; targetsLength);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     // now, targetNames[targetIndex] == config.targetNames[erc20]</span></span></code></pre>\n</li>\n</ol>\n<p>@@ -244,32 +242,32 @@ library BasketLibP1 {\nuint256 size = 0; // backup basket size\nBackupConfig storage backup = config.backups[targetNames.at(i)];</p>\n<ul>\n<li>IERC20[] memory backupsToUse = new IERC20<a href=\"backup.erc20s.length\"></a>;</li>\n<li>+\n// Find the backup basket size: min(backup.max, # of good backup collateral)\nfor (uint256 j = 0; j &#x3C; backup.erc20s.length &#x26;&#x26; size &#x3C; backup.max; ++j) {</li>\n<li>if (goodCollateral(targetNames.at(i), backup.erc20s[j], assetRegistry)) size++;</li>\n<li>if (goodCollateral(targetNames.at(i), backup.erc20s[j], assetRegistry)) </li>\n<li>{</li>\n<li>backupsToUse[size] = backup.erc20s[j];</li>\n<li>size++;</li>\n<li>\n<p>}\n}</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">     // Now, size = len(backups(tgt)). If empty, fail.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     if (size == 0) return false;</span></span></code></pre>\n</li>\n<li>// Set backup basket weights…</li>\n<li>\n<p>uint256 assigned = 0;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">     // Loop: for erc20 in backups(tgt)...</span></span></code></pre>\n</li>\n<li>for (uint256 j = 0; j &#x3C; backup.erc20s.length &#x26;&#x26; assigned &#x3C; size; ++j) {</li>\n<li>if (goodCollateral(targetNames.at(i), backup.erc20s[j], assetRegistry)) {</li>\n<li>// Across this .add(), targetWeight(newBasket’,erc20)</li>\n<li>// = targetWeight(newBasket,erc20) + unsoundPrimeWt(tgt) / len(backups(tgt))</li>\n<li>newBasket.add(</li>\n<li>backup.erc20s[j],</li>\n<li>totalWeights[i].minus(goodWeights[i]).div(</li>\n<li>// this div is safe: targetPerRef > 0: goodCollateral check</li>\n<li>assetRegistry.toColl(backup.erc20s[j]).targetPerRef().mulu(size),</li>\n<li>CEIL</li>\n<li>)</li>\n<li>);</li>\n<li>assigned++;</li>\n<li>}</li>\n<li>for (uint256 j = 0; j &#x3C; size; ++j) {</li>\n<li>+</li>\n<li>newBasket.add(</li>\n<li>backupsToUse[j],</li>\n<li>totalWeights[i].minus(goodWeights[i]).div(</li>\n<li>// this div is safe: targetPerRef > 0: goodCollateral check</li>\n<li>assetRegistry.toColl(backupsToUse[j]).targetPerRef().mulu(size),</li>\n<li>CEIL</li>\n<li>)</li>\n<li>\n<p>);\n}\n// Here, targetWeight(newBasket, e) = primeWt(e) + backupWt(e) for all e targeting tgt\n}</p>\n<pre><code></code></pre>\n</li>\n</ul>\n<h2 id=\"g-09-basketlibnextbasket-caching\" style=\"position:relative;\"><a href=\"#g-09-basketlibnextbasket-caching\" aria-label=\"g 09 basketlibnextbasket caching permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] <code>BasketLib.nextBasket()</code> caching</h2>\n<p>On top of the above refactoring:</p>\n<ul>\n<li><code>config.erc20s[i]</code> is being read a few times <a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/mixins/BasketLib.sol#L193-L224\">here</a></li>\n<li><code>config.erc20s.length</code> and <code>backup.erc20s.length</code> can be cached</li>\n<li><code>targetNames.at(i)</code> is  being read twice in the second loop (3 before the proposed refactoring)</li>\n</ul>\n<h2 id=\"g-10sellamount-at-dutchtradesettle\" style=\"position:relative;\"><a href=\"#g-10sellamount-at-dutchtradesettle\" aria-label=\"g 10sellamount at dutchtradesettle permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10]<code>sellAmount</code> at <code>DutchTrade.settle()</code></h2>\n<p><code>sellAmount</code> is read here twice if greater than <code>sellBal</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">soldAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">sellAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">sellBal</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">sellAmount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">sellBal</span><span class=\"mtk1\"> : </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"g-11-quotecustomredemption-loop\" style=\"position:relative;\"><a href=\"#g-11-quotecustomredemption-loop\" aria-label=\"g 11 quotecustomredemption loop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-11] <code>quoteCustomRedemption()</code> loop</h2>\n<h3 id=\"nonce\" style=\"position:relative;\"><a href=\"#nonce\" aria-label=\"nonce permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code>nonce</code></h3>\n<p>Savings: <code>100*basketNonces.length</code><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/c4ec2473bbcb4831d62af55d275368e73e16b984/contracts/p1/BasketHandler.sol#L398\">Here</a> nonce is being read each iteration.\nIt can be cached outside of the loop.</p>\n<h3 id=\"basketnonceslength\" style=\"position:relative;\"><a href=\"#basketnonceslength\" aria-label=\"basketnonceslength permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code>basketNonces.length</code></h3>\n<p>Savings: <code>100*basketNonces.length</code></p>\n<h3 id=\"berc20slength\" style=\"position:relative;\"><a href=\"#berc20slength\" aria-label=\"berc20slength permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code>b.erc20s.length</code></h3>\n<p>Savings: <code>100*(sum of</code>b.erc20s.length<code>for all baskets)</code></p>\n<h2 id=\"g-12-use-custom-errors-instead-of-string-errors\" style=\"position:relative;\"><a href=\"#g-12-use-custom-errors-instead-of-string-errors\" aria-label=\"g 12 use custom errors instead of string errors permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-12] Use custom errors instead of string errors</h2>\n<p>This saves gas both for deployment and in case that the revert is triggered.</p>\n<hr>\n<h1 id=\"mitigation-review\" style=\"position:relative;\"><a href=\"#mitigation-review\" aria-label=\"mitigation review permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"#mitigation-review\">Mitigation Review</a></h1>\n<h2 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p>Following the C4 audit, 3 wardens (0xA5DF, ronnyx2017, and rvierdiiev) reviewed the mitigations for all identified issues. Additional details can be found within the <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation\">C4 Reserve Protocol Mitigation Review repository</a>.</p>\n<h2 id=\"mitigation-review-scope\" style=\"position:relative;\"><a href=\"#mitigation-review-scope\" aria-label=\"mitigation review scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review Scope</h2>\n<h3 id=\"branch\" style=\"position:relative;\"><a href=\"#branch\" aria-label=\"branch permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Branch</h3>\n<p><a href=\"https://github.com/reserve-protocol/protocol/pull/882\">https://github.com/reserve-protocol/protocol/pull/882</a> (commit hash 99d9db72e04db29f8e80e50a78b16a0b475d79f3)</p>\n<h3 id=\"individual-prs\" style=\"position:relative;\"><a href=\"#individual-prs\" aria-label=\"individual prs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Individual PRs</h3>\n<table>\n<thead>\n<tr>\n<th>URL</th>\n<th>Mitigation of</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/857\">https://github.com/reserve-protocol/protocol/pull/857</a></td>\n<td>H-01</td>\n<td>Fix redeemCustom</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/888\">https://github.com/reserve-protocol/protocol/pull/888</a></td>\n<td>H-02</td>\n<td>Adds governance function to manually push the era forward</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/876\">https://github.com/reserve-protocol/protocol/pull/876</a></td>\n<td>M-01</td>\n<td>Allow settle trade when paused or frozen</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/873\">https://github.com/reserve-protocol/protocol/pull/873</a> &#x26; <a href=\"https://github.com/reserve-protocol/protocol/pull/869\">https://github.com/reserve-protocol/protocol/pull/869</a></td>\n<td>M-02</td>\n<td>Disable dutch auctions on a per-collateral basis, use 4-step dutch trade curve</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/878\">https://github.com/reserve-protocol/protocol/pull/878</a></td>\n<td>M-03</td>\n<td>Distribute revenue in setDistribution</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/885\">https://github.com/reserve-protocol/protocol/pull/885</a></td>\n<td>M-04</td>\n<td>Update payout variables if melt fails during setRatio</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol-private/pull/15\">https://github.com/reserve-protocol/protocol-private/pull/15</a></td>\n<td>M-06</td>\n<td>Use lotPrice()</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol-private/pull/7\">https://github.com/reserve-protocol/protocol-private/pull/7</a></td>\n<td>M-07</td>\n<td>Refresh before selling rewards, refactor revenue &#x26; distro</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/857\">https://github.com/reserve-protocol/protocol/pull/857</a></td>\n<td>M-08</td>\n<td>payoutRewards before freeze and update payoutLastPaid before unfreeze</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol-private/pull/3\">https://github.com/reserve-protocol/protocol-private/pull/3</a></td>\n<td>M-09</td>\n<td>Payout rewards during cancelUnstake</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/886\">https://github.com/reserve-protocol/protocol/pull/886</a></td>\n<td>M-10</td>\n<td>Add oracle deprecation check</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/857\">https://github.com/reserve-protocol/protocol/pull/857</a></td>\n<td>M-11</td>\n<td>Change gas reservation policy in AssetRegistry</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"out-of-scope\" style=\"position:relative;\"><a href=\"#out-of-scope\" aria-label=\"out of scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Out of Scope</h3>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/16\">M-05: Lack of claimRewards when manageToken in RevenueTrader</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-06-reserve-findings/issues/6\">M-12: Custom redemption can be used to get more than RToken value, when an upwards depeg occurs</a></li>\n</ul>\n<h2 id=\"mitigation-review-summary\" style=\"position:relative;\"><a href=\"#mitigation-review-summary\" aria-label=\"mitigation review summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review Summary</h2>\n<table>\n<thead>\n<tr>\n<th>Original Issue</th>\n<th>Status</th>\n<th>Full Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>H-01</td>\n<td>Mitigation Confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/7\">ronnyx2017</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/30\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/3\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td>H-02</td>\n<td>Mitigation Confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/31\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/8\">ronnyx2017</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/11\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td>M-01</td>\n<td>Mitigation Confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/5\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/32\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/9\">ronnyx2017</a></td>\n</tr>\n<tr>\n<td>M-02</td>\n<td>Mitigation Errors</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/20\">ronnyx2017</a> and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/40\">0xA5DF</a> - details also shared below</td>\n</tr>\n<tr>\n<td>M-03</td>\n<td>Mitigation Error</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/36\">0xA5DF</a> and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/10\">rvierdiiev</a> - details also shared below</td>\n</tr>\n<tr>\n<td>M-04</td>\n<td>Mitigation Error</td>\n<td>Report from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/37\">0xA5DF</a> - details also shared below</td>\n</tr>\n<tr>\n<td>M-05</td>\n<td>Sponsor Disputed</td>\n<td>-</td>\n</tr>\n<tr>\n<td>M-06</td>\n<td>Mitigation Confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/13\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/41\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/23\">ronnyx2017</a></td>\n</tr>\n<tr>\n<td>M-07</td>\n<td>Mitigation Confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/24\">ronnyx2017</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/34\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/14\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td>M-08</td>\n<td>Mitigation Confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/15\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/38\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/25\">ronnyx2017</a></td>\n</tr>\n<tr>\n<td>M-09</td>\n<td>Mitigation Confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/16\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/33\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/26\">ronnyx2017</a></td>\n</tr>\n<tr>\n<td>M-10</td>\n<td>Mitigation Confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/35\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/28\">ronnyx2017</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/17\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td>M-11</td>\n<td>Mitigation Confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/27\">ronnyx2017</a>, <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/39\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/18\">rvierdiiev</a></td>\n</tr>\n<tr>\n<td>M-12</td>\n<td>Sponsor Acknowledged</td>\n<td>-</td>\n</tr>\n</tbody>\n</table>\n<p><strong>During their review, the wardens surfaced several mitigation errors. These consisted of 4 Medium severity issues. See below for details.</strong></p>\n<h2 id=\"m-02-mitigation-error-dutchtradedisablederc20-gives-governance-an-incentive-to-disable-rsr-auctions\" style=\"position:relative;\"><a href=\"#m-02-mitigation-error-dutchtradedisablederc20-gives-governance-an-incentive-to-disable-rsr-auctions\" aria-label=\"m 02 mitigation error dutchtradedisablederc20 gives governance an incentive to disable rsr auctions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/20\">M-02 Mitigation Error: <code>dutchTradeDisabled[erc20]</code> gives governance an incentive to disable RSR auctions</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/20\">ronnyx2017</a></em></p>\n<p><strong>Severity: Medium</strong></p>\n<p>Lines of Code: <a href=\"https://github.com/reserve-protocol/protocol/blob/3.0.0-rc5/contracts/p1/Broker.sol#L213-L216\">Broker.sol#L213-L216</a></p>\n<p>The mitigation adds different disable flags for GnosisTrade and DutchTrade. It can disable dutch trades by specific collateral. But it has serious problem with overall economic model design.</p>\n<p>The traders Broker contract are under control of the governance. The governance proposals are voted by stRSR stakers. And if the RToken is undercollateralized, the staking RSR will be sold for collaterals. In order to prevent this from happening, the governance(stakers) have every incentive to block the rsr auction. Although governance also can set disable flag for trade broker in the previous version of mitigation, there is a difference made it impossible to do so in previous versions.</p>\n<p>In the pre version, there is only one disable flag that disables any trades for any token. So if the governance votes for disable trades, the RToken users will find that they can’t derive any gain from RToken. So no one would try to issue RToken by their collateral. It is also unacceptable for governance.</p>\n<p>But after the mitigation, the governance can decide only disable the DutchTrade for RSR. And they can initiate a proposal about enable RSR trade -> open openTrade -> re-disable RSR trade to ensure their own gains. And most importantly, this behavior seems to do no harm to RToken holders just on the face of it, and it therefore does not threaten RToken issuance.</p>\n<p>So in order to prevent the undercollateralized case, dutchTradeDisabled[erc20] gives governance every incentive to disable RSR auctions.</p>\n<h3 id=\"impact-8\" style=\"position:relative;\"><a href=\"#impact-8\" aria-label=\"impact 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>When RToken is undercollateralized, disabling RSR trade will force users into redeeming from RToken baskets. It will lead to even greater depeg, and the RToken users will bear all the losses, but the RSR stakers can emerge unscathed.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>StRSR stakers can initiate such a proposal to prevent staking RSR auctions:</p>\n<ol>\n<li>Call <code>Broker.setBatchTradeDisabled(bool disabled)</code> to disable any GnosisTrade.</li>\n<li>And call <code>setDutchTradeDisabled(RSR_address, true)</code> to disable RSR DutchTrade.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The <code>dutchTradeDisabled</code> flag of RSR should not be set to true directly by governance in the <code>Broker.setDutchTradeDisabled</code> function. Add a check like that:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">require(!(disabled &amp;&amp; rsrTrader.tokenToBuy()==erc20),&quot;xxxxxxx&quot;);</span></span></code></pre>\n<h3 id=\"assessed-type\" style=\"position:relative;\"><a href=\"#assessed-type\" aria-label=\"assessed type permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Context</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/20#issuecomment-1692159329\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Anticipating restricting governance to only be able to <em>enable</em> batch trade, or dutch trade. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/20#issuecomment-1803002105\">pmckelvy1 (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>Implemented <a href=\"https://github.com/reserve-protocol/protocol/blob/master/contracts/p1/Broker.sol#L211\">here</a> and <a href=\"https://github.com/reserve-protocol/protocol/blob/master/contracts/p1/Broker.sol#L217\">here</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-mitigation-error-attacker-might-disable-trading-by-faking-a-report-violation\" style=\"position:relative;\"><a href=\"#m-02-mitigation-error-attacker-might-disable-trading-by-faking-a-report-violation\" aria-label=\"m 02 mitigation error attacker might disable trading by faking a report violation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/40\">M-02 Mitigation Error: Attacker might disable trading by faking a report violation</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/40\">0xA5DF</a></em></p>\n<p><strong>Severity: Medium</strong></p>\n<p>Lines of Code: <a href=\"https://github.com/reserve-protocol/protocol/blob/99d9db72e04db29f8e80e50a78b16a0b475d79f3/contracts/plugins/trading/DutchTrade.sol#L212-L214\">DutchTrade.sol#L212-L214</a></p>\n<p>Dutch trade now creates a report violation whenever the price is x1.5 then the best price.</p>\n<p>The issue is that the attacker can fake a report violation by buying with the higher price. Since revenue traders don’t have a minimum trade amount that can cost the attacker near zero funds.</p>\n<p>Mitigation might be to create violation report only if the price is high and the total value of the sell is above some threshold.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/40#issuecomment-1692064874\">tbrent (Reserve) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/40#issuecomment-1803002833\">pmckelvy1 (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>Fixed <a href=\"https://github.com/reserve-protocol/protocol/blob/master/contracts/p1/Broker.sol#L142\">here</a> - only rebalancing trades can disable dutch trades in this manner.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-mitigation-error-funds-arent-distributed-before-changing-distribution\" style=\"position:relative;\"><a href=\"#m-03-mitigation-error-funds-arent-distributed-before-changing-distribution\" aria-label=\"m 03 mitigation error funds arent distributed before changing distribution permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/36\">M-03 Mitigation Error: Funds aren’t distributed before changing distribution</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/36\">0xA5DF</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/10\">rvierdiiev</a></em></p>\n<p><strong>Severity: Medium</strong></p>\n<p>Lines of Code: <a href=\"https://github.com/reserve-protocol/protocol/blob/99d9db72e04db29f8e80e50a78b16a0b475d79f3/contracts/p1/Distributor.sol#L59-L63\">Distributor.sol#L59-L63</a></p>\n<p>Mitigation does solve the issue; however there’s a wider issue here that funds aren’t distributed before set distribution is executed.</p>\n<p>Fully mitigating the issue might not be possible, as it’d require to send from the backing manager to revenue trader and sell all assets for the <code>tokenToBuy</code>. But we can at least distribute the current balance before changing the distribution.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/36#issuecomment-1692078866\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Anticipating adding a try-catch at the start of <code>setDistribution()</code> targeting <code>RevenueTrader.distributeTokenToBuy()</code></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/36#issuecomment-1803003171\">pmckelvy1 (Reserve) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>Anticipating adding a try-catch at the start of <code>setDistribution()</code> targeting <code>RevenueTrader.distributeTokenToBuy()</code></p>\n</blockquote>\n<p>Added <a href=\"https://github.com/reserve-protocol/protocol/blob/3.1.0/contracts/p1/Distributor.sol#L59\">here</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-mitigation-error-furnace-would-melt-less-than-intended\" style=\"position:relative;\"><a href=\"#m-04-mitigation-error-furnace-would-melt-less-than-intended\" aria-label=\"m 04 mitigation error furnace would melt less than intended permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/37\">M-04 Mitigation Error: Furnace would melt less than intended</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/37\">0xA5DF</a></em></p>\n<p><strong>Severity: Medium</strong></p>\n<p>Lines of Code: <a href=\"https://github.com/reserve-protocol/protocol/blob/99d9db72e04db29f8e80e50a78b16a0b475d79f3/contracts/p1/Furnace.sol#L92-L105\">Furnace.sol#L92-L105</a></p>\n<p>We traded one problem with another here. The original issue was that in case <code>melt()</code> fails then the distribution would use the new rate for previous periods as well.</p>\n<p>The issue now is that in case of a failure (e.g. paused or frozen) we simply don’t melt for the previous period. Meaning RToken holders would get deprived of the melting they’re supposed to get.</p>\n<p>This is especially noticeable when the ratio has been decreased and the balance didn’t grow much, in that case we do more harm than good by updating <code>lastPayout</code> and <code>lastPayoutBal</code>.</p>\n<p>A better mitigation might be to update the <code>lastPayout</code> in a way that would reflect the melting that should be distributed.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-reserve-mitigation-findings/issues/37#issuecomment-1692068277\">tbrent (Reserve) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>I think this can only happen when frozen, not while paused. <code>Furnace.melt()</code> and <code>RToken.melt()</code> succeed while paused. </p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-2\">High Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#h-01-custom-redemption-might-revert-if-old-assets-were-unregistered\">[H-01] Custom redemption might revert if old assets were unregistered</a></li>\n<li><a href=\"#h-02-a-new-era-might-be-triggered-despite-a-significant-value-being-held-in-the-previous-era\">[H-02] A new era might be triggered despite a significant value being held in the previous era</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-12\">Medium Risk Findings (12)</a></p>\n<ul>\n<li><a href=\"#m-01-a-dutch-trade-could-end-up-with-an-unintended-lower-closing-price\">[M-01] A Dutch trade could end up with an unintended lower closing price</a></li>\n<li><a href=\"#m-02-the-broker-should-not-be-fully-disabled-by-gnosistradereportviolation\">[M-02] The broker should not be fully disabled by GnosisTrade.reportViolation</a></li>\n<li><a href=\"#m-03-in-case-distributorsetdistribution-use-revenue-from-rtoken-revenuetrader-and-rsr-token-revenuetrader-should-be-distributed\">[M-03] In case <code>Distributor.setDistribution</code> use, revenue from rToken RevenueTrader and rsr token RevenueTrader should be distributed</a></li>\n<li><a href=\"#m-04-furnacep1setratio-will-work-incorrectly-after-call-when-frozen-\">[M-04] FurnaceP1.setRatio will work incorrectly after call when frozen </a></li>\n<li><a href=\"#m-05-lack-of-claimrewards-when-managetoken-in-revenuetrader\">[M-05] Lack of claimRewards when manageToken in RevenueTrader</a></li>\n<li><a href=\"#m-06--oracle-timeout-at-rebalance-will-result-in-a-sell-off-of-all-rsrs-at-0-price\">[M-06]  Oracle timeout at rebalance will result in a sell-off of all RSRs at 0 price</a></li>\n<li><a href=\"#m-07-sell-reward-rtokens-at-low-price-because-of-skiping-furnacemelt\">[M-07] Sell reward <code>rTokens</code> at low price because of skiping <code>furnace.melt</code></a></li>\n<li><a href=\"#m-08-stake-before-unfreeze-can-take-away-most-of-rsr-rewards-in-the-freeze-period\">[M-08] Stake before unfreeze can take away most of rsr rewards in the freeze period</a></li>\n<li><a href=\"#m-09-cancelunstake-lack-payoutrewards-before-mint-shares\">[M-09] <code>cancelUnstake</code> lack <code>payoutRewards</code> before mint shares</a></li>\n<li><a href=\"#m-10-an-oracle-deprecation-might-lead-the-protocol-to-sell-assets-for-a-low-price\">[M-10] An oracle deprecation might lead the protocol to sell assets for a low price</a></li>\n<li><a href=\"#m-11-attacker-can-disable-basket-during-un-registration-which-can-cause-an-unnecessary-trade-in-some-cases\">[M-11] Attacker can disable basket during un-registration, which can cause an unnecessary trade in some cases</a></li>\n<li><a href=\"#m-12-custom-redemption-can-be-used-to-get-more-than-rtoken-value-when-an-upwards-depeg-occurs\">[M-12] Custom redemption can be used to get more than RToken value, when an upwards depeg occurs</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#01-a-redeemer-might-get-front-run-by-a-freezer\">01 A redeemer might get ‘front-run’ by a freezer</a></li>\n<li><a href=\"#02-leaky-refresh-math-is-incorrect\">02 Leaky refresh math is incorrect</a></li>\n<li><a href=\"#03-reorg-attack\">03 Reorg attack</a></li>\n<li><a href=\"#04-distributetokentobuy-can-be-called-while-pausedfrozen\">04 <code>distributeTokenToBuy()</code> can be called while paused/frozen</a></li>\n<li><a href=\"#05-redeemcustom-allows-the-use-of-the-zero-basket\">05 <code>redeemCustom</code> allows the use of the zero basket</a></li>\n<li><a href=\"#06-refreshbasket-can-be-called-before-the-first-prime-basket-was-set\">06 <code>refreshBasket</code> can be called before the first prime basket was set</a></li>\n<li><a href=\"#07-min_auction_length-seems-too-low\">07 <code>MIN_AUCTION_LENGTH</code> seems too low</a></li>\n<li><a href=\"#08-if-a-token-that-yields-rsr-would-be-used-as-collateral-then-100-of-the-yield-would-go-to-strsr\">08 If a token that yields RSR would be used as collateral then 100% of the yield would go to StRSR</a></li>\n<li><a href=\"#09-protocol-might-not-be-able-to-compromise-basket-when-needed\">09 Protocol might not be able to compromise basket when needed</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-at-tocoll-and-toasset-use-the-mapping-to-check-if-asset-exists\">G-01 At <code>toColl()</code> and <code>toAsset()</code> use the mapping to check if asset exists</a></li>\n<li><a href=\"#g-02-get-targetindex-from-mapping-instead-of-iterating\">G-02 Get <code>targetIndex</code> from mapping instead of iterating</a></li>\n<li><a href=\"#g-03-use-furnace-instead-of-mainfurnace\">G-03 Use <code>furnace</code> instead of <code>main.furnace()</code></a></li>\n<li><a href=\"#g-04-deployerimplementations-can-be-immutable\">G-04 Deployer.implementations can be immutable</a></li>\n<li><a href=\"#g-05-update-lastwithdrawrefresh-only-if-it-has-changed\">G-05 Update <code>lastWithdrawRefresh</code> only if it has changed</a></li>\n<li><a href=\"#g-06-require-array-to-be-sorted-and-use-sortedandallunique-at-backingmanagerforwardrevenue\">G-06 Require array to be sorted and use <code>sortedAndAllUnique</code> at <code>BackingManager.forwardRevenue()</code></a></li>\n<li><a href=\"#g-07-caching-storage-variable-and-function-calls\">G-07 Caching storage variable and function calls</a></li>\n<li><a href=\"#g-08basketlibnextbasket-refactoring\">G-08<code>BasketLib.nextBasket()</code> refactoring</a></li>\n<li><a href=\"#g-09-basketlibnextbasket-caching\">G-09 <code>BasketLib.nextBasket()</code> caching</a></li>\n<li><a href=\"#g-10sellamount-at-dutchtradesettle\">G-10<code>sellAmount</code> at <code>DutchTrade.settle()</code></a></li>\n<li><a href=\"#g-11-quotecustomredemption-loop\">G-11 <code>quoteCustomRedemption()</code> loop</a></li>\n<li><a href=\"#g-12-use-custom-errors-instead-of-string-errors\">G-12 Use custom errors instead of string errors</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#mitigation-review\">Mitigation Review</a></p>\n<ul>\n<li><a href=\"#introduction\">Introduction</a></li>\n<li><a href=\"#mitigation-review-scope\">Mitigation Review Scope</a></li>\n<li><a href=\"#mitigation-review-summary\">Mitigation Review Summary</a></li>\n<li><a href=\"#m-02-mitigation-error-dutchtradedisablederc20-gives-governance-an-incentive-to-disable-rsr-auctions\">M-02 Mitigation Error: <code>dutchTradeDisabled[erc20]</code> gives governance an incentive to disable RSR auctions</a></li>\n<li><a href=\"#m-02-mitigation-error-attacker-might-disable-trading-by-faking-a-report-violation\">M-02 Mitigation Error: Attacker might disable trading by faking a report violation</a></li>\n<li><a href=\"#m-03-mitigation-error-funds-arent-distributed-before-changing-distribution\">M-03 Mitigation Error: Funds aren’t distributed before changing distribution</a></li>\n<li><a href=\"#m-04-mitigation-error-furnace-would-melt-less-than-intended\">M-04 Mitigation Error: Furnace would melt less than intended</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}