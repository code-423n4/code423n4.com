{
  "circa": {
    "title": "Ambire Wallet - Invitational",
    "sponsor": "Ambire",
    "slug": "2023-05-ambire",
    "date": "2023-08-04",
    "findings": "https://github.com/code-423n4/2023-05-ambire-findings/issues",
    "contest": 243
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the Ambire Wallet smart contract system written in Solidity. The audit took place between May 23 - May 26 2023.</p>\n<p>Following the C4 audit, 3 wardens (<a href=\"https://twitter.com/adrianromero\">adriro</a>, <a href=\"https://twitter.com/carlitox477\">carlitox477</a> and rbserver) reviewed the mitigations for all identified issues; the mitigation review report is appended below the audit report.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>In Code4rena’s Invitational audits, the competition is limited to a small group of wardens; for this audit, 5 wardens contributed reports:</p>\n<ol>\n<li><a href=\"https://twitter.com/adrianromero\">adriro</a></li>\n<li><a href=\"https://twitter.com/bin2chen\">bin2chen</a></li>\n<li><a href=\"https://twitter.com/carlitox477\">carlitox477</a></li>\n<li>d3e4</li>\n<li>rbserver</li>\n</ol>\n<p>This audit was judged by <a href=\"https://twitter.com/thePicodes\">Picodes</a>.</p>\n<p>Final report assembled by thebrittfactor.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 5 unique vulnerabilities. Of these vulnerabilities, 5 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 5 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 2 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-05-ambire\">C4 Ambire Wallet - Invitational repository</a>, and is composed of 4 smart contracts written in the Solidity programming language and includes 329 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"medium-risk-findings-5\" style=\"position:relative;\"><a href=\"#medium-risk-findings-5\" aria-label=\"medium risk findings 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (5)</h1>\n<h2 id=\"m-01-fallback-handlers-can-trick-users-into-calling-functions-of-the-ambireaccount-contract\" style=\"position:relative;\"><a href=\"#m-01-fallback-handlers-can-trick-users-into-calling-functions-of-the-ambireaccount-contract\" aria-label=\"m 01 fallback handlers can trick users into calling functions of the ambireaccount contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/21\">[M-01] Fallback handlers can trick users into calling functions of the AmbireAccount contract</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/21\">adriro</a></em></p>\n<p>Selector clashing can be used to trick users into calling base functions of the wallet.</p>\n<p>Fallback handlers provide extensibility to the Ambire wallet. The main idea here is that functions not present in the wallet implementation are delegated to the fallback handler by using the <code>fallback()</code> function.</p>\n<p>Function dispatch in Solidity is done using function selectors. Selectors are represented by the first 4 bytes of the keccak hash of the function signature (name + argument types). It is possible (and not computationally difficult) to find different functions that have the same selector.</p>\n<p>This means that a malicious actor can craft a fallback handler with a function signature carefully selected to match one of the functions present in the base AmbireAccount contract, and with an innocent looking implementation. While the fallback implementation may seem harmless, this function, when called, will actually trigger the function in the base AmbireAccount contract. This can be used, for example, to hide a call to <code>setAddrPrivilege()</code> which could be used to grant control of the wallet to the malicious actor.</p>\n<p>This is similar to the exploit reported on proxies in <a href=\"https://medium.com/nomic-foundation-blog/malicious-backdoors-in-ethereum-proxies-62629adf3357\">this article</a>, which caused the proposal of the transparent proxy pattern.</p>\n<p>As further reference, another <a href=\"https://github.com/romeroadrian/audits/blob/main/code4rena/2022-11-debtdao/H-01.md\">similar issue</a> can be found in the DebtDAO audit that could lead to unnoticed calls due to selector clashing (disclaimer: the linked report is authored by me).</p>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>It is difficult to provide a recommendation based on the current design of contracts. Any whitelisting or validation around the selector won’t work as the main entry point of the wallet is the AmbireAccount contract itself. The solution would need to be based on something similar to what was proposed for transparent proxies, which involves segmenting the calls to avoid clashing, but this could cripple the functionality and simplicity of the wallet.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/21#issuecomment-1564930049\">Ivshti (Ambire) commented</a>:</strong></p>\n<blockquote>\n<p>I’m not sure if this is applicable: the use case of this is the Ambire team pushing out fallback handlers and allowing users to opt into them. While this does leave an opportunity for us to be that malicious actor, I’m not sure there’s a better trade off here.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/21#issuecomment-1566172322\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The scenario is convincing; provided the attacker manages to have its malicious implementation of <code>fallbackHandler</code> used by Ambire wallet users, which seems unlikely, but doable. Furthermore, as there are no admin roles here, the possibility of this attack by the Ambire team is worth stating.</p>\n<p>Overall, I think Medium severity is appropriate. I agree with the previous comments that there is no clear mitigation though, aside from warning users about this.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-attacker-can-force-the-failure-of-transactions-that-use-trycatch\" style=\"position:relative;\"><a href=\"#m-02-attacker-can-force-the-failure-of-transactions-that-use-trycatch\" aria-label=\"m 02 attacker can force the failure of transactions that use trycatch permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/18\">[M-02] Attacker can force the failure of transactions that use <code>tryCatch</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/18\">adriro</a></em></p>\n<p>An attacker, or malicious relayer, can force the failure of transactions that rely on <code>tryCatch()</code> by carefully choosing the gas limit.</p>\n<p>The <code>tryCatch()</code> function present in the AmbireAccount contract can be used to execute a call in the context of a wallet, which is eventually allowed to fail; i.e. the operation doesn’t revert if the call fails.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">119</span><span class=\"mtk1\">: \t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">tryCatch</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">value</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">120</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&#39;ONLY_IDENTITY_CAN_CALL&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">121</span><span class=\"mtk1\">: \t\t(</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">returnData</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{ value: </span><span class=\"mtk12\">value</span><span class=\"mtk1\">, gas: </span><span class=\"mtk11\">gasleft</span><span class=\"mtk1\">() }(</span><span class=\"mtk12\">data</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">122</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">success</span><span class=\"mtk1\">) </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogErr</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">value</span><span class=\"mtk1\">, </span><span class=\"mtk12\">data</span><span class=\"mtk1\">, </span><span class=\"mtk12\">returnData</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">123</span><span class=\"mtk1\">: \t}</span></span></span></code></pre>\n<p><a href=\"https://eips.ethereum.org/EIPS/eip-150\">EIP-150</a> introduces the “rule of 1/64th” in which 1/64th of the available gas is reserved in the calling context and the rest of it is forward to the external call. This means that, potentially, the called function can run out of gas, while the calling context may have some gas to eventually continue and finish execution successfully.</p>\n<p>A malicious relayer, or a malicious actor that front-runs the transaction, can carefully choose the gas limit to make the call to <code>tryCatch()</code> fail due out of gas, while still saving some gas in the main context to continue execution. Even if the underlying call in <code>tryCatch()</code> would succeed, an attacker can force its failure while the main call to the wallet is successfully executed.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following test reproduces the attack. The user creates a transaction to execute a call using <code>tryCatch()</code> to a function of the <code>TestTryCatch</code> contract, which simulates some operations that consume gas. The attacker then executes the bundle by carefully choosing the gas limit (450,000 units of gas in this case) so that the call to <code>TestTryCatch</code> fails due to out of gas, but the main call to <code>execute()</code> in the wallet (here simplified by using <code>executeBySender()</code> to avoid signatures) gets correctly executed.</p>\n<p>Note: the snippet shows only the relevant code for the test. Full test file can be found <a href=\"https://gist.github.com/romeroadrian/535a969c96e0a6f78781287bd0931b6a\">here</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">TestTryCatch</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[</span><span class=\"mtk7\">20</span><span class=\"mtk1\">] </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">foo</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// simulate expensive operation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">index</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">20</span><span class=\"mtk1\">; </span><span class=\"mtk12\">index</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">foo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">index</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">index</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_AmbireAccount_ForceFailTryCatch</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;user&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addrs</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">addrs</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">user</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">AmbireAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">AmbireAccount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addrs</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">TestTryCatch</span><span class=\"mtk1\"> </span><span class=\"mtk12\">testTryCatch</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">TestTryCatch</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">AmbireAccount</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Transaction</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">txns</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">AmbireAccount</span><span class=\"mtk1\">.</span><span class=\"mtk10\">Transaction</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">txns</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">to</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">txns</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">txns</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">data</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">AmbireAccount</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tryCatch</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">testTryCatch</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TestTryCatch</span><span class=\"mtk1\">.</span><span class=\"mtk12\">test</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// This should actually be a call to &quot;execute&quot;, we simplify the case using &quot;executeBySender&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// to avoid the complexity of providing a signature. Core issue remains the same.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectEmit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogErr</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">testTryCatch</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">account</span><span class=\"mtk1\">.</span><span class=\"mtk12\">executeBySender</span><span class=\"mtk1\">{gas: </span><span class=\"mtk7\">450_000</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">txns</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// assert call to TestTryCatch failed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">testTryCatch</span><span class=\"mtk1\">.</span><span class=\"mtk11\">foo</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommendation-1\" style=\"position:relative;\"><a href=\"#recommendation-1\" aria-label=\"recommendation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>The context that calls in <code>tryCatch()</code>, can check the remaining gas after the call to determine if the remaining amount is greater than 1/64 of the available gas, before the external call.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">tryCatch</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">value</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&#39;ONLY_IDENTITY_CAN_CALL&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">gasBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">gasleft</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">returnData</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{ value: </span><span class=\"mtk12\">value</span><span class=\"mtk1\">, gas: </span><span class=\"mtk11\">gasleft</span><span class=\"mtk1\">() }(</span><span class=\"mtk12\">data</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+     </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">gasleft</span><span class=\"mtk1\">() &gt; </span><span class=\"mtk12\">gasBefore</span><span class=\"mtk1\">/</span><span class=\"mtk7\">64</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">success</span><span class=\"mtk1\">) </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogErr</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">value</span><span class=\"mtk1\">, </span><span class=\"mtk12\">data</span><span class=\"mtk1\">, </span><span class=\"mtk12\">returnData</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/18#issuecomment-1567747570\">Ivshti (Ambire) commented</a>:</strong></p>\n<blockquote>\n<p>@Picodes - we tend to disagree with the severity here. Gas attacks are possible in almost all cases of using Ambire accounts through a relayer. It’s an inherent design compromise of ERC-4337 as well, and the only way to counter it is with appropriate offchain checks/reputation systems and griefing protections.</p>\n<p>Also, the solution seems too finicky. What if the <code>tryCatch</code> is called within execute (which it very likely will), which requires even more gas left to complete? Then 1) the solution won’t be reliable 2) the attacker can make the attack anyway through execute</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/18#issuecomment-1570505823\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The main issue here is, the nonce is incremented, despite the fact the transaction wasn’t executed as intended, which would force the user to resign the payload and would be a griefing attack against the user. I do break an important invariant, which if the nonce is incremented, the transaction signed by the user was included as he intended.</p>\n<p>Also, I think this can be used within <code>tryCatchLimit</code> to pass a lower <code>gasLimit</code>: quoting <a href=\"https://eips.ethereum.org/EIPS/eip-150\">EIP150</a>:\n“If a call asks for more gas than the maximum allowed amount (i.e. the total amount of gas remaining in the parent after subtracting the gas cost of the call and memory expansion), do not return an OOG error; instead, if a call asks for more gas than all but one 64th of the maximum allowed amount, call with all but one 64th of the maximum allowed amount of gas (this is equivalent to a version of EIP-90<a href=\"https://github.com/ethereum/EIPs/issues/90\">1</a> plus EIP-114<a href=\"https://github.com/ethereum/EIPs/issues/114\">2</a>).”</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/18#issuecomment-1571555097\">Ivshti (Ambire) commented</a>:</strong></p>\n<blockquote>\n<p>@Picodes - I’m not sure I understand. The whole point of signing something that calls into <code>tryCatch</code> is that you don’t care about the case where the nonce is incremented, but the transaction is failing. What am I missing?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/18#issuecomment-1573629324\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>The whole point of signing something that calls into <code>tryCatch</code> is that you don’t care about the case where the nonce is incremented but the transaction is failing</p>\n</blockquote>\n<p>You don’t care if the transactions fail because the sub-call is invalid, but you do if it’s because the relayer manipulated the gas, right?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/18#issuecomment-1592963193\">Ivshti (Ambire) commented</a>:</strong></p>\n<blockquote>\n<p>@Picodes - Ok, I see the point here - probably repeating stuff that others said before, but trying to simplify.  The relayer can rug users by taking their fee, regardless of the fact that the inner transactions fail, due to the relayer using a lower <code>gasLimit</code>. This would be possible if some of the sub-transactions use <code>tryCatch</code>, but the fee payment does not.</p>\n<p>However, I’m not sure how the mitigation would work. Can the relayer still calculate a “right” gas limit for which the <code>tryCatch</code> will fail, but the rest will succeed?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/18#issuecomment-1593011603\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>My understanding is that using <code>gasleft() > gasBefore/64</code>, we know for sure than the inner call didn’t fail due to an out of gas, as it was called with <code>63*gasBefore/64</code>. So the relayer has to give enough gas for every subcall to execute fully, whether it is successful or not.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/18#issuecomment-1593043044\">Ivshti (Ambire) commented</a>:</strong></p>\n<blockquote>\n<p>I see, this sounds reasonable. I need a bit more time to think about it and if it is, we’ll apply this mitigation.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation#mitigations-to-be-reviewed\">Ambire mitigated:</a></strong></p>\n<blockquote>\n<p>Check gasleft to prevent this attack.</p>\n</blockquote>\n<p><strong>Status:</strong> Not fully mitigated. Full details in reports from <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/15\">adriro</a> and <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/9\">carlitox477</a>, and also included in the Mitigation Review section below.</p>\n<hr>\n<h2 id=\"m-03-recovery-transaction-can-be-replayed-after-a-cancellation\" style=\"position:relative;\"><a href=\"#m-03-recovery-transaction-can-be-replayed-after-a-cancellation\" aria-label=\"m 03 recovery transaction can be replayed after a cancellation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/16\">[M-03] Recovery transaction can be replayed after a cancellation</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/16\">adriro</a>, also found by <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/5\">bin2chen</a></em></p>\n<p>The recovery transaction can be replayed after a cancellation of the recovery procedure, reinstating the recovery mechanism.</p>\n<p>The Ambire wallet provides a recovery mechanism in which a privilege can recover access to the wallet if they lose their keys. The process contains three parts; all of them considered in the <code>execute()</code> function:</p>\n<ol>\n<li>A transaction including a signature with <code>SIGMODE_RECOVER</code> mode enqueues the transaction to be executed after the defined timelock. This action should include a signature by one of the defined recovery keys to be valid.</li>\n<li>\n<p>This can be followed by two paths; the cancellation of the process or the execution of the recovery:</p>\n<ul>\n<li>If the timelock passes, then anyone can complete the execution of the originally submitted bundle.</li>\n<li>A signed cancellation can be submitted to abort the recovery process, which clears the state of <code>scheduledRecoveries</code>.</li>\n</ul>\n</li>\n</ol>\n<p>Since nonces are only incremented when the bundle is executed, the call that triggers the recovery procedure can be replayed as long as the nonce stays the same.</p>\n<p>This means that the recovery process can be re-initiated after a cancellation is issued by replaying the original call that initiated the procedure.</p>\n<p>Note: this also works for cancellations. If the submitted recovery bundle is the same, then a cancellation can be replayed if the recovery process is initiated again while under the same nonce value.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Recovery process is initiated using a transaction with <code>SIGMODE_RECOVER</code> signature mode.</li>\n<li>Procedure is canceled by executing a signed call with <code>SIGMODE_CANCEL</code> signature mode.</li>\n<li>Recovery can be re-initiated by replaying the transaction from step 1.</li>\n</ol>\n<h3 id=\"recommendation-2\" style=\"position:relative;\"><a href=\"#recommendation-2\" aria-label=\"recommendation 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Increment the nonce during a cancellation. This will stop the nonce, preventing any previous signature from being replayed.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isCancellation</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">scheduledRecoveries</span><span class=\"mtk1\">[</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+   </span><span class=\"mtk12\">nonce</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">currentNonce</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogRecoveryCancelled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recoveryInfoHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recoveryKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">scheduledRecoveries</span><span class=\"mtk1\">[</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">recoveryInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timelock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogRecoveryScheduled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recoveryInfoHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recoveryKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currentNonce</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">txns</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/16#issuecomment-1567748808\">Ivshti (Ambire) commented</a>:</strong></p>\n<blockquote>\n<p>Excellent finding.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/16#issuecomment-1567748808\">Ivshti (Ambire) commented</a>:</strong></p>\n<blockquote>\n<p>Solved.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation#mitigations-to-be-reviewed\">Ambire mitigated:</a></strong><br></p>\n<blockquote>\n<p>Increment the nonce to prevent replaying recovery transactions.</p>\n</blockquote>\n<p><strong>Status:</strong> Not fully mitigated. Full details in reports from <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/19\">adriro</a>, <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/6\">carlitox477</a>, and <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/10\">rbserver</a>, and also included in the Mitigation Review section below.</p>\n<hr>\n<h2 id=\"m-04-project-may-fail-to-be-deployed-to-chains-not-compatible-with-shanghai-hardfork\" style=\"position:relative;\"><a href=\"#m-04-project-may-fail-to-be-deployed-to-chains-not-compatible-with-shanghai-hardfork\" aria-label=\"m 04 project may fail to be deployed to chains not compatible with shanghai hardfork permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/12\">[M-04] Project may fail to be deployed to chains not compatible with Shanghai hardfork</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/12\">adriro</a></em></p>\n<p>Current settings may produce incompatible bytecode with some of the chains supported by the protocol.</p>\n<p>The Ambire wallet supports and targets different chains, such as Ethereum, Polygon, Avalanche, BNB, Optimism, Arbitrum, etc. This information is available on <a href=\"https://www.ambire.com/\">their website</a>.</p>\n<p>All of the contracts in scope have the version pragma fixed to be compiled using Solidity 0.8.20. This <a href=\"https://github.com/ethereum/solidity/releases/tag/v0.8.20\">new version of the compiler</a> uses the new <code>PUSH0</code> opcode introduced in the Shanghai hard fork, which is now the default EVM version in the compiler and the one being currently used to compile the project.</p>\n<p>Here is an excerpt of the bytecode produced for the <code>AmbireAccount</code> contract, in which we can see the presence of the <code>PUSH0</code> opcode (full bytecode can be found in the file <code>artifacts/contracts/AmbireAccount.sol/AmbireAccount.json</code>):</p>\n<p><img src=\"https://i.ibb.co/pwNXzps/carbon.png\" alt=\"byecode\"></p>\n<p>This means that the produced bytecode for the different contracts won’t be compatible with the chains that don’t yet support the Shanghai hard fork.</p>\n<p>This could also become a problem if different versions of Solidity are used to compile contracts for different chains. The differences in bytecode between versions can impact the deterministic nature of contract addresses, potentially breaking counterfactuality.</p>\n<h3 id=\"recommendation-3\" style=\"position:relative;\"><a href=\"#recommendation-3\" aria-label=\"recommendation 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Change the Solidity compiler version to 0.8.19 or define an evm version, which is compatible across all of the intended chains to be supported by the protocol (see <a href=\"https://book.getfoundry.sh/reference/config/solidity-compiler?highlight=evm_vers#evm_version\">https://book.getfoundry.sh/reference/config/solidity-compiler?highlight=evm_vers#evm_version</a>).</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/12#issuecomment-1565217229\">Ivshti (Ambire) commented</a>:</strong></p>\n<blockquote>\n<p>Valid finding. Do you know of any big mainstream chains that do not support PUSH0?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/12#issuecomment-1566073476\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@Ivshti - I haven’t checked for myself, but it seems Arbitrum doesn’t support PUSH0 yet. For example <a href=\"https://github.com/ethereum/solidity/issues/14254\">https://github.com/ethereum/solidity/issues/14254</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/12#issuecomment-1566074725\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Regarding the severity of the finding, I don’t think the generic finding of “this contract uses 0.8.20, so won’t work on some L2s” is of Medium severity as there is 0 chance that this leads to a loss of funds in production (the team will obviously see that it doesn’t work and just change the compiler version).</p>\n<p>However, in this context, I do agree with the warden that “the differences in bytecode between versions can impact the deterministic nature of contract addresses, potentially breaking counterfactuality”. Therefore, Medium severity seems appropriate.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/12#issuecomment-1567748924\">Ivshti (Ambire) commented</a>:</strong></p>\n<blockquote>\n<p>Solved.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation#mitigations-to-be-reviewed\">Ambire mitigated:</a></strong><br></p>\n<blockquote>\n<p>Downgrade Solidity to allow deploying on pre-Shanghai networks.</p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/17\">adriro</a>, <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/4\">carlitox477</a>, and <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/12\">rbserver</a>.</p>\n<hr>\n<h2 id=\"m-05-ambireaccount-implementation-can-be-destroyed-by-privileges\" style=\"position:relative;\"><a href=\"#m-05-ambireaccount-implementation-can-be-destroyed-by-privileges\" aria-label=\"m 05 ambireaccount implementation can be destroyed by privileges permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/10\">[M-05] AmbireAccount implementation can be destroyed by privileges</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/10\">adriro</a></em></p>\n<p>The <code>AmbireAccount</code> implementation can be destroyed, resulting in the bricking of all associated wallets.</p>\n<p>The <code>AmbireAccount</code> contract has a constructor that sets up privileges. These are essentially addresses that have control over the wallet.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">58</span><span class=\"mtk1\">: \t</span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addrs</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">len</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">addrs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">60</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">len</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">61</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk3\">// NOTE: privileges[] can be set to any arbitrary value, but for this we SSTORE directly through the proxy creator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">62</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk12\">privileges</span><span class=\"mtk1\">[</span><span class=\"mtk12\">addrs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]] = </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">63</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogPrivilegeChanged</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addrs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">64</span><span class=\"mtk1\">: \t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">65</span><span class=\"mtk1\">: \t}</span></span></span></code></pre>\n<p>Normally, this constructor is not really used, as wallets are deployed using proxies. The proxy constructor is the actual piece of code that sets up the privileges storage to grant initial permission to the owner of the wallet.</p>\n<p>However, these proxies need to rely on a reference implementation of the <code>AmbireAccount</code> contract. A single contract is deployed and its address is then injected into the proxy code.</p>\n<p>The main issue is, privileges defined in the reference implementation have control over that instance, and could eventually force a destruction of the contract using a fallback handler with a <code>selfdestruct</code> instruction (see PoC for a detailed explanation). This destruction of the implementation would render all wallets non-functional, as the proxies won’t have any underlying logic code. Consequently, wallets would become inaccessible, resulting in a potential loss of funds.</p>\n<p>It is not clear of the purpose of this constructor in the <code>AmbireAccount</code> contract. It may be present to facilitate testing. This issue can be triggered by a malicious deployer (or any of the defined privileges) or by simply setting up a wrong privilege accidentally. Nevertheless, its presence imposes a big and unneeded security risk, as the destruction of the reference implementation can render <strong>all</strong> wallets useless and inaccessible.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following test reproduces the described issue. A deployer account deploys the implementation of the <code>AmbireAccount</code> contract that is later used by the user account to create a proxy (<code>AccountProxy</code> contract) over the implementation. The deployer then forces the destruction of the reference implementation, using a fallback handler (<code>Destroyer</code> contract). The user’s wallet is now inaccessible, as there is no code behind the proxy.</p>\n<p>The majority of the test is implemented in the <code>setUp()</code> function, in order to properly test the destruction of the contract (in Foundry, contracts are deleted when the test is finalized).</p>\n<p>Note: the snippet shows only the relevant code for the test. Full test file can be found <a href=\"https://gist.github.com/romeroadrian/79248a4fdf436eb3044e87cfffc9d8f7\">here</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Destroyer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">destruct</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">selfdestruct</span><span class=\"mtk1\">(</span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AccountProxy</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ERC1967Proxy</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Simulate privileges storage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">privileges</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addrs</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_logic</span><span class=\"mtk1\">) </span><span class=\"mtk11\">ERC1967Proxy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_logic</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">len</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">addrs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">len</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk3\">// NOTE: privileges[] can be set to any arbitrary value, but for this we SSTORE directly through the proxy creator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">privileges</span><span class=\"mtk1\">[</span><span class=\"mtk12\">addrs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]] = </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AuditDestructTest</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Test</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">AmbireAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">implementation</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">AmbireAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wallet</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Master account implementation can be destroyed by any of the configured privileges</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">deployer</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;deployer&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;user&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Lets say deployer creates reference implementation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addrsImpl</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">addrsImpl</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">deployer</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">implementation</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">AmbireAccount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addrsImpl</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// User deploys wallet</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addrsWallet</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">addrsWallet</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">user</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">wallet</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">AmbireAccount</span><span class=\"mtk1\">(</span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">AccountProxy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addrsWallet</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">implementation</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Test the wallet is working ok</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wallet</span><span class=\"mtk1\">.</span><span class=\"mtk11\">supportsInterface</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x4e2312e0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Now privilege sets fallback</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Destroyer</span><span class=\"mtk1\"> </span><span class=\"mtk12\">destroyer</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Destroyer</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">AmbireAccount</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Transaction</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">txns</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">AmbireAccount</span><span class=\"mtk1\">.</span><span class=\"mtk10\">Transaction</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">txns</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">to</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">implementation</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">txns</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">txns</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">data</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">AmbireAccount</span><span class=\"mtk1\">.</span><span class=\"mtk12\">setAddrPrivilege</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x6969</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint160</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">destroyer</span><span class=\"mtk1\">))))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">deployer</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">implementation</span><span class=\"mtk1\">.</span><span class=\"mtk11\">executeBySender</span><span class=\"mtk1\">(</span><span class=\"mtk12\">txns</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// and destroys master implementation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">Destroyer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">implementation</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">destruct</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_AmbireAccount_DestroyImplementation</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Assert implementation has been destroyed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">implementation</span><span class=\"mtk1\">).</span><span class=\"mtk12\">code</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Now every wallet (proxy) that points to this master implementation will be bricked</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">wallet</span><span class=\"mtk1\">.</span><span class=\"mtk11\">supportsInterface</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x4e2312e0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommendation-4\" style=\"position:relative;\"><a href=\"#recommendation-4\" aria-label=\"recommendation 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Remove the constructor from the <code>AmbireAccount</code> contract.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/10#issuecomment-1566179847\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>There is a constructor but no initializer; so I don’t get how a wallet could be deployed behind a minimal proxy: how do you set the first privilege addresses?</p>\n<p>It seems that either the constructor needs to be changed to an initializer, or the intent is to deploy the whole bytecode for every wallet.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/10#issuecomment-1567752167\">Ivshti (Ambire) commented</a>:</strong></p>\n<blockquote>\n<p>@Picodes - we use a completely different mechanism in which we generate bytecode, which directly <code>SSTORES</code> the relevant <code>privileges</code> slots.</p>\n<p>We absolutely disagree with using an initializer. It is leaving too much room for error, as it can be seen from the two Parity exploits.</p>\n<p>That said, this finding is valid, and removing the constructor is one solution. Another is ensuring we deploy the implementation with no privileges. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/10#issuecomment-1568575519\">Ivshti (Ambire) commented</a>:</strong></p>\n<blockquote>\n<p>@Picodes - we are in the process of fixing this by removing the constructor.</p>\n<p>I would say this finding is excellent, but I am considering whether the severity should be degraded, as once the implementation is deployed with empty <code>privileges</code>, this issue doesn’t exist. You can argue that this creates sort of a “trusted setup”, where someone needs to watch what we’re deploying, but this is a fundamental effect anyway, as someone needs to watch whether we’re deploying the right code. The way we’ll mitigate this in the future when we’re deploying is by pre-signing deployment transactions with different gas prices and different networks and placing them on github for people to review, or even broadcast themselves.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/10#issuecomment-1568829690\">Ivshti (Ambire) commented</a>:</strong></p>\n<blockquote>\n<p>@Picodes - we decided to remove the constructor, because it just makes things more obvious (production privileges are not set via the constructor).</p>\n<p>With that said, I just remembered that this vulnerability is mitigated by the fact the implementation will be deployed via <code>CREATE2</code> and can be re-deployed</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/10#issuecomment-1570397729\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>So:</p>\n<ul>\n<li>This is in the end a trust issue and the report shows how the team could have used the constructor to grief users.</li>\n<li>The fact that the implementation is deployed via <code>CREATE2</code> doesn’t change the severity, as the team could still be malicious. If anything, it makes it even worse because it creates a scenario where the team could blackmail users to get paid for the redeployment.</li>\n</ul>\n<p> Overall, considering that there shouldn’t be any trust assumption in this repository, I think Medium severity is appropriate, under <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">“the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements”</a>.</p>\n</blockquote>\n<p><em>Note: for full discussion, see <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/10\">here</a></em></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation#mitigations-to-be-reviewed\">Ambire mitigated:</a></strong><br></p>\n<blockquote>\n<p>To mitigate this and avoid confusion, we removed the constructor as it’s not used anyway.</p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/18\">adriro</a>, <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/5\">carlitox477</a>, and <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/11\">rbserver</a>.</p>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 5 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/34\">report highlighted below</a> by <strong>d3e4</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/33\">carlitox477</a>,\n<a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/27\">adriro</a>,\n<a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/26\">rbserver</a> and\n<a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/8\">bin2chen</a>.</em></p>\n<h2 id=\"l-01-ambireaccountfactorydeploysafe-does-not-guarantee-that-no-call-hasnt-already-been-made-on-the-deployed-contract\" style=\"position:relative;\"><a href=\"#l-01-ambireaccountfactorydeploysafe-does-not-guarantee-that-no-call-hasnt-already-been-made-on-the-deployed-contract\" aria-label=\"l 01 ambireaccountfactorydeploysafe does not guarantee that no call hasnt already been made on the deployed contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] <code>AmbireAccountFactory.deploySafe()</code> does not guarantee that no call hasn’t already been made on the deployed contract</h2>\n<p>When deploying and executing (<code>AmbireAccountFactory.sol#L24</code>), it is possible that another one of the privileged signers might have made a call on the already deployed contract, changing its state. While this can only be one of the designated signers with privilege as set by the deployer, it may be against the wishes of the deployer that someone else makes a first function call.\nConsider allowing only a single address with privilege in the constructor, such that the deployer would be the only one who could make a first call.</p>\n<h2 id=\"l-02-fallback-handler-should-not-be-allowed-to-be-this\" style=\"position:relative;\"><a href=\"#l-02-fallback-handler-should-not-be-allowed-to-be-this\" aria-label=\"l 02 fallback handler should not be allowed to be this permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Fallback handler should not be allowed to be <code>this</code></h2>\n<p>In <code>AmbireAccount.sol</code>, if <code>address(uint160(uint(privileges[FALLBACK_HANDLER_SLOT]))) == address(this)</code>, anyone could call the functions protected by <code>require(msg.sender == address(this), 'ONLY_IDENTITY_CAN_CALL');</code>, with obvious and disastrous consequences. This seems like an unnecessary attack surface to expose. Consider checking this is not the case, either when setting the privileges (in <code>setAddrPrivilege()</code>) or in the fallback itself.</p>\n<h2 id=\"l-03-schnorr-signature-validation-may-be-incompatible-with-the-intended-signers\" style=\"position:relative;\"><a href=\"#l-03-schnorr-signature-validation-may-be-incompatible-with-the-intended-signers\" aria-label=\"l 03 schnorr signature validation may be incompatible with the intended signers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Schnorr signature validation may be incompatible with the intended signers</h2>\n<p>The Schnorr signature scheme implemented for validation in <code>SignatureValidator.recoverAddrImpl()</code> (<code>SignatureValidator.sol#L63-L82</code>) is engineered to leverage Ethereums <code>ecrecover</code> for its calculations. It also uses a specific hash function (keccak256 of a certain encoding of data). As far as I can tell, this is not a standard Schnorr scheme. It is important to note, that both the signer and validator must agree on the same group and hash function. The implemented Schnorr validation will not work with any other Schnorr scheme.\nConsider whether <code>AmbireAccount</code> is expected to interface with other Schnorr scheme implementations, and if so, make sure that the same Schnorr scheme is used.</p>\n<h2 id=\"l-04-schnorr-signature-length-is-not-checked\" style=\"position:relative;\"><a href=\"#l-04-schnorr-signature-length-is-not-checked\" aria-label=\"l 04 schnorr signature length is not checked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Schnorr signature length is not checked</h2>\n<p>When <code>SignatureValidator.recoverAddrImpl()</code> (<code>SignatureValidator.sol#L63</code>) is called with a Schnorr signature, it is not checked that it has the correct length, unlike for <code>SignatureMode.EIP712</code> and <code>SignatureMode.EthSign</code>.\nConsider checking that <code>sig</code>, before trimming, has a length of <code>129</code> (<code>(bytes32, bytes32, bytes32, uint8)</code> plus the <code>modeRaw</code> byte).</p>\n<h2 id=\"l-05-logprivilegechanged-does-not-adequately-describe-the-change\" style=\"position:relative;\"><a href=\"#l-05-logprivilegechanged-does-not-adequately-describe-the-change\" aria-label=\"l 05 logprivilegechanged does not adequately describe the change permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] <code>LogPrivilegeChanged</code> does not adequately describe the change</h2>\n<p><code>LogPrivilegeChanged(addr, priv)</code> is emitted when the privilege of <code>addr</code> is changed to <code>priv</code> (<code>AmbireAccount.sol#L115</code>) (also in the constructor, but there it is first set, rather than changed). Since the previous value is not emitted, it is difficult to know whether and how it was meaningfully changed; especially considering that privileges are <code>bytes32</code>, but generally carry their meaning only in being non-zero, but may also encode for recovery and the fallback handler.\nConsider including the previous privilege in the event, and perhaps emit a different event when the fallback handler is changed and when the recovery info hash is set. This would then probably involve creating a separate function for setting this.</p>\n<h2 id=\"l-06-consider-indexing-unindexed-events\" style=\"position:relative;\"><a href=\"#l-06-consider-indexing-unindexed-events\" aria-label=\"l 06 consider indexing unindexed events permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-06] Consider indexing unindexed events</h2>\n<p>Instances:<br>\n<code>AmbireAccountFactory.sol#L7</code></p>\n<h2 id=\"l-07-error-message-with-opposite-meaning\" style=\"position:relative;\"><a href=\"#l-07-error-message-with-opposite-meaning\" aria-label=\"l 07 error message with opposite meaning permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-07] Error message with opposite meaning</h2>\n<p>The anti-bricking checks return <code>PRIVILEGE_NOT_DOWNGRADED</code> if the sender/signer key removes their own privilege. If this is attempted, this error message suggests that the privilege should have been downgraded but wasn’t, which is the opposite of what is intended. The error message should therefore rather be <code>PRIVILEGE_DOWNGRADED</code> or <code>PRIVILEGE_MUST_NOT_BE_DOWNGRADED</code> or similar.</p>\n<p>Instances:<br>\n<code>AmbireAccount.sol#L193</code>\n<code>AmbireAccount.sol#L207</code></p>\n<h2 id=\"l-08-non-scheduled-recoveries-can-be-cancelled\" style=\"position:relative;\"><a href=\"#l-08-non-scheduled-recoveries-can-be-cancelled\" aria-label=\"l 08 non scheduled recoveries can be cancelled permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-08] Non-scheduled recoveries can be cancelled</h2>\n<p>When a recovery is cancelled, <code>LogRecoveryCancelled</code> is emitted (<code>AmbireAccount.sol#L173</code>). This happens even if the recovery wasn’t previously scheduled, giving a false impression that it was. Consider reverting attempts to cancel a recovery that hasn’t already been scheduled.</p>\n<h2 id=\"l-09-ambireaccountconstructor-does-not-allow-for-custom-privileges\" style=\"position:relative;\"><a href=\"#l-09-ambireaccountconstructor-does-not-allow-for-custom-privileges\" aria-label=\"l 09 ambireaccountconstructor does not allow for custom privileges permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-09] <code>AmbireAccount.constructor()</code> does not allow for custom privileges</h2>\n<p><code>AmbireAccount.constructor()</code> only sets <code>privileges[addrs[i]] = bytes32(uint(1));</code> (<code>AmbireAccount.sol#L62</code>). A second call is necessary to set the remaining <code>privileges</code>, at <code>FALLBACK_HANDLER_SLOT</code> and the value <code>recoveryInfoHash</code>.\nConsider adding a parameter with the values to set at <code>addrs</code>.</p>\n<h2 id=\"l-10-it-makes-more-sense-to-check-signatureslength--0-than-signer--address0-for-multisigs\" style=\"position:relative;\"><a href=\"#l-10-it-makes-more-sense-to-check-signatureslength--0-than-signer--address0-for-multisigs\" aria-label=\"l 10 it makes more sense to check signatureslength  0 than signer  address0 for multisigs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-10] It makes more sense to check <code>signatures.length > 0</code> than <code>signer != address(0)</code> for multisigs</h2>\n<p>In <code>SignatureValidator.recoverAddrImpl()</code> for <code>SignatureMode.Multisig</code>, it is checked that last <code>signer != address(0)</code> (<code>SignatureValidator.sol#L92</code>) after validating each signature in the array <code>signatures</code>. This can be <code>address(0)</code> only if <code>signatures.length == 0</code>, in which case the for-loop is skipped, leaving <code>signer</code> unassigned. It would make more sense to instead check <code>require(signatures.length != 0, 'SV_ZERO_SIG');</code>, just after L85.</p>\n<h2 id=\"l-11-redundant-requirerevert\" style=\"position:relative;\"><a href=\"#l-11-redundant-requirerevert\" aria-label=\"l 11 redundant requirerevert permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-11] Redundant require/revert</h2>\n<p>In <code>SignatureValidator.recoverAddrImpl()</code> it is first checked that <code>require(modeRaw &#x3C; uint8(SignatureMode.LastUnused), 'SV_SIGMODE');</code> (<code>SignatureValidator.sol#L49</code>). This ensures that <code>SignatureMode mode = SignatureMode(modeRaw);</code> will be one of the available signature modes. Each of these modes is then considered and the function returns in each case. But at the end of the function, there is a <code>revert('SV_TYPE');</code> (<code>SignatureValidator.sol#L120</code>). This line can therefore not be reached.\nConsider removing either of these checks, as they have the same effect.</p>\n<h2 id=\"l-12-group-order-denoted-q-may-be-confused-with-the-public-key\" style=\"position:relative;\"><a href=\"#l-12-group-order-denoted-q-may-be-confused-with-the-public-key\" aria-label=\"l 12 group order denoted q may be confused with the public key permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-12] Group order denoted <code>Q</code> may be confused with the public key</h2>\n<p>In <code>SignatureValidator.sol</code>, the Schnorr signature scheme group order is denoted <code>Q</code>. While in the context of Schnorr signatures, a lowercase <code>'q'</code> is sometimes used to denote the group order. This particular Schnorr signature scheme uses the subgroup generated by the secp256k1 base point, the order of which is usually denoted <code>n</code>. I.e. the value which is here denoted <code>Q</code> is usually known as <code>n</code>. Furthermore, secp256k1 is primarily thought of in the context of ECDSA, where <code>Q</code> usually denotes the public key.\nConsider renaming <code>Q</code> to <code>n</code>.</p>\n<h2 id=\"l-13-use-uint256-instead-of-uint\" style=\"position:relative;\"><a href=\"#l-13-use-uint256-instead-of-uint\" aria-label=\"l 13 use uint256 instead of uint permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-13] Use <code>uint256</code> instead of <code>uint</code></h2>\n<p>Consider using the explicit <code>uint256</code> consistently instead of its alias <code>uint</code>.</p>\n<p>Instances:<br>\n<code>AmbireAccount.sol#L15</code><br>\n<code>AmbireAccount.sol#L62</code><br>\n<code>AmbireAccount.sol#L63</code><br>\n<code>AmbireAccount.sol#L94</code></p>\n<h2 id=\"l-14-typos\" style=\"position:relative;\"><a href=\"#l-14-typos\" aria-label=\"l 14 typos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-14] Typos</h2>\n<p>Instances:<br>\ncontracft -> contract (<code>AmbireAccountFactory.sol#L15</code>)<br>\n<code>// bytes4(keccak256(\"isValidSignature(bytes32,bytes)\") -> // bytes4(keccak256(\"isValidSignature(bytes32,bytes)\"))</code>(<code>AmbireAccount.sol#L243</code>)</p>\n<h2 id=\"l-15-requiresp--0-fails-to-protect-schnorr-signature-validation\" style=\"position:relative;\"><a href=\"#l-15-requiresp--0-fails-to-protect-schnorr-signature-validation\" aria-label=\"l 15 requiresp  0 fails to protect schnorr signature validation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-15] <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/30\"><code>require(sp != 0);</code> fails to protect Schnorr signature validation</a></h2>\n<p>An incorrect check drastically reduces the security of Schnorr validation. Whether it is completely broken depends on whether fixed points can be found for <code>keccak256(f(x))</code>.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Schnorr signatures are validated like this:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">mode</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">SignatureMode</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Schnorr</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// px := public key x-coord</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// e := schnorr signature challenge</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// s := schnorr signature</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// parity := public key y-coord parity (27 or 28)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// last uint8 is for the Ambire sig mode - it&#39;s ignored</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">sig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">trimToSize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sig</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">px</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">e</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">s</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">parity</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sig</span><span class=\"mtk1\">, (</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// ecrecover = (m, v, r, s);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Q</span><span class=\"mtk1\"> - </span><span class=\"mtk11\">mulmod</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">s</span><span class=\"mtk1\">), </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">px</span><span class=\"mtk1\">), </span><span class=\"mtk12\">Q</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ep</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Q</span><span class=\"mtk1\"> - </span><span class=\"mtk11\">mulmod</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">e</span><span class=\"mtk1\">), </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">px</span><span class=\"mtk1\">), </span><span class=\"mtk12\">Q</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sp</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// the ecrecover precompile implementation checks that the `r` and `s`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// inputs are non-zero (in this case, `px` and `ep`), thus we don&#39;t need to</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// check if they&#39;re zero.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">R</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ecrecover</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">parity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">px</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ep</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">R</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&#39;SV_ZERO_SIG&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">e</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">R</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">parity</span><span class=\"mtk1\">), </span><span class=\"mtk12\">px</span><span class=\"mtk1\">, </span><span class=\"mtk12\">hash</span><span class=\"mtk1\">)), </span><span class=\"mtk8\">&#39;SV_SCHNORR_FAILED&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint160</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">px</span><span class=\"mtk1\">)));</span></span></span></code></pre>\n<p><code>ecrecover(sp, parity, px, ep)</code>\n<code>ecrecover(m, v, r, s)</code> returns a hash of <code>(1/r) * (s*P - m*G)</code>, where <code>P</code> is a point derived from <code>r</code> and <code>v</code>, and the operations are to be interpreted as elliptic curve point operations. In our case, where <code>ecrecover(sp, parity, px, ep)</code>, we get <code>(1/px) * (ep*P - sp*G)</code>. We see that if <code>sp % Q == 0</code> then <code>G*sp == O</code>, where <code>O</code> is the identity; because <code>Q</code> is the order of <code>G</code>, so <code>(1/px) * (ep*P - sp*G) = ep/px * P</code>. This means we could make ANY public key <code>px</code> pass validation in <code>ecrecover</code>.</p>\n<p>Achieving <code>sp % Q == 0</code> should have been prevented by <code>require(sp != 0);</code>, which fails to consider that <code>sp == Q</code> is equally impermissible. In fact, the check cannot trigger because <code>sp > 0</code> since <code>mulmod(uint256(s), uint256(px), Q) &#x3C; Q</code>.\nSo if we simply let <code>s == 0</code>, which we are free to do, then <code>sp</code> evaluates to <code>bytes32(Q - mulmod(0, uint256(px), Q)) == bytes32(Q - 0) == bytes32(Q)</code>, which leads to the issue described above.</p>\n<p>If this was normal ECDSA validation it would already have been broken. But we now also require that <code>e == keccak256(abi.encodePacked(R, uint8(parity), px, hash))</code>. Recall that <code>R = ep/px * P</code>. We can therefore consider <code>R</code> a function of <code>e</code>. <code>R</code> is then hashed with <code>px</code> and <code>hash</code>, which are predetermined values that we want to attack. This line can therefore be thought of as a keccak256-based hash function <code>H</code> of <code>e</code>. Therefore, we have the problem of finding an <code>e</code> such that <code>e == H(e)</code>.</p>\n<p>Finding this enables the attacker to validate and execute any transaction hash.</p>\n<p>keccak256 is considered safe against pre-image attacks, i.e. given <code>y</code> find <code>x</code> such that <code>y == keccak256(x)</code>. But finding a fixed point, i.e. <code>e</code> such that <code>e == H(e)</code> may be considerably easier. I have been unable to confirm whether it is known to be possible for keccak256, <a href=\"https://crypto.stackexchange.com/questions/48580/fixed-point-of-the-sha-256-compression-function\"> but it does seem possible for <code>sha256</code></a>. Considering that <a href=\"https://sha-mbles.github.io/\">SHA-1 has already been broken for a chosen-prefix attack</a>, it does not seem unrealistic that a fixed point attack will be achievable in this case.</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Fortunately, this is trivial to mitigate:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">- </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sp</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+ </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sp</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">Q</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>since <code>0 &#x3C; sp &#x3C;= Q</code>. Or, for peace of mind, <code>require(sp % Q != 0)</code>.</p>\n<h3 id=\"assessed-type\" style=\"position:relative;\"><a href=\"#assessed-type\" aria-label=\"assessed type permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Invalid Validation</p>\n<h2 id=\"l-16-transactions-bundles-signed-for-a-future-nonce-cannot-be-cancelled\" style=\"position:relative;\"><a href=\"#l-16-transactions-bundles-signed-for-a-future-nonce-cannot-be-cancelled\" aria-label=\"l 16 transactions bundles signed for a future nonce cannot be cancelled permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-16] <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/31\">Transactions bundles signed for a future nonce cannot be cancelled</a></h2>\n<p>Transaction bundles signed for a future nonce cannot be cancelled, except by possibly and unfeasibly, many calls to <code>execute()</code>.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>AmbireAccount.execute()</code> validates a signature against a hash based on an incrementing nonce (<code>AmbireAccount.sol#L138</code>). Only a transaction bundle hash with the current nonce can be executed. A signature for the current nonce may thus be invalidated by signing a dummy transaction bundle, which only causes the nonce to increment, rendering the undesirable signature forever inexecutable. But if a transaction bundle is signed for a nonce in the future, either by mistake or in anticipation of a <code>executeMultiple()</code> call, the only way to cancel the signature would be to repeatedly call <code>execute()</code> until the nonce has passed. This might cost significant gas (the signed nonce might be arbitrarily high), and the transaction bundle might then be executed anyway by a frontrunner.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Implement a mapping which stores cancelled transaction bundle hashes, and check this before executing.</p>\n<h3 id=\"assessed-type-1\" style=\"position:relative;\"><a href=\"#assessed-type-1\" aria-label=\"assessed type 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Context</p>\n<h2 id=\"l-17-the-anti-bricking-mechanism-only-applies-to-the-normal-mode-but-not-the-recovery-mode\" style=\"position:relative;\"><a href=\"#l-17-the-anti-bricking-mechanism-only-applies-to-the-normal-mode-but-not-the-recovery-mode\" aria-label=\"l 17 the anti bricking mechanism only applies to the normal mode but not the recovery mode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-17] <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/32\">The anti-bricking mechanism only applies to the normal mode, but not the recovery mode</a></h2>\n<p><code>recoveryInfoHash</code> is critical for recovery but is not protected in the same way a signer’s own privilege is protected. It is therefore possible for a recovery key to remove its own ability to recover the account, bricking the account.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The anti-bricking mechanism is supposed to prevent a signer from signing away their own privilege. This is checked by <code>[require(privileges[signerKey] != bytes32(0), 'PRIVILEGE_NOT_DOWNGRADED');</code> (<code>AmbireAccount.sol#L193</code>) at the end of <code>AmbireAccount.execute()</code>. But this presupposes that it was <code>signerKey</code> that signed the transaction just executed. This is not the case in the case of a recovery. Then <code>signerKey</code> is <code>signerKeyToRecover</code> such that <code>[privileges[signerKeyToRecover] == recoveryInfoHash]</code> (<code>AmbireAccount.sol#L153</code>). <code>signerKeyToRecover</code> is supposedly the key we are trying to recover, meaning it is lost, so it doesn’t matter what happens to its privileges. We are probably about to give privilege to a new address.</p>\n<p>It seems plausible that this new address might be incorrectly entered, and in this case it is critical that the recovery key (which signed the transaction about to be executed) cannot revoke its own ability to recover, leaving the account with no authorised signer.\nRecovery keys do not operate based on <code>privileges</code>, but on there being an appropriate <code>recoveryInfoHash</code> set, as noted above. Therefore this value must not be allowed to change, which would be the analogous anti-bricking mechanism for recoveries.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>At a minimum simply check that <code>privileges[signerKeyToRecover] == recoveryInfoHash</code> still.</p>\n<p>But note that we might actually want to be able to set <code>privileges[signerKeyToRecover] = 0</code> for fear that the lost key might become compromised. Currently, this is not possible. It would be acceptable to move <code>recoveryInfoHash</code> somewhere else, i.e. <code>privileges[someOtherSignerKeyToRecover] = recoveryInfoHash</code>. Note that <code>someOtherSignerKeyToRecover</code> may actually be an arbitrary address; it is only used to retrieve <code>recoveryInfoHash</code>. So it is not critical that <code>someOtherSignerKeyToRecover</code> is a valid address that we can sign with; we can still use it to recover with.</p>\n<p>An alternative could then be, to allow <code>privileges[signerKeyToRecover] == 0</code> for recoveries being finalised and instead require that <code>privileges[someOtherSignerKeyToRecover] == recoveryInfoHash</code> for <code>someOtherSignerKeyToRecover</code>. This can be seen as having two separate but analogous anti-bricking mechanisms, one for normal execution and one for recovery.</p>\n<h3 id=\"assessed-type-2\" style=\"position:relative;\"><a href=\"#assessed-type-2\" aria-label=\"assessed type 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Invalid Validation</p>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this audit, 2 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/35\">report highlighted below</a> by <strong>d3e4</strong> received the top score from the judge.</p>\n<p><em>The following warden also submitted a report: <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/28\">adriro</a>.</em></p>\n<h2 id=\"g-01-splitsignature-may-be-redundant\" style=\"position:relative;\"><a href=\"#g-01-splitsignature-may-be-redundant\" aria-label=\"g 01 splitsignature may be redundant permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] <code>splitSignature()</code> may be redundant</h2>\n<p><code>SignatureValidator.splitSignature()</code> seems to only be used once in <code>AmbireAccount.sol#L145</code>, where only its first return value is used, which is <code>signature</code> with its last byte removed. We can thus simply inline <code>Bytes.trimToSize()</code> instead:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ import &#39;./Bytes.sol&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- (bytes memory sig, ) = SignatureValidator.splitSignature(signature);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ bytes memory sig = Bytes.trimToSize(signature, signature.length - 1);</span></span></span></code></pre>\n<h2 id=\"g-02-cache-variable\" style=\"position:relative;\"><a href=\"#g-02-cache-variable\" aria-label=\"g 02 cache variable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Cache variable</h2>\n<p><code>sig.length - 1</code> may be cached in memory in:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">modeRaw</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sig</span><span class=\"mtk1\">[</span><span class=\"mtk12\">sig</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">sig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">trimToSize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sig</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"g-03-unnecessary-require-in-ambireaccountfactorydeploysafe\" style=\"position:relative;\"><a href=\"#g-03-unnecessary-require-in-ambireaccountfactorydeploysafe\" aria-label=\"g 03 unnecessary require in ambireaccountfactorydeploysafe permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Unnecessary require in <code>AmbireAccountFactory.deploySafe()</code></h2>\n<p><code>AmbireAccountFactory.deploySafe(code, salt)</code> returns the address where the bytecode “code” is deployed itself, deploying it first if it isn’t already deployed. Therefore, it is meaningless to check that the fresh deployment is successful, which only amounts to checking that the opcode <code>CREATE2</code> works as expected. Specifically:\n<code>require(addr == expectedAddr, 'FAILED_MATCH');</code> in <code>AmbireAccountFactory.deploySafe()</code> can be removed, as it must be assumed that the calculation of <code>expectedAddr</code> is correct.\n<code>require(addr != address(0), 'FAILED_DEPLOYING');</code> will never trigger, as <code>CREATE2</code> only returns <code>address(0)</code> when trying to deploy to the same address twice, which is not the case since it is already checked that <code>extcodesize(addr) == 0</code>.</p>\n<h2 id=\"g-04-unnecessary-require-in-signaturevalidatorrecoveraddrimpl\" style=\"position:relative;\"><a href=\"#g-04-unnecessary-require-in-signaturevalidatorrecoveraddrimpl\" aria-label=\"g 04 unnecessary require in signaturevalidatorrecoveraddrimpl permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Unnecessary require in <code>SignatureValidator.recoverAddrImpl()</code></h2>\n<p><code>address signer = address(wallet);</code> so <code>require(signer != address(0), 'SV_ZERO_SIG');</code> is redundant in <code>SignatureValidator.recoverAddrImpl()</code>, as it would already have reverted in <code>wallet.isValidSignature(hash, sig)</code>, because of a function call to the zero address.</p>\n<h2 id=\"g-05-unnecessary-declaration-of-currentnonce\" style=\"position:relative;\"><a href=\"#g-05-unnecessary-declaration-of-currentnonce\" aria-label=\"g 05 unnecessary declaration of currentnonce permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Unnecessary declaration of `currentNonce<code></code></h2>\n<p>In <code>AmbireAccount.execute()</code> <code>currentNonce</code> is declared: <code>uint256 currentNonce = nonce;</code> (<code>AmbireAccount.sol#L136</code>), but never changed, and then used to update <code>nonce</code>: <code>nonce = currentNonce + 1;</code> (<code>AmbireAccount.sol#L189</code>). <code>nonce</code> alone can be used throughout and then incremented by <code>nonce++</code>.</p>\n<h2 id=\"g-06-it-is-more-gas-efficient-to-revert-with-a-custom-error-than-a-require-with-a-string\" style=\"position:relative;\"><a href=\"#g-06-it-is-more-gas-efficient-to-revert-with-a-custom-error-than-a-require-with-a-string\" aria-label=\"g 06 it is more gas efficient to revert with a custom error than a require with a string permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] It is more gas efficient to revert with a custom error than a <code>require</code> with a string</h2>\n<p>See <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/35\">Gas Optimizations Report</a> for details. </p>\n<h2 id=\"g-07-constructors-may-be-declared-payable-to-save-gas\" style=\"position:relative;\"><a href=\"#g-07-constructors-may-be-declared-payable-to-save-gas\" aria-label=\"g 07 constructors may be declared payable to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] Constructors may be declared <code>payable</code> to save gas</h2>\n<p>Instances:<br>\nAmbireAccount.sol#L58\nAmbireAccountFactory.sol#L11</p>\n<hr>\n<h1 id=\"mitigation-review\" style=\"position:relative;\"><a href=\"#mitigation-review\" aria-label=\"mitigation review permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review</h1>\n<h2 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p>Following the C4 audit, 3 wardens (<a href=\"https://twitter.com/adrianromero\">adriro</a>, <a href=\"https://twitter.com/carlitox477\">carlitox477</a> and rbserver) reviewed the mitigations for all identified issues. Additional details can be found within the <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation\">C4 Ambire Wallet Mitigation Review repository</a>.</p>\n<h2 id=\"overview-of-changes\" style=\"position:relative;\"><a href=\"#overview-of-changes\" aria-label=\"overview of changes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview of Changes</h2>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation#overview-of-changes\">Summary from the Sponsor</a>:</strong></p>\n<p>We fixed 4 of the vulnerabilities after they were found, and we chose not to mitigate one.</p>\n<h2 id=\"mitigation-review-scope\" style=\"position:relative;\"><a href=\"#mitigation-review-scope\" aria-label=\"mitigation review scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review Scope</h2>\n<table>\n<thead>\n<tr>\n<th>Mitigation of</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>M-02</td>\n<td>Check gasleft to prevent this attack</td>\n</tr>\n<tr>\n<td>M-03</td>\n<td>Increment the nonce to prevent replaying recovery transactions</td>\n</tr>\n<tr>\n<td>M-04</td>\n<td>Downgrade Solidity to allow deploying on pre-Shanghai networks</td>\n</tr>\n<tr>\n<td>M-05</td>\n<td>To mitigate this and avoid confusion, we removed the constructor as it’s not used anyway</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"mitigation-review-summary\" style=\"position:relative;\"><a href=\"#mitigation-review-summary\" aria-label=\"mitigation review summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review Summary</h2>\n<table>\n<thead>\n<tr>\n<th>Original Issue</th>\n<th>Status</th>\n<th>Full Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/18\">M-02</a></td>\n<td>Not fully mitigated</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/15\">adriro</a> and <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/9\">carlitox477</a>, and also shared below</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/16\">M-03</a></td>\n<td>Not fully mitigated</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/19\">adriro</a>, <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/6\">carlitox477</a>, and <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/10\">rbserver</a>, and also shared below</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/12\">M-04</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/17\">adriro</a>, <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/4\">carlitox477</a>, and <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/12\">rbserver</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/10\">M-05</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/18\">adriro</a>, <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/5\">carlitox477</a>, and <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/11\">rbserver</a></td>\n</tr>\n</tbody>\n</table>\n<p><strong>See below for details regarding the two issues that were not fully mitigated.</strong></p>\n<h2 id=\"mitigation-of-m-02-not-fully-mitigated\" style=\"position:relative;\"><a href=\"#mitigation-of-m-02-not-fully-mitigated\" aria-label=\"mitigation of m 02 not fully mitigated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/15\">Mitigation of M-02: Not fully mitigated</a></h2>\n<p><em>Submitted by adriro, also found by <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/9\">carlitox477</a>.</em></p>\n<h3 id=\"original-issue\" style=\"position:relative;\"><a href=\"#original-issue\" aria-label=\"original issue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Original Issue</h3>\n<p>M-02: <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/18\">Attacker can force the failure of transactions that use <code>tryCatch</code></a> </p>\n<h3 id=\"comments\" style=\"position:relative;\"><a href=\"#comments\" aria-label=\"comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comments</h3>\n<p>While the issue mentioned in M-02 has been technically mitigated, the same attack can be performed in another function present in the wallet.</p>\n<p>The report describes an attack in which a malicious relayer can force the failure of calls to <code>tryCatch</code>. The issue in this specific function has been mitigated, however the same attack can be performed in the function <code>tryCatchLimit</code>.</p>\n<h2 id=\"mitigation-of-m-03-not-fully-mitigated\" style=\"position:relative;\"><a href=\"#mitigation-of-m-03-not-fully-mitigated\" aria-label=\"mitigation of m 03 not fully mitigated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/19\">Mitigation of M-03: Not fully mitigated</a></h2>\n<p><em>Submitted by adriro, also found by <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/6\">carlitox477</a> and <a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/10\">rbserver</a>.</em></p>\n<h3 id=\"original-issue-1\" style=\"position:relative;\"><a href=\"#original-issue-1\" aria-label=\"original issue 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Original Issue</h3>\n<p>M-03: <a href=\"https://github.com/code-423n4/2023-05-ambire-findings/issues/16\">Recovery transaction can be replayed after a cancellation</a></p>\n<p>The mitigation of M-03 contains an error in the implementation of the fix. The original issue is still present.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The report in M-03 describes an issue related to the replay of the recovery transaction. After a cancellation is executed, the same transaction that initiated the recovery procedure can be replayed since the nonce is not incremented after canceling the recovery.</p>\n<p>The intended fix is present. The updated implementation of <code>execute()</code> is as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">131</span><span class=\"mtk1\">: \t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">execute</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Transaction</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calls</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signature</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">132</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentNonce</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">nonce</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">133</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk3\">// NOTE: abi.encode is safer than abi.encodePacked in terms of collision safety</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">134</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">chainid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currentNonce</span><span class=\"mtk1\">, </span><span class=\"mtk12\">calls</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">135</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">136</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signerKey</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">137</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk3\">// Recovery signature: allows to perform timelocked calls</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">138</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sigMode</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint8</span><span class=\"mtk1\">(</span><span class=\"mtk12\">signature</span><span class=\"mtk1\">[</span><span class=\"mtk12\">signature</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">139</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">140</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">sigMode</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">SIGMODE_RECOVER</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">sigMode</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">SIGMODE_CANCEL</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">141</span><span class=\"mtk1\">: \t\t\t(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sig</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">SignatureValidator</span><span class=\"mtk1\">.</span><span class=\"mtk11\">splitSignature</span><span class=\"mtk1\">(</span><span class=\"mtk12\">signature</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">142</span><span class=\"mtk1\">: \t\t\t(</span><span class=\"mtk12\">RecoveryInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recoveryInfo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">innerRecoverySig</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signerKeyToRecover</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">143</span><span class=\"mtk1\">: \t\t\t\t</span><span class=\"mtk12\">sig</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">144</span><span class=\"mtk1\">: \t\t\t\t(</span><span class=\"mtk12\">RecoveryInfo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">145</span><span class=\"mtk1\">: \t\t\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">146</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk12\">signerKey</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">signerKeyToRecover</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">147</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isCancellation</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">sigMode</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">SIGMODE_CANCEL</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">148</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recoveryInfoHash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recoveryInfo</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">149</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">privileges</span><span class=\"mtk1\">[</span><span class=\"mtk12\">signerKeyToRecover</span><span class=\"mtk1\">] == </span><span class=\"mtk12\">recoveryInfoHash</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;RECOVERY_NOT_AUTHORIZED&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">150</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">151</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">scheduled</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">scheduledRecoveries</span><span class=\"mtk1\">[</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">152</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">scheduled</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">isCancellation</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">153</span><span class=\"mtk1\">: \t\t\t\t</span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">scheduled</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;RECOVERY_NOT_READY&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">154</span><span class=\"mtk1\">: \t\t\t\t</span><span class=\"mtk12\">nonce</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">155</span><span class=\"mtk1\">: \t\t\t\t</span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">scheduledRecoveries</span><span class=\"mtk1\">[</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">156</span><span class=\"mtk1\">: \t\t\t\t</span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogRecoveryFinalized</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recoveryInfoHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">157</span><span class=\"mtk1\">: \t\t\t} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">158</span><span class=\"mtk1\">: \t\t\t\t</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hashToSign</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">isCancellation</span><span class=\"mtk1\"> ? </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x63616E63</span><span class=\"mtk1\">)) : </span><span class=\"mtk12\">hash</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">159</span><span class=\"mtk1\">: \t\t\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recoveryKey</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">SignatureValidator</span><span class=\"mtk1\">.</span><span class=\"mtk11\">recoverAddrImpl</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hashToSign</span><span class=\"mtk1\">, </span><span class=\"mtk12\">innerRecoverySig</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">160</span><span class=\"mtk1\">: \t\t\t\t</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isIn</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">161</span><span class=\"mtk1\">: \t\t\t\t</span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">recoveryInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">keys</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">162</span><span class=\"mtk1\">: \t\t\t\t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">recoveryInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">keys</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] == </span><span class=\"mtk12\">recoveryKey</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">163</span><span class=\"mtk1\">: \t\t\t\t\t\t</span><span class=\"mtk12\">isIn</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">164</span><span class=\"mtk1\">: \t\t\t\t\t\t</span><span class=\"mtk15\">break</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">165</span><span class=\"mtk1\">: \t\t\t\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">166</span><span class=\"mtk1\">: \t\t\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">167</span><span class=\"mtk1\">: \t\t\t\t</span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">isIn</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;RECOVERY_NOT_AUTHORIZED&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">168</span><span class=\"mtk1\">: \t\t\t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isCancellation</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">169</span><span class=\"mtk1\">: \t\t\t\t\t</span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">scheduledRecoveries</span><span class=\"mtk1\">[</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">170</span><span class=\"mtk1\">: \t\t\t\t\t</span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogRecoveryCancelled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recoveryInfoHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recoveryKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">171</span><span class=\"mtk1\">: \t\t\t\t} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">172</span><span class=\"mtk1\">: \t\t\t\t\t</span><span class=\"mtk12\">scheduledRecoveries</span><span class=\"mtk1\">[</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">recoveryInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timelock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">173</span><span class=\"mtk1\">: \t\t\t\t\t</span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogRecoveryScheduled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recoveryInfoHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recoveryKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currentNonce</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">calls</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">174</span><span class=\"mtk1\">: \t\t\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">175</span><span class=\"mtk1\">: \t\t\t\t</span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">176</span><span class=\"mtk1\">: \t\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">177</span><span class=\"mtk1\">: \t\t} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">178</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk12\">signerKey</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">SignatureValidator</span><span class=\"mtk1\">.</span><span class=\"mtk11\">recoverAddrImpl</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">signature</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">179</span><span class=\"mtk1\">: \t\t\t</span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">privileges</span><span class=\"mtk1\">[</span><span class=\"mtk12\">signerKey</span><span class=\"mtk1\">] != </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&#39;INSUFFICIENT_PRIVILEGE&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">180</span><span class=\"mtk1\">: \t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">181</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">182</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk3\">// we increment the nonce to prevent reentrancy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">183</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk3\">// also, we do it here as we want to reuse the previous nonce</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">184</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk3\">// and respectively hash upon recovery / canceling</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">185</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk3\">// doing this after sig verification is fine because sig verification can only do STATICCALLS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">186</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk12\">nonce</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">currentNonce</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">187</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk11\">executeBatch</span><span class=\"mtk1\">(</span><span class=\"mtk12\">calls</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">188</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">189</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk3\">// The actual anti-bricking mechanism - do not allow a signerKey to drop their own privileges</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">190</span><span class=\"mtk1\">: \t\t</span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">privileges</span><span class=\"mtk1\">[</span><span class=\"mtk12\">signerKey</span><span class=\"mtk1\">] != </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&#39;PRIVILEGE_NOT_DOWNGRADED&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">191</span><span class=\"mtk1\">: \t}</span></span></span></code></pre>\n<p>The patched line is 154. Note that this line belongs to a path that is executed when the recovery process is finally executed after the timelock, and has nothing to do with the cancellation of the process. Note also that the change is in fact a no operation, since the increment is overwritten by line 186:</p>\n<ol>\n<li>Line 132 sets <code>currentNonce</code> to the actual value of <code>nonce</code>, say <code>N</code>.</li>\n<li>Line 154 executes <code>nonce++</code> which sets the storage value of <code>nonce</code> to <code>N+1</code>.</li>\n<li>Recovery bundle is executed and line 186 sets the storage value of <code>nonce</code> to <code>currentNonce + 1</code>, which means that <code>nonce</code> is still <code>N+1</code>.</li>\n</ol>\n<p>The intended fix contains an error and fails to mitigate the issue. It is not clear if this was mistakenly placed in the wrong code path or if there was a confusion related to the different code paths that this function may take. In any case, the nonce is not incremented after a cancellation, which means that the replay attack is still possible.</p>\n<h3 id=\"recommendation-5\" style=\"position:relative;\"><a href=\"#recommendation-5\" aria-label=\"recommendation 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>The <code>nonce</code> should be incremented in the path that executes the cancellation, as recommended in the report for M-03.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isCancellation</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">scheduledRecoveries</span><span class=\"mtk1\">[</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+   </span><span class=\"mtk12\">nonce</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">currentNonce</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogRecoveryCancelled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recoveryInfoHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recoveryKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">scheduledRecoveries</span><span class=\"mtk1\">[</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">recoveryInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timelock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogRecoveryScheduled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recoveryInfoHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recoveryKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currentNonce</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">txns</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/19#issuecomment-1601712658\">Ivshti (Ambire) commented</a>:</strong></p>\n<blockquote>\n<p>Fixed.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-06-ambire-mitigation-findings/issues/19#issuecomment-1602720352\">adriro (warden) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>Fixed.</p>\n</blockquote>\n<p>LGTM</p>\n</blockquote>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#medium-risk-findings-5\">Medium Risk Findings (5)</a></p>\n<ul>\n<li><a href=\"#m-01-fallback-handlers-can-trick-users-into-calling-functions-of-the-ambireaccount-contract\">[M-01] Fallback handlers can trick users into calling functions of the AmbireAccount contract</a></li>\n<li><a href=\"#m-02-attacker-can-force-the-failure-of-transactions-that-use-trycatch\">[M-02] Attacker can force the failure of transactions that use <code>tryCatch</code></a></li>\n<li><a href=\"#m-03-recovery-transaction-can-be-replayed-after-a-cancellation\">[M-03] Recovery transaction can be replayed after a cancellation</a></li>\n<li><a href=\"#m-04-project-may-fail-to-be-deployed-to-chains-not-compatible-with-shanghai-hardfork\">[M-04] Project may fail to be deployed to chains not compatible with Shanghai hardfork</a></li>\n<li><a href=\"#m-05-ambireaccount-implementation-can-be-destroyed-by-privileges\">[M-05] AmbireAccount implementation can be destroyed by privileges</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#l-01-ambireaccountfactorydeploysafe-does-not-guarantee-that-no-call-hasnt-already-been-made-on-the-deployed-contract\">L-01 <code>AmbireAccountFactory.deploySafe()</code> does not guarantee that no call hasn’t already been made on the deployed contract</a></li>\n<li><a href=\"#l-02-fallback-handler-should-not-be-allowed-to-be-this\">L-02 Fallback handler should not be allowed to be <code>this</code></a></li>\n<li><a href=\"#l-03-schnorr-signature-validation-may-be-incompatible-with-the-intended-signers\">L-03 Schnorr signature validation may be incompatible with the intended signers</a></li>\n<li><a href=\"#l-04-schnorr-signature-length-is-not-checked\">L-04 Schnorr signature length is not checked</a></li>\n<li><a href=\"#l-05-logprivilegechanged-does-not-adequately-describe-the-change\">L-05 <code>LogPrivilegeChanged</code> does not adequately describe the change</a></li>\n<li><a href=\"#l-06-consider-indexing-unindexed-events\">L-06 Consider indexing unindexed events</a></li>\n<li><a href=\"#l-07-error-message-with-opposite-meaning\">L-07 Error message with opposite meaning</a></li>\n<li><a href=\"#l-08-non-scheduled-recoveries-can-be-cancelled\">L-08 Non-scheduled recoveries can be cancelled</a></li>\n<li><a href=\"#l-09-ambireaccountconstructor-does-not-allow-for-custom-privileges\">L-09 <code>AmbireAccount.constructor()</code> does not allow for custom privileges</a></li>\n<li><a href=\"#l-10-it-makes-more-sense-to-check-signatureslength--0-than-signer--address0-for-multisigs\">L-10 It makes more sense to check <code>signatures.length > 0</code> than <code>signer != address(0)</code> for multisigs</a></li>\n<li><a href=\"#l-11-redundant-requirerevert\">L-11 Redundant require/revert</a></li>\n<li><a href=\"#l-12-group-order-denoted-q-may-be-confused-with-the-public-key\">L-12 Group order denoted <code>Q</code> may be confused with the public key</a></li>\n<li><a href=\"#l-13-use-uint256-instead-of-uint\">L-13 Use <code>uint256</code> instead of <code>uint</code></a></li>\n<li><a href=\"#l-14-typos\">L-14 Typos</a></li>\n<li><a href=\"#l-15-requiresp--0-fails-to-protect-schnorr-signature-validation\">L-15 <code>require(sp != 0);</code> fails to protect Schnorr signature validation</a></li>\n<li><a href=\"#l-16-transactions-bundles-signed-for-a-future-nonce-cannot-be-cancelled\">L-16 Transactions bundles signed for a future nonce cannot be cancelled</a></li>\n<li><a href=\"#l-17-the-anti-bricking-mechanism-only-applies-to-the-normal-mode-but-not-the-recovery-mode\">L-17 The anti-bricking mechanism only applies to the normal mode, but not the recovery mode</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-splitsignature-may-be-redundant\">G-01 <code>splitSignature()</code> may be redundant</a></li>\n<li><a href=\"#g-02-cache-variable\">G-02 Cache variable</a></li>\n<li><a href=\"#g-03-unnecessary-require-in-ambireaccountfactorydeploysafe\">G-03 Unnecessary require in <code>AmbireAccountFactory.deploySafe()</code></a></li>\n<li><a href=\"#g-04-unnecessary-require-in-signaturevalidatorrecoveraddrimpl\">G-04 Unnecessary require in <code>SignatureValidator.recoverAddrImpl()</code></a></li>\n<li><a href=\"#g-05-unnecessary-declaration-of-currentnonce\">G-05 Unnecessary declaration of `currentNonce<code></code></a></li>\n<li><a href=\"#g-06-it-is-more-gas-efficient-to-revert-with-a-custom-error-than-a-require-with-a-string\">G-06 It is more gas efficient to revert with a custom error than a <code>require</code> with a string</a></li>\n<li><a href=\"#g-07-constructors-may-be-declared-payable-to-save-gas\">G-07 Constructors may be declared <code>payable</code> to save gas</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#mitigation-review\">Mitigation Review</a></p>\n<ul>\n<li><a href=\"#introduction\">Introduction</a></li>\n<li><a href=\"#overview-of-changes\">Overview of Changes</a></li>\n<li><a href=\"#mitigation-review-scope\">Mitigation Review Scope</a></li>\n<li><a href=\"#mitigation-review-summary\">Mitigation Review Summary</a></li>\n<li><a href=\"#mitigation-of-m-02-not-fully-mitigated\">Mitigation of M-02: Not fully mitigated</a></li>\n<li><a href=\"#mitigation-of-m-03-not-fully-mitigated\">Mitigation of M-03: Not fully mitigated</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}