{
  "circa": {
    "title": "Sushi Trident contest phase 1",
    "sponsor": "Sushi",
    "slug": "2021-09-sushitrident",
    "date": "2021-11-22",
    "findings": "https://github.com/code-423n4/2021-09-sushitrident-findings/issues",
    "contest": 29
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code 423n4 (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the code contest outlined in this document, C4 conducted an analysis of Sushi Trident smart contract system written in Solidity. The code contest took place between September 16—September 29 2021.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>18 Wardens contributed reports to the Sushi Trident code contest (phase 1):</p>\n<ol>\n<li>broccoli (<a href=\"https://github.com/x9453\">shw</a> and <a href=\"https://twitter.com/jonah1005w\">jonah1005</a>)</li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li><a href=\"https://github.com/0xsanson\">0xsanson</a></li>\n<li>GreyArt (<a href=\"https://twitter.com/HickupH\">hickuphh3</a> and <a href=\"https://twitter.com/itsmeSTYJ\">itsmeSTYJ</a>)</li>\n<li><a href=\"https://twitter.com/0xRajeev\">0xRajeev</a></li>\n<li><a href=\"https://twitter.com/hack3r_0m\">hack3r-0m</a></li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li><a href=\"https://twitter.com/_hrkrshnn\">hrkrshnn</a></li>\n<li><a href=\"https://twitter.com/gallodasballo\">GalloDaSballo</a></li>\n<li><a href=\"https://twitter.com/gpersoon\">gpersoon</a></li>\n<li><a href=\"https://twitter.com/MukeshJ_eth\">JMukesh</a></li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"http://twitter.com/_nikitastupin\">nikitastupin</a></li>\n<li><a href=\"https://twitter.com/transmissions11\">t11s</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/alcueca\">Alberto Cuesta Cañada</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/money_lego\">moneylegobatman</a> and <a href=\"https://twitter.com/CloudEllie1\">CloudEllie</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 65 unique vulnerabilities and 110 total findings. All of the issues presented here are linked back to their original findings</p>\n<p>Of these vulnerabilities, 16 received a risk rating in the category of HIGH severity, 10 received a risk rating in the category of MEDIUM severity, and 39 received a risk rating in the category of LOW severity.</p>\n<p>C4 analysis also identified 20 non-critical recommendations and 25 gas optimizations.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2021-09-sushitrident\">C4 Sushi Trident contest repository</a>, and is composed of 58 smart contracts written in the Solidity programming language and includes 5,556 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-16\" style=\"position:relative;\"><a href=\"#high-risk-findings-16\" aria-label=\"high risk findings 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (16)</h1>\n<h2 id=\"h-01-flash-swap-call-back-prior-to-transferring-tokens-in-indexpool\" style=\"position:relative;\"><a href=\"#h-01-flash-swap-call-back-prior-to-transferring-tokens-in-indexpool\" aria-label=\"h 01 flash swap call back prior to transferring tokens in indexpool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/26\">[H-01] Flash swap call back prior to transferring tokens in <code>indexPool</code></a></h2>\n<p><em>Submitted by broccoli, also found by 0xsanson and cmichel</em></p>\n<h4 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>In the <code>IndexPool</code> contract, <code>flashSwap</code> does not work.\nThe callback function is called prior to token transfer. The sender won’t receive tokens in the callBack function.\n<code>ITridentCallee(msg.sender).tridentSwapCallback(context);</code></p>\n<p><code>Flashswap</code> is not implemented correctly. It may need a migration to redeploy all <code>indexPools</code> if the issue is found after main-net launch.\nI consider this a high-risk issue.</p>\n<h4 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/IndexPool.sol#L196-L223\">IndexPool.sol#L196-L223</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">ITridentCallee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">).</span><span class=\"mtk11\">tridentSwapCallback</span><span class=\"mtk1\">(</span><span class=\"mtk12\">context</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// @dev Check Trident router has sent `amountIn` for skim into pool.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { </span><span class=\"mtk3\">// @dev This is safe from under/overflow - only logged amounts handled.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_balance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenIn</span><span class=\"mtk1\">) &gt;= </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">inRecord</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;NOT_RECEIVED&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">inRecord</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reserve</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">uint120</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">outRecord</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reserve</span><span class=\"mtk1\"> -= </span><span class=\"mtk11\">uint120</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">unwrapBento</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h4 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">unwrapBento</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">ITridentCallee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">).</span><span class=\"mtk11\">tridentSwapCallback</span><span class=\"mtk1\">(</span><span class=\"mtk12\">context</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// @dev Check Trident router has sent `amountIn` for skim into pool.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { </span><span class=\"mtk3\">// @dev This is safe from under/overflow - only logged amounts handled.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_balance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenIn</span><span class=\"mtk1\">) &gt;= </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">inRecord</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;NOT_RECEIVED&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">inRecord</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reserve</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">uint120</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">outRecord</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reserve</span><span class=\"mtk1\"> -= </span><span class=\"mtk11\">uint120</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/26#issuecomment-952521402\">maxsam4 (Sushi) commented</a>:</strong></p>\n<blockquote>\n<p>Duplicate of\n<a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/157\">https://github.com/code-423n4/2021-09-sushitrident-findings/issues/157</a>\nand\n<a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/80\">https://github.com/code-423n4/2021-09-sushitrident-findings/issues/80</a></p>\n</blockquote>\n<h2 id=\"h-02-index-pool-always-swap-to-zero\" style=\"position:relative;\"><a href=\"#h-02-index-pool-always-swap-to-zero\" aria-label=\"h 02 index pool always swap to zero permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/27\">[H-02] Index Pool always swap to Zero</a></h2>\n<p><em>Submitted by broccoli, also found by 0xsanson, cmichel, and WatchPug</em></p>\n<h4 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>When an Index pool is initiated with two tokens A: B and the weight rate = 1:2, then no user can buy token A with token B.</p>\n<p>The root cause is the error in pow. It seems like the dev tries to implement <a href=\"https://en.wikipedia.org/wiki/Exponentiation_by_squaring\">Exponentiation by squaring</a>.\n<a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/IndexPool.sol#L286-L291\">IndexPool.sol#L286-L291</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_pow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">n</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">output</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">n</span><span class=\"mtk1\"> % </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">n</span><span class=\"mtk1\"> /= </span><span class=\"mtk7\">2</span><span class=\"mtk1\">; </span><span class=\"mtk12\">n</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">n</span><span class=\"mtk1\"> /= </span><span class=\"mtk7\">2</span><span class=\"mtk1\">) </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">a</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">n</span><span class=\"mtk1\"> % </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">output</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">output</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">a</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>There’s no bracket for <code>for</code>.</p>\n<p>The <code>IndexPool</code> is not functional. I consider this is a high-risk issue.</p>\n<h4 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>When we initiated the pool with 2:1.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"python\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">deployed_code = encode_abi([</span><span class=\"mtk8\">&quot;address[]&quot;</span><span class=\"mtk1\">,</span><span class=\"mtk8\">&quot;uint136[]&quot;</span><span class=\"mtk1\">,</span><span class=\"mtk8\">&quot;uint256&quot;</span><span class=\"mtk1\">], [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (link.address, dai.address),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk7\">2</span><span class=\"mtk1\">*</span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">18</span><span class=\"mtk1\">,  </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">18</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">])</span></span></span></code></pre>\n<p>No one can buy dai with link.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"python\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># (address tokenIn, address tokenOut, address recipient, bool unwrapBento, uint256 amountIn)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">previous_balance = bento.functions.balanceOf(dai.address, admin).call()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">swap_amount =  </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bento.functions.transfer(link.address, admin, pool.address, swap_amount).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">pool.functions.swap(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    encode_abi(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        [</span><span class=\"mtk8\">&#39;address&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;address&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;address&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;bool&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;uint256&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        [link.address, dai.address, admin, </span><span class=\"mtk4\">False</span><span class=\"mtk1\">, swap_amount]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">current_balance = bento.functions.balanceOf(dai.address, admin).call()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">token_received = current_balance - previous_balance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># always = 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">print</span><span class=\"mtk1\">(token_received)</span></span></span></code></pre>\n<h4 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>The brackets of <code>for</code> were missed.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_pow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">n</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">output</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">n</span><span class=\"mtk1\"> % </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">n</span><span class=\"mtk1\"> /= </span><span class=\"mtk7\">2</span><span class=\"mtk1\">; </span><span class=\"mtk12\">n</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">n</span><span class=\"mtk1\"> /= </span><span class=\"mtk7\">2</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">a</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">n</span><span class=\"mtk1\"> % </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">output</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">output</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">a</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 id=\"h-03-indexpool-pow-overflows-when-weightratio--10\" style=\"position:relative;\"><a href=\"#h-03-indexpool-pow-overflows-when-weightratio--10\" aria-label=\"h 03 indexpool pow overflows when weightratio  10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/28\">[H-03] <code>IndexPool</code> pow overflows when <code>weightRatio</code> > 10.</a></h2>\n<p><em>Submitted by broccoli</em></p>\n<h4 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>In the <code>IndexPool</code> contract, pow is used in calculating price. (<a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/IndexPool.sol#L255-L266\"><code>IndexPool.sol</code> L255-L266</a>).\nHowever, Pow is easy to cause overflow. If the <code>weightRatio</code> is large (e.g. 10), there’s always overflow.</p>\n<p>Lp providers can still provide liquidity to the pool where no one can swap. All pools need to redeploy. I consider this a high-risk issue.</p>\n<h4 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of concept</h4>\n<p>It’s easy to trigger this bug by deploying a 1:10 <code>IndexPool</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"python\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">deployed_code = encode_abi([</span><span class=\"mtk8\">&quot;address[]&quot;</span><span class=\"mtk1\">,</span><span class=\"mtk8\">&quot;uint136[]&quot;</span><span class=\"mtk1\">,</span><span class=\"mtk8\">&quot;uint256&quot;</span><span class=\"mtk1\">], [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (link.address, dai.address),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">18</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">18</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">tx_hash = master_deployer.functions.deployPool(index_pool_factory.address, deployed_code).transact()</span></span></span></code></pre>\n<p>Transactions would be reverted when buying <code>link</code> with <code>dai</code>.</p>\n<h4 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>The <code>weightRatio</code> is an 18 decimals number. It should be divided by <code>(BASE)^exp</code>. The scale in the contract is not consistent. Recommend the dev to check all the scales/ decimals.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/28\">maxsam4 (Sushi) confirmed</a></strong></p>\n<h2 id=\"h-04-indexpools-init_pool_supply-is-not-fair\" style=\"position:relative;\"><a href=\"#h-04-indexpools-init_pool_supply-is-not-fair\" aria-label=\"h 04 indexpools init_pool_supply is not fair permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/29\">[H-04] IndexPool’s <code>INIT_POOL_SUPPLY</code> is not fair.</a></h2>\n<p><em>Submitted by broccoli, also found by WatchPug</em></p>\n<h4 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The <code>indexPool</code> mint <code>INIT_POOL_SUPPLY</code> to address 0 in the constructor. However, the value of the burned lp is decided by the first lp provider. According to the formula in <a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/IndexPool.sol#L106\"><code>IndexPool.sol</code> L106</a>.</p>\n<p><code>AmountIn = first_lp_amount / INIT_POOL_SUPPLY</code> and the burned lp worth = <code>AmountIn * (INIT_POOL_SUPPLY) / (first_lp_amount + INIT_POOL_SUPPLY)</code>.\nIf a pool is not initialized with optimal parameters, it would be a great number of tokens been burn. All lp providers in the pool would receive less profit.</p>\n<p>The optimal parameter is <code>10**8</code>. It’s likely no one would initialize with <code>10**8</code> wei in most pools. I consider this is a high-risk issue.</p>\n<h4 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of concept</h4>\n<p>There are two scenarios that the first lp provider can do. The lp provider provides the same amount of token in both cases. However, in the first scenario, he gets about <code>10 ** 18 * 10**18</code> lp while in the other scenario he gets <code>100 * 10**18</code> lp.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"python\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">deposit_amount = </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bento.functions.transfer(link.address, admin, pool.address, deposit_amount).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bento.functions.transfer(dai.address, admin, pool.address, deposit_amount).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">pool.functions.mint(encode_abi(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    [</span><span class=\"mtk8\">&#39;address&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;uint256&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    [admin, </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">8</span><span class=\"mtk1\">] </span><span class=\"mtk3\"># minimum</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">pool.functions.mint(encode_abi(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    [</span><span class=\"mtk8\">&#39;address&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;uint256&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    [admin, </span><span class=\"mtk7\">10000000000009999</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10</span><span class=\"mtk1\">** </span><span class=\"mtk7\">20</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)).transact()</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"python\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">deposit_amount = </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bento.functions.transfer(link.address, admin, pool.address, deposit_amount).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">bento.functions.transfer(dai.address, admin, pool.address, deposit_amount).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">pool.functions.mint(encode_abi(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    [</span><span class=\"mtk8\">&#39;address&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;uint256&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    [admin, deposit_amount * </span><span class=\"mtk7\">100</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)).transact()</span></span></span></code></pre>\n<h4 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Recommend to handle <code>INIT_POOL_SUPPLY</code> in uniswap-v2’s way. Determine an optimized parameter for the user would be a better UX design.</p>\n<h2 id=\"h-05-hybrid-pool-uses-wrong-non_optimal_mint_fee\" style=\"position:relative;\"><a href=\"#h-05-hybrid-pool-uses-wrong-non_optimal_mint_fee\" aria-label=\"h 05 hybrid pool uses wrong non_optimal_mint_fee permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/31\">[H-05] hybrid pool uses wrong <code>non_optimal_mint_fee</code></a></h2>\n<p><em>Submitted by broccoli</em></p>\n<h4 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>When an lp provider deposits an imbalance amount of token, a swap fee is applied. <code>HybridPool</code> uses the same <code>_nonOptimalMintFee</code> as <code>constantProductPool</code>; however, since two pools use different AMM curve, the ideal balance is not the same.  ref: <a href=\"https://github.com/curvefi/curve-contract/blob/master/contracts/pools/3pool/StableSwap3Pool.vy#L322-L337\"><code>StableSwap3Pool.vy</code> L322-L337</a></p>\n<p>Stable swap Pools are designed for 1B+ TVL. Any issue related to pricing/fee is serious. I consider this is a high-risk issue</p>\n<h4 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li><a href=\"https://github.com/curvefi/curve-contract/blob/master/contracts/pools/3pool/StableSwap3Pool.vy#L322-L337\">StableSwap3Pool.vy#L322-L337</a></li>\n<li><a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/HybridPool.sol#L425-L441\">HybridPool.sol#L425-L441</a></li>\n</ul>\n<h4 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Calculate the swapping fee based on the stable swap curve. refer to <a href=\"https://github.com/curvefi/curve-contract/blob/master/contracts/pools/3pool/StableSwap3Pool.vy#L322-L337\">StableSwap3Pool.vy#L322-L337</a>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/31\">maxsam4 (Sushi) confirmed</a></strong></p>\n<h2 id=\"h-06-indexpool--poor-conversion-from-balancer-v1s-corresponding-functions\" style=\"position:relative;\"><a href=\"#h-06-indexpool--poor-conversion-from-balancer-v1s-corresponding-functions\" aria-label=\"h 06 indexpool  poor conversion from balancer v1s corresponding functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/40\">[H-06] <code>IndexPool</code>:  Poor conversion from Balancer V1’s corresponding functions</a></h2>\n<p><em>Submitted by GreyArt</em></p>\n<h5 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h5>\n<p>A number of functions suffer from the erroneous conversion of Balancer V1’s implementation.</p>\n<ul>\n<li>\n<p><code>_compute()</code> (equivalent to Balancer’s <a href=\"https://github.com/balancer-labs/balancer-core/blob/master/contracts/BNum.sol#L108-L126\"><code>bpow()</code></a>)</p>\n<ul>\n<li><code>if (remain == 0) output = wholePow;</code> when a return statement should be used instead.</li>\n</ul>\n</li>\n<li>\n<p><code>_computeSingleOutGivenPoolIn()</code> (equivalent to Balancer’s <a href=\"https://github.com/balancer-labs/balancer-core/blob/master/contracts/BMath.sol#L195-L224\"><code>_calcSingleOutGivenPoolIn()</code></a>)</p>\n<ul>\n<li><code>tokenOutRatio</code> should be calculated with <code>_compute()</code> instead of <code>_pow()</code></li>\n<li><code>zaz</code> should be calculated with <code>_mul()</code> instead of the native <code>*</code></li>\n</ul>\n</li>\n<li>\n<p><code>_pow()</code> (equivalent to Balancer’s <a href=\"https://github.com/balancer-labs/balancer-core/blob/master/contracts/BNum.sol#L89-L103\"><code>bpowi()</code></a>)</p>\n<ul>\n<li>Missing brackets <code>{}</code> for the for loop causes a different interpretation</li>\n<li><code>_mul</code> should be used instead of the native <code>*</code></li>\n</ul>\n</li>\n</ul>\n<h5 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h5>\n<p>The fixed implementation is provided below.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_computeSingleOutGivenPoolIn</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenOutBalance</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenOutWeight</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalWeight</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">toBurn</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_swapFee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">normalizedWeight</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenOutWeight</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_totalWeight</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newPoolSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">toBurn</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newPoolSupply</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenOutRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_compute</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolRatio</span><span class=\"mtk1\">, </span><span class=\"mtk11\">_div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BASE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">normalizedWeight</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newBalanceOut</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenOutRatio</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenOutBalance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAmountOutBeforeSwapFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">tokenOutBalance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">newBalanceOut</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">zaz</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">normalizedWeight</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_swapFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAmountOutBeforeSwapFee</span><span class=\"mtk1\">, (</span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">zaz</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_compute</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">base</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">exp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MIN_POW_BASE</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">base</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">base</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">MAX_POW_BASE</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;INVALID_BASE&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">whole</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">exp</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">remain</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">exp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">whole</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wholePow</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_pow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">base</span><span class=\"mtk1\">, </span><span class=\"mtk12\">whole</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">remain</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wholePow</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">partialResult</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_powApprox</span><span class=\"mtk1\">(</span><span class=\"mtk12\">base</span><span class=\"mtk1\">, </span><span class=\"mtk12\">remain</span><span class=\"mtk1\">, </span><span class=\"mtk12\">POW_PRECISION</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">output</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wholePow</span><span class=\"mtk1\">, </span><span class=\"mtk12\">partialResult</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_pow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">n</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">output</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">output</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">n</span><span class=\"mtk1\"> % </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">n</span><span class=\"mtk1\"> /= </span><span class=\"mtk7\">2</span><span class=\"mtk1\">; </span><span class=\"mtk12\">n</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">n</span><span class=\"mtk1\"> /= </span><span class=\"mtk7\">2</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">a</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">a</span><span class=\"mtk1\">, </span><span class=\"mtk12\">a</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">n</span><span class=\"mtk1\"> % </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">output</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">output</span><span class=\"mtk1\">, </span><span class=\"mtk12\">a</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/40\">maxsam4 (Sushi) acknowledged</a></strong></p>\n<h2 id=\"h-07-indexpoolmint-the-first-liquidity-provider-is-forced-to-supply-assets-in-the-same-amount-which-may-cause-a-significant-amount-of-fund-loss\" style=\"position:relative;\"><a href=\"#h-07-indexpoolmint-the-first-liquidity-provider-is-forced-to-supply-assets-in-the-same-amount-which-may-cause-a-significant-amount-of-fund-loss\" aria-label=\"h 07 indexpoolmint the first liquidity provider is forced to supply assets in the same amount which may cause a significant amount of fund loss permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/72\">[H-07] <code>IndexPool.mint</code> The first liquidity provider is forced to supply assets in the same amount, which may cause a significant amount of fund loss</a></h2>\n<p><em>Submitted by WatchPug, also found by broccoli</em></p>\n<p>When <code>reserve == 0</code>, <code>amountIn</code> for all the tokens will be set to the same amount: <code>ratio</code>, regardless of the weights, decimals and market prices of the assets.</p>\n<p>The first liquidity provider may not be aware of this so that it may create an arbitrage opportunity for flashbots to take a significant portion of the value of The first liquidity provider’s liquidity.</p>\n<p><a href=\"https://github.com/sushiswap/trident/blob/6bd4c053b6213ffc612987eb565aa3813d5f0d13/contracts/pool/IndexPool.sol#L93-L105\"><code>IndexPool.sol#L93</code> L105</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @dev Mints LP tokens - should be called via the router after transferring `bento` tokens.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// The router must ensure that sufficient LP tokens are minted by using the return value.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">lock</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">toMint</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">data</span><span class=\"mtk1\">, (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint120</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ratio</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint120</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">toMint</span><span class=\"mtk1\">, </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenIn</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint120</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reserve</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">records</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenIn</span><span class=\"mtk1\">].</span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// @dev If token balance is &#39;0&#39;, initialize with `ratio`.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint120</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">reserve</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk11\">uint120</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ratio</span><span class=\"mtk1\">, </span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">)) : </span><span class=\"mtk12\">ratio</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">MIN_BALANCE</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;MIN_BALANCE&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// @dev Check Trident router has sent `amountIn` for skim into pool.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// @dev This is safe from overflow - only logged amounts handled.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_balance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenIn</span><span class=\"mtk1\">) &gt;= </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">reserve</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;NOT_RECEIVED&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">records</span><span class=\"mtk1\">[</span><span class=\"mtk12\">tokenIn</span><span class=\"mtk1\">].</span><span class=\"mtk12\">reserve</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenIn</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">toMint</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">liquidity</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">toMint</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h5 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h5>\n<p>Given:</p>\n<ul>\n<li>A <code>IndexPool</code> of 99% USDT and 1% WBTC;</li>\n<li>Alice is the first liquidity provider.</li>\n<li>Alice transfers 1e18 WBTC and 1e18 USDT to mint 100e18 of liquidity;</li>\n<li>Bob can use 100e18 USDT (~$100) to swap out most of the balance of WBTC.</li>\n</ul>\n<h5 id=\"impact-6\" style=\"position:relative;\"><a href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h5>\n<p>A significant portion (>90% in the case above) of the user’s funds can be lost due to arbitrage.</p>\n<h5 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h5>\n<p>Consider allowing the first liquidity provider to use custom <code>amountIn</code> values for each token or always takes the MIN_BALANCE of each token.</p>\n<h2 id=\"h-08-hybridpools-reserve-is-converted-to-amount-twice\" style=\"position:relative;\"><a href=\"#h-08-hybridpools-reserve-is-converted-to-amount-twice\" aria-label=\"h 08 hybridpools reserve is converted to amount twice permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/101\">[H-08] <code>HybridPool</code>’s reserve is converted to “amount” twice</a></h2>\n<p><em>Submitted by cmichel, also found by 0xsanson and WatchPug</em></p>\n<p>The <code>HybridPool</code>’s reserves are stored as Bento “amounts” (not Bento shares) in <code>_updateReserves</code> because <code>_balance()</code> converts the current share balance to amount balances.\nHowever, when retrieving the <code>reserve0/1</code> storage fields in <code>_getReserves</code>, they are converted to amounts a second time.</p>\n<h4 id=\"impact-7\" style=\"position:relative;\"><a href=\"#impact-7\" aria-label=\"impact 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The <code>HybridPool</code> returns wrong reserves which affects all minting/burning and swap functions.\nThey all return wrong results making the pool eventually economically exploitable or leading to users receiving less tokens than they should.</p>\n<h4 id=\"poc\" style=\"position:relative;\"><a href=\"#poc\" aria-label=\"poc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h4>\n<p>Imagine the current Bento amount / share price being <code>1.5</code>.\nThe pool’s Bento <em>share</em> balance being <code>1000</code>.\n<code>_updateReserves</code> will store a reserve of <code>1.5 * 1000 = 1500</code>.\nWhen anyone trades using the <code>swap</code> function, <code>_getReserves()</code> is called and multiplies it by <code>1.5</code> again, leading to using a reserve of 2250 instead of 1500.\nA higher reserve for the output token leads to receiving more tokens as the swap output.\nThus the pool lost tokens and the LPs suffer this loss.</p>\n<h4 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Make sure that the reserves are in the correct amounts.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/101\">maxsam4 (Sushi) confirmed</a></strong></p>\n<h2 id=\"h-09-unsafe-cast-in-indexpool-mint-leads-to-attack\" style=\"position:relative;\"><a href=\"#h-09-unsafe-cast-in-indexpool-mint-leads-to-attack\" aria-label=\"h 09 unsafe cast in indexpool mint leads to attack permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/77\">[H-09] Unsafe cast in <code>IndexPool</code> mint leads to attack</a></h2>\n<p><em>Submitted by cmichel, also found by cmichel and pauliax</em></p>\n<p>The <code>IndexPool.mint</code> function performs an unsafe cast of <code>ratio</code> to the <code>uint120</code> type:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint120</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ratio</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint120</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">toMint</span><span class=\"mtk1\">, </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p>Note that <code>toMint</code> is chosen by the caller and when choosing <code>toMint = 2**120 * totalSupply / BASE</code>, the <code>ratio</code> variable will be <code>2**120</code> and then truncated to 0 due to the cast.</p>\n<p>This allows an attacker to mint LP tokens for free.\nThey just need to choose the <code>ratio</code> such that the <code>amountIn = ratio * reserve / BASE</code> variable passes the <code>require(amountIn >= MIN_BALANCE, \"MIN_BALANCE\");</code> check.\nFor example, when choosing <code>ratio = 2**120 * totalSupply / BASE + 1e16</code>, an attacker has to pay 1/100th of the current reserves but heavily inflates the LP token supply.</p>\n<p>They can then use the inflated LP tokens they received in <code>burn</code> to withdraw the entire pool reserves.</p>\n<h4 id=\"poc-1\" style=\"position:relative;\"><a href=\"#poc-1\" aria-label=\"poc 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h4>\n<p>I created <a href=\"https://gist.github.com/MrToph/0c8b6b5ffac0673b2f72412cf4b0b099\">this POC</a> that implements a hardhat test and shows how to steal the pool tokens:</p>\n<h4 id=\"impact-8\" style=\"position:relative;\"><a href=\"#impact-8\" aria-label=\"impact 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>An attacker can inflate the LP token pool supply and mint themselves a lot of LP tokens by providing almost no tokens themselves.\nThe entire pool tokens can be stolen.</p>\n<h4 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Even though Solidity 0.8.x is used, type casts do not throw an error.\nA <a href=\"https://docs.openzeppelin.com/contracts/4.x/api/utils#SafeCast\"><code>SafeCast</code> library</a> must be used everywhere a typecast is done.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/126\">maxsam4 (Sushi) confirmed</a></strong></p>\n<h2 id=\"h-10-indexpool-initial-lp-supply-computation-is-wrong\" style=\"position:relative;\"><a href=\"#h-10-indexpool-initial-lp-supply-computation-is-wrong\" aria-label=\"h 10 indexpool initial lp supply computation is wrong permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/78\">[H-10] <code>IndexPool</code> initial LP supply computation is wrong</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>IndexPool.constructor</code> function already mints <code>INIT_POOL_SUPPLY = 100 * 1e18 = 1e20</code> LP tokens to the zero address.</p>\n<p>When trying to use the pool, someone has to provide the actual initial reserve tokens in <code>mint</code>.\nOn the first <code>mint</code>, the pool reserves are zero and the token amount required to mint is just this <code>ratio</code> itself: <code>uint120 amountIn = reserve != 0 ? uint120(_mul(ratio, reserve)) : ratio;</code></p>\n<p>Note that the <code>amountIn</code> is <strong>independent of the token</strong> which does not make much sense.\nThis implies that all tokens must be provided in equal “raw amounts”, regardless of their decimals and value.</p>\n<h4 id=\"poc-2\" style=\"position:relative;\"><a href=\"#poc-2\" aria-label=\"poc 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h4>\n<h6 id=\"issue-1\" style=\"position:relative;\"><a href=\"#issue-1\" aria-label=\"issue 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Issue 1</h6>\n<p>Imagine I want to create a DAI/WBTC pool.\nIf I want to initialize the pool with 100$ of DAI, <code>amountIn = ratio</code> needs to be <code>100*1e18=1e20</code> as DAI has 18 decimals.\nHowever, I now also need to supply <code>1e20</code> of WBTC (which has 8 decimals) and I’d need to pay <code>1e20/1e8 * priceOfBTC</code>, over a quadrillion dollars to match it with the 100$ of DAI.</p>\n<h6 id=\"issue-2\" style=\"position:relative;\"><a href=\"#issue-2\" aria-label=\"issue 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Issue 2</h6>\n<p>Even in a pool where all tokens have the same decimals and the same value, like <code>USDC &#x3C;> USDT</code>, it leads to issues:</p>\n<ul>\n<li>Initial minter calls <code>mint</code> with <code>toMint = 1e20</code> which sets <code>ratio = 1e20 * 1e18 / 1e20 = 1e18</code> and thus <code>amountIn = 1e18</code> as well. The total supply increases to <code>2e20</code>.</li>\n<li>Second minter needs to pay <strong>less</strong> tokens to receive the same amount of <code>1e18</code> LP tokens as the first minter. This should never be the case. <code>toMint = 1e20</code> => <code>ratio = 1e20 * 1e18 / 2e20 = 0.5e18</code>. Then <code>amountIn = ratio * reserve / 1e18 = 0.5*reserve = 0.5e18</code>. They only pay half of what the first LP provider had to pay.</li>\n</ul>\n<h4 id=\"impact-9\" style=\"position:relative;\"><a href=\"#impact-9\" aria-label=\"impact 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>It’s unclear why it’s assumed that the pool’s tokens are all in equal value - this is <em>not</em> a StableSwap-like pool.</p>\n<p>Any pool that uses tokens that don’t have the same value and share the same decimals cannot be used because initial liquidity cannot be provided in an economically justifiable way.</p>\n<p>It also leads to issues where the second LP supplier has to pay <strong>less tokens</strong> to receive the exact same amount of LP tokens that the initial minter receives. They can steal from the initial LP provider by burning these tokens again.</p>\n<h4 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Do not mint the initial token supply to the zero address in the constructor.</p>\n<p>Do it like Uniswap/Balancer and let the first liquidity provider provide arbitrary token amounts, then mint the initial pool supply.\nIf <code>reserve == 0</code>, <code>amountIn</code> should just take the pool balances that were transferred to this account.</p>\n<p>In case the initial mint to the zero address in the constructor was done to prevent the “Uniswap-attack” where the price of a single wei of LP token can be very high and price out LPs, send a small fraction of this initial LP supply (~1000) to the zero address <strong>after</strong> it was minted to the first supplier in <code>mint</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/78\">maxsam4 (Sushi) confirmed</a></p>\n<h2 id=\"h-11-constantproductpoolburnsingle-swap-amount-computations-should-use-balance\" style=\"position:relative;\"><a href=\"#h-11-constantproductpoolburnsingle-swap-amount-computations-should-use-balance\" aria-label=\"h 11 constantproductpoolburnsingle swap amount computations should use balance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/96\">[H-11] <code>ConstantProductPool.burnSingle</code> swap amount computations should use balance</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>ConstantProductPool.burnSingle</code> function is basically a <code>burn</code> followed by a <code>swap</code> and must therefore act the same way as calling these two functions sequentially.</p>\n<p>The token amounts to redeem (<code>amount0</code>, <code>amount1</code>) are computed on the <strong>balance</strong> (not the reserve).\nHowever, the swap amount is then computed on the <strong>reserves</strong> and not the balance.\nThe <code>burn</code> function would have updated the <code>reserve</code> to the balances and therefore <code>balance</code> should be used here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">amount1</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">_getAmountOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_reserve0</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amount0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_reserve1</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amount1</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<blockquote>\n<p>⚠️ The same issue occurs in the <code>HybridPool.burnSingle</code>.</p>\n</blockquote>\n<h4 id=\"impact-10\" style=\"position:relative;\"><a href=\"#impact-10\" aria-label=\"impact 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>For a burn, usually the <code>reserve</code> should equal the <code>balance</code>, however if any new tokens are sent to the contract and <code>balance > reserve</code>, this function will return slightly less swap amounts.</p>\n<h4 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Call <code>_getAmountOut</code> with the balances instead of the reserves: <code>_getAmountOut(amount0, balance0 - amount0, balance1 - amount1)</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/96#issuecomment-947608322\">maxsam4 (Sushi) confirmed</a>:</strong></p>\n<blockquote>\n<p>Please bump this to High sev. This bug can actually lead to loss of funds from the pool. The author found the right issue but failed to analyze the full impact. Regardless, I think they deserve “High” for pointing this out.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/96#issuecomment-950561090\">alcueca (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This is what we come to C4 for <img class=\"emoji-icon\" alt=\"emoji-clap\" data-icon=\"emoji-clap\" style=\"display: inline; margin: 0; margin-top: 1px; position: relative; top: 5px; width: 25px\" src=\"data:image/png;base64, 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\" title=\"emoji-clap\" /> <img class=\"emoji-icon\" alt=\"emoji-clap\" data-icon=\"emoji-clap\" style=\"display: inline; margin: 0; margin-top: 1px; position: relative; top: 5px; width: 25px\" src=\"data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAbjUlEQVR42uWbCTSXad/Hr3mmmfZFFGMppU2WSGQtshNaRItsoaJCUpREFIUk2RXKXspSKlLapBJJm9Ji+Vua7Zn3mXdmmia/93fdXZ6/QyVOc877vO9zzveI/zXc1+f+/rbrvh8CAP+v9ckPE5TIsAJTko46/7E1uSZEhK77PwfgtDGRumhBrt5aRqBsEfmt0IBM+tC6AhOyq9CUPC00ISGnjIgawvjmPx5AvhExvLKYNL2wJdDmSODRKgK4UfePANhcYUngwUoCt60IoFse5JsQt/9YAKeNiDbeUahdQeAHJwK/riXQ4kDg0iJygxDy1QfWr6Gbb8U1T20InDcjnQjF6O+86BRtMiRAmwz60Gd5pmTyKRMybcAAcrXJiDxj4nF1KfnnS3TAz84EXq8hcNeKvMU7K9dzfZousalDWI1276Fl6pO1f8emc9XIUIStiw6LRZUWaJCRH3FkBIbja/yqPyAA+L9/oAQ2yBFjdMLdx2j/Jvv3Fkcwu3uujZ5HrG9iCFSh/VN0yRH8mQhq6BfZOLujuJm4EgtSX23NwsyEPMkl5Oueaw8Zk8El5uTxveW4bhl5w8K2bwCntcmYPEPyHdvUtyhhlLTAIKIRpUWO4gbf0g0Wm5EH3a1H8CL2aRDzooUEMgxIxXBCFPBnEqjhX+zOLyBieMdf3LV+H4rP0ZVlFqTyQ2txnQ51Ycea97mrBkGgG44W6BLhTwLINyaW9I9Qi9FNocaipFAKKNUNsmTdKWNST3NDgTHR6A4gRI0YncTPNIWJHoXG4H3RSoBhJn/DkvyIYYYAuDxzmbqv57ozpiSeJu5/Yd76pwuBJ+jes2YEMHR9PgqAkYummRzv9J+4QS/qAgZBEiWLmi0vSOZmG5JcBBHHJUMWAuvlv1G1njbYGP89HSVGCL8ncNUQ0/E1lsnwN5+V7q03delANs9CckyYGlmDJfkvam9McmfwZ4O7r0s3JqOuLSHN1CU/YvJ+hbDw+5+z9Yk7DY1PAjhnRmppqWtYTQD/CLVNdpIudydHokRRU9kGxfHnWgEy5NtlMuNGeOpMi9m3QrM+yFrzxlrNKdsmjCYCXb/YWVlMYffSOb8XR2yAq8l+cCpoDQQvVTnrOk9Uop8ABqHGo6Yf1CLR580x3PRJbnfQVKcMiQUNE+oA3Avdw23nGWQhc+S3nwSA1uaSy32MH+oE+j264s5JfW7jQ1BCKDGW4EYAAFkzd4J/rKM2FO5aBYX+KyF9szkELlK8uE5NXIx+vl5VzC7ZzQTu5+2HxopUeHrlCFxP8YdDjrr1m7QlZPsB4CuUAGoKSjFDj5RTAD0TLYZxFr32G0vJ20gtkjQU8xeukUOJ82H1FqHxigksIV6bhB7QIN4HNYltsg7RzdUnCkHzRk310pns6WUw3c9GWVSdOoIB+cpBWSwh0lIBzvlZwp1Yd7gc6ghZ7iYQbC770Gb2uCnLFUQk4x3n/Vl9PABabqRCc00mvLiZBney9kKci2FzPyF8y1wwTU+UaIarEjt6HV2f0ySHN+zNSSPyxE2eOOFncyksBk3oUzmJsA1JsFifxewuLISb9TGRK831Xw3nIt0h1cvyzx0mchGO04UohH8slha0jbVVh/qTofD6Tga04l2uywiAk15m4LNA6pmqyBDJ7QbTEi7uc4aGs1HQhmua72XCy8pjUJUdArFOes83qktI9QPCEGZnCQqju63zsBnLNSDZikJkDkvcsix/jeWv+ziAwajvKF3UTEZNdIWCiOvRjQuh9lQEvMA7+OhCHJRGe0H4CvWKZTICE/QkR6kmO2nDYwRAN9dWlwNt1ZnwrOggFO2wAjdVsXsKIsNMEtdoN9xN2QFNZQnQejcTIWRxEG5nBsNhxwVPBgBhNGpE9ypwSJ1IsfCcwiTKuZWt6QvAV2yxECXMvgqsUhT2Sdu0EJ7kR+CFZ0ATtfD1FKhI3g4Ry5UbjCeNNAs2k3l0O84DWi4nQVtNFrTUZkMrfn1ZGgule+zBcY7o3YXTBbcW+C37+WHOXmi5kozrMvF3ZXAQbqUjhDW6j9zUJ03s60LdlCfIeOlM8dygKanNNtYTzDh2IwW7hwdti7Eh8qWd5AcBdK/p3TR4wcTRs3dbKPx3RZwXtJQnv98g3r1Xl5Ph2kFX2L5gSoutwrgT+ZuN3zw9sQfa0SVttdkIIQt4uLbpUiKUh68FeyXxKhsViejyMKff60+HA+/6UQqJQuByQhU6Id5Fr3rLPMmArfozUr20pRb1vEhXrCghK9V+OBHoAGney8DXWC7RXpIM6VEphqOGEtYhZpgSgXxT4n/BnPxE80OuIRn7IQCfqr1jLeXHh6W5GcH9rGDuwtsRQPsdjOMzB6HYdxG4KX/3s6/e5GeVYWveNRYfhHbcUCtCoDZvqUG74x2/fmgjrFGRqFqrNSW9Msb9r+f43/IQViuuacQ1jbePw/3cEDi5eSHk+S6DDJ/l4GM0M6H7XfYxlC4qO7wZ6ssS4VFJLJyL2Ah+C+UyqHs/eIZhTJyxJX5at4I2Q1xle3PKgMj2B8BXzErSbpqTSgoDVsHjU/uBd/UIdNw8BryLcVCb4AHH7FTAWWncb1FWs395mLy5s6XkMHTcTqcQuJBpobp2FCpjN4Pz3AlVfqbyBdVHtna+KI6GVgwBCqEZ3cDD3PC86ABc3mMDNxO8oXCvM2zTn3GYXoujopDoIfv5/1V3KgyaqxEY6im6qyjEBbwXTN3CrplfDUxIHi3j15a+7wfqbTgAgBXC8LMBaKOl5omOlWDtsEqAmdy90v0u8Cg3GO6n+EB54HK4unsFlPmawaFFM8FBfuyfRx00f3+asaOTh/FPIfAYBNwgd8dvJ3qD5wKpu/utVUvvH9vR+er8YWi9hTCpW3Dt69oceHXmAFzbuxoq470g09sS1quKmrsoic44vsm0s74okoYO55omhPDw7CE46m72q7vGpOn/nhuwQSvQJ6IZukQHe4Vt+dgxXjAjzymQbAOy8bMAuKpOMPNfNPvewTV6jXutVEuXKojZCQ0ZpLN/mdLDEx4mkG4/FyojnKHpXBSnusTNkLBKBexkx7zLXK/z9kVOYGdrWXx3J3Dlj4dlsuqIL/gaTK+Jtp9/9SGWzFcXYqAVQwCdgMCyEEIuvCyKgCvBqzCJ2kHoYoUGG4Xx+tmbTX+tLwjnqkwzrmviQucYVB4LgH1Wc8/2cO83rHGagJr53TAyx0OBLNqtTJT7BOCgKDJu58JZr0uiPKDm1AGoxAR1ercDbDOWPSg6erC+h6Z4fbSVIjzK2AXtlcehoy6X6wEaT4dAmos22MsKvMveaPTXy5NB0IY27bjTDUINhZAGd1O2g5+pzL04Z/0bD7N2w8sLsegEDgK39nVNNrwoCIOyACtIc1AHF2WR3BSnefWPc/dAG8sxTSx/vMCQLIncCDtM5fy7ARjK+oTJrB+QY6VRoE8ANvJC08OWq76pzgiCFozRV1XpUF8SB2VR7uBnIp8mNmqwqbf2pJc3o1yhGTdIK0Pr/Rx4XZ0FbeejINfdiIZDZ46Hybum03sRQkIXBA5AC12Pm6hJ84NdZgq3YlyMyusyd8MrCoGGDYNAf9/zU6FQvMUUfOeJv91tPKO1DnMMjzoL80ULg9qI5bn+YjycCV0LO0xk/LpVs5EUAnPBRNYXjOgTgJkoGbbdULrharQ7NJcnczHXTJub0gQoxY5ug8bEPCOpMX45Gwz+epSNd/lGGlf6ePff37mOizGQ720OTgpCnXleCzub8rFJuoxOqOJD4NFyihCq0/zBz0LhbLyrSUkdVplXpfHQiut4uIau7UBnPc/bC5nOWuCsIAj5m006mwr2Qzsm1Q6aV+6xUKA3CZusc+FuEGAxO9FTTXxot9I4tFt5/EefAOhCa9lxwamuBvAgew/eLbpBvOA7SLogAk56moKtglC59/yJNy9hInxB47KCg8Dsi7ocD2d3WILL7HGdp73NO1uKwhiEjC4I73UzFWqO74IQq7knU70WX36IHWVTeRK0VmfynVCFJTdvDyTaqsEGFRGoPOAMbaUx0FGRhiU5m+tLupzwDPuTy7FbYf8K9XIPVUnJAZ0JUpuM+JbMXK8+oeb0diuox9KHPT73x3jYBT44tgMSVynDanmh+lBz6Ze3IpywJ4jE+s+cgOpACN9fSYQLASvBDS+60GdJJ+8MgipPQvvyITRWY3eJ1aEWQyDaQacgd+fKCmyjMfRYZWAQvq9CWIVhkGCvCVu1JeH+ka3w+koyDQV6c/gQqtEx2KtU4MQZtkrz6dq54lMHAmAYSlJy7GDDLQumNBQH2UF9fvh7CBijNAbvHnaDQ0tkwU5esDlmuSLvXtwmaDx/CJPiMQYhCzoQ2A/XkuHSXnvYpCoKZ7ZbdvKKD0A7jsT0wltxDYPAjcoPToTAUTeTkpLw9Q9p38BjXWfzv3MCbrYkGtI3mUCIhRw8yd4NP2DibGegmhmEpnuYGK+loBO2YDMlUzgQAIPYPCAzRXCYRaCZ/IuyiPXcgNOKGbcdyb8sCocrgVawz2Qq2MsLdaTYq3U8SvWBFqz/7TSbMydwEG6kwJX9TrBZUwKK/ZdD67mDDAIOTwwCJ/zvntHuMsTxecO5qD9amb3Z5vi/ryIFbsa4Q573IniY4f8XhlVnC24a1/CFsB5jj5DkZvLbemXhyQM5FR45S3SYIh2NJwsMNg2zVmm8gknxKQ5FDadD4UrQKrjgbQLFngYQbChFIfyU42bw07OsXdCCGRmzPt8J7KKvH1gH3vMmwoXdNtyd5BJZNTqBtcxUPHQDtX/LrbTOFvyMAWDi+gTu9/54LwdaLsXDk9P7/+TdOv6WbZyJzStXj2JlcAEP7UlO/QJAj7k2604t2rdSoyNomUqZgbSwtYzwMPMYu3ktZfudoQjLUt5aLXiS7gevsFbXxG6EiCXyGA5C/8r3Mv31+UmcGbqaoG4QfkSbV0Zj/64nhQcnDtB+EbtFjP8OurGuO01B9Ph3LzE3tGHppeLRdT0B1KLw799M8YOdC+VP9guAw+zvbHA8hWt4hleRugty/Ve92bBgxq6ZoiMtIq0U20ONp0L2Wm14cSoEXuMGqBpyAuHwCmVYoyD0xznfRX/Qpqj1Es36nM05CO0UAj0DiPWAIKNpcCNyHSayJFxDExmD8AXEQWCuenA6AqLtdVpc8aZ+NgDb2cLWcWt0oCYzmBt7H5+PhZIDG2ErngTNkRi1fK3Kdz/uNpwKtw64QDMOPq9vpcNr7AibcNMJthrgojTu7cVdK942YdZuL2eZmpZI6gRqX2x7q5O8IXyxPNQc2QY/3M6Advw5AviIBgaHh3qOvUHO9uXgrCY+/7MBqAuPGL9VZ8qzklAsb+djoBknv/rSeOwEN4G3wcx4JbHhdstkBH+OWzEH7uEM0IJ2f43j8feoZkyOSY7zYP0c4XdXQuw6W4pZwqMQaDZHcU7AnqLuuB8U4OjbSksjWrm1DwD9BcINYhh2lw55Ap5cB/anCoxeMHnUiv2WSn9WxHpCE469LRXH4CnO4KVh68BjgVSSktiIdStkx/0r3UkLHqT6Au9SAtewfI9qLY6Eo8464KEhDneiXYF3oSvh0QSGohBQP9RgHGOZbK1MpQ6gAD6ugYCgFQZDsCZrD+y1UrlNu8DPBTAGNc1wisCew2jpO8nbEEI8tFzHY20sLeeC7cBda3KK+oSR22wVhN+ccNOFx+k7oZWDkEVB4ExwENLW6+GJ0WS4n+QFbV0Jr4ZunoPAhUU73nncPP2+t74AENpL1OPInepp8cZJ9TvpzwUwnJ2mKppJC8YmOmpz01szhVB+BOoLI6E4wAY85088ri05MsRZSfhdvochPMnaxdrdTG46bMdSd8zNEPaYSkM9VgxuKMJwworAIAxA/QbBL4eumhNdPxfA1yhBdkKsbCk7Pv3oOj2oOebPOYFXnswdkp4PXAUeWhMz9SaPisPTXzi7dSE8zdkNrRTCHYSAooNRurspRC5XhpeYJDto+4pwOmgY9EMDhkFbbmzRryX4AD1r7E8jNJgdMUujVJYrCOcf32AEtXiA0VyWQA9IucHoAkLwmj/phMlUgUxPDQko2b4Inp0Ihja6UeaE15fiINvLAlLX60MrugKHGDorUAj9EIPRXxCsH6hKD4JAC6XrfQHoNRWyGXom9sZqq2eLlmZ5mEFddjB3DtCCJZLOCCUIwUdHqmDxjLFl23Uk4fKuZVyP0E4hUBfcRgjleH6Hj84u4lzw+noKJkS6qQHqU+7oCaIWhaPyvZxQ2LdC/amaOBnaN4Deg5EYSmbIIKLlpCJ+44T3Ynh0Yi/w8DkAD0vcs8IDcGmPLQQaTS+3lRd6GmQgBTf2ruK6xHacHbhwoBCwEtxJ3ILzQgwdmWlC7FsDdwY7XUJhJaCHqRG2818qCZDR/QHQPSmKo2RHDxm0wE1D8l6BnzXtw+lwRCFwp7kV4U4QYyXPW680/l34whlwO8wBGosiGIQMrkJ8Tx2BQw/ngJqBqJ8galEYio8wZ+1fqVFLSD8c0POMgD2PkxMZ9rUxPp15cS7IFp7hxlvxzrbh+Pnq3CG4i3U/1UYJ3JSFIXqpHFRHuUDT2UjoYE7oqM7mxAG424eq+eoHjN4QEMATdOlxD4tWDyNZ7QEA4E+I7HxNftq4odY7jKXb6XD0shjPAW6koVKh+Xw0VCOEpOWzwHXOeDiycjbUxm3En+MaCuFWOgXBcgNVBl+3mG5z4q+rouoOpW8Q7V1CB+A8wjn0FvYzhaFrfw9doeXf82FKf15UGMV6BAUF4WFOexfJ/3oDx+RG7BK5E2LsGJvxmPxOxBqIXjwTNqATsp014NFRjH3sCLnEiKCwH6CiFeFD4n+OvxOhUfGh8GH07QgEQNvwJvzbz/Do7sGpcLgQ5Qnh9rrp2t3fc+rniwpj2HGzovakUX7RNmrv7hzx5cpjO14kbhBtjzkBE2GosRR44GlQkbsePDm+HehTIw4CdQOGDhP9nqr3z7FicMCoGBAG49Ou4EOgALjxvK0ihTvkfXSaQvCAkJVaKXQ//QJA1e0FqikoJXNpocSUdXq0R6BNEr04rvd/iQcnl3Ysgp06E8F3/gQo9VkI9Rk7qRPo2SAFQcOCivs3+76XGBg+EOoQBoO54sOO4APA6znyvg3HZIzNHPcc8lSQI+Dzj3V8AP1/Z0eoq1tcrShamu1pBg9zgmlVoOFAN8SdExR56IOXuijs0p0El7Zb0LaY5gSubWYgUEk9lAxtDMpHYTBX8B3R0w0MQBXNNek0HLgGrB0hvsIwvR7vTUtj04AA9HyXcMQgMt9ZVaLqpPdihLCH6xRfV6Rx/f/jNF844aIJ7nNFIFBvMoXAhUNT8UEcoOKxdU6gMPgq766kLvVwyQdB9O0GBEDXtuBwVpXqB0kbTGFgAHp3izKCQwbprdeYeC/PZwltlOgLE1wotOI4/SDZC7IcVblz/d36UlDmYwaPUrZB45kI7iAVnyPSabKHeoLpDaKDiYUGPyyqPuCEGgYA19G/WZWyA5JcjYGG9EAB8Bsl1iOMHz7IcL36xLqTWxfjQ5UgPCzBTWBI8EpioC7BHTIc5sJGhBCgNwkubDGCukQPeJG/jyufvIuxqLju6gWGOaQ3CL4bekHgg2D5ANe9Ko6CG3Fb6LODVnoTB7b53j3CRNSscdgorVUTr8GcwCXGptI4esGY/A7D/S4IGA7btSdC0UY8eovGI/fcIGg8G8mt4ZXGoGL5YiCYPgqiuxvQ5gxCJgPAQCAcPLzh3mkqCnaEtZqTD9Mm70sA+Ao1mvUIs7Bl1rVXEr1KJ8CqZLQ63mEck2kFQAgekOOsDp5qouClIQY5a1Th1n5beHx8B7xEN9DH7c24DksmKoaKgeDD6O0I5oaeEG6l88slAmnDz16ei4abR7ZDhN38tmmCw5T5AL4wBCwTGpay4/Li8FTpetQGaCgIp+eHHISH2Bjlu2mDj5YEuGJIJFrPgis7F3MOeZaDj8sLwrgk2YztdQsfBnUHH0QvRyR9HAIKrc+5se5EKOTutAELWZEt7FpZCHxZCBNR8ihVwyljI/eay/1RHGhD3yGk7xZxdn+Uug3OexlDsMFkPEkWhhDjKVC0QQcqQ22hLmkzPM0K4MbqV0XhdD0DEkXzBScGpssdFAZ1Q28IVPRRG0J6gmcYJZGbYL3O9Fz2zoAIV9IB4EtDGMXmBlnUXAWREW6btCQbjmFIXIt0hQeZAXhwsgceHN3KlcVDi6RhnbIIbMaD1EQreTjnqQ8Ve1ZCNeaHh0e2wBMMj6fZAdBwIggaTu6B5wiGwuG+ng6lAxd1RXcndBfGfSL32O168nYIWDa3ZuTQQeqsmx010DL4uROkGHvxUnns4EGGi2YK5QSazvzjuKsBlASt5h6O3MAxuniLMcQvkwd3dXGwVxwPXpricMBCGtIxYRZu0oMy7CivB6+ACnRH5X4HqMRR+zbOG7Xx7vT9AZo8KQDaV/TqJ2jYNRQehMqUnXDQUY83Q2iYGTvpGo8a9OUB9D5QEWFvmc9Gqc8QHGJHQXjOn9wStkQB4larQZKtOsRYK0Kw0VRww9nBUkYIrFGBeLiSjJNlzJKZEG8pA1kOKpDvOp8CoY/kuM03s6TJY+GAIGjvz31txrzRgKdWt1L8IGGD6S/qkmMcmPXF+GcDfweA3ueLQqhJ7I+roDSGDyIGNDTwGUTkwpmC6YtlxuebSwvma08ak2w0VSB9Bx6pJyxXhJPrtCAPO8ko8xlwbPUc2kTRu4+JdCuGRSANAdpQ0RxBW2wqWkm4t82eYENWkbAVkjaZ/aY3VXAjnWJZfho5gHF44GID1CjWNU5jCXIOShWljtLsIS2DqWPDfBZM+gsPVri30lJWKkCIoRRk2CnDRRysbu6zpSHA5YeG3CCWD/ZxeoYPaGvTdsAVrD5x6wx+M5Ie780cKIUa08d5wN/uBgEGQgolzVwxC6XApMjgqGlJjvbdpDnhpzCzGZCEpTISv/rhdJmyajZWEEMoD7SG2wddEIQnPEzZCg9TfaAWk2ZltBvQqhO1WvMX3anj3OnUyt6AF+x6jfbLARj4IDWCjdXCDIgYk0S319uUZ44fYmOvJHLfT3cyhJpMA1/sINeqiEIonjtm4mFL4WZjKPO3hGt7VkF5sA2c32kFmRuNwH+hXKP6hNHODOY09iL1NwM7Evv7w+MbCoVpSLdwmUE3gCfS2thPHHGYI/KLy1zRv5bJjmtXlxiVuVJR5ErEYjlIWq0CaQ4akGSnBuFLFcBZbcKFCQKDzdidZ5vv4/8y879NDMR41BQWFmriI75dIi00zGnU4K+N8ft5VCriI/c7zBF7vkFzQqvdbNGr2pPGbmF5ZTazPX/z/zEAmJgzxrKWVQalxKqIMrO2MgXTlTjZ17koeRZGgnzbf1z/A8LqwGwl+RDuAAAAAElFTkSuQmCC\" title=\"emoji-clap\" /> <img class=\"emoji-icon\" alt=\"emoji-clap\" data-icon=\"emoji-clap\" style=\"display: inline; margin: 0; margin-top: 1px; position: relative; top: 5px; width: 25px\" src=\"data:image/png;base64, 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\" title=\"emoji-clap\" /></p>\n</blockquote>\n<h2 id=\"h-12-absolute-difference-is-not-calculated-properly-when-a--b-in-mathutils\" style=\"position:relative;\"><a href=\"#h-12-absolute-difference-is-not-calculated-properly-when-a--b-in-mathutils\" aria-label=\"h 12 absolute difference is not calculated properly when a  b in mathutils permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/139\">[H-12] absolute difference is not calculated properly when a > b in MathUtils</a></h2>\n<p><em>Submitted by hack3r-0m, also found by broccoli</em></p>\n<p>the difference is computed incorrectly when a > b. <a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/libraries/MathUtils.sol#L22\"><code>MathUtils.sol</code> L22</a></p>\n<p>As it only used in <code>within1</code> function, scope narrows down to where <code>difference(a, b) &#x3C;= 1;</code> is exploitable.</p>\n<p>cases where <code>difference(a, b) &#x3C;= 1</code> should be true but is reported false:</p>\n<ul>\n<li>where b = a-1 (returned value is <code>type(uint256).max</code>)</li>\n</ul>\n<p>cases where <code>difference(a, b) &#x3C;= 1</code> should be false but is reported true:</p>\n<ul>\n<li>where a = <code>type(uint256)</code>.max and b = 0, it returns 1 but it should ideally return <code>type(uint256).max</code></li>\n</ul>\n<p><code>within1</code> is used at the following locations:</p>\n<ul>\n<li><a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/HybridPool.sol#L359\"><code>HybridPool.sol</code> L359</a></li>\n<li><a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/HybridPool.sol#L383\"><code>HybridPool.sol</code> L383</a></li>\n<li><a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/HybridPool.sol#L413\"><code>HybridPool.sol</code> L413</a></li>\n</ul>\n<p>It is possible to decrease the denominator and increase the value of the numerator (when calculating y) using constants and input to make <code>within1</code> fail</p>\n<p>Mitigation:</p>\n<p>Add <code>else</code> condition to mitigate it.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">a</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">b</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">diff</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">b</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">diff</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">b</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">a</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/139\">maxsam4 (Sushi) confirmed</a></strong></p>\n<h2 id=\"h-13-overflow-in-the-mint-function-of-indexpool-causes-lps-funds-to-be-stolen\" style=\"position:relative;\"><a href=\"#h-13-overflow-in-the-mint-function-of-indexpool-causes-lps-funds-to-be-stolen\" aria-label=\"h 13 overflow in the mint function of indexpool causes lps funds to be stolen permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/163\">[H-13] Overflow in the <code>mint</code> function of <code>IndexPool</code> causes LPs’ funds to be stolen</a></h2>\n<p><em>Submitted by broccoli, also found by WatchPug</em></p>\n<h4 id=\"impact-11\" style=\"position:relative;\"><a href=\"#impact-11\" aria-label=\"impact 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>It is possible to overflow the addition in the balance check (i.e., <code>_balance(tokenIn) >= amountIn + reserve</code>) in the mint function by setting the <code>amountIn</code> to a large amount. As a result, the attacker could gain a large number of LP tokens by not even providing any liquidity. The attacker’s liquidity would be much greater than any other LPs, causing him could effectively steal others’ funds by burning his liquidity (since the funds he receives are proportional to his liquidity).</p>\n<h4 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li><a href=\"https://gist.github.com/x9453/7a423aef223c1b86442206e3248d318c\">mint_overflow.js</a></li>\n</ul>\n<p>Referenced code:</p>\n<ul>\n<li><a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/IndexPool.sol#L110\">IndexPool.sol L110</a></li>\n</ul>\n<h4 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider removing the <code>uncheck</code> statement to prevent integer overflows from happening.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/163#issuecomment-935750061\">maxsam4 (Sushi) acknowledged</a>:</strong></p>\n<blockquote>\n<p>FWIW The problem here isn’t that we used unchecked but that we didn’t cast amountIn to uint256. It’s possible to overflow uint120 but not uint256.</p>\n</blockquote>\n<h2 id=\"h-14-incorrect-usage-of-_pow-in-_computesingleoutgivenpoolin-of-indexpool\" style=\"position:relative;\"><a href=\"#h-14-incorrect-usage-of-_pow-in-_computesingleoutgivenpoolin-of-indexpool\" aria-label=\"h 14 incorrect usage of _pow in _computesingleoutgivenpoolin of indexpool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/165\">[H-14] Incorrect usage of <code>_pow</code> in <code>_computeSingleOutGivenPoolIn</code> of <code>IndexPool</code></a></h2>\n<p><em>Submitted by broccoli</em></p>\n<h4 id=\"impact-12\" style=\"position:relative;\"><a href=\"#impact-12\" aria-label=\"impact 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The <code>_computeSingleOutGivenPoolIn</code> function of <code>IndexPool</code> uses the <code>_pow</code> function to calculate <code>tokenOutRatio</code> with the exponent in <code>WAD</code> (i.e., in 18 decimals of precision). However, the <code>_pow</code> function assumes that the given exponent <code>n</code> is not in <code>WAD</code>. (for example, <code>_pow(5, BASE)</code> returns <code>5 ** (10 ** 18)</code> instead of <code>5 ** 1</code>). The misuse of the <code>_pow</code> function could causes an integer overflow in the <code>_computeSingleOutGivenPoolIn</code> function and thus prevent any function from calling it.</p>\n<h4 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Referenced code:\n<a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/IndexPool.sol#L279\">IndexPool.sol#L279</a></p>\n<h4 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Change the <code>_pow</code> function to the <code>_compute</code> function, which supports exponents in <code>WAD</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/165\">maxsam4 (Sushi) confirmed</a></strong></p>\n<h2 id=\"h-15-incorrect-multiplication-in-_computesingleoutgivenpoolin-of-indexpool\" style=\"position:relative;\"><a href=\"#h-15-incorrect-multiplication-in-_computesingleoutgivenpoolin-of-indexpool\" aria-label=\"h 15 incorrect multiplication in _computesingleoutgivenpoolin of indexpool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/166\">[H-15] Incorrect multiplication in <code>_computeSingleOutGivenPoolIn</code> of <code>IndexPool</code></a></h2>\n<p><em>Submitted by broccoli</em></p>\n<h4 id=\"impact-13\" style=\"position:relative;\"><a href=\"#impact-13\" aria-label=\"impact 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The <code>_computeSingleOutGivenPoolIn</code> function of <code>IndexPool</code> uses the raw multiplication (i.e., <code>*</code>) to calculate the <code>zaz</code> variable. However, since both <code>(BASE - normalizedWeight)</code> and <code>_swapFee</code> are in <code>WAD</code>, the <code>_mul</code> function should be used instead to calculate the correct value of <code>zaz</code>. Otherwise, <code>zaz</code> would be <code>10 ** 18</code> times larger than the expected value and causes an integer underflow when calculating <code>amountOut</code>. The incorrect usage of multiplication prevents anyone from calling the function successfully.</p>\n<h4 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Referenced code:\n<a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/IndexPool.sol#L282\">IndexPool.sol#L282</a></p>\n<h4 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Change <code>(BASE - normalizedWeight) * _swapFee</code> to <code>_mul((BASE - normalizedWeight), _swapFee)</code>.</p>\n<p> <strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/166\">maxsam4 (Sushi) confirmed</a></strong></p>\n<h2 id=\"h-16-funds-in-the-pool-could-be-stolen-by-exploiting-flashswap-in-hybridpool\" style=\"position:relative;\"><a href=\"#h-16-funds-in-the-pool-could-be-stolen-by-exploiting-flashswap-in-hybridpool\" aria-label=\"h 16 funds in the pool could be stolen by exploiting flashswap in hybridpool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/167\">[H-16] Funds in the pool could be stolen by exploiting <code>flashSwap</code> in <code>HybridPool</code></a></h2>\n<p><em>Submitted by broccoli</em></p>\n<h4 id=\"impact-14\" style=\"position:relative;\"><a href=\"#impact-14\" aria-label=\"impact 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>An attacker can call the <code>bento.harvest</code> function during the callback function of a flash swap of the <code>HybridPool</code> to reduce the number of input tokens that he has to pay to the pool, as long as there is any unrealized profit in the strategy contract of the underlying asset.</p>\n<h4 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ol>\n<li>The <code>HybridPool</code> accounts for the reserve and balance of the pool using the <code>bento.toAmount</code> function, which represents the actual amount of assets that the pool owns instead of the relative share. The value of <code>toAmount</code> could increase or decrease if the <code>bento.harvest</code> function is called (by anyone), depending on whether the strategy contract earns or loses money.</li>\n<li>Supposing that the DAI strategy contract of <code>Bento</code> has a profit not accounted for yet. To account for the profit, anyone could call <code>harvest</code> on <code>Bento</code> with the corresponding parameters, which, as a result, increases the <code>elastic</code> of the DAI token.</li>\n<li>Now, an attacker wants to utilize the unrealized profit to steal funds from a DAI-WETH hybrid pool. He calls <code>flashSwap</code> to initiate a flash swap from WETH to DAI. First, the pool transfers the corresponding amount of DAI to him, calls the <code>tridentSwapCallback</code> function on the attacker’s contract, and expects that enough DAI is received at the end.</li>\n<li>During the <code>tridentSwapCallback</code> function, the attacker calls <code>bento.harvest</code> to realize the profit of DAI. As a result, the pool’s <code>bento.toAmount</code> increases, and the amount of DAI that the attacker has to pay to the pool is decreased. The attacker could get the same amount of ETH but paying less DAI by exploiting this bug.</li>\n</ol>\n<p>Referenced code:</p>\n<ul>\n<li><a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/HybridPool.sol#L218-L220\"><code>HybridPool.sol</code> L218-L220</a></li>\n<li><a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/HybridPool.sol#L249-L250\"><code>HybridPool.sol</code> L249-L250</a></li>\n<li><a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/HybridPool.sol#L272-L285\"><code>HybridPool.sol</code> L272-L285</a></li>\n<li><a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/flat/BentoBoxV1Flat.sol#L1105\"><code>BentoBoxV1Flat.sol</code> L1105</a></li>\n<li><a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/flat/BentoBoxV1Flat.sol#L786-L792\"><code>BentoBoxV1Flat.sol</code> L786-L792</a></li>\n<li><a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/flat/BentoBoxV1Flat.sol#L264-L277\"><code>BentoBoxV1Flat.sol</code> L264-L277</a></li>\n</ul>\n<h4 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider not using <code>bento.toAmount</code> to track the reservers and balances, but use <code>balanceOf</code> instead (as done in the other two pools).</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/167#issuecomment-935717783\">maxsam4 (Sushi) confirmed</a>:</strong></p>\n<blockquote>\n<p>Stableswap needs to use <code>toAmount</code> balances rather shares to work. This issue allows skimming yield profits from the pool. There’s no user funds at risk but still an issue.</p>\n<p>We plan on resolving this by using a fixed toElastic ratio during the whole swap.</p>\n</blockquote>\n<h1 id=\"medium-risk-findings-10\" style=\"position:relative;\"><a href=\"#medium-risk-findings-10\" aria-label=\"medium risk findings 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (10)</h1>\n<h2 id=\"m-01-no-bar-fees-for-indexpools\" style=\"position:relative;\"><a href=\"#m-01-no-bar-fees-for-indexpools\" aria-label=\"m 01 no bar fees for indexpools permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/181\">[M-01] No bar fees for <code>IndexPools</code>?</a></h2>\n<p><em>Submitted by 0xsanson, also found by pauliax</em></p>\n<h4 id=\"impact-15\" style=\"position:relative;\"><a href=\"#impact-15\" aria-label=\"impact 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p><code>IndexPool</code> doesn’t collect fees for <code>barFeeTo</code>. Since this Pool contains also a method <code>updateBarFee()</code>, probably this is an unintended behavior.\nAlso without a fee, liquidity providers would probably ditch <code>ConstantProductPool</code> in favor of <code>IndexPool</code> (using the same two tokens with equal weights), since they get all the rewards. This would constitute an issue for the ecosystem.</p>\n<h4 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Add a way to send <code>barFees</code> to <code>barFeeTo</code>, same as the other pools.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/181\">maxsam4 (Sushi) confirmed</a></strong></p>\n<h2 id=\"m-02-constantproductpool--hybridpool-adding-and-removing-unbalanced-liquidity-yields-slightly-more-tokens-than-swap\" style=\"position:relative;\"><a href=\"#m-02-constantproductpool--hybridpool-adding-and-removing-unbalanced-liquidity-yields-slightly-more-tokens-than-swap\" aria-label=\"m 02 constantproductpool  hybridpool adding and removing unbalanced liquidity yields slightly more tokens than swap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/34\">[M-02] <code>ConstantProductPool</code> &#x26; <code>HybridPool</code>: Adding and removing unbalanced liquidity yields slightly more tokens than swap</a></h2>\n<p><em>Submitted by GreyArt, also found by broccoli</em></p>\n<h5 id=\"impact-16\" style=\"position:relative;\"><a href=\"#impact-16\" aria-label=\"impact 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h5>\n<p>A mint fee is applied whenever unbalanced liquidity is added, because it is akin to swapping the excess token amount for the other token.</p>\n<p>However, the current implementation distributes the minted fee to the minter as well (when he should be excluded). It therefore acts as a rebate of sorts.</p>\n<p>As a result, it makes adding and removing liquidity as opposed to swapping directly (negligibly) more desirable. An example is given below using the Constant Product Pool to illustrate this point. The Hybrid pool exhibits similar behaviour.</p>\n<h5 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h5>\n<ol>\n<li>Initialize the pool with ETH-USDC sushi pool amounts. As of the time of writing, there is roughly 53586.556 ETH and 165143020.5295 USDC.</li>\n<li>Mint unbalanced LP with 5 ETH (&#x26; 0 USDC). This gives the user <code>138573488720892 / 1e18</code> LP tokens.</li>\n<li>Burn the minted LP tokens, giving the user 2.4963 ETH and 7692.40 USDC. This is therefore equivalent to swapping 5 - 2.4963 = 2.5037 ETH for 7692.4044 USDC.</li>\n<li>If the user were to swap the 2.5037 ETH directly, he would receive 7692.369221 (0.03 USDC lesser).</li>\n</ol>\n<h5 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h5>\n<p>The mint fee should be distributed to existing LPs first, by incrementing <code>_reserve0</code> and <code>_reserve1</code> with the fee amounts. The rest of the calculations follow after.</p>\n<p><code>ConstantProductPool</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee1</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">_nonOptimalMintFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_reserve0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_reserve1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// increment reserve amounts with fees</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">_reserve0</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">uint112</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fee0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">_reserve1</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">uint112</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fee1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">_mintFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_reserve0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_reserve1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">computed</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">TridentMath</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sqrt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">balance0</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">balance1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">kLast</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">computed</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><code>HybridPool</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee1</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">_nonOptimalMintFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_reserve0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_reserve1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// increment reserve amounts with fees</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">_reserve0</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">uint112</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fee0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">_reserve1</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">uint112</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fee1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newLiq</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_computeLiquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">balance0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">balance1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/34\">maxsam4 (Sushi) confirmed</a></strong></p>\n<h2 id=\"m-03-router-would-fail-when-adding-liquidity-to-index-pool\" style=\"position:relative;\"><a href=\"#m-03-router-would-fail-when-adding-liquidity-to-index-pool\" aria-label=\"m 03 router would fail when adding liquidity to index pool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/68\">[M-03] Router would fail when adding liquidity to index Pool</a></h2>\n<p><em>Submitted by broccoli</em></p>\n<h4 id=\"impact-17\" style=\"position:relative;\"><a href=\"#impact-17\" aria-label=\"impact 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p><code>TridentRouter</code> is easy to fail when trying to provide liquidity to an index pool.</p>\n<p>Users would not get extra lp if they are not providing lp at the pool’s spot price. It’s the same design as uniswap v2. However, uniswap’s v2 handle’s the dirty part.</p>\n<p>Users would not lose tokens if they use the router (<a href=\"https://github.com/Uniswap/v2-periphery/blob/master/contracts/UniswapV2Router02.sol#L61-L76\"><code>UniswapV2Router02.sol</code> L61-L76</a>).</p>\n<p>However, the router wouldn’t stop users from transferring extra tokens (<a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/TridentRouter.sol#L168-L190\"><code>TridentRouter.sol</code> L168-L190</a>).</p>\n<p>Second, the price would possibly change when the transaction is confirmed. This would be reverted in the index pool.</p>\n<p>Users would either transfer extra tokens or fail. I consider this is a medium-risk issue.</p>\n<h4 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/TridentRouter.sol#L168-L190\">TridentRouter.sol#L168-L190</a></p>\n<p>A possible scenario:</p>\n<p>There’s a BTC/USD pool. BTC = 50000 USD.</p>\n<ol>\n<li>A user sends a transaction to transfer 1 BTC and 50000 USD.</li>\n<li>After the user send a transaction, a random bot buying BTC with USD.</li>\n<li>The transaction at step 1 is mined. Since the BTC price is not 50000 USD, the transaction fails.</li>\n</ol>\n<h4 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Please refer to the uniswap v2 router in <a href=\"https://github.com/Uniswap/v2-periphery/blob/master/contracts/UniswapV2Router02.sol#L61-L76\"><code>UniswapV2Router02.sol</code> L61-L76</a></p>\n<p>The router should calculate the optimal parameters for users.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/68\">maxsam4 (Sushi) confirmed</a></strong></p>\n<h2 id=\"m-04-routers-complexpath-percentagepaths-dont-work-as-expected\" style=\"position:relative;\"><a href=\"#m-04-routers-complexpath-percentagepaths-dont-work-as-expected\" aria-label=\"m 04 routers complexpath percentagepaths dont work as expected permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/87\">[M-04] Router’s <code>complexPath</code> percentagePaths don’t work as expected</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>TridentRouter.complexPath</code> function allows splitting a trade result into several buckets and trade them in a different pool each.\nThe distribution is defined by the <code>params.percentagePath[i].balancePercentage</code> values:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">percentagePath</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceShares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">bento</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">percentagePath</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokenIn</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transferShares</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">balanceShares</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">percentagePath</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">balancePercentage</span><span class=\"mtk1\">) / </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\">)**</span><span class=\"mtk7\">8</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bento</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">percentagePath</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokenIn</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">percentagePath</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">transferShares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">isWhiteListed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">percentagePath</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">percentagePath</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">swap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">percentagePath</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">data</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>However, the base value <code>bento.balanceOf(params.percentagePath[i].tokenIn, address(this));</code> is recomputed after each iteration instead of caching it before the loop.</p>\n<p>This leads to not all tokens being used even though the percentages add up to 100%.</p>\n<h4 id=\"poc-3\" style=\"position:relative;\"><a href=\"#poc-3\" aria-label=\"poc 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h4>\n<p>Assume I want to trade 50% DAI to WETH and the other 50% DAI to WBTC.\nIn the first iteration, <code>balanceShares</code> is computed and then 50% of it is swapped in the first pool.</p>\n<p>However, in the second iteration, <code>balanceShares</code> is updated again, and only 50% <strong>of the remaining</strong> (instead of the total) balance, i.e. 25%, is traded.</p>\n<p>The final 25% are lost and can be skimmed by anyone afterwards.</p>\n<h4 id=\"impact-18\" style=\"position:relative;\"><a href=\"#impact-18\" aria-label=\"impact 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Users can lose their funds using <code>complexPath</code>.</p>\n<h4 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Cache the <code>balanceShares</code> value once before the second <code>for</code> loop starts.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/87#issuecomment-934546115\">sarangparikh22 (Sushi) disputed</a>:</strong></p>\n<blockquote>\n<p>This is not the correct way to calculate the complexPath swap parameters.\nFor instance, if we need to swap 50% DAI to WETH and the other 50% DAI to WBTC, we would keep percentages as 50 and 100, instead of 50-50 as described above. If the user enters wrong percentages, they would loose funds.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/87#issuecomment-950522743\">alcueca (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The format for entering the percentages is not documented. Sustained as Sev 2 as the lack of documentation on this parameter could lead to loss of funds.</p>\n</blockquote>\n<h2 id=\"m-05-_deposittobentobox-sometimes-uses-both-eth-and-weth\" style=\"position:relative;\"><a href=\"#m-05-_deposittobentobox-sometimes-uses-both-eth-and-weth\" aria-label=\"m 05 _deposittobentobox sometimes uses both eth and weth permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/89\">[M-05] <code>_depositToBentoBox</code> sometimes uses both ETH and WETH</a></h2>\n<p><em>Submitted by cmichel, also found by 0xRajeev</em></p>\n<p>The <code>TridentRouter._depositToBentoBox</code> function only uses the <code>ETH</code> in the contract if it’s higher then the desired <code>underlyingAmount</code> (<code>address(this).balance >= underlyingAmount)</code>).</p>\n<p>Otherwise, the ETH is ignored and the function uses WETH from the user.</p>\n<h4 id=\"impact-19\" style=\"position:relative;\"><a href=\"#impact-19\" aria-label=\"impact 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Note that the <code>underlyingAmount = bento.toAmount(wETH, amount, true)</code> is computed from the Bento share price and it might happen that it increases from the time the transaction was submitted to the time the transaction is included in a block.\nIn that case, it might completely ignore the sent <code>ETH</code> balance from the user and in addition transfer the same amount of <code>WETH</code> from the user.</p>\n<p>The user can lose their <code>ETH</code> deposit in the contract.</p>\n<h4 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Each batch must use <code>refundETH</code> at the end.</p>\n<p>Furthermore, we recommend still depositing <code>address(this).balance</code> ETH into Bento and if it’s less than <code>underlyingAmount</code> use <code>WETH</code> only for <strong>the remaining token difference</strong>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/89\">maxsam4 (Sushi) acknowledged</a></strong></p>\n<h2 id=\"m-06-withdrawfromweth-always-reverts-\" style=\"position:relative;\"><a href=\"#m-06-withdrawfromweth-always-reverts-\" aria-label=\"m 06 withdrawfromweth always reverts  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/90\">[M-06] <code>withdrawFromWETH</code> always reverts </a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>TridentHelper.withdrawFromWETH</code> (used in <code>TridentRouter.unwrapWETH</code>) function performs a low-level call to <code>WETH.withdraw(amount)</code>.</p>\n<p>It then checks if the return <code>data</code> length is more or equal to <code>32</code> bytes, however <code>WETH.withdraw</code> returns <code>void</code> and has a return value of <code>0</code>.\nThus, the function always reverts even if <code>success == true</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawFromWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit WETH.withdraw returns nothing, data.length always zero. this always reverts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">success</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk7\">32</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;WITHDRAW_FROM_WETH_FAILED&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h4 id=\"impact-20\" style=\"position:relative;\"><a href=\"#impact-20\" aria-label=\"impact 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The <code>unwrapWETH</code> function is broken and makes all transactions revert.\nBatch calls to the router cannot perform any unwrapping of WETH.</p>\n<h4 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Remove the <code>data.length >= 32</code> from the require and only check if <code>success</code> is true.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/90\">sarangparikh22 (Sushi) confirmed</a></strong></p>\n<h2 id=\"m-07-hybridpools-flashswap-sends-entire-fee-to-barfeeto\" style=\"position:relative;\"><a href=\"#m-07-hybridpools-flashswap-sends-entire-fee-to-barfeeto\" aria-label=\"m 07 hybridpools flashswap sends entire fee to barfeeto permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/99\">[M-07] <code>HybridPool</code>’s <code>flashSwap</code> sends entire fee to <code>barFeeTo</code></a></h2>\n<p><em>Submitted by cmichel, also found by 0xsanson</em></p>\n<p>The <code>HybridPool.flashSwap</code> function sends the entire trade fees <code>fee</code> to the <code>barFeeTo</code>.\nIt should only send <code>barFee * fee</code> to the <code>barFeeTo</code> address.</p>\n<h4 id=\"impact-21\" style=\"position:relative;\"><a href=\"#impact-21\" aria-label=\"impact 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>LPs are not getting paid at all when this function is used.\nThere is no incentive to provide liquidity.</p>\n<h4 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>The <code>flashSwap</code> function should use the same fee mechanism as <code>swap</code> and only send <code>barFee * fee / MAX_FEE</code> to the <code>barFeeTo</code>. See <code>_handleFee</code> function.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/99\">maxsam4 (Sushi) confirmed</a></li>\n</ul>\n<h2 id=\"m-08-rounding-errors-will-occur-for-tokens-without-decimals\" style=\"position:relative;\"><a href=\"#m-08-rounding-errors-will-occur-for-tokens-without-decimals\" aria-label=\"m 08 rounding errors will occur for tokens without decimals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/152\">[M-08] Rounding errors will occur for tokens without decimals</a></h2>\n<p>Some rare tokens have 0 decimals: <a href=\"https://etherscan.io/token/0xcc8fa225d80b9c7d42f96e9570156c65d6caaa25\">https://etherscan.io/token/0xcc8fa225d80b9c7d42f96e9570156c65d6caaa25</a></p>\n<p>For these tokens, small losses of precision will be amplified by the lack of decimals.</p>\n<p>Consider a constant product pool with 1000 of token0 (with no decimals), and 1000 of token1 (also with no decimals). Suppose I swap n= 1,2,3,4 of token0 to token1. Then my output amount of token1 will be 0,1,2,3.</p>\n<p>If token0/1 are valuable than I will be losing 100%, 50%, 33%, 25% of my trade to rounding.\nCurrently there is no valuable token with 0 decimals, but there may be in the future.</p>\n<p>Rounding the final <code>getAmountOut</code> division upwards would fix this.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/152#issuecomment-946648813\">maxsam4 (Sushi) commented</a>:</strong></p>\n<blockquote>\n<p>Acceptable risk. We can’t do anything if the token itself doesn’t have decimals. We don’t create synthetic assets and fractionalize such tokens ourselves.</p>\n</blockquote>\n<h2 id=\"m-09-approximations-may-finish-with-inaccurate-values\" style=\"position:relative;\"><a href=\"#m-09-approximations-may-finish-with-inaccurate-values\" aria-label=\"m 09 approximations may finish with inaccurate values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/155\">[M-09] Approximations may finish with inaccurate values</a></h2>\n<p><em>Submitted by 0xsanson, also found by broccoli</em></p>\n<h4 id=\"impact-22\" style=\"position:relative;\"><a href=\"#impact-22\" aria-label=\"impact 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>In <code>HybridPool.sol</code>, functions <code>_computeLiquidityFromAdjustedBalances</code>, <code>_getY</code> and <code>_getYD</code> may finish before approximation converge, since it’s limited by <code>MAX_LOOP_LIMIT</code> iterations.\nIn this situation the final estimated value will still be treated as correct, even though it could be relatively inaccurate.</p>\n<h4 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider reverting the transactions if this doesn’t occur.\nSee <a href=\"https://blog.openzeppelin.com/saddle-contracts-audit/\">https://blog.openzeppelin.com/saddle-contracts-audit/</a> issue [M03], with their relative fix.</p>\n<h2 id=\"m-10-users-are-susceptible-to-back-running-when-depositing-eth-to-tridenrouter\" style=\"position:relative;\"><a href=\"#m-10-users-are-susceptible-to-back-running-when-depositing-eth-to-tridenrouter\" aria-label=\"m 10 users are susceptible to back running when depositing eth to tridenrouter permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/179\">[M-10] Users are susceptible to back-running when depositing ETH to <code>TridenRouter</code></a></h2>\n<p><em>Submitted by broccoli</em></p>\n<h4 id=\"impact-23\" style=\"position:relative;\"><a href=\"#impact-23\" aria-label=\"impact 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The <code>_depositToBentoBox</code> and <code>_depositFromUserToBentoBox</code> allow users to provide ETH to the router, which is later deposited to the <code>bento</code> contract for swapping other assets or providing liquidity. However, in these two functions, the input parameter does not represent the actual amount of ETH to deposit, and users have to calculate the actual amount and send it to the router, causing a back-run vulnerability if there are ETH left after the operation.</p>\n<h4 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ol>\n<li>A user wants to swap ETH to DAI. He calls <code>exactInputSingleWithNativeToken</code> on the router with the corresponding parameters and <code>params.amountIn</code> being 10. Before calling the function, he calculates <code>bento.toAmount(wETH, 10, true) = 15</code> and thus send 15 ETH to the router.</li>\n<li>However, at the time when his transaction is executed, <code>bento.toAmount(wETH, amount, true)</code> becomes to <code>14</code>, which could happen if someone calls <code>harvest</code> on <code>bento</code> to update the <code>elastic</code> value of the <code>wETH</code> token.</li>\n<li>As a result, only 14 ETH is transferred to the pool, and 1 ETH is left in the router. Anyone could back-run the user’s transaction to retrieve the remaining 1 ETH from the router by calling the <code>refundETH</code> function.</li>\n</ol>\n<p>Referenced code: <a href=\"https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/TridentRouter.sol#L318-L351\">TridentRouter.sol#L318-L351</a></p>\n<h4 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Directly push the remaining ETH to the sender to prevent any ETH left in the router.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/179#issuecomment-934388751\">maxsam4 (Sushi) confirmed</a>:</strong></p>\n<blockquote>\n<p>I think it’s low risk because it’s basically arbitrage and we have protection for the user in terms of “minOutputAmount”. I will be reworking ETH handling to avoid this issue completely.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/179#issuecomment-950567287\">alcueca (judge) commented</a>:</strong></p>\n<blockquote>\n<p>It’s a loss of funds, not arbitrage. It should be prevented or documented. Sustained.</p>\n</blockquote>\n<h1 id=\"low-risk-findings-39\" style=\"position:relative;\"><a href=\"#low-risk-findings-39\" aria-label=\"low risk findings 39 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Findings (39)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/4\">[L-01] unchecked use of optional function “decimals” of erc20 standards</a> <em>Submitted by hack3r-0m</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/9\">[L-02] <code>ConstantProductPool</code> lacks zero check for maserDeployer</a> <em>Submitted by hack3r-0m</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/10\">[L-03] HybridPool.sol lacks zero check for maserDeployer</a> <em>Submitted by hack3r-0m</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/18\">[L-04] <code>TridentERC20.sol</code> Possible replay attacks on <code>permit</code> function in case of a future chain split</a> <em>Submitted by nikitastupin, also found by 0xRajeev, 0xsanson, broccoli, and t11s</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/15\">[L-05] Reset cachedPool ?</a> <em>Submitted by gpersoon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/23\">[L-06] Missing validation of recipient argument could indefinitely lock owner role</a> <em>Submitted by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/32\">[L-07] # Hybrid Pool underflow when a &#x3C; 100</a> <em>Submitted by broccoli</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/39\">[L-08] <code>HybridPool</code>: SwapCallback should be done regardless of data.length</a> <em>Submitted by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/45\">[L-09] Missing invalid token check against pool address</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/46\">[L-10] <code>barFee</code> handled incorrectly in <code>flashSwap</code> (or swap)</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/47\">[L-11] Strict bound in reserve check of Hybrid Pool</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/49\">[L-12] Unlocked Solidity compiler pragma is risky</a> <em>Submitted by 0xRajeev, also found by broccoli, hrkrshnn, and JMukesh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/52\">[L-13] Missing zero-address checks</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/55\">[L-14] Missing timelock for critical contract setters of privileged roles</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/56\">[L-15] Unconditional setting of boolean/address values is risky</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/57\">[L-16] Timelock between new owner transfer+claim will reduce risk</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/58\">[L-17] Allowing direct single-step ownership transfer even as an option is risky</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/59\">[L-18] Missing contract existence check may cause silent failures of token transfers</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/82\">[L-19] <code>IndexPool</code> should check that tokens are supported</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/91\">[L-20] Several low-level calls don’t check the success return value</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/94\">[L-21] <code>ConstantProductPool</code> bar fee computation seems wrong</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/95\">[L-22] <code>ConstantProductPool</code> mint liquidity computation should include fees</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/100\">[L-23] <code>HybridPool</code>’s <code>flashSwap</code> does not always call callback</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/124\">[L-24] The functions <code>refundETH</code> and <code>unwrapWETH</code> is generalized-front-runnable</a> <em>Submitted by hrkrshnn</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/131\">[L-25] Lack of checks for address and amount in <code>TridentERC20._mint</code></a> <em>Submitted by GalloDaSballo</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/135\">[L-26] Lack of checks for address and amount in <code>TridentERC20._mint</code></a> <em>Submitted by GalloDaSballo</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/140\">[L-27] Lack of address validation in <code>MasterDeployer.setMigrator</code></a> <em>Submitted by GalloDaSballo</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/141\">[L-28] Consider using solidity 0.8.8</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/153\">[L-29] lack of input validation in <code>Transfer()</code> and <code>TransferFrom()</code></a> <em>Submitted by JMukesh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/162\">[L-30] <code>_powApprox</code>: unbounded loop and meaning</a> <em>Submitted by 0xsanson</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/164\">[L-31] <code>HybridPool</code>’s wrong amount to balance conversion</a> <em>Submitted by 0xsanson</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/173\">[L-32] <code>_computeLiquidityFromAdjustedBalances</code> order of operations can be improved</a> <em>Submitted by 0xsanson</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/180\">[L-33] Wrong initialization of <code>blockTimestampLast</code> in <code>ConstantProductPool</code></a> <em>Submitted by broccoli</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/149\">[L-34] Oracle Initialization</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/184\">[L-35] Docs disagrees with index pool code</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/185\">[L-36] Division by zero in <code>_computeLiquidityFromAdjustedBalances</code> of <code>HybridPool</code></a> <em>Submitted by broccoli</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/174\">[L-37] <code>_getY</code> and <code>_getYD</code> math operations can be reordered</a> <em>Submitted by 0xsanson</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/188\">[L-38] Division and division in <code>_getY</code> of <code>HybridPool</code></a> <em>Submitted by broccoli</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/190\">[L-39] Incorrect comparison in the <code>_updateReserves</code> function of <code>HybridPool</code></a> <em>Submitted by broccoli</em></li>\n</ul>\n<h1 id=\"non-critical-findings-20\" style=\"position:relative;\"><a href=\"#non-critical-findings-20\" aria-label=\"non critical findings 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Findings (20)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/2\">[N-01] Events not emitted while changing state variables in constructor</a> <em>Submitted by hack3r-0m</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/35\">[N-02] <code>ConstantProductPool</code>: Move minting of MIN_LIQUIDITY after checks</a> <em>Submitted by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/43\">[N-03] Unused constants could indicate missing logic or redundant code</a> <em>Submitted by 0xRajeev, also found by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/76\">[N-04] <code>TridentRouter.isWhiteListed()</code> Misleading name</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/86\">[N-05] TridentERC20 does not emit Approval event in <code>transferFrom</code></a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/93\">[N-06] <code>ConstantProductPool.getAmountOut</code> does not verify token</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/97\">[N-07] <code>HybridPool</code> missing positive token amount checks for initial mint</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/104\">[N-08] <code>MAX_FEE_SQUARE</code> dependency on <code>MAX_FEE</code></a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/105\">[N-09] Emit events when setting the values in constructor</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/107\">[N-10] Inclusive check of <code>type(uint128).max</code></a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/121\">[N-11] Consider avoiding low level calls to MasterDeployer</a> <em>Submitted by hrkrshnn</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/122\">[N-12] Functions that can be made external</a> <em>Submitted by hrkrshnn</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/127\">[N-13] Style issues</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/138\">[N-14] Lack of address validation in <code>MasterDeployer.addToWhitelist</code></a> <em>Submitted by GalloDaSballo</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/150\">[N-15] Using interfaces instead of selectors is best practice</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/156\">[N-16] Follow Curve’s convention: <code>_getYD</code> and <code>_getY</code></a> <em>Submitted by 0xsanson</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/175\">[N-17] View functions in Hybrid Pool Contract Pool need better documentation</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/177\">[N-18] Inconsistent tokens sent to <code>barFeeTo</code></a> <em>Submitted by 0xsanson</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/189\">[N-19] Unnecessary condition on <code>_processSwap</code> of <code>HybridPool</code></a> <em>Submitted by broccoli</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/48\">[N-20] Similarly initialized weight thresholds may cause unexpected deployment failures</a> <em>Submitted by 0xRajeev</em></li>\n</ul>\n<h1 id=\"gas-optimizations-25\" style=\"position:relative;\"><a href=\"#gas-optimizations-25\" aria-label=\"gas optimizations 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations (25)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/12\">[G-01] Safe gas on <code>_powApprox</code></a> <em>Submitted by gpersoon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/16\">[G-02] Use parameter <code>_blockTimestampLast</code> in <code>_update()</code> </a> <em>Submitted by gpersoon, also found by 0xsanson</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/33\">[G-03] Consider unlocking pool only upon initial mint</a> <em>Submitted by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/37\">[G-04] <code>ConstantProductPool</code>: Unnecessary mod before casting to uint32</a> <em>Submitted by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/41\">[G-05] <code>IndexPool</code>: Redundant MAX_WEIGHT</a> <em>Submitted by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/42\">[G-06] <code>TridentOwnable</code>: <code>pendingOwner</code> should be set to address(1) if direct owner transfer is used</a> <em>Submitted by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/60\">[G-07] Replace multiple calls with a single new function call</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/61\">[G-08] Unused code can be removed to save gas</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/62\">[G-09] Use of unchecked can save gas where computation is known to be overflow/underflow safe</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/103\">[G-10] Gas: <code>HybridPool._computeLiquidityFromAdjustedBalances</code> should return early</a> <em>Submitted by cmichel, also found by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/64\">[G-11] Avoiding initialization of loop index can save a little gas</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/65\">[G-12] Caching in local variables can save gas </a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/102\">[G-13] Gas: <code>HybridPool</code> unnecessary <code>balance</code> computations</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/51\">[G-14] Use of <code>ecrecover</code> is susceptible to signature malleability</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/112\">[G-15] Caching the length in for loops</a> <em>Submitted by hrkrshnn</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/113\">[G-16] Consider using custom errors instead of revert strings</a> <em>Submitted by hrkrshnn</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/114\">[G-17] Consider changing the <code>_deployData</code> architecture</a> <em>Submitted by hrkrshnn</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/115\">[G-18] Caching the storage read to <code>tokens.length</code></a> <em>Submitted by hrkrshnn</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/116\">[G-19] Caching a storage load in TridentERC20</a> <em>Submitted by hrkrshnn</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/117\">[G-20] Unused state variable <code>barFee</code> and _barFeeTo in <code>IndexPool</code></a> <em>Submitted by hrkrshnn</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/118\">[G-21]  Consider putting some parts of <code>_div</code> in unchecked</a> <em>Submitted by hrkrshnn</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/119\">[G-22] Use <code>calldata</code> instead of <code>memory</code> for function parameters</a> <em>Submitted by hrkrshnn</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/128\">[G-23] Cache array length in for loops can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/129\">[G-24] Cache storage variable in the stack can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-sushitrident-findings/issues/148\">[G-25] Using 10**X for constants isn’t gas efficient</a></li>\n</ul>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-16\">High Risk Findings (16)</a></p>\n<ul>\n<li><a href=\"#h-01-flash-swap-call-back-prior-to-transferring-tokens-in-indexpool\">[H-01] Flash swap call back prior to transferring tokens in <code>indexPool</code></a></li>\n<li><a href=\"#h-02-index-pool-always-swap-to-zero\">[H-02] Index Pool always swap to Zero</a></li>\n<li><a href=\"#h-03-indexpool-pow-overflows-when-weightratio--10\">[H-03] <code>IndexPool</code> pow overflows when <code>weightRatio</code> > 10.</a></li>\n<li><a href=\"#h-04-indexpools-init_pool_supply-is-not-fair\">[H-04] IndexPool’s <code>INIT_POOL_SUPPLY</code> is not fair.</a></li>\n<li><a href=\"#h-05-hybrid-pool-uses-wrong-non_optimal_mint_fee\">[H-05] hybrid pool uses wrong <code>non_optimal_mint_fee</code></a></li>\n<li><a href=\"#h-06-indexpool--poor-conversion-from-balancer-v1s-corresponding-functions\">[H-06] <code>IndexPool</code>:  Poor conversion from Balancer V1’s corresponding functions</a></li>\n<li><a href=\"#h-07-indexpoolmint-the-first-liquidity-provider-is-forced-to-supply-assets-in-the-same-amount-which-may-cause-a-significant-amount-of-fund-loss\">[H-07] <code>IndexPool.mint</code> The first liquidity provider is forced to supply assets in the same amount, which may cause a significant amount of fund loss</a></li>\n<li><a href=\"#h-08-hybridpools-reserve-is-converted-to-amount-twice\">[H-08] <code>HybridPool</code>’s reserve is converted to “amount” twice</a></li>\n<li><a href=\"#h-09-unsafe-cast-in-indexpool-mint-leads-to-attack\">[H-09] Unsafe cast in <code>IndexPool</code> mint leads to attack</a></li>\n<li><a href=\"#h-10-indexpool-initial-lp-supply-computation-is-wrong\">[H-10] <code>IndexPool</code> initial LP supply computation is wrong</a></li>\n<li><a href=\"#h-11-constantproductpoolburnsingle-swap-amount-computations-should-use-balance\">[H-11] <code>ConstantProductPool.burnSingle</code> swap amount computations should use balance</a></li>\n<li><a href=\"#h-12-absolute-difference-is-not-calculated-properly-when-a--b-in-mathutils\">[H-12] absolute difference is not calculated properly when a > b in MathUtils</a></li>\n<li><a href=\"#h-13-overflow-in-the-mint-function-of-indexpool-causes-lps-funds-to-be-stolen\">[H-13] Overflow in the <code>mint</code> function of <code>IndexPool</code> causes LPs’ funds to be stolen</a></li>\n<li><a href=\"#h-14-incorrect-usage-of-_pow-in-_computesingleoutgivenpoolin-of-indexpool\">[H-14] Incorrect usage of <code>_pow</code> in <code>_computeSingleOutGivenPoolIn</code> of <code>IndexPool</code></a></li>\n<li><a href=\"#h-15-incorrect-multiplication-in-_computesingleoutgivenpoolin-of-indexpool\">[H-15] Incorrect multiplication in <code>_computeSingleOutGivenPoolIn</code> of <code>IndexPool</code></a></li>\n<li><a href=\"#h-16-funds-in-the-pool-could-be-stolen-by-exploiting-flashswap-in-hybridpool\">[H-16] Funds in the pool could be stolen by exploiting <code>flashSwap</code> in <code>HybridPool</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-10\">Medium Risk Findings (10)</a></p>\n<ul>\n<li><a href=\"#m-01-no-bar-fees-for-indexpools\">[M-01] No bar fees for <code>IndexPools</code>?</a></li>\n<li><a href=\"#m-02-constantproductpool--hybridpool-adding-and-removing-unbalanced-liquidity-yields-slightly-more-tokens-than-swap\">[M-02] <code>ConstantProductPool</code> &#x26; <code>HybridPool</code>: Adding and removing unbalanced liquidity yields slightly more tokens than swap</a></li>\n<li><a href=\"#m-03-router-would-fail-when-adding-liquidity-to-index-pool\">[M-03] Router would fail when adding liquidity to index Pool</a></li>\n<li><a href=\"#m-04-routers-complexpath-percentagepaths-dont-work-as-expected\">[M-04] Router’s <code>complexPath</code> percentagePaths don’t work as expected</a></li>\n<li><a href=\"#m-05-_deposittobentobox-sometimes-uses-both-eth-and-weth\">[M-05] <code>_depositToBentoBox</code> sometimes uses both ETH and WETH</a></li>\n<li><a href=\"#m-06-withdrawfromweth-always-reverts-\">[M-06] <code>withdrawFromWETH</code> always reverts </a></li>\n<li><a href=\"#m-07-hybridpools-flashswap-sends-entire-fee-to-barfeeto\">[M-07] <code>HybridPool</code>’s <code>flashSwap</code> sends entire fee to <code>barFeeTo</code></a></li>\n<li><a href=\"#m-08-rounding-errors-will-occur-for-tokens-without-decimals\">[M-08] Rounding errors will occur for tokens without decimals</a></li>\n<li><a href=\"#m-09-approximations-may-finish-with-inaccurate-values\">[M-09] Approximations may finish with inaccurate values</a></li>\n<li><a href=\"#m-10-users-are-susceptible-to-back-running-when-depositing-eth-to-tridenrouter\">[M-10] Users are susceptible to back-running when depositing ETH to <code>TridenRouter</code></a></li>\n</ul>\n</li>\n<li><a href=\"#low-risk-findings-39\">Low Risk Findings (39)</a></li>\n<li><a href=\"#non-critical-findings-20\">Non-Critical Findings (20)</a></li>\n<li><a href=\"#gas-optimizations-25\">Gas Optimizations (25)</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode 423n4 (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the code contest outlined in this document, C4 conducted an analysis of Sushi Trident smart contract system written in Solidity. The code contest took place between September 16—September 29 2021.\n\n## Wardens\n\n18 Wardens contributed reports to the Sushi Trident code contest (phase 1):\n\n1. broccoli ([shw](https://github.com/x9453) and [jonah1005](https://twitter.com/jonah1005w))\n2. [cmichel](https://twitter.com/cmichelio)\n3. WatchPug ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n4. [0xsanson](https://github.com/0xsanson)\n5. GreyArt ([hickuphh3](https://twitter.com/HickupH) and [itsmeSTYJ](https://twitter.com/itsmeSTYJ))\n6. [0xRajeev](https://twitter.com/0xRajeev)\n7. [hack3r-0m](https://twitter.com/hack3r_0m)\n8. [pauliax](https://twitter.com/SolidityDev)\n9.  [hrkrshnn](https://twitter.com/_hrkrshnn)\n10.  [GalloDaSballo](https://twitter.com/gallodasballo)\n11.  [gpersoon](https://twitter.com/gpersoon)\n12.  [JMukesh](https://twitter.com/MukeshJ_eth)\n13.  [defsec](https://twitter.com/defsec_)\n14.  [nikitastupin](http://twitter.com/_nikitastupin)\n15. [t11s](https://twitter.com/transmissions11)\n\nThis contest was judged by [Alberto Cuesta Cañada](https://twitter.com/alcueca).\n\nFinal report assembled by [moneylegobatman](https://twitter.com/money_lego) and [CloudEllie](https://twitter.com/CloudEllie1).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 65 unique vulnerabilities and 110 total findings. All of the issues presented here are linked back to their original findings\n\nOf these vulnerabilities, 16 received a risk rating in the category of HIGH severity, 10 received a risk rating in the category of MEDIUM severity, and 39 received a risk rating in the category of LOW severity.\n\nC4 analysis also identified 20 non-critical recommendations and 25 gas optimizations.\n\n# Scope\n\nThe code under review can be found within the [C4 Sushi Trident contest repository](https://github.com/code-423n4/2021-09-sushitrident), and is composed of 58 smart contracts written in the Solidity programming language and includes 5,556 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code423n4.com).\n\n# High Risk Findings (16)\n\n## [[H-01] Flash swap call back prior to transferring tokens in `indexPool`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/26)\n_Submitted by broccoli, also found by 0xsanson and cmichel_\n\n#### Impact\nIn the `IndexPool` contract, `flashSwap` does not work.\nThe callback function is called prior to token transfer. The sender won't receive tokens in the callBack function.\n`ITridentCallee(msg.sender).tridentSwapCallback(context);`\n\n`Flashswap` is not implemented correctly. It may need a migration to redeploy all `indexPools` if the issue is found after main-net launch.\nI consider this a high-risk issue.\n\n#### Proof of Concept\n[IndexPool.sol#L196-L223](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/IndexPool.sol#L196-L223)\n\n```solidity\nITridentCallee(msg.sender).tridentSwapCallback(context);\n// @dev Check Trident router has sent `amountIn` for skim into pool.\nunchecked { // @dev This is safe from under/overflow - only logged amounts handled.\n    require(_balance(tokenIn) >= amountIn + inRecord.reserve, \"NOT_RECEIVED\");\n    inRecord.reserve += uint120(amountIn);\n    outRecord.reserve -= uint120(amountOut);\n}\n_transfer(tokenOut, amountOut, recipient, unwrapBento);\n```\n\n#### Recommended Mitigation Steps\n```solidity\n_transfer(tokenOut, amountOut, recipient, unwrapBento);\nITridentCallee(msg.sender).tridentSwapCallback(context);\n// @dev Check Trident router has sent `amountIn` for skim into pool.\nunchecked { // @dev This is safe from under/overflow - only logged amounts handled.\n    require(_balance(tokenIn) >= amountIn + inRecord.reserve, \"NOT_RECEIVED\");\n    inRecord.reserve += uint120(amountIn);\n    outRecord.reserve -= uint120(amountOut);\n}\n```\n\n**[maxsam4 (Sushi) commented](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/26#issuecomment-952521402):**\n > Duplicate of\n> https://github.com/code-423n4/2021-09-sushitrident-findings/issues/157\n> and\n> https://github.com/code-423n4/2021-09-sushitrident-findings/issues/80\n\n## [[H-02] Index Pool always swap to Zero](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/27)\n_Submitted by broccoli, also found by 0xsanson, cmichel, and WatchPug_\n\n#### Impact\nWhen an Index pool is initiated with two tokens A: B and the weight rate = 1:2, then no user can buy token A with token B.\n\nThe root cause is the error in pow. It seems like the dev tries to implement [Exponentiation by squaring](https://en.wikipedia.org/wiki/Exponentiation_by_squaring).\n[IndexPool.sol#L286-L291](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/IndexPool.sol#L286-L291)\n\n```solidity\nfunction _pow(uint256 a, uint256 n) internal pure returns (uint256 output) {\n  output = n % 2 != 0 ? a : BASE;\n  for (n /= 2; n != 0; n /= 2) a = a * a;\n  if (n % 2 != 0) output = output * a;\n}\n```\n\nThere's no bracket for `for`.\n\nThe `IndexPool` is not functional. I consider this is a high-risk issue.\n\n#### Proof of Concept\nWhen we initiated the pool with 2:1.\n\n```python\ndeployed_code = encode_abi([\"address[]\",\"uint136[]\",\"uint256\"], [\n    (link.address, dai.address),\n    (2*10**18,  10**18),\n    10**13\n])\n```\n\nNo one can buy dai with link.\n\n```python\n# (address tokenIn, address tokenOut, address recipient, bool unwrapBento, uint256 amountIn)\nprevious_balance = bento.functions.balanceOf(dai.address, admin).call()\nswap_amount =  10**18\n\nbento.functions.transfer(link.address, admin, pool.address, swap_amount).transact()\npool.functions.swap(\n    encode_abi(\n        ['address', 'address', 'address', 'bool', 'uint256'],\n        [link.address, dai.address, admin, False, swap_amount]\n    )\n).transact()\ncurrent_balance = bento.functions.balanceOf(dai.address, admin).call()\ntoken_received = current_balance - previous_balance\n# always = 0\nprint(token_received)\n```\n\n#### Recommended Mitigation Steps\nThe brackets of `for` were missed.\n\n```solidity\nfunction _pow(uint256 a, uint256 n) internal pure returns (uint256 output) {\n    output = n % 2 != 0 ? a : BASE;\n    for (n /= 2; n != 0; n /= 2) {\n        a = a * a;\n        if (n % 2 != 0) output = output * a;\n    }\n}\n```\n\n## [[H-03] `IndexPool` pow overflows when `weightRatio` > 10.](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/28)\n_Submitted by broccoli_\n\n#### Impact\nIn the `IndexPool` contract, pow is used in calculating price. ([`IndexPool.sol` L255-L266](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/IndexPool.sol#L255-L266)).\nHowever, Pow is easy to cause overflow. If the `weightRatio` is large (e.g. 10), there's always overflow.\n\nLp providers can still provide liquidity to the pool where no one can swap. All pools need to redeploy. I consider this a high-risk issue.\n\n#### Proof of concept\nIt's easy to trigger this bug by deploying a 1:10 `IndexPool`.\n\n```python\ndeployed_code = encode_abi([\"address[]\",\"uint136[]\",\"uint256\"], [\n    (link.address, dai.address),\n    (10**18, 10 * 10**18),\n    10**13\n])\ntx_hash = master_deployer.functions.deployPool(index_pool_factory.address, deployed_code).transact()\n```\n\nTransactions would be reverted when buying `link` with `dai`.\n\n#### Recommended Mitigation Steps\nThe `weightRatio` is an 18 decimals number. It should be divided by `(BASE)^exp`. The scale in the contract is not consistent. Recommend the dev to check all the scales/ decimals.\n\n**[maxsam4 (Sushi) confirmed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/28)**\n\n\n## [[H-04] IndexPool's `INIT_POOL_SUPPLY` is not fair.](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/29)\n_Submitted by broccoli, also found by WatchPug_\n\n#### Impact\nThe `indexPool` mint `INIT_POOL_SUPPLY` to address 0 in the constructor. However, the value of the burned lp is decided by the first lp provider. According to the formula in [`IndexPool.sol` L106](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/IndexPool.sol#L106).\n\n`AmountIn = first_lp_amount / INIT_POOL_SUPPLY` and the burned lp worth = `AmountIn * (INIT_POOL_SUPPLY) / (first_lp_amount + INIT_POOL_SUPPLY)`.\nIf a pool is not initialized with optimal parameters, it would be a great number of tokens been burn. All lp providers in the pool would receive less profit.\n\nThe optimal parameter is `10**8`. It's likely no one would initialize with `10**8` wei in most pools. I consider this is a high-risk issue.\n\n#### Proof of concept\nThere are two scenarios that the first lp provider can do. The lp provider provides the same amount of token in both cases. However, in the first scenario, he gets about `10 ** 18 * 10**18` lp while in the other scenario he gets `100 * 10**18` lp.\n\n```python\ndeposit_amount = 10**18\nbento.functions.transfer(link.address, admin, pool.address, deposit_amount).transact()\nbento.functions.transfer(dai.address, admin, pool.address, deposit_amount).transact()\npool.functions.mint(encode_abi(\n    ['address', 'uint256'],\n    [admin, 10**8] # minimum\n)).transact()\npool.functions.mint(encode_abi(\n    ['address', 'uint256'],\n    [admin, 10000000000009999 * 10** 20]\n)).transact()\n```\n\n```python\ndeposit_amount = 10**18\nbento.functions.transfer(link.address, admin, pool.address, deposit_amount).transact()\nbento.functions.transfer(dai.address, admin, pool.address, deposit_amount).transact()\npool.functions.mint(encode_abi(\n    ['address', 'uint256'],\n    [admin, deposit_amount * 100]\n)).transact()\n```\n\n#### Recommended Mitigation Steps\nRecommend to handle `INIT_POOL_SUPPLY` in uniswap-v2's way. Determine an optimized parameter for the user would be a better UX design.\n\n## [[H-05] hybrid pool uses wrong `non_optimal_mint_fee`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/31)\n_Submitted by broccoli_\n\n#### Impact\nWhen an lp provider deposits an imbalance amount of token, a swap fee is applied. `HybridPool` uses the same `_nonOptimalMintFee` as `constantProductPool`; however, since two pools use different AMM curve, the ideal balance is not the same.  ref: [`StableSwap3Pool.vy` L322-L337](https://github.com/curvefi/curve-contract/blob/master/contracts/pools/3pool/StableSwap3Pool.vy#L322-L337)\n\nStable swap Pools are designed for 1B+ TVL. Any issue related to pricing/fee is serious. I consider this is a high-risk issue\n\n#### Proof of Concept\n- [StableSwap3Pool.vy#L322-L337](https://github.com/curvefi/curve-contract/blob/master/contracts/pools/3pool/StableSwap3Pool.vy#L322-L337)\n- [HybridPool.sol#L425-L441](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/HybridPool.sol#L425-L441)\n\n\n#### Recommended Mitigation Steps\nCalculate the swapping fee based on the stable swap curve. refer to [StableSwap3Pool.vy#L322-L337](https://github.com/curvefi/curve-contract/blob/master/contracts/pools/3pool/StableSwap3Pool.vy#L322-L337).\n\n\n**[maxsam4 (Sushi) confirmed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/31)**\n\n## [[H-06] `IndexPool`:  Poor conversion from Balancer V1's corresponding functions](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/40)\n_Submitted by GreyArt_\n\n##### Impact\nA number of functions suffer from the erroneous conversion of Balancer V1's implementation.\n\n*   `_compute()` (equivalent to Balancer's [`bpow()`](https://github.com/balancer-labs/balancer-core/blob/master/contracts/BNum.sol#L108-L126))\n    *   `if (remain == 0) output = wholePow;` when a return statement should be used instead.\n*   `_computeSingleOutGivenPoolIn()` (equivalent to Balancer's [`_calcSingleOutGivenPoolIn()`](https://github.com/balancer-labs/balancer-core/blob/master/contracts/BMath.sol#L195-L224))\n    *   `tokenOutRatio` should be calculated with `_compute()` instead of `_pow()`\n    *   `zaz` should be calculated with `_mul()` instead of the native `*`\n*   `_pow()` (equivalent to Balancer's [`bpowi()`](https://github.com/balancer-labs/balancer-core/blob/master/contracts/BNum.sol#L89-L103))\n    *   Missing brackets `{}` for the for loop causes a different interpretation\n    *   `_mul` should be used instead of the native `*`\n\n##### Recommended Mitigation Steps\nThe fixed implementation is provided below.\n\n```jsx\nfunction _computeSingleOutGivenPoolIn(\n  uint256 tokenOutBalance,\n  uint256 tokenOutWeight,\n  uint256 _totalSupply,\n  uint256 _totalWeight,\n  uint256 toBurn,\n  uint256 _swapFee\n) internal pure returns (uint256 amountOut) {\n    uint256 normalizedWeight = _div(tokenOutWeight, _totalWeight);\n    uint256 newPoolSupply = _totalSupply - toBurn;\n    uint256 poolRatio = _div(newPoolSupply, _totalSupply);\n    uint256 tokenOutRatio = _compute(poolRatio, _div(BASE, normalizedWeight));\n    uint256 newBalanceOut = _mul(tokenOutRatio, tokenOutBalance);\n    uint256 tokenAmountOutBeforeSwapFee = tokenOutBalance - newBalanceOut;\n    uint256 zaz = _mul(BASE - normalizedWeight, _swapFee);\n    amountOut = _mul(tokenAmountOutBeforeSwapFee, (BASE - zaz));\n}\n\nfunction _compute(uint256 base, uint256 exp) internal pure returns (uint256 output) {\n  require(MIN_POW_BASE <= base && base <= MAX_POW_BASE, \"INVALID_BASE\");\n\n  uint256 whole = (exp / BASE) * BASE;\n  uint256 remain = exp - whole;\n  uint256 wholePow = _pow(base, whole / BASE);\n\n  if (remain == 0) return wholePow;\n\n  uint256 partialResult = _powApprox(base, remain, POW_PRECISION);\n  output = _mul(wholePow, partialResult);\n}\n\nfunction _pow(uint256 a, uint256 n) internal pure returns (uint256 output) {\n  output = n % 2 != 0 ? a : BASE;\n  for (n /= 2; n != 0; n /= 2) {\n\t\ta = _mul(a, a);\n    if (n % 2 != 0) output = _mul(output, a);\n\t}\n}\n```\n\n**[maxsam4 (Sushi) acknowledged](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/40)**\n\n## [[H-07] `IndexPool.mint` The first liquidity provider is forced to supply assets in the same amount, which may cause a significant amount of fund loss](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/72)\n_Submitted by WatchPug, also found by broccoli_\n\nWhen `reserve == 0`, `amountIn` for all the tokens will be set to the same amount: `ratio`, regardless of the weights, decimals and market prices of the assets.\n\nThe first liquidity provider may not be aware of this so that it may create an arbitrage opportunity for flashbots to take a significant portion of the value of The first liquidity provider's liquidity.\n\n\n[`IndexPool.sol#L93` L105](https://github.com/sushiswap/trident/blob/6bd4c053b6213ffc612987eb565aa3813d5f0d13/contracts/pool/IndexPool.sol#L93-L105)\n```solidity\n/// @dev Mints LP tokens - should be called via the router after transferring `bento` tokens.\n/// The router must ensure that sufficient LP tokens are minted by using the return value.\nfunction mint(bytes calldata data) public override lock returns (uint256 liquidity) {\n    (address recipient, uint256 toMint) = abi.decode(data, (address, uint256));\n\n    uint120 ratio = uint120(_div(toMint, totalSupply));\n\n    for (uint256 i = 0; i < tokens.length; i++) {\n        address tokenIn = tokens[i];\n        uint120 reserve = records[tokenIn].reserve;\n        // @dev If token balance is '0', initialize with `ratio`.\n        uint120 amountIn = reserve != 0 ? uint120(_mul(ratio, reserve)) : ratio;\n        require(amountIn >= MIN_BALANCE, \"MIN_BALANCE\");\n        // @dev Check Trident router has sent `amountIn` for skim into pool.\n        unchecked {\n            // @dev This is safe from overflow - only logged amounts handled.\n            require(_balance(tokenIn) >= amountIn + reserve, \"NOT_RECEIVED\");\n            records[tokenIn].reserve += amountIn;\n        }\n        emit Mint(msg.sender, tokenIn, amountIn, recipient);\n    }\n    _mint(recipient, toMint);\n    liquidity = toMint;\n}\n```\n\n##### Proof of Concept\nGiven:\n\n*   A `IndexPool` of 99% USDT and 1% WBTC;\n*   Alice is the first liquidity provider.\n\n1.  Alice transfers 1e18 WBTC and 1e18 USDT to mint 100e18 of liquidity;\n2.  Bob can use 100e18 USDT (\\~\\$100) to swap out most of the balance of WBTC.\n\n##### Impact\nA significant portion (>90% in the case above) of the user's funds can be lost due to arbitrage.\n\n##### Recommendation\nConsider allowing the first liquidity provider to use custom `amountIn` values for each token or always takes the MIN_BALANCE of each token.\n\n## [[H-08] `HybridPool`'s reserve is converted to \"amount\" twice](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/101)\n_Submitted by cmichel, also found by 0xsanson and WatchPug_\n\nThe `HybridPool`'s reserves are stored as Bento \"amounts\" (not Bento shares) in `_updateReserves` because `_balance()` converts the current share balance to amount balances.\nHowever, when retrieving the `reserve0/1` storage fields in `_getReserves`, they are converted to amounts a second time.\n\n#### Impact\nThe `HybridPool` returns wrong reserves which affects all minting/burning and swap functions.\nThey all return wrong results making the pool eventually economically exploitable or leading to users receiving less tokens than they should.\n\n#### POC\nImagine the current Bento amount / share price being `1.5`.\nThe pool's Bento *share* balance being `1000`.\n`_updateReserves` will store a reserve of `1.5 * 1000 = 1500`.\nWhen anyone trades using the `swap` function, `_getReserves()` is called and multiplies it by `1.5` again, leading to using a reserve of 2250 instead of 1500.\nA higher reserve for the output token leads to receiving more tokens as the swap output.\nThus the pool lost tokens and the LPs suffer this loss.\n\n#### Recommended Mitigation Steps\nMake sure that the reserves are in the correct amounts.\n\n**[maxsam4 (Sushi) confirmed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/101)**\n\n## [[H-09] Unsafe cast in `IndexPool` mint leads to attack](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/77)\n_Submitted by cmichel, also found by cmichel and pauliax_\n\nThe `IndexPool.mint` function performs an unsafe cast of `ratio` to the `uint120` type:\n\n```solidity\nuint120 ratio = uint120(_div(toMint, totalSupply));\n```\n\nNote that `toMint` is chosen by the caller and when choosing `toMint = 2**120 * totalSupply / BASE`, the `ratio` variable will be `2**120` and then truncated to 0 due to the cast.\n\nThis allows an attacker to mint LP tokens for free.\nThey just need to choose the `ratio` such that the `amountIn = ratio * reserve / BASE` variable passes the `require(amountIn >= MIN_BALANCE, \"MIN_BALANCE\");` check.\nFor example, when choosing `ratio = 2**120 * totalSupply / BASE + 1e16`, an attacker has to pay 1/100th of the current reserves but heavily inflates the LP token supply.\n\nThey can then use the inflated LP tokens they received in `burn` to withdraw the entire pool reserves.\n\n#### POC\nI created [this POC](https://gist.github.com/MrToph/0c8b6b5ffac0673b2f72412cf4b0b099) that implements a hardhat test and shows how to steal the pool tokens:\n\n#### Impact\nAn attacker can inflate the LP token pool supply and mint themselves a lot of LP tokens by providing almost no tokens themselves.\nThe entire pool tokens can be stolen.\n\n#### Recommended Mitigation Steps\nEven though Solidity 0.8.x is used, type casts do not throw an error.\nA [`SafeCast` library](https://docs.openzeppelin.com/contracts/4.x/api/utils#SafeCast) must be used everywhere a typecast is done.\n\n\n**[maxsam4 (Sushi) confirmed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/126)**\n\n## [[H-10] `IndexPool` initial LP supply computation is wrong](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/78)\n_Submitted by cmichel_\n\nThe `IndexPool.constructor` function already mints `INIT_POOL_SUPPLY = 100 * 1e18 = 1e20` LP tokens to the zero address.\n\nWhen trying to use the pool, someone has to provide the actual initial reserve tokens in `mint`.\nOn the first `mint`, the pool reserves are zero and the token amount required to mint is just this `ratio` itself: `uint120 amountIn = reserve != 0 ? uint120(_mul(ratio, reserve)) : ratio;`\n\nNote that the `amountIn` is **independent of the token** which does not make much sense.\nThis implies that all tokens must be provided in equal \"raw amounts\", regardless of their decimals and value.\n\n#### POC\n\n###### Issue 1\n\nImagine I want to create a DAI/WBTC pool.\nIf I want to initialize the pool with 100\\$ of DAI, `amountIn = ratio` needs to be `100*1e18=1e20` as DAI has 18 decimals.\nHowever, I now also need to supply `1e20` of WBTC (which has 8 decimals) and I'd need to pay `1e20/1e8 * priceOfBTC`, over a quadrillion dollars to match it with the 100\\$ of DAI.\n\n###### Issue 2\n\nEven in a pool where all tokens have the same decimals and the same value, like `USDC <> USDT`, it leads to issues:\n\n*   Initial minter calls `mint` with `toMint = 1e20` which sets `ratio = 1e20 * 1e18 / 1e20 = 1e18` and thus `amountIn = 1e18` as well. The total supply increases to `2e20`.\n*   Second minter needs to pay **less** tokens to receive the same amount of `1e18` LP tokens as the first minter. This should never be the case. `toMint = 1e20` => `ratio = 1e20 * 1e18 / 2e20 = 0.5e18`. Then `amountIn = ratio * reserve / 1e18 = 0.5*reserve = 0.5e18`. They only pay half of what the first LP provider had to pay.\n\n#### Impact\n\nIt's unclear why it's assumed that the pool's tokens are all in equal value - this is *not* a StableSwap-like pool.\n\nAny pool that uses tokens that don't have the same value and share the same decimals cannot be used because initial liquidity cannot be provided in an economically justifiable way.\n\nIt also leads to issues where the second LP supplier has to pay **less tokens** to receive the exact same amount of LP tokens that the initial minter receives. They can steal from the initial LP provider by burning these tokens again.\n\n#### Recommended Mitigation Steps\nDo not mint the initial token supply to the zero address in the constructor.\n\nDo it like Uniswap/Balancer and let the first liquidity provider provide arbitrary token amounts, then mint the initial pool supply.\nIf `reserve == 0`, `amountIn` should just take the pool balances that were transferred to this account.\n\nIn case the initial mint to the zero address in the constructor was done to prevent the \"Uniswap-attack\" where the price of a single wei of LP token can be very high and price out LPs, send a small fraction of this initial LP supply (\\~1000) to the zero address **after** it was minted to the first supplier in `mint`.\n\n[maxsam4 (Sushi) confirmed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/78)\n\n## [[H-11] `ConstantProductPool.burnSingle` swap amount computations should use balance](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/96)\n_Submitted by cmichel_\n\nThe `ConstantProductPool.burnSingle` function is basically a `burn` followed by a `swap` and must therefore act the same way as calling these two functions sequentially.\n\nThe token amounts to redeem (`amount0`, `amount1`) are computed on the **balance** (not the reserve).\nHowever, the swap amount is then computed on the **reserves** and not the balance.\nThe `burn` function would have updated the `reserve` to the balances and therefore `balance` should be used here:\n\n```solidity\namount1 += _getAmountOut(amount0, _reserve0 - amount0, _reserve1 - amount1);\n```\n\n> ⚠️ The same issue occurs in the `HybridPool.burnSingle`.\n\n#### Impact\nFor a burn, usually the `reserve` should equal the `balance`, however if any new tokens are sent to the contract and `balance > reserve`, this function will return slightly less swap amounts.\n\n#### Recommended Mitigation Steps\nCall `_getAmountOut` with the balances instead of the reserves: `_getAmountOut(amount0, balance0 - amount0, balance1 - amount1)`\n\n**[maxsam4 (Sushi) confirmed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/96#issuecomment-947608322):**\n > Please bump this to High sev. This bug can actually lead to loss of funds from the pool. The author found the right issue but failed to analyze the full impact. Regardless, I think they deserve \"High\" for pointing this out.\n\n**[alcueca (judge) commented](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/96#issuecomment-950561090):**\n > This is what we come to C4 for :clap: :clap: :clap:\n\n## [[H-12] absolute difference is not calculated properly when a > b in MathUtils](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/139)\n_Submitted by hack3r-0m, also found by broccoli_\n\nthe difference is computed incorrectly when a > b. [`MathUtils.sol` L22](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/libraries/MathUtils.sol#L22)\n\nAs it only used in `within1` function, scope narrows down to where `difference(a, b) <= 1;` is exploitable.\n\ncases where `difference(a, b) <= 1` should be true but is reported false:\n\n*   where b = a-1 (returned value is `type(uint256).max`)\n\ncases where `difference(a, b) <= 1` should be false but is reported true:\n\n*   where a = `type(uint256)`.max and b = 0, it returns 1 but it should ideally return `type(uint256).max`\n\n`within1` is used at the following locations:\n*   [`HybridPool.sol` L359](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/HybridPool.sol#L359)\n*   [`HybridPool.sol` L383](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/HybridPool.sol#L383)\n*   [`HybridPool.sol` L413](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/HybridPool.sol#L413)\n\nIt is possible to decrease the denominator and increase the value of the numerator (when calculating y) using constants and input to make `within1` fail\n\nMitigation:\n\nAdd `else` condition to mitigate it.\n```solidity\nunchecked {\n    if (a > b) {\n        diff = a - b;\n    }\n    else {\n        diff = b - a;\n    }\n}\n```\n\n**[maxsam4 (Sushi) confirmed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/139)**\n\n## [[H-13] Overflow in the `mint` function of `IndexPool` causes LPs' funds to be stolen](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/163)\n_Submitted by broccoli, also found by WatchPug_\n\n#### Impact\nIt is possible to overflow the addition in the balance check (i.e., `_balance(tokenIn) >= amountIn + reserve`) in the mint function by setting the `amountIn` to a large amount. As a result, the attacker could gain a large number of LP tokens by not even providing any liquidity. The attacker's liquidity would be much greater than any other LPs, causing him could effectively steal others' funds by burning his liquidity (since the funds he receives are proportional to his liquidity).\n\n#### Proof of Concept\n- [mint_overflow.js](https://gist.github.com/x9453/7a423aef223c1b86442206e3248d318c)\n\nReferenced code:\n- [IndexPool.sol L110](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/IndexPool.sol#L110)\n\n#### Recommended Mitigation Steps\nConsider removing the `uncheck` statement to prevent integer overflows from happening.\n\n**[maxsam4 (Sushi) acknowledged](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/163#issuecomment-935750061):**\n > FWIW The problem here isn't that we used unchecked but that we didn't cast amountIn to uint256. It's possible to overflow uint120 but not uint256.\n\n## [[H-14] Incorrect usage of `_pow` in `_computeSingleOutGivenPoolIn` of `IndexPool`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/165)\n_Submitted by broccoli_\n\n#### Impact\nThe `_computeSingleOutGivenPoolIn` function of `IndexPool` uses the `_pow` function to calculate `tokenOutRatio` with the exponent in `WAD` (i.e., in 18 decimals of precision). However, the `_pow` function assumes that the given exponent `n` is not in `WAD`. (for example, `_pow(5, BASE)` returns `5 ** (10 ** 18)` instead of `5 ** 1`). The misuse of the `_pow` function could causes an integer overflow in the `_computeSingleOutGivenPoolIn` function and thus prevent any function from calling it.\n\n#### Proof of Concept\nReferenced code:\n[IndexPool.sol#L279](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/IndexPool.sol#L279)\n\n#### Recommended Mitigation Steps\nChange the `_pow` function to the `_compute` function, which supports exponents in `WAD`.\n\n**[maxsam4 (Sushi) confirmed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/165)**\n\n## [[H-15] Incorrect multiplication in `_computeSingleOutGivenPoolIn` of `IndexPool`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/166)\n_Submitted by broccoli_\n\n#### Impact\nThe `_computeSingleOutGivenPoolIn` function of `IndexPool` uses the raw multiplication (i.e., `*`) to calculate the `zaz` variable. However, since both `(BASE - normalizedWeight)` and `_swapFee` are in `WAD`, the `_mul` function should be used instead to calculate the correct value of `zaz`. Otherwise, `zaz` would be `10 ** 18` times larger than the expected value and causes an integer underflow when calculating `amountOut`. The incorrect usage of multiplication prevents anyone from calling the function successfully.\n\n#### Proof of Concept\nReferenced code:\n[IndexPool.sol#L282](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/IndexPool.sol#L282)\n\n#### Recommended Mitigation Steps\nChange `(BASE - normalizedWeight) * _swapFee` to `_mul((BASE - normalizedWeight), _swapFee)`.\n\n **[maxsam4 (Sushi) confirmed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/166)**\n\n## [[H-16] Funds in the pool could be stolen by exploiting `flashSwap` in `HybridPool`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/167)\n_Submitted by broccoli_\n\n#### Impact\nAn attacker can call the `bento.harvest` function during the callback function of a flash swap of the `HybridPool` to reduce the number of input tokens that he has to pay to the pool, as long as there is any unrealized profit in the strategy contract of the underlying asset.\n\n#### Proof of Concept\n1.  The `HybridPool` accounts for the reserve and balance of the pool using the `bento.toAmount` function, which represents the actual amount of assets that the pool owns instead of the relative share. The value of `toAmount` could increase or decrease if the `bento.harvest` function is called (by anyone), depending on whether the strategy contract earns or loses money.\n2.  Supposing that the DAI strategy contract of `Bento` has a profit not accounted for yet. To account for the profit, anyone could call `harvest` on `Bento` with the corresponding parameters, which, as a result, increases the `elastic` of the DAI token.\n3.  Now, an attacker wants to utilize the unrealized profit to steal funds from a DAI-WETH hybrid pool. He calls `flashSwap` to initiate a flash swap from WETH to DAI. First, the pool transfers the corresponding amount of DAI to him, calls the `tridentSwapCallback` function on the attacker's contract, and expects that enough DAI is received at the end.\n4.  During the `tridentSwapCallback` function, the attacker calls `bento.harvest` to realize the profit of DAI. As a result, the pool's `bento.toAmount` increases, and the amount of DAI that the attacker has to pay to the pool is decreased. The attacker could get the same amount of ETH but paying less DAI by exploiting this bug.\n\nReferenced code:\n* [`HybridPool.sol` L218-L220](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/HybridPool.sol#L218-L220)\n* [`HybridPool.sol` L249-L250](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/HybridPool.sol#L249-L250)\n* [`HybridPool.sol` L272-L285](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/pool/HybridPool.sol#L272-L285)\n* [`BentoBoxV1Flat.sol` L1105](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/flat/BentoBoxV1Flat.sol#L1105)\n* [`BentoBoxV1Flat.sol` L786-L792](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/flat/BentoBoxV1Flat.sol#L786-L792)\n* [`BentoBoxV1Flat.sol` L264-L277](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/flat/BentoBoxV1Flat.sol#L264-L277)\n\n#### Recommended Mitigation Steps\nConsider not using `bento.toAmount` to track the reservers and balances, but use `balanceOf` instead (as done in the other two pools).\n\n**[maxsam4 (Sushi) confirmed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/167#issuecomment-935717783):**\n > Stableswap needs to use `toAmount` balances rather shares to work. This issue allows skimming yield profits from the pool. There's no user funds at risk but still an issue.\n>\n> We plan on resolving this by using a fixed toElastic ratio during the whole swap.\n\n# Medium Risk Findings (10)\n\n## [[M-01] No bar fees for `IndexPools`?](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/181)\n_Submitted by 0xsanson, also found by pauliax_\n\n#### Impact\n`IndexPool` doesn't collect fees for `barFeeTo`. Since this Pool contains also a method `updateBarFee()`, probably this is an unintended behavior.\nAlso without a fee, liquidity providers would probably ditch `ConstantProductPool` in favor of `IndexPool` (using the same two tokens with equal weights), since they get all the rewards. This would constitute an issue for the ecosystem.\n\n#### Recommended Mitigation Steps\nAdd a way to send `barFees` to `barFeeTo`, same as the other pools.\n\n**[maxsam4 (Sushi) confirmed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/181)**\n\n## [[M-02] `ConstantProductPool` & `HybridPool`: Adding and removing unbalanced liquidity yields slightly more tokens than swap](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/34)\n_Submitted by GreyArt, also found by broccoli_\n\n##### Impact\nA mint fee is applied whenever unbalanced liquidity is added, because it is akin to swapping the excess token amount for the other token.\n\nHowever, the current implementation distributes the minted fee to the minter as well (when he should be excluded). It therefore acts as a rebate of sorts.\n\nAs a result, it makes adding and removing liquidity as opposed to swapping directly (negligibly) more desirable. An example is given below using the Constant Product Pool to illustrate this point. The Hybrid pool exhibits similar behaviour.\n\n##### Proof of Concept\n1.  Initialize the pool with ETH-USDC sushi pool amounts. As of the time of writing, there is roughly 53586.556 ETH and 165143020.5295 USDC.\n2.  Mint unbalanced LP with 5 ETH (& 0 USDC). This gives the user `138573488720892 / 1e18` LP tokens.\n3.  Burn the minted LP tokens, giving the user 2.4963 ETH and 7692.40 USDC. This is therefore equivalent to swapping 5 - 2.4963 = 2.5037 ETH for 7692.4044 USDC.\n4.  If the user were to swap the 2.5037 ETH directly, he would receive 7692.369221 (0.03 USDC lesser).\n\n##### Recommended Mitigation Steps\nThe mint fee should be distributed to existing LPs first, by incrementing `_reserve0` and `_reserve1` with the fee amounts. The rest of the calculations follow after.\n\n`ConstantProductPool`\n\n```jsx\n(uint256 fee0, uint256 fee1) = _nonOptimalMintFee(amount0, amount1, _reserve0, _reserve1);\n// increment reserve amounts with fees\n_reserve0 += uint112(fee0);\n_reserve1 += uint112(fee1);\nunchecked {\n    _totalSupply += _mintFee(_reserve0, _reserve1, _totalSupply);\n}\nuint256 computed = TridentMath.sqrt(balance0 * balance1);\n...\nkLast = computed;\n```\n\n`HybridPool`\n\n```jsx\n(uint256 fee0, uint256 fee1) = _nonOptimalMintFee(amount0, amount1, _reserve0, _reserve1);\n// increment reserve amounts with fees\n_reserve0 += uint112(fee0);\n_reserve1 += uint112(fee1);\nuint256 newLiq = _computeLiquidity(balance0, balance1);\n...\n```\n\n**[maxsam4 (Sushi) confirmed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/34)**\n\n## [[M-03] Router would fail when adding liquidity to index Pool](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/68)\n_Submitted by broccoli_\n\n#### Impact\n`TridentRouter` is easy to fail when trying to provide liquidity to an index pool.\n\nUsers would not get extra lp if they are not providing lp at the pool's spot price. It's the same design as uniswap v2. However, uniswap's v2 handle's the dirty part.\n\nUsers would not lose tokens if they use the router ([`UniswapV2Router02.sol` L61-L76](https://github.com/Uniswap/v2-periphery/blob/master/contracts/UniswapV2Router02.sol#L61-L76)).\n\nHowever, the router wouldn't stop users from transferring extra tokens ([`TridentRouter.sol` L168-L190](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/TridentRouter.sol#L168-L190)).\n\nSecond, the price would possibly change when the transaction is confirmed. This would be reverted in the index pool.\n\nUsers would either transfer extra tokens or fail. I consider this is a medium-risk issue.\n\n#### Proof of Concept\n[TridentRouter.sol#L168-L190](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/TridentRouter.sol#L168-L190)\n\nA possible scenario:\n\nThere's a BTC/USD pool. BTC = 50000 USD.\n\n1.  A user sends a transaction to transfer 1 BTC and 50000 USD.\n2.  After the user send a transaction, a random bot buying BTC with USD.\n3.  The transaction at step 1 is mined. Since the BTC price is not 50000 USD, the transaction fails.\n\n#### Recommended Mitigation Steps\nPlease refer to the uniswap v2 router in [`UniswapV2Router02.sol` L61-L76](https://github.com/Uniswap/v2-periphery/blob/master/contracts/UniswapV2Router02.sol#L61-L76)\n\nThe router should calculate the optimal parameters for users.\n\n**[maxsam4 (Sushi) confirmed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/68)**\n\n## [[M-04] Router's `complexPath` percentagePaths don't work as expected](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/87)\n_Submitted by cmichel_\n\nThe `TridentRouter.complexPath` function allows splitting a trade result into several buckets and trade them in a different pool each.\nThe distribution is defined by the `params.percentagePath[i].balancePercentage` values:\n\n```solidity\nfor (uint256 i; i < params.percentagePath.length; i++) {\n    uint256 balanceShares = bento.balanceOf(params.percentagePath[i].tokenIn, address(this));\n    uint256 transferShares = (balanceShares * params.percentagePath[i].balancePercentage) / uint256(10)**8;\n    bento.transfer(params.percentagePath[i].tokenIn, address(this), params.percentagePath[i].pool, transferShares);\n    isWhiteListed(params.percentagePath[i].pool);\n    IPool(params.percentagePath[i].pool).swap(params.percentagePath[i].data);\n}\n```\n\nHowever, the base value `bento.balanceOf(params.percentagePath[i].tokenIn, address(this));` is recomputed after each iteration instead of caching it before the loop.\n\nThis leads to not all tokens being used even though the percentages add up to 100%.\n\n#### POC\nAssume I want to trade 50% DAI to WETH and the other 50% DAI to WBTC.\nIn the first iteration, `balanceShares` is computed and then 50% of it is swapped in the first pool.\n\nHowever, in the second iteration, `balanceShares` is updated again, and only 50% **of the remaining** (instead of the total) balance, i.e. 25%, is traded.\n\nThe final 25% are lost and can be skimmed by anyone afterwards.\n\n#### Impact\nUsers can lose their funds using `complexPath`.\n\n#### Recommended Mitigation Steps\nCache the `balanceShares` value once before the second `for` loop starts.\n\n**[sarangparikh22 (Sushi) disputed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/87#issuecomment-934546115):**\n > This is not the correct way to calculate the complexPath swap parameters.\n> For instance, if we need to swap 50% DAI to WETH and the other 50% DAI to WBTC, we would keep percentages as 50 and 100, instead of 50-50 as described above. If the user enters wrong percentages, they would loose funds.\n\n**[alcueca (judge) commented](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/87#issuecomment-950522743):**\n > The format for entering the percentages is not documented. Sustained as Sev 2 as the lack of documentation on this parameter could lead to loss of funds.\n\n## [[M-05] `_depositToBentoBox` sometimes uses both ETH and WETH](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/89)\n_Submitted by cmichel, also found by 0xRajeev_\n\nThe `TridentRouter._depositToBentoBox` function only uses the `ETH` in the contract if it's higher then the desired `underlyingAmount` (`address(this).balance >= underlyingAmount)`).\n\nOtherwise, the ETH is ignored and the function uses WETH from the user.\n\n#### Impact\nNote that the `underlyingAmount = bento.toAmount(wETH, amount, true)` is computed from the Bento share price and it might happen that it increases from the time the transaction was submitted to the time the transaction is included in a block.\nIn that case, it might completely ignore the sent `ETH` balance from the user and in addition transfer the same amount of `WETH` from the user.\n\nThe user can lose their `ETH` deposit in the contract.\n\n#### Recommended Mitigation Steps\nEach batch must use `refundETH` at the end.\n\nFurthermore, we recommend still depositing `address(this).balance` ETH into Bento and if it's less than `underlyingAmount` use `WETH` only for **the remaining token difference**.\n\n**[maxsam4 (Sushi) acknowledged](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/89)**\n\n## [[M-06] `withdrawFromWETH` always reverts ](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/90)\n_Submitted by cmichel_\n\nThe `TridentHelper.withdrawFromWETH` (used in `TridentRouter.unwrapWETH`) function performs a low-level call to `WETH.withdraw(amount)`.\n\nIt then checks if the return `data` length is more or equal to `32` bytes, however `WETH.withdraw` returns `void` and has a return value of `0`.\nThus, the function always reverts even if `success == true`.\n\n```solidity\nfunction withdrawFromWETH(uint256 amount) internal {\n    // @audit WETH.withdraw returns nothing, data.length always zero. this always reverts\n    require(success && data.length >= 32, \"WITHDRAW_FROM_WETH_FAILED\");\n}\n```\n\n#### Impact\nThe `unwrapWETH` function is broken and makes all transactions revert.\nBatch calls to the router cannot perform any unwrapping of WETH.\n\n#### Recommended Mitigation Steps\nRemove the `data.length >= 32` from the require and only check if `success` is true.\n\n**[sarangparikh22 (Sushi) confirmed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/90)**\n\n## [[M-07] `HybridPool`'s `flashSwap` sends entire fee to `barFeeTo`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/99)\n_Submitted by cmichel, also found by 0xsanson_\n\nThe `HybridPool.flashSwap` function sends the entire trade fees `fee` to the `barFeeTo`.\nIt should only send `barFee * fee` to the `barFeeTo` address.\n\n#### Impact\nLPs are not getting paid at all when this function is used.\nThere is no incentive to provide liquidity.\n\n#### Recommended Mitigation Steps\nThe `flashSwap` function should use the same fee mechanism as `swap` and only send `barFee * fee / MAX_FEE` to the `barFeeTo`. See `_handleFee` function.\n\n- [maxsam4 (Sushi) confirmed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/99)\n\n## [[M-08] Rounding errors will occur for tokens without decimals](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/152)\n\nSome rare tokens have 0 decimals: https://etherscan.io/token/0xcc8fa225d80b9c7d42f96e9570156c65d6caaa25\n\nFor these tokens, small losses of precision will be amplified by the lack of decimals.\n\nConsider a constant product pool with 1000 of token0 (with no decimals), and 1000 of token1 (also with no decimals). Suppose I swap n= 1,2,3,4 of token0 to token1. Then my output amount of token1 will be 0,1,2,3.\n\nIf token0/1 are valuable than I will be losing 100%, 50%, 33%, 25% of my trade to rounding.\nCurrently there is no valuable token with 0 decimals, but there may be in the future.\n\nRounding the final `getAmountOut` division upwards would fix this.\n\n**[maxsam4 (Sushi) commented](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/152#issuecomment-946648813):**\n > Acceptable risk. We can't do anything if the token itself doesn't have decimals. We don't create synthetic assets and fractionalize such tokens ourselves.\n\n## [[M-09] Approximations may finish with inaccurate values](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/155)\n_Submitted by 0xsanson, also found by broccoli_\n\n#### Impact\nIn `HybridPool.sol`, functions `_computeLiquidityFromAdjustedBalances`, `_getY` and `_getYD` may finish before approximation converge, since it's limited by `MAX_LOOP_LIMIT` iterations.\nIn this situation the final estimated value will still be treated as correct, even though it could be relatively inaccurate.\n\n#### Recommended Mitigation Steps\nConsider reverting the transactions if this doesn't occur.\nSee https://blog.openzeppelin.com/saddle-contracts-audit/ issue \\[M03], with their relative fix.\n\n## [[M-10] Users are susceptible to back-running when depositing ETH to `TridenRouter`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/179)\n_Submitted by broccoli_\n\n#### Impact\nThe `_depositToBentoBox` and `_depositFromUserToBentoBox` allow users to provide ETH to the router, which is later deposited to the `bento` contract for swapping other assets or providing liquidity. However, in these two functions, the input parameter does not represent the actual amount of ETH to deposit, and users have to calculate the actual amount and send it to the router, causing a back-run vulnerability if there are ETH left after the operation.\n\n#### Proof of Concept\n1.  A user wants to swap ETH to DAI. He calls `exactInputSingleWithNativeToken` on the router with the corresponding parameters and `params.amountIn` being 10. Before calling the function, he calculates `bento.toAmount(wETH, 10, true) = 15` and thus send 15 ETH to the router.\n2.  However, at the time when his transaction is executed, `bento.toAmount(wETH, amount, true)` becomes to `14`, which could happen if someone calls `harvest` on `bento` to update the `elastic` value of the `wETH` token.\n3.  As a result, only 14 ETH is transferred to the pool, and 1 ETH is left in the router. Anyone could back-run the user's transaction to retrieve the remaining 1 ETH from the router by calling the `refundETH` function.\n\nReferenced code: [TridentRouter.sol#L318-L351](https://github.com/sushiswap/trident/blob/9130b10efaf9c653d74dc7a65bde788ec4b354b5/contracts/TridentRouter.sol#L318-L351)\n\n#### Recommended Mitigation Steps\nDirectly push the remaining ETH to the sender to prevent any ETH left in the router.\n\n**[maxsam4 (Sushi) confirmed](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/179#issuecomment-934388751):**\n > I think it's low risk because it's basically arbitrage and we have protection for the user in terms of \"minOutputAmount\". I will be reworking ETH handling to avoid this issue completely.\n\n**[alcueca (judge) commented](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/179#issuecomment-950567287):**\n > It's a loss of funds, not arbitrage. It should be prevented or documented. Sustained.\n\n# Low Risk Findings (39)\n- [[L-01] unchecked use of optional function \"decimals\" of erc20 standards](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/4) _Submitted by hack3r-0m_\n- [[L-02] `ConstantProductPool` lacks zero check for maserDeployer](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/9) _Submitted by hack3r-0m_\n- [[L-03] HybridPool.sol lacks zero check for maserDeployer](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/10) _Submitted by hack3r-0m_\n- [[L-04] `TridentERC20.sol` Possible replay attacks on `permit` function in case of a future chain split](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/18) _Submitted by nikitastupin, also found by 0xRajeev, 0xsanson, broccoli, and t11s_\n- [[L-05] Reset cachedPool ?](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/15) _Submitted by gpersoon_\n- [[L-06] Missing validation of recipient argument could indefinitely lock owner role](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/23) _Submitted by defsec_\n- [[L-07] # Hybrid Pool underflow when a < 100](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/32) _Submitted by broccoli_\n- [[L-08] `HybridPool`: SwapCallback should be done regardless of data.length](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/39) _Submitted by GreyArt_\n- [[L-09] Missing invalid token check against pool address](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/45) _Submitted by 0xRajeev_\n- [[L-10] `barFee` handled incorrectly in `flashSwap` (or swap)](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/46) _Submitted by 0xRajeev_\n- [[L-11] Strict bound in reserve check of Hybrid Pool](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/47) _Submitted by 0xRajeev_\n- [[L-12] Unlocked Solidity compiler pragma is risky](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/49) _Submitted by 0xRajeev, also found by broccoli, hrkrshnn, and JMukesh_\n- [[L-13] Missing zero-address checks](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/52) _Submitted by 0xRajeev_\n- [[L-14] Missing timelock for critical contract setters of privileged roles](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/55) _Submitted by 0xRajeev_\n- [[L-15] Unconditional setting of boolean/address values is risky](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/56) _Submitted by 0xRajeev_\n- [[L-16] Timelock between new owner transfer+claim will reduce risk](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/57) _Submitted by 0xRajeev_\n- [[L-17] Allowing direct single-step ownership transfer even as an option is risky](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/58) _Submitted by 0xRajeev_\n- [[L-18] Missing contract existence check may cause silent failures of token transfers](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/59) _Submitted by 0xRajeev_\n- [[L-19] `IndexPool` should check that tokens are supported](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/82) _Submitted by cmichel_\n- [[L-20] Several low-level calls don't check the success return value](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/91) _Submitted by cmichel_\n- [[L-21] `ConstantProductPool` bar fee computation seems wrong](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/94) _Submitted by cmichel_\n- [[L-22] `ConstantProductPool` mint liquidity computation should include fees](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/95) _Submitted by cmichel_\n- [[L-23] `HybridPool`'s `flashSwap` does not always call callback](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/100) _Submitted by cmichel_\n- [[L-24] The functions `refundETH` and `unwrapWETH` is generalized-front-runnable](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/124) _Submitted by hrkrshnn_\n- [[L-25] Lack of checks for address and amount in `TridentERC20._mint`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/131) _Submitted by GalloDaSballo_\n- [[L-26] Lack of checks for address and amount in `TridentERC20._mint`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/135) _Submitted by GalloDaSballo_\n- [[L-27] Lack of address validation in `MasterDeployer.setMigrator`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/140) _Submitted by GalloDaSballo_\n- [[L-28] Consider using solidity 0.8.8](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/141)\n- [[L-29] lack of input validation in `Transfer()` and `TransferFrom()`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/153) _Submitted by JMukesh_\n- [[L-30] `_powApprox`: unbounded loop and meaning](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/162) _Submitted by 0xsanson_\n- [[L-31] `HybridPool`'s wrong amount to balance conversion](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/164) _Submitted by 0xsanson_\n- [[L-32] `_computeLiquidityFromAdjustedBalances` order of operations can be improved](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/173) _Submitted by 0xsanson_\n- [[L-33] Wrong initialization of `blockTimestampLast` in `ConstantProductPool`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/180) _Submitted by broccoli_\n- [[L-34] Oracle Initialization](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/149)\n- [[L-35] Docs disagrees with index pool code](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/184)\n- [[L-36] Division by zero in `_computeLiquidityFromAdjustedBalances` of `HybridPool`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/185) _Submitted by broccoli_\n- [[L-37] `_getY` and `_getYD` math operations can be reordered](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/174) _Submitted by 0xsanson_\n- [[L-38] Division and division in `_getY` of `HybridPool`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/188) _Submitted by broccoli_\n- [[L-39] Incorrect comparison in the `_updateReserves` function of `HybridPool`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/190) _Submitted by broccoli_\n\n# Non-Critical Findings (20)\n\n- [[N-01] Events not emitted while changing state variables in constructor](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/2) _Submitted by hack3r-0m_\n- [[N-02] `ConstantProductPool`: Move minting of MIN_LIQUIDITY after checks](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/35) _Submitted by GreyArt_\n- [[N-03] Unused constants could indicate missing logic or redundant code](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/43) _Submitted by 0xRajeev, also found by GreyArt_\n- [[N-04] `TridentRouter.isWhiteListed()` Misleading name](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/76) _Submitted by WatchPug_\n- [[N-05] TridentERC20 does not emit Approval event in `transferFrom`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/86) _Submitted by cmichel_\n- [[N-06] `ConstantProductPool.getAmountOut` does not verify token](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/93) _Submitted by cmichel_\n- [[N-07] `HybridPool` missing positive token amount checks for initial mint](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/97) _Submitted by cmichel_\n- [[N-08] `MAX_FEE_SQUARE` dependency on `MAX_FEE`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/104) _Submitted by pauliax_\n- [[N-09] Emit events when setting the values in constructor](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/105) _Submitted by pauliax_\n- [[N-10] Inclusive check of `type(uint128).max`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/107) _Submitted by pauliax_\n- [[N-11] Consider avoiding low level calls to MasterDeployer](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/121) _Submitted by hrkrshnn_\n- [[N-12] Functions that can be made external](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/122) _Submitted by hrkrshnn_\n- [[N-13] Style issues](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/127) _Submitted by pauliax_\n- [[N-14] Lack of address validation in `MasterDeployer.addToWhitelist`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/138) _Submitted by GalloDaSballo_\n- [[N-15] Using interfaces instead of selectors is best practice](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/150)\n- [[N-16] Follow Curve's convention: `_getYD` and `_getY`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/156) _Submitted by 0xsanson_\n- [[N-17] View functions in Hybrid Pool Contract Pool need better documentation](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/175)\n- [[N-18] Inconsistent tokens sent to `barFeeTo`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/177) _Submitted by 0xsanson_\n- [[N-19] Unnecessary condition on `_processSwap` of `HybridPool`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/189) _Submitted by broccoli_\n- [[N-20] Similarly initialized weight thresholds may cause unexpected deployment failures](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/48) _Submitted by 0xRajeev_\n\n# Gas Optimizations (25)\n- [[G-01] Safe gas on `_powApprox`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/12) _Submitted by gpersoon_\n- [[G-02] Use parameter `_blockTimestampLast` in `_update()` ](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/16) _Submitted by gpersoon, also found by 0xsanson_\n- [[G-03] Consider unlocking pool only upon initial mint](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/33) _Submitted by GreyArt_\n- [[G-04] `ConstantProductPool`: Unnecessary mod before casting to uint32](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/37) _Submitted by GreyArt_\n- [[G-05] `IndexPool`: Redundant MAX_WEIGHT](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/41) _Submitted by GreyArt_\n- [[G-06] `TridentOwnable`: `pendingOwner` should be set to address(1) if direct owner transfer is used](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/42) _Submitted by GreyArt_\n- [[G-07] Replace multiple calls with a single new function call](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/60) _Submitted by 0xRajeev_\n- [[G-08] Unused code can be removed to save gas](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/61) _Submitted by 0xRajeev_\n- [[G-09] Use of unchecked can save gas where computation is known to be overflow/underflow safe](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/62) _Submitted by 0xRajeev_\n- [[G-10] Gas: `HybridPool._computeLiquidityFromAdjustedBalances` should return early](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/103) _Submitted by cmichel, also found by 0xRajeev_\n- [[G-11] Avoiding initialization of loop index can save a little gas](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/64) _Submitted by 0xRajeev_\n- [[G-12] Caching in local variables can save gas ](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/65) _Submitted by 0xRajeev_\n- [[G-13] Gas: `HybridPool` unnecessary `balance` computations](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/102) _Submitted by cmichel_\n- [[G-14] Use of `ecrecover` is susceptible to signature malleability](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/51) _Submitted by 0xRajeev_\n- [[G-15] Caching the length in for loops](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/112) _Submitted by hrkrshnn_\n- [[G-16] Consider using custom errors instead of revert strings](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/113) _Submitted by hrkrshnn_\n- [[G-17] Consider changing the `_deployData` architecture](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/114) _Submitted by hrkrshnn_\n- [[G-18] Caching the storage read to `tokens.length`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/115) _Submitted by hrkrshnn_\n- [[G-19] Caching a storage load in TridentERC20](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/116) _Submitted by hrkrshnn_\n- [[G-20] Unused state variable `barFee` and _barFeeTo in `IndexPool`](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/117) _Submitted by hrkrshnn_\n- [[G-21]  Consider putting some parts of `_div` in unchecked](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/118) _Submitted by hrkrshnn_\n- [[G-22] Use `calldata` instead of `memory` for function parameters](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/119) _Submitted by hrkrshnn_\n- [[G-23] Cache array length in for loops can save gas](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/128) _Submitted by WatchPug_\n- [[G-24] Cache storage variable in the stack can save gas](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/129) _Submitted by WatchPug_\n- [[G-25] Using 10**X for constants isn't gas efficient](https://github.com/code-423n4/2021-09-sushitrident-findings/issues/148)\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}