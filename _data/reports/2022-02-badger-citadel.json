{
  "circa": {
    "title": "Badger Citadel contest",
    "sponsor": "BadgerDAO",
    "slug": "2022-02-badger-citadel",
    "date": "2022-04-22",
    "findings": "https://github.com/code-423n4/2022-02-badger-citadel-findings/issues",
    "contest": 84
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Badger Citadel smart contract system written in Solidity. The audit contest took place between February 4—February 6 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>40 Wardens contributed reports to the Badger Citadel contest:</p>\n<ol>\n<li>Czar102</li>\n<li>gellej</li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li><a href=\"https://github.com/TomAFrench\">TomFrenchBlockchain</a></li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li>pedroais</li>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li><a href=\"https://tqts.ar/\">tqts</a></li>\n<li>0x1f8b</li>\n<li><a href=\"https://twitter.com/SirH4shalot\">sirhashalot</a></li>\n<li>hyh</li>\n<li>harleythedog</li>\n<li><a href=\"https://twitter.com/HickupH\">hickuphh3</a></li>\n<li>cccz</li>\n<li>hubble (ksk2345 and shri4net)</li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li>p4st13r4 (<a href=\"https://github.com/0x69e8\">0x69e8</a> and 0xb4bb4)</li>\n<li>0x0x0x</li>\n<li>IllIllI</li>\n<li><a href=\"https://twitter.com/JustDravee\">Dravee</a></li>\n<li><a href=\"https://twitter.com/ori_dabush\">OriDabush</a></li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>NoamYakov</li>\n<li>robee</li>\n<li>floppydisk</li>\n<li>samruna</li>\n<li><a href=\"https://twitter.com/wuwe19\">wuwe1</a></li>\n<li>kenta</li>\n<li>peritoflores</li>\n<li>Jujic</li>\n<li><a href=\"https://www.instagram.com/riyan_rfa/\">rfa</a></li>\n<li><a href=\"https://twitter.com/Man56Post\">PostMan56</a></li>\n<li><a href=\"https://www.linkedin.com/in/yahia-chaabane/\">ych18</a></li>\n<li><a href=\"https://twitter.com/sabtikw\">sabtikw</a></li>\n<li><a href=\"https://twitter.com/Throt7le\">throttle</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/liam_eastwood13\">0xleastwood</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded 3 unique MEDIUM severity vulnerabilities. Additionally, the analysis included 24 reports detailing issues with a risk rating of LOW severity or non-critical as well as 22 reports recommending gas optimizations. All of the issues presented here are linked back to their original finding.</p>\n<p>Notably, 0 vulnerabilities were found during this audit contest that received a risk rating in the category of HIGH severity.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-02-badger-citadel\">C4 Badger Citadel contest repository</a>, and is composed of 1 smart contract written in the Solidity programming language and includes 384 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"medium-risk-findings-3\" style=\"position:relative;\"><a href=\"#medium-risk-findings-3\" aria-label=\"medium risk findings 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (3)</h1>\n<h2 id=\"m-01-the-owner-and-proxy-admin-can-make-users-lose-funds-rug-vectors\" style=\"position:relative;\"><a href=\"#m-01-the-owner-and-proxy-admin-can-make-users-lose-funds-rug-vectors\" aria-label=\"m 01 the owner and proxy admin can make users lose funds rug vectors permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/50\">[M-01] The Owner and Proxy Admin can make users lose funds (“rug vectors”)</a></h2>\n<p><em>Submitted by gellej, also found by WatchPug, Czar102, csanuragjain, p4st13r4, pedroais, TomFrenchBlockchain, defsec, hubble, gzeon, 0x1f8b, and sirhashalot</em></p>\n<p>The contest explicitly asks to analyze the contract for “Rug Vectors”, so that is what this issue is about.</p>\n<p>I have classified this issue as “high risk” - although the vulnerability is considerable, the attacks themselves are not very likely to occur (they depend on the owner and/or the proxy admin to be compromised). The main reason why I believe the vulnerabiity is “high” is because the very fact that all these factors exist can make the sale fail, as informed users will avoid the contract completely one they realize the extent in which the contract is manipulable.</p>\n<p>In the current implementation, there several ways that investors can lose funds if the owner of the contract is not well behaved. These risks can be divided into two kinds:</p>\n<ul>\n<li>owner becomes unable to act (for example, owner looses her private key, or the owner is a wallet or a DAO and signers cannot agree on the right action to take)</li>\n<li>owner is malicious  (for example, the owner account gets hacked or the signers turn bad), and wants to steal as much as the funds as possible (“Rug Vectors”), or executes a griefing attack (i.e. acts in such a way to hurt the buyers and/or the project, without immediate financial gain)</li>\n</ul>\n<p>The contract is vulnerable to all three types of vulnerabilities (“rug pull”, “griefing” and “inactivity”).</p>\n<p>(1) Loss of funds due to owner inactivity:\n(1a) If the owner does never funds the contract, the buyers will not receive their tokens, and have no recourse to get their investment back\n(1b) If the owner does not call <code>finalize</code>, buyers will not receive their tokens, and and have no recourse to get their investment back</p>\n<p>(2) Griefing attacks by the owner (attacks that that have no immediate gain for the attacker, but are either annoying or lead to loss of funds)\n(2a) the owner can change many essential conditions of the sale: for example, the price, the start time, the duration, the guest list, and the total amount of tokens that are allowed to be sold. The owner can do this at any moment, also <strong>while the sale is in course</strong>. This allows for all kinds of griefing attacks. It also voids the whole point of using a smart contract in the first place.\n(2b) Owner can pause the contract at any time, which will freeze the funds in the contract, as it also disallows users to claim their tokens</p>\n<p>(3) Rug pull by owner (attacks with financial gain for the attacker, buyer loses money)\n(3a) The Owner can call <code>sweep</code> at any time and remove all unsold CTDL tokens while the sale is in progress. Future buyers will still be able to buy tokens, but the sale can never be finalized (unless the owner funds the contract)\n(3b) Owner can front-run buyers and change the price. I.e. the owner can monitor the mem pool for a large <code>buy</code> transaction and precede the transaction with her own transaction that changes the price to a very low one. If the price is low enough, <code>getAmountOut</code> will return <code>0</code>, and the buyers will lose her funds and not receive any CTDL tokens at all.</p>\n<p>(4) Rug pull by proxy Admin\n(4a) Although no deployment script is provided in the repo, we may assume (from the tests and the fact that the contracts are upgradeable) that the actual sale will be deployed as a proxy. The proxy admin (which may not be the same account as the owner) can change the implementation of the contract at any time, and in particular can change the implemention logic in such a way that all the funds held by the contract can be sent to the attacker.</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>In general, I would recommend to not write your own contract at all, but instead use OpenZeppelin’s crowdsale contract: <a href=\"https://docs.openzeppelin.com/contracts/2.x/api/crowdsale#Crowdsale\">https://docs.openzeppelin.com/contracts/2.x/api/crowdsale#Crowdsale</a> which seems to fit your needs pretty well</li>\n<li>To address 1a and 3a, enforce that the contract is funded  with enough CTDL tokens <em>before</em> the sale starts (for example, as part of the initialize logic)</li>\n<li>To adress 1b, simply remove the “onlyOwner” modifier on the “finalize()” function so that it can be called by anyone</li>\n<li>To (partially) address 2a, reduce the extent to which the owner can change the sale conditions during the sale (in any case remove the setSaleStart, setSaleEnd, setTokenInLimit or limit their application to before the sale starts). Ideally, once the sale starts, conditions of the sale remain unchanged, or change in a predictable way</li>\n<li>To address 2b, leave the tokens of the buyer in the contract (instead of sending them to a <code>saleRecipient</code> and implement an <code>emergencyWithdraw</code> function that will work also when the contract is paused, and that allows buyers can use to retrieve their original investment in case something goes wrong</li>\n<li>To address 3a, allow the owner to call <code>sweep</code> only after the sale is finalized</li>\n<li>To address 3b, either do not allow to change the token price during the token sale, or, if you must have this functionality, have the price change take effect only after a delay to make front-running by the owner impossible</li>\n<li>To address 4a, do not deploy the contract as a proxy at all (which seems overkill anyway, given the use case)</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/50#issuecomment-1066631798\">0xleastwood (judge) decreased to Medium severity and commented</a>:</strong></p>\n<blockquote>\n<p>Awesome write-up! </p>\n<p>Because the issue outlined by the warden covers several separate issues from other wardens, I’ll mark this as the primary issue and de-duplicate all other issues.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/50#issuecomment-1069103297\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I’ve thought about this more and I’ve decided to split up distinct issues into 3 primary issues:</p>\n<ul>\n<li>Owner rugs users.</li>\n<li>Funds are transferred to saleRecipient before settlement.</li>\n<li>Changing a token buy price during the sale by front-running buyers by forcing them to purchase at an unfair token price.</li>\n</ul>\n<p>This issue falls under the first primary issue.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-salerecipient-can-rug-buyers\" style=\"position:relative;\"><a href=\"#m-02-salerecipient-can-rug-buyers\" aria-label=\"m 02 salerecipient can rug buyers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/61\">[M-02] <code>saleRecipient</code> can rug buyers</a></h2>\n<p><em>Submitted by WatchPug, also found by gellej, Czar102, hyh, harleythedog, pauliax, cmichel, 0x1f8b, hickuphh3, cccz, and sirhashalot</em></p>\n<p>In <code>TokenSaleUpgradeable.sol#buy()</code>, <code>tokenIn</code> will be transferred from the buyer directly to the <code>saleRecipient</code> without requiring/locking/releasing the corresponding amount of <code>tokenOut</code>.</p>\n<p>This allows the <code>saleRecipient</code> to rug the users simply by not transferring <code>tokenOut</code> and finalizing the sale.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Given:</p>\n<ul>\n<li>tokenIn: <code>WBTC</code></li>\n<li>_tokenOutPrice: <code>1e8</code></li>\n<li>tokenOut: <code>CTDL</code></li>\n<li>Alice <code>buy()</code> with <code>100e8</code>;</li>\n<li>Alice <code>buy()</code> with <code>200e8</code>;</li>\n</ul>\n<p>A malicious <code>saleRecipient</code> can just not transfer any <code>CTDL</code> to the contract and <code>finalize()</code> and keep <code>300e8 WBTC</code> received.</p>\n<p>As a result, Alice and Bob can not get the expected amount of <code>tokensOut</code>, and there is no way to retrieve the WBTC paid, in essence, lose all the funds.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Instead of transferring the tokenIn directing to the <code>saleRecipient</code> in <code>buy()</code>, consider transferring the tokenIn into the contract (<code>address(this)</code>), and require a sufficient amount of <code>tokenOut</code> to be transferred into the contract first before the amount of <code>tokenIn</code> can be released to the <code>saleRecipient</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/61\">shuklaayush (BadgerDAO) disagreed with severity</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/61#issuecomment-1066620627\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>As this is also an issue regarding abuse of an owner’s admin privileges, it fits the criteria of a <code>medium</code> severity issue.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/61#issuecomment-1069067800\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I’ve thought about this more and I’ve decided to split up distinct issues into 3 primary issues:</p>\n<ul>\n<li>Owner rugs users.</li>\n<li>Funds are transferred to <code>saleRecipient</code> before settlement.</li>\n<li>Changing a token buy price during the sale by front-running buyers by forcing them to purchase at an unfair token price.</li>\n</ul>\n<p>This issue falls under the second primary issue.</p>\n<ul>\n<li>Funds are transferred to <code>saleRecipient</code> before settlement.</li>\n</ul>\n</blockquote>\n<hr>\n<h2 id=\"m-03-owner-can-steal-input-tokens\" style=\"position:relative;\"><a href=\"#m-03-owner-can-steal-input-tokens\" aria-label=\"m 03 owner can steal input tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/105\">[M-03] Owner can steal input tokens</a></h2>\n<p><em>Submitted by Czar102, also found by gellej, cmichel, tqts, gzeon, TomFrenchBlockchain, pauliax, and pedroais</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-badger-citadel/blob/main/contracts/TokenSaleUpgradeable.sol#L299-L309\">TokenSaleUpgradeable.sol#L299-L309</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-badger-citadel/blob/main/contracts/TokenSaleUpgradeable.sol#L311-L324\">TokenSaleUpgradeable.sol#L311-L324</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-badger-citadel/blob/main/contracts/TokenSaleUpgradeable.sol#L211-L224\">TokenSaleUpgradeable.sol#L211-L224</a></p>\n<p>Owner is in full control over the <code>saleRecipient</code> address. When a <code>buy()</code> transaction enters the mempool, an owner can frontrun the buy with a transaction that calls <code>setTokenOutPrice()</code> and sets the price to a very high value, effectively making bought tokens close to (if not usually equal) zero and consuming the tokens to the owner-selected address - <code>saleRecipient</code>. Thus, an owner has incentive to perform such attack as they may cause little or zero additional indebtnees to the contract and all tokens to the owner.</p>\n<p>This can also be seen as a coincidence - an owner sets a price while a user broadcasts a <code>buy()</code> transaction. The user may buy for a significantly different price than they intended.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Do not let changing sale price after the sale has started. Do not let changing sale start if the sale has already started.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/105#issuecomment-1031666053\">GalloDaSballo (BadgerDAO) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>I agree with the finding and the conclusion, we shouldn’t let the price change after the sale has started.</p>\n<p>As for the example, that would only work once, because if we actually did that it would immediately warn every other user of our malicious behavior.</p>\n<p>I think the finding is valid and it’s a clear example of admin privilege, so I believe medium severity to be more appropriate</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/105#issuecomment-1066608561\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I agree with the sponsor on the above.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/105#issuecomment-1069077794\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I’ve thought about this more and I’ve decided to split up distinct issues into 3 primary issues:</p>\n<ul>\n<li>Owner rugs users.</li>\n<li>Funds are transferred to saleRecipient before settlement.</li>\n<li>Changing a token buy price during the sale by front-running buyers by forcing them to purchase at an unfair token price.</li>\n</ul>\n<p>I believe this satisfies the third primary issue description.</p>\n<ul>\n<li>Changing a token buy price during the sale by front-running buyers by forcing them to purchase at an unfair token price.</li>\n</ul>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 24 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/111\">report highlighted below</a> by warden <strong>Czar102</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/31\">0x0x0x</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/51\">gellej</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/40\">cmichel</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/106\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/18\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/64\">hubble</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/69\">OriDabush</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/96\">pauliax</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/66\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/84\">sirhashalot</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/90\">NoamYakov</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/28\">tqts</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/57\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/107\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/75\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/34\">floppydisk</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/23\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/46\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/47\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/1\">samruna</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/74\">wuwe1</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/8\">robee</a>, and <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/33\">kenta</a>.</em></p>\n<h2 id=\"codebase-impressions-and-summary\" style=\"position:relative;\"><a href=\"#codebase-impressions-and-summary\" aria-label=\"codebase impressions and summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Codebase Impressions and Summary</h2>\n<p>Several minor changes have been identified that can be applied in order to improve general security of the contract logic and code quality.</p>\n<p>Among those, three out of four issues focus on code clarity, conventions and unambiguity of the comments. A possible attack vector has also been recognized, which makes the owner capable of griefing users and making their transactions revert, consuming gas fees.</p>\n<h2 id=\"l-01-ambiguous-usage-of--operator\" style=\"position:relative;\"><a href=\"#l-01-ambiguous-usage-of--operator\" aria-label=\"l 01 ambiguous usage of  operator permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Ambiguous usage of <code>^</code> operator</h2>\n<p>Is Solidity <code>^</code> is used for <code>xor</code> operation, but in <a href=\"https://github.com/code-423n4/2022-02-badger-citadel/blob/84596551d62f243d13fcb2d486346dde08002f7b/contracts/TokenSaleUpgradeable.sol#L32\">TokenSaleUpgradeable.sol:32</a> it is used to symbolize exponentiation. It is preferable to use <code>**</code> instead to avoid ambiguity or confusion.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// TokenSaleUpgradeable.sol:32</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// eg. 1 WBTC (8 decimals) = 40,000 CTDL ==&gt; price = 10^8 / 40,000</span></span></span></code></pre>\n<h2 id=\"l-02-owner-can-frontrun-buy-function\" style=\"position:relative;\"><a href=\"#l-02-owner-can-frontrun-buy-function\" aria-label=\"l 02 owner can frontrun buy function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Owner can frontrun <code>buy</code> function</h2>\n<p>Owner can frontrun <code>buy</code> function in order to cause transaction to fail (and as a consequence make someone lose gas fee) by invoking one of these functions:</p>\n<ul>\n<li><code>setTokenInLimit</code>, with a small <code>_tokenInLimit</code> argument,</li>\n<li><code>setSaleDuration</code>, with a small <code>_saleDuration</code> argument,</li>\n<li><code>setSaleStart</code>, with a future timestamp.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Revert calls to these functions after the sale has started.</p>\n<h2 id=\"n-01-open-todo\" style=\"position:relative;\"><a href=\"#n-01-open-todo\" aria-label=\"n 01 open todo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Open TODO</h2>\n<p>An open TODO is present in <a href=\"https://github.com/code-423n4/2022-02-badger-citadel/blob/84596551d62f243d13fcb2d486346dde08002f7b/contracts/TokenSaleUpgradeable.sol#L13\">TokenSaleUpgradeable.sol:13</a>. It is recommended to avoid open TODOs as they may indicate programming errors that still need to be fixed.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// TokenSaleUpgradeable.sol:13</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">TODO: Better revert strings</span></span></code></pre>\n<h2 id=\"n-02-inconsistent-naming-conventions\" style=\"position:relative;\"><a href=\"#n-02-inconsistent-naming-conventions\" aria-label=\"n 02 inconsistent naming conventions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] Inconsistent naming conventions</h2>\n<p>The name of the variable <code>guestlist</code> (defined in <a href=\"https://github.com/code-423n4/2022-02-badger-citadel/blob/84596551d62f243d13fcb2d486346dde08002f7b/contracts/TokenSaleUpgradeable.sol#L53\">TokenSaleUpgradeable.sol:53</a>) and the event <code>GuestlistUpdated</code> (defined in <a href=\"https://github.com/code-423n4/2022-02-badger-citadel/blob/84596551d62f243d13fcb2d486346dde08002f7b/contracts/TokenSaleUpgradeable.sol#L76\">TokenSaleUpgradeable.sol:76</a>) should be changed to <code>guestList</code> and <code>GuestListUpdated</code> respectively in order to make them more readable and consistent with other parts of the code.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// TokenSaleUpgradeable.sol:53</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">BadgerGuestListAPI</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">guestlist</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// TokenSaleUpgradeable.sol:76</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">GuestlistUpdated</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">guestlist</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/111#issuecomment-1031656506\">GalloDaSballo (BadgerDao) commented</a>:</strong></p>\n<blockquote>\n<p>Appreciate the findings.</p>\n<p>Pretty sure <code>^</code> in a comment gives same level of clarity</p>\n<p>As for frontrun, I guess we could do that, but why?</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 22 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/112\">report highlighted below</a> by warden <strong>IllIllI</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/108\">Czar102</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/77\">TomFrenchBlockchain</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/80\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/56\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/32\">0x0x0x</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/73\">peritoflores</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/110\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/97\">pauliax</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/76\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/3\">Jujic</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/79\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/48\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/49\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/29\">tqts</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/35\">NoamYakov</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/7\">robee</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/68\">OriDabush</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/9\">PostMan56</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/38\">ych18</a>, <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/19\">sabtikw</a>, and <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/21\">throttle</a>.</em></p>\n<h2 id=\"g-01-use--0-rather-than--0-for-unsigned-integers-in-require-statements\" style=\"position:relative;\"><a href=\"#g-01-use--0-rather-than--0-for-unsigned-integers-in-require-statements\" aria-label=\"g 01 use  0 rather than  0 for unsigned integers in require statements permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Use <code>!= 0</code> rather than <code>> 0</code> for unsigned integers in <code>require()</code> statements</h2>\n<p>When the optimizer is enabled, gas is wasted by doing a greater-than operation, rather than a not-equals operation inside <code>require()</code> statements. When Using <code>!=</code>, the optimizer is able to avoid the <code>EQ</code>, <code>ISZERO</code>, and associated operations, by relying on the <code>JUMPI</code> that comes afterwards, which itself checks for zero.</p>\n<h3 id=\"examples\" style=\"position:relative;\"><a href=\"#examples\" aria-label=\"examples permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Examples</h3>\n<p>See markdown file within <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/112\">original submission</a> for in-depth examples.</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Hardhat\nForge\nnpx @remix-project/remix-lib</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use <code>!= 0</code> rather than <code>> 0</code> for unsigned integers in <code>require()</code> statements. Note that the comparison in <code>claim()</code> results in no gas savings.</p>\n<h2 id=\"g-02---use-local-variables-to-cache-results-of-storage-reads\" style=\"position:relative;\"><a href=\"#g-02---use-local-variables-to-cache-results-of-storage-reads\" aria-label=\"g 02   use local variables to cache results of storage reads permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] - Use local variables to cache results of storage reads</h2>\n<p>Reading from storage is expensive whereas reading from the stack is cheap. If the result of a storage read in required multiple times, the code should cache the value in a local variable, and read from that variable, rather than fetching from storage again.</p>\n<h3 id=\"examples-1\" style=\"position:relative;\"><a href=\"#examples-1\" aria-label=\"examples 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Examples</h3>\n<p>See markdown file within <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/112\">original submission</a> for in-depth examples.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Hardhat\nForge\nnpx @remix-project/remix-lib</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Cache the result of storage reads in a stack variable for future reads</p>\n<h2 id=\"g-03---pre-calculate-repeatedly-checked-offsets\" style=\"position:relative;\"><a href=\"#g-03---pre-calculate-repeatedly-checked-offsets\" aria-label=\"g 03   pre calculate repeatedly checked offsets permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] - Pre-calculate repeatedly-checked offsets</h2>\n<p>Reading from storage is expensive, so it saves gas when only one variable has to be read versus multiple. If there is a calculation which requires multiple storage reads, the calculation should be optimized to pre-calculate as much as possible, and store the intermediate result in storage.</p>\n<h3 id=\"examples-2\" style=\"position:relative;\"><a href=\"#examples-2\" aria-label=\"examples 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Examples</h3>\n<p>See markdown file within <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/112\">original submission</a> for in-depth examples.</p>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Forge</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Pre-calculate the end timestamp, and reference that rather than adding <code>saleStart</code> and <code>saleDuration</code> in multiple places. Note that due to packing, the variable is sensitive to the order in which it is defined in the contract, as well as its visibility. Also note that while I’ve split the separate instances, in reality you’d apply both of them and get a larger ammortization benefit</p>\n<h2 id=\"g-04---use-unchecked-for-operations-not-expected-to-overflow\" style=\"position:relative;\"><a href=\"#g-04---use-unchecked-for-operations-not-expected-to-overflow\" aria-label=\"g 04   use unchecked for operations not expected to overflow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] - Use <code>unchecked</code> for operations not expected to overflow</h2>\n<p>If it is not possible for an operation to overflow, it should be wrapped in <code>unchecked {}</code> to save the gas that would have been used to check for an overflow.</p>\n<h3 id=\"examples-3\" style=\"position:relative;\"><a href=\"#examples-3\" aria-label=\"examples 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Examples</h3>\n<p>See markdown file within <a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/112\">original submission</a> for in-depth examples.</p>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Hardhat\nForge\nnpx @remix-project/remix-lib</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add <code>unchecked { }</code> and casts to operations that cannot overflow</p>\n<h2 id=\"g-05---pull-tokens-rather-than-pushing-them\" style=\"position:relative;\"><a href=\"#g-05---pull-tokens-rather-than-pushing-them\" aria-label=\"g 05   pull tokens rather than pushing them permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] - Pull tokens rather than pushing them</h2>\n<p>It wastes gas to push tokens to <code>saleRecipient</code> every time there is a buy.</p>\n<h3 id=\"examples-4\" style=\"position:relative;\"><a href=\"#examples-4\" aria-label=\"examples 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Examples</h3>\n<h4 id=\"1-tokensaleupgradeablesoll183\" style=\"position:relative;\"><a href=\"#1-tokensaleupgradeablesoll183\" aria-label=\"1 tokensaleupgradeablesoll183 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. <a href=\"https://github.com/code-423n4/2022-02-badger-citadel/blob/84596551d62f243d13fcb2d486346dde08002f7b/contracts/TokenSaleUpgradeable.sol#L183\">TokenSaleUpgradeable.sol:L183</a></h4>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokenIn</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">saleRecipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenInAmount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Create a new function or modify <code>sweep()</code> to send the current balance of the contract to <code>saleRecipient</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/112#issuecomment-1045313951\">GalloDaSballo (BadgerDao) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>All findings are valid and appreciated, would recommend the warden to just post the specific gas differences instead of the whole table as there’s 10s of thousands of lines in the readme, but the only lines that count are very few.</p>\n<p>That said, this may be the best report I’ve ever seen, as while it’s a lot of superfluous information (again just delete the redundant lines), the information is all there and verifiable.</p>\n<p>I think the work from the warden is commendable and it is really appreciated.</p>\n<p>A breath of fresh air compared to the usual copy paste “use != instead of >”</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#medium-risk-findings-3\">Medium Risk Findings (3)</a></p>\n<ul>\n<li><a href=\"#m-01-the-owner-and-proxy-admin-can-make-users-lose-funds-rug-vectors\">[M-01] The Owner and Proxy Admin can make users lose funds (“rug vectors”)</a></li>\n<li><a href=\"#m-02-salerecipient-can-rug-buyers\">[M-02] <code>saleRecipient</code> can rug buyers</a></li>\n<li><a href=\"#m-03-owner-can-steal-input-tokens\">[M-03] Owner can steal input tokens</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#codebase-impressions-and-summary\">Codebase Impressions and Summary</a></li>\n<li><a href=\"#l-01-ambiguous-usage-of--operator\">L-01 Ambiguous usage of <code>^</code> operator</a></li>\n<li><a href=\"#l-02-owner-can-frontrun-buy-function\">L-02 Owner can frontrun <code>buy</code> function</a></li>\n<li><a href=\"#n-01-open-todo\">N-01 Open TODO</a></li>\n<li><a href=\"#n-02-inconsistent-naming-conventions\">N-02 Inconsistent naming conventions</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-use--0-rather-than--0-for-unsigned-integers-in-require-statements\">G-01 Use <code>!= 0</code> rather than <code>> 0</code> for unsigned integers in <code>require()</code> statements</a></li>\n<li><a href=\"#g-02---use-local-variables-to-cache-results-of-storage-reads\">G-02 - Use local variables to cache results of storage reads</a></li>\n<li><a href=\"#g-03---pre-calculate-repeatedly-checked-offsets\">G-03 - Pre-calculate repeatedly-checked offsets</a></li>\n<li><a href=\"#g-04---use-unchecked-for-operations-not-expected-to-overflow\">G-04 - Use <code>unchecked</code> for operations not expected to overflow</a></li>\n<li><a href=\"#g-05---pull-tokens-rather-than-pushing-them\">G-05 - Pull tokens rather than pushing them</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the Badger Citadel smart contract system written in Solidity. The audit contest took place between February 4—February 6 2022.\n\n## Wardens\n\n40 Wardens contributed reports to the Badger Citadel contest:\n\n  1. Czar102\n  1. gellej\n  1. [cmichel](https://twitter.com/cmichelio)\n  1. [pauliax](https://twitter.com/SolidityDev)\n  1. [TomFrenchBlockchain](https://github.com/TomAFrench)\n  1. [gzeon](https://twitter.com/gzeon)\n  1. pedroais\n  1. WatchPug ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n  1. [tqts](https://tqts.ar/)\n  1. 0x1f8b\n  1. [sirhashalot](https://twitter.com/SirH4shalot)\n  1. hyh\n  1. harleythedog\n  1. [hickuphh3](https://twitter.com/HickupH)\n  1. cccz\n  1. hubble (ksk2345 and shri4net)\n  1. [defsec](https://twitter.com/defsec_)\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. p4st13r4 ([0x69e8](https://github.com/0x69e8) and 0xb4bb4)\n  1. 0x0x0x\n  1. IllIllI\n  1. [Dravee](https://twitter.com/JustDravee)\n  1. [OriDabush](https://twitter.com/ori_dabush)\n  1. [Ruhum](https://twitter.com/0xruhum)\n  1. NoamYakov\n  1. robee\n  1. floppydisk\n  1. samruna\n  1. [wuwe1](https://twitter.com/wuwe19)\n  1. kenta\n  1. peritoflores\n  1. Jujic\n  1. [rfa](https://www.instagram.com/riyan_rfa/)\n  1. [PostMan56](https://twitter.com/Man56Post)\n  1. [ych18](https://www.linkedin.com/in/yahia-chaabane/)\n  1. [sabtikw](https://twitter.com/sabtikw)\n  1. [throttle](https://twitter.com/Throt7le)\n\nThis contest was judged by [0xleastwood](https://twitter.com/liam_eastwood13).\n\nFinal report assembled by [liveactionllama](https://twitter.com/liveactionllama).\n\n# Summary\n\nThe C4 analysis yielded 3 unique MEDIUM severity vulnerabilities. Additionally, the analysis included 24 reports detailing issues with a risk rating of LOW severity or non-critical as well as 22 reports recommending gas optimizations. All of the issues presented here are linked back to their original finding.\n\nNotably, 0 vulnerabilities were found during this audit contest that received a risk rating in the category of HIGH severity.\n\n# Scope\n\nThe code under review can be found within the [C4 Badger Citadel contest repository](https://github.com/code-423n4/2022-02-badger-citadel), and is composed of 1 smart contract written in the Solidity programming language and includes 384 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code423n4.com).\n\n# Medium Risk Findings (3)\n## [[M-01] The Owner and Proxy Admin can make users lose funds (\"rug vectors\")](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/50)\n_Submitted by gellej, also found by WatchPug, Czar102, csanuragjain, p4st13r4, pedroais, TomFrenchBlockchain, defsec, hubble, gzeon, 0x1f8b, and sirhashalot_\n\nThe contest explicitly asks to analyze the contract for \"Rug Vectors\", so that is what this issue is about.\n\nI have classified this issue as \"high risk\" - although the vulnerability is considerable, the attacks themselves are not very likely to occur (they depend on the owner and/or the proxy admin to be compromised). The main reason why I believe the vulnerabiity is \"high\" is because the very fact that all these factors exist can make the sale fail, as informed users will avoid the contract completely one they realize the extent in which the contract is manipulable.\n\nIn the current implementation, there several ways that investors can lose funds if the owner of the contract is not well behaved. These risks can be divided into two kinds:\n\n*   owner becomes unable to act (for example, owner looses her private key, or the owner is a wallet or a DAO and signers cannot agree on the right action to take)\n*   owner is malicious  (for example, the owner account gets hacked or the signers turn bad), and wants to steal as much as the funds as possible (\"Rug Vectors\"), or executes a griefing attack (i.e. acts in such a way to hurt the buyers and/or the project, without immediate financial gain)\n\nThe contract is vulnerable to all three types of vulnerabilities (\"rug pull\", \"griefing\" and \"inactivity\").\n\n(1) Loss of funds due to owner inactivity:\n(1a) If the owner does never funds the contract, the buyers will not receive their tokens, and have no recourse to get their investment back\n(1b) If the owner does not call `finalize`, buyers will not receive their tokens, and and have no recourse to get their investment back\n\n(2) Griefing attacks by the owner (attacks that that have no immediate gain for the attacker, but are either annoying or lead to loss of funds)\n(2a) the owner can change many essential conditions of the sale: for example, the price, the start time, the duration, the guest list, and the total amount of tokens that are allowed to be sold. The owner can do this at any moment, also **while the sale is in course**. This allows for all kinds of griefing attacks. It also voids the whole point of using a smart contract in the first place.\n(2b) Owner can pause the contract at any time, which will freeze the funds in the contract, as it also disallows users to claim their tokens\n\n(3) Rug pull by owner (attacks with financial gain for the attacker, buyer loses money)\n(3a) The Owner can call `sweep` at any time and remove all unsold CTDL tokens while the sale is in progress. Future buyers will still be able to buy tokens, but the sale can never be finalized (unless the owner funds the contract)\n(3b) Owner can front-run buyers and change the price. I.e. the owner can monitor the mem pool for a large `buy` transaction and precede the transaction with her own transaction that changes the price to a very low one. If the price is low enough, `getAmountOut` will return `0`, and the buyers will lose her funds and not receive any CTDL tokens at all.\n\n(4) Rug pull by proxy Admin\n(4a) Although no deployment script is provided in the repo, we may assume (from the tests and the fact that the contracts are upgradeable) that the actual sale will be deployed as a proxy. The proxy admin (which may not be the same account as the owner) can change the implementation of the contract at any time, and in particular can change the implemention logic in such a way that all the funds held by the contract can be sent to the attacker.\n\n### Recommended Mitigation Steps\n\n*   In general, I would recommend to not write your own contract at all, but instead use OpenZeppelin's crowdsale contract: <https://docs.openzeppelin.com/contracts/2.x/api/crowdsale#Crowdsale> which seems to fit your needs pretty well\n*   To address 1a and 3a, enforce that the contract is funded  with enough CTDL tokens *before* the sale starts (for example, as part of the initialize logic)\n*   To adress 1b, simply remove the \"onlyOwner\" modifier on the \"finalize()\" function so that it can be called by anyone\n*   To (partially) address 2a, reduce the extent to which the owner can change the sale conditions during the sale (in any case remove the setSaleStart, setSaleEnd, setTokenInLimit or limit their application to before the sale starts). Ideally, once the sale starts, conditions of the sale remain unchanged, or change in a predictable way\n*   To address 2b, leave the tokens of the buyer in the contract (instead of sending them to a `saleRecipient` and implement an `emergencyWithdraw` function that will work also when the contract is paused, and that allows buyers can use to retrieve their original investment in case something goes wrong\n*   To address 3a, allow the owner to call `sweep` only after the sale is finalized\n*   To address 3b, either do not allow to change the token price during the token sale, or, if you must have this functionality, have the price change take effect only after a delay to make front-running by the owner impossible\n*   To address 4a, do not deploy the contract as a proxy at all (which seems overkill anyway, given the use case)\n\n**[0xleastwood (judge) decreased to Medium severity and commented](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/50#issuecomment-1066631798):**\n > Awesome write-up! \n> \n> Because the issue outlined by the warden covers several separate issues from other wardens, I'll mark this as the primary issue and de-duplicate all other issues.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/50#issuecomment-1069103297):**\n > I've thought about this more and I've decided to split up distinct issues into 3 primary issues:\n> - Owner rugs users.\n> - Funds are transferred to saleRecipient before settlement.\n> - Changing a token buy price during the sale by front-running buyers by forcing them to purchase at an unfair token price.\n>\n > This issue falls under the first primary issue.\n\n\n\n***\n\n## [[M-02] `saleRecipient` can rug buyers](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/61)\n_Submitted by WatchPug, also found by gellej, Czar102, hyh, harleythedog, pauliax, cmichel, 0x1f8b, hickuphh3, cccz, and sirhashalot_\n\nIn `TokenSaleUpgradeable.sol#buy()`, `tokenIn` will be transferred from the buyer directly to the `saleRecipient` without requiring/locking/releasing the corresponding amount of `tokenOut`.\n\nThis allows the `saleRecipient` to rug the users simply by not transferring `tokenOut` and finalizing the sale.\n\n### Proof of Concept\n\nGiven:\n\n*   tokenIn: `WBTC`\n*   \\_tokenOutPrice: `1e8`\n*   tokenOut: `CTDL`\n\n1.  Alice `buy()` with `100e8`;\n2.  Alice `buy()` with `200e8`;\n\nA malicious `saleRecipient` can just not transfer any `CTDL` to the contract and `finalize()` and keep `300e8 WBTC` received.\n\nAs a result, Alice and Bob can not get the expected amount of `tokensOut`, and there is no way to retrieve the WBTC paid, in essence, lose all the funds.\n\n### Recommended Mitigation Steps\n\nInstead of transferring the tokenIn directing to the `saleRecipient` in `buy()`, consider transferring the tokenIn into the contract (`address(this)`), and require a sufficient amount of `tokenOut` to be transferred into the contract first before the amount of `tokenIn` can be released to the `saleRecipient`.\n\n**[shuklaayush (BadgerDAO) disagreed with severity](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/61)**\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/61#issuecomment-1066620627):**\n > As this is also an issue regarding abuse of an owner's admin privileges, it fits the criteria of a `medium` severity issue.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/61#issuecomment-1069067800):**\n > I've thought about this more and I've decided to split up distinct issues into 3 primary issues:\n> - Owner rugs users.\n> - Funds are transferred to `saleRecipient` before settlement.\n> - Changing a token buy price during the sale by front-running buyers by forcing them to purchase at an unfair token price.\n>\n > This issue falls under the second primary issue.\n>  - Funds are transferred to `saleRecipient` before settlement.\n\n\n\n***\n\n## [[M-03] Owner can steal input tokens](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/105)\n_Submitted by Czar102, also found by gellej, cmichel, tqts, gzeon, TomFrenchBlockchain, pauliax, and pedroais_\n\n[TokenSaleUpgradeable.sol#L299-L309](https://github.com/code-423n4/2022-02-badger-citadel/blob/main/contracts/TokenSaleUpgradeable.sol#L299-L309)<br>\n[TokenSaleUpgradeable.sol#L311-L324](https://github.com/code-423n4/2022-02-badger-citadel/blob/main/contracts/TokenSaleUpgradeable.sol#L311-L324)<br>\n[TokenSaleUpgradeable.sol#L211-L224](https://github.com/code-423n4/2022-02-badger-citadel/blob/main/contracts/TokenSaleUpgradeable.sol#L211-L224)\n\nOwner is in full control over the `saleRecipient` address. When a `buy()` transaction enters the mempool, an owner can frontrun the buy with a transaction that calls `setTokenOutPrice()` and sets the price to a very high value, effectively making bought tokens close to (if not usually equal) zero and consuming the tokens to the owner-selected address - `saleRecipient`. Thus, an owner has incentive to perform such attack as they may cause little or zero additional indebtnees to the contract and all tokens to the owner.\n\nThis can also be seen as a coincidence - an owner sets a price while a user broadcasts a `buy()` transaction. The user may buy for a significantly different price than they intended.\n\n### Recommended Mitigation Steps\n\nDo not let changing sale price after the sale has started. Do not let changing sale start if the sale has already started.\n\n**[GalloDaSballo (BadgerDAO) disagreed with severity and commented](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/105#issuecomment-1031666053):**\n > I agree with the finding and the conclusion, we shouldn't let the price change after the sale has started.\n> \n> As for the example, that would only work once, because if we actually did that it would immediately warn every other user of our malicious behavior.\n> \n> I think the finding is valid and it's a clear example of admin privilege, so I believe medium severity to be more appropriate\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/105#issuecomment-1066608561):**\n > I agree with the sponsor on the above.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/105#issuecomment-1069077794):**\n > I've thought about this more and I've decided to split up distinct issues into 3 primary issues:\n> - Owner rugs users.\n> - Funds are transferred to saleRecipient before settlement.\n> - Changing a token buy price during the sale by front-running buyers by forcing them to purchase at an unfair token price.\n>\n > I believe this satisfies the third primary issue description.\n>  - Changing a token buy price during the sale by front-running buyers by forcing them to purchase at an unfair token price.\n\n\n\n***\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 24 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/111) by warden **Czar102** received the top score from the judge.\n\n_The following wardens also submitted reports: [0x0x0x](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/31), [gellej](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/51), [cmichel](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/40), [Dravee](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/106), [0x1f8b](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/18), [hubble](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/64), [OriDabush](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/69), [pauliax](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/96), [IllIllI](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/66), [sirhashalot](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/84), [NoamYakov](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/90), [tqts](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/28), [WatchPug](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/57), [hyh](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/107), [Ruhum](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/75), [floppydisk](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/34), [csanuragjain](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/23), [defsec](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/46), [gzeon](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/47), [samruna](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/1), [wuwe1](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/74), [robee](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/8), and [kenta](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/33)._\n\n## Codebase Impressions and Summary\n\nSeveral minor changes have been identified that can be applied in order to improve general security of the contract logic and code quality.\n\nAmong those, three out of four issues focus on code clarity, conventions and unambiguity of the comments. A possible attack vector has also been recognized, which makes the owner capable of griefing users and making their transactions revert, consuming gas fees.\n\n## [L-01] Ambiguous usage of `^` operator\n\nIs Solidity `^` is used for `xor` operation, but in [TokenSaleUpgradeable.sol:32](https://github.com/code-423n4/2022-02-badger-citadel/blob/84596551d62f243d13fcb2d486346dde08002f7b/contracts/TokenSaleUpgradeable.sol#L32) it is used to symbolize exponentiation. It is preferable to use `**` instead to avoid ambiguity or confusion.\n\n```solidity\n// TokenSaleUpgradeable.sol:32\n/// eg. 1 WBTC (8 decimals) = 40,000 CTDL ==> price = 10^8 / 40,000\n```\n\n## [L-02] Owner can frontrun `buy` function\n\nOwner can frontrun `buy` function in order to cause transaction to fail (and as a consequence make someone lose gas fee) by invoking one of these functions:\n\n*   `setTokenInLimit`, with a small `_tokenInLimit` argument,\n*   `setSaleDuration`, with a small `_saleDuration` argument,\n*   `setSaleStart`, with a future timestamp.\n\n### Recommended Mitigation Steps\n\nRevert calls to these functions after the sale has started.\n\n## [N-01] Open TODO\n\nAn open TODO is present in [TokenSaleUpgradeable.sol:13](https://github.com/code-423n4/2022-02-badger-citadel/blob/84596551d62f243d13fcb2d486346dde08002f7b/contracts/TokenSaleUpgradeable.sol#L13). It is recommended to avoid open TODOs as they may indicate programming errors that still need to be fixed.\n\n    // TokenSaleUpgradeable.sol:13\n    TODO: Better revert strings\n\n## [N-02] Inconsistent naming conventions\n\nThe name of the variable `guestlist` (defined in [TokenSaleUpgradeable.sol:53](https://github.com/code-423n4/2022-02-badger-citadel/blob/84596551d62f243d13fcb2d486346dde08002f7b/contracts/TokenSaleUpgradeable.sol#L53)) and the event `GuestlistUpdated` (defined in [TokenSaleUpgradeable.sol:76](https://github.com/code-423n4/2022-02-badger-citadel/blob/84596551d62f243d13fcb2d486346dde08002f7b/contracts/TokenSaleUpgradeable.sol#L76)) should be changed to `guestList` and `GuestListUpdated` respectively in order to make them more readable and consistent with other parts of the code.\n\n```solidity\n// TokenSaleUpgradeable.sol:53\nBadgerGuestListAPI public guestlist;\n```\n\n```solidity\n// TokenSaleUpgradeable.sol:76\nevent GuestlistUpdated(address indexed guestlist);\n```\n\n**[GalloDaSballo (BadgerDao) commented](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/111#issuecomment-1031656506):**\n > Appreciate the findings.\n> \n> Pretty sure `^` in a comment gives same level of clarity\n> \n> As for frontrun, I guess we could do that, but why?\n\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 22 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/112) by warden **IllIllI** received the top score from the judge.\n\n_The following wardens also submitted reports: [Czar102](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/108), [TomFrenchBlockchain](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/77), [Dravee](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/80), [WatchPug](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/56), [0x0x0x](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/32), [peritoflores](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/73), [hyh](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/110), [pauliax](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/97), [Ruhum](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/76), [Jujic](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/3), [rfa](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/79), [gzeon](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/48), [defsec](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/49), [tqts](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/29), [NoamYakov](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/35), [robee](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/7), [OriDabush](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/68), [PostMan56](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/9), [ych18](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/38), [sabtikw](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/19), and [throttle](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/21)._\n\n## [G-01] Use `!= 0` rather than `> 0` for unsigned integers in `require()` statements\n\nWhen the optimizer is enabled, gas is wasted by doing a greater-than operation, rather than a not-equals operation inside `require()` statements. When Using `!=`, the optimizer is able to avoid the `EQ`, `ISZERO`, and associated operations, by relying on the `JUMPI` that comes afterwards, which itself checks for zero.\n\n### Examples\nSee markdown file within [original submission](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/112) for in-depth examples.\n\n### Tools Used\nHardhat\nForge\nnpx @remix-project/remix-lib\n\n### Recommended Mitigation Steps\nUse `!= 0` rather than `> 0` for unsigned integers in `require()` statements. Note that the comparison in `claim()` results in no gas savings.\n\n## [G-02] - Use local variables to cache results of storage reads\n\nReading from storage is expensive whereas reading from the stack is cheap. If the result of a storage read in required multiple times, the code should cache the value in a local variable, and read from that variable, rather than fetching from storage again.\n\n### Examples\nSee markdown file within [original submission](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/112) for in-depth examples.\n\n### Tools Used\nHardhat\nForge\nnpx @remix-project/remix-lib\n\n### Recommended Mitigation Steps\nCache the result of storage reads in a stack variable for future reads\n\n## [G-03] - Pre-calculate repeatedly-checked offsets\n\nReading from storage is expensive, so it saves gas when only one variable has to be read versus multiple. If there is a calculation which requires multiple storage reads, the calculation should be optimized to pre-calculate as much as possible, and store the intermediate result in storage.\n\n### Examples\n\nSee markdown file within [original submission](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/112) for in-depth examples.\n\n### Tools Used\nForge\n\n### Recommended Mitigation Steps\nPre-calculate the end timestamp, and reference that rather than adding `saleStart` and `saleDuration` in multiple places. Note that due to packing, the variable is sensitive to the order in which it is defined in the contract, as well as its visibility. Also note that while I've split the separate instances, in reality you'd apply both of them and get a larger ammortization benefit\n\n## [G-04] - Use `unchecked` for operations not expected to overflow\n\nIf it is not possible for an operation to overflow, it should be wrapped in `unchecked {}` to save the gas that would have been used to check for an overflow.\n\n### Examples\nSee markdown file within [original submission](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/112) for in-depth examples.\n\n### Tools Used\nHardhat\nForge\nnpx @remix-project/remix-lib\n\n### Recommended Mitigation Steps\nAdd `unchecked { }` and casts to operations that cannot overflow\n\n## [G-05] - Pull tokens rather than pushing them\n\nIt wastes gas to push tokens to `saleRecipient` every time there is a buy.\n\n### Examples\n\n#### 1. [TokenSaleUpgradeable.sol:L183](https://github.com/code-423n4/2022-02-badger-citadel/blob/84596551d62f243d13fcb2d486346dde08002f7b/contracts/TokenSaleUpgradeable.sol#L183)\n```solidity\n        tokenIn.safeTransferFrom(msg.sender, saleRecipient, _tokenInAmount);\n```\n\n### Recommended Mitigation Steps\nCreate a new function or modify `sweep()` to send the current balance of the contract to `saleRecipient`\n\n**[GalloDaSballo (BadgerDao) confirmed and commented](https://github.com/code-423n4/2022-02-badger-citadel-findings/issues/112#issuecomment-1045313951):**\n > All findings are valid and appreciated, would recommend the warden to just post the specific gas differences instead of the whole table as there's 10s of thousands of lines in the readme, but the only lines that count are very few.\n> \n> That said, this may be the best report I've ever seen, as while it's a lot of superfluous information (again just delete the redundant lines), the information is all there and verifiable.\n> \n> I think the work from the warden is commendable and it is really appreciated.\n> \n> A breath of fresh air compared to the usual copy paste \"use != instead of >\"\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}