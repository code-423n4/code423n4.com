{
  "circa": {
    "title": "Shell Protocol",
    "sponsor": "Shell Protocol",
    "slug": "2023-08-shell",
    "date": "2023-10-04",
    "findings": "https://github.com/code-423n4/2023-08-shell-findings/issues",
    "contest": 277
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the Shell Protocol smart contract system written in Solidity. The audit took place between August 21 — August 28 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>44 Wardens contributed reports to the Shell Protocol:</p>\n<ol>\n<li><a href=\"https://code4rena.com/@pontifex\">pontifex</a></li>\n<li><a href=\"https://code4rena.com/@Mirror\">Mirror</a></li>\n<li><a href=\"https://code4rena.com/@Udsen\">Udsen</a></li>\n<li><a href=\"https://code4rena.com/@oakcobalt\">oakcobalt</a></li>\n<li><a href=\"https://code4rena.com/@prapandey031\">prapandey031</a></li>\n<li><a href=\"https://code4rena.com/@Testerbot\">Testerbot</a></li>\n<li><a href=\"https://code4rena.com/@d3e4\">d3e4</a></li>\n<li><a href=\"https://code4rena.com/@ItsNio\">ItsNio</a></li>\n<li><a href=\"https://code4rena.com/@ktg\">ktg</a></li>\n<li><a href=\"https://code4rena.com/@markus_ether\">markus_ether</a></li>\n<li><a href=\"https://code4rena.com/@mert_eren\">mert_eren</a></li>\n<li><a href=\"https://code4rena.com/@T1MOH\">T1MOH</a></li>\n<li><a href=\"https://code4rena.com/@skodi\">skodi</a></li>\n<li><a href=\"https://code4rena.com/@0xSmartContract\">0xSmartContract</a></li>\n<li><a href=\"https://code4rena.com/@lsaudit\">lsaudit</a></li>\n<li><a href=\"https://code4rena.com/@MrPotatoMagic\">MrPotatoMagic</a></li>\n<li><a href=\"https://code4rena.com/@catellatech\">catellatech</a></li>\n<li><a href=\"https://code4rena.com/@ihtishamsudo\">ihtishamsudo</a></li>\n<li><a href=\"https://code4rena.com/@MohammedRizwan\">MohammedRizwan</a></li>\n<li><a href=\"https://code4rena.com/@pfapostol\">pfapostol</a></li>\n<li>plainshift (<a href=\"https://code4rena.com/@thank_you\">thank_you</a>, <a href=\"https://code4rena.com/@windhustler\">windhustler</a> and <a href=\"https://code4rena.com/@surya\">surya</a>)</li>\n<li><a href=\"https://code4rena.com/@0xmystery\">0xmystery</a></li>\n<li><a href=\"https://code4rena.com/@JP_Courses\">JP_Courses</a></li>\n<li><a href=\"https://code4rena.com/@carrotsmuggler\">carrotsmuggler</a></li>\n<li><a href=\"https://code4rena.com/@rjs\">rjs</a></li>\n<li><a href=\"https://code4rena.com/@moneyversed\">moneyversed</a></li>\n<li><a href=\"https://code4rena.com/@0xAnah\">0xAnah</a></li>\n<li><a href=\"https://code4rena.com/@0xhacksmithh\">0xhacksmithh</a></li>\n<li><a href=\"https://code4rena.com/@0x11singh99\">0x11singh99</a></li>\n<li><a href=\"https://code4rena.com/@0x4non\">0x4non</a></li>\n<li><a href=\"https://code4rena.com/@Sathish9098\">Sathish9098</a></li>\n<li><a href=\"https://code4rena.com/@Jorgect\">Jorgect</a></li>\n<li><a href=\"https://code4rena.com/@epistkr\">epistkr</a></li>\n<li><a href=\"https://code4rena.com/@0xprinc\">0xprinc</a></li>\n<li><a href=\"https://code4rena.com/@Fulum\">Fulum</a></li>\n<li><a href=\"https://code4rena.com/@lanrebayode77\">lanrebayode77</a></li>\n<li><a href=\"https://code4rena.com/@Rolezn\">Rolezn</a></li>\n<li><a href=\"https://code4rena.com/@Shubham\">Shubham</a></li>\n<li><a href=\"https://code4rena.com/@ast3ros\">ast3ros</a></li>\n<li><a href=\"https://code4rena.com/@nisedo\">nisedo</a></li>\n<li><a href=\"https://code4rena.com/@MatricksDeCoder\">MatricksDeCoder</a></li>\n<li><a href=\"https://code4rena.com/@chainsnake\">chainsnake</a></li>\n</ol>\n<p>This audit was judged by <a href=\"https://code4rena.com/@Dravee\">Dravee</a>.</p>\n<p>Final report assembled by thebrittfactor.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 1 unique vulnerability, receiving a risk rating in the category of HIGH severity.</p>\n<p>Additionally, C4 analysis included 21 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 13 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-08-shell\">C4 Shell Protocol repository</a>, and is composed of 1 smart contract written in the Solidity programming language and includes 460 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"high-risk-findings-1\" style=\"position:relative;\"><a href=\"#high-risk-findings-1\" aria-label=\"high risk findings 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (1)</h1>\n<h2 id=\"h-01-lack-of-balance-validation\" style=\"position:relative;\"><a href=\"#h-01-lack-of-balance-validation\" aria-label=\"h 01 lack of balance validation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/57\">[H-01] Lack of Balance Validation</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/57\">Mirror</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/275\">prapandey031</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/268\">d3e4</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/191\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/188\">ItsNio</a>, pontifex (<a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/186\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/184\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/183\">ktg</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/161\">markus_ether</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/70\">Testerbot</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/63\">mert_eren</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/59\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/50\">oakcobalt</a>, and <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/271\">skodi</a></em></p>\n<h3 id=\"description\" style=\"position:relative;\"><a href=\"#description\" aria-label=\"description permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>The pool’s ratio of y to x must be within the interval <code>[MIN_M, MAX_M)</code>, which will be checked by the <code>_checkBalances()</code> function.\nExternal view functions will call the <code>_swap()</code>, <code>_reserveTokenSpecified()</code> or <code>_lpTokenSpecified()</code> functions to get the specified result. However, <code>_checkBalances()</code> is only used in the <code>_swap()</code> and <code>_lpTokenSpecified()</code> functions. There is no balance validation for <code>depositGivenInputAmount()</code> and <code>withdrawGivenOutputAmount()</code> functions, which use the <code>_reserveTokenSpecified()</code> function.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>If are no other validations outside of these two functions, user deposits/withdrawls may break the invariant, i.e. the pool’s ratio of y to x is outside the interval <code>[MIN_M, MAX_M)</code>.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Add the following code in the test/EvolvingProteusProperties.t.sol file to the EvolvingProteusProperties contract, and run <code>forge test --mt RatioOutsideExpectedInterval</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testDepositRatioOutsideExpectedInterval</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">x0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">y0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">s0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositedAmount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">int128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MIN_M</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0x00000000000002af31dc461</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">INT_MAX_SQRT</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0xb504f333f9de6484597d89b3754abe9f</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">x0</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">MIN_BALANCE</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">x0</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">INT_MAX_SQRT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">y0</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">MIN_BALANCE</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">y0</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">INT_MAX_SQRT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">s0</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">MIN_BALANCE</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">s0</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">INT_MAX_SQRT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositedAmount</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">MIN_OPERATING_AMOUNT</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">depositedAmount</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">INT_MAX_SQRT</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">depositedAmount</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FIXED_FEE</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">y0</span><span class=\"mtk1\">/</span><span class=\"mtk12\">x0</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">MAX_BALANCE_AMOUNT_RATIO</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">x0</span><span class=\"mtk1\">/</span><span class=\"mtk12\">y0</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">MAX_BALANCE_AMOUNT_RATIO</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">y0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">divi</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">x0</span><span class=\"mtk1\">) + </span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositedAmount</span><span class=\"mtk1\">)) &lt; </span><span class=\"mtk12\">MIN_M</span><span class=\"mtk1\">);   </span><span class=\"mtk3\">// breaks the invariant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">SpecifiedToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositedToken</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">SpecifiedToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">X</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">();  </span><span class=\"mtk3\">// There should be at least one case that call did not revert as expected</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">DUT</span><span class=\"mtk1\">.</span><span class=\"mtk11\">depositGivenInputAmount</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">x0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">y0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">s0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">depositedAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">depositedToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testWithdrawRatioOutsideExpectedInterval</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">x0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">y0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">s0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">withdrawnAmount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">int128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MIN_M</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0x00000000000002af31dc461</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">INT_MAX_SQRT</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0xb504f333f9de6484597d89b3754abe9f</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">x0</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">MIN_BALANCE</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">x0</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">INT_MAX_SQRT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">y0</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">MIN_BALANCE</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">y0</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">INT_MAX_SQRT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">s0</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">MIN_BALANCE</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">s0</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">INT_MAX_SQRT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">withdrawnAmount</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">MIN_OPERATING_AMOUNT</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">withdrawnAmount</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">INT_MAX_SQRT</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">withdrawnAmount</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FIXED_FEE</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">y0</span><span class=\"mtk1\">/</span><span class=\"mtk12\">x0</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">MAX_BALANCE_AMOUNT_RATIO</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">x0</span><span class=\"mtk1\">/</span><span class=\"mtk12\">y0</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">MAX_BALANCE_AMOUNT_RATIO</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">withdrawnAmount</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">y0</span><span class=\"mtk1\">);    </span><span class=\"mtk3\">// no more than balance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">((</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">y0</span><span class=\"mtk1\">) - </span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">withdrawnAmount</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">divi</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">x0</span><span class=\"mtk1\">)) &lt; </span><span class=\"mtk12\">MIN_M</span><span class=\"mtk1\">);   </span><span class=\"mtk3\">// breaks the invariant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">SpecifiedToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">withdrawnToken</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">SpecifiedToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Y</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">();  </span><span class=\"mtk3\">// There should be at least one case that call did not revert as expected</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">DUT</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdrawGivenOutputAmount</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">x0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">y0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">s0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">withdrawnAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">withdrawnToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It’s recommended to add <code>_checkBalances(xi + specifiedAmount, yi)</code> after <a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L579\">L579</a> and add <code>_checkBalances(xi, yi + specifiedAmount)</code> after <a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L582\">L582</a>.</p>\n<h3 id=\"assessed-type\" style=\"position:relative;\"><a href=\"#assessed-type\" aria-label=\"assessed type permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Invalid Validation</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/268#issuecomment-1704611312\">viraj124 (Shell) commented via duplicate Issue #268</a>:</strong></p>\n<blockquote>\n<p>This should be low/med at best IMO. We’re adding the balance check, but note _<code>getUtility</code> is an internal method and there are input checks of the reserve balances values passed, so this is an invalid argument.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/268#issuecomment-1713211667\">viraj124 (Shell) confirmed and commented via duplicate Issue #268</a>:</strong></p>\n<blockquote>\n<p>We checked this further with some other members of the team and agreed this is high severity. We’ve fixed this in a PR.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/57#issuecomment-1721966687\">Dravee (judge) increased severity to High</a></strong></p>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 21 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/247\">report highlighted below</a> by <strong>Udsen</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/255\">prapandey031</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/141\">MrPotatoMagic</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/135\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/121\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/78\">MohammedRizwan</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/269\">JP_Courses</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/261\">0xprinc</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/245\">Fulum</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/222\">plainshift</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/167\">pontifex</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/151\">Testerbot</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/138\">lanrebayode77</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/134\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/125\">Shubham</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/102\">ast3ros</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/92\">0xmystery</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/68\">nisedo</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/62\">Mirror</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/38\">MatricksDeCoder</a>, and <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/28\">chainsnake</a>.</em></p>\n<h2 id=\"01-recommended-to-add-an-input-validation-for-the-duration-variable-in-the-constructor\" style=\"position:relative;\"><a href=\"#01-recommended-to-add-an-input-validation-for-the-duration-variable-in-the-constructor\" aria-label=\"01 recommended to add an input validation for the duration variable in the constructor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[01] RECOMMENDED TO ADD AN INPUT VALIDATION FOR THE <code>duration</code> VARIABLE IN THE <code>constructor</code></h2>\n<p>In the <code>EvolvingProteus.constructor</code> the <code>duration</code> is passed in as an input parameter. Function <code>duration</code> denotes the total duration of the curve’s evolution. Hence, the <code>duration</code> variable is a critical variable of the protocol. If duration is set to zero by mistake, it will prompt a redeployment of the contract which could be waste of gas and additional workload. An input validity check should be performed for the <code>duration</code> variable inside the <code>constructor</code> as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">require(duration != 0, `Duration can not be zero`);</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L243-L263\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L243-L263</a></p>\n<p><em>Note from the judge: for a more detailed description of this finding, please see <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/118\">issue 118</a> from warden lsaudit</em></p>\n<h2 id=\"02-discrepancy-between-natspec-comments-and-logic-implementation\" style=\"position:relative;\"><a href=\"#02-discrepancy-between-natspec-comments-and-logic-implementation\" aria-label=\"02 discrepancy between natspec comments and logic implementation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[02] DISCREPANCY BETWEEN NATSPEC COMMENTS AND LOGIC IMPLEMENTATION</h2>\n<p>The <code>EvolvingProteus._getUtility</code> function is used to calculate the <code>utility</code> value of the pool at the time of the function call. The <code>utility</code> is calculated using a quadratic formula which is shown below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">k(ab - 1)u**2 + (ay + bx)u + xy/k = 0</span></span></code></pre>\n<p>As per the equation, there is a <code>k</code> value used in the <code>a</code> and <code>c</code> coefficients. But this <code>k</code> value is not used when calculating the <code>aQuad</code> and the <code>cQuad</code> values. This could be due to <code>normalization</code> of the equation or the <code>k = 1</code>. But the reason for the missing <code>k</code> value from the coefficient calculations is not given.</p>\n<p>Hence, it is fair to assume there is a discrepancy between the Natspec comments and the actual implementation of the logic.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L697\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L697</a><br>\n<a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L712-L714\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L712-L714</a></p>\n<h2 id=\"03-discrepancy-between-natspec-comment-and-logic-implementation-of-the-withdrawgiveninputamount-function\" style=\"position:relative;\"><a href=\"#03-discrepancy-between-natspec-comment-and-logic-implementation-of-the-withdrawgiveninputamount-function\" aria-label=\"03 discrepancy between natspec comment and logic implementation of the withdrawgiveninputamount function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[03] DISCREPANCY BETWEEN NATSPEC COMMENT AND LOGIC IMPLEMENTATION OF THE <code>withdrawGivenInputAmount</code> FUNCTION</h2>\n<p>The <code>natspec</code> comments of the <code>EvolvingProteus.withdrawGivenInputAmount</code> function states that the <code>feeDirection</code> of the function to be used is <code>FEE_UP</code>. The reason for using <code>FEE_UP</code> is described as wanting to increase the perceived amount of reserve tokens leaving the pool; however, the <code>feeDirection</code> is determined by the protocol to benefit itself. The <code>withdrawGivenInputAmount</code> transaction will benefit the protocol if the perceived amount of reserve tokens leaving the pool is decreased, which is equivalent to charging a fee from the withdrawing amount.</p>\n<p>The logic implementation of the <code>withdrawGivenInputAmount</code> function has implemented this requirement correctly, as shown below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    int256 result = _lpTokenSpecified( //@audit-info - amount of reserved token to withdraw</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        withdrawnToken,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        -int256(burnedAmount),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        FEE_DOWN, //@audit-issue - discrepancy between the NATSPEC and the implementation regarding FEE_DOWN</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        int256(totalSupply),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        int256(xBalance),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        int256(yBalance)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span></code></pre>\n<p>It is recommended to update the <code>natspect</code> comments of the <code>withdrawGivenInputAmount</code> function to state that the <code>feeDirection</code> used for the <code>withdrawGivenInputAmount</code> transaction is <code>FEE_DOWN</code>, by providing it with the proper reason to do so.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L459-L461\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L459-L461</a><br>\n<a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L478-L485\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L478-L485</a></p>\n<h2 id=\"04-erroneous-natspec-comments-should-be-corrected\" style=\"position:relative;\"><a href=\"#04-erroneous-natspec-comments-should-be-corrected\" aria-label=\"04 erroneous natspec comments should be corrected permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[04] ERRONEOUS NATSPEC COMMENTS SHOULD BE CORRECTED</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">@param px_final The final price at the `y axis`</span></span></code></pre>\n<p>Above comment should be corrected as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">@param px_final The final price at the `x axis`</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L240\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L240</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">The minimum price value calculated with abdk library equivalent to `10^12(wei)`</span></span></code></pre>\n<p>The above comment should be corrected as follows, since the given value (<code>10^12</code>) in the comment is not the minimum price value:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">The minimum price value calculated with abdk library equivalent to `10^10(wei)`</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L173\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L173</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"> *  without caring about which particular function `is was` called.</span></span></code></pre>\n<p>The above comment should be corrected as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"> *  without caring about which particular function `was` called.</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L736\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L736</a><br>\n<a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L768\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L768</a></p>\n<h2 id=\"05-add-meaningful-revert-messages-to-the-require-statements\" style=\"position:relative;\"><a href=\"#05-add-meaningful-revert-messages-to-the-require-statements\" aria-label=\"05 add meaningful revert messages to the require statements permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[05] ADD MEANINGFUL <code>revert</code> MESSAGES TO THE <code>require</code> STATEMENTS</h2>\n<p>In the <code>EvolvingProteus</code> contract, there are multiple occasions where <code>require</code> statements are used for conditional checks. But these <code>require</code> statements are not using <code>revert messages</code>. Hence, if these <code>require</code> statements revert, it will be difficult to find the <code>reason for the revert</code>.</p>\n<p>It is recommended to add meaningful revert messages to these <code>require</code> statements.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L414\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L414</a><br>\n<a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L397-L402\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L397-L402</a></p>\n<h2 id=\"06-min_balance-invariant-is-not-checked-for-the-final-lp-token-supply-amount-in-the-_reservetokenspecified-function-thus-breaking-expected-behaviour-of-the-protocol\" style=\"position:relative;\"><a href=\"#06-min_balance-invariant-is-not-checked-for-the-final-lp-token-supply-amount-in-the-_reservetokenspecified-function-thus-breaking-expected-behaviour-of-the-protocol\" aria-label=\"06 min_balance invariant is not checked for the final lp token supply amount in the _reservetokenspecified function thus breaking expected behaviour of the protocol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[06] <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/205\"><code>MIN_BALANCE</code> INVARIANT IS NOT CHECKED FOR THE FINAL LP TOKEN SUPPLY AMOUNT IN THE <code>_reserveTokenSpecified</code> FUNCTION, THUS BREAKING EXPECTED BEHAVIOUR OF THE PROTOCOL</a></h2>\n<p>The <code>EvolvingProteus._reserveTokenSpecified</code> function is called to calculate the <code>changed amount</code> of the <code>LP token supply</code> based on the <code>proportional change of the utility</code> of the pool. </p>\n<p>Firstly the initial utility and final utility are calculated as shown below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    ui = _getUtility(xi, yi);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uf = _getUtility(xf, yf);</span></span></code></pre>\n<p>Then, the proportional change of the utility is used to calculate the final LP token supply amount as shown below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 result = Math.mulDiv(uint256(uf), uint256(si), uint256(ui));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(result &lt; INT_MAX);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    int256 sf = int256(result);</span></span></code></pre>\n<p>The issue here is the computed <code>sf</code> (final LP token supply amount) is not checked against the <code>MIN_BALANCE</code> value. Since <code>_reserveTokenSpecified</code> is called by both <code>EvolvingProteus.depositGivenInputAmount</code> and <code>EvolvingProteus.withdrawGivenOutputAmount</code> functions, the <code>sf</code> amount can decrease from the initial LP token supply amount of <code>si</code> during reserve token withdrawals.</p>\n<p>This could prompt the <code>sf &#x3C; MIN_BALANCE</code> condition to occur. If this condition occurs, the transaction should revert as it is done in the <code>EvolvingProteus._getUtilityFinalLp</code> function. But the transaction will not revert in the <code>_reserveTokenSpecified</code> function execution since there is no conditional check to verify <code>sf >= MIN_BALANCE</code>. </p>\n<p>The <code>withdrawGivenOutputAmount</code> transaction will execute successfully without reverting, even if the key invariant <code>sf >= MIN_BALANCE</code> is broken. Hence, this breaks the expected behaviour of the protocol.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ui</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getUtility</span><span class=\"mtk1\">(</span><span class=\"mtk12\">xi</span><span class=\"mtk1\">, </span><span class=\"mtk12\">yi</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uf</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getUtility</span><span class=\"mtk1\">(</span><span class=\"mtk12\">xf</span><span class=\"mtk1\">, </span><span class=\"mtk12\">yf</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">result</span><span class=\"mtk1\"> = </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uf</span><span class=\"mtk1\">), </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">si</span><span class=\"mtk1\">), </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ui</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">result</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">INT_MAX</span><span class=\"mtk1\">);   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sf</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">result</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// apply fee to the computed amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">computedAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_applyFeeByRounding</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sf</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">si</span><span class=\"mtk1\">, </span><span class=\"mtk12\">feeDirection</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L586-L594\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L586-L594</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sf</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">MIN_BALANCE</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L658\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L658</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">result</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_reserveTokenSpecified</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">withdrawnToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            -</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">withdrawnAmount</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">FEE_UP</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">xBalance</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yBalance</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L441-L448\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L441-L448</a></p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It is recommended to add the conditional check to verify <code>sf >= MIN_BALANCE</code> in the <code>_reserveTokenSpecified</code> function, after the <code>sf</code> value is calculated, as shown below. If the invariant for <code>MIN_BALANCE</code> is broken, then the transaction should revert.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 result = Math.mulDiv(uint256(uf), uint256(si), uint256(ui));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(result &lt; INT_MAX);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    int256 sf = int256(result);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(sf &gt;= MIN_BALANCE); </span></span></code></pre>\n<h2 id=\"07-_checkbalances-function-breaks-the-expected-behaviour-of-the-protocol-due-to-erroneous-conditional-check\" style=\"position:relative;\"><a href=\"#07-_checkbalances-function-breaks-the-expected-behaviour-of-the-protocol-due-to-erroneous-conditional-check\" aria-label=\"07 _checkbalances function breaks the expected behaviour of the protocol due to erroneous conditional check permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[07] <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/204\"><code>_checkBalances</code> FUNCTION BREAKS THE EXPECTED BEHAVIOUR OF THE PROTOCOL DUE TO ERRONEOUS CONDITIONAL CHECK</a></h2>\n<p>The <code>EvolvingProteus._checkBalances</code> function is used to verify the token reserve balances and the token reserve ratio are within the valid boundaries of the pool. To validate the <code>reserve ratio</code> is within the valid range of <code>MIN_M - MAX_M</code>, the following checks are performed:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (finalBalanceRatio &lt; MIN_M) revert BoundaryError(x,y);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    else if (MAX_M &lt;= finalBalanceRatio) revert BoundaryError(x,y);</span></span></code></pre>\n<p>The <code>NATSPEC</code> comments for the <code>MIN_M</code> and <code>MAX_M</code> are given as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">MIN_M -&gt; This limits the pool to having at most 10**8 x for each y</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MAX_M -&gt; This limits the pool to having at most 10**8 y for each x</span></span></code></pre>\n<p>Even though the documentation says the <code>y / x</code> ratio can have at most <code>10**8</code>, the logic implementation reverts when the <code>y / x == 10**8</code> as shown below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    else if (MAX_M &lt;= finalBalanceRatio) revert BoundaryError(x,y);</span></span></code></pre>\n<p>But it is not the case with the <code>MIN_M</code>, as the transaction will not revert when <code>y / x == 1 / 10**8</code>. There is a discrepancy between the documentation and the logic implementation.</p>\n<p>Consider a scenario where the <code>y balance = 200 * 10**20</code> and <code>x balance = 200 * 10**12</code>; now <code>y / x = 10**8</code>. The transaction is not expected to be reverted since the documentation mentions that the pool is allowed to have at most <code>10**8</code> y for each x. But according to the logic implementation, this transaction will revert since <code>MAX_M == finalBalanceRatio</code>. This breaks the expected behaviour of the protocol. </p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">finalBalanceRatio</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">MIN_M</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BoundaryError</span><span class=\"mtk1\">(</span><span class=\"mtk12\">x</span><span class=\"mtk1\">,</span><span class=\"mtk12\">y</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">MAX_M</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">finalBalanceRatio</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BoundaryError</span><span class=\"mtk1\">(</span><span class=\"mtk12\">x</span><span class=\"mtk1\">,</span><span class=\"mtk12\">y</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L812-L813\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L812-L813</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk12\">This</span><span class=\"mtk1\"> </span><span class=\"mtk12\">limits</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\"> </span><span class=\"mtk12\">having</span><span class=\"mtk1\"> </span><span class=\"mtk12\">at</span><span class=\"mtk1\"> </span><span class=\"mtk12\">most</span><span class=\"mtk1\"> </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">y</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">each</span><span class=\"mtk1\"> </span><span class=\"mtk12\">x</span><span class=\"mtk1\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    */ </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">int128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_M</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0x5f5e1000000000000000000</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L155-L157\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L155-L157</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk12\">When</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> </span><span class=\"mtk12\">has</span><span class=\"mtk1\"> </span><span class=\"mtk7\">18</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">, </span><span class=\"mtk4\">this</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">one</span><span class=\"mtk1\"> </span><span class=\"mtk12\">microtoken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    */ </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MIN_BALANCE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">12</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L149-L151\">https://github.com/code-423n4/2023-08-shell/blob/main/src/proteus/EvolvingProteus.sol#L149-L151</a></p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It is recommended to modify the <code>MAX_M &#x3C;= finalBalanceRatio</code> conditional check of the <code>_checkBalances</code> function, as shown below (omit the equality check in it):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    else if (MAX_M &lt; finalBalanceRatio) revert BoundaryError(x,y);</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/247#issuecomment-1715240987\">Dravee (judge) commented</a>:</strong></p>\n<blockquote>\n<p>01 - Low (0-input validation).<br>\n02 - Low (Issue with comment).<br>\n03 - Low (Issue with comment).<br>\n04 - 3 Lows (Issue with comment).<br>\n05 - Out of scope - due to the <a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/bot-report.md#nc-16-requirerevert-without-any-message\">Automated Findings Report</a>.<br>\n06 - Low<br>\n07 - Info (accepting as typo in comment but with a decreased severity as the warden misunderstood).</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this audit, 13 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/120\">report highlighted below</a> by <strong>lsaudit</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/197\">MrPotatoMagic</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/270\">JP_Courses</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/267\">0xAnah</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/237\">0xhacksmithh</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/209\">0x11singh99</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/168\">pontifex</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/123\">0x4non</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/113\">pfapostol</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/80\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/56\">Sathish9098</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/20\">Jorgect</a>, and <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/8\">epistkr</a>.</em></p>\n<h2 id=\"g-01-do-not-calculate-constants\" style=\"position:relative;\"><a href=\"#g-01-do-not-calculate-constants\" aria-label=\"g 01 do not calculate constants permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Do not calculate constants</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">146: uint256 constant INT_MAX = uint256(type(int256).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">151: int256 constant MIN_BALANCE = 10**12;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">181: uint256 constant MAX_BALANCE_AMOUNT_RATIO = 10**11;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">191: uint256 constant FIXED_FEE = 10**9;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">196: int256 constant MULTIPLIER = 1e18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">201: int256 constant MAX_PRICE_RATIO = 10**4</span></span></code></pre>\n<h2 id=\"g-02-do-not-initialize-variables-with-default-values\" style=\"position:relative;\"><a href=\"#g-02-do-not-initialize-variables-with-default-values\" aria-label=\"g 02 do not initialize variables with default values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Do not initialize variables with default values</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">211: bool constant FEE_DOWN = false;</span></span></code></pre>\n<h2 id=\"g-03-the-result-of-function-calls-should-be-cached-rather-than-re-calling-the-function\" style=\"position:relative;\"><a href=\"#g-03-the-result-of-function-calls-should-be-cached-rather-than-re-calling-the-function\" aria-label=\"g 03 the result of function calls should be cached rather than re calling the function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] The result of function calls should be cached rather than re-calling the function</h2>\n<p>Function <code>t(self)</code> is being called 3 times. Firstly, in the <code>if</code>-condition (line 98), then - when condition fails: <code>ABDK_ONE.sub(t(self))</code> and <code>self.px_final.mul(t(self))</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: EvolvingProteus.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">097:     function p_min(Config storage self) public view returns (int128) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">098:         if (t(self) &gt; ABDK_ONE) return self.px_final;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">099:         else return self.px_init.mul(ABDK_ONE.sub(t(self))).add(self.px_final.mul(t(self)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">100:     }</span></span></code></pre>\n<p>The same issue occurs for <code>p_max</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: EvolvingProteus.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">106:     function p_max(Config storage self) public view returns (int128) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">107:         if (t(self) &gt; ABDK_ONE) return self.py_final;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">108:         else return self.py_init.mul(ABDK_ONE.sub(t(self))).add(self.py_final.mul(t(self)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">109:     }</span></span></code></pre>\n<p>The result of <code>t(self)</code> should be cached in a variable, instead of being executed 3 times.</p>\n<h2 id=\"g-04-more-likely-to-revert-operations-should-be-executed-first\" style=\"position:relative;\"><a href=\"#g-04-more-likely-to-revert-operations-should-be-executed-first\" aria-label=\"g 04 more likely to revert operations should be executed first permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] More likely to revert operations should be executed first</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: EvolvingProteus.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">250:         // price value checks</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">251:         if (py_init &gt;= MAX_PRICE_VALUE || py_final &gt;= MAX_PRICE_VALUE) revert MaximumAllowedPriceExceeded();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">252:         if (px_init &lt;= MIN_PRICE_VALUE || px_final &lt;= MIN_PRICE_VALUE) revert MinimumAllowedPriceExceeded();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">253: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">254:         // at all times x price should be less than y price</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">255:         if (py_init &lt;= px_init) revert InvalidPrice();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">256:         if (py_final &lt;= px_final) revert InvalidPrice();</span></span></code></pre>\n<p>Since <code>py_init</code>, <code>px_init</code>, <code>py_final</code> and <code>px_final</code> are <code>int128</code>, there are <code>2**128</code> values they can be assigned to.</p>\n<p>This implies, that condition <code>if (py_init &#x3C;= px_init)</code> will revert for <code>(2**128) * (2**128 - 1) / 2 + 2**128</code> cases, while\ncondition <code>if (py_init >= MAX_PRICE_VALUE || py_final >= MAX_PRICE_VALUE)</code>  will revert for <code>(2**128 - MAX_PRICE_VALUE) * 2**128 + (2**128 - MAX_PRICE_VALUE) * 2**128</code>.</p>\n<p>According to that, reverts for <code>py_init &#x3C;= px_init</code> and <code>py_final &#x3C;= px_final</code> are more likely than reverts for <code>py_init >= MAX_PRICE_VALUE || py_final >= MAX_PRICE_VALUE</code> and <code>px_init &#x3C;= MIN_PRICE_VALUE || px_final &#x3C;= MIN_PRICE_VALUE</code>. Thus, ordering of lines 251-252 and 255-256 should be changed:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (py_init &lt;= px_init) revert InvalidPrice();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (py_final &lt;= px_final) revert InvalidPrice();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (py_init &gt;= MAX_PRICE_VALUE || py_final &gt;= MAX_PRICE_VALUE)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (px_init &lt;= MIN_PRICE_VALUE || px_final &lt;= MIN_PRICE_VALUE)</span></span></code></pre>\n<h2 id=\"g-05-or-in-if-condition-can-be-rewritten-to-two-single-if-conditions\" style=\"position:relative;\"><a href=\"#g-05-or-in-if-condition-can-be-rewritten-to-two-single-if-conditions\" aria-label=\"g 05 or in if condition can be rewritten to two single if conditions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] OR in <code>if</code>-condition can be rewritten to two single <code>if</code> conditions</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: EvolvingProteus.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">251:         if (py_init &gt;= MAX_PRICE_VALUE || py_final &gt;= MAX_PRICE_VALUE) revert MaximumAllowedPriceExceeded();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">252:         if (px_init &lt;= MIN_PRICE_VALUE || px_final &lt;= MIN_PRICE_VALUE) revert MinimumAllowedPriceExceeded();</span></span></code></pre>\n<p>Refactoring the <code>if</code>-condition in a way it won’t be containing the <code>||</code> operator will save more gas.</p>\n<p>This is a simple forge test, which demonstrates gas usage for both versions:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">     function testIfWithOR(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        int128 py_init,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        int128 px_init,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        int128 py_final,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        int128 px_final,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 duration</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) public returns (uint) { </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (py_init &gt;= MAX_PRICE_VALUE || py_final &gt;= MAX_PRICE_VALUE) return 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (px_init &lt;= MIN_PRICE_VALUE || px_final &lt;= MIN_PRICE_VALUE) return 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   function testIfWithoutOr(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        int128 py_init,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        int128 px_init,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        int128 py_final,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        int128 px_final,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 duration</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) public returns (uint) { </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (py_init &gt;= MAX_PRICE_VALUE) return 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (py_final &gt;= MAX_PRICE_VALUE) return 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (px_init &lt;= MIN_PRICE_VALUE) return 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (px_final &lt;= MIN_PRICE_VALUE) return 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Gas:testIfWithOR(int128,int128,int128,int128,uint256):(uint256) (runs: 256, μ: 914, ~: 926)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Gas:testIfWithoutOr(int128,int128,int128,int128,uint256):(uint256) (runs: 256, μ: 844, ~: 855)</span></span></code></pre>\n<p>This suggests, that conditions should be rewritten to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (py_init &gt;= MAX_PRICE_VALUE) revert MaximumAllowedPriceExceeded();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (py_final &gt;= MAX_PRICE_VALUE) revert MaximumAllowedPriceExceeded();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (px_init &lt;= MIN_PRICE_VALUE) revert MaximumAllowedPriceExceeded();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (px_final &lt;= MIN_PRICE_VALUE) revert MaximumAllowedPriceExceeded();</span></span></code></pre>\n<h2 id=\"g-06-incorrect-usage-of-abdkmath64x64divu-in-constructor\" style=\"position:relative;\"><a href=\"#g-06-incorrect-usage-of-abdkmath64x64divu-in-constructor\" aria-label=\"g 06 incorrect usage of abdkmath64x64divu in constructor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Incorrect usage of <code>ABDKMath64x64.divu</code> in constructor</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">259:        if (py_init.div(py_init.sub(px_init)) &gt; ABDKMath64x64.divu(uint(MAX_PRICE_RATIO), 1)) revert MaximumAllowedPriceRatioExceeded();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">260:        if (py_final.div(py_final.sub(px_final)) &gt; ABDKMath64x64.divu(uint(MAX_PRICE_RATIO), 1)) revert MaximumAllowedPriceRatioExceeded();</span></span></code></pre>\n<p>Function <code>MAX_PRICE_RATIO</code> is declared as <code>int256 constant MAX_PRICE_RATIO = 10**4;</code> and it is only used in the <code>constructor</code>. Having this constant declared as <code>int256</code> and then being cast to <code>uint</code> is an unreasonable waste of gas.</p>\n<p>Declare this constant as uint and do not cast it later:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">201:        uint constant MAX_PRICE_RATIO = 10**4</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(...)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">259:        if (py_init.div(py_init.sub(px_init)) &gt; ABDKMath64x64.divu(MAX_PRICE_RATIO, 1)) revert MaximumAllowedPriceRatioExceeded();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">260:        if (py_final.div(py_final.sub(px_final)) &gt; ABDKMath64x64.divu(MAX_PRICE_RATIO, 1)) revert MaximumAllowedPriceRatioExceeded();</span></span></code></pre>\n<h2 id=\"g-07-unnecessary-double-if-condition-in-_swap-and-_lptokenspecified\" style=\"position:relative;\"><a href=\"#g-07-unnecessary-double-if-condition-in-_swap-and-_lptokenspecified\" aria-label=\"g 07 unnecessary double if condition in _swap and _lptokenspecified permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] Unnecessary double <code>if</code> condition in <code>_swap</code> and <code>_lpTokenSpecified</code></h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: EvolvingProteus.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">529:             if (specifiedToken == SpecifiedToken.X) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">530:                 int256 fixedPoint = xi + roundedSpecifiedAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">531:                 (xf, yf) = _findFinalPoint(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">532:                     fixedPoint,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">533:                     utility,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">534:                     _getPointGivenXandUtility</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">535:                 );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">536:             } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">537:                 int256 fixedPoint = yi + roundedSpecifiedAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">538:                 (xf, yf) = _findFinalPoint(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">539:                     fixedPoint,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">540:                     utility,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">541:                     _getPointGivenYandUtility</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">542:                 );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">543:             }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">544:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">545:         </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">546:         // balance checks with consideration the computed amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">547:         if (specifiedToken == SpecifiedToken.X) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">548:             computedAmount = _applyFeeByRounding(yf - yi, feeDirection);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">549:             _checkBalances(xi + specifiedAmount, yi + computedAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">550:         } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">551:             computedAmount = _applyFeeByRounding(xf - xi, feeDirection);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">552:             _checkBalances(xi + computedAmount, yi + specifiedAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">553:         }</span></span></code></pre>\n<p>Function <code>_swap</code> checks <code>specifiedToken == SpecifiedToken.X</code> condition twice: firstly in line 529, then in line 547. There are no additional operations within those two <code>if</code> blocks, thus, the result of <code>specifiedToken == SpecifiedToken.X</code> will be always the same. This implies that the 2nd <code>if</code> condition can be removed and lines 548-549 can be included in the first <code>if</code> block:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">            int256 utility = _getUtility(xi, yi);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (specifiedToken == SpecifiedToken.X) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                int256 fixedPoint = xi + roundedSpecifiedAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                (xf, yf) = _findFinalPoint(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    fixedPoint,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    utility,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    _getPointGivenXandUtility</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                 computedAmount = _applyFeeByRounding(yf - yi, feeDirection);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                _checkBalances(xi + specifiedAmount, yi + computedAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                int256 fixedPoint = yi + roundedSpecifiedAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                (xf, yf) = _findFinalPoint(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    fixedPoint,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    utility,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    _getPointGivenYandUtility</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                 computedAmount = _applyFeeByRounding(xf - xi, feeDirection);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                _checkBalances(xi + computedAmount, yi + specifiedAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span></code></pre>\n<p>The same issue occurs for <code>_lpTokenSpecified</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: EvolvingProteus.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">626:         if (specifiedToken == SpecifiedToken.X)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">627:             (xf, yf) = _findFinalPoint(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">628:                 yi,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">629:                 uf,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">630:                 _getPointGivenYandUtility</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">631:             );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">632:         else</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">633:             (xf, yf) = _findFinalPoint(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">634:                 xi,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">635:                 uf,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">636:                 _getPointGivenXandUtility</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">637:             );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">638: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">639:         // balance checks with consideration the computed amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">640:         if (specifiedToken == SpecifiedToken.X) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">641:             computedAmount = _applyFeeByRounding(xf - xi, feeDirection);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">642:             _checkBalances(xi + computedAmount, yf);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">643:         } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">644:             computedAmount = _applyFeeByRounding(yf - yi, feeDirection);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">645:             _checkBalances(xf, yi + computedAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">646:         }</span></span></code></pre>\n<h2 id=\"g-08-unnecessary-variable-declaration-in-_reservetokenspecified\" style=\"position:relative;\"><a href=\"#g-08-unnecessary-variable-declaration-in-_reservetokenspecified\" aria-label=\"g 08 unnecessary variable declaration in _reservetokenspecified permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] Unnecessary variable declaration in <code>_reserveTokenSpecified</code></h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: EvolvingProteus.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">589:         uint256 result = Math.mulDiv(uint256(uf), uint256(si), uint256(ui));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">590:         require(result &lt; INT_MAX);   </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">591:         int256 sf = int256(result);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">592: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">593:         // apply fee to the computed amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">594:         computedAmount = _applyFeeByRounding(sf - si, feeDirection);</span></span></code></pre>\n<p>Declaring the <code>int256 sf</code> variable is redundant. Since it’s only being used once (line 594), <code>int256(result)</code> can be used directly: <code>computedAmount = _applyFeeByRounding(int256(result) - si, feeDirection);</code>.</p>\n<h2 id=\"g-09-calculations-which-wont-underflow-can-be-unchecked\" style=\"position:relative;\"><a href=\"#g-09-calculations-which-wont-underflow-can-be-unchecked\" aria-label=\"g 09 calculations which wont underflow can be unchecked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] Calculations which won’t underflow can be <code>unchecked</code></h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">834:        if (absoluteValue &lt; FIXED_FEE * 2) revert AmountError();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">835:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">836:        uint256 roundedAbsoluteAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">837:        if (feeUp) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">838:            roundedAbsoluteAmount =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">839:                absoluteValue +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">840:                (absoluteValue / BASE_FEE) +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">841:                FIXED_FEE;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">842:            require(roundedAbsoluteAmount &lt; INT_MAX);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">843:        } else</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">844:            roundedAbsoluteAmount =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">845:                absoluteValue -</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">846:                (absoluteValue / BASE_FEE) -</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">847:                FIXED_FEE;</span></span></code></pre>\n<p>According to line 834, <code>absoluteValue</code> is at least <code>>= 2 * FIXED_FEE</code> (otherwise, the function will revert with <code>AmountError()</code>). This implies, that lines 844-847 will never underflow.</p>\n<p>In the worst case scenario, <code>absoluteValue = 2 * FIXED_FEE</code> (because <code>if (absoluteValue &#x3C; FIXED_FEE * 2)</code>, then the function will revert). Moreover, we know that <code>BASE_FEE = 800</code> (line 186).</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">roundedAbsoluteAmount = absoluteValue - (absoluteValue / BASE_FEE) - FIXED_FEE;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">for BASE_FEE = 800</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">roundedAbsoluteAmount = absoluteValue - (absoluteValue / 800) - FIXED_FEE;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">for absoluteValue = 2 * FIXED_FEE</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2 * FIXED_FEE - (2 * FIXED_FEE  / 800) - FIXED_FEE = FIXED_FEE - (2 * FIXED_FEE  / 800)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">FIXED_FEE - (2 * FIXED_FEE  / 800) &gt;= 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">800 * FIXED_FEE - 2 * FIXED_FEE &gt;= 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">798 * FIXED_FEE &gt;= 0</span></span></code></pre>\n<p>This implies that calculations won’t underflow and can be inserted into the <code>unchecked</code> block:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"> unchecked{roundedAbsoluteAmount =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                absoluteValue -</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                (absoluteValue / BASE_FEE) -</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                FIXED_FEE;}</span></span></code></pre>\n<h2 id=\"g-10-pre-calculate-equations-which-contain-only-constant-values-in-constructor\" style=\"position:relative;\"><a href=\"#g-10-pre-calculate-equations-which-contain-only-constant-values-in-constructor\" aria-label=\"g 10 pre calculate equations which contain only constant values in constructor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10] Pre-calculate equations which contain only constant values in <code>constructor</code></h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">259:        if (py_init.div(py_init.sub(px_init)) &gt; ABDKMath64x64.divu(uint(MAX_PRICE_RATIO), 1)) revert MaximumAllowedPriceRatioExceeded();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">260:        if (py_final.div(py_final.sub(px_final)) &gt; ABDKMath64x64.divu(uint(MAX_PRICE_RATIO), 1)) revert MaximumAllowedPriceRatioExceeded();</span></span></code></pre>\n<p>Since <code>MAX_PRICE_RATIO</code> is a constant value, the value of <code>ABDKMath64x64.divu(uint(MAX_PRICE_RATIO), 1))</code> can be calculated before compiling the contract.\nCalling <code>ABDKMath64x64.divu</code> on a known, constant value is a waste of gas.</p>\n<h2 id=\"g-11-pre-calculate-equations-which-contains-only-constant-values-in-_getutility\" style=\"position:relative;\"><a href=\"#g-11-pre-calculate-equations-which-contains-only-constant-values-in-_getutility\" aria-label=\"g 11 pre calculate equations which contains only constant values in _getutility permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-11] Pre-calculate equations which contains only constant values in <code>_getUtility</code></h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">709:        int128 two = ABDKMath64x64.divu(uint256(2 * MULTIPLIER), uint256(MULTIPLIER));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">710:        int128 one = ABDKMath64x64.divu(uint256(MULTIPLIER), uint256(MULTIPLIER));</span></span></code></pre>\n<p>Since <code>MULTIPLIER</code> is a constant value, the values of <code>ABDKMath64x64.divu(uint256(2 * MULTIPLIER), uint256(MULTIPLIER))</code> and <code>ABDKMath64x64.divu(uint256(MULTIPLIER), uint256(MULTIPLIER))</code> can be calculated before compiling the contract. Calling <code>ABDKMath64x64.divu</code> on a known, constant value is a waste of gas.</p>\n<h2 id=\"g-12-some-equations-can-be-inlined-to-reduce-number-of-variables-declarations\" style=\"position:relative;\"><a href=\"#g-12-some-equations-can-be-inlined-to-reduce-number-of-variables-declarations\" aria-label=\"g 12 some equations can be inlined to reduce number of variables declarations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-12] Some equations can be inlined to reduce number of variables declarations</h2>\n<p><code>_getUtility</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">int128 two = ABDKMath64x64.divu(uint256(2 * MULTIPLIER), uint256(MULTIPLIER));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int128 one = ABDKMath64x64.divu(uint256(MULTIPLIER), uint256(MULTIPLIER));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int128 aQuad = (a.mul(b).sub(one));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 bQuad = (a.muli(y) + b.muli(x));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 cQuad = x * y;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 disc = int256(Math.sqrt(uint256((bQuad**2 - (aQuad.muli(cQuad)*4)))));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 r0 = (-bQuad*MULTIPLIER + disc*MULTIPLIER) / aQuad.mul(two).muli(MULTIPLIER);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 r1 = (-bQuad*MULTIPLIER - disc*MULTIPLIER) / aQuad.mul(two).muli(MULTIPLIER);</span></span></code></pre>\n<p>Can be changed to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">int128 two = ABDKMath64x64.divu(uint256(2 * MULTIPLIER), uint256(MULTIPLIER));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int128 aQuad = (a.mul(b).sub(ABDKMath64x64.divu(uint256(MULTIPLIER), uint256(MULTIPLIER))));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 bQuad = (a.muli(y) + b.muli(x));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 disc = int256(Math.sqrt(uint256((bQuad**2 - (aQuad.muli(x * y)*4)))));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 r0 = (-bQuad*MULTIPLIER + disc*MULTIPLIER) / aQuad.mul(two).muli(MULTIPLIER);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 r1 = (-bQuad*MULTIPLIER - disc*MULTIPLIER) / aQuad.mul(two).muli(MULTIPLIER);</span></span></code></pre>\n<p><code>_getPointGivenXandUtility</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 a_convert = a.muli(MULTIPLIER);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 b_convert = b.muli(MULTIPLIER);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">x0 = x;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 f_0 = ((( x0  * MULTIPLIER ) / utility) + a_convert);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 f_1 = ((MULTIPLIER * MULTIPLIER / f_0) -  b_convert);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 f_2 = (f_1 * utility) / MULTIPLIER; </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">y0 = f_2;</span></span></code></pre>\n<p>Can be changed to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">x0 = x;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">y0 = (((MULTIPLIER * MULTIPLIER / ((( x0  * MULTIPLIER ) / utility) + a.muli(MULTIPLIER))) -  b.muli(MULTIPLIER)) * utility) / MULTIPLIER;</span></span></code></pre>\n<p><code>_getPointGivenYandUtility</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 a_convert = a.muli(MULTIPLIER);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 b_convert = b.muli(MULTIPLIER);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">y0 = y;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 f_0 = (( y0  * MULTIPLIER ) / utility) + b_convert;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 f_1 = ( ((MULTIPLIER)*(MULTIPLIER) / f_0) - a_convert );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">int256 f_2 = (f_1 * utility) / (MULTIPLIER); </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">x0 = f_2;</span></span></code></pre>\n<p>Can be changed to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">y0 = y;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">x0 = (( ((MULTIPLIER)*(MULTIPLIER) / (( y0  * MULTIPLIER ) / utility) + b.muli(MULTIPLIER)) - a.muli(MULTIPLIER) ) * utility) / (MULTIPLIER);</span></span></code></pre>\n<h2 id=\"g-13-_getutility-calculates-the-same-value-twice\" style=\"position:relative;\"><a href=\"#g-13-_getutility-calculates-the-same-value-twice\" aria-label=\"g 13 _getutility calculates the same value twice permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-13] <code>_getUtility</code> calculates the same value twice</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">717:        int256 r0 = (-bQuad*MULTIPLIER + disc*MULTIPLIER) / aQuad.mul(two).muli(MULTIPLIER);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">718:        int256 r1 = (-bQuad*MULTIPLIER - disc*MULTIPLIER) / aQuad.mul(two).muli(MULTIPLIER);</span></span></code></pre>\n<p>Cache results of <code>-bQuad*MULTIPLIER</code>, <code>disc*MULTIPLIER</code> and <code>aQuad.mul(two).muli(MULTIPLIER)</code> to not calculate it twice.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/120#issuecomment-1704643561\">viraj124 (Shell) acknowledged</a></strong></p>\n<hr>\n<h1 id=\"audit-analysis\" style=\"position:relative;\"><a href=\"#audit-analysis\" aria-label=\"audit analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit Analysis</h1>\n<p>For this audit, 11 analysis reports were submitted by wardens. An analysis report examines the codebase as a whole, providing observations and advice on such topics as architecture, mechanism, or approach. The <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/137\">report highlighted below</a> by <strong>0xSmartContract</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/246\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/225\">catellatech</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/139\">ihtishamsudo</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/69\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/266\">carrotsmuggler</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/251\">rjs</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/231\">0xmystery</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/226\">plainshift</a>, <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/157\">pfapostol</a>, and <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/106\">moneyversed</a>.</em></p>\n<h3 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h3>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Head</th>\n<th align=\"left\">Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\">The approach I followed when reviewing the code</td>\n<td align=\"left\">Stages in my code review and analysis</td>\n</tr>\n<tr>\n<td align=\"left\">Analysis of the code base</td>\n<td align=\"left\">What is unique? How are the existing patterns used?</td>\n</tr>\n<tr>\n<td align=\"left\">Test analysis</td>\n<td align=\"left\">Test scope of the project and quality of tests</td>\n</tr>\n<tr>\n<td align=\"left\">Centralization risks</td>\n<td align=\"left\">How was the risk of centralization handled in the p project, what could be alternatives?</td>\n</tr>\n<tr>\n<td align=\"left\">Systemic risks</td>\n<td align=\"left\">Potential systemic risks in the project</td>\n</tr>\n<tr>\n<td align=\"left\">Competition analysis</td>\n<td align=\"left\">What are similar projects?</td>\n</tr>\n<tr>\n<td align=\"left\">Security Approach of the Project</td>\n<td align=\"left\">Audit approach of the Project</td>\n</tr>\n<tr>\n<td align=\"left\">Other Audit Reports and Automated Findings</td>\n<td align=\"left\">What are the previous Audit reports and their analysis</td>\n</tr>\n<tr>\n<td align=\"left\">Gas Optimization</td>\n<td align=\"left\">Gas usage approach of the project and alternative solutions to it</td>\n</tr>\n<tr>\n<td align=\"left\">Other recommendations</td>\n<td align=\"left\">What is unique? How are the existing patterns used?</td>\n</tr>\n<tr>\n<td align=\"left\">New insights and learning from this audit</td>\n<td align=\"left\">Things learned from the project</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"the-approach-i-followed-when-reviewing-the-code\" style=\"position:relative;\"><a href=\"#the-approach-i-followed-when-reviewing-the-code\" aria-label=\"the approach i followed when reviewing the code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The approach I followed when reviewing the code</h3>\n<p>First, by examining the scope of the code, I determined my code review and analysis strategy for the <a href=\"https://github.com/code-423n4/2023-08-shell\">Shell Protocol</a>.</p>\n<p>I analyzed and audited the subject in the following steps:</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Stage</th>\n<th align=\"left\">Details</th>\n<th align=\"left\">Information</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\">Compile and Run Test</td>\n<td align=\"left\"><a href=\"https://github.com/code-423n4/2023-08-shell#testing\">Installation</a></td>\n<td align=\"left\">Test and installation structure is simple, cleanly designed.</td>\n</tr>\n<tr>\n<td align=\"left\">Architecture Review</td>\n<td align=\"left\">The <a href=\"https://shell-protocol.notion.site/Proteus-AMM-Engine-Update-3-7f33b7e1561347b696874a8ba02b9782\">Proteus-AMM</a> explainer provides a high-level overview of the Project system and then describe the core components.</td>\n<td align=\"left\">Provides a basic architectural teaching for General Architecture.</td>\n</tr>\n<tr>\n<td align=\"left\">Graphical Analysis</td>\n<td align=\"left\">Graphical Analysis with <a href=\"https://github.com/ConsenSys/solidity-metrics\">Solidity-metrics</a></td>\n<td align=\"left\">A visual view has been made to dominate the general structure of the codes of the project.</td>\n</tr>\n<tr>\n<td align=\"left\">Slither Analysis</td>\n<td align=\"left\"><a href=\"https://github.com/crytic/slither\">Slither Report</a></td>\n<td align=\"left\">The project does not currently have a slither result, a slither control was created from scratch.</td>\n</tr>\n<tr>\n<td align=\"left\">Test Suits</td>\n<td align=\"left\"><a href=\"https://github.com/code-423n4/2023-08-shell/tree/main/src/test\">Tests</a></td>\n<td align=\"left\">In this section, the scope and content of the tests of the project are analyzed.</td>\n</tr>\n<tr>\n<td align=\"left\">Manual Code Review</td>\n<td align=\"left\"><a href=\"https://github.com/code-423n4/2023-08-shell#scope\">Scope</a></td>\n<td align=\"left\">Top-down analysis of codes according to architectural design, IDE used: VsCode.</td>\n</tr>\n<tr>\n<td align=\"left\">Project White Paper</td>\n<td align=\"left\"><a href=\"https://shell-protocol.notion.site/Proteus-AMM-Engine-Update-3-7f33b7e1561347b696874a8ba02b9782\">WhitePaper</a></td>\n<td align=\"left\"></td>\n</tr>\n<tr>\n<td align=\"left\">Infographic</td>\n<td align=\"left\"><a href=\"https://www.figma.com/\">Figma</a></td>\n<td align=\"left\">I made Visual drawings to understand the hard-to-understand mechanisms.</td>\n</tr>\n<tr>\n<td align=\"left\">Special focus on Areas of Concern</td>\n<td align=\"left\"><a href=\"https://github.com/code-423n4/2023-08-shell#use-cases-for-evolving-proteus\">Areas of Concern</a></td>\n<td align=\"left\">Evolving Proteus’s algorithm has six parameters that determine liquidity concentration.</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"analysis-of-the-code-base\" style=\"position:relative;\"><a href=\"#analysis-of-the-code-base\" aria-label=\"analysis of the code base permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Analysis of the code base</h3>\n<p>Image #1:\n<img src=\"https://user-images.githubusercontent.com/135237830/272598282-fc7ef308-e406-4d35-8ead-b66a0815ced1.png\" alt=\"https://user-images.githubusercontent.com/135237830/272598282-fc7ef308-e406-4d35-8ead-b66a0815ced1.png\">\n<br></p>\n<p>Image #2:\n<img src=\"https://user-images.githubusercontent.com/135237830/272598604-957b19f6-97a7-47d0-9b47-b2f81c6b046b.png\" alt=\"https://user-images.githubusercontent.com/135237830/272598604-957b19f6-97a7-47d0-9b47-b2f81c6b046b.png\">\n<br></p>\n<h3 id=\"test-analysis\" style=\"position:relative;\"><a href=\"#test-analysis\" aria-label=\"test analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test analysis</h3>\n<p><em>Note: image has been removed due to an outdated link</em></p>\n<p>ForkEvolvingProteus.t.sol : </p>\n<ul>\n<li>Invariant tests can be great tools for shaking out invalid assumptions, complex edge cases, and unexpected interactions in a smart contract system. But it can also be challenging to channel the fuzzer’s unconstrained chaos into a suite of meaningful, reliable tests.</li>\n</ul>\n<h3 id=\"evolving-proteus-invariants-test-list--forkevolvingproteustsol-\" style=\"position:relative;\"><a href=\"#evolving-proteus-invariants-test-list--forkevolvingproteustsol-\" aria-label=\"evolving proteus invariants test list  forkevolvingproteustsol  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Evolving Proteus Invariants test list ( ForkEvolvingProteus.t.sol ):</h3>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Number</th>\n<th align=\"left\">Head</th>\n<th align=\"left\">Test Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\">1.</td>\n<td align=\"left\">Token balance check</td>\n<td align=\"left\">The differences in pool token balances after a swap is same as the differences in user token balances after factoring in the fee.</td>\n</tr>\n<tr>\n<td align=\"left\">2.</td>\n<td align=\"left\">Token supply check</td>\n<td align=\"left\">Utility &#x26; utility/lp token supply does not decrease after swap.</td>\n</tr>\n<tr>\n<td align=\"left\">3.</td>\n<td align=\"left\">Deposit check</td>\n<td align=\"left\">For a deposit, utility will always increase, and util/lp does not decrease.</td>\n</tr>\n<tr>\n<td align=\"left\">4.</td>\n<td align=\"left\">Withdraw check</td>\n<td align=\"left\">For a withdrawl, utility will always decrease, and util/lp does not decrease.</td>\n</tr>\n<tr>\n<td align=\"left\">5.</td>\n<td align=\"left\">Soft invariant</td>\n<td align=\"left\">x price decreases over time &#x26; y price stays constant.</td>\n</tr>\n<tr>\n<td align=\"left\">6.</td>\n<td align=\"left\">Soft invariant</td>\n<td align=\"left\">when x price increases over time &#x26; y price stays constant.</td>\n</tr>\n<tr>\n<td align=\"left\">7.</td>\n<td align=\"left\">Soft invariant</td>\n<td align=\"left\">when y price decreases over time &#x26; x price stays constant.</td>\n</tr>\n<tr>\n<td align=\"left\">8.</td>\n<td align=\"left\">Soft invariant</td>\n<td align=\"left\">when y price increases over time &#x26; x price stays constant.</td>\n</tr>\n<tr>\n<td align=\"left\">9.</td>\n<td align=\"left\">Soft invariant</td>\n<td align=\"left\">when x &#x26; y prices both increase with time.</td>\n</tr>\n<tr>\n<td align=\"left\">10.</td>\n<td align=\"left\">Soft invariant</td>\n<td align=\"left\">when x &#x26; y prices both decrease with time.</td>\n</tr>\n<tr>\n<td align=\"left\">11.</td>\n<td align=\"left\">Soft invariant</td>\n<td align=\"left\">when x &#x26; y prices both stay constant.</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"invariant-tests-recommended-to-be-added-forkevolvingproteustsol\" style=\"position:relative;\"><a href=\"#invariant-tests-recommended-to-be-added-forkevolvingproteustsol\" aria-label=\"invariant tests recommended to be added forkevolvingproteustsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Invariant tests recommended to be added (ForkEvolvingProteus.t.sol):</h3>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Number</th>\n<th align=\"left\">Head</th>\n<th align=\"left\">Test Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\">1.</td>\n<td align=\"left\">Soft invariant</td>\n<td align=\"left\">when x price increases over time &#x26; y price decreases.</td>\n</tr>\n<tr>\n<td align=\"left\">2.</td>\n<td align=\"left\">Soft invariant</td>\n<td align=\"left\">when y price increases over time &#x26; x price decreases.</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"centralization-risks\" style=\"position:relative;\"><a href=\"#centralization-risks\" aria-label=\"centralization risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Centralization risks</h3>\n<p>There is no centrality risk in the controlled scope.</p>\n<h3 id=\"systemic-risks\" style=\"position:relative;\"><a href=\"#systemic-risks\" aria-label=\"systemic risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Systemic risks</h3>\n<p>We can talk about a systemic risk here because there are some Layer2 special cases.</p>\n<p>If Arbitrum is compile <a href=\"https://developer.arbitrum.io/solidity-support\">Compatible</a> with 0.8.20 and newer, contracts compiled with these versions will result in a non-functional or potentially damaged version that does not behave as expected. The default behavior of the compiler will be to use the latest version which means it will compile with version 0.8.20 which will produce broken code by default.</p>\n<p>According to the given code, this problem does not exist, but it should be taken care of while deploying.</p>\n<h3 id=\"competition-analysis\" style=\"position:relative;\"><a href=\"#competition-analysis\" aria-label=\"competition analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Competition analysis</h3>\n<p>Other projects with a similar structure to the project:</p>\n<ol>\n<li><a href=\"https://app.dfx.finance/\">dfx finance</a></li>\n<li><a href=\"https://docs.gamma.xyz/gamma/\">Gamma</a></li>\n<li><a href=\"https://github.com/osmosis-labs/osmosis\">Osmosis</a></li>\n</ol>\n<p>However, with its mathematical modeling, the Shell Protocol is unique.</p>\n<h3 id=\"security-approach-of-the-project\" style=\"position:relative;\"><a href=\"#security-approach-of-the-project\" aria-label=\"security approach of the project permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Security Approach of the Project</h3>\n<p><strong>Successful current security understandings of the project:</strong></p>\n<ol>\n<li>The most important security point of Shell protocol is contracts are non-custodial, meaning NOBODY (not even the core team or the Shell DAO) is able to access the funds held in any of the core contracts. </li>\n<li>Proteus Pool Safeguards System; a pool’s deployer can assign a wallet the ability to freeze the pool in case of an emergency. LPs may still withdraw their tokens, but swaps and deposits are disabled.\nThe Shell core team controls a 2/3 multi-signature wallet, the <code>ShellMultiSig</code>, that can freeze trading on Proteus pools assigned to it.</li>\n<li>\n<p>On-Chain Monitoring System; Shell conducts on-chain security monitoring with Forta. Anyone can subscribe to updates from the Shell Forta bot. This bot tracks Shell transactions in which wrapping, unwrapping, swapping, depositing, or withdrawals occur over a threshold amount. If transactions occur with unusually high token amounts, the bot sends out an alert.</p>\n<p><a href=\"https://app.forta.network/bot/0x7f9afc392329ed5a473bcf304565adf9c2588ba4bc060f7d215519005b8303e3\">https://app.forta.network/bot/0x7f9afc392329ed5a473bcf304565adf9c2588ba4bc060f7d215519005b8303e3</a></p>\n</li>\n<li>\n<p>First, they created the main audit from a reputable auditing organization like Trail of Bits and resolved all the security concerns in the report.</p>\n<p><a href=\"https://github.com/trailofbits/publications/blob/master/reviews/ShellProtocolv2.pdf\">https://github.com/trailofbits/publications/blob/master/reviews/ShellProtocolv2.pdf</a></p>\n</li>\n<li>They manage the 2nd audit process with an innovative audit such as Code4rena, in which many auditors examine the codes.</li>\n<li>They set the <code>$</code>100,000 <a href=\"https://immunefi.com/bounty/shellprotocol/\">ImmuneFi reward</a>.</li>\n</ol>\n<p><strong>What the project should add in the understanding of Security:</strong></p>\n<ol>\n<li>By distributing the project to testnets, this ensures that the audits are carried out in an on-chain audit (this will increase coverage).</li>\n<li>After the project is published on the mainnet, there should be emergency action plans (not found in the documents).</li>\n<li>No pause mechanism; this is a chaotic situation, which can be thought of as a choice between decentralization and security. Having a pause mechanism makes sense in order not to damage user funds in case of a possible problem in the project.</li>\n<li>No upgradability; there are use cases of the upgradable pattern in defi projects using mathematical models, but it is a design and security option.</li>\n</ol>\n<h3 id=\"other-audit-reports-and-automated-findings\" style=\"position:relative;\"><a href=\"#other-audit-reports-and-automated-findings\" aria-label=\"other audit reports and automated findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Other Audit Reports and Automated Findings</h3>\n<p>Especially low detections in the <a href=\"https://github.com/code-423n4/2023-08-shell/blob/main/bot-report.md\">Automated Finding Report</a> should be taken into account.</p>\n<p><strong>Other Audit Reports (TrailOfBits):</strong></p>\n<p>Here is a summary of the issues found in the audit report with Exposure Analysis and Category details:</p>\n<p><a href=\"https://github.com/trailofbits/publications/blob/master/reviews/ShellProtocolv2.pdf\">Audit Report TrailOfBits</a></p>\n<p><img src=\"https://user-images.githubusercontent.com/135237830/272598859-9f8e7dca-3da4-4b21-b828-6264b275b936.png\" alt=\"https://user-images.githubusercontent.com/135237830/272598859-9f8e7dca-3da4-4b21-b828-6264b275b936.png\"></p>\n<h3 id=\"gas-optimization\" style=\"position:relative;\"><a href=\"#gas-optimization\" aria-label=\"gas optimization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimization</h3>\n<p>The project is generally efficient in terms of gas optimizations, many generally accepted gas optimizations have been implemented. Gas optimizations with minor effects are already mentioned in automatic finding, but gas optimizations will not be a priority considering code readability and codebase size.</p>\n<p><strong>Gas Optimization Recommendations</strong></p>\n<ol>\n<li>The highest gas expenditure in the project occurs when creating pool instances. If the architecture here was designed like the singleton architecture in UniswapV4, gas savings will be close to 90%.</li>\n<li>The most important gas usage of the contract subject to the audit is the <code>ABDKMath64x64.sol</code> library that it uses. More gas optimized by <a href=\"https://github.com/PaulRBerg/prb-math\">prb-math</a> may be preferred. Detailed gas comparisons are available on the project’s github link</li>\n</ol>\n<h3 id=\"prbmath\" style=\"position:relative;\"><a href=\"#prbmath\" aria-label=\"prbmath permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PRBMath</h3>\n<p>Gas estimations based on the <a href=\"https://github.com/PaulRBerg/prb-math/releases/tag/v2.0.1\">v2.0.1</a> and the\n<a href=\"https://github.com/PaulRBerg/prb-math/releases/tag/v3.0.0\">v3.0.0</a> releases.</p>\n<table>\n<thead>\n<tr>\n<th>SD59x18</th>\n<th>Min</th>\n<th>Max</th>\n<th>Avg</th>\n<th></th>\n<th>UD60x18</th>\n<th>Min</th>\n<th>Max</th>\n<th>Avg</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>abs</td>\n<td>68</td>\n<td>72</td>\n<td>70</td>\n<td></td>\n<td>n/a</td>\n<td>n/a</td>\n<td>n/a</td>\n<td>n/a</td>\n</tr>\n<tr>\n<td>avg</td>\n<td>95</td>\n<td>105</td>\n<td>100</td>\n<td></td>\n<td>avg</td>\n<td>57</td>\n<td>57</td>\n<td>57</td>\n</tr>\n<tr>\n<td>ceil</td>\n<td>82</td>\n<td>117</td>\n<td>101</td>\n<td></td>\n<td>ceil</td>\n<td>78</td>\n<td>78</td>\n<td>78</td>\n</tr>\n<tr>\n<td>div</td>\n<td>431</td>\n<td>483</td>\n<td>451</td>\n<td></td>\n<td>div</td>\n<td>205</td>\n<td>205</td>\n<td>205</td>\n</tr>\n<tr>\n<td>exp</td>\n<td>38</td>\n<td>2797</td>\n<td>2263</td>\n<td></td>\n<td>exp</td>\n<td>1874</td>\n<td>2742</td>\n<td>2244</td>\n</tr>\n<tr>\n<td>exp2</td>\n<td>63</td>\n<td>2678</td>\n<td>2104</td>\n<td></td>\n<td>exp2</td>\n<td>1784</td>\n<td>2652</td>\n<td>2156</td>\n</tr>\n<tr>\n<td>floor</td>\n<td>82</td>\n<td>117</td>\n<td>101</td>\n<td></td>\n<td>floor</td>\n<td>43</td>\n<td>43</td>\n<td>43</td>\n</tr>\n<tr>\n<td>frac</td>\n<td>23</td>\n<td>23</td>\n<td>23</td>\n<td></td>\n<td>frac</td>\n<td>23</td>\n<td>23</td>\n<td>23</td>\n</tr>\n<tr>\n<td>gm</td>\n<td>26</td>\n<td>892</td>\n<td>690</td>\n<td></td>\n<td>gm</td>\n<td>26</td>\n<td>893</td>\n<td>691</td>\n</tr>\n<tr>\n<td>inv</td>\n<td>40</td>\n<td>40</td>\n<td>40</td>\n<td></td>\n<td>inv</td>\n<td>40</td>\n<td>40</td>\n<td>40</td>\n</tr>\n<tr>\n<td>ln</td>\n<td>463</td>\n<td>7306</td>\n<td>4724</td>\n<td></td>\n<td>ln</td>\n<td>419</td>\n<td>6902</td>\n<td>3814</td>\n</tr>\n<tr>\n<td>log10</td>\n<td>104</td>\n<td>9074</td>\n<td>4337</td>\n<td></td>\n<td>log10</td>\n<td>503</td>\n<td>8695</td>\n<td>4571</td>\n</tr>\n<tr>\n<td>log2</td>\n<td>377</td>\n<td>7241</td>\n<td>4243</td>\n<td></td>\n<td>log2</td>\n<td>330</td>\n<td>6825</td>\n<td>3426</td>\n</tr>\n<tr>\n<td>mul</td>\n<td>455</td>\n<td>463</td>\n<td>459</td>\n<td></td>\n<td>mul</td>\n<td>219</td>\n<td>275</td>\n<td>247</td>\n</tr>\n<tr>\n<td>pow</td>\n<td>64</td>\n<td>11338</td>\n<td>8518</td>\n<td></td>\n<td>pow</td>\n<td>64</td>\n<td>10637</td>\n<td>6635</td>\n</tr>\n<tr>\n<td>powu</td>\n<td>293</td>\n<td>24745</td>\n<td>5681</td>\n<td></td>\n<td>powu</td>\n<td>83</td>\n<td>24535</td>\n<td>5471</td>\n</tr>\n<tr>\n<td>sqrt</td>\n<td>140</td>\n<td>839</td>\n<td>716</td>\n<td></td>\n<td>sqrt</td>\n<td>114</td>\n<td>846</td>\n<td>710</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"abdkmath64x64\" style=\"position:relative;\"><a href=\"#abdkmath64x64\" aria-label=\"abdkmath64x64 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ABDKMath64x64</h3>\n<p>Gas estimations based on the v3.0 release of ABDKMath. See my <a href=\"https://github.com/PaulRBerg/abdk-gas-estimations\">abdk-gas-estimations</a> repo.</p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>Min</th>\n<th>Max</th>\n<th>Avg</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>abs</td>\n<td>88</td>\n<td>92</td>\n<td>90</td>\n</tr>\n<tr>\n<td>avg</td>\n<td>41</td>\n<td>41</td>\n<td>41</td>\n</tr>\n<tr>\n<td>div</td>\n<td>168</td>\n<td>168</td>\n<td>168</td>\n</tr>\n<tr>\n<td>exp</td>\n<td>77</td>\n<td>3780</td>\n<td>2687</td>\n</tr>\n<tr>\n<td>exp2</td>\n<td>77</td>\n<td>3600</td>\n<td>2746</td>\n</tr>\n<tr>\n<td>gavg</td>\n<td>166</td>\n<td>875</td>\n<td>719</td>\n</tr>\n<tr>\n<td>inv</td>\n<td>157</td>\n<td>157</td>\n<td>157</td>\n</tr>\n<tr>\n<td>ln</td>\n<td>7074</td>\n<td>7164</td>\n<td>7126</td>\n</tr>\n<tr>\n<td>log2</td>\n<td>6972</td>\n<td>7062</td>\n<td>7024</td>\n</tr>\n<tr>\n<td>mul</td>\n<td>111</td>\n<td>111</td>\n<td>111</td>\n</tr>\n<tr>\n<td>pow</td>\n<td>303</td>\n<td>4740</td>\n<td>1792</td>\n</tr>\n<tr>\n<td>sqrt</td>\n<td>129</td>\n<td>809</td>\n<td>699</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"other-recommendations\" style=\"position:relative;\"><a href=\"#other-recommendations\" aria-label=\"other recommendations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Other recommendations</h3>\n<ul>\n<li>Logic similar to the singleton pattern similar to Uniswapv4 can be used in a project. This is a gas-optimized and innovative solution\n(expressed for the overall project, not for the audit contract).</li>\n<li>\n<p>The use of assembly in project codes is very low. I especially recommend using such useful and gas-optimized code patterns:</p>\n<p><a href=\"https://github.com/dragonfly-xyz/useful-solidity-patterns/tree/main/patterns/assembly-tricks-1\">https://github.com/dragonfly-xyz/useful-solidity-patterns/tree/main/patterns/assembly-tricks-1</a></p>\n</li>\n<li>\n<p>It is seen that the latest versions of imported important libraries such as Openzeppelin are not used in the project codes; it should be noted.</p>\n<p><a href=\"https://security.snyk.io/package/npm/@openzeppelin%2Fcontracts/\">https://security.snyk.io/package/npm/@openzeppelin%2Fcontracts/</a></p>\n</li>\n<li>\n<p>A good model can be used to systematically assess the risk of the project, for example, this modeling is recommended:</p>\n<p><a href=\"https://www.notion.so/Smart-Contract-Risk-Assessment-3b067bc099ce4c31a35ef28b011b92ff#7770b3b385444779bf11e677f16e101e\">https://www.notion.so/Smart-Contract-Risk-Assessment-3b067bc099ce4c31a35ef28b011b92ff#7770b3b385444779bf11e677f16e101e</a></p>\n</li>\n</ul>\n<p>Here are my other suggestions for corrections, the details of which are in my <a href=\"https://github.com/code-423n4/2023-08-shell-findings/blob/main/data/0xSmartContract-Q.md\">QA Report</a>.</p>\n<ul>\n<li><strong>L-01</strong> - <code>result</code> require  block  is inconsistent with NatSpec comment</li>\n<li><strong>L-02</strong> - <code>libusb</code> dependency can be a security risk</li>\n<li><strong>L-03</strong> - There is a difference in the formula with the NatSpec comments</li>\n<li><strong>L-04</strong> - There may be problems with the use of Arbitrum</li>\n<li><strong>N-01</strong> - Project Upgrade and Stop Scenario should be</li>\n<li><strong>N-02</strong> - Missing Event for initialize</li>\n</ul>\n<h3 id=\"new-insights-and-learning-from-this-audit\" style=\"position:relative;\"><a href=\"#new-insights-and-learning-from-this-audit\" aria-label=\"new insights and learning from this audit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>New insights and learning from this audit</h3>\n<ul>\n<li><code>ForkEvolvingProteus.t.sol</code> invariant tests are extensive, quality tests in a high-mathematical computational project and are remarkable. The project developers did a great job!</li>\n<li>I learned, in depth, the usage and details of <code>ABDKMath64x64.sol</code> library.</li>\n</ul>\n<h3 id=\"time-spent\" style=\"position:relative;\"><a href=\"#time-spent\" aria-label=\"time spent permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Time spent:</h3>\n<p>13 hours</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/137#issuecomment-1700399008\">0xRobocop (lookout) commented</a>:</strong></p>\n<blockquote>\n<p>In my point of view, although the report does not touch a core area of concern specific to the code like <a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/69\">Issue #69</a>, the report is pretty complete in terms of security, as a holistic approach. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-shell-findings/issues/137#issuecomment-1704719090\">viraj124 (Shell) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>A few observations:</p>\n<ul>\n<li>Regarding the invariant not testing when prices move in opposite directions, the reason for that is the behaviour is not consistent. Hence, we kept that out of scope for the audit and we won’t be using that price configuration in the near future.</li>\n<li>Regarding singleton behaviour, all our accounting for all different pools is done in the ocean, so that compensates for deploying different contracts for each pool. That being said, we might change that in the future if needed. For now, due to the architecture of the ocean and for us to support more defi primitives like lending and option markets and not just be limited to amm’s, we decided not to go with the singleton pool deployment approach.</li>\n</ul>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-1\">High Risk Findings (1)</a></p>\n<ul>\n<li><a href=\"#h-01-lack-of-balance-validation\">[H-01] Lack of Balance Validation</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#01-recommended-to-add-an-input-validation-for-the-duration-variable-in-the-constructor\">01 RECOMMENDED TO ADD AN INPUT VALIDATION FOR THE <code>duration</code> VARIABLE IN THE <code>constructor</code></a></li>\n<li><a href=\"#02-discrepancy-between-natspec-comments-and-logic-implementation\">02 DISCREPANCY BETWEEN NATSPEC COMMENTS AND LOGIC IMPLEMENTATION</a></li>\n<li><a href=\"#03-discrepancy-between-natspec-comment-and-logic-implementation-of-the-withdrawgiveninputamount-function\">03 DISCREPANCY BETWEEN NATSPEC COMMENT AND LOGIC IMPLEMENTATION OF THE <code>withdrawGivenInputAmount</code> FUNCTION</a></li>\n<li><a href=\"#04-erroneous-natspec-comments-should-be-corrected\">04 ERRONEOUS NATSPEC COMMENTS SHOULD BE CORRECTED</a></li>\n<li><a href=\"#05-add-meaningful-revert-messages-to-the-require-statements\">05 ADD MEANINGFUL <code>revert</code> MESSAGES TO THE <code>require</code> STATEMENTS</a></li>\n<li><a href=\"#06-min_balance-invariant-is-not-checked-for-the-final-lp-token-supply-amount-in-the-_reservetokenspecified-function-thus-breaking-expected-behaviour-of-the-protocol\">06 <code>MIN_BALANCE</code> INVARIANT IS NOT CHECKED FOR THE FINAL LP TOKEN SUPPLY AMOUNT IN THE <code>_reserveTokenSpecified</code> FUNCTION, THUS BREAKING EXPECTED BEHAVIOUR OF THE PROTOCOL</a></li>\n<li><a href=\"#07-_checkbalances-function-breaks-the-expected-behaviour-of-the-protocol-due-to-erroneous-conditional-check\">07 <code>_checkBalances</code> FUNCTION BREAKS THE EXPECTED BEHAVIOUR OF THE PROTOCOL DUE TO ERRONEOUS CONDITIONAL CHECK</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-do-not-calculate-constants\">G-01 Do not calculate constants</a></li>\n<li><a href=\"#g-02-do-not-initialize-variables-with-default-values\">G-02 Do not initialize variables with default values</a></li>\n<li><a href=\"#g-03-the-result-of-function-calls-should-be-cached-rather-than-re-calling-the-function\">G-03 The result of function calls should be cached rather than re-calling the function</a></li>\n<li><a href=\"#g-04-more-likely-to-revert-operations-should-be-executed-first\">G-04 More likely to revert operations should be executed first</a></li>\n<li><a href=\"#g-05-or-in-if-condition-can-be-rewritten-to-two-single-if-conditions\">G-05 OR in <code>if</code>-condition can be rewritten to two single <code>if</code> conditions</a></li>\n<li><a href=\"#g-06-incorrect-usage-of-abdkmath64x64divu-in-constructor\">G-06 Incorrect usage of <code>ABDKMath64x64.divu</code> in constructor</a></li>\n<li><a href=\"#g-07-unnecessary-double-if-condition-in-_swap-and-_lptokenspecified\">G-07 Unnecessary double <code>if</code> condition in <code>_swap</code> and <code>_lpTokenSpecified</code></a></li>\n<li><a href=\"#g-08-unnecessary-variable-declaration-in-_reservetokenspecified\">G-08 Unnecessary variable declaration in <code>_reserveTokenSpecified</code></a></li>\n<li><a href=\"#g-09-calculations-which-wont-underflow-can-be-unchecked\">G-09 Calculations which won’t underflow can be <code>unchecked</code></a></li>\n<li><a href=\"#g-10-pre-calculate-equations-which-contain-only-constant-values-in-constructor\">G-10 Pre-calculate equations which contain only constant values in <code>constructor</code></a></li>\n<li><a href=\"#g-11-pre-calculate-equations-which-contains-only-constant-values-in-_getutility\">G-11 Pre-calculate equations which contains only constant values in <code>_getUtility</code></a></li>\n<li><a href=\"#g-12-some-equations-can-be-inlined-to-reduce-number-of-variables-declarations\">G-12 Some equations can be inlined to reduce number of variables declarations</a></li>\n<li><a href=\"#g-13-_getutility-calculates-the-same-value-twice\">G-13 <code>_getUtility</code> calculates the same value twice</a></li>\n</ul>\n</li>\n<li><a href=\"#audit-analysis\">Audit Analysis</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}