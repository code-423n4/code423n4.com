{
  "circa": {
    "title": "Malt Finance contest",
    "sponsor": "Malt Finance",
    "slug": "2021-11-malt",
    "date": "2022-02-14",
    "findings": "https://github.com/code-423n4/2021-11-malt-findings/issues",
    "contest": 59
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the code contest outlined in this document, C4 conducted an analysis of Malt Finance contest smart contract system written in Solidity. The code contest took place between November 25—December 1 2021.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>35 Wardens contributed reports to the Malt Finance contest:</p>\n<ol>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li><a href=\"https://twitter.com/liam_eastwood13\">leastwood</a></li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li>harleythedog</li>\n<li>0x0x0x</li>\n<li>jayjonah8</li>\n<li><a href=\"https://twitter.com/Meta0xNull\">Meta0xNull</a></li>\n<li>hyh</li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li>ScopeLift (<a href=\"https://github.com/wildmolasses\">wildmolasses</a>, <a href=\"https://twitter.com/BenDiFrancesco\">bendi</a>, <a href=\"https://twitter.com/msolomon44/\">mds1</a>)</li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"https://twitter.com/gpersoon\">gpersoon</a></li>\n<li>TomFrench</li>\n<li>stonesandtrees</li>\n<li><a href=\"https://twitter.com/xYrYuYx\">xYrYuYx</a></li>\n<li><a href=\"https://twitter.com/GiveMeTestEther\">GiveMeTestEther</a></li>\n<li>0x1f8b</li>\n<li><a href=\"https://twitter.com/_ye0lde\">ye0lde</a></li>\n<li><a href=\"https://twitter.com/n4th4n131?t=ZXGbALC3q6JMMoolZddgHg&#x26;s=09\">nathaniel</a></li>\n<li>robee</li>\n<li><a href=\"https://twitter.com/merkleplant_eth\">pmerkleplant</a></li>\n<li>0xwags</li>\n<li>Koustre</li>\n<li><a href=\"https://twitter.com/danbinnun\">danb</a></li>\n<li><a href=\"https://twitter.com/BouSalman\">BouSalman</a></li>\n<li><a href=\"https://twitter.com/sabtikw\">sabtikw</a></li>\n<li>hagrid</li>\n<li><a href=\"https://twitter.com/tabishjshaikh\">tabish</a></li>\n<li><a href=\"https://twitter.com/loop_225\">loop</a></li>\n<li>thank_you</li>\n<li><a href=\"https://twitter.com/shenwilly_\">shenwilly</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/GalloDaSballo\">Alex the Entreprenerd</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/CloudEllie1\">CloudEllie</a> and <a href=\"https://twitter.com/itsmetechjay\">itsmetechjay</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 78 unique vulnerabilities and 178 total findings. All of the issues presented here are linked back to their original finding.</p>\n<p>Of these vulnerabilities, 5 received a risk rating in the category of HIGH severity, 30 received a risk rating in the category of MEDIUM severity, and 43 received a risk rating in the category of LOW severity.</p>\n<p>C4 analysis also identified 25 non-critical recommendations and 75 gas optimizations.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2021-11-malt\">C4 Malt Finance contest repository</a>, and is composed of 24 smart contracts written in the Solidity programming language and includes 4,452 source lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-5\" style=\"position:relative;\"><a href=\"#high-risk-findings-5\" aria-label=\"high risk findings 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (5)</h1>\n<h2 id=\"h-01-timelock-can-be-bypassed\" style=\"position:relative;\"><a href=\"#h-01-timelock-can-be-bypassed\" aria-label=\"h 01 timelock can be bypassed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/263\">[H-01] Timelock can be bypassed</a></h2>\n<p><em>Submitted by WatchPug, also found by 0x0x0x and gzeon</em></p>\n<p>The purpose of a Timelock contract is to put a limit on the privileges of the <code>governor</code>, by forcing a two step process with a preset delay time.</p>\n<p>However, we found that the current implementation actually won’t serve that purpose as it allows the <code>governor</code> to execute any transactions without any constraints.</p>\n<p>To do that, the current governor can call <code>Timelock#setGovernor(address _governor)</code> and set a new <code>governor</code> effective immediately.</p>\n<p>And the new <code>governor</code> can then call <code>Timelock#setDelay()</code> and change the delay to <code>0</code>, also effective immediately.</p>\n<p>The new <code>governor</code> can now use all the privileges without a delay, including granting minter role to any address and mint unlimited amount of MALT.</p>\n<p>In conclusion, a Timelock contract is supposed to guard the protocol from lost private key or malicious actions. The current implementation won’t fulfill that mission.</p>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Timelock.sol#L98-L105\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Timelock.sol#L98-L105</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setGovernor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_governor</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">GOVERNOR_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Must have timelock role&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_swapRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_governor</span><span class=\"mtk1\">, </span><span class=\"mtk12\">governor</span><span class=\"mtk1\">, </span><span class=\"mtk12\">GOVERNOR_ROLE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">governor</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_governor</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NewGovernor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_governor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Timelock.sol#L66-L77\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Timelock.sol#L66-L77</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setDelay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delay</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">GOVERNOR_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Must have timelock role&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_delay</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_delay</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">gracePeriod</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;Timelock::setDelay: Delay must not be greater equal to zero and less than gracePeriod&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">delay</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_delay</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NewDelay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">delay</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h4 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h4>\n<p>Consider making <code>setGovernor</code> and <code>setDelay</code> only callable from the Timelock contract itself.</p>\n<p>Specificaly, changing from <code>onlyRole(GOVERNOR_ROLE, \"Must have timelock role\")</code> to <code>require(msg.sender == address(this), \"...\")</code>.</p>\n<p>Also, consider changing <code>_adminSetup(_admin)</code> in <code>Timelock#initialize()</code> to <code>_adminSetup(address(this))</code>, so that all roles are managed by the timelock itself as well.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/263\">0xScotch (sponsor) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/263#issuecomment-1008067115\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified an exploit that allows to sidestep the delay for the timelock, effectively bypassing all of the timelock’s security guarantees. Because of the gravity of this, I agree with the high risk severity.</p>\n<p>Mitigation can be achieved by ensuring that all operations run under a time delay</p>\n</blockquote>\n<h2 id=\"h-02-unable-to-remove-liquidity-in-recovery-mode\" style=\"position:relative;\"><a href=\"#h-02-unable-to-remove-liquidity-in-recovery-mode\" aria-label=\"h 02 unable to remove liquidity in recovery mode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/323\">[H-02] Unable to remove liquidity in Recovery Mode</a></h2>\n<p><em>Submitted by gzeon</em></p>\n<p>According to <a href=\"https://github.com/code-423n4/2021-11-malt#high-level-overview-of-the-malt-protocol\">https://github.com/code-423n4/2021-11-malt#high-level-overview-of-the-malt-protocol</a></p>\n<blockquote>\n<p>When the Malt price TWAP drops below a specified threshold (eg 2% below peg) then the protocol will revert any transaction that tries to remove Malt from the AMM pool (ie buying Malt or removing liquidity). Users wanting to remove liquidity can still do so via the UniswapHandler contract that is whitelisted in recovery mode.</p>\n</blockquote>\n<p>However, in <a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/DexHandlers/UniswapHandler.sol#L236\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/DexHandlers/UniswapHandler.sol#L236</a>\nliquidity removed is directly sent to msg.sender, which would revert if it is not whitelisted\n<a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/PoolTransferVerification.sol#L53\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/PoolTransferVerification.sol#L53</a></p>\n<h4 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Liquidity should be removed to UniswapHandler contract, then the proceed is sent to msg.sender</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/323\">0xScotch (sponsor) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/323#issuecomment-1010448871\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I believe this finding to be correct, because of the whitelisting on <code>verifyTransfer</code>, during recovery mode the removal of liquidity from UniSwapV2Pair will perform safeTransfers: <a href=\"https://github.com/Uniswap/v2-core/blob/4dd59067c76dea4a0e8e4bfdda41877a6b16dedc/contracts/UniswapV2Pair.sol#L148\">https://github.com/Uniswap/v2-core/blob/4dd59067c76dea4a0e8e4bfdda41877a6b16dedc/contracts/UniswapV2Pair.sol#L148</a></p>\n<p>This means that the <code>_beforeTokenTransfer</code> will be called which eventually will call <code>verifyTransfer</code> which, if the price is below peg will revert.</p>\n<p>Transfering the funds to the whitelisted contract should avoid this issue.</p>\n<p>I’d like to remind the sponsor that anyone could deploy similar swapping contracts (or different ones such as curve), so if a person is motivate enough, all the whitelisting could technically be sidestepped.</p>\n<p>That said, given the condition of LPing on Uniswap, the check and the current system would make it impossible to withdraw funds.</p>\n<p>Because this does indeed compromises the availability of funds (effectively requiring the admin to unstock them manually via Whitelisting each user), I agree with High Severity</p>\n</blockquote>\n<h2 id=\"h-03-getauctioncore-function-returns-wrong-values-out-of-order\" style=\"position:relative;\"><a href=\"#h-03-getauctioncore-function-returns-wrong-values-out-of-order\" aria-label=\"h 03 getauctioncore function returns wrong values out of order permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/63\">[H-03] getAuctionCore function returns wrong values out of order</a></h2>\n<p><em>Submitted by jayjonah8</em></p>\n<h4 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>In the <code>AuctionEscapeHatch.sol</code> file both <code>earlyExitReturn()</code> and <code>\\_calculateMaltRequiredForExit</code> call the <code>getAuctionCore()</code> function which has 10 possible return values most of which are not used.  It gets the wrong value back for the “active”  variable since it’s the 10th argument but both functions have it as the 9th return value where “preAuctionReserveRatio” should be because of one missing comma.  This is serious because these both are functions which deal with allowing a user to exit their arbitrage token position early.  This can result in a loss of user funds.</p>\n<h4 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/AuctionEscapeHatch.sol#L100\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/AuctionEscapeHatch.sol#L100</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/AuctionEscapeHatch.sol#L174\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/AuctionEscapeHatch.sol#L174</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L527\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L527</a></li>\n</ul>\n<h4 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Manual code review</p>\n<h4 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>In <code>AuctionEscapeHatch.sol</code> change the following in <code>\\_calculateMaltRequiredForExit()</code> and earlyExitReturn() functions:</p>\n<p>From:</p>\n<p>(,,,,,\nuint256 pegPrice,\n,\nuint256 auctionEndTime,\nbool active\n) = auction.getAuctionCore(_auctionId);</p>\n<p>To:</p>\n<p>(,,,,,\nuint256 pegPrice,\n,\nuint256 auctionEndTime,\n,\nbool active\n) = auction.getAuctionCore(_auctionId);</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/63\">0xScotch (sponsor) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/63#issuecomment-1019278807\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden identified a mistake in programming where the code would use the wrong returned value.\nBecause of this, the entire protocol functionality can be compromised.\nAs such I agree with High Severity</p>\n</blockquote>\n<h2 id=\"h-04-auctionburnreserveskewgetpegdeltafrequency-wrong-implementation-can-result-in-an-improper-amount-of-excess-liquidity-extension-balance-to-be-used-at-the-end-of-an-auction-\" style=\"position:relative;\"><a href=\"#h-04-auctionburnreserveskewgetpegdeltafrequency-wrong-implementation-can-result-in-an-improper-amount-of-excess-liquidity-extension-balance-to-be-used-at-the-end-of-an-auction-\" aria-label=\"h 04 auctionburnreserveskewgetpegdeltafrequency wrong implementation can result in an improper amount of excess liquidity extension balance to be used at the end of an auction  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/294\">[H-04] <code>AuctionBurnReserveSkew.getPegDeltaFrequency()</code> Wrong implementation can result in an improper amount of excess Liquidity Extension balance to be used at the end of an auction </a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/AuctionBurnReserveSkew.sol#L116-L132\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/AuctionBurnReserveSkew.sol#L116-L132</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getPegDeltaFrequency</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">initialIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">count</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">auctionAverageLookback</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">initialIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">count</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">auctionAverageLookback</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">total</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">initialIndex</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">count</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">index</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getIndexOfObservation</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">total</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">total</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">pegObservations</span><span class=\"mtk1\">[</span><span class=\"mtk12\">index</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">total</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10000</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">auctionAverageLookback</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>When <code>count &#x3C; auctionAverageLookback</code>, at L131, it should be <code>return total * 10000 / count;</code>. The current implementation will return a smaller value than expected.</p>\n<p>The result of <code>getPegDeltaFrequency()</code> will be used for calculating <code>realBurnBudget</code> for auctions. With the result of <code>getPegDeltaFrequency()</code> being inaccurate, can result in an improper amount of excess Liquidity Extension balance to be used at the end of an auction.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/294\">0xScotch (sponsor) confirmed and disagreed with severity</a>:</strong></p>\n<blockquote>\n<p>I actually think this should be higher severity. This bug could manifest in liquidity extension being depleted to zero which could have catastrophic consequences downstream.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/294#issuecomment-1019392232\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding, this is an incorrect logic in the protocol, which can limit it’s functionality and as the sponsor says: <code>could have catastrophic consequences downstream</code> as such I’ll increase the severity to high.</p>\n<p>Mitigation seems to be straightforward</p>\n</blockquote>\n<h2 id=\"h-05-auctioneschapehatchsolexitearly-updates-state-of-the-auction-wrongly\" style=\"position:relative;\"><a href=\"#h-05-auctioneschapehatchsolexitearly-updates-state-of-the-auction-wrongly\" aria-label=\"h 05 auctioneschapehatchsolexitearly updates state of the auction wrongly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/268\">[H-05] AuctionEschapeHatch.sol#exitEarly updates state of the auction wrongly</a></h2>\n<p><em>Submitted by 0x0x0x</em></p>\n<p><code>AuctionEschapeHatch.sol#exitEarly</code> takes as input <code>amount</code> to represent how much of the</p>\n<p>When the user exits an auction with profit, to apply the profit penalty less <code>maltQuantity</code> is liquidated compared to how much malt token the liquidated amount corresponds to. The problem is <code>auction.amendAccountParticipation()</code> simply subtracts the malt quantity with penalty and full <code>amount</code> from users auction stats. This causes a major problem, since in <code>_calculateMaltRequiredForExit</code> those values are used for calculation by calculating maltQuantity as follow:</p>\n<p><code>uint256 maltQuantity = userMaltPurchased.mul(amount).div(userCommitment);</code></p>\n<p>The ratio of <code>userMaltPurchased / userCommitment</code> gets higher after each profit taking (since penalty is applied to substracted <code>maltQuantity</code> from <code>userMaltPurchased</code>), by doing so a user can earn more than it should. Since after each profit taking users commitment corresponds to proportionally more malt, the user can even reduce profit penalties by dividing <code>exitEarly</code> calls in several calls.</p>\n<p>In other words, the ratio of <code>userMaltPurchased / userCommitment</code> gets higher after each profit taking and user can claim more malt with less commitment. Furthermore after all <code>userMaltPurchased</code> is claimed the user can have <code>userCommitment</code> left over, which can be used to <code>claimArbitrage</code>, when possible.</p>\n<h4 id=\"mitigation-step\" style=\"position:relative;\"><a href=\"#mitigation-step\" aria-label=\"mitigation step permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Step</h4>\n<p>Make sure which values are used for what and update values which doesn’t create problems like this. Rethink about how to track values of an auction correctly.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/268\">0xScotch (sponsor) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/268#issuecomment-1020736987\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified an exploit that allows early withdrawers to gain more rewards than expected.\nAnytime “points” and rewards need to be earned over time, it’s ideal to accrue points in order to distribute them (see how Compound or AAVE tokens work)\nBecause the warden showed a flow in the accounting logic for the protocol, I agree with high severity.</p>\n</blockquote>\n<h1 id=\"medium-risk-findings-30\" style=\"position:relative;\"><a href=\"#medium-risk-findings-30\" aria-label=\"medium risk findings 30 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (30)</h1>\n<h2 id=\"m-01-timelock_role-has-absolute-power-to-withdraw-all-fund-may-raise-red-flags-for-investors\" style=\"position:relative;\"><a href=\"#m-01-timelock_role-has-absolute-power-to-withdraw-all-fund-may-raise-red-flags-for-investors\" aria-label=\"m 01 timelock_role has absolute power to withdraw all fund may raise red flags for investors permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/125\">[M-01] TIMELOCK_ROLE Has Absolute Power to Withdraw All FUND May Raise Red Flags for Investors</a></h2>\n<p><em>Submitted by Meta0xNull</em></p>\n<p><code>TIMELOCK_ROLE</code> Can Withdraw All FUND from the Contracts via <code>emergencyWithdrawGAS(), emergencyWithdraw(), partialWithdrawGAS(), partialWithdraw()</code>.</p>\n<p>While I believe developer have good intention to use these functions. It often associate with Rug Pull by developer in the eyes of investors because Rug Pull is not uncommon in Defi. Investors lose all their hard earn money.</p>\n<p>Read More: $10.8M Stolen, Developers Implicated in Alleged Smart Contract ‘Rug Pull’\n<a href=\"https://www.coindesk.com/tech/2020/12/02/108m-stolen-developers-implicated-in-alleged-smart-contract-rug-pull/\">https://www.coindesk.com/tech/2020/12/02/108m-stolen-developers-implicated-in-alleged-smart-contract-rug-pull/</a></p>\n<p>Read More: The Rise of Cryptocurrency Exit Scams and DeFi Rug Pulls\n<a href=\"https://www.cylynx.io/blog/the-rise-of-cryptocurrency-exit-scams-and-defi-rug-pulls/\">https://www.cylynx.io/blog/the-rise-of-cryptocurrency-exit-scams-and-defi-rug-pulls/</a></p>\n<h4 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Permissions.sol#L80-L109\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Permissions.sol#L80-L109</a></p>\n<h4 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<ol>\n<li>Pause the Contract and Disable All Functions when Bad Thing Happen rather than Withdraw All Fund to a random address.</li>\n<li>If Withdraw Fund can’t avoid, a Multi Sig ETH Address should be hardcoded into the contract to ensure the fund move to a safe wallet.</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/125#issuecomment-988785042\">0xScotch (sponsor) commented</a>:</strong></p>\n<blockquote>\n<p>Duplicate of #263</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/125#issuecomment-1008068213\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This is not a duplicate of #263, where 263 talks about sidestepping the delay of the timelock, this finding talks about the high degree of power that the TIMELOCK_ROLE has.</p>\n<p>This is a typical “admin privilege” finding, it’s very important to disclose admin privileges to users so that they can make informed decisions</p>\n<p>In this case the TIMELOCK_ROLE can effectively rug the protocol, however this is contingent on the account that has the role to pull the rug.</p>\n<p>Because of its reliance on external factors, am downgrading the finding to medium severity</p>\n</blockquote>\n<h2 id=\"m-02-frontrunning-in-uniswaphandler-calls-to-uniswapv2router\" style=\"position:relative;\"><a href=\"#m-02-frontrunning-in-uniswaphandler-calls-to-uniswapv2router\" aria-label=\"m 02 frontrunning in uniswaphandler calls to uniswapv2router permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/219\">[M-02] Frontrunning in UniswapHandler calls to UniswapV2Router</a></h2>\n<p><em>Submitted by thank</em>you, also found by 0x0x0x, cmichel, defsec, harleythedog, hyh, Koustre, leastwood, Meta0xNull, pauliax, pmerkleplant, tabish, WatchPug, and xYrYuYx_</p>\n<p>UniswapHandler utilizes UniswapV2Router to swap, add liquidity, and remove liquidity with the UniswapV2Pair contract. In order to utilize these functionalities, UniswapHandler must call various UniswapV2Router methods.</p>\n<ul>\n<li>addLiquidity</li>\n<li>removeLiquidity</li>\n<li>swapExactTokensForTokens (swaps for both DAI and Malt)</li>\n</ul>\n<p>In all three methods, UniswapV2Router requires the callee to provide input arguments that define how much the amount out minimum UniswapHandler will allow for a trade. This argument is designed to prevent slippage and more importantly, sandwich attacks.</p>\n<p>UniswapHandler correctly handles price slippage when calling <a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L201\">addLiquidity</a>. However, that is not the case for <a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L230\">removeLiquidity</a> and swapExactTokensForTokens <a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L148\">here</a> and <a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L173\">here</a>. For both methods, 0 is passed in as the amount out minimum allowed for a trade. This allows for anyone watching the mempool to sandwich attack UniswapHandler (or any contract that calls UniswapHandler) in such a way that allows the hacker to profit off of a guaranteed trade.</p>\n<p>How does this work? Let’s assume UniswapHandler makes a call to <a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L148\">UniswapV2Router#swapExactTokensForTokens</a> to trade DAI for Malt. Any hacker who watches the mempool and sees this transaction can immediately buy as much Malt as they want. This raises the price of Malt. Since UniswapHandler is willing to accept any amount out minimum (the number is set to <a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L150\">zero</a>), then the UniswapHandler will always trade DAI for Malt. This second transaction raises the price of Malt even further. Finally, the hacker trades their Malt for DAI, receiving a profit due to the artificially inflated price of Malt from the sandwich attack.</p>\n<p>It’s important to note that anyone has access to the UniswapV2Router contract. There are no known ACL controls on UniswapV2Router. This sandwich attack can impact even the <code>buyMalt</code> function.</p>\n<p>The following functions when called are vulnerable to frontrunning attacks:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L131\">UniswapHandler#buyMalt</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L160\">UniswapHandler#sellMalt</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L221\">UniswapHandler#removeLiquidity</a></li>\n</ul>\n<p>And by extension the following contract functions since they also call the UniswapHandler function calls:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Bonding.sol#L114\">Bonding#unbondAndBreak</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/LiquidityExtension.sol#L117\">LiquidityExtension#purchaseAndBurn</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/RewardReinvestor.sol#L78\">RewardReinvestor#splitReinvest</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L145\">StabilizerNode#stabilize</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/SwingTrader.sol#L50\">SwingTrader#buyMalt</a></li>\n</ul>\n<h4 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Refer to the impact section for affected code and links to the appropriate LoC.</p>\n<h4 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>The UniswapV2Router and UniswapV2Pair contract should allow only the UniswapHandler contract to call either contract. In addition, price slippage checks should be implemented whenever removing liquidity or swapping tokens. This ensures that a frontrunning attack can’t occur.</p>\n<h4 id=\"anything-else-we-should-know\" style=\"position:relative;\"><a href=\"#anything-else-we-should-know\" aria-label=\"anything else we should know permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Anything Else We Should Know</h4>\n<p>I wish I had more time to work on this bug but unfortunately I have several current clients who require significant time from me. I’m happy to pursue this beyond the initial submission, in particular building a concrete PoC. I think the most important takeaway from this bug find is that anyone can purchase Malt at any time and anyone can manipulate the Malt reserve. This in turn impacts other functionalities that rely on the Malt reserve to make price/token calculations such as exiting an auction early or reinvesting rewards.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/219\">0xScotch (sponsor) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/219#issuecomment-1008433912\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Because transactions sit on the mempool (which is public, hence accessible by anyone), they can be frontrun, because of this swapping protocols (uniswap in this case) offer slippage checks.\nSetting the slippage checks allows a frontrunner to squeeze the maximum amount of value possible (sometimes the whole amount).</p>\n<p>Because this applies to a leak of value, I believe medium severity to be correct</p>\n</blockquote>\n<h2 id=\"m-03-abstractrewardminesolsetrewardtoken-is-dangerous\" style=\"position:relative;\"><a href=\"#m-03-abstractrewardminesolsetrewardtoken-is-dangerous\" aria-label=\"m 03 abstractrewardminesolsetrewardtoken is dangerous permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/285\">[M-03] AbstractRewardMine.sol#setRewardToken is dangerous</a></h2>\n<p><em>Submitted by 0x0x0x, also found by harleythedog and hyh</em></p>\n<p>In case the reward token is changed, <code>totalDeclaredReward</code> will be changed and likely equal to <code>0</code>.  Since <code>_userStakePadding</code> and <code>_globalStakePadding</code> are accumulated, changing the reward token will not reset those values. Thus, it will create problems.</p>\n<h4 id=\"recommendation-1\" style=\"position:relative;\"><a href=\"#recommendation-1\" aria-label=\"recommendation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h4>\n<p>I think it would be the best to remove this function.</p>\n<p>If you want to keep it, then it must have an event and it should be used by a timelock contract. Furthermore, it has to be used carefully and the new token should be distributed such that padding variables still make sense.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/285\">0xScotch (sponsor) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/285#issuecomment-1008437864\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with highlighting the Admin Privilege, however because this is contingent on a malicious Admin, I’ll downgrade the finding to Medium Severity.</p>\n<p>Mitigation could be done by ensuring old rewards are sent out, still claimable, or by making the <code>rewardToken</code> immutable</p>\n</blockquote>\n<h2 id=\"m-04-the-power-structure-is-too-centralized-and-protocol-may-break-if-anything-happen-to-admin\" style=\"position:relative;\"><a href=\"#m-04-the-power-structure-is-too-centralized-and-protocol-may-break-if-anything-happen-to-admin\" aria-label=\"m 04 the power structure is too centralized and protocol may break if anything happen to admin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/124\">[M-04] The Power Structure is Too Centralized And Protocol May Break If Anything Happen to Admin</a></h2>\n<p><em>Submitted by Meta0xNull</em></p>\n<p>There are a lot of different roles in Malt Finance to handle different tasks. All these roles only can set by Admin. If anything happen to Admin and he/she no longer available, the protocol will start countdown to the end of life.</p>\n<h4 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L890-L1013\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L890-L1013</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/RewardSystem/RewardDistributor.sol#L291-L345\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/RewardSystem/RewardDistributor.sol#L291-L345</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Bonding.sol#L327-L355\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Bonding.sol#L327-L355</a>\nMany More Sol…</li>\n</ul>\n<h4 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<ol>\n<li>Some tasks don’t really need a special role like StabilizerNode. Should allow any community members to run their own StabilizerNode without approval needed.</li>\n<li>Consider transfer Admin to Multisig or DAO.</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/124\">0xScotch (sponsor) disputed</a>:</strong></p>\n<blockquote>\n<p>This is a known risk that is by design. We will migrate to DAO control of parameters when the protocol matures. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/124#issuecomment-1008445251\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I respect the wardens work for flagging this up.\nBecause any of these exploits are contingent on the Admin being malicious, I’ll downgrade to Medium Severity</p>\n</blockquote>\n<h2 id=\"m-05-_notsameblock-can-be-circumvented-in-bondtoaccount-\" style=\"position:relative;\"><a href=\"#m-05-_notsameblock-can-be-circumvented-in-bondtoaccount-\" aria-label=\"m 05 _notsameblock can be circumvented in bondtoaccount  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/195\">[M-05] _notSameBlock() can be circumvented in bondToAccount() </a></h2>\n<p><em>Submitted by gpersoon, also found by leastwood and ScopeLift</em></p>\n<p>The function bondToAccount() of Bonding.sol has a check based on _notSameBlock()\n_notSameBlock() makes sure the same msg.sender cannot do 2 actions within the same block.</p>\n<p>However this can be circumvented in this case:\nSuppose you call bondToAccount() via a (custom) smart contract, then the msg.sender will be the address of the smart contract.\nFor a pseudo code proof of concept see below.</p>\n<p>I’m not sure what the deeper reason is for the _notSameBlock() in bondToAccount().\nBut if it is important then circumventing this check it will pose a risk.</p>\n<h4 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>call function attack1.attack()</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">attack1</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">attack</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         </span><span class=\"mtk12\">call</span><span class=\"mtk1\"> </span><span class=\"mtk12\">attack2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">forward</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         </span><span class=\"mtk12\">call</span><span class=\"mtk1\"> </span><span class=\"mtk12\">any</span><span class=\"mtk1\"> </span><span class=\"mtk12\">other</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">of</span><span class=\"mtk1\"> </span><span class=\"mtk11\">malt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">attack2</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">forward</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       </span><span class=\"mtk12\">call</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bondToAccount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// uses msg.sender of attack2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/Bonding.sol#L81-L92\">https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/Bonding.sol#L81-L92</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">bondToAccount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">offering</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         </span><span class=\"mtk11\">_notSameBlock</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/Permissions.sol#L135-L141\">https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/Permissions.sol#L135-L141</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_notSameBlock</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">( </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">lastBlock</span><span class=\"mtk1\">[</span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">()],</span><span class=\"mtk8\">&quot;Can&#39;t carry out actions in the same block&quot;</span><span class=\"mtk1\"> );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">lastBlock</span><span class=\"mtk1\">[</span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">()] = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h4 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Add access controls to the function bondToAccount()\nAn end-user could still call bond()</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/195\">0xScotch (sponsor) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/195#issuecomment-1008447039\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p><code>notSameBlock</code> is effectively being used as the <code>nonReentrant</code> modifier, without the same security guarantees, as such, in spite of not having a specific attack vector, because the warden showed how to side step this security feature of the protocol, am going to raise the severity to Medium</p>\n</blockquote>\n<h2 id=\"m-06-abstractrewardmine---re-entrancy-attack-during-withdrawal\" style=\"position:relative;\"><a href=\"#m-06-abstractrewardmine---re-entrancy-attack-during-withdrawal\" aria-label=\"m 06 abstractrewardmine   re entrancy attack during withdrawal permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/333\">[M-06] AbstractRewardMine - Re-entrancy attack during withdrawal</a></h2>\n<p><em>Submitted by ScopeLift</em></p>\n<p>The internal <code>_withdraw</code> method does not follow the checks-effects-interactions pattern. A malicious token, or one that implemented transfer hooks, could re-enter the public calling function (such as <code>withdraw()</code>) before proper internal accounting was completed. Because the <code>earned</code> function looks up the <code>_userWithdrawn</code> mapping, which is not yet updated when the transfer occurs, it would be possible for a malicious contract to re-enter <code>_withdraw</code> repeatedly and drain the pool.</p>\n<h4 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>The internal accounting should be done before the transfer occurs:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountReward</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_userWithdrawn</span><span class=\"mtk1\">[</span><span class=\"mtk12\">account</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">amountReward</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_globalWithdrawn</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">amountReward</span><span class=\"mtk1\">;</span><span class=\"mtk12\">f</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountReward</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/333\">0xScotch (sponsor) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/333#issuecomment-1008447954\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden identified a re-entrancy vulnerability that, given the right token would allow to drain the entirety of the contract.</p>\n<p>Tokens with hooks (ERC777 and ERC677) would allow to exploit the contract and drain it in it’s entirety.</p>\n<p>This is a very serious vulnerability.\nHowever it can happen exclusively on a malicious or a token with hooks, as such (while I recommend the sponsor to mitigate by following recommendation by the warden), the attack can be completely prevented by using a token without hooks.</p>\n<p>For that reason I’ll rate the finding of medium severity (as it requires external conditions)</p>\n</blockquote>\n<h2 id=\"m-07-movingaveragesetsamplememory-may-broke-movingaverage-making-the-value-of-exchangerate-in-stabilizernodestabilize-being-extremely-wrong\" style=\"position:relative;\"><a href=\"#m-07-movingaveragesetsamplememory-may-broke-movingaverage-making-the-value-of-exchangerate-in-stabilizernodestabilize-being-extremely-wrong\" aria-label=\"m 07 movingaveragesetsamplememory may broke movingaverage making the value of exchangerate in stabilizernodestabilize being extremely wrong permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/313\">[M-07] <code>MovingAverage.setSampleMemory()</code> may broke MovingAverage, making the value of <code>exchangeRate</code> in <code>StabilizerNode.stabilize()</code> being extremely wrong</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/MovingAverage.sol#L424-L442\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/MovingAverage.sol#L424-L442</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setSampleMemory</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_sampleMemory</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ADMIN_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Must have admin privs&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_sampleMemory</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Cannot have sample memroy of 0&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_sampleMemory</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">sampleMemory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">sampleMemory</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_sampleMemory</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">samples</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">counter</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">counter</span><span class=\"mtk1\"> % </span><span class=\"mtk12\">_sampleMemory</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">activeSamples</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_sampleMemory</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// TODO handle when list is smaller Tue 21 Sep 2021 22:29:41 BST</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">sampleMemory</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_sampleMemory</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>In the current implementation, when <code>sampleMemory</code> is updated, the samples index will be malposition, making <code>getValueWithLookback()</code> get the wrong samples, so that returns the wrong value.</p>\n<h4 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li>When initial sampleMemory is <code>10</code></li>\n<li>After <code>movingAverage.update(1e18)</code> being called for 120 times</li>\n<li>The admin calls <code>movingAverage.setSampleMemory(118)</code> and set sampleMemory to <code>118</code></li>\n</ul>\n<p>The current <code>movingAverage.getValueWithLookback(sampleLength * 10)</code> returns <code>0.00000203312 e18</code>, while it’s expeceted to be <code>1e18</code></p>\n<p>After <code>setSampleMemory()</code>, <code>getValueWithLookback()</code> may also return <code>0</code>or revert FullMath: FULLDIV_OVERFLOW at L134.</p>\n<h5 id=\"recommendation-2\" style=\"position:relative;\"><a href=\"#recommendation-2\" aria-label=\"recommendation 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h5>\n<p>Consider removing <code>setSampleMemory</code> function.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/313\">0xScotch (sponsor) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/313#issuecomment-1008462965\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I agree that calling <code>setSampleMemory</code> will cause issues, and can cause opportunities to further extract value.\nHowever this can be triggered by an admin action.\nI’ll think about the severity, but as of now, because it is contingent on admin privilege, will downgrade to Medium</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/313#issuecomment-1025181213\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I stand by my decision of Medium Severity. While the consequences can be troublesome, they are contingent on the admin breaking / griefing the system</p>\n</blockquote>\n<h2 id=\"m-08-_getfirstsample-returns-wrong-sample-if-count--samplememory\" style=\"position:relative;\"><a href=\"#m-08-_getfirstsample-returns-wrong-sample-if-count--samplememory\" aria-label=\"m 08 _getfirstsample returns wrong sample if count  samplememory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/252\">[M-08] <code>_getFirstSample</code> returns wrong sample if count &#x3C; sampleMemory</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>MovingAverage.sol</code> contract defines several variables that in the end make the <code>samples</code> array act as a ring buffer:</p>\n<ul>\n<li><code>sampleMemory</code>: The total length (buffer size) of the <code>samples</code> array. <code>samples</code> is initialized with <code>sampleMemory</code> zero observations.</li>\n<li><code>counter</code>: The pending sample index (modulo <code>sampleMemory</code>)</li>\n</ul>\n<p>The <code>_getFirstSample</code> function computes the first sample as <code>(counter + 1) % sampleMemory</code> which returns the correct index only <em>if the ring buffer is full</em>, i.e., it wraps around. (in the <code>counter + 1 >= sampleMemory</code>).</p>\n<p>If the <code>samples</code> array does not wrap around yet, the zero index should be returned instead.</p>\n<h4 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Returning <code>counter + 1</code> if <code>counter + 1 &#x3C; sampleMemory</code> returns a zero initialized <code>samples</code> observation index.\nThis then leads to a wrong computation of the TWAP.</p>\n<h4 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Add an additional check for <code>if (counter + 1 &#x3C; sampleMemory) return 0</code> in <code>_getFirstSample</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/252\">0xScotch (sponsor) confirmed and disagreed with severity</a>:</strong></p>\n<blockquote>\n<p>Funds aren’t directly at risk. I believe this is medium severity</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/252#issuecomment-1008466725\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Personally am not sure the first sample after wrapping would be <code>counter + 1</code> (why not  <code>counter % sampleMemory</code>)</p>\n<p>That said, I do agree that before wrapping, the first item in the array is at the 0 index</p>\n<p>I agree that the protocol is not behaving properly so I can understand the high severity, that said I also agree with the Sponsor’s statement, the worst case would be a leak of value, so Medium severity seems the most appropriate</p>\n</blockquote>\n<h2 id=\"m-09-uniswaphandlermaltmarketprice-returns-wrong-decimals\" style=\"position:relative;\"><a href=\"#m-09-uniswaphandlermaltmarketprice-returns-wrong-decimals\" aria-label=\"m 09 uniswaphandlermaltmarketprice returns wrong decimals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/255\">[M-09] <code>UniswapHandler.maltMarketPrice</code> returns wrong decimals</a></h2>\n<p><em>Submitted by cmichel, also found by gzeon</em></p>\n<p>The <code>UniswapHandler.maltMarketPrice</code> function returns a tuple of the <code>price</code> and the <code>decimals</code> of the price.\nHowever, the returned <code>decimals</code> do not match the computed <code>price</code> for the <code>else if (rewardDecimals &#x3C; maltDecimals)</code> branch:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">rewardDecimals</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">maltDecimals</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">diff</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">maltDecimals</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">rewardDecimals</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">rewardReserves</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk12\">diff</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk12\">rewardDecimals</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">maltReserves</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">maltDecimals</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Note that <code>rewardReserves</code> are in reward token decimals, <code>maltReserves</code> is a malt balance amount (18 decimals).\nThen, the returned amount is in <code>rewardDecimals + diffDecimals + rewardDecimals - maltDecimals = maltDecimals + rewardDecimals - maltDecimals = rewardDecimals</code>.\nHowever <code>decimals = maltDecimals</code> is wrongly returned.</p>\n<h4 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Callers to this function will receive a price in unexpected decimals and might inflate or deflate the actual amount.\nLuckily, the <code>AuctionEscapeHatch</code> decides to completely ignore the returned <code>decimals</code> and as all prices are effectively in <code>rewardDecimals</code>, even if stated in <code>maltDecimals</code>, it currently does not seem to lead to an issue.</p>\n<h4 id=\"recommendation-3\" style=\"position:relative;\"><a href=\"#recommendation-3\" aria-label=\"recommendation 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h4>\n<p>Fix the function by returning <code>rewardDecimals</code> instead of <code>maltDecimals</code> in the <code>rewardDecimals &#x3C; maltDecimals</code> branch.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/255\">0xScotch (sponsor) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/255#issuecomment-1010461081\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Finding is valid, because the returned value is unused, I agree with the medium severity</p>\n</blockquote>\n<h2 id=\"m-10-auctionparticipantsol-setreplenishingindex-mistake-could-freeze-unclaimed-tokens\" style=\"position:relative;\"><a href=\"#m-10-auctionparticipantsol-setreplenishingindex-mistake-could-freeze-unclaimed-tokens\" aria-label=\"m 10 auctionparticipantsol setreplenishingindex mistake could freeze unclaimed tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/88\">[M-10] AuctionParticipant.sol: <code>setReplenishingIndex</code> mistake could freeze unclaimed tokens</a></h2>\n<p><em>Submitted by harleythedog</em></p>\n<p>In AuctionParticipant.sol, the function <code>setReplenishingIndex</code> is an admin function that allows manually setting <code>replenishingIndex</code>. As I have shown in my two previous findings, I believe that this function could be called frequently. In my opinion (and Murphy’s law would agree), this implies that eventually an admin will accidentally set <code>replenishingIndex</code> incorrectly with this function.</p>\n<p>Right now, <code>setReplenishingIndex</code> does not allow the admin to set <code>replenishingIndex</code> to a value smaller than it currently is. So, if an admin were to accidentally set this value too high, then it would be impossible to set it back to a lower value (the higher the value set, the worse this issue). All of the unclaimed tokens on auctions at smaller indices would be locked forever.</p>\n<h4 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>See code for <code>setReplenishingIndex</code> here: <a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/AuctionParticipant.sol#L132\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/AuctionParticipant.sol#L132</a></p>\n<h4 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Remove the require statement on line 136, so that an admin can set the index to a smaller value.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/88\">0xScotch (sponsor) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/88#issuecomment-1011612291\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding in that if the <code>ADMIN</code> were to increase the <code>replenishingIndex</code> then the unclaim tokens at auctions below the index wouldn’t be claimable anymore.</p>\n<p>I believe the warden properly highlighted what an hypothetical abuse of <code>admin privilege</code> would look like.\nAs such I’ll rate the finding with medium severity.</p>\n<p>I don’t necessarily agree with the warden recommended mitigation, it may actually be best to simply delete the setter, or force it to go up by one index at a time after checking that all tokens are claimed</p>\n</blockquote>\n<h2 id=\"m-11-no-max-for-advanceincentive\" style=\"position:relative;\"><a href=\"#m-11-no-max-for-advanceincentive\" aria-label=\"m 11 no max for advanceincentive permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/190\">[M-11] No max for advanceIncentive</a></h2>\n<p><em>Submitted by gpersoon, also found by 0x1f8b</em></p>\n<p>The function setAdvanceIncentive of DAO.sol doesn’t check for a maximum value of incentive.\nIf incentivewould be very large, then advanceIncentive would be very large and the function advance() would mint a large amount of malt.</p>\n<p>The function setAdvanceIncentive() can only be called by an admin, but a mistake could be made.\nAlso if an admin would want to do a rug pull, this would be an ideal place to do it.</p>\n<h4 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/DAO.sol#L98-L104\">https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/DAO.sol#L98-L104</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setAdvanceIncentive</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">incentive</span><span class=\"mtk1\">)  </span><span class=\"mtk11\">externalonlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ADMIN_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Must have admin role&quot;</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">advanceIncentive</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">incentive</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/DAO.sol#L55-L63\">https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/DAO.sol#L55-L63</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">advance</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">malt</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">advanceIncentive</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h4 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Check for a reasonable maximum value in advance()</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/190\">0xScotch (sponsor) confirmed and disagreed with severity</a>:</strong> </p>\n<blockquote>\n<p>Definitely need to guard against arbitrarily large incentives. Disagree the risk is medium though.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/190#issuecomment-1019288176\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding, this is an example of admin privilege, where the admin can set a variable which can be used to dilute the token and rug the protocol.</p>\n<p>Because this is contingent on the admin’s action, I believe medium severity to be proper</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/190#issuecomment-1025181758\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The simple rationale on the medium severity is that the owner could set the incentive to an exorbitant amount with the goal of minting a lot of tokens for an exit scam</p>\n</blockquote>\n<h2 id=\"m-12-permissions---return-values-not-checked-when-sending-eth\" style=\"position:relative;\"><a href=\"#m-12-permissions---return-values-not-checked-when-sending-eth\" aria-label=\"m 12 permissions   return values not checked when sending eth permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/329\">[M-12] Permissions - return values not checked when sending ETH</a></h2>\n<p><em>Submitted by ScopeLift, also found by nathaniel</em></p>\n<p>On lines 85 and 101, ETH is transferred using a <code>.call</code> to an address provided as an input, but there is no verification that the call call succeeded. This can result in a call to <code>emergencyWithdrawGAS</code> or <code>partialWithdrawGAS</code> appearing successful but in reality it failed. This can happen when the provided <code>destination</code> address is a contract that cannot receive ETH, or if the <code>amount</code> provided is larger than the contract’s balance</p>\n<h4 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Enter the following in remix, deploy the <code>Receiver</code> contract, and send 1 ETH when deploying the <code>Permissions</code> contract. Call <code>emergencyWithdrawGAS</code> with the receiver address and you’ll see it reverts. This would not be caught in the current code</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Receivier</span><span class=\"mtk1\">{}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Permissions</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">emergencyWithdrawGAS</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">destination</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ok</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">destination</span><span class=\"mtk1\">.</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&#39;&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ok</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;call failed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h4 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Remix</p>\n<h4 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>In <code>emergencyWithdrawGAS</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- destination.call{value: address(this).balance}(&#39;&#39;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ (bool ok, ) = destination.call{value: address(this).balance}(&#39;&#39;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ require(ok, &quot;call failed&quot;);</span></span></span></code></pre>\n<p>And similar for <code>partialWithdrawGAS</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/329\">0xScotch (sponsor) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/329#issuecomment-1019293046\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding, I believe if a developer were to not use safeTransfer we’d rate as medium, so while I believe the impact to be minimal (no composability), I’ll keep the severity to medium</p>\n</blockquote>\n<h2 id=\"m-13-reducing-the-epoch-length-results-in-leaking-value-from-advancement-incentives\" style=\"position:relative;\"><a href=\"#m-13-reducing-the-epoch-length-results-in-leaking-value-from-advancement-incentives\" aria-label=\"m 13 reducing the epoch length results in leaking value from advancement incentives permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/4\">[M-13] Reducing the epoch length results in leaking value from advancement incentives</a></h2>\n<p><em>Submitted by TomFrench</em></p>\n<p>Unintended advancement incentives being paid out to third party</p>\n<h4 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><code>DAO.sol</code> incentives outside parties to advance the epoch by minting 100 MALT tokens for calling the <code>advance</code> function. This is limited by checking that the start timestamp of the next epoch has passed.</p>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/DAO.sol#L55-L63\">https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/DAO.sol#L55-L63</a></p>\n<p>This start timestamp is calculated by multiplying the new epoch number by the length of an epoch and adding it to the genesis timestamp.</p>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/DAO.sol#L65-L67\">https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/DAO.sol#L65-L67</a></p>\n<p>This method makes no accommodation for the fact that previous epochs may have been set to be a different length to what they are currently.</p>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/DAO.sol#L111-L114\">https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/DAO.sol#L111-L114</a></p>\n<p>In the case where the epoch length is reduced, <code>DAO</code> will think that the epoch number can be incremented potentially many times. Provided the <code>advanceIncentive</code> is worth more than the gas necessary to advance the epoch will be rapidly advanced potentially many times paying out unnecessary incentives.</p>\n<h4 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Rather than calculating from the genesis timestamp, store the last time that the epoch length was modified and calculate from there.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/4\">0xScotch (sponsor) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/4#issuecomment-1019293929\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Given a specific epoch length, the system will be able to determine which incentives to pay out.\nBecause the math for calculating the next epoch is based on the initial time, changing the <code>epochLength</code> can cause unintended consequences and allow for further calls to <code>advance</code> with the goal of receiving more caller incentives.</p>\n<p>The exploit can be triggered by admin privileges (changing epochLength), and because it’s a leak of value, I agree with medium severity</p>\n</blockquote>\n<h2 id=\"m-14-wrong-permissions-on-reassignglobaladmin\" style=\"position:relative;\"><a href=\"#m-14-wrong-permissions-on-reassignglobaladmin\" aria-label=\"m 14 wrong permissions on reassignglobaladmin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/250\">[M-14] Wrong permissions on <code>reassignGlobalAdmin</code></a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>Permissions.reassignGlobalAdmin</code> function is supposed to only be run with the <code>TIMELOCK_ROLE</code> role, see <code>onlyRole(TIMELOCK_ROLE, \"Only timelock can assign roles\")</code>.</p>\n<p>However, the <code>TIMELOCK_ROLE</code> is not the admin of all the reassigned roles and the <code>revokeRole(role, oldAccount)</code> calls will fail as it requires the <code>ADMIN_ROLE</code>.</p>\n<h4 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>The idea might have been that only the <code>TIMELOCK</code> should be able to call this function, and usually it is also an admin, but the function strictly does not work if the caller <em>only</em> has the <code>TIMELOCK</code> roll and will revert in this case.\nMaybe governance decided to remove the admin role from the Timelock, which makes it impossible to call <code>reassignGlobalAdmin</code> anymore as both the timelock and admin are locked out.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/250\">0xScotch (sponsor) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/250#issuecomment-1019393705\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified a flaw in the roles implementation, while the system seems to work when the timelock has multiple roles, the name of the roles implies a different functionality than what can actually be done.\nThe sponsor confirms.\nWhile I believe the impact in the demo setup to be fairly minor, because the finding shows a flow in the role setup, and the sponsor confirmed, I agree with medium severity</p>\n</blockquote>\n<h2 id=\"m-15-bonding-doesnt-work-with-fee-on-transfer-tokens\" style=\"position:relative;\"><a href=\"#m-15-bonding-doesnt-work-with-fee-on-transfer-tokens\" aria-label=\"m 15 bonding doesnt work with fee on transfer tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/251\">[M-15] Bonding doesn’t work with fee-on transfer tokens</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>Certain ERC20 tokens make modifications to their ERC20’s <code>transfer</code> or <code>balanceOf</code> functions.\nOne type of these tokens is deflationary tokens that charge a certain fee for every <code>transfer()</code> or <code>transferFrom()</code>.</p>\n<h4 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The <code>Bonding._bond()</code> function will revert in the <code>_balanceCheck</code> when transferring a fee-on-transfer token as it assumes the entire <code>amount</code> was received.</p>\n<h4 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>To support fee-on-transfer tokens, measure the asset change right before and after the asset-transferring calls and use the difference as the actual bonded amount.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/251\">0xScotch (sponsor) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/251#issuecomment-1019394195\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding, the check will revert on a token that takes fees as the system assumes that <code>amount</code> is the amount that will be received</p>\n</blockquote>\n<h2 id=\"m-16-theft-of-system-profit\" style=\"position:relative;\"><a href=\"#m-16-theft-of-system-profit\" aria-label=\"m 16 theft of system profit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/56\">[M-16] theft of system profit</a></h2>\n<p><em>Submitted by danb, also found by leastwood and WatchPug</em></p>\n<p>System profit comes from the stabilize function when the price of malt is above 1. Therefore it should not be allowed for anyone to take a part of the system profit when the price is above one. Right now, anyone can take a part of the investors’ profits, even if they don’t own any malt at all.</p>\n<h4 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>suppose that the price went up to 1.2 dai; the investors should get the reward for this rise. instead, anyone can take a part of the reward in the following steps:\nThe price of malt is now 1.2 dai.\nTake a flash loan of a large amount of malt.\nSell the malt for dai.\nNow the price went down to 1.1 dai because of the enormous swap.\nCall stabilize in order to lower the price to 1 dai.\nBuy malt to repay the flash loan at a lower cost with the bought dai.\nRepay the flash loan, and take the profit.</p>\n<p>It is a sandwich attack because they sold malt for a high price, then they called stabilize to lower the value, then repurchase it for a low price.</p>\n<p>The user made a profit at the expense of the investors.</p>\n<p>If a user already has malt, it’s even easier:\njust sell all malt at a high cost.</p>\n<h4 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>in _beforeTokenTransfer, if the price is above 1$ and the receiver is the AMM pool, stabilize it.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/56#issuecomment-1010442853\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@0xScotch The warden says that if the price is above the peg price, the system should stabilize it\nFrom reading the <code>PoolTransferVerification.verifyTransfer</code>, the system wants you to trade when Malt is above peg (minus tolerance)</p>\n<p>Would you say this finding is invalid?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/56#issuecomment-1019287914\">0xScotch (sponsor) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>@0xScotch The warden says that if the price is above the peg price, the system should stabilize it From reading the <code>PoolTransferVerification.verifyTransfer</code>, the system wants you to trade when Malt is above peg (minus tolerance)</p>\n<p>Would you say this finding is invalid?</p>\n</blockquote>\n<p>I think the issue being pointed out is that the stabilization above peg can be sandwiched and some profit that would go to LPs can be extracted. I think this is an issue but its not absolutely critical.</p>\n<p>We have discussed internally how to deal with this and the suggestion of calling stabilize would require some additional logic in the transfer verification as it would create a circular execution path.</p>\n<ol>\n<li>User tries to sell at 1.2</li>\n<li>Transfer verifier triggers stabilize</li>\n<li>StabilizerNode tries to sell Malt ahead of initial user</li>\n<li>Transfer verifier runs again and will call stabilize again unless we modify it to deal with this case.</li>\n</ol>\n<p>I don’t think that is an issue but we will consider how to best move ahead with it.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/56#issuecomment-1019511028\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Let’s dissect the warden’s finding:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">The price of malt is now 1.2 dai.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Take a flash loan of a large amount of malt.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Sell the malt for dai.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Now the price went down to 1.1 dai because of the enormous swap.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Call stabilize in order to lower the price to 1 dai.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Buy malt to repay the flash loan at a lower cost with the bought dai.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Repay the flash loan, and take the profit.</span></span></code></pre>\n<p>-> Flashloan Malt (assumes liquidity to do so, but let’s allow that)\n-> Sell malt for dai -> price goes lower\n-> Call stabilize -> system reduces price even further\n-> Buy back the malt\n-> repay the loan</p>\n<p>I feel like this is something that can’t really be avoided as due to the permissionless nature of liquidity pools, limiting the ability to sell or buy to a path will be sidestepped by having other pools being deployed to avoid those checks.</p>\n<p>That said, the warden has identified a way to leak value from the price control system.</p>\n<p>To be precise the value is being extracted against traders, as to get Malt to 1.2 you’d need a trader to be so aggressive in their purchase to push the price that high.\nThe warden showed how any arber / frontrunner can then “steal” the potential profits of the malt system users by frontrunning them.</p>\n<p>Due to the profit extraction nature of the finding, I believe Medium Severity to be correct</p>\n</blockquote>\n<h2 id=\"m-17-auction-collateraltoken-wont-work-if-token-is-fee-on-transfer-token-\" style=\"position:relative;\"><a href=\"#m-17-auction-collateraltoken-wont-work-if-token-is-fee-on-transfer-token-\" aria-label=\"m 17 auction collateraltoken wont work if token is fee on transfer token  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/227\">[M-17] Auction collateralToken won’t work if token is fee-on-transfer token </a></h2>\n<p><em>Submitted by harleythedog</em></p>\n<p>There are several ERC20 tokens that take a small fee on transfers/transferFroms (known as “fee-on-transfer” tokens). Most notably, USDT is an ERC20 token that has togglable transfer fees, but for now the fee is set to 0 (see the contract here: <a href=\"https://etherscan.io/address/0xdAC17F958D2ee523a2206206994597C13D831ec7#code\">https://etherscan.io/address/0xdAC17F958D2ee523a2206206994597C13D831ec7#code</a>). For these tokens, it should not be assumed that if you transfer <code>x</code> tokens to an address, that the address actually receives <code>x</code> tokens. In the current test environment, DAI is the only <code>collateralToken</code> available, so there are no issues. However, it has been noted that more pools will be added in the future, so special care will need to be taken if fee-on-transfer tokens (like USDT) are planned to be used as <code>collateralTokens</code>.</p>\n<p>For example, consider the function <code>purchaseArbitrageTokens</code> in Auction.sol. This function transfers <code>realCommitment</code> amount of <code>collateralToken</code> to the liquidityExtension, and then calls <code>purchaseAndBurn(realCommitment)</code> on the liquidityExtension. The very first line of <code>purchaseAndBurn(amount)</code> is <code>require(collateralToken.balanceOf(address(this)) >= amount, \"Insufficient balance\");</code>. In the case of fee-on-transfer tokens, this line will revert due to the small fee taken. This means that all calls to <code>purchaseArbitrageTokens</code> will fail, which would be very bad when the price goes below peg, since no one would be able to participate in this auction.</p>\n<h4 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>See <code>purchaseArbitrageTokens</code> here: <a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L177\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L177</a></p>\n<p>See <code>purchaseAndBurn</code> here: <a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/LiquidityExtension.sol#L117\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/LiquidityExtension.sol#L117</a></p>\n<h4 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Add logic to transfers/transferFroms to calculate exactly how many tokens were actually sent to a specific address. In the example given with <code>purchaseArbitrageTokens</code>, instead of calling <code>purchaseAndBurn</code> with <code>realCommitment</code>, the contract should use the difference in the liquidityExtension balance after the transfer minus the liquidityExtension  balance before the transfer.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/227\">0xScotch (sponsor) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/227#issuecomment-1019511655\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding, the system as a whole seem to not deal with feeOnTransfer Token\nMitigation can be as simple as never using them, or refactoring to check for actual amounts received</p>\n</blockquote>\n<h2 id=\"m-18-auctionparticipantsol-purchasearbitragetokens-should-not-push-duplicate-auctions\" style=\"position:relative;\"><a href=\"#m-18-auctionparticipantsol-purchasearbitragetokens-should-not-push-duplicate-auctions\" aria-label=\"m 18 auctionparticipantsol purchasearbitragetokens should not push duplicate auctions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/87\">[M-18] AuctionParticipant.sol: <code>purchaseArbitrageTokens</code> should not push duplicate auctions</a></h2>\n<p><em>Submitted by harleythedog</em></p>\n<p>In AuctionParticpant.sol, every time <code>purchaseArbitrageTokens</code> is called, the current auction is pushed to <code>auctionIds</code>. If this function were to be called on the same auction multiple times, then the same auction id would be pushed multiple times into this array, and the <code>claim</code> function would have issues with <code>replenishingIndex</code>.</p>\n<p>Specifically, even if <code>replenishingIndex</code> was incremented once in <code>claim</code>, it is still possible that the auction at the next index will never reward any more tokens to the participant, so the contract would need manual intervention to set <code>replenishingIndex</code> (due to the if statement on lines 79-82 that does nothing if there is no claimable yield).</p>\n<p>It is likely that <code>purchaseArbitrageTokens</code> would be called multiple times on the same auction. In fact, the commented out code for <code>handleDeficit</code> (in ImpliedCollateralService.sol) even suggests that the purchases might happen within the same transaction. So this issue will likely be an issue on most auctions and would require manual setting of <code>replenishingIndex</code>.</p>\n<p>NOTE: This is a separate issue from the one I just submitted previously relating to <code>replenishingIndex</code>. The previous issue was related to an edge case where <code>replenishingIndex</code> might need to be incremented by one if there are never going to be more claims, while this issue is due to duplicate auction ids.</p>\n<h4 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>See code for <code>purchaseArbitrageTokens</code> here: <a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/AuctionParticipant.sol#L40\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/AuctionParticipant.sol#L40</a></p>\n<p>Notice that <code>currentAuction</code> is always appended to <code>auctionIds</code>.</p>\n<h4 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Add a check to the function to <code>purchaseArbitrageTokens</code> to ensure that duplicate ids are not added. For example, this can be achieved by changing auctionIds to a mapping instead of an array.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/87\">0xScotch (sponsor) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/87#issuecomment-1019521510\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I agree with the finding, adding the same <code>auctionId</code> can lead to undefined behaviour. This can break claiming of incentives. Because of that, I think medium severity to be appropriate</p>\n</blockquote>\n<h2 id=\"m-19-miningservicesetbonding-should-use-bonding-role-instead-of-reinvestor-one\" style=\"position:relative;\"><a href=\"#m-19-miningservicesetbonding-should-use-bonding-role-instead-of-reinvestor-one\" aria-label=\"m 19 miningservicesetbonding should use bonding role instead of reinvestor one permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/370\">[M-19] MiningService.setBonding should use BONDING role instead of REINVESTOR one</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p>BONDING_ROLE cannot be managed after it was initialized.</p>\n<h4 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><code>setBonding</code> set the wrong role via _swapRole:</p>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/MiningService.sol#L116\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/MiningService.sol#L116</a></p>\n<h4 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Set <code>BONDING_ROLE</code> instead of <code>REINVESTOR_ROLE</code> in <code>setBonding</code> function:</p>\n<p>Now:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setBonding</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_bonding</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ADMIN_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Must have admin privs&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_bonding</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Cannot use address 0&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">_swapRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_bonding</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">, </span><span class=\"mtk12\">REINVESTOR_ROLE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bonding</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_bonding</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>To be:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setBonding</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_bonding</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ADMIN_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Must have admin privs&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_bonding</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Cannot use address 0&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">_swapRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_bonding</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bonding</span><span class=\"mtk1\">, </span><span class=\"mtk12\">BONDING_ROLE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bonding</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_bonding</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/370\">0xScotch (sponsor) confirmed</a></strong></p>\n<h2 id=\"m-20-users-can-contribute-to-an-auction-without-directly-committing-collateral-tokens\" style=\"position:relative;\"><a href=\"#m-20-users-can-contribute-to-an-auction-without-directly-committing-collateral-tokens\" aria-label=\"m 20 users can contribute to an auction without directly committing collateral tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/188\">[M-20] Users Can Contribute To An Auction Without Directly Committing Collateral Tokens</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p><code>purchaseArbitrageTokens</code> enables users to commit collateral tokens and in return receive arbitrage tokens which are redeemable in the future for Malt tokens. Each auction specifies a commitment cap which when reached, prevents users from participating in the auction. However, <code>realCommitment</code> can be ignored by directly sending the <code>LiquidityExtension</code> contract collateral tokens and subsequently calling <code>purchaseArbitrageTokens</code>.</p>\n<h4 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Consider the following scenario:</p>\n<ul>\n<li>An auction is currently active.</li>\n<li>A user sends collateral tokens to the <code>LiquidityExtension</code> contract.</li>\n<li>The same user calls <code>purchaseArbitrageTokens</code> with amount <code>0</code>.</li>\n<li>The <code>purchaseAndBurn</code> call returns a positive <code>purchased</code> amount which is subsequently used in auction calculations.</li>\n</ul>\n<p>As a result, a user could effectively influence the average malt price used throughout the <code>Auction</code> contract.</p>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L177-L214\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L177-L214</a>\n<a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/LiquidityExtension.sol#L117-L128\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/LiquidityExtension.sol#L117-L128</a></p>\n<h4 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider adding a check to ensure that <code>realCommitment != 0</code> in <code>purchaseArbitrageTokens</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/188\">0xScotch (sponsor) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/188#issuecomment-1020112892\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified a way to side-step the cap on commitments.\nBecause the commitments are used for calculating limits, but <code>maltPurchased</code> is used to calculate rewards, an exploiter can effectively use an auction to purchase as many arbitrage tokens as they desire.</p>\n<p>Using any <code>amount</code> greater than zero will eventually allow to end the auction, however, by using 0 this process can be repeated continuously.</p>\n<p>Agree with the finding and severity</p>\n</blockquote>\n<h2 id=\"m-21-stabilizernode-will-mint-an-incentive-for-triggering-an-auction-even-if-an-auction-exists-already\" style=\"position:relative;\"><a href=\"#m-21-stabilizernode-will-mint-an-incentive-for-triggering-an-auction-even-if-an-auction-exists-already\" aria-label=\"m 21 stabilizernode will mint an incentive for triggering an auction even if an auction exists already permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/191\">[M-21] <code>StabilizerNode</code> Will Mint An Incentive For Triggering An Auction Even If An Auction Exists Already</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p><code>_startAuction</code> utilises the <code>SwingTrader</code> contract to purchase Malt. If <code>SwingTrader</code> has insufficient capital to return the price of Malt back to its target price, an auction is triggered with the remaining amount. However, no auction is triggered if the current auction exists, but <code>msg.sender</code> is still rewarded for their call to <code>stabilize</code>.</p>\n<h4 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><code>_shouldAdjustSupply</code> initially checks if the current auction is active, however, it does not check if the current auction exists. There is a key distinction between the <code>auctionActive</code> and <code>auctionExists</code> functions which are not used consistently. Hence, an auction which is inactive but exists would satisfy the edge case and result in <code>triggerAuction</code> simply returning.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L382-L386\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L382-L386</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L268-L272\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L268-L272</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L342-L344\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L342-L344</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L873-L888\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L873-L888</a></li>\n</ul>\n<h4 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider using <code>auctionExists</code> and <code>auctionActive</code> consistently in <code>StabilizerNode</code> and <code>Auction</code> to ensure this edge case cannot be abused.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/191\">0xScotch (sponsor) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/191#issuecomment-1020125296\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden found a way to effectively mint free malt by spamming the caller incentive by abusing a specific edge case.</p>\n</blockquote>\n<h2 id=\"m-22-_calculatemaltrequiredforexit-uses-spot-price-to-calculate-malt-quantity-in-exitearly\" style=\"position:relative;\"><a href=\"#m-22-_calculatemaltrequiredforexit-uses-spot-price-to-calculate-malt-quantity-in-exitearly\" aria-label=\"m 22 _calculatemaltrequiredforexit uses spot price to calculate malt quantity in exitearly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/215\">[M-22] <code>_calculateMaltRequiredForExit</code> Uses Spot Price To Calculate Malt Quantity In <code>exitEarly</code></a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p><code>_calculateMaltRequiredForExit</code> in <code>AuctionEscapeHatch</code> currently uses Malt’s spot price to calculate the quantity to return to the exiting user. This spot price simply tracks the Uniswap pool’s reserves which can easily be manipulated via a flash loan attack to extract funds from the protocol.</p>\n<h4 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/AuctionEscapeHatch.sol#L65-L92\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/AuctionEscapeHatch.sol#L65-L92</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/AuctionEscapeHatch.sol#L193\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/AuctionEscapeHatch.sol#L193</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L80-L109\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L80-L109</a></li>\n<li><a href=\"https://shouldiusespotpriceasmyoracle.com/\">https://shouldiusespotpriceasmyoracle.com/</a></li>\n</ul>\n<h4 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider implementing/integrating a TWAP oracle to track the price of Malt.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/215\">0xScotch (sponsor) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/215#issuecomment-1020710474\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I feel like this issue highlights the design challenge that the sponsor will have to solve, on one hand the protocol is meant to stabilize the price of malt in specific pools (impossible to block / control every pool due to permissionless nature).\nAt the same time in order to determine which direction to move the price to, they need to refer to the pricing of the underlying pools (in this case a UniV2Pool, most likely from QuickSwap)</p>\n<p>Personally I understand the finding and think it’s valid, however I don’t believe there’s easy answers as to how the sponsor should address this.</p>\n<p>Whenever there’s excess value there will be entities trying to seize it and perhaps through such a harsh environment this protocol can truly find a way to be sustainable.</p>\n<p>That said, I’ll mark the finding as valid, but believe this specific issue underlines the challenges that await the sponsor in making the protocol succesful</p>\n</blockquote>\n<h2 id=\"m-23-addliquidity-does-not-reset-approval-if-not-all-tokens-were-added-to-liquidity-pool\" style=\"position:relative;\"><a href=\"#m-23-addliquidity-does-not-reset-approval-if-not-all-tokens-were-added-to-liquidity-pool\" aria-label=\"m 23 addliquidity does not reset approval if not all tokens were added to liquidity pool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/228\">[M-23] <code>addLiquidity</code> Does Not Reset Approval If Not All Tokens Were Added To Liquidity Pool</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p><code>addLiquidity</code> is called when users reinvest their tokens through bonding events. The <code>RewardReinvestor</code> first transfers Malt and rewards tokens before adding liquidity to the token pool. <code>addLiquidity</code> provides protections against slippage by a margin of 5%, and any dust token amounts are transferred back to the caller. In this instance, the caller is the <code>RewardReinvestor</code> contract which further distributes the dust token amounts to the protocol’s treasury. However, the token approval for this outcome is not handled properly. Dust approval amounts can accrue over time, leading to large Uniswap approval amounts by the <code>UniswapHandler</code> contract.</p>\n<h4 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L212-L214\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L212-L214</a>\n<a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L216-L218\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L216-L218</a></p>\n<h4 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider resetting the approval amount if either <code>maltUsed &#x3C; maltBalance</code> or <code>rewardUsed &#x3C; rewardBalance</code> in <code>addLiquidity</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/228\">0xScotch (sponsor) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/228#issuecomment-1020718747\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The UniV2Router will first <a href=\"https://github.com/Uniswap/v2-periphery/blob/2efa12e0f2d808d9b49737927f0e416fafa5af68/contracts/UniswapV2Router02.sol#L71\">calculate the amounts</a> and then <a href=\"https://github.com/Uniswap/v2-periphery/blob/2efa12e0f2d808d9b49737927f0e416fafa5af68/contracts/UniswapV2Router02.sol#L73\">pull them</a> from the msg.sender</p>\n<p>This means that approvals may not be fully utilized, leaving traces of approvals here and there.\nThis can cause issues with certain tokens (USDT comes to mind), and will also not trigger gas refunds.</p>\n</blockquote>\n<h2 id=\"m-24-_distributerewards-does-not-reset-approval-if-not-all-tokens-were-allocated\" style=\"position:relative;\"><a href=\"#m-24-_distributerewards-does-not-reset-approval-if-not-all-tokens-were-allocated\" aria-label=\"m 24 _distributerewards does not reset approval if not all tokens were allocated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/229\">[M-24] <code>_distributeRewards</code> Does Not Reset Approval If Not All Tokens Were Allocated</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p><code>_distributeRewards</code> attempts to reward LP token holders when the price of Malt exceeds its price target. Malt Finance is able to being Malt back to its peg by selling Malt and distributing rewards tokens to LP token holders. An external call to <code>Auction</code> is made via the <code>allocateArbRewards</code> function. Prior to this call, the <code>StabilizerNode</code> approves the contract for a fixed amount of tokens, however, the <code>allocateArbRewards</code> function does not necessarily utilise this entire amount. Hence, dust token approval amounts may accrue from within the <code>StabilizerNode</code> contract.</p>\n<h4 id=\"proof-of-concept-18\" style=\"position:relative;\"><a href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L252-L253\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L252-L253</a>\n<a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L809-L871\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L809-L871</a></p>\n<h4 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider resetting the approval amount if the input <code>rewarded</code> amount to <code>allocateArbRewards</code> is less than the output amount.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/229\">0xScotch (sponsor) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/229#issuecomment-1020720987\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Finding is valid, incorrect approvals can cause reverts (USDT being an example), and not fully resetting will also negate gas refunds</p>\n</blockquote>\n<h2 id=\"m-25-amm-pool-can-be-drained-using-a-flashloan-and-calling-stabilize\" style=\"position:relative;\"><a href=\"#m-25-amm-pool-can-be-drained-using-a-flashloan-and-calling-stabilize\" aria-label=\"m 25 amm pool can be drained using a flashloan and calling stabilize permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/372\">[M-25] AMM pool can be drained using a flashloan and calling <code>stabilize</code></a></h2>\n<p><em>Submitted by stonesandtrees</em></p>\n<p>All of the <code>rewardToken</code> in a given AMM pool can be removed from the AMM pool and distributed as LP rewards.</p>\n<h4 id=\"proof-of-concept-19\" style=\"position:relative;\"><a href=\"#proof-of-concept-19\" aria-label=\"proof of concept 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>In the <code>stabilize</code> method in the <code>StabilizerNode</code> the initial check to see if the Malt price needs to be stabilized it uses a short period TWAP:\n<a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L156\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L156</a></p>\n<p>However, if the price is above the threshold for stabilization then the trade size required to stabilize looks at the AMM pool directly which is vulnerable to flashloan manipulation.</p>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L250-L275\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L250-L275</a></p>\n<p>Attack:</p>\n<ol>\n<li>Wait for TWAP to rise above the stabilization threshold</li>\n<li>Flashloan remove all but a tiny amount of Malt from the pool.</li>\n<li>Call <code>stabilize</code>. This will pass the TWAP check and execute <code>_distributeSupply</code> which in turn ultimately calls <code>_calculateTradeSize</code> in the <code>UniswapHandler</code>. This calculation will determine that almost all of the <code>rewardToken</code> needs to be removed from the pool to return the price to peg.</li>\n<li>Malt will mint enough Malt to remove a lot of the <code>rewardToken</code> from the pool.</li>\n<li>The protocol will now distribute that received <code>rewardToken</code> as rewards. 0.3% of which goes directly to the attacker and the rest goes to LP rewards, swing trader and the treasury.</li>\n</ol>\n<p>The amount of money that can be directly stolen by a malicious actor is small but it can cause a lot of pain for the protocol as the pool will be destroyed and confusion around rewards will be created.</p>\n<h4 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Use a short TWAP to calculate the trade size instead of reading directly from the pool.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/372\">0xScotch (sponsor) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/372#issuecomment-1020734907\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I believe the warden has identified a valid grief and potential exploit</p>\n<p>I’m not convinced on the simplicity of:\n<code>2. Flashloan remove all but a tiny amount of Malt from the pool.</code></p>\n<p>You’d have to buy that liquidity in order to be able to remove the malt, which effectively makes the operation not as straightforward (if not unprofitable for the attacker).</p>\n<p>I do believe the grief can be performed but in lack of a clear incentive for the attacker, am going to downgrade to Medium Severity.\nCan be done, but not clear on the incentives</p>\n</blockquote>\n<h2 id=\"m-26-dutch-auction-can-be-manipulated\" style=\"position:relative;\"><a href=\"#m-26-dutch-auction-can-be-manipulated\" aria-label=\"m 26 dutch auction can be manipulated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/375\">[M-26] Dutch auction can be manipulated</a></h2>\n<p><em>Submitted by gzeon</em></p>\n<p>When malt is under-peg and the swing trader module do not have enough capital to buy back to peg, a Dutch auction is triggered to sell arb token. The price of the Dutch auction decrease linearly toward endprice until _endAuction() is called. <a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L589\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L589</a></p>\n<p>_endAuction() is called in</p>\n<ol>\n<li>When auction.commitments >= auction.maxCommitments</li>\n</ol>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L212\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L212</a></p>\n<ol start=\"2\">\n<li>On stabilize() -> checkAuctionFinalization() -> _checkAuctionFinalization()</li>\n</ol>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/StabilizerNode.sol#L146\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/StabilizerNode.sol#L146</a>\n<a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L754\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L754</a></p>\n<ol start=\"3\">\n<li>On stabilize() ->_startAuction() -> triggerAuction() -> _checkAuctionFinalization()</li>\n</ol>\n<p><a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/StabilizerNode.sol#L170\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/StabilizerNode.sol#L170</a>\n<a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L754\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L754</a></p>\n<p>It is possible manipulate the dutch auction by preventing _endAuction() being called.</p>\n<h4 id=\"proof-of-concept-20\" style=\"position:relative;\"><a href=\"#proof-of-concept-20\" aria-label=\"proof of concept 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Consider someone call purchaseArbitrageTokens with auction.maxCommitments minus 1 wei, <code>_endAuction</code> won’t be called because auction.commitments &#x3C; auction.maxCommitments. Further purchase would revert because <code>purchaseAndBurn</code> (<a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L184\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L184</a>) would likely revert since swapping 1 wei in most AMM will fail due to rounding error. Even if it does not revert, there is no incentive to waste gas to purchase 1 wei of token.</p>\n<p>As such, the only way for the auction to finalize is to call stabilize().\nHowever, this is not immediately possible because it require\n<code>block.timestamp >= stabilizeWindowEnd</code> where\n<code>stabilizeWindowEnd = block.timestamp + stabilizeBackoffPeriod</code>\nstabilizeBackoffPeriod is initially set to 5 minutes in the contract</p>\n<p>After 5 minute, stabilize() can be called by anyone. By using this exploit, an attacker can guarantee he can purchase at (startingPrice+endingPrice)/2 or lower, given the default 10 minute auctionLength and 5 minute stabilizeBackoffPeriod. (unless a privileged user call stabilize() which override the stability window)</p>\n<p>Also note that stabilize() might not be called since there is no incentive.</p>\n<h4 id=\"recommended-mitigation-steps-24\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-24\" aria-label=\"recommended mitigation steps 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<ol>\n<li>Incentivize stabilize() or incentivize a permission-less call to _endAuction()</li>\n<li>Lock-in auction price when user commit purchase</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/375\">0xScotch (sponsor) labeled</a> sponsor confirmed</strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/375#issuecomment-1020758586\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>By purchasing all but 1 wei of arbitrageTokens, any caller can guarantee that the auction will offer the steepest discount.</p>\n<p>This is caused by the fact that AMMs (esp UniV2) will revert with small numbers, as rounding will cause the amountOut to == 0 which will cause a INSUFFICIENT_AMOUNT revert.</p>\n<p>I agree with the pre-conditions and the possibility of this to happen.\nIn a sense I believe this can become the meta strategy that every dutch auction participant will use (the fight between buyers will be done by paying gas to be the first few to buy arbitrageTokens).</p>\n<p>So the question is how to avoid it.\nI guess purchasing at a time should lock the price for that particular buyer at that particular time (adding a mapping should increase cost of 20k on write and a few thousand gas on read).</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/375#issuecomment-1020759031\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>TODO: Decide on severity</p>\n<p>Medium for sure, extract value reliably.\nIs it high though? Arguably the dutch auction is not properly coded as it allows to get a further discount instead of locking in a price for the user at time of deposit</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/375#issuecomment-1022195290\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>While an argument for the Dutch Auction being coded wrong (user locking in price) can be made, that’s not the definition of a Dutch Auciton</p>\n<img width=\"600\" alt=\"Screenshot 2022-01-26 at 14 16 34\" src=\"https://user-images.githubusercontent.com/13383782/151169628-a1d8e7e7-15c2-4064-a985-9f923154170a.png\">\nhttps://www.investopedia.com/terms/d/dutchauction.asp\n<p>So arguably the dutch auction is properly coded, it’s that there’s a specific way to sidestep it which is caused by:</p>\n<ul>\n<li>1 wei tx reverting on swap</li>\n<li>sum of purchases not being enough</li>\n</ul>\n<p>For this conditions to happen the “exploiter” needs to be fast enough to place an order, in such a way that their order will leave 1 commitment left.\nI can imagine them setting up a contract that reverts if this condition isn’t met and that checks for w/e amount is needed at that time.</p>\n<p>I would assume that having an admin privileged function to close the auction prematurely would solve this specific attack.</p>\n<p>I believe that the warden has identified a fairly reliable way to get a discount from the protocol because of the impact and some of the technicalities I believe Medium Severity to be more appropriate.\nThis will be exploited, but in doing so will make the protocol successful (all auction full minus 1 wei), the premium / discount will be reliable predicted (50% between start and end) and as such I believe it will be priced in</p>\n</blockquote>\n<h2 id=\"m-27-slippage-checks-when-adding-liquidity-are-too-strict\" style=\"position:relative;\"><a href=\"#m-27-slippage-checks-when-adding-liquidity-are-too-strict\" aria-label=\"m 27 slippage checks when adding liquidity are too strict permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/257\">[M-27] Slippage checks when adding liquidity are too strict</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>When adding liquidity through <code>UniswapHandler.addLiquidity</code>, the entire contract balances are used to add liquidity and the min amounts are set to 95% of these balances.\nIf the balances in this contract are unbalanced (the ratio is not similar to the current Uniswap pool reserve ratios) then this function will revert and no liquidity is added.</p>\n<p>See <code>UniswapHandler.buyMalt</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">maltUsed</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rewardUsed</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityCreated</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">router</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addLiquidity</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">malt</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">maltBalance</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// @audit-info amountADesired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">rewardBalance</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// @audit assumes that whatever is in this contract is already balanced. good assumption?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">maltBalance</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk7\">95</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk7\">100</span><span class=\"mtk1\">), </span><span class=\"mtk3\">// @audit-info amountAMin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">rewardBalance</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk7\">95</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk7\">100</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// transfer LP tokens to sender</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">now</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<h4 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>If the contract has unbalanced balances, then the <code>router.addLiquidity</code> call will revert.\nNote that an attacker could even send tokens to this contract to make them unbalanced and revert, resulting in a griefing attack.</p>\n<h4 id=\"recommended-mitigation-steps-25\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-25\" aria-label=\"recommended mitigation steps 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>It needs to be ensured that the balances in the contract are always balanced and match the current reserve ratio.\nIt might be better to avoid directly using the balances which can be manipulated by transferring tokens to the contract and accepting parameters instead of how many tokens to provide liquidity with from the caller side.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/257\">0xScotch (sponsor) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/257#issuecomment-1022202079\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Interestingly the warden highlights the other side of the “missing slippage check” argument.\nSlippage checks in general need to be calculated offChain (as you will get frontrun in the mempool, so the slippage check is a risk minimization tool more than anything else)</p>\n<p>The warden also specified a griefing attack that can be used because of the hardcoded check.\nThe sponsor confirms, I think medium severity is appropriate</p>\n</blockquote>\n<h2 id=\"m-28-bondingsol-_unbondandbreak-does-not-account-for-edge-case-where-no-tokens-are-returned\" style=\"position:relative;\"><a href=\"#m-28-bondingsol-_unbondandbreak-does-not-account-for-edge-case-where-no-tokens-are-returned\" aria-label=\"m 28 bondingsol _unbondandbreak does not account for edge case where no tokens are returned permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/234\">[M-28] Bonding.sol _unbondAndBreak does not account for edge case where no tokens are returned</a></h2>\n<p><em>Submitted by harleythedog</em></p>\n<p>In Bonding.sol, the internal function <code>_unbondAndBreak</code> transfers a user’s stake tokens to the dexHandler and then calls <code>removeLiquidity</code> on the dexHandler. Within the Uniswap handler (which is the only handler so far) <code>removeLiquidity</code> takes special care in the edge case where <code>router.removeLiquidity</code> returns zero tokens. Specifically, the Uniswap handler has this code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amountMalt</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">amountReward</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">liquidityBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lpToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">lpToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidityBalance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amountMalt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>If this edge case does indeed happen (i.e. if something is preventing the Uniswap router from removing liquidity at the moment), then the Uniswap handler will transfer the LP tokens back to Bonding.sol. However, Bonding.sol does not have any logic to recognize that this happened, so the LP tokens will become stuck in the contract and the user will never get any of their value back. This could be very bad if the user unbonds a lot of LP and they don’t get any of it back.</p>\n<h4 id=\"proof-of-concept-21\" style=\"position:relative;\"><a href=\"#proof-of-concept-21\" aria-label=\"proof of concept 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>See <code>_unbondAndBreak</code> here: <a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Bonding.sol#L226\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Bonding.sol#L226</a></p>\n<p>Notice how the edge case where <code>amountMalt == 0 || amountReward == 0</code> is not considered in this function, but it is considered in the Uniswap handler’s <code>removeLiquidity</code> here: <a href=\"https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/DexHandlers/UniswapHandler.sol#L240\">https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/DexHandlers/UniswapHandler.sol#L240</a></p>\n<h4 id=\"recommended-mitigation-steps-26\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-26\" aria-label=\"recommended mitigation steps 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Add a similar edge case check to <code>_unbondAndBreak</code>. In the case where LP tokens are transferred back to Bonding.sol instead of malt/reward, these LP tokens should be forwarded back to the user since the value is rightfully theirs.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/234\">0xScotch (sponsor) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/234#issuecomment-1022203715\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>In the <code>then</code> case the tokens will be sent back to the <code>Bonding.sol</code> contract, which has no way of rescuing or returning the tokens, probably reverting would be a better solution.</p>\n<p>Because the warden identified a way for tokens to get stucked, I think Medium Severity to be appropriate</p>\n</blockquote>\n<h2 id=\"m-29-user-can-bypass-recovery-mode-via-uniswaphandler-to-buy-malt-\" style=\"position:relative;\"><a href=\"#m-29-user-can-bypass-recovery-mode-via-uniswaphandler-to-buy-malt-\" aria-label=\"m 29 user can bypass recovery mode via uniswaphandler to buy malt  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/325\">[M-29] User can bypass Recovery Mode via UniswapHandler to buy Malt </a></h2>\n<p><em>Submitted by gzeon</em></p>\n<p>One of the innovative feature of Malt is to block buying while under peg. The buy block can be bypassed by swapping to the whitelisted UniswapHandler, and then extract the token by abusing the add and remove liquidity function. This is considered a high severity issue because it undermine to protocol’s ability to generate profit by the privileged role as designed and allow potential risk-free MEV.</p>\n<h4 id=\"proof-of-concept-22\" style=\"position:relative;\"><a href=\"#proof-of-concept-22\" aria-label=\"proof of concept 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ol>\n<li>User swap dai into malt and send malt directly to uniswapHandler, this is possible becuase uniswapHandler is whitelisted</li>\n</ol>\n<p><code>swapExactTokensForTokens(amountDai, 0, [dai.address, malt.address], uniswapHandler.address, new Date().getTime() + 10000);</code>\n2) User send matching amount of dai to uniswapHandler\n3) User call addLiquidity() and get back LP token\n4) User call removeLiquidity() and get back both dai and malt</p>\n<h4 id=\"recommended-mitigation-steps-27\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-27\" aria-label=\"recommended mitigation steps 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>According to documentation in <a href=\"https://github.com/code-423n4/2021-11-malt#high-level-overview-of-the-malt-protocol\">https://github.com/code-423n4/2021-11-malt#high-level-overview-of-the-malt-protocol</a></p>\n<blockquote>\n<p>Users wanting to remove liquidity can still do so via the UniswapHandler contract that is whitelisted in recovery mode.</p>\n</blockquote>\n<p>, this should be exploitable. Meanwhile the current implementation did not actually allow remove liquidity during recovery mode (refer to issue “Unable to remove liquidity in Recovery Mode”)\nThis exploit can be mitigated by disabling addLiquidity() when the protocol is in recovery mode</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/325\">0xScotch (sponsor) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/325#issuecomment-1020752336\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Malt token is programmed to explicitly prevent buying it when at discount.\nHowever, because <code>addLiquidity</code> and <code>removeLiquidity</code> are callable by anyone, and the <code>UniswapHandler</code> is whitelisted, through a calculated addition and removal of liquidity anyone can mimick buying Malt for a discount (by providing imbalanced underlying and redeeming them).</p>\n<p>I believe this sidesteps the majority of the functionality of the protocol, and while the attack is fairly simple, it denies the protocol functionality and as such agree with a High Severity</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/325#issuecomment-1025167069\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>After re-review:\nAddressing each step:</p>\n<ol>\n<li>The swap can be done as the whitelisting is bypassed (so finding is valid on that end)</li>\n<li>User can send more liquidity</li>\n<li>User can add liquidity at discount (as they bought at discount) (notice that this subjects them to potentially more IL so arguably the MEV extraction happened at step 1)</li>\n<li>This cannot be done because of #323 which was found by the same warden. As per #323 you can’t remove liquidity as the <code>transfer</code> will be from pool to user and as such will be reverted due to the system being in recovery mode.</li>\n</ol>\n<p>I believe that the warden identified a way to sidestep purchasing malt via purchase -> send to UniswapHandler -> add liquidity which should allow for some MEV extraction (with the user risking IL as they assume malt will go back to peg)</p>\n<p>Because of this there’s still some validity to the finding, but it’s not as dire as I originally believed.</p>\n<p>I’m going to downgrade the finding to Medium Severity as:</p>\n<ol>\n<li>Value can be extracted</li>\n<li>by bypassing the check for buying malt</li>\n</ol>\n<p>But this doesn’t allow the selling of malt, so it’s not a protocol breaking exploit but rather a way to gain MEV.</p>\n</blockquote>\n<h2 id=\"m-30-malt-protocol-uses-stale-results-from-maltdatalab-which-can-be-abused-by-users\" style=\"position:relative;\"><a href=\"#m-30-malt-protocol-uses-stale-results-from-maltdatalab-which-can-be-abused-by-users\" aria-label=\"m 30 malt protocol uses stale results from maltdatalab which can be abused by users permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/373\">[M-30] Malt Protocol Uses Stale Results From <code>MaltDataLab</code> Which Can Be Abused By Users</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p><code>MaltDataLab</code> integrates several <code>MovingAverage</code> contracts to fetch sensitive data for the Malt protocol. Primary data used by the protocol consists of the real value for LP tokens, the average price for Malt and average reserve ratios. <code>trackMaltPrice</code>, <code>trackPoolReserves</code> and <code>trackPool</code> are called by a restricted role denoted as the <code>UPDATER_ROLE</code> and represented by an EOA account and not another contract. Hence, the EOA account must consistently update the aforementioned functions to ensure the most up-to-date values. However, miners can censor calls to <code>MaltDataLab</code> and effectively extract value from other areas of the protocol which use stale values.</p>\n<h4 id=\"proof-of-concept-23\" style=\"position:relative;\"><a href=\"#proof-of-concept-23\" aria-label=\"proof of concept 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Consider the following attack vector:</p>\n<ul>\n<li>The price of Malt exceeds the lower bound threshold and hence <code>stabilize</code> can be called by any user.</li>\n<li>The <code>_stabilityWindowOverride</code> function is satisfied, hence the function will execute.</li>\n<li>The state variable, <code>exchangeRate</code>, queries <code>maltPriceAverage</code> which may use an outdated exchange rate.</li>\n<li><code>_startAuction</code> is executed which rewards <code>msg.sender</code> with 100 Malt as an incentive for triggering an auction.</li>\n<li>As the price is not subsequently updated, a malicious attacker could collude with a miner to censor further pool updates and continue calling <code>stabilize</code> on every <code>fastAveragePeriod</code> interval to extract incentive payments.</li>\n<li>If the payments exceed what the <code>UPDATER_ROLE</code> is willing to pay to call <code>trackMaltPrice</code>, a user is able to sustain this attack.</li>\n</ul>\n<p>This threatens the overall stability of the protocol and should be properly handled to prevent such attacks. However, the fact that <code>MaltDataLab</code> uses a series of spot price data points to calculate the <code>MovingAverage</code> also creates an area of concern as well-funded actors could still manipulate the <code>MovingAverage</code> contract by sandwiching calls to <code>trackMaltPrice</code>, <code>trackPool</code> and <code>trackPoolReserves</code>.</p>\n<p><code>trackMaltPrice</code>, <code>trackPool</code>, and <code>trackPoolReserves</code> should be added to the following areas of the code where applicable.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Bonding.sol#L159\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Bonding.sol#L159</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Bonding.sol#L173\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Bonding.sol#L173</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Bonding.sol#L177\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Bonding.sol#L177</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L881\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L881</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L710\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L710</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L156\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L156</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L190\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L190</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/ImpliedCollateralService.sol#L105\">https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/ImpliedCollateralService.sol#L105</a></li>\n</ul>\n<h4 id=\"recommended-mitigation-steps-28\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-28\" aria-label=\"recommended mitigation steps 28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider adding calls to <code>trackMaltPrice</code>, <code>trackPoolReserves</code> and <code>trackPool</code> wherever the values are impacted by the protocol. This should ensure the protocol is tracking the most up-to-date values. Assuming the cumulative values are used in the <code>MovingAverage</code> contracts, then sensitive calls utilising <code>MaltDataLab</code> should be protected from flashloan attacks. However, currently this is not the case, rather <code>MovingAverage</code> consists of a series of spot price data points which can be manipulated by well-funded actors or via a flashloan. Therefore, there needs to be necessary changes made to <code>MaltDataLab</code> to use cumulative price updates as its moving average instead of spot price.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/373\">0xScotch (sponsor) confirmed</a>:</strong> </p>\n<blockquote>\n<p>Gas issues were the reason updates weren’t inlined into paths that update critical values. However based on some thoughts from the team over the past few weeks and suggestions in other audit findings I think we can reduce gas enough to make it viable to inline it </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/373#issuecomment-1019283105\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<ol>\n<li>Miners can censor transactions, that is a fact</li>\n<li>Relying on an external call can cause race conditions or situations where the call didn’t happen (price didn’t update in time)</li>\n<li>Arguably a malicious actor could collude with miners with the goal of extracting further value</li>\n</ol>\n<p>However, the target chain for the deployment is Polygon, so unless they were to create custom validator code, and collude 1-1 with each validator (no flashbots on Polygon, yet) then the attack is increasingly more complex.</p>\n<p>The attack is reliant on the externalities of the validator + somebody incentivized enough to exploit this.</p>\n<p>I agree with he finding and believe after stabilize the system should auto-update the prices\nBecause of the external requirements am downgrading to medium severity</p>\n</blockquote>\n<h1 id=\"low-risk-findings-43\" style=\"position:relative;\"><a href=\"#low-risk-findings-43\" aria-label=\"low risk findings 43 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Findings (43)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/120\">[L-01] sellMalt(), addLiquidity() and removeLiquidity() Allow Non Privileged Users Withdraw Fund</a> <em>Submitted by Meta0xNull, also found by 0x1f8b</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/216\">[L-02] Missing zero address check which will put forfeited rewards at risk(ForefeitHandler.sol) </a> <em>Submitted by 0xwags</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/64\">[L-03] Multiple Zero address transfer functions on contract Permissions</a> <em>Submitted by BouSalman, also found by 0xwags and sabtikw</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/380\">[L-04] DOS with unbounded loop</a> <em>Submitted by Koustre</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/130\">[L-05] setupParticipant() function does not check for zero address</a> <em>Submitted by jayjonah8</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/113\">[L-06] reassignGlobalAdmin() Lack of Zero Address Check </a> <em>Submitted by Meta0xNull, also found by BouSalman</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/135\">[L-07] Code does not match comments in “_finalizeAuction” (Auction.sol)</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/198\">[L-08] Revert transaction if it is unable to change data</a> <em>Submitted by xYrYuYx</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/74\">[L-09] Missing zero-address checks on contract initialization</a> <em>Submitted by hyh, also found by 0x1f8b, cmichel, jayjonah8, tabish, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/41\">[L-10] The Contract Should safeApprove(0) first</a> <em>Submitted by defsec, also found by hagrid and robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/168\">[L-11] Lack of precision</a> <em>Submitted by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/103\">[L-12] Incorrect error messages in <code>StabilizerNode.sol</code></a> <em>Submitted by pmerkleplant</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/359\">[L-13] purchaseArbitrageTokens 0 amount</a> <em>Submitted by pauliax, also found by jayjonah8</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/245\">[L-14] <code>initialize</code> functions can be frontrun</a> <em>Submitted by cmichel, also found by 0x1f8b, defsec, jayjonah8, leastwood, Meta0xNull, stonesandtrees, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/293\">[L-15] <code>StabilizerNode.sol</code> The current implementation is misconfiguration-prone for rewardToken with non-18 decimals</a> <em>Submitted by WatchPug, also found by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/235\">[L-16] Auction.sol amendAccountParticipation has no zero division check</a> <em>Submitted by harleythedog</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/85\">[L-17] AuctionParticipant.sol: <code>replenishingIndex</code> incrementing should be improved</a> <em>Submitted by harleythedog</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/357\">[L-18] maxAmount and balance</a> <em>Submitted by pauliax, also found by xYrYuYx</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/356\">[L-19] Inclusive checks</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/352\">[L-20] Inconsistencies when checking if the auction is active</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/115\">[L-21] _setupRole() Deprecated and Not Using With Constructor Effectively Circumventing the Admin System</a> <em>Submitted by Meta0xNull, also found by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/350\">[L-22] Validation of ‘to’ in transferAndCall and transferWithPermit</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/349\">[L-23] DOMAIN_SEPARATOR can change</a> <em>Submitted by pauliax, also found by leastwood</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/353\">[L-24] Auction.claimArbitrage: if calculated claimable amount is too big, the remaining committed amount cannot be retrieved</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/175\">[L-25] Malt decimals inconsistency: StabilizerNode and DAO contracts use 18 as hard coded Malt decimals</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/193\">[L-26] setSampleMemory counter set to right value?</a> <em>Submitted by gpersoon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/75\">[L-27] Lack Of Return Value Check On the Dex Handler Malt Price Calculation</a> <em>Submitted by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/60\">[L-28] SafeMath library is not always used in the contracts</a> <em>Submitted by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/247\">[L-29] <code>approve</code> return values not checked &#x26; unsafe</a> <em>Submitted by cmichel, also found by defsec and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/238\">[L-30] Missing Overflow Protection On the DeployedCapital</a> <em>Submitted by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/18\">[L-31] Deprecated Function Usage</a> <em>Submitted by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/259\">[L-32] Remove liquidity never ends up with left-over LP tokens</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/253\">[L-33] <code>splitReinvest</code> does not provide liquidity at optimal ratio</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/246\">[L-34] <code>totalDeclaredReward >= totalReleasedReward</code> not true in <code>AbstractRewardMine</code></a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/320\">[L-35] Missing <code>maltDataLab.trackReserveRatio()</code> in some cases after <code>swingTrader.sellMalt()</code></a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/21\">[L-36] SafeMath Not Used Nearly At All In MovingAverage.sol</a> <em>Submitted by jayjonah8</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/9\">[L-37] Should include non-existing contract check</a> <em>Submitted by jayjonah8</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/112\">[L-38] reassignGlobalAdmin() Have No Transfer Ownership Pattern</a> <em>Submitted by Meta0xNull</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/292\">[L-39] The value of <code>reward</code> parameter of the <code>ProvideReinvest</code> event can be wrong</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/192\">[L-40] Max value of upperStabilityThreshold and lowerStabilityThreshold not checked</a> <em>Submitted by gpersoon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/194\">[L-41] Adapt count in setAuctionAverageLookback?</a> <em>Submitted by gpersoon, also found by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/358\">[L-42] Unbounded loops</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/305\">[L-43] Users may lose a small portion of promised returns due to precision loss</a> <em>Submitted by WatchPug</em></li>\n</ul>\n<h1 id=\"non-critical-findings-25\" style=\"position:relative;\"><a href=\"#non-critical-findings-25\" aria-label=\"non critical findings 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Findings (25)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/157\">[N-01] Unused imports</a> <em>Submitted by robee, also found by defsec, Meta0xNull, WatchPug, and xYrYuYx</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/242\">[N-02] Implementations should inherit their interface</a> <em>Submitted by WatchPug, also found by xYrYuYx</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/200\">[N-03] deployedCapital variable is internal</a> <em>Submitted by xYrYuYx</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/31\">[N-04] Index address of events for better filtering</a> <em>Submitted by tabish</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/30\">[N-05] Use bps uniformly</a> <em>Submitted by tabish</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/185\">[N-06] Outdated Solidity Version Provides No Protections Against Arithmetic Underflows And Overflows</a> <em>Submitted by leastwood, also found by 0x0x0x, BouSalman, hyh, sabtikw, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/348\">[N-07] Create2Deployer</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/343\">[N-08] Inaccurate revert messages</a> <em>Submitted by pauliax, also found by 0x0x0x, harleythedog, robee, and ScopeLift</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/183\">[N-09] <code>setupParticipant</code> function should be internal</a> <em>Submitted by nathaniel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/315\">[N-10] Outdated versions of OpenZeppelin library</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/302\">[N-11] Misleading variable names</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/286\">[N-12] Misleading error message</a> <em>Submitted by WatchPug, also found by gpersoon and ScopeLift</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/276\">[N-13] Race condition on ERC20 approval</a> <em>Submitted by WatchPug, also found by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/265\">[N-14] Code Style: private/internal function names should be prefixed with <code>_</code></a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/98\">[N-15] No message in require statements.</a> <em>Submitted by BouSalman</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/97\">[N-16] functions visibility on contract AuctionEscapeHatch</a> <em>Submitted by BouSalman</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/91\">[N-17] functions visibility on contract Timelock.sol</a> <em>Submitted by BouSalman</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/69\">[N-18] Unused event or missed emit on SetAnnualYield()</a> <em>Submitted by BouSalman</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/79\">[N-19] Open TODOs</a> <em>Submitted by ye0lde, also found by Meta0xNull, pauliax, and robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/58\">[N-20]  Missing events for admin only functions that change critical parameters</a> <em>Submitted by defsec, also found by 0x0x0x, harleythedog, sabtikw, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/187\">[N-21] governor or timelock</a> <em>Submitted by gpersoon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/258\">[N-22] Wrong comment in <code>removeLiquidity</code></a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/249\">[N-23] Initial <code>SetTransferService</code> event not emitted</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/290\">[N-24] Permissions.sol#_swapRole is named wrongly</a> <em>Submitted by 0x0x0x</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/230\">[N-25] <code>permit</code> Double Emits An <code>Approval</code> Event</a> <em>Submitted by leastwood</em></li>\n</ul>\n<h1 id=\"gas-optimizations-75\" style=\"position:relative;\"><a href=\"#gas-optimizations-75\" aria-label=\"gas optimizations 75 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations (75)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/317\">[G-01] Use short reason strings can save gas</a> <em>Submitted by WatchPug, also found by GiveMeTestEther, Meta0xNull, robee, and ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/106\">[G-02] Cache array length in <code>for</code> loops</a> <em>Submitted by pmerkleplant, also found by 0x0x0x, GiveMeTestEther, pauliax, robee, WatchPug, and ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/89\">[G-03]  Cache Reference To State Variable “currentAuctionID” in _checkAuctionFinalization (Auction.sol)</a> <em>Submitted by ye0lde, also found by harleythedog</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/80\">[G-04] Assignment Of Variables To Default </a> <em>Submitted by ye0lde, also found by 0x0x0x, GiveMeTestEther, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/161\">[G-05] Storage double reading. Could save SLOAD</a> <em>Submitted by robee, also found by GiveMeTestEther, hyh, WatchPug, and ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/77\">[G-06] Underutilized Named Returns</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/76\">[G-07] Unused Named Returns</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/382\">[G-08]  Unnecessary intermediate variables (MovingAverage.sol)</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/271\">[G-09] For uint <code>> 0</code> can be replaced with <code>!= 0</code> for gas optimisation</a> <em>Submitted by 0x0x0x, also found by defsec, pmerkleplant, and ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/137\">[G-10] Unneeded variables (Auction.sol, StabilizerNode.sol)</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/208\">[G-11] Reduce external calls</a> <em>Submitted by xYrYuYx</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/205\">[G-12] decimals return of costBasis is not used.</a> <em>Submitted by xYrYuYx</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/309\">[G-13] Checking <code>uint256</code> variables <code>>= 0</code> is redundant</a> <em>Submitted by WatchPug, also found by 0x0x0x, gzeon, pauliax, and xYrYuYx</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/371\">[G-14] Cache decimals</a> <em>Submitted by pauliax, also found by hyh and xYrYuYx</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/199\">[G-15] In TransactionService, store index of source to avoid loop when removing verifier</a> <em>Submitted by xYrYuYx</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/163\">[G-16] Public functions to external</a> <em>Submitted by robee, also found by 0x0x0x and xYrYuYx</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/38\">[G-17] Storage Optimization</a> <em>Submitted by 0x1f8b, also found by gzeon, robee, and tabish</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/45\">[G-18] initialized storage variables are set again in the initializer function </a> <em>Submitted by sabtikw</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/158\">[G-19] Unused declared local variables</a> <em>Submitted by robee, also found by Koustre</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/379\">[G-20] Can remove treasuryRewardCut from ForfeitHandler.sol</a> <em>Submitted by harleythedog, also found by pmerkleplant</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/101\">[G-21] Don’t try bonding zero liquidity in <code>RewardReinvestor</code></a> <em>Submitted by pmerkleplant</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/369\">[G-22] (10000 - thresholdBps) can be pre-calculated</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/307\">[G-23] Only use <code>SafeMath</code> when necessary can save gas</a> <em>Submitted by WatchPug, also found by pauliax and ScopeLift</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/108\">[G-24] Redundant require statements in <code>Auction:purchaseArbitrageTokens</code></a> <em>Submitted by loop, also found by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/364\">[G-25] ERC20 import</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/214\">[G-26] Timelock reuse function argument as argument for the event emit</a> <em>Submitted by GiveMeTestEther, also found by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/295\">[G-27] <code>++i</code> is more gas efficient than <code>i++</code></a> <em>Submitted by WatchPug, also found by defsec, jayjonah8, and pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/180\">[G-28] Similar code in <code>getCollateralValueInMalt</code> and <code>totalUsefulCollateral</code> functions </a> <em>Submitted by nathaniel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/178\">[G-29] Duplicated code in <code>unbond</code> and <code>unbondAndBreak</code> functions</a> <em>Submitted by nathaniel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/49\">[G-30] Auction.userClaimableArbTokens nonzero auction.finalPrice check is redundant</a> <em>Submitted by hyh, also found by nathaniel and shenwilly</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/316\">[G-31] Redundant checks</a> <em>Submitted by WatchPug, also found by loop</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/73\">[G-32] SwingTrader.costBasis function should have internal version that uses Malt balance from sellMalt</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/72\">[G-33] SwingTrader: sellMalt and costBasis functions can be simplified</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/67\">[G-34] Auction.userClaimableArbTokens amountOut calculations can be simplified</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/50\">[G-35] Auction.userClaimableArbTokens claimablePerc calculations can be simplified</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/377\">[G-36] Unncessary statement in UniswapHandler.sol removeBuyer</a> <em>Submitted by harleythedog</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/2\">[G-37] Invalid equation check on <code>require</code></a> <em>Submitted by hagrid</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/385\">[G-38] Gas optimization: Unnecessary return string</a> <em>Submitted by gzeon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/289\">[G-39] Custom size uint is not more efficient than uint256</a> <em>Submitted by 0x0x0x, also found by cmichel and defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/310\">[G-40] Checking if <code>lpProfitCut > 0</code> can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/308\">[G-41] <code>MovingAverage.sol#_getFirstSample()</code> Implementation can be simpler and save some gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/131\">[G-42] AbstractRewardMine._handleStakePadding logic cases can be separated and function simplified</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/128\">[G-43]  AbstractRewardMine._handleStakePadding calls totalDeclaredReward and this way balanceOf function twice</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/114\">[G-44] AbstractRewardMine.getRewardOwnershipFraction shouldn’t be used internally</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/306\">[G-45] <code>AuctionBurnReserveSkew.sol#getRealBurnBudget()</code> Implementation can be simpler and save some gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/304\">[G-46] Returning the named returns is redundant</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/301\">[G-47] <code>AuctionBurnReserveSkew.sol#getPegDeltaFrequency()</code> Implementation can be simpler and save some gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/300\">[G-48] Cache external call results can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/296\">[G-49] Unnecessary internal function calls</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/287\">[G-50] Unused storage variables</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/280\">[G-51] Use immutable variable can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/273\">[G-52] <code>uint64(block.timestamp % 2**64)</code> can be simpler and save some gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/269\">[G-53] <code>MovingAverage.sol</code> Use inline expression can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/5\">[G-54] Unnecessary event fields</a> <em>Submitted by TomFrench</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/339\">[G-55] RewardReinvestor - safeTransfer used unnecessarily on Malt token</a> <em>Submitted by ScopeLift</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/331\">[G-56] Various contracts - remove unused function parameters to save gas </a> <em>Submitted by ScopeLift</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/330\">[G-57] Various contracts - stricter function mutability for gas savings</a> <em>Submitted by ScopeLift</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/326\">[G-58] AuctionBurnReserveSkew - remove <code>for</code> loop from initializer</a> <em>Submitted by ScopeLift</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/212\">[G-59] MovingAverage:getValueWithLookback move sampleDiff  to save gas</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/117\">[G-75] removeVerifier() Repeat SLOAD During Loop Is Waste of Gas</a> <em>Submitted by Meta0xNull</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/210\">[G-60] MovingAverage:getValue move the declaration/initialization of sampleDiff to save gas in the case of an early return</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/116\">[G-74] Avoiding Initialization of Loop Index If It Is 0</a> <em>Submitted by Meta0xNull</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/209\">[G-61] MovingAverage:initialize reuse argument variable instead storage variable in the loop condition</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/153\">[G-62] AuctionBurnReserveSkew:addAbovePegObservation gas optimization</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/152\">[G-63] AuctionBurnReserveSkew:getRealBurnBudget no underflow check needed</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/151\">[G-64] Auction:amendAccountParticipation no underflow check needed</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/149\">[G-65] Auction:claimArbitrage no underflow checks needed</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/147\">[G-66] Auction:purchaseArbitrageTokens gas optimization</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/144\">[G-67] RewardThrottle:handleReward gas optimizations</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/143\">[G-68] RewardDistributor:decrementRewards no underflow check needed</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/142\">[G-69] RewardDistributor:_incrementFocalPoint() save storage read</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/140\">[G-70] RewardDistributor:_forfeit no underflow check needed</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/288\">[G-71] Dont calculate progressionBps, when not needed</a> <em>Submitted by 0x0x0x</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/284\">[G-72] AbstractRewardMine.sol#_removeFromStakePadding can be implemented more efficiently</a> <em>Submitted by 0x0x0x</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-11-malt-findings/issues/164\">[G-73] State variables that could be set immutable</a> <em>Submitted by robee, also found by hyh</em></li>\n</ul>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-5\">High Risk Findings (5)</a></p>\n<ul>\n<li><a href=\"#h-01-timelock-can-be-bypassed\">[H-01] Timelock can be bypassed</a></li>\n<li><a href=\"#h-02-unable-to-remove-liquidity-in-recovery-mode\">[H-02] Unable to remove liquidity in Recovery Mode</a></li>\n<li><a href=\"#h-03-getauctioncore-function-returns-wrong-values-out-of-order\">[H-03] getAuctionCore function returns wrong values out of order</a></li>\n<li><a href=\"#h-04-auctionburnreserveskewgetpegdeltafrequency-wrong-implementation-can-result-in-an-improper-amount-of-excess-liquidity-extension-balance-to-be-used-at-the-end-of-an-auction-\">[H-04] <code>AuctionBurnReserveSkew.getPegDeltaFrequency()</code> Wrong implementation can result in an improper amount of excess Liquidity Extension balance to be used at the end of an auction </a></li>\n<li><a href=\"#h-05-auctioneschapehatchsolexitearly-updates-state-of-the-auction-wrongly\">[H-05] AuctionEschapeHatch.sol#exitEarly updates state of the auction wrongly</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-30\">Medium Risk Findings (30)</a></p>\n<ul>\n<li><a href=\"#m-01-timelock_role-has-absolute-power-to-withdraw-all-fund-may-raise-red-flags-for-investors\">[M-01] TIMELOCK_ROLE Has Absolute Power to Withdraw All FUND May Raise Red Flags for Investors</a></li>\n<li><a href=\"#m-02-frontrunning-in-uniswaphandler-calls-to-uniswapv2router\">[M-02] Frontrunning in UniswapHandler calls to UniswapV2Router</a></li>\n<li><a href=\"#m-03-abstractrewardminesolsetrewardtoken-is-dangerous\">[M-03] AbstractRewardMine.sol#setRewardToken is dangerous</a></li>\n<li><a href=\"#m-04-the-power-structure-is-too-centralized-and-protocol-may-break-if-anything-happen-to-admin\">[M-04] The Power Structure is Too Centralized And Protocol May Break If Anything Happen to Admin</a></li>\n<li><a href=\"#m-05-_notsameblock-can-be-circumvented-in-bondtoaccount-\">[M-05] _notSameBlock() can be circumvented in bondToAccount() </a></li>\n<li><a href=\"#m-06-abstractrewardmine---re-entrancy-attack-during-withdrawal\">[M-06] AbstractRewardMine - Re-entrancy attack during withdrawal</a></li>\n<li><a href=\"#m-07-movingaveragesetsamplememory-may-broke-movingaverage-making-the-value-of-exchangerate-in-stabilizernodestabilize-being-extremely-wrong\">[M-07] <code>MovingAverage.setSampleMemory()</code> may broke MovingAverage, making the value of <code>exchangeRate</code> in <code>StabilizerNode.stabilize()</code> being extremely wrong</a></li>\n<li><a href=\"#m-08-_getfirstsample-returns-wrong-sample-if-count--samplememory\">[M-08] <code>_getFirstSample</code> returns wrong sample if count &#x3C; sampleMemory</a></li>\n<li><a href=\"#m-09-uniswaphandlermaltmarketprice-returns-wrong-decimals\">[M-09] <code>UniswapHandler.maltMarketPrice</code> returns wrong decimals</a></li>\n<li><a href=\"#m-10-auctionparticipantsol-setreplenishingindex-mistake-could-freeze-unclaimed-tokens\">[M-10] AuctionParticipant.sol: <code>setReplenishingIndex</code> mistake could freeze unclaimed tokens</a></li>\n<li><a href=\"#m-11-no-max-for-advanceincentive\">[M-11] No max for advanceIncentive</a></li>\n<li><a href=\"#m-12-permissions---return-values-not-checked-when-sending-eth\">[M-12] Permissions - return values not checked when sending ETH</a></li>\n<li><a href=\"#m-13-reducing-the-epoch-length-results-in-leaking-value-from-advancement-incentives\">[M-13] Reducing the epoch length results in leaking value from advancement incentives</a></li>\n<li><a href=\"#m-14-wrong-permissions-on-reassignglobaladmin\">[M-14] Wrong permissions on <code>reassignGlobalAdmin</code></a></li>\n<li><a href=\"#m-15-bonding-doesnt-work-with-fee-on-transfer-tokens\">[M-15] Bonding doesn’t work with fee-on transfer tokens</a></li>\n<li><a href=\"#m-16-theft-of-system-profit\">[M-16] theft of system profit</a></li>\n<li><a href=\"#m-17-auction-collateraltoken-wont-work-if-token-is-fee-on-transfer-token-\">[M-17] Auction collateralToken won’t work if token is fee-on-transfer token </a></li>\n<li><a href=\"#m-18-auctionparticipantsol-purchasearbitragetokens-should-not-push-duplicate-auctions\">[M-18] AuctionParticipant.sol: <code>purchaseArbitrageTokens</code> should not push duplicate auctions</a></li>\n<li><a href=\"#m-19-miningservicesetbonding-should-use-bonding-role-instead-of-reinvestor-one\">[M-19] MiningService.setBonding should use BONDING role instead of REINVESTOR one</a></li>\n<li><a href=\"#m-20-users-can-contribute-to-an-auction-without-directly-committing-collateral-tokens\">[M-20] Users Can Contribute To An Auction Without Directly Committing Collateral Tokens</a></li>\n<li><a href=\"#m-21-stabilizernode-will-mint-an-incentive-for-triggering-an-auction-even-if-an-auction-exists-already\">[M-21] <code>StabilizerNode</code> Will Mint An Incentive For Triggering An Auction Even If An Auction Exists Already</a></li>\n<li><a href=\"#m-22-_calculatemaltrequiredforexit-uses-spot-price-to-calculate-malt-quantity-in-exitearly\">[M-22] <code>_calculateMaltRequiredForExit</code> Uses Spot Price To Calculate Malt Quantity In <code>exitEarly</code></a></li>\n<li><a href=\"#m-23-addliquidity-does-not-reset-approval-if-not-all-tokens-were-added-to-liquidity-pool\">[M-23] <code>addLiquidity</code> Does Not Reset Approval If Not All Tokens Were Added To Liquidity Pool</a></li>\n<li><a href=\"#m-24-_distributerewards-does-not-reset-approval-if-not-all-tokens-were-allocated\">[M-24] <code>_distributeRewards</code> Does Not Reset Approval If Not All Tokens Were Allocated</a></li>\n<li><a href=\"#m-25-amm-pool-can-be-drained-using-a-flashloan-and-calling-stabilize\">[M-25] AMM pool can be drained using a flashloan and calling <code>stabilize</code></a></li>\n<li><a href=\"#m-26-dutch-auction-can-be-manipulated\">[M-26] Dutch auction can be manipulated</a></li>\n<li><a href=\"#m-27-slippage-checks-when-adding-liquidity-are-too-strict\">[M-27] Slippage checks when adding liquidity are too strict</a></li>\n<li><a href=\"#m-28-bondingsol-_unbondandbreak-does-not-account-for-edge-case-where-no-tokens-are-returned\">[M-28] Bonding.sol _unbondAndBreak does not account for edge case where no tokens are returned</a></li>\n<li><a href=\"#m-29-user-can-bypass-recovery-mode-via-uniswaphandler-to-buy-malt-\">[M-29] User can bypass Recovery Mode via UniswapHandler to buy Malt </a></li>\n<li><a href=\"#m-30-malt-protocol-uses-stale-results-from-maltdatalab-which-can-be-abused-by-users\">[M-30] Malt Protocol Uses Stale Results From <code>MaltDataLab</code> Which Can Be Abused By Users</a></li>\n</ul>\n</li>\n<li><a href=\"#low-risk-findings-43\">Low Risk Findings (43)</a></li>\n<li><a href=\"#non-critical-findings-25\">Non-Critical Findings (25)</a></li>\n<li><a href=\"#gas-optimizations-75\">Gas Optimizations (75)</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the code contest outlined in this document, C4 conducted an analysis of Malt Finance contest smart contract system written in Solidity. The code contest took place between November 25—December 1 2021.\n\n## Wardens\n\n35 Wardens contributed reports to the Malt Finance contest:\n\n1. WatchPug ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n1. [gzeon](https://twitter.com/gzeon)\n1. [leastwood](https://twitter.com/liam_eastwood13)\n1. [cmichel](https://twitter.com/cmichelio)\n1. harleythedog\n1. 0x0x0x\n1. jayjonah8\n1. [Meta0xNull](https://twitter.com/Meta0xNull)\n1. hyh\n1. [pauliax](https://twitter.com/SolidityDev)\n1. ScopeLift ([wildmolasses](https://github.com/wildmolasses), [bendi](https://twitter.com/BenDiFrancesco), [mds1](https://twitter.com/msolomon44/))\n1. [defsec](https://twitter.com/defsec_)\n1. [gpersoon](https://twitter.com/gpersoon)\n1. TomFrench\n1. stonesandtrees\n1. [xYrYuYx](https://twitter.com/xYrYuYx)\n1. [GiveMeTestEther](https://twitter.com/GiveMeTestEther)\n1. 0x1f8b\n1. [ye0lde](https://twitter.com/_ye0lde)\n1. [nathaniel](https://twitter.com/n4th4n131?t&#x3D;ZXGbALC3q6JMMoolZddgHg&amp;s&#x3D;09)\n1. robee\n1. [pmerkleplant](https://twitter.com/merkleplant_eth)\n1. 0xwags\n1. Koustre\n1. [danb](https://twitter.com/danbinnun)\n1. [BouSalman](https://twitter.com/BouSalman)\n1. [sabtikw](https://twitter.com/sabtikw)\n1. hagrid\n1. [tabish](https://twitter.com/tabishjshaikh)\n1. [loop](https://twitter.com/loop_225)\n1. thank_you\n1. [shenwilly](https://twitter.com/shenwilly_)\n\nThis contest was judged by [Alex the Entreprenerd](https://twitter.com/GalloDaSballo).\n\nFinal report assembled by [CloudEllie](https://twitter.com/CloudEllie1) and [itsmetechjay](https://twitter.com/itsmetechjay).\n\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 78 unique vulnerabilities and 178 total findings. All of the issues presented here are linked back to their original finding.\n\nOf these vulnerabilities, 5 received a risk rating in the category of HIGH severity, 30 received a risk rating in the category of MEDIUM severity, and 43 received a risk rating in the category of LOW severity.\n\nC4 analysis also identified 25 non-critical recommendations and 75 gas optimizations.\n\n# Scope\n\nThe code under review can be found within the [C4 Malt Finance contest repository](https://github.com/code-423n4/2021-11-malt), and is composed of 24 smart contracts written in the Solidity programming language and includes 4,452 source lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code423n4.com).\n\n# High Risk Findings (5)\n## [[H-01] Timelock can be bypassed](https://github.com/code-423n4/2021-11-malt-findings/issues/263)\n_Submitted by WatchPug, also found by 0x0x0x and gzeon_\n\nThe purpose of a Timelock contract is to put a limit on the privileges of the `governor`, by forcing a two step process with a preset delay time.\n\nHowever, we found that the current implementation actually won't serve that purpose as it allows the `governor` to execute any transactions without any constraints.\n\nTo do that, the current governor can call `Timelock#setGovernor(address _governor)` and set a new `governor` effective immediately.\n\nAnd the new `governor` can then call `Timelock#setDelay()` and change the delay to `0`, also effective immediately.\n\nThe new `governor` can now use all the privileges without a delay, including granting minter role to any address and mint unlimited amount of MALT.\n\nIn conclusion, a Timelock contract is supposed to guard the protocol from lost private key or malicious actions. The current implementation won't fulfill that mission.\n\n<https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Timelock.sol#L98-L105>\n\n```solidity\n  function setGovernor(address _governor)\n    public\n    onlyRole(GOVERNOR_ROLE, \"Must have timelock role\")\n  {\n    _swapRole(_governor, governor, GOVERNOR_ROLE);\n    governor = _governor;\n    emit NewGovernor(_governor);\n  }\n```\n\n<https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Timelock.sol#L66-L77>\n\n```solidity\n  function setDelay(uint256 _delay)\n    public\n    onlyRole(GOVERNOR_ROLE, \"Must have timelock role\")\n  {\n    require(\n      _delay >= 0 && _delay < gracePeriod,\n      \"Timelock::setDelay: Delay must not be greater equal to zero and less than gracePeriod\"\n    );\n    delay = _delay;\n\n    emit NewDelay(delay);\n  }\n```\n\n#### Recommendation\n\nConsider making `setGovernor` and `setDelay` only callable from the Timelock contract itself.\n\nSpecificaly, changing from `onlyRole(GOVERNOR_ROLE, \"Must have timelock role\")` to `require(msg.sender == address(this), \"...\")`.\n\nAlso, consider changing `_adminSetup(_admin)` in `Timelock#initialize()` to `_adminSetup(address(this))`, so that all roles are managed by the timelock itself as well.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/263)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/263#issuecomment-1008067115):**\n > The warden has identified an exploit that allows to sidestep the delay for the timelock, effectively bypassing all of the timelock's security guarantees. Because of the gravity of this, I agree with the high risk severity.\n> \n> Mitigation can be achieved by ensuring that all operations run under a time delay\n\n\n\n## [[H-02] Unable to remove liquidity in Recovery Mode](https://github.com/code-423n4/2021-11-malt-findings/issues/323)\n_Submitted by gzeon_\n\nAccording to <https://github.com/code-423n4/2021-11-malt#high-level-overview-of-the-malt-protocol>\n\n> When the Malt price TWAP drops below a specified threshold (eg 2% below peg) then the protocol will revert any transaction that tries to remove Malt from the AMM pool (ie buying Malt or removing liquidity). Users wanting to remove liquidity can still do so via the UniswapHandler contract that is whitelisted in recovery mode.\n\nHowever, in <https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/DexHandlers/UniswapHandler.sol#L236>\nliquidity removed is directly sent to msg.sender, which would revert if it is not whitelisted\n<https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/PoolTransferVerification.sol#L53>\n\n#### Recommended Mitigation Steps\n\nLiquidity should be removed to UniswapHandler contract, then the proceed is sent to msg.sender\n\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/323)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/323#issuecomment-1010448871):**\n > I believe this finding to be correct, because of the whitelisting on `verifyTransfer`, during recovery mode the removal of liquidity from UniSwapV2Pair will perform safeTransfers: https://github.com/Uniswap/v2-core/blob/4dd59067c76dea4a0e8e4bfdda41877a6b16dedc/contracts/UniswapV2Pair.sol#L148\n> \n> This means that the `_beforeTokenTransfer` will be called which eventually will call `verifyTransfer` which, if the price is below peg will revert.\n> \n> Transfering the funds to the whitelisted contract should avoid this issue.\n> \n> \n> I'd like to remind the sponsor that anyone could deploy similar swapping contracts (or different ones such as curve), so if a person is motivate enough, all the whitelisting could technically be sidestepped.\n> \n> That said, given the condition of LPing on Uniswap, the check and the current system would make it impossible to withdraw funds.\n> \n> Because this does indeed compromises the availability of funds (effectively requiring the admin to unstock them manually via Whitelisting each user), I agree with High Severity\n\n\n\n## [[H-03] getAuctionCore function returns wrong values out of order](https://github.com/code-423n4/2021-11-malt-findings/issues/63)\n_Submitted by jayjonah8_\n\n\n\n#### Impact\n\nIn the `AuctionEscapeHatch.sol` file both `earlyExitReturn()` and `\\_calculateMaltRequiredForExit` call the `getAuctionCore()` function which has 10 possible return values most of which are not used.  It gets the wrong value back for the \"active\"  variable since it's the 10th argument but both functions have it as the 9th return value where \"preAuctionReserveRatio\" should be because of one missing comma.  This is serious because these both are functions which deal with allowing a user to exit their arbitrage token position early.  This can result in a loss of user funds.\n\n#### Proof of Concept\n\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/AuctionEscapeHatch.sol#L100>\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/AuctionEscapeHatch.sol#L174>\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L527>\n\n#### Tools Used\n\nManual code review\n\n#### Recommended Mitigation Steps\n\nIn `AuctionEscapeHatch.sol` change the following in `\\_calculateMaltRequiredForExit()` and earlyExitReturn() functions:\n\nFrom:\n\n(,,,,,\nuint256 pegPrice,\n,\nuint256 auctionEndTime,\nbool active\n) = auction.getAuctionCore(\\_auctionId);\n\nTo:\n\n(,,,,,\nuint256 pegPrice,\n,\nuint256 auctionEndTime,\n,\nbool active\n) = auction.getAuctionCore(\\_auctionId);\n\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/63)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/63#issuecomment-1019278807):**\n > The warden identified a mistake in programming where the code would use the wrong returned value.\n> Because of this, the entire protocol functionality can be compromised.\n> As such I agree with High Severity\n\n\n\n## [[H-04] `AuctionBurnReserveSkew.getPegDeltaFrequency()` Wrong implementation can result in an improper amount of excess Liquidity Extension balance to be used at the end of an auction ](https://github.com/code-423n4/2021-11-malt-findings/issues/294)\n_Submitted by WatchPug_\n\n<https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/AuctionBurnReserveSkew.sol#L116-L132>\n\n```solidity\n  function getPegDeltaFrequency() public view returns (uint256) {\n    uint256 initialIndex = 0;\n    uint256 index;\n\n    if (count > auctionAverageLookback) {\n      initialIndex = count - auctionAverageLookback;\n    }\n\n    uint256 total = 0;\n\n    for (uint256 i = initialIndex; i < count; ++i) {\n      index = _getIndexOfObservation(i);\n      total = total + pegObservations[index];\n    }\n\n    return total * 10000 / auctionAverageLookback;\n  }\n```\n\nWhen `count < auctionAverageLookback`, at L131, it should be `return total * 10000 / count;`. The current implementation will return a smaller value than expected.\n\nThe result of `getPegDeltaFrequency()` will be used for calculating `realBurnBudget` for auctions. With the result of `getPegDeltaFrequency()` being inaccurate, can result in an improper amount of excess Liquidity Extension balance to be used at the end of an auction.\n\n**[0xScotch (sponsor) confirmed and disagreed with severity](https://github.com/code-423n4/2021-11-malt-findings/issues/294):**\n > I actually think this should be higher severity. This bug could manifest in liquidity extension being depleted to zero which could have catastrophic consequences downstream.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/294#issuecomment-1019392232):**\n > Agree with the finding, this is an incorrect logic in the protocol, which can limit it's functionality and as the sponsor says: `could have catastrophic consequences downstream` as such I'll increase the severity to high.\n> \n> Mitigation seems to be straightforward\n\n\n## [[H-05] AuctionEschapeHatch.sol#exitEarly updates state of the auction wrongly](https://github.com/code-423n4/2021-11-malt-findings/issues/268)\n_Submitted by 0x0x0x_\n\n`AuctionEschapeHatch.sol#exitEarly` takes as input `amount` to represent how much of the\n\nWhen the user exits an auction with profit, to apply the profit penalty less `maltQuantity` is liquidated compared to how much malt token the liquidated amount corresponds to. The problem is `auction.amendAccountParticipation()` simply subtracts the malt quantity with penalty and full `amount` from users auction stats. This causes a major problem, since in `_calculateMaltRequiredForExit` those values are used for calculation by calculating maltQuantity as follow:\n\n`uint256 maltQuantity = userMaltPurchased.mul(amount).div(userCommitment);`\n\nThe ratio of `userMaltPurchased / userCommitment` gets higher after each profit taking (since penalty is applied to substracted `maltQuantity` from `userMaltPurchased`), by doing so a user can earn more than it should. Since after each profit taking users commitment corresponds to proportionally more malt, the user can even reduce profit penalties by dividing `exitEarly` calls in several calls.\n\nIn other words, the ratio of `userMaltPurchased / userCommitment` gets higher after each profit taking and user can claim more malt with less commitment. Furthermore after all `userMaltPurchased` is claimed the user can have `userCommitment` left over, which can be used to `claimArbitrage`, when possible.\n\n#### Mitigation Step\n\nMake sure which values are used for what and update values which doesn't create problems like this. Rethink about how to track values of an auction correctly.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/268)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/268#issuecomment-1020736987):**\n > The warden has identified an exploit that allows early withdrawers to gain more rewards than expected.\n> Anytime \"points\" and rewards need to be earned over time, it's ideal to accrue points in order to distribute them (see how Compound or AAVE tokens work)\n> Because the warden showed a flow in the accounting logic for the protocol, I agree with high severity.\n\n\n\n \n# Medium Risk Findings (30)\n## [[M-01] TIMELOCK_ROLE Has Absolute Power to Withdraw All FUND May Raise Red Flags for Investors](https://github.com/code-423n4/2021-11-malt-findings/issues/125)\n_Submitted by Meta0xNull_\n\n\n`TIMELOCK_ROLE` Can Withdraw All FUND from the Contracts via `emergencyWithdrawGAS(), emergencyWithdraw(), partialWithdrawGAS(), partialWithdraw()`.\n\nWhile I believe developer have good intention to use these functions. It often associate with Rug Pull by developer in the eyes of investors because Rug Pull is not uncommon in Defi. Investors lose all their hard earn money.\n\nRead More: \\$10.8M Stolen, Developers Implicated in Alleged Smart Contract 'Rug Pull'\n<https://www.coindesk.com/tech/2020/12/02/108m-stolen-developers-implicated-in-alleged-smart-contract-rug-pull/>\n\nRead More: The Rise of Cryptocurrency Exit Scams and DeFi Rug Pulls\n<https://www.cylynx.io/blog/the-rise-of-cryptocurrency-exit-scams-and-defi-rug-pulls/>\n\n#### Proof of Concept\n\n<https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Permissions.sol#L80-L109>\n\n#### Recommended Mitigation Steps\n\n1.  Pause the Contract and Disable All Functions when Bad Thing Happen rather than Withdraw All Fund to a random address.\n2.  If Withdraw Fund can't avoid, a Multi Sig ETH Address should be hardcoded into the contract to ensure the fund move to a safe wallet.\n\n\n**[0xScotch (sponsor) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/125#issuecomment-988785042):**\n > Duplicate of #263\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/125#issuecomment-1008068213):**\n > This is not a duplicate of #263, where 263 talks about sidestepping the delay of the timelock, this finding talks about the high degree of power that the TIMELOCK_ROLE has.\n> \n> This is a typical \"admin privilege\" finding, it's very important to disclose admin privileges to users so that they can make informed decisions\n> \n> In this case the TIMELOCK_ROLE can effectively rug the protocol, however this is contingent on the account that has the role to pull the rug.\n> \n> Because of its reliance on external factors, am downgrading the finding to medium severity\n\n\n\n## [[M-02] Frontrunning in UniswapHandler calls to UniswapV2Router](https://github.com/code-423n4/2021-11-malt-findings/issues/219)\n_Submitted by thank_you, also found by 0x0x0x, cmichel, defsec, harleythedog, hyh, Koustre, leastwood, Meta0xNull, pauliax, pmerkleplant, tabish, WatchPug, and xYrYuYx_\n\n\nUniswapHandler utilizes UniswapV2Router to swap, add liquidity, and remove liquidity with the UniswapV2Pair contract. In order to utilize these functionalities, UniswapHandler must call various UniswapV2Router methods.\n\n*   addLiquidity\n*   removeLiquidity\n*   swapExactTokensForTokens (swaps for both DAI and Malt)\n\nIn all three methods, UniswapV2Router requires the callee to provide input arguments that define how much the amount out minimum UniswapHandler will allow for a trade. This argument is designed to prevent slippage and more importantly, sandwich attacks.\n\nUniswapHandler correctly handles price slippage when calling [addLiquidity](https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L201). However, that is not the case for [removeLiquidity](https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L230) and swapExactTokensForTokens [here](https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L148) and [here](https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L173). For both methods, 0 is passed in as the amount out minimum allowed for a trade. This allows for anyone watching the mempool to sandwich attack UniswapHandler (or any contract that calls UniswapHandler) in such a way that allows the hacker to profit off of a guaranteed trade.\n\nHow does this work? Let's assume UniswapHandler makes a call to [UniswapV2Router#swapExactTokensForTokens](https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L148) to trade DAI for Malt. Any hacker who watches the mempool and sees this transaction can immediately buy as much Malt as they want. This raises the price of Malt. Since UniswapHandler is willing to accept any amount out minimum (the number is set to [zero](https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L150)), then the UniswapHandler will always trade DAI for Malt. This second transaction raises the price of Malt even further. Finally, the hacker trades their Malt for DAI, receiving a profit due to the artificially inflated price of Malt from the sandwich attack.\n\nIt's important to note that anyone has access to the UniswapV2Router contract. There are no known ACL controls on UniswapV2Router. This sandwich attack can impact even the `buyMalt` function.\n\nThe following functions when called are vulnerable to frontrunning attacks:\n\n*   [UniswapHandler#buyMalt](https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L131)\n*   [UniswapHandler#sellMalt](https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L160)\n*   [UniswapHandler#removeLiquidity](https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L221)\n\nAnd by extension the following contract functions since they also call the UniswapHandler function calls:\n\n*   [Bonding#unbondAndBreak](https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Bonding.sol#L114)\n*   [LiquidityExtension#purchaseAndBurn](https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/LiquidityExtension.sol#L117)\n*   [RewardReinvestor#splitReinvest](https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/RewardReinvestor.sol#L78)\n*   [StabilizerNode#stabilize](https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L145)\n*   [SwingTrader#buyMalt](https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/SwingTrader.sol#L50)\n\n#### Proof of Concept\n\nRefer to the impact section for affected code and links to the appropriate LoC.\n\n#### Recommended Mitigation Steps\n\nThe UniswapV2Router and UniswapV2Pair contract should allow only the UniswapHandler contract to call either contract. In addition, price slippage checks should be implemented whenever removing liquidity or swapping tokens. This ensures that a frontrunning attack can't occur.\n\n#### Anything Else We Should Know\n\nI wish I had more time to work on this bug but unfortunately I have several current clients who require significant time from me. I'm happy to pursue this beyond the initial submission, in particular building a concrete PoC. I think the most important takeaway from this bug find is that anyone can purchase Malt at any time and anyone can manipulate the Malt reserve. This in turn impacts other functionalities that rely on the Malt reserve to make price/token calculations such as exiting an auction early or reinvesting rewards.\n\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/219)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/219#issuecomment-1008433912):**\n > Because transactions sit on the mempool (which is public, hence accessible by anyone), they can be frontrun, because of this swapping protocols (uniswap in this case) offer slippage checks.\n> Setting the slippage checks allows a frontrunner to squeeze the maximum amount of value possible (sometimes the whole amount).\n> \n> Because this applies to a leak of value, I believe medium severity to be correct\n\n\n\n## [[M-03] AbstractRewardMine.sol#setRewardToken is dangerous](https://github.com/code-423n4/2021-11-malt-findings/issues/285)\n_Submitted by 0x0x0x, also found by harleythedog and hyh_\n\n\nIn case the reward token is changed, `totalDeclaredReward` will be changed and likely equal to `0`.  Since `_userStakePadding` and `_globalStakePadding` are accumulated, changing the reward token will not reset those values. Thus, it will create problems.\n\n#### Recommendation\n\nI think it would be the best to remove this function.\n\nIf you want to keep it, then it must have an event and it should be used by a timelock contract. Furthermore, it has to be used carefully and the new token should be distributed such that padding variables still make sense.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/285)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/285#issuecomment-1008437864):**\n > Agree with highlighting the Admin Privilege, however because this is contingent on a malicious Admin, I'll downgrade the finding to Medium Severity.\n> \n> Mitigation could be done by ensuring old rewards are sent out, still claimable, or by making the `rewardToken` immutable\n\n\n\n## [[M-04] The Power Structure is Too Centralized And Protocol May Break If Anything Happen to Admin](https://github.com/code-423n4/2021-11-malt-findings/issues/124)\n_Submitted by Meta0xNull_\n\n\nThere are a lot of different roles in Malt Finance to handle different tasks. All these roles only can set by Admin. If anything happen to Admin and he/she no longer available, the protocol will start countdown to the end of life.\n\n#### Proof of Concept\n\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L890-L1013>\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/RewardSystem/RewardDistributor.sol#L291-L345>\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Bonding.sol#L327-L355>\nMany More Sol....\n\n#### Recommended Mitigation Steps\n\n1.  Some tasks don't really need a special role like StabilizerNode. Should allow any community members to run their own StabilizerNode without approval needed.\n2.  Consider transfer Admin to Multisig or DAO.\n\n**[0xScotch (sponsor) disputed](https://github.com/code-423n4/2021-11-malt-findings/issues/124):**\n > This is a known risk that is by design. We will migrate to DAO control of parameters when the protocol matures. \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/124#issuecomment-1008445251):**\n > I respect the wardens work for flagging this up.\n> Because any of these exploits are contingent on the Admin being malicious, I'll downgrade to Medium Severity\n\n\n\n## [[M-05] _notSameBlock() can be circumvented in bondToAccount() ](https://github.com/code-423n4/2021-11-malt-findings/issues/195)\n_Submitted by gpersoon, also found by leastwood and ScopeLift_\n\n\nThe function bondToAccount() of Bonding.sol has a check based on \\_notSameBlock()\n\\_notSameBlock() makes sure the same msg.sender cannot do 2 actions within the same block.\n\nHowever this can be circumvented in this case:\nSuppose you call bondToAccount() via a (custom) smart contract, then the msg.sender will be the address of the smart contract.\nFor a pseudo code proof of concept see below.\n\nI'm not sure what the deeper reason is for the \\_notSameBlock() in bondToAccount().\nBut if it is important then circumventing this check it will pose a risk.\n\n#### Proof of Concept\n\ncall function attack1.attack()\n\n```JS\ncontract attack1 {\n   function attack(address account, uint256 amount) {\n         call attack2.forward(account, amount);\n         call any other function of malt\n  }\n}\n\ncontract attack2 {\n   function forward(address account, uint256 amount) {\n       call bonding.bondToAccount(account, amount); // uses msg.sender of attack2\n   }\n}\n```\n\n<https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/Bonding.sol#L81-L92>\n\n```JS\nfunction bondToAccount(address account, uint256 amount) public {\n    if (msg.sender != offering) {\n         _notSameBlock();\n    }\n    ...\n```\n\n<https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/Permissions.sol#L135-L141>\n\n```JS\nfunction _notSameBlock() internal {\n    require( block.number > lastBlock[_msgSender()],\"Can't carry out actions in the same block\" );\n    lastBlock[_msgSender()] = block.number;\n  }\n```\n\n#### Recommended Mitigation Steps\n\nAdd access controls to the function bondToAccount()\nAn end-user could still call bond()\n\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/195)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/195#issuecomment-1008447039):**\n > `notSameBlock` is effectively being used as the `nonReentrant` modifier, without the same security guarantees, as such, in spite of not having a specific attack vector, because the warden showed how to side step this security feature of the protocol, am going to raise the severity to Medium\n\n\n\n## [[M-06] AbstractRewardMine - Re-entrancy attack during withdrawal](https://github.com/code-423n4/2021-11-malt-findings/issues/333)\n_Submitted by ScopeLift_\n\n\nThe internal `_withdraw` method does not follow the checks-effects-interactions pattern. A malicious token, or one that implemented transfer hooks, could re-enter the public calling function (such as `withdraw()`) before proper internal accounting was completed. Because the `earned` function looks up the `_userWithdrawn` mapping, which is not yet updated when the transfer occurs, it would be possible for a malicious contract to re-enter `_withdraw` repeatedly and drain the pool.\n\n#### Recommended Mitigation Steps\n\nThe internal accounting should be done before the transfer occurs:\n\n```solidity\nfunction _withdraw(address account, uint256 amountReward, address to) internal {\n    _userWithdrawn[account] += amountReward;\n    _globalWithdrawn += amountReward;f\n\n   rewardToken.safeTransfer(to, amountReward);\n\n    emit Withdraw(account, amountReward, to);\n  }\n```\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/333)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/333#issuecomment-1008447954):**\n > The warden identified a re-entrancy vulnerability that, given the right token would allow to drain the entirety of the contract.\n> \n> Tokens with hooks (ERC777 and ERC677) would allow to exploit the contract and drain it in it's entirety.\n> \n> This is a very serious vulnerability.\n> However it can happen exclusively on a malicious or a token with hooks, as such (while I recommend the sponsor to mitigate by following recommendation by the warden), the attack can be completely prevented by using a token without hooks.\n> \n> For that reason I'll rate the finding of medium severity (as it requires external conditions)\n\n\n\n## [[M-07] `MovingAverage.setSampleMemory()` may broke MovingAverage, making the value of `exchangeRate` in `StabilizerNode.stabilize()` being extremely wrong](https://github.com/code-423n4/2021-11-malt-findings/issues/313)\n_Submitted by WatchPug_\n\n\n<https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/MovingAverage.sol#L424-L442>\n\n```solidity\nfunction setSampleMemory(uint256 _sampleMemory)\n  external\n  onlyRole(ADMIN_ROLE, \"Must have admin privs\")\n{\n  require(_sampleMemory > 0, \"Cannot have sample memroy of 0\");\n\n  if (_sampleMemory > sampleMemory) {\n    for (uint i = sampleMemory; i < _sampleMemory; i++) {\n      samples.push();\n    }\n    counter = counter % _sampleMemory;\n  } else {\n    activeSamples = _sampleMemory;\n\n    // TODO handle when list is smaller Tue 21 Sep 2021 22:29:41 BST\n  }\n\n  sampleMemory = _sampleMemory;\n}\n```\n\nIn the current implementation, when `sampleMemory` is updated, the samples index will be malposition, making `getValueWithLookback()` get the wrong samples, so that returns the wrong value.\n\n#### Proof of Concept\n\n*   When initial sampleMemory is `10`\n*   After `movingAverage.update(1e18)` being called for 120 times\n*   The admin calls `movingAverage.setSampleMemory(118)` and set sampleMemory to `118`\n\nThe current `movingAverage.getValueWithLookback(sampleLength * 10)` returns `0.00000203312 e18`, while it's expeceted to be `1e18`\n\nAfter `setSampleMemory()`, `getValueWithLookback()` may also return `0`or revert FullMath: FULLDIV_OVERFLOW at L134.\n\n##### Recommendation\n\nConsider removing `setSampleMemory` function.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/313)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/313#issuecomment-1008462965):**\n > I agree that calling `setSampleMemory` will cause issues, and can cause opportunities to further extract value.\n> However this can be triggered by an admin action.\n> I'll think about the severity, but as of now, because it is contingent on admin privilege, will downgrade to Medium\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/313#issuecomment-1025181213):**\n > I stand by my decision of Medium Severity. While the consequences can be troublesome, they are contingent on the admin breaking / griefing the system\n\n\n\n## [[M-08] `_getFirstSample` returns wrong sample if count < sampleMemory](https://github.com/code-423n4/2021-11-malt-findings/issues/252)\n_Submitted by cmichel_\n\nThe `MovingAverage.sol` contract defines several variables that in the end make the `samples` array act as a ring buffer:\n\n*   `sampleMemory`: The total length (buffer size) of the `samples` array. `samples` is initialized with `sampleMemory` zero observations.\n*   `counter`: The pending sample index (modulo `sampleMemory`)\n\nThe `_getFirstSample` function computes the first sample as `(counter + 1) % sampleMemory` which returns the correct index only *if the ring buffer is full*, i.e., it wraps around. (in the `counter + 1 >= sampleMemory`).\n\nIf the `samples` array does not wrap around yet, the zero index should be returned instead.\n\n#### Impact\n\nReturning `counter + 1` if `counter + 1 < sampleMemory` returns a zero initialized `samples` observation index.\nThis then leads to a wrong computation of the TWAP.\n\n#### Recommended Mitigation Steps\n\nAdd an additional check for `if (counter + 1 < sampleMemory) return 0` in `_getFirstSample`.\n\n**[0xScotch (sponsor) confirmed and disagreed with severity](https://github.com/code-423n4/2021-11-malt-findings/issues/252):**\n > Funds aren't directly at risk. I believe this is medium severity\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/252#issuecomment-1008466725):**\n > Personally am not sure the first sample after wrapping would be `counter + 1` (why not  `counter % sampleMemory`)\n> \n> That said, I do agree that before wrapping, the first item in the array is at the 0 index\n> \n> I agree that the protocol is not behaving properly so I can understand the high severity, that said I also agree with the Sponsor's statement, the worst case would be a leak of value, so Medium severity seems the most appropriate\n\n\n\n## [[M-09] `UniswapHandler.maltMarketPrice` returns wrong decimals](https://github.com/code-423n4/2021-11-malt-findings/issues/255)\n_Submitted by cmichel, also found by gzeon_\n\n\n\nThe `UniswapHandler.maltMarketPrice` function returns a tuple of the `price` and the `decimals` of the price.\nHowever, the returned `decimals` do not match the computed `price` for the `else if (rewardDecimals < maltDecimals)` branch:\n\n```solidity\nelse if (rewardDecimals < maltDecimals) {\n  uint256 diff = maltDecimals - rewardDecimals;\n  price = (rewardReserves.mul(10**diff)).mul(10**rewardDecimals).div(maltReserves);\n  decimals = maltDecimals;\n}\n```\n\nNote that `rewardReserves` are in reward token decimals, `maltReserves` is a malt balance amount (18 decimals).\nThen, the returned amount is in `rewardDecimals + diffDecimals + rewardDecimals - maltDecimals = maltDecimals + rewardDecimals - maltDecimals = rewardDecimals`.\nHowever `decimals = maltDecimals` is wrongly returned.\n\n#### Impact\n\nCallers to this function will receive a price in unexpected decimals and might inflate or deflate the actual amount.\nLuckily, the `AuctionEscapeHatch` decides to completely ignore the returned `decimals` and as all prices are effectively in `rewardDecimals`, even if stated in `maltDecimals`, it currently does not seem to lead to an issue.\n\n#### Recommendation\n\nFix the function by returning `rewardDecimals` instead of `maltDecimals` in the `rewardDecimals < maltDecimals` branch.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/255)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/255#issuecomment-1010461081):**\n > Finding is valid, because the returned value is unused, I agree with the medium severity\n\n\n\n## [[M-10] AuctionParticipant.sol: `setReplenishingIndex` mistake could freeze unclaimed tokens](https://github.com/code-423n4/2021-11-malt-findings/issues/88)\n_Submitted by harleythedog_\n\nIn AuctionParticipant.sol, the function `setReplenishingIndex` is an admin function that allows manually setting `replenishingIndex`. As I have shown in my two previous findings, I believe that this function could be called frequently. In my opinion (and Murphy's law would agree), this implies that eventually an admin will accidentally set `replenishingIndex` incorrectly with this function.\n\nRight now, `setReplenishingIndex` does not allow the admin to set `replenishingIndex` to a value smaller than it currently is. So, if an admin were to accidentally set this value too high, then it would be impossible to set it back to a lower value (the higher the value set, the worse this issue). All of the unclaimed tokens on auctions at smaller indices would be locked forever.\n\n#### Proof of Concept\n\nSee code for `setReplenishingIndex` here: <https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/AuctionParticipant.sol#L132>\n\n\n#### Recommended Mitigation Steps\n\nRemove the require statement on line 136, so that an admin can set the index to a smaller value.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/88)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/88#issuecomment-1011612291):**\n > Agree with the finding in that if the `ADMIN` were to increase the `replenishingIndex` then the unclaim tokens at auctions below the index wouldn't be claimable anymore.\n> \n> I believe the warden properly highlighted what an hypothetical abuse of `admin privilege` would look like.\n> As such I'll rate the finding with medium severity.\n> \n> I don't necessarily agree with the warden recommended mitigation, it may actually be best to simply delete the setter, or force it to go up by one index at a time after checking that all tokens are claimed\n\n\n## [[M-11] No max for advanceIncentive](https://github.com/code-423n4/2021-11-malt-findings/issues/190)\n_Submitted by gpersoon, also found by 0x1f8b_\n\n\nThe function setAdvanceIncentive of DAO.sol doesn't check for a maximum value of incentive.\nIf incentivewould be very large, then advanceIncentive would be very large and the function advance() would mint a large amount of malt.\n\nThe function setAdvanceIncentive() can only be called by an admin, but a mistake could be made.\nAlso if an admin would want to do a rug pull, this would be an ideal place to do it.\n\n#### Proof of Concept\n\n<https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/DAO.sol#L98-L104>\n\n```js\nfunction setAdvanceIncentive(uint256 incentive)  externalonlyRole(ADMIN_ROLE, \"Must have admin role\") {\n  ...\n  advanceIncentive = incentive;\n```\n\n<https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/DAO.sol#L55-L63>\n\n```js\nfunction advance() external {\n...\n  malt.mint(msg.sender, advanceIncentive * 1e18);\n\n```\n\n#### Recommended Mitigation Steps\n\nCheck for a reasonable maximum value in advance()\n\n**[0xScotch (sponsor) confirmed and disagreed with severity](https://github.com/code-423n4/2021-11-malt-findings/issues/190):** \n > Definitely need to guard against arbitrarily large incentives. Disagree the risk is medium though.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/190#issuecomment-1019288176):**\n > Agree with the finding, this is an example of admin privilege, where the admin can set a variable which can be used to dilute the token and rug the protocol.\n> \n> Because this is contingent on the admin's action, I believe medium severity to be proper\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/190#issuecomment-1025181758):**\n > The simple rationale on the medium severity is that the owner could set the incentive to an exorbitant amount with the goal of minting a lot of tokens for an exit scam\n\n\n\n## [[M-12] Permissions - return values not checked when sending ETH](https://github.com/code-423n4/2021-11-malt-findings/issues/329)\n_Submitted by ScopeLift, also found by nathaniel_\n\nOn lines 85 and 101, ETH is transferred using a `.call` to an address provided as an input, but there is no verification that the call call succeeded. This can result in a call to `emergencyWithdrawGAS` or `partialWithdrawGAS` appearing successful but in reality it failed. This can happen when the provided `destination` address is a contract that cannot receive ETH, or if the `amount` provided is larger than the contract's balance\n\n#### Proof of Concept\n\nEnter the following in remix, deploy the `Receiver` contract, and send 1 ETH when deploying the `Permissions` contract. Call `emergencyWithdrawGAS` with the receiver address and you'll see it reverts. This would not be caught in the current code\n\n```solidity\npragma solidity ^0.8.0;\n\ncontract Receivier{}\n\ncontract Permissions {\n  constructor() payable {}\n\n  function emergencyWithdrawGAS(address payable destination) external {\n    (bool ok, ) = destination.call{value: address(this).balance}('');\n    require(ok, \"call failed\");\n  }\n}\n```\n\n#### Tools Used\n\nRemix\n\n#### Recommended Mitigation Steps\n\nIn `emergencyWithdrawGAS`:\n\n```diff\n- destination.call{value: address(this).balance}('');\n+ (bool ok, ) = destination.call{value: address(this).balance}('');\n+ require(ok, \"call failed\");\n```\n\nAnd similar for `partialWithdrawGAS`\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/329)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/329#issuecomment-1019293046):**\n > Agree with the finding, I believe if a developer were to not use safeTransfer we'd rate as medium, so while I believe the impact to be minimal (no composability), I'll keep the severity to medium\n\n\n\n## [[M-13] Reducing the epoch length results in leaking value from advancement incentives](https://github.com/code-423n4/2021-11-malt-findings/issues/4)\n_Submitted by TomFrench_\n\n\nUnintended advancement incentives being paid out to third party\n\n#### Proof of Concept\n\n`DAO.sol` incentives outside parties to advance the epoch by minting 100 MALT tokens for calling the `advance` function. This is limited by checking that the start timestamp of the next epoch has passed.\n\n<https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/DAO.sol#L55-L63>\n\nThis start timestamp is calculated by multiplying the new epoch number by the length of an epoch and adding it to the genesis timestamp.\n\n<https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/DAO.sol#L65-L67>\n\nThis method makes no accommodation for the fact that previous epochs may have been set to be a different length to what they are currently.\n\n<https://github.com/code-423n4/2021-11-malt/blob/d3f6a57ba6694b47389b16d9d0a36a956c5e6a94/src/contracts/DAO.sol#L111-L114>\n\nIn the case where the epoch length is reduced, `DAO` will think that the epoch number can be incremented potentially many times. Provided the `advanceIncentive` is worth more than the gas necessary to advance the epoch will be rapidly advanced potentially many times paying out unnecessary incentives.\n\n#### Recommended Mitigation Steps\n\nRather than calculating from the genesis timestamp, store the last time that the epoch length was modified and calculate from there.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/4)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/4#issuecomment-1019293929):**\n > Given a specific epoch length, the system will be able to determine which incentives to pay out.\n> Because the math for calculating the next epoch is based on the initial time, changing the `epochLength` can cause unintended consequences and allow for further calls to `advance` with the goal of receiving more caller incentives.\n> \n> The exploit can be triggered by admin privileges (changing epochLength), and because it's a leak of value, I agree with medium severity\n\n\n\n## [[M-14] Wrong permissions on `reassignGlobalAdmin`](https://github.com/code-423n4/2021-11-malt-findings/issues/250)\n_Submitted by cmichel_\n\nThe `Permissions.reassignGlobalAdmin` function is supposed to only be run with the `TIMELOCK_ROLE` role, see `onlyRole(TIMELOCK_ROLE, \"Only timelock can assign roles\")`.\n\nHowever, the `TIMELOCK_ROLE` is not the admin of all the reassigned roles and the `revokeRole(role, oldAccount)` calls will fail as it requires the `ADMIN_ROLE`.\n\n#### Recommended Mitigation Steps\n\nThe idea might have been that only the `TIMELOCK` should be able to call this function, and usually it is also an admin, but the function strictly does not work if the caller *only* has the `TIMELOCK` roll and will revert in this case.\nMaybe governance decided to remove the admin role from the Timelock, which makes it impossible to call `reassignGlobalAdmin` anymore as both the timelock and admin are locked out.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/250)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/250#issuecomment-1019393705):**\n > The warden has identified a flaw in the roles implementation, while the system seems to work when the timelock has multiple roles, the name of the roles implies a different functionality than what can actually be done.\n> The sponsor confirms.\n> While I believe the impact in the demo setup to be fairly minor, because the finding shows a flow in the role setup, and the sponsor confirmed, I agree with medium severity\n\n\n\n## [[M-15] Bonding doesn't work with fee-on transfer tokens](https://github.com/code-423n4/2021-11-malt-findings/issues/251)\n_Submitted by cmichel_\n\nCertain ERC20 tokens make modifications to their ERC20's `transfer` or `balanceOf` functions.\nOne type of these tokens is deflationary tokens that charge a certain fee for every `transfer()` or `transferFrom()`.\n\n#### Impact\n\nThe `Bonding._bond()` function will revert in the `_balanceCheck` when transferring a fee-on-transfer token as it assumes the entire `amount` was received.\n\n#### Recommended Mitigation Steps\n\nTo support fee-on-transfer tokens, measure the asset change right before and after the asset-transferring calls and use the difference as the actual bonded amount.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/251)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/251#issuecomment-1019394195):**\n > Agree with the finding, the check will revert on a token that takes fees as the system assumes that `amount` is the amount that will be received\n\n\n\n## [[M-16] theft of system profit](https://github.com/code-423n4/2021-11-malt-findings/issues/56)\n_Submitted by danb, also found by leastwood and WatchPug_\n\nSystem profit comes from the stabilize function when the price of malt is above 1. Therefore it should not be allowed for anyone to take a part of the system profit when the price is above one. Right now, anyone can take a part of the investors' profits, even if they don't own any malt at all.\n\n#### Proof of Concept\n\nsuppose that the price went up to 1.2 dai; the investors should get the reward for this rise. instead, anyone can take a part of the reward in the following steps:\nThe price of malt is now 1.2 dai.\nTake a flash loan of a large amount of malt.\nSell the malt for dai.\nNow the price went down to 1.1 dai because of the enormous swap.\nCall stabilize in order to lower the price to 1 dai.\nBuy malt to repay the flash loan at a lower cost with the bought dai.\nRepay the flash loan, and take the profit.\n\nIt is a sandwich attack because they sold malt for a high price, then they called stabilize to lower the value, then repurchase it for a low price.\n\nThe user made a profit at the expense of the investors.\n\nIf a user already has malt, it’s even easier:\njust sell all malt at a high cost.\n\n#### Recommended Mitigation Steps\n\nin \\_beforeTokenTransfer, if the price is above 1\\$ and the receiver is the AMM pool, stabilize it.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/56#issuecomment-1010442853):**\n > @0xScotch The warden says that if the price is above the peg price, the system should stabilize it\n> From reading the `PoolTransferVerification.verifyTransfer`, the system wants you to trade when Malt is above peg (minus tolerance)\n> \n> Would you say this finding is invalid?\n\n**[0xScotch (sponsor) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/56#issuecomment-1019287914):**\n > > @0xScotch The warden says that if the price is above the peg price, the system should stabilize it From reading the `PoolTransferVerification.verifyTransfer`, the system wants you to trade when Malt is above peg (minus tolerance)\n> > \n> > Would you say this finding is invalid?\n> \n> I think the issue being pointed out is that the stabilization above peg can be sandwiched and some profit that would go to LPs can be extracted. I think this is an issue but its not absolutely critical.\n> \n> We have discussed internally how to deal with this and the suggestion of calling stabilize would require some additional logic in the transfer verification as it would create a circular execution path.\n> 1. User tries to sell at 1.2\n> 2. Transfer verifier triggers stabilize\n> 3. StabilizerNode tries to sell Malt ahead of initial user\n> 4. Transfer verifier runs again and will call stabilize again unless we modify it to deal with this case.\n> \n> I don't think that is an issue but we will consider how to best move ahead with it.\n> \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/56#issuecomment-1019511028):**\n > Let's dissect the warden's finding:\n> ```\n> The price of malt is now 1.2 dai.\n> Take a flash loan of a large amount of malt.\n> Sell the malt for dai.\n> Now the price went down to 1.1 dai because of the enormous swap.\n> Call stabilize in order to lower the price to 1 dai.\n> Buy malt to repay the flash loan at a lower cost with the bought dai.\n> Repay the flash loan, and take the profit.\n> ```\n> \n> -> Flashloan Malt (assumes liquidity to do so, but let's allow that)\n> -> Sell malt for dai -> price goes lower\n> -> Call stabilize -> system reduces price even further\n> -> Buy back the malt\n> -> repay the loan\n> \n> I feel like this is something that can't really be avoided as due to the permissionless nature of liquidity pools, limiting the ability to sell or buy to a path will be sidestepped by having other pools being deployed to avoid those checks.\n> \n> That said, the warden has identified a way to leak value from the price control system.\n> \n> To be precise the value is being extracted against traders, as to get Malt to 1.2 you'd need a trader to be so aggressive in their purchase to push the price that high.\n> The warden showed how any arber / frontrunner can then \"steal\" the potential profits of the malt system users by frontrunning them.\n> \n> Due to the profit extraction nature of the finding, I believe Medium Severity to be correct\n\n\n\n## [[M-17] Auction collateralToken won't work if token is fee-on-transfer token ](https://github.com/code-423n4/2021-11-malt-findings/issues/227)\n_Submitted by harleythedog_\n\nThere are several ERC20 tokens that take a small fee on transfers/transferFroms (known as \"fee-on-transfer\" tokens). Most notably, USDT is an ERC20 token that has togglable transfer fees, but for now the fee is set to 0 (see the contract here: <https://etherscan.io/address/0xdAC17F958D2ee523a2206206994597C13D831ec7#code>). For these tokens, it should not be assumed that if you transfer `x` tokens to an address, that the address actually receives `x` tokens. In the current test environment, DAI is the only `collateralToken` available, so there are no issues. However, it has been noted that more pools will be added in the future, so special care will need to be taken if fee-on-transfer tokens (like USDT) are planned to be used as `collateralTokens`.\n\nFor example, consider the function `purchaseArbitrageTokens` in Auction.sol. This function transfers `realCommitment` amount of `collateralToken` to the liquidityExtension, and then calls `purchaseAndBurn(realCommitment)` on the liquidityExtension. The very first line of `purchaseAndBurn(amount)` is `require(collateralToken.balanceOf(address(this)) >= amount, \"Insufficient balance\");`. In the case of fee-on-transfer tokens, this line will revert due to the small fee taken. This means that all calls to `purchaseArbitrageTokens` will fail, which would be very bad when the price goes below peg, since no one would be able to participate in this auction.\n\n#### Proof of Concept\n\nSee `purchaseArbitrageTokens` here: <https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L177>\n\nSee `purchaseAndBurn` here: <https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/LiquidityExtension.sol#L117>\n\n\n#### Recommended Mitigation Steps\n\nAdd logic to transfers/transferFroms to calculate exactly how many tokens were actually sent to a specific address. In the example given with `purchaseArbitrageTokens`, instead of calling `purchaseAndBurn` with `realCommitment`, the contract should use the difference in the liquidityExtension balance after the transfer minus the liquidityExtension  balance before the transfer.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/227)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/227#issuecomment-1019511655):**\n > Agree with the finding, the system as a whole seem to not deal with feeOnTransfer Token\n> Mitigation can be as simple as never using them, or refactoring to check for actual amounts received\n\n\n\n## [[M-18] AuctionParticipant.sol: `purchaseArbitrageTokens` should not push duplicate auctions](https://github.com/code-423n4/2021-11-malt-findings/issues/87)\n_Submitted by harleythedog_\n\nIn AuctionParticpant.sol, every time `purchaseArbitrageTokens` is called, the current auction is pushed to `auctionIds`. If this function were to be called on the same auction multiple times, then the same auction id would be pushed multiple times into this array, and the `claim` function would have issues with `replenishingIndex`.\n\nSpecifically, even if `replenishingIndex` was incremented once in `claim`, it is still possible that the auction at the next index will never reward any more tokens to the participant, so the contract would need manual intervention to set `replenishingIndex` (due to the if statement on lines 79-82 that does nothing if there is no claimable yield).\n\nIt is likely that `purchaseArbitrageTokens` would be called multiple times on the same auction. In fact, the commented out code for `handleDeficit` (in ImpliedCollateralService.sol) even suggests that the purchases might happen within the same transaction. So this issue will likely be an issue on most auctions and would require manual setting of `replenishingIndex`.\n\nNOTE: This is a separate issue from the one I just submitted previously relating to `replenishingIndex`. The previous issue was related to an edge case where `replenishingIndex` might need to be incremented by one if there are never going to be more claims, while this issue is due to duplicate auction ids.\n\n#### Proof of Concept\n\nSee code for `purchaseArbitrageTokens` here: <https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/AuctionParticipant.sol#L40>\n\nNotice that `currentAuction` is always appended to `auctionIds`.\n\n\n#### Recommended Mitigation Steps\n\nAdd a check to the function to `purchaseArbitrageTokens` to ensure that duplicate ids are not added. For example, this can be achieved by changing auctionIds to a mapping instead of an array.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/87)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/87#issuecomment-1019521510):**\n > I agree with the finding, adding the same `auctionId` can lead to undefined behaviour. This can break claiming of incentives. Because of that, I think medium severity to be appropriate\n\n\n\n## [[M-19] MiningService.setBonding should use BONDING role instead of REINVESTOR one](https://github.com/code-423n4/2021-11-malt-findings/issues/370)\n_Submitted by hyh_\n\nBONDING_ROLE cannot be managed after it was initialized.\n\n#### Proof of Concept\n\n`setBonding` set the wrong role via \\_swapRole:\n\n<https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/MiningService.sol#L116>\n\n#### Recommended Mitigation Steps\n\nSet `BONDING_ROLE` instead of `REINVESTOR_ROLE` in `setBonding` function:\n\nNow:\n```solidity\nfunction setBonding(address _bonding)\n  public\n  onlyRole(ADMIN_ROLE, \"Must have admin privs\")\n{\n  require(_bonding != address(0), \"Cannot use address 0\");\n  _swapRole(_bonding, bonding, REINVESTOR_ROLE);\n  bonding = _bonding;\n}\n```\n\nTo be:\n```solidity\nfunction setBonding(address _bonding)\n  public\n  onlyRole(ADMIN_ROLE, \"Must have admin privs\")\n{\n  require(_bonding != address(0), \"Cannot use address 0\");\n  _swapRole(_bonding, bonding, BONDING_ROLE);\n  bonding = _bonding;\n}\n```\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/370)**\n\n\n## [[M-20] Users Can Contribute To An Auction Without Directly Committing Collateral Tokens](https://github.com/code-423n4/2021-11-malt-findings/issues/188)\n_Submitted by leastwood_\n\n`purchaseArbitrageTokens` enables users to commit collateral tokens and in return receive arbitrage tokens which are redeemable in the future for Malt tokens. Each auction specifies a commitment cap which when reached, prevents users from participating in the auction. However, `realCommitment` can be ignored by directly sending the `LiquidityExtension` contract collateral tokens and subsequently calling `purchaseArbitrageTokens`.\n\n#### Proof of Concept\n\nConsider the following scenario:\n\n*   An auction is currently active.\n*   A user sends collateral tokens to the `LiquidityExtension` contract.\n*   The same user calls `purchaseArbitrageTokens` with amount `0`.\n*   The `purchaseAndBurn` call returns a positive `purchased` amount which is subsequently used in auction calculations.\n\nAs a result, a user could effectively influence the average malt price used throughout the `Auction` contract.\n\n<https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L177-L214>\n<https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/LiquidityExtension.sol#L117-L128>\n\n#### Recommended Mitigation Steps\n\nConsider adding a check to ensure that `realCommitment != 0` in `purchaseArbitrageTokens`.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/188)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/188#issuecomment-1020112892):**\n > The warden has identified a way to side-step the cap on commitments.\n> Because the commitments are used for calculating limits, but `maltPurchased` is used to calculate rewards, an exploiter can effectively use an auction to purchase as many arbitrage tokens as they desire.\n> \n> Using any `amount` greater than zero will eventually allow to end the auction, however, by using 0 this process can be repeated continuously.\n> \n> Agree with the finding and severity\n\n\n## [[M-21] `StabilizerNode` Will Mint An Incentive For Triggering An Auction Even If An Auction Exists Already](https://github.com/code-423n4/2021-11-malt-findings/issues/191)\n_Submitted by leastwood_\n\n`_startAuction` utilises the `SwingTrader` contract to purchase Malt. If `SwingTrader` has insufficient capital to return the price of Malt back to its target price, an auction is triggered with the remaining amount. However, no auction is triggered if the current auction exists, but `msg.sender` is still rewarded for their call to `stabilize`.\n\n#### Proof of Concept\n\n`_shouldAdjustSupply` initially checks if the current auction is active, however, it does not check if the current auction exists. There is a key distinction between the `auctionActive` and `auctionExists` functions which are not used consistently. Hence, an auction which is inactive but exists would satisfy the edge case and result in `triggerAuction` simply returning.\n\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L382-L386>\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L268-L272>\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L342-L344>\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L873-L888>\n\n\n#### Recommended Mitigation Steps\n\nConsider using `auctionExists` and `auctionActive` consistently in `StabilizerNode` and `Auction` to ensure this edge case cannot be abused.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/191)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/191#issuecomment-1020125296):**\n > The warden found a way to effectively mint free malt by spamming the caller incentive by abusing a specific edge case.\n\n\n\n## [[M-22] `_calculateMaltRequiredForExit` Uses Spot Price To Calculate Malt Quantity In `exitEarly`](https://github.com/code-423n4/2021-11-malt-findings/issues/215)\n_Submitted by leastwood_\n\n`_calculateMaltRequiredForExit` in `AuctionEscapeHatch` currently uses Malt's spot price to calculate the quantity to return to the exiting user. This spot price simply tracks the Uniswap pool's reserves which can easily be manipulated via a flash loan attack to extract funds from the protocol.\n\n#### Proof of Concept\n\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/AuctionEscapeHatch.sol#L65-L92>\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/AuctionEscapeHatch.sol#L193>\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L80-L109>\n- <https://shouldiusespotpriceasmyoracle.com/>\n\n\n#### Recommended Mitigation Steps\n\nConsider implementing/integrating a TWAP oracle to track the price of Malt.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/215)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/215#issuecomment-1020710474):**\n > I feel like this issue highlights the design challenge that the sponsor will have to solve, on one hand the protocol is meant to stabilize the price of malt in specific pools (impossible to block / control every pool due to permissionless nature).\n> At the same time in order to determine which direction to move the price to, they need to refer to the pricing of the underlying pools (in this case a UniV2Pool, most likely from QuickSwap)\n> \n> Personally I understand the finding and think it's valid, however I don't believe there's easy answers as to how the sponsor should address this.\n> \n> Whenever there's excess value there will be entities trying to seize it and perhaps through such a harsh environment this protocol can truly find a way to be sustainable.\n> \n> That said, I'll mark the finding as valid, but believe this specific issue underlines the challenges that await the sponsor in making the protocol succesful\n\n\n\n## [[M-23] `addLiquidity` Does Not Reset Approval If Not All Tokens Were Added To Liquidity Pool](https://github.com/code-423n4/2021-11-malt-findings/issues/228)\n_Submitted by leastwood_\n\n`addLiquidity` is called when users reinvest their tokens through bonding events. The `RewardReinvestor` first transfers Malt and rewards tokens before adding liquidity to the token pool. `addLiquidity` provides protections against slippage by a margin of 5%, and any dust token amounts are transferred back to the caller. In this instance, the caller is the `RewardReinvestor` contract which further distributes the dust token amounts to the protocol's treasury. However, the token approval for this outcome is not handled properly. Dust approval amounts can accrue over time, leading to large Uniswap approval amounts by the `UniswapHandler` contract.\n\n#### Proof of Concept\n\n<https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L212-L214>\n<https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L216-L218>\n\n#### Recommended Mitigation Steps\n\nConsider resetting the approval amount if either `maltUsed < maltBalance` or `rewardUsed < rewardBalance` in `addLiquidity`.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/228)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/228#issuecomment-1020718747):**\n > The UniV2Router will first [calculate the amounts](https://github.com/Uniswap/v2-periphery/blob/2efa12e0f2d808d9b49737927f0e416fafa5af68/contracts/UniswapV2Router02.sol#L71) and then [pull them](https://github.com/Uniswap/v2-periphery/blob/2efa12e0f2d808d9b49737927f0e416fafa5af68/contracts/UniswapV2Router02.sol#L73) from the msg.sender\n> \n> This means that approvals may not be fully utilized, leaving traces of approvals here and there.\n> This can cause issues with certain tokens (USDT comes to mind), and will also not trigger gas refunds.\n\n\n\n## [[M-24] `_distributeRewards` Does Not Reset Approval If Not All Tokens Were Allocated](https://github.com/code-423n4/2021-11-malt-findings/issues/229)\n_Submitted by leastwood_\n\n`_distributeRewards` attempts to reward LP token holders when the price of Malt exceeds its price target. Malt Finance is able to being Malt back to its peg by selling Malt and distributing rewards tokens to LP token holders. An external call to `Auction` is made via the `allocateArbRewards` function. Prior to this call, the `StabilizerNode` approves the contract for a fixed amount of tokens, however, the `allocateArbRewards` function does not necessarily utilise this entire amount. Hence, dust token approval amounts may accrue from within the `StabilizerNode` contract.\n\n#### Proof of Concept\n\n<https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L252-L253>\n<https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L809-L871>\n\n\n#### Recommended Mitigation Steps\n\nConsider resetting the approval amount if the input `rewarded` amount to `allocateArbRewards` is less than the output amount.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/229)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/229#issuecomment-1020720987):**\n > Finding is valid, incorrect approvals can cause reverts (USDT being an example), and not fully resetting will also negate gas refunds\n\n\n\n## [[M-25] AMM pool can be drained using a flashloan and calling `stabilize`](https://github.com/code-423n4/2021-11-malt-findings/issues/372)\n_Submitted by stonesandtrees_\n\nAll of the `rewardToken` in a given AMM pool can be removed from the AMM pool and distributed as LP rewards.\n\n#### Proof of Concept\n\nIn the `stabilize` method in the `StabilizerNode` the initial check to see if the Malt price needs to be stabilized it uses a short period TWAP:\n<https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L156>\n\nHowever, if the price is above the threshold for stabilization then the trade size required to stabilize looks at the AMM pool directly which is vulnerable to flashloan manipulation.\n\n<https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/DexHandlers/UniswapHandler.sol#L250-L275>\n\nAttack:\n\n1.  Wait for TWAP to rise above the stabilization threshold\n2.  Flashloan remove all but a tiny amount of Malt from the pool.\n3.  Call `stabilize`. This will pass the TWAP check and execute `_distributeSupply` which in turn ultimately calls `_calculateTradeSize` in the `UniswapHandler`. This calculation will determine that almost all of the `rewardToken` needs to be removed from the pool to return the price to peg.\n4.  Malt will mint enough Malt to remove a lot of the `rewardToken` from the pool.\n5.  The protocol will now distribute that received `rewardToken` as rewards. 0.3% of which goes directly to the attacker and the rest goes to LP rewards, swing trader and the treasury.\n\nThe amount of money that can be directly stolen by a malicious actor is small but it can cause a lot of pain for the protocol as the pool will be destroyed and confusion around rewards will be created.\n\n#### Recommended Mitigation Steps\n\nUse a short TWAP to calculate the trade size instead of reading directly from the pool.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/372)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/372#issuecomment-1020734907):**\n > I believe the warden has identified a valid grief and potential exploit\n> \n> I'm not convinced on the simplicity of:\n> `2. Flashloan remove all but a tiny amount of Malt from the pool.`\n> \n> You'd have to buy that liquidity in order to be able to remove the malt, which effectively makes the operation not as straightforward (if not unprofitable for the attacker).\n> \n> I do believe the grief can be performed but in lack of a clear incentive for the attacker, am going to downgrade to Medium Severity.\n> Can be done, but not clear on the incentives\n\n\n\n## [[M-26] Dutch auction can be manipulated](https://github.com/code-423n4/2021-11-malt-findings/issues/375)\n_Submitted by gzeon_\n\nWhen malt is under-peg and the swing trader module do not have enough capital to buy back to peg, a Dutch auction is triggered to sell arb token. The price of the Dutch auction decrease linearly toward endprice until \\_endAuction() is called. <https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L589>\n\n\\_endAuction() is called in\n\n1.  When auction.commitments >= auction.maxCommitments\n\n<https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L212>\n\n2.  On stabilize() -> checkAuctionFinalization() -> \\_checkAuctionFinalization()\n\n<https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/StabilizerNode.sol#L146>\n<https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L754>\n\n3.  On stabilize() ->\\_startAuction() -> triggerAuction() -> \\_checkAuctionFinalization()\n\n<https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/StabilizerNode.sol#L170>\n<https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L754>\n\nIt is possible manipulate the dutch auction by preventing \\_endAuction() being called.\n\n#### Proof of Concept\n\nConsider someone call purchaseArbitrageTokens with auction.maxCommitments minus 1 wei, `_endAuction` won't be called because auction.commitments < auction.maxCommitments. Further purchase would revert because `purchaseAndBurn` (<https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Auction.sol#L184>) would likely revert since swapping 1 wei in most AMM will fail due to rounding error. Even if it does not revert, there is no incentive to waste gas to purchase 1 wei of token.\n\nAs such, the only way for the auction to finalize is to call stabilize().\nHowever, this is not immediately possible because it require\n`block.timestamp >= stabilizeWindowEnd` where\n`stabilizeWindowEnd = block.timestamp + stabilizeBackoffPeriod`\nstabilizeBackoffPeriod is initially set to 5 minutes in the contract\n\nAfter 5 minute, stabilize() can be called by anyone. By using this exploit, an attacker can guarantee he can purchase at (startingPrice+endingPrice)/2 or lower, given the default 10 minute auctionLength and 5 minute stabilizeBackoffPeriod. (unless a privileged user call stabilize() which override the stability window)\n\nAlso note that stabilize() might not be called since there is no incentive.\n\n#### Recommended Mitigation Steps\n\n1.  Incentivize stabilize() or incentivize a permission-less call to \\_endAuction()\n2.  Lock-in auction price when user commit purchase\n\n\n**[0xScotch (sponsor) labeled](https://github.com/code-423n4/2021-11-malt-findings/issues/375) sponsor confirmed**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/375#issuecomment-1020758586):**\n > By purchasing all but 1 wei of arbitrageTokens, any caller can guarantee that the auction will offer the steepest discount.\n> \n> This is caused by the fact that AMMs (esp UniV2) will revert with small numbers, as rounding will cause the amountOut to == 0 which will cause a INSUFFICIENT_AMOUNT revert.\n> \n> I agree with the pre-conditions and the possibility of this to happen.\n> In a sense I believe this can become the meta strategy that every dutch auction participant will use (the fight between buyers will be done by paying gas to be the first few to buy arbitrageTokens).\n> \n> So the question is how to avoid it.\n> I guess purchasing at a time should lock the price for that particular buyer at that particular time (adding a mapping should increase cost of 20k on write and a few thousand gas on read).\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/375#issuecomment-1020759031):**\n > TODO: Decide on severity\n> \n> Medium for sure, extract value reliably.\n> Is it high though? Arguably the dutch auction is not properly coded as it allows to get a further discount instead of locking in a price for the user at time of deposit\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/375#issuecomment-1022195290):**\n > While an argument for the Dutch Auction being coded wrong (user locking in price) can be made, that's not the definition of a Dutch Auciton\n> \n> <img width=\"600\" alt=\"Screenshot 2022-01-26 at 14 16 34\" src=\"https://user-images.githubusercontent.com/13383782/151169628-a1d8e7e7-15c2-4064-a985-9f923154170a.png\">\n> https://www.investopedia.com/terms/d/dutchauction.asp\n> \n> So arguably the dutch auction is properly coded, it's that there's a specific way to sidestep it which is caused by:\n> - 1 wei tx reverting on swap\n> - sum of purchases not being enough\n> \n> For this conditions to happen the \"exploiter\" needs to be fast enough to place an order, in such a way that their order will leave 1 commitment left.\n> I can imagine them setting up a contract that reverts if this condition isn't met and that checks for w/e amount is needed at that time.\n> \n> I would assume that having an admin privileged function to close the auction prematurely would solve this specific attack.\n> \n> I believe that the warden has identified a fairly reliable way to get a discount from the protocol because of the impact and some of the technicalities I believe Medium Severity to be more appropriate.\n> This will be exploited, but in doing so will make the protocol successful (all auction full minus 1 wei), the premium / discount will be reliable predicted (50% between start and end) and as such I believe it will be priced in\n\n\n## [[M-27] Slippage checks when adding liquidity are too strict](https://github.com/code-423n4/2021-11-malt-findings/issues/257)\n_Submitted by cmichel_\n\nWhen adding liquidity through `UniswapHandler.addLiquidity`, the entire contract balances are used to add liquidity and the min amounts are set to 95% of these balances.\nIf the balances in this contract are unbalanced (the ratio is not similar to the current Uniswap pool reserve ratios) then this function will revert and no liquidity is added.\n\nSee `UniswapHandler.buyMalt`:\n\n```solidity\n(maltUsed, rewardUsed, liquidityCreated) = router.addLiquidity(\n  address(malt),\n  address(rewardToken),\n  maltBalance, // @audit-info amountADesired\n  rewardBalance,\n  // @audit assumes that whatever is in this contract is already balanced. good assumption?\n  maltBalance.mul(95).div(100), // @audit-info amountAMin\n  rewardBalance.mul(95).div(100),\n  msg.sender, // transfer LP tokens to sender\n  now\n);\n```\n\n#### Impact\n\nIf the contract has unbalanced balances, then the `router.addLiquidity` call will revert.\nNote that an attacker could even send tokens to this contract to make them unbalanced and revert, resulting in a griefing attack.\n\n#### Recommended Mitigation Steps\n\nIt needs to be ensured that the balances in the contract are always balanced and match the current reserve ratio.\nIt might be better to avoid directly using the balances which can be manipulated by transferring tokens to the contract and accepting parameters instead of how many tokens to provide liquidity with from the caller side.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/257)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/257#issuecomment-1022202079):**\n > Interestingly the warden highlights the other side of the \"missing slippage check\" argument.\n> Slippage checks in general need to be calculated offChain (as you will get frontrun in the mempool, so the slippage check is a risk minimization tool more than anything else)\n> \n> The warden also specified a griefing attack that can be used because of the hardcoded check.\n> The sponsor confirms, I think medium severity is appropriate\n\n\n## [[M-28] Bonding.sol _unbondAndBreak does not account for edge case where no tokens are returned](https://github.com/code-423n4/2021-11-malt-findings/issues/234)\n_Submitted by harleythedog_\n\nIn Bonding.sol, the internal function `_unbondAndBreak` transfers a user's stake tokens to the dexHandler and then calls `removeLiquidity` on the dexHandler. Within the Uniswap handler (which is the only handler so far) `removeLiquidity` takes special care in the edge case where `router.removeLiquidity` returns zero tokens. Specifically, the Uniswap handler has this code:\n\n```solidity\nif (amountMalt == 0 || amountReward == 0) {\n  liquidityBalance = lpToken.balanceOf(address(this));\n  lpToken.safeTransfer(msg.sender, liquidityBalance);\n  return (amountMalt, amountReward);\n}\n```\n\nIf this edge case does indeed happen (i.e. if something is preventing the Uniswap router from removing liquidity at the moment), then the Uniswap handler will transfer the LP tokens back to Bonding.sol. However, Bonding.sol does not have any logic to recognize that this happened, so the LP tokens will become stuck in the contract and the user will never get any of their value back. This could be very bad if the user unbonds a lot of LP and they don't get any of it back.\n\n#### Proof of Concept\n\nSee `_unbondAndBreak` here: <https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/Bonding.sol#L226>\n\nNotice how the edge case where `amountMalt == 0 || amountReward == 0` is not considered in this function, but it is considered in the Uniswap handler's `removeLiquidity` here: <https://github.com/code-423n4/2021-11-malt/blob/c3a204a2c0f7c653c6c2dda9f4563fd1dc1cecf3/src/contracts/DexHandlers/UniswapHandler.sol#L240>\n\n#### Recommended Mitigation Steps\n\nAdd a similar edge case check to `_unbondAndBreak`. In the case where LP tokens are transferred back to Bonding.sol instead of malt/reward, these LP tokens should be forwarded back to the user since the value is rightfully theirs.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/234)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/234#issuecomment-1022203715):**\n > In the `then` case the tokens will be sent back to the `Bonding.sol` contract, which has no way of rescuing or returning the tokens, probably reverting would be a better solution.\n> \n> Because the warden identified a way for tokens to get stucked, I think Medium Severity to be appropriate\n\n\n## [[M-29] User can bypass Recovery Mode via UniswapHandler to buy Malt ](https://github.com/code-423n4/2021-11-malt-findings/issues/325)\n_Submitted by gzeon_\n\nOne of the innovative feature of Malt is to block buying while under peg. The buy block can be bypassed by swapping to the whitelisted UniswapHandler, and then extract the token by abusing the add and remove liquidity function. This is considered a high severity issue because it undermine to protocol's ability to generate profit by the privileged role as designed and allow potential risk-free MEV.\n\n#### Proof of Concept\n\n1.  User swap dai into malt and send malt directly to uniswapHandler, this is possible becuase uniswapHandler is whitelisted\n\n`swapExactTokensForTokens(amountDai, 0, [dai.address, malt.address], uniswapHandler.address, new Date().getTime() + 10000);`\n2\\) User send matching amount of dai to uniswapHandler\n3\\) User call addLiquidity() and get back LP token\n4\\) User call removeLiquidity() and get back both dai and malt\n\n#### Recommended Mitigation Steps\n\nAccording to documentation in <https://github.com/code-423n4/2021-11-malt#high-level-overview-of-the-malt-protocol>\n\n> Users wanting to remove liquidity can still do so via the UniswapHandler contract that is whitelisted in recovery mode.\n\n, this should be exploitable. Meanwhile the current implementation did not actually allow remove liquidity during recovery mode (refer to issue \"Unable to remove liquidity in Recovery Mode\")\nThis exploit can be mitigated by disabling addLiquidity() when the protocol is in recovery mode\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/325)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/325#issuecomment-1020752336):**\n > The Malt token is programmed to explicitly prevent buying it when at discount.\n> However, because `addLiquidity` and `removeLiquidity` are callable by anyone, and the `UniswapHandler` is whitelisted, through a calculated addition and removal of liquidity anyone can mimick buying Malt for a discount (by providing imbalanced underlying and redeeming them).\n> \n> I believe this sidesteps the majority of the functionality of the protocol, and while the attack is fairly simple, it denies the protocol functionality and as such agree with a High Severity\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/325#issuecomment-1025167069):**\n > After re-review:\n> Addressing each step:\n> \n> 1) The swap can be done as the whitelisting is bypassed (so finding is valid on that end)\n> 2) User can send more liquidity\n> 3) User can add liquidity at discount (as they bought at discount) (notice that this subjects them to potentially more IL so arguably the MEV extraction happened at step 1)\n> 4) This cannot be done because of #323 which was found by the same warden. As per #323 you can't remove liquidity as the `transfer` will be from pool to user and as such will be reverted due to the system being in recovery mode.\n> \n> I believe that the warden identified a way to sidestep purchasing malt via purchase -> send to UniswapHandler -> add liquidity which should allow for some MEV extraction (with the user risking IL as they assume malt will go back to peg)\n> \n> Because of this there's still some validity to the finding, but it's not as dire as I originally believed.\n> \n> I'm going to downgrade the finding to Medium Severity as:\n> 1) Value can be extracted\n> 2) by bypassing the check for buying malt\n> \n> But this doesn't allow the selling of malt, so it's not a protocol breaking exploit but rather a way to gain MEV.\n\n\n\n## [[M-30] Malt Protocol Uses Stale Results From `MaltDataLab` Which Can Be Abused By Users](https://github.com/code-423n4/2021-11-malt-findings/issues/373)\n_Submitted by leastwood_\n\n`MaltDataLab` integrates several `MovingAverage` contracts to fetch sensitive data for the Malt protocol. Primary data used by the protocol consists of the real value for LP tokens, the average price for Malt and average reserve ratios. `trackMaltPrice`, `trackPoolReserves` and `trackPool` are called by a restricted role denoted as the `UPDATER_ROLE` and represented by an EOA account and not another contract. Hence, the EOA account must consistently update the aforementioned functions to ensure the most up-to-date values. However, miners can censor calls to `MaltDataLab` and effectively extract value from other areas of the protocol which use stale values.\n\n#### Proof of Concept\n\nConsider the following attack vector:\n\n*   The price of Malt exceeds the lower bound threshold and hence `stabilize` can be called by any user.\n*   The `_stabilityWindowOverride` function is satisfied, hence the function will execute.\n*   The state variable, `exchangeRate`, queries `maltPriceAverage` which may use an outdated exchange rate.\n*   `_startAuction` is executed which rewards `msg.sender` with 100 Malt as an incentive for triggering an auction.\n*   As the price is not subsequently updated, a malicious attacker could collude with a miner to censor further pool updates and continue calling `stabilize` on every `fastAveragePeriod` interval to extract incentive payments.\n*   If the payments exceed what the `UPDATER_ROLE` is willing to pay to call `trackMaltPrice`, a user is able to sustain this attack.\n\nThis threatens the overall stability of the protocol and should be properly handled to prevent such attacks. However, the fact that `MaltDataLab` uses a series of spot price data points to calculate the `MovingAverage` also creates an area of concern as well-funded actors could still manipulate the `MovingAverage` contract by sandwiching calls to `trackMaltPrice`, `trackPool` and `trackPoolReserves`.\n\n`trackMaltPrice`, `trackPool`, and `trackPoolReserves` should be added to the following areas of the code where applicable.\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Bonding.sol#L159>\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Bonding.sol#L173>\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Bonding.sol#L177>\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L881>\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/Auction.sol#L710>\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L156>\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/StabilizerNode.sol#L190>\n- <https://github.com/code-423n4/2021-11-malt/blob/main/src/contracts/ImpliedCollateralService.sol#L105>\n\n\n#### Recommended Mitigation Steps\n\nConsider adding calls to `trackMaltPrice`, `trackPoolReserves` and `trackPool` wherever the values are impacted by the protocol. This should ensure the protocol is tracking the most up-to-date values. Assuming the cumulative values are used in the `MovingAverage` contracts, then sensitive calls utilising `MaltDataLab` should be protected from flashloan attacks. However, currently this is not the case, rather `MovingAverage` consists of a series of spot price data points which can be manipulated by well-funded actors or via a flashloan. Therefore, there needs to be necessary changes made to `MaltDataLab` to use cumulative price updates as its moving average instead of spot price.\n\n**[0xScotch (sponsor) confirmed](https://github.com/code-423n4/2021-11-malt-findings/issues/373):** \n > Gas issues were the reason updates weren't inlined into paths that update critical values. However based on some thoughts from the team over the past few weeks and suggestions in other audit findings I think we can reduce gas enough to make it viable to inline it \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-11-malt-findings/issues/373#issuecomment-1019283105):**\n > 1) Miners can censor transactions, that is a fact\n> 2) Relying on an external call can cause race conditions or situations where the call didn't happen (price didn't update in time)\n> 3) Arguably a malicious actor could collude with miners with the goal of extracting further value\n> \n> However, the target chain for the deployment is Polygon, so unless they were to create custom validator code, and collude 1-1 with each validator (no flashbots on Polygon, yet) then the attack is increasingly more complex.\n> \n> The attack is reliant on the externalities of the validator + somebody incentivized enough to exploit this.\n> \n> I agree with he finding and believe after stabilize the system should auto-update the prices\n> Because of the external requirements am downgrading to medium severity\n\n# Low Risk Findings (43)\n- [[L-01] sellMalt(), addLiquidity() and removeLiquidity() Allow Non Privileged Users Withdraw Fund](https://github.com/code-423n4/2021-11-malt-findings/issues/120) _Submitted by Meta0xNull, also found by 0x1f8b_\n- [[L-02] Missing zero address check which will put forfeited rewards at risk(ForefeitHandler.sol) ](https://github.com/code-423n4/2021-11-malt-findings/issues/216) _Submitted by 0xwags_\n- [[L-03] Multiple Zero address transfer functions on contract Permissions](https://github.com/code-423n4/2021-11-malt-findings/issues/64) _Submitted by BouSalman, also found by 0xwags and sabtikw_\n- [[L-04] DOS with unbounded loop](https://github.com/code-423n4/2021-11-malt-findings/issues/380) _Submitted by Koustre_\n- [[L-05] setupParticipant() function does not check for zero address](https://github.com/code-423n4/2021-11-malt-findings/issues/130) _Submitted by jayjonah8_\n- [[L-06] reassignGlobalAdmin() Lack of Zero Address Check ](https://github.com/code-423n4/2021-11-malt-findings/issues/113) _Submitted by Meta0xNull, also found by BouSalman_\n- [[L-07] Code does not match comments in \"_finalizeAuction\" (Auction.sol)](https://github.com/code-423n4/2021-11-malt-findings/issues/135) _Submitted by ye0lde_\n- [[L-08] Revert transaction if it is unable to change data](https://github.com/code-423n4/2021-11-malt-findings/issues/198) _Submitted by xYrYuYx_\n- [[L-09] Missing zero-address checks on contract initialization](https://github.com/code-423n4/2021-11-malt-findings/issues/74) _Submitted by hyh, also found by 0x1f8b, cmichel, jayjonah8, tabish, and WatchPug_\n- [[L-10] The Contract Should safeApprove(0) first](https://github.com/code-423n4/2021-11-malt-findings/issues/41) _Submitted by defsec, also found by hagrid and robee_\n- [[L-11] Lack of precision](https://github.com/code-423n4/2021-11-malt-findings/issues/168) _Submitted by robee_\n- [[L-12] Incorrect error messages in `StabilizerNode.sol`](https://github.com/code-423n4/2021-11-malt-findings/issues/103) _Submitted by pmerkleplant_\n- [[L-13] purchaseArbitrageTokens 0 amount](https://github.com/code-423n4/2021-11-malt-findings/issues/359) _Submitted by pauliax, also found by jayjonah8_\n- [[L-14] `initialize` functions can be frontrun](https://github.com/code-423n4/2021-11-malt-findings/issues/245) _Submitted by cmichel, also found by 0x1f8b, defsec, jayjonah8, leastwood, Meta0xNull, stonesandtrees, and WatchPug_\n- [[L-15] `StabilizerNode.sol` The current implementation is misconfiguration-prone for rewardToken with non-18 decimals](https://github.com/code-423n4/2021-11-malt-findings/issues/293) _Submitted by WatchPug, also found by cmichel_\n- [[L-16] Auction.sol amendAccountParticipation has no zero division check](https://github.com/code-423n4/2021-11-malt-findings/issues/235) _Submitted by harleythedog_\n- [[L-17] AuctionParticipant.sol: `replenishingIndex` incrementing should be improved](https://github.com/code-423n4/2021-11-malt-findings/issues/85) _Submitted by harleythedog_\n- [[L-18] maxAmount and balance](https://github.com/code-423n4/2021-11-malt-findings/issues/357) _Submitted by pauliax, also found by xYrYuYx_\n- [[L-19] Inclusive checks](https://github.com/code-423n4/2021-11-malt-findings/issues/356) _Submitted by pauliax_\n- [[L-20] Inconsistencies when checking if the auction is active](https://github.com/code-423n4/2021-11-malt-findings/issues/352) _Submitted by pauliax_\n- [[L-21] _setupRole() Deprecated and Not Using With Constructor Effectively Circumventing the Admin System](https://github.com/code-423n4/2021-11-malt-findings/issues/115) _Submitted by Meta0xNull, also found by pauliax_\n- [[L-22] Validation of 'to' in transferAndCall and transferWithPermit](https://github.com/code-423n4/2021-11-malt-findings/issues/350) _Submitted by pauliax_\n- [[L-23] DOMAIN_SEPARATOR can change](https://github.com/code-423n4/2021-11-malt-findings/issues/349) _Submitted by pauliax, also found by leastwood_\n- [[L-24] Auction.claimArbitrage: if calculated claimable amount is too big, the remaining committed amount cannot be retrieved](https://github.com/code-423n4/2021-11-malt-findings/issues/353) _Submitted by hyh_\n- [[L-25] Malt decimals inconsistency: StabilizerNode and DAO contracts use 18 as hard coded Malt decimals](https://github.com/code-423n4/2021-11-malt-findings/issues/175) _Submitted by hyh_\n- [[L-26] setSampleMemory counter set to right value?](https://github.com/code-423n4/2021-11-malt-findings/issues/193) _Submitted by gpersoon_\n- [[L-27] Lack Of Return Value Check On the Dex Handler Malt Price Calculation](https://github.com/code-423n4/2021-11-malt-findings/issues/75) _Submitted by defsec_\n- [[L-28] SafeMath library is not always used in the contracts](https://github.com/code-423n4/2021-11-malt-findings/issues/60) _Submitted by defsec_\n- [[L-29] `approve` return values not checked & unsafe](https://github.com/code-423n4/2021-11-malt-findings/issues/247) _Submitted by cmichel, also found by defsec and WatchPug_\n- [[L-30] Missing Overflow Protection On the DeployedCapital](https://github.com/code-423n4/2021-11-malt-findings/issues/238) _Submitted by defsec_\n- [[L-31] Deprecated Function Usage](https://github.com/code-423n4/2021-11-malt-findings/issues/18) _Submitted by defsec_\n- [[L-32] Remove liquidity never ends up with left-over LP tokens](https://github.com/code-423n4/2021-11-malt-findings/issues/259) _Submitted by cmichel_\n- [[L-33] `splitReinvest` does not provide liquidity at optimal ratio](https://github.com/code-423n4/2021-11-malt-findings/issues/253) _Submitted by cmichel_\n- [[L-34] `totalDeclaredReward >= totalReleasedReward` not true in `AbstractRewardMine`](https://github.com/code-423n4/2021-11-malt-findings/issues/246) _Submitted by cmichel_\n- [[L-35] Missing `maltDataLab.trackReserveRatio()` in some cases after `swingTrader.sellMalt()`](https://github.com/code-423n4/2021-11-malt-findings/issues/320) _Submitted by WatchPug_\n- [[L-36] SafeMath Not Used Nearly At All In MovingAverage.sol](https://github.com/code-423n4/2021-11-malt-findings/issues/21) _Submitted by jayjonah8_\n- [[L-37] Should include non-existing contract check](https://github.com/code-423n4/2021-11-malt-findings/issues/9) _Submitted by jayjonah8_\n- [[L-38] reassignGlobalAdmin() Have No Transfer Ownership Pattern](https://github.com/code-423n4/2021-11-malt-findings/issues/112) _Submitted by Meta0xNull_\n- [[L-39] The value of `reward` parameter of the `ProvideReinvest` event can be wrong](https://github.com/code-423n4/2021-11-malt-findings/issues/292) _Submitted by WatchPug_\n- [[L-40] Max value of upperStabilityThreshold and lowerStabilityThreshold not checked](https://github.com/code-423n4/2021-11-malt-findings/issues/192) _Submitted by gpersoon_\n- [[L-41] Adapt count in setAuctionAverageLookback?](https://github.com/code-423n4/2021-11-malt-findings/issues/194) _Submitted by gpersoon, also found by WatchPug_\n- [[L-42] Unbounded loops](https://github.com/code-423n4/2021-11-malt-findings/issues/358) _Submitted by pauliax_\n- [[L-43] Users may lose a small portion of promised returns due to precision loss](https://github.com/code-423n4/2021-11-malt-findings/issues/305) _Submitted by WatchPug_\n\n# Non-Critical Findings (25)\n- [[N-01] Unused imports](https://github.com/code-423n4/2021-11-malt-findings/issues/157) _Submitted by robee, also found by defsec, Meta0xNull, WatchPug, and xYrYuYx_\n- [[N-02] Implementations should inherit their interface](https://github.com/code-423n4/2021-11-malt-findings/issues/242) _Submitted by WatchPug, also found by xYrYuYx_\n- [[N-03] deployedCapital variable is internal](https://github.com/code-423n4/2021-11-malt-findings/issues/200) _Submitted by xYrYuYx_\n- [[N-04] Index address of events for better filtering](https://github.com/code-423n4/2021-11-malt-findings/issues/31) _Submitted by tabish_\n- [[N-05] Use bps uniformly](https://github.com/code-423n4/2021-11-malt-findings/issues/30) _Submitted by tabish_\n- [[N-06] Outdated Solidity Version Provides No Protections Against Arithmetic Underflows And Overflows](https://github.com/code-423n4/2021-11-malt-findings/issues/185) _Submitted by leastwood, also found by 0x0x0x, BouSalman, hyh, sabtikw, and WatchPug_\n- [[N-07] Create2Deployer](https://github.com/code-423n4/2021-11-malt-findings/issues/348) _Submitted by pauliax_\n- [[N-08] Inaccurate revert messages](https://github.com/code-423n4/2021-11-malt-findings/issues/343) _Submitted by pauliax, also found by 0x0x0x, harleythedog, robee, and ScopeLift_\n- [[N-09] `setupParticipant` function should be internal](https://github.com/code-423n4/2021-11-malt-findings/issues/183) _Submitted by nathaniel_\n- [[N-10] Outdated versions of OpenZeppelin library](https://github.com/code-423n4/2021-11-malt-findings/issues/315) _Submitted by WatchPug_\n- [[N-11] Misleading variable names](https://github.com/code-423n4/2021-11-malt-findings/issues/302) _Submitted by WatchPug_\n- [[N-12] Misleading error message](https://github.com/code-423n4/2021-11-malt-findings/issues/286) _Submitted by WatchPug, also found by gpersoon and ScopeLift_\n- [[N-13] Race condition on ERC20 approval](https://github.com/code-423n4/2021-11-malt-findings/issues/276) _Submitted by WatchPug, also found by robee_\n- [[N-14] Code Style: private/internal function names should be prefixed with `_`](https://github.com/code-423n4/2021-11-malt-findings/issues/265) _Submitted by WatchPug_\n- [[N-15] No message in require statements.](https://github.com/code-423n4/2021-11-malt-findings/issues/98) _Submitted by BouSalman_\n- [[N-16] functions visibility on contract AuctionEscapeHatch](https://github.com/code-423n4/2021-11-malt-findings/issues/97) _Submitted by BouSalman_\n- [[N-17] functions visibility on contract Timelock.sol](https://github.com/code-423n4/2021-11-malt-findings/issues/91) _Submitted by BouSalman_\n- [[N-18] Unused event or missed emit on SetAnnualYield()](https://github.com/code-423n4/2021-11-malt-findings/issues/69) _Submitted by BouSalman_\n- [[N-19] Open TODOs](https://github.com/code-423n4/2021-11-malt-findings/issues/79) _Submitted by ye0lde, also found by Meta0xNull, pauliax, and robee_\n- [[N-20]  Missing events for admin only functions that change critical parameters](https://github.com/code-423n4/2021-11-malt-findings/issues/58) _Submitted by defsec, also found by 0x0x0x, harleythedog, sabtikw, and WatchPug_\n- [[N-21] governor or timelock](https://github.com/code-423n4/2021-11-malt-findings/issues/187) _Submitted by gpersoon_\n- [[N-22] Wrong comment in `removeLiquidity`](https://github.com/code-423n4/2021-11-malt-findings/issues/258) _Submitted by cmichel_\n- [[N-23] Initial `SetTransferService` event not emitted](https://github.com/code-423n4/2021-11-malt-findings/issues/249) _Submitted by cmichel_\n- [[N-24] Permissions.sol#_swapRole is named wrongly](https://github.com/code-423n4/2021-11-malt-findings/issues/290) _Submitted by 0x0x0x_\n- [[N-25] `permit` Double Emits An `Approval` Event](https://github.com/code-423n4/2021-11-malt-findings/issues/230) _Submitted by leastwood_\n\n# Gas Optimizations (75)\n- [[G-01] Use short reason strings can save gas](https://github.com/code-423n4/2021-11-malt-findings/issues/317) _Submitted by WatchPug, also found by GiveMeTestEther, Meta0xNull, robee, and ye0lde_\n- [[G-02] Cache array length in `for` loops](https://github.com/code-423n4/2021-11-malt-findings/issues/106) _Submitted by pmerkleplant, also found by 0x0x0x, GiveMeTestEther, pauliax, robee, WatchPug, and ye0lde_\n- [[G-03]  Cache Reference To State Variable \"currentAuctionID\" in _checkAuctionFinalization (Auction.sol)](https://github.com/code-423n4/2021-11-malt-findings/issues/89) _Submitted by ye0lde, also found by harleythedog_\n- [[G-04] Assignment Of Variables To Default ](https://github.com/code-423n4/2021-11-malt-findings/issues/80) _Submitted by ye0lde, also found by 0x0x0x, GiveMeTestEther, and WatchPug_\n- [[G-05] Storage double reading. Could save SLOAD](https://github.com/code-423n4/2021-11-malt-findings/issues/161) _Submitted by robee, also found by GiveMeTestEther, hyh, WatchPug, and ye0lde_\n- [[G-06] Underutilized Named Returns](https://github.com/code-423n4/2021-11-malt-findings/issues/77) _Submitted by ye0lde_\n- [[G-07] Unused Named Returns](https://github.com/code-423n4/2021-11-malt-findings/issues/76) _Submitted by ye0lde_\n- [[G-08]  Unnecessary intermediate variables (MovingAverage.sol)](https://github.com/code-423n4/2021-11-malt-findings/issues/382) _Submitted by ye0lde_\n- [[G-09] For uint `> 0` can be replaced with ` != 0` for gas optimisation](https://github.com/code-423n4/2021-11-malt-findings/issues/271) _Submitted by 0x0x0x, also found by defsec, pmerkleplant, and ye0lde_\n- [[G-10] Unneeded variables (Auction.sol, StabilizerNode.sol)](https://github.com/code-423n4/2021-11-malt-findings/issues/137) _Submitted by ye0lde_\n- [[G-11] Reduce external calls](https://github.com/code-423n4/2021-11-malt-findings/issues/208) _Submitted by xYrYuYx_\n- [[G-12] decimals return of costBasis is not used.](https://github.com/code-423n4/2021-11-malt-findings/issues/205) _Submitted by xYrYuYx_\n- [[G-13] Checking `uint256` variables `>= 0` is redundant](https://github.com/code-423n4/2021-11-malt-findings/issues/309) _Submitted by WatchPug, also found by 0x0x0x, gzeon, pauliax, and xYrYuYx_\n- [[G-14] Cache decimals](https://github.com/code-423n4/2021-11-malt-findings/issues/371) _Submitted by pauliax, also found by hyh and xYrYuYx_\n- [[G-15] In TransactionService, store index of source to avoid loop when removing verifier](https://github.com/code-423n4/2021-11-malt-findings/issues/199) _Submitted by xYrYuYx_\n- [[G-16] Public functions to external](https://github.com/code-423n4/2021-11-malt-findings/issues/163) _Submitted by robee, also found by 0x0x0x and xYrYuYx_\n- [[G-17] Storage Optimization](https://github.com/code-423n4/2021-11-malt-findings/issues/38) _Submitted by 0x1f8b, also found by gzeon, robee, and tabish_\n- [[G-18] initialized storage variables are set again in the initializer function ](https://github.com/code-423n4/2021-11-malt-findings/issues/45) _Submitted by sabtikw_\n- [[G-19] Unused declared local variables](https://github.com/code-423n4/2021-11-malt-findings/issues/158) _Submitted by robee, also found by Koustre_\n- [[G-20] Can remove treasuryRewardCut from ForfeitHandler.sol](https://github.com/code-423n4/2021-11-malt-findings/issues/379) _Submitted by harleythedog, also found by pmerkleplant_\n- [[G-21] Don't try bonding zero liquidity in `RewardReinvestor`](https://github.com/code-423n4/2021-11-malt-findings/issues/101) _Submitted by pmerkleplant_\n- [[G-22] (10000 - thresholdBps) can be pre-calculated](https://github.com/code-423n4/2021-11-malt-findings/issues/369) _Submitted by pauliax_\n- [[G-23] Only use `SafeMath` when necessary can save gas](https://github.com/code-423n4/2021-11-malt-findings/issues/307) _Submitted by WatchPug, also found by pauliax and ScopeLift_\n- [[G-24] Redundant require statements in `Auction:purchaseArbitrageTokens`](https://github.com/code-423n4/2021-11-malt-findings/issues/108) _Submitted by loop, also found by pauliax_\n- [[G-25] ERC20 import](https://github.com/code-423n4/2021-11-malt-findings/issues/364) _Submitted by pauliax_\n- [[G-26] Timelock reuse function argument as argument for the event emit](https://github.com/code-423n4/2021-11-malt-findings/issues/214) _Submitted by GiveMeTestEther, also found by pauliax_\n- [[G-27] `++i` is more gas efficient than `i++`](https://github.com/code-423n4/2021-11-malt-findings/issues/295) _Submitted by WatchPug, also found by defsec, jayjonah8, and pauliax_\n- [[G-28] Similar code in `getCollateralValueInMalt` and `totalUsefulCollateral` functions ](https://github.com/code-423n4/2021-11-malt-findings/issues/180) _Submitted by nathaniel_\n- [[G-29] Duplicated code in `unbond` and `unbondAndBreak` functions](https://github.com/code-423n4/2021-11-malt-findings/issues/178) _Submitted by nathaniel_\n- [[G-30] Auction.userClaimableArbTokens nonzero auction.finalPrice check is redundant](https://github.com/code-423n4/2021-11-malt-findings/issues/49) _Submitted by hyh, also found by nathaniel and shenwilly_\n- [[G-31] Redundant checks](https://github.com/code-423n4/2021-11-malt-findings/issues/316) _Submitted by WatchPug, also found by loop_\n- [[G-32] SwingTrader.costBasis function should have internal version that uses Malt balance from sellMalt](https://github.com/code-423n4/2021-11-malt-findings/issues/73) _Submitted by hyh_\n- [[G-33] SwingTrader: sellMalt and costBasis functions can be simplified](https://github.com/code-423n4/2021-11-malt-findings/issues/72) _Submitted by hyh_\n- [[G-34] Auction.userClaimableArbTokens amountOut calculations can be simplified](https://github.com/code-423n4/2021-11-malt-findings/issues/67) _Submitted by hyh_\n- [[G-35] Auction.userClaimableArbTokens claimablePerc calculations can be simplified](https://github.com/code-423n4/2021-11-malt-findings/issues/50) _Submitted by hyh_\n- [[G-36] Unncessary statement in UniswapHandler.sol removeBuyer](https://github.com/code-423n4/2021-11-malt-findings/issues/377) _Submitted by harleythedog_\n- [[G-37] Invalid equation check on `require`](https://github.com/code-423n4/2021-11-malt-findings/issues/2) _Submitted by hagrid_\n- [[G-38] Gas optimization: Unnecessary return string](https://github.com/code-423n4/2021-11-malt-findings/issues/385) _Submitted by gzeon_\n- [[G-39] Custom size uint is not more efficient than uint256](https://github.com/code-423n4/2021-11-malt-findings/issues/289) _Submitted by 0x0x0x, also found by cmichel and defsec_\n- [[G-40] Checking if `lpProfitCut > 0` can save gas](https://github.com/code-423n4/2021-11-malt-findings/issues/310) _Submitted by WatchPug_\n- [[G-41] `MovingAverage.sol#_getFirstSample()` Implementation can be simpler and save some gas](https://github.com/code-423n4/2021-11-malt-findings/issues/308) _Submitted by WatchPug_\n- [[G-42] AbstractRewardMine._handleStakePadding logic cases can be separated and function simplified](https://github.com/code-423n4/2021-11-malt-findings/issues/131) _Submitted by hyh_\n- [[G-43]  AbstractRewardMine._handleStakePadding calls totalDeclaredReward and this way balanceOf function twice](https://github.com/code-423n4/2021-11-malt-findings/issues/128) _Submitted by hyh_\n- [[G-44] AbstractRewardMine.getRewardOwnershipFraction shouldn't be used internally](https://github.com/code-423n4/2021-11-malt-findings/issues/114) _Submitted by hyh_\n- [[G-45] `AuctionBurnReserveSkew.sol#getRealBurnBudget()` Implementation can be simpler and save some gas](https://github.com/code-423n4/2021-11-malt-findings/issues/306) _Submitted by WatchPug_\n- [[G-46] Returning the named returns is redundant](https://github.com/code-423n4/2021-11-malt-findings/issues/304) _Submitted by WatchPug_\n- [[G-47] `AuctionBurnReserveSkew.sol#getPegDeltaFrequency()` Implementation can be simpler and save some gas](https://github.com/code-423n4/2021-11-malt-findings/issues/301) _Submitted by WatchPug_\n- [[G-48] Cache external call results can save gas](https://github.com/code-423n4/2021-11-malt-findings/issues/300) _Submitted by WatchPug_\n- [[G-49] Unnecessary internal function calls](https://github.com/code-423n4/2021-11-malt-findings/issues/296) _Submitted by WatchPug_\n- [[G-50] Unused storage variables](https://github.com/code-423n4/2021-11-malt-findings/issues/287) _Submitted by WatchPug_\n- [[G-51] Use immutable variable can save gas](https://github.com/code-423n4/2021-11-malt-findings/issues/280) _Submitted by WatchPug_\n- [[G-52] `uint64(block.timestamp % 2**64)` can be simpler and save some gas](https://github.com/code-423n4/2021-11-malt-findings/issues/273) _Submitted by WatchPug_\n- [[G-53] `MovingAverage.sol` Use inline expression can save gas](https://github.com/code-423n4/2021-11-malt-findings/issues/269) _Submitted by WatchPug_\n- [[G-54] Unnecessary event fields](https://github.com/code-423n4/2021-11-malt-findings/issues/5) _Submitted by TomFrench_\n- [[G-55] RewardReinvestor - safeTransfer used unnecessarily on Malt token](https://github.com/code-423n4/2021-11-malt-findings/issues/339) _Submitted by ScopeLift_\n- [[G-56] Various contracts - remove unused function parameters to save gas ](https://github.com/code-423n4/2021-11-malt-findings/issues/331) _Submitted by ScopeLift_\n- [[G-57] Various contracts - stricter function mutability for gas savings](https://github.com/code-423n4/2021-11-malt-findings/issues/330) _Submitted by ScopeLift_\n- [[G-58] AuctionBurnReserveSkew - remove `for` loop from initializer](https://github.com/code-423n4/2021-11-malt-findings/issues/326) _Submitted by ScopeLift_\n- [[G-59] MovingAverage:getValueWithLookback move sampleDiff  to save gas](https://github.com/code-423n4/2021-11-malt-findings/issues/212) _Submitted by GiveMeTestEther_\n- [[G-75] removeVerifier() Repeat SLOAD During Loop Is Waste of Gas](https://github.com/code-423n4/2021-11-malt-findings/issues/117) _Submitted by Meta0xNull_\n- [[G-60] MovingAverage:getValue move the declaration/initialization of sampleDiff to save gas in the case of an early return](https://github.com/code-423n4/2021-11-malt-findings/issues/210) _Submitted by GiveMeTestEther_\n- [[G-74] Avoiding Initialization of Loop Index If It Is 0](https://github.com/code-423n4/2021-11-malt-findings/issues/116) _Submitted by Meta0xNull_\n- [[G-61] MovingAverage:initialize reuse argument variable instead storage variable in the loop condition](https://github.com/code-423n4/2021-11-malt-findings/issues/209) _Submitted by GiveMeTestEther_\n- [[G-62] AuctionBurnReserveSkew:addAbovePegObservation gas optimization](https://github.com/code-423n4/2021-11-malt-findings/issues/153) _Submitted by GiveMeTestEther_\n- [[G-63] AuctionBurnReserveSkew:getRealBurnBudget no underflow check needed](https://github.com/code-423n4/2021-11-malt-findings/issues/152) _Submitted by GiveMeTestEther_\n- [[G-64] Auction:amendAccountParticipation no underflow check needed](https://github.com/code-423n4/2021-11-malt-findings/issues/151) _Submitted by GiveMeTestEther_\n- [[G-65] Auction:claimArbitrage no underflow checks needed](https://github.com/code-423n4/2021-11-malt-findings/issues/149) _Submitted by GiveMeTestEther_\n- [[G-66] Auction:purchaseArbitrageTokens gas optimization](https://github.com/code-423n4/2021-11-malt-findings/issues/147) _Submitted by GiveMeTestEther_\n- [[G-67] RewardThrottle:handleReward gas optimizations](https://github.com/code-423n4/2021-11-malt-findings/issues/144) _Submitted by GiveMeTestEther_\n- [[G-68] RewardDistributor:decrementRewards no underflow check needed](https://github.com/code-423n4/2021-11-malt-findings/issues/143) _Submitted by GiveMeTestEther_\n- [[G-69] RewardDistributor:_incrementFocalPoint() save storage read](https://github.com/code-423n4/2021-11-malt-findings/issues/142) _Submitted by GiveMeTestEther_\n- [[G-70] RewardDistributor:_forfeit no underflow check needed](https://github.com/code-423n4/2021-11-malt-findings/issues/140) _Submitted by GiveMeTestEther_\n- [[G-71] Dont calculate progressionBps, when not needed](https://github.com/code-423n4/2021-11-malt-findings/issues/288) _Submitted by 0x0x0x_\n- [[G-72] AbstractRewardMine.sol#_removeFromStakePadding can be implemented more efficiently](https://github.com/code-423n4/2021-11-malt-findings/issues/284) _Submitted by 0x0x0x_\n- [[G-73] State variables that could be set immutable](https://github.com/code-423n4/2021-11-malt-findings/issues/164) _Submitted by robee, also found by hyh_\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}