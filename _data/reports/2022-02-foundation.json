{
  "circa": {
    "title": "Foundation contest",
    "sponsor": "Foundation",
    "slug": "2022-02-foundation",
    "date": "2022-05-19",
    "findings": "https://github.com/code-423n4/2022-02-foundation-findings/issues",
    "contest": 94
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Foundation smart contract system written in Solidity. The audit contest took place between February 24—March 2 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>34 Wardens contributed reports to the Foundation contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/liam_eastwood13\">leastwood</a></li>\n<li>IllIllI</li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li><a href=\"https://twitter.com/0xliumin\">0xliumin</a></li>\n<li>cccz</li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li>0x1f8b</li>\n<li>hyh</li>\n<li><a href=\"https://twitter.com/JustDravee\">Dravee</a></li>\n<li><a href=\"https://twitter.com/shenwilly_\">shenwilly</a></li>\n<li><a href=\"https://twitter.com/wuwe19\">wuwe1</a></li>\n<li>thankthedark (d4rk and thank_you)</li>\n<li>CertoraInc (<a href=\"https://twitter.com/danbinnun\">danb</a>, egjlmn1, <a href=\"https://twitter.com/ori_dabush\">OriDabush</a>, ItayG, and shakedwinder)</li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li>Afanasyevich</li>\n<li>pedroais</li>\n<li>TerrierLover</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li>hubble (ksk2345 and shri4net)</li>\n<li>kenta</li>\n<li><a href=\"https://www.instagram.com/riyan_rfa/\">rfa</a></li>\n<li>robee</li>\n<li><a href=\"http://twitter.com/isiain\">iain</a></li>\n<li>0xwags</li>\n<li><a href=\"https://twitter.com/kirkthebaird\">kirk-baird</a></li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>jayjonah8</li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/alcueca\">Alberto Cuesta Cañada</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 21 unique vulnerabilities. Of these vulnerabilities, 3 received a risk rating in the category of HIGH severity and 18 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 20 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 11 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-02-foundation\">C4 Foundation contest repository</a>, and is composed of 16 smart contracts written in the Solidity programming language and includes 1,689 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-3\" style=\"position:relative;\"><a href=\"#high-risk-findings-3\" aria-label=\"high risk findings 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (3)</h1>\n<h2 id=\"h-01-nft-owner-can-create-multiple-auctions\" style=\"position:relative;\"><a href=\"#h-01-nft-owner-can-create-multiple-auctions\" aria-label=\"h 01 nft owner can create multiple auctions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/23\">[H-01] NFT owner can create multiple auctions</a></h2>\n<p><em>Submitted by 0xliumin, also found by leastwood</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketReserveAuction.sol#L325-L349\">NFTMarketReserveAuction.sol#L325-L349</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketReserveAuction.sol#L596-L599\">NFTMarketReserveAuction.sol#L596-L599</a><br></p>\n<p>NFT owner can permanently lock funds of bidders.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Alice (the attacker) calls <code>createReserveAuction</code>, and creates one like normal. let this be auction id 1.</p>\n<p>Alice calls <code>createReserveAuction</code> again, before any user has placed a bid (this is easy to guarantee with a deployed attacker contract). We’d expect that Alice wouldn’t be able to create another auction, but she can, because <code>_transferToEscrow</code> doesn’t revert if there’s an existing auction. let this be Auction id 2.</p>\n<p>Since <code>nftContractToTokenIdToAuctionId[nftContract][tokenId]</code> will contain auction id 2, all bidders will see that auction as the one to bid on (unless they inspect contract events or data manually).</p>\n<p>Alice can now cancel auction id 1, then cancel auction id 2, locking up the funds of the last bidder on auction id 2 forever.</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Prevent NFT owners from creating multiple auctions.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/23#issuecomment-1054614690\">NickCuso (Foundation) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This is a great find!</p>\n<p>The impact of this bug is:</p>\n<ul>\n<li>Bidder’s funds are stuck in escrow in an unrecoverable way without an upgrade, and even with an upgrade it would have been non-trivial to offer a migration path to recover the funds (but it would have been possible to recover correctly).</li>\n<li>It allows sellers to stop the clock and/or back out of an auction. Normally once a bid is received we do not allow the seller to cancel the auction. With this bug, they could have created a new auction and then cancel that in order to back out of the deal entirely. This violates trust with collectors.</li>\n</ul>\n<p>We have fixed this problem by adding the following code to <code>createReserveAuction</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// This check must be after _transferToEscrow in case auto-settle was required</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">nftContractToTokenIdToAuctionId</span><span class=\"mtk1\">[</span><span class=\"mtk12\">nftContract</span><span class=\"mtk1\">][</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">] != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NFTMarketReserveAuction_Already_Listed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nftContractToTokenIdToAuctionId</span><span class=\"mtk1\">[</span><span class=\"mtk12\">nftContract</span><span class=\"mtk1\">][</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n</blockquote>\n<hr>\n<h2 id=\"h-02-creators-can-steal-sale-revenue-from-owners-sales\" style=\"position:relative;\"><a href=\"#h-02-creators-can-steal-sale-revenue-from-owners-sales\" aria-label=\"h 02 creators can steal sale revenue from owners sales permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/30\">[H-02] Creators can steal sale revenue from owners’ sales</a></h2>\n<p><em>Submitted by IllIllI</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/a03a7e198c1dfffb1021c0e8ec91ba4194b8aa12/contracts/mixins/NFTMarketCreators.sol#L158-L160\">NFTMarketCreators.sol#L158-L160</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-foundation/blob/a03a7e198c1dfffb1021c0e8ec91ba4194b8aa12/contracts/mixins/NFTMarketCreators.sol#L196-L198\">NFTMarketCreators.sol#L196-L198</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-foundation/blob/a03a7e198c1dfffb1021c0e8ec91ba4194b8aa12/contracts/mixins/NFTMarketCreators.sol#L97-L99\">NFTMarketCreators.sol#L97-L99</a><br></p>\n<p>According to the <a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/README.md?plain=1#L21\"><code>README.md</code></a>:</p>\n<blockquote>\n<p>All sales in the Foundation market will pay the creator 10% royalties on secondary sales. This is not specific to NFTs minted on Foundation, it should work for any NFT. If royalty information was not defined when the NFT was originally deployed, it may be added using the Royalty Registry which will be respected by our market contract.</p>\n</blockquote>\n<p>Using the Royalty Registry an owner can decide to change the royalty information right before the sale is complete, affecting who gets what.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>By updating the registry to include the seller as one of the royalty recipients, the creator can steal the sale price minus fees. This is because if code finds that the seller is a royalty recipient the royalties are all passed to the creator regardless of whether the owner is the seller or not.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// 4th priority: getRoyalties override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">recipients</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">nftContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">supportsERC165Interface</span><span class=\"mtk1\">(</span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IGetRoyalties</span><span class=\"mtk1\">).</span><span class=\"mtk12\">interfaceId</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IGetRoyalties</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nftContract</span><span class=\"mtk1\">).</span><span class=\"mtk12\">getRoyalties</span><span class=\"mtk1\">{ gas: </span><span class=\"mtk12\">READ_ONLY_GAS_LIMIT</span><span class=\"mtk1\"> }(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_recipients</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipientBasisPoints</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_recipients</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_recipients</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">recipientBasisPoints</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hasRecipient</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_recipients</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_recipients</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">hasRecipient</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_recipients</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] == </span><span class=\"mtk12\">seller</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_recipients</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recipientBasisPoints</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L127-L154\">https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L127-L154</a></p>\n<p>When <code>true</code> is returned as the final return value above, the following code leaves <code>ownerRev</code> as zero because <code>isCreator</code> is <code>true</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ownerRev</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isCreator</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">creatorRecipients</span><span class=\"mtk1\">, </span><span class=\"mtk12\">creatorShares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">isCreator</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">_getCreatorPaymentInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nftContract</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">seller</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Calculate the Foundation fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isCreator</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">_nftContractToTokenIdToFirstSaleCompleted</span><span class=\"mtk1\">[</span><span class=\"mtk12\">nftContract</span><span class=\"mtk1\">][</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">PRIMARY_FOUNDATION_FEE_BASIS_POINTS</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">SECONDARY_FOUNDATION_FEE_BASIS_POINTS</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">foundationFee</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">price</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">BASIS_POINTS</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">creatorRecipients</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isCreator</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// When sold by the creator, all revenue is split if applicable.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">creatorRev</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">foundationFee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Rounding favors the owner first, then creator, and foundation last.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">creatorRev</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">price</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">CREATOR_ROYALTY_BASIS_POINTS</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">BASIS_POINTS</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ownerRevTo</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">seller</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ownerRev</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">foundationFee</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">creatorRev</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// No royalty recipients found.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ownerRevTo</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">seller</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ownerRev</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">foundationFee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>In addition, if the index of the seller in <code>_recipients</code> is greater than <code>MAX_ROYALTY_RECIPIENTS_INDEX</code>, then the seller is omitted from the calculation and gets zero (<code>_sendValueWithFallbackWithdraw()</code> doesn’t complain when it sends zero).</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxCreatorIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">creatorRecipients</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">maxCreatorIndex</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">MAX_ROYALTY_RECIPIENTS_INDEX</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">maxCreatorIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">MAX_ROYALTY_RECIPIENTS_INDEX</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L76-L79\">https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L76-L79</a></p>\n<p>This issue does a lot of damage because the creator can choose whether and when to apply it on a sale-by-sale basis. Two other similar, but separate, exploits are available for the other blocks in <code>_getCreatorPaymentInfo()</code> that return arrays but they either require a malicious NFT implementation or can only specify a static seller for which this will affect things. In all cases, not only may the seller get zero dollars for the sale, but they’ll potentially owe a lot of taxes based on the ‘sale’ price. The attacker may or may not be the creator - creators can be bribed with kickbacks.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Always calculate owner/seller revenue separately from royalty revenue.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/30#issuecomment-1060623733\">NickCuso (Foundation) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This is a great discovery and a creative way for creators to abuse the system, stealing funds from a secondary sale. Thank you for reporting this.</p>\n<p>It’s a difficult one for us to address. We want to ensure that NFTs minted on our platform as a split continue to split revenue from the initial sale. We were using <code>isCreator</code> from <code>_getCreatorPaymentInfo</code> as our way of determining if all the revenue from a sale should go to the royalty recipients, which is a split contract for the use case we are concerned about here.</p>\n<p>The royalty override makes it easy for a creator to choose to abuse this feature at any time. So that was our primary focus for this fix.</p>\n<p>This is the change we have made in <code>_getFees</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isCreator</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// lookup for tokenCreator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ITokenCreator</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nftContract</span><span class=\"mtk1\">).</span><span class=\"mtk12\">tokenCreator</span><span class=\"mtk1\">{ gas: </span><span class=\"mtk12\">READ_ONLY_GAS_LIMIT</span><span class=\"mtk1\"> }(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_creator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">isCreator</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_creator</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">seller</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// solhint-disable-next-line no-empty-blocks</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Fall through</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">creatorRecipients</span><span class=\"mtk1\">, </span><span class=\"mtk12\">creatorShares</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">_getCreatorPaymentInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nftContract</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Since the royalty override is only considered in <code>_getCreatorPaymentInfo</code> we are no longer vulnerable to someone adding logic after the NFT has been released to try and rug pull the current owner(s).</p>\n<p>It is still possible for someone to try and abuse this logic, but to do so they must have built into the NFT contract itself a way to lie about who the <code>tokenCreator</code> is before the time of a sale. If we were to detect this happening, we would moderate that collection from the Foundation website. Additionally we will think about a longer term solution here so that this type of attack is strictly not possible with our market contract.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-03-an-offer-made-after-auction-end-can-be-stolen-by-an-auction-winner\" style=\"position:relative;\"><a href=\"#h-03-an-offer-made-after-auction-end-can-be-stolen-by-an-auction-winner\" aria-label=\"h 03 an offer made after auction end can be stolen by an auction winner permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/49\">[H-03] An offer made after auction end can be stolen by an auction winner</a></h2>\n<p><em>Submitted by hyh, also found by leastwood, shenwilly, and WatchPug</em></p>\n<p>An Offer which is made for an NFT when auction has ended, but its winner hasn’t received the NFT yet, can be stolen by this winner as <code>_transferFromEscrow</code> being called by <code>_acceptOffer</code> will transfer the NFT to the winner, finalising the auction, while no transfer to the user who made the offer will happen.</p>\n<p>This way the auction winner will obtain both the NFT and the offer amount after the fees at no additional cost, at the expense of the user who made the offer.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When an auction has ended, there is a possibility to make the offers for an auctioned NFT as:</p>\n<p><code>makeOffer</code> checks <code>_isInActiveAuction</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L200\">https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L200</a></p>\n<p><code>_isInActiveAuction</code> returns false when <code>auctionIdToAuction[auctionId].endTime &#x3C; block.timestamp</code>, so <code>makeOffer</code> above can proceed:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketReserveAuction.sol#L666-L669\">https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketReserveAuction.sol#L666-L669</a></p>\n<p>Then, the auction winner can call <code>acceptOffer -> _acceptOffer</code> (or <code>setBuyPrice -> _autoAcceptOffer -> _acceptOffer</code>).</p>\n<p><code>_acceptOffer</code> will try to transfer directly, and then calls <code>_transferFromEscrow</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L262-L271\">https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L262-L271</a></p>\n<p>If the auction has ended, but a winner hasn’t picked up the NFT yet, the direct transfer will fail, proceeding with <code>_transferFromEscrow</code> in the FNDNFTMarket defined order:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _transferFromEscrow(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">address nftContract,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 tokenId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">address recipient,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">address seller</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">) internal override(NFTMarketCore, NFTMarketReserveAuction, NFTMarketBuyPrice, NFTMarketOffer) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">super._transferFromEscrow(nftContract, tokenId, recipient, seller);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>NFTMarketOffer._transferFromEscrow will call super as <code>nftContractToIdToOffer</code> was already deleted:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L296-L302\">https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L296-L302</a></p>\n<p>NFTMarketBuyPrice._transferFromEscrow will call super as there is no buy price set:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketBuyPrice.sol#L283-L293\">https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketBuyPrice.sol#L283-L293</a></p>\n<p>Finally, NFTMarketReserveAuction._transferFromEscrow will send the NFT to the winner via <code>_finalizeReserveAuction</code>, not to the user who made the offer:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketReserveAuction.sol#L556-L560\">https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketReserveAuction.sol#L556-L560</a></p>\n<p>The <code>recipient</code> user who made the offer is not present in this logic, the NFT is being transferred to the <code>auction.bidder</code>, and the original <code>acceptOffer</code> will go through successfully.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>An attempt to set a buy price from auction winner will lead to auction finalisation, so <code>_buy</code> cannot be called with a not yet finalised auction, this way the NFTMarketReserveAuction._transferFromEscrow L550-L560 logic is called from the NFTMarketOffer._acceptOffer only:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L270\">https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L270</a></p>\n<p>is the only user of</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketReserveAuction.sol#L550-L560\">https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketReserveAuction.sol#L550-L560</a></p>\n<p>This way the fix is to update L556-L560 for the described case as:</p>\n<p>Now:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// Finalization will revert if the auction has not yet ended.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">_finalizeReserveAuction(auctionId, false);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// Finalize includes the transfer, so we are done here.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">return;</span></span></code></pre>\n<p>To be, we leave the NFT in the escrow and let L564 super call to transfer it to the recipient:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// Finalization will revert if the auction has not yet ended.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">_finalizeReserveAuction(auctionId, true);</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/49#issuecomment-1060649574\">NickCuso (Foundation) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Yes! This was a great find and a major issue with our implementation. I’m very happy that it was flagged by a few different people, it helps raise our confidence that several wardens really dove into the code.</p>\n<p>It was a big miss on our part that this was not thoroughly tested. Our tests for this scenario confirmed the events and payouts, but did not validate the ownership in the end!</p>\n<p>The proposed fix is perfect and exactly what we have implemented. This follows the patterns we established well, and actually simplifies the logic here so that things are easier to reason about.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-18\" style=\"position:relative;\"><a href=\"#medium-risk-findings-18\" aria-label=\"medium risk findings 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (18)</h1>\n<h2 id=\"m-01-eip-712-signatures-can-be-re-used-in-private-sales\" style=\"position:relative;\"><a href=\"#m-01-eip-712-signatures-can-be-re-used-in-private-sales\" aria-label=\"m 01 eip 712 signatures can be re used in private sales permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/68\">[M-01] EIP-712 signatures can be re-used in private sales</a></h2>\n<p><em>Submitted by thankthedark, also found by Afanasyevich and cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketPrivateSale.sol#L123-L174\">NFTMarketPrivateSale.sol#L123-L174</a><br></p>\n<p>Within a NFTMarketPrivateSale contract, buyers are allowed to purchase a seller’s NFT. This is done through a seller providing a buyer a EIP-712 signature. The buyer can then call <code>#buyFromPrivateSaleFor</code> providing the v, r, and s values of the signature as well as any additional details to generate the message hash. If the signature is valid, then the NFT is transferred to the buyer.</p>\n<p>The problem with the code is that EIP-712 signatures can be re-used within a small range of time assuming that the original seller takes back ownership of the NFT. This is because the NFTMarketPrivateSale#buyFromPrivateSaleFor method has no checks to determine if the EIP-712 signature has been used before.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Consider the following example:</p>\n<ol>\n<li>Joe the NFT owner sells a NFT to the malicious buyer Rachel via a private sale.</li>\n<li>Rachel through this private sale obtains the EIP-712 signature and uses it to purchase a NFT.</li>\n<li>Joe the NFT owner purchases back the NFT within two days of the original sale to Rachel.</li>\n<li>Joe the NFT owner puts the NFT back on sale.</li>\n<li>Rachel, who has the original EIP-712 signature, can re-purchase the NFT by calling <code>#buyFromPrivateSaleFor</code> again with the same parameters they provided in the original private sale purchase in step 1.</li>\n</ol>\n<p>The <code>#buyFromPrivateSaleFor</code> <a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketPrivateSale.sol#L123\">function</a> runs several validation checks before transferring the NFT over to the buyer. The validations are as follows:</p>\n<ol>\n<li>L#132 - The signature has expired.</li>\n<li>L#135 - The deadline is beyond 48 hours from now.</li>\n<li>L#143 - The amount argument is greater than msg.value.</li>\n<li>L#149 - The msg.value is greater than the amount set.</li>\n<li>L#171 - This checks that the EIP-712 signature comes from the NFT seller.</li>\n</ol>\n<p>As you can see, there are no checks that the EIP-712 signature has been used before. If the original NFT seller purchases back the NFT, then they are susceptible to having the original buyer taking back the NFT. This can be problematic if the NFT has risen in value, as the original buyer can utilize the same purchase amount from the first transaction in this malicious transaction.</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Most contracts utilize nonces when generating EIP-712 signatures to ensure that the contract hasn’t been used for. When a nonce is injected into a signature, it makes it impossible for re-use, assuming of course the nonce feature is done correctly.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/68#issuecomment-1057990473\">NickCuso (Foundation) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Yes, this is a good point to raise and something like this could happen because it’s not intuitive to think that the private sale remains valid after it’s been used.</p>\n<p>This is mitigated by the short time window we use for Private Sales. Our frontend uses 24-hour expirations and in the contract we ensure the window is &#x3C;= 48 hours.</p>\n<p>In order to remain backwards compatible with our existing integration and any signatures which are outstanding at the time of the upgrade, we decided not to use <code>nonce</code> as recommended. Instead we simply store a mapping tracking if the exact private sale terms have already been used.</p>\n<p>Here’s the primary addition:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Ensure that the offer can only be accepted once.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">privateSaleInvalidated</span><span class=\"mtk1\">[</span><span class=\"mtk12\">nftContract</span><span class=\"mtk1\">][</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">][</span><span class=\"mtk12\">seller</span><span class=\"mtk1\">][</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">][</span><span class=\"mtk12\">deadline</span><span class=\"mtk1\">]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NFTMarketPrivateSale_Signature_Canceled_Or_Already_Claimed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">privateSaleInvalidated</span><span class=\"mtk1\">[</span><span class=\"mtk12\">nftContract</span><span class=\"mtk1\">][</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">][</span><span class=\"mtk12\">seller</span><span class=\"mtk1\">][</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">][</span><span class=\"mtk12\">deadline</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span></code></pre>\n</blockquote>\n<hr>\n<h2 id=\"m-02-sendvaluewithfallbackwithdraw-withdrawfor-function-may-fail-to-withdraw-ether-recorded-in-pendingwithdrawals\" style=\"position:relative;\"><a href=\"#m-02-sendvaluewithfallbackwithdraw-withdrawfor-function-may-fail-to-withdraw-ether-recorded-in-pendingwithdrawals\" aria-label=\"m 02 sendvaluewithfallbackwithdraw withdrawfor function may fail to withdraw ether recorded in pendingwithdrawals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/12\">[M-02] <code>SendValueWithFallbackWithdraw</code>: <code>withdrawFor</code> function may fail to withdraw ether recorded in <code>pendingWithdrawals</code></a></h2>\n<p><em>Submitted by cccz</em></p>\n<p>The NFTMarketFees contract and the NFTMarketReserveAuction contract use the _sendValueWithFallbackWithdraw function to send ether to FoundationTreasury, CreatorRecipients, Seller, Bidder.\nWhen the receiver fails to receive due to some reasons (exceeding the gas limit or the receiver contract cannot receive ether), it will record the ether to be sent in the pendingWithdrawals variable.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _sendValueWithFallbackWithdraw(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address payable user,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 gasLimit</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (amount == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Cap the gas to prevent consuming all available gas to block a tx from completing successfully</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // solhint-disable-next-line avoid-low-level-calls</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (bool success, ) = user.call{ value: amount, gas: gasLimit }(&quot;&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (!success) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Record failed sends for a withdrawal later</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Transfers could fail if sent to a multisig with non-trivial receiver logic</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pendingWithdrawals[user] += amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      emit WithdrawPending(user, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>The user can then withdraw ether via the withdraw or withdrawFor functions.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function withdraw() external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    withdrawFor(payable(msg.sender));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function withdrawFor(address payable user) public nonReentrant {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 amount = pendingWithdrawals[user];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (amount == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      revert SendValueWithFallbackWithdraw_No_Funds_Available();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pendingWithdrawals[user] = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    user.sendValue(amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit Withdrawal(user, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>However, the withdrawFor function can only send ether to the address recorded in pendingWithdrawals. When the recipient is a contract that cannot receive ether, these ethers will be locked in the contract and cannot be withdrawn.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/SendValueWithFallbackWithdraw.sol#L37-L77\">https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/SendValueWithFallbackWithdraw.sol#L37-L77</a></p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add the withdrawTo function as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function withdrawTo(address payable to) public nonReentrant {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 amount = pendingWithdrawals[msg.sneder];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (amount == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      revert SendValueWithFallbackWithdraw_No_Funds_Available();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pendingWithdrawals[msg.sneder] = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    to.sendValue(amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit Withdrawal(msg.sneder, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/12#issuecomment-1051183216\">NickCuso (Foundation) confirmed, but disagreed with High severity and commented</a>:</strong></p>\n<blockquote>\n<p>We believe this is better classified as a <code>2 (Med Risk)</code>.</p>\n<ul>\n<li>Worst case is funds for a user are trapped in escrow, however they are correctly attributed to that user and cannot be accessed by any other account. If we did not address this by launch, the issue could be corrected post launch via a contract upgrade and that user would then be made whole. So the funds are just temporarily unavailable to them.</li>\n</ul>\n<p>This is a great report and we will be making a change to address the problem!</p>\n<p>When reviewing the recommended mitigation we identified a new potential risk that could introduce. So we are going a slightly different way…</p>\n<p>The <code>_sendValueWithFallbackWithdraw</code> function will send <code>FETH</code> tokens when it fails to transfer ETH. For any account that currently has a non-zero <code>pendingWithdrawals</code> we will include a migration function allowing us to move the escrowed ETH out of the market contract and into that user’s FETH account. </p>\n<p>Once that migration has been completed, we will delete the migration function and withdraw* functions — simplifying the market contract and freeing up much needed contract size to make room for new features in the future.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/12#issuecomment-1072299920\">Alberto Cuesta Cañada (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The combination of upgradability with the limited scope of the vulnerability makes it reasonable to downgrade this to a medium severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-approve-race-condition-in-feth\" style=\"position:relative;\"><a href=\"#m-03-approve-race-condition-in-feth\" aria-label=\"m 03 approve race condition in feth permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/14\">[M-03] Approve race condition in FETH</a></h2>\n<p><em>Submitted by 0x1f8b</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/FETH.sol#L212\">FETH.sol#L212</a><br></p>\n<p>Front running attack in approve.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The contract of the <code>FETH</code> does not have any protection against the well-known “Multiple Withdrawal Attack” attack on the Approve/TransferFrom methods of the ERC20 standard.</p>\n<p>Although this attack poses a limited risk in specific situations, it is worth mentioning to consider it for possible future operations.</p>\n<p>There are solutions to mitigate this front running such as, to first reduce the spender’s allowance to 0 and set the desired value afterwards; another solution could the one that Open Zeppelin offers, where the non-standard decreaseAllowance and increaseAllowance functions have been added to mitigate the well-known issues involving setting allowances.</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add increase and decrease allowance.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/14#issuecomment-1060614467\">NickCuso (Foundation) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Yes, this is a good best practice to be following. We will add these functions in the near future. In the meantime we’ve added an inline comment about the potential risk.</p>\n<p>At first we don’t expect there will be much interest in using FETH outside of Foundation itself. Thanks to the trusted relationship with the market contract, approvals are not necessary. So this is not an issue that should come up in the near term.</p>\n<p>We are not fixing this immediately because it introduces a risk associated with another contract our users have deployed, that contract was not part of the contest repo. We are looking to patch that vulnerability and then will add <code>increaseAllowance</code> to FETH.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-adminaccountmigration-does-not-update-buypriceseller\" style=\"position:relative;\"><a href=\"#m-04-adminaccountmigration-does-not-update-buypriceseller\" aria-label=\"m 04 adminaccountmigration does not update buypriceseller permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/87\">[M-04] <code>adminAccountMigration()</code> Does Not Update <code>buyPrice.seller</code></a></h2>\n<p><em>Submitted by leastwood, also found by cccz</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketReserveAuction.sol#L263-L292\">NFTMarketReserveAuction.sol#L263-L292</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketBuyPrice.sol#L125-L141\">NFTMarketBuyPrice.sol#L125-L141</a><br></p>\n<p>The <code>adminAccountMigration()</code> function is called by the operator role to update all sellers’ auctions. The <code>auction.seller</code> account is updated to the new address, however, the protocol fails to update <code>buyPrice.seller</code>. As a result, the protocol is put in a deadlock situation where the new address cannot cancel the auction and withdraw their NFT without the compromised account first cancelling the buy price and vice-versa. This is only recoverable if the new account is migrated back to the compromised account and then <code>cancelBuyPrice()</code> is called before migrating back.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider invalidating the buy offer before account migration.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/87#issuecomment-1060628220\">NickCuso (Foundation) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Correct - if we were to use <code>adminAccountMigration</code> while the NFT had both an auction reserve price and had a buy price set this would have created a deadlock type situation where the NFT is in a bad state and we’d likely need to migrate the NFT back to the original owner in order to correct it.</p>\n<p>There were two possible solutions to this:</p>\n<ul>\n<li>Update <code>adminAccountMigration</code> to update both auction and buy price at the same time.</li>\n<li>Cut <code>adminAccountMigration</code> completely.</li>\n</ul>\n<p>We went with the latter solution. This is not a feature we have used in some time and as we continue to grow, it’s not scalable since it required Foundation to get involved directly and included manual verification steps.</p>\n<p>Removing this feature has saved over 2KB in contract space as well, which we really needed in order to make room for new features and changes.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-exchange-does-not-split-royalty-revenue-correctly\" style=\"position:relative;\"><a href=\"#m-05-exchange-does-not-split-royalty-revenue-correctly\" aria-label=\"m 05 exchange does not split royalty revenue correctly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/29\">[M-05] Exchange does not split royalty revenue correctly</a></h2>\n<p><em>Submitted by IllIllI</em></p>\n<p>According to the <a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/README.md?plain=1#L21\"><code>README.md</code></a>:</p>\n<blockquote>\n<p>If royalty information was not defined when the NFT was originally deployed, it may be added using the Royalty Registry which will be respected by our market contract.</p>\n</blockquote>\n<p>The actual exchange code only respects the Royalty Registry or other royalty information if the number of recipients is less than or equal to four.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>If the <code>creatorRecipients.length</code> is more than four then the array is essentially truncated and the royalties are only split among the first four entries in the array. If the array happens to be sorted from low to high then the people who were supposed to get the largest portions of the royalties are given nothing.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxCreatorIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">creatorRecipients</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">maxCreatorIndex</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">MAX_ROYALTY_RECIPIENTS_INDEX</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">maxCreatorIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">MAX_ROYALTY_RECIPIENTS_INDEX</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L76-L79\">https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L76-L79</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Send payouts to each additional recipient if more than 1 was defined</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalDistributed</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">maxCreatorIndex</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">share</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">creatorFee</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">creatorShares</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]) / </span><span class=\"mtk12\">totalShares</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">totalDistributed</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">share</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk11\">_sendValueWithFallbackWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">creatorRecipients</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk12\">share</span><span class=\"mtk1\">, </span><span class=\"mtk12\">SEND_VALUE_GAS_LIMIT_MULTIPLE_RECIPIENTS</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L99-L105\">https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L99-L105</a></p>\n<p>Creators shouldn’t have to settle the correct amounts amongst themselves afterwards and doing so may trigger unwanted tax consequences for the creators who got the larger shares of funds.</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Fetch the royalty information during offer creation, cache it for the final transfer, and reject any NFT for which the array size is more than <code>MAX_ROYALTY_RECIPIENTS_INDEX</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/29#issuecomment-1055329404\">NickCuso (Foundation) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Yes, this is correct. This behavior is intended — however we should be more clear about that in the readme and inline comments. I’ll add some comments inline to clarify.</p>\n<p>The reason we have a cap at all is because any number of addresses could be returned by these APIs. That would be okay if the creator themselves always paid the gas costs to process them, but since the costs are often pushed to the collectors or secondary sellers - we wanted to ensure the worst case scenario never got unreasonably expensive.</p>\n<p>The actual limit we put in place is arbitrary. However some limit is necessary to ensure a reasonable experience for our users.</p>\n<p>If the creator does want payouts to go to many different addresses, the recommended approach would be to send the royalties to a contract with then handles the split internally in a gas efficient manner, e.g. with <a href=\"https://www.0xsplits.xyz/\">https://www.0xsplits.xyz/</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-buyfromprivatesalefor-will-fail-if-the-buyer-has-insufficient-balance-due-to-an-open-offer-on-the-same-nft\" style=\"position:relative;\"><a href=\"#m-06-buyfromprivatesalefor-will-fail-if-the-buyer-has-insufficient-balance-due-to-an-open-offer-on-the-same-nft\" aria-label=\"m 06 buyfromprivatesalefor will fail if the buyer has insufficient balance due to an open offer on the same nft permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/77\">[M-06] <code>buyFromPrivateSaleFor()</code> Will Fail if The Buyer Has Insufficient Balance Due to an Open Offer on The Same NFT</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketPrivateSale.sol#L143-L150\">NFTMarketPrivateSale.sol#L143-L150</a><br></p>\n<p>The <code>buyFromPrivateSaleFor()</code> function allows sellers to make private sales to users. If insufficient <code>ETH</code> is provided to the function call, the protocol will attempt to withdraw the amount difference from the user’s unlocked balance. However, if the same user has an open offer on the same NFT, then these funds will remain locked until expiration. As a result, the user cannot make use of these locked funds even though they may be needed for a successful sale.</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding a <code>_cancelBuyersOffer()</code> call to the <code>buyFromPrivateSaleFor()</code> function. This should be added only to the case where insufficient <code>ETH</code> was provided to the trade. By cancelling the buyer’s offer on the same NFT, we can guarantee that the user has access to the correct amount of funds.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/77#issuecomment-1058017830\">NickCuso (Foundation) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Yes - completely agree. This was an oversight on our end - and as a result it created an inconsistent experience for users. Since we leveraged an outstanding offer balance for a <code>buy</code> purchase, the same behavior should occur when using Private Sales so that user’s are not in a state where they cannot make the purchase due to incorrectly having their funds locked up.</p>\n<p>As you point out without this change, it’s possible that the buyer using private sales continues to have their funds locked up for an Offer that can now only be accepted by themselves. It’s an awkward state that should be avoided.</p>\n<p>We have made the recommended change.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-_getcreatorpaymentinfo-is-not-equipped-to-handle-reverts-on-an-unbounded-_recipients-array\" style=\"position:relative;\"><a href=\"#m-07-_getcreatorpaymentinfo-is-not-equipped-to-handle-reverts-on-an-unbounded-_recipients-array\" aria-label=\"m 07 _getcreatorpaymentinfo is not equipped to handle reverts on an unbounded _recipients array permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/85\">[M-07] <code>_getCreatorPaymentInfo()</code> is Not Equipped to Handle Reverts on an Unbounded <code>_recipients</code> Array</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketCreators.sol#L49-L251\">NFTMarketCreators.sol#L49-L251</a><br></p>\n<p>The <code>_getCreatorPaymentInfo()</code> function is utilised by <code>_distributeFunds()</code> whenever an NFT sale is made. The function uses <code>try</code> and <code>catch</code> statements to handle bad API endpoints. As such, a revert in this function would lead to NFTs that are locked in the contract. Some API endpoints receive an array of recipient addresses which are iterated over. If for whatever reason the function reverts inside of a <code>try</code> statement, the revert is actually not handled and it will not fall through to the empty <code>catch</code> statement.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The end result is that valid and honest NFT contracts may revert if the call runs out of gas due to an unbounded <code>_recipients</code> array. <code>try</code> statements are only able to handle external calls.</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider bounding the number of iterations to <code>MAX_ROYALTY_RECIPIENTS_INDEX</code> as this is already enforced by <code>_distributeFunds()</code>. It may be useful to identify other areas where the <code>try</code> statement will not handle reverts on internal calls.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/85#issuecomment-1062826549\">NickCuso (Foundation) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Yes - this code is trying to be very defensive so that NFTs cannot get stuck in escrow. This is a great suggestion on how we could continue to improve.</p>\n<p>Instead of capping the loop lengths in <code>_getCreatorPaymentInfo</code> we have opted to remove them entirely. There was another simplification that happened recently to this function that made removal a viable option. Now the only other loop for this data is in _distributeFunds and we already cap the max length there.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-primary-seller-can-avoid-paying-the-primary-fee\" style=\"position:relative;\"><a href=\"#m-08-primary-seller-can-avoid-paying-the-primary-fee\" aria-label=\"m 08 primary seller can avoid paying the primary fee permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/39\">[M-08] Primary seller can avoid paying the primary fee</a></h2>\n<p><em>Submitted by pedroais, also found by leastwood and WatchPug</em></p>\n<p>A primary seller can circumvent the 15% fee and pay 5% as a secondary seller.</p>\n<h3 id=\"context\" style=\"position:relative;\"><a href=\"#context\" aria-label=\"context permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Context</h3>\n<p>The Foundation protocol charges a 15% fee if the sale is a primary sale and 5% if it’s a secondary sale.<br>\n<a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L40\">https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L40</a></p>\n<p>There are 2 conditions that must be met for a sale to be considered primary:</p>\n<ol>\n<li>The seller is one of the creators in the NFT metadata.</li>\n<li>It’s the first time this NFT is sold on the foundation protocol.</li>\n</ol>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L188\">https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L188</a></p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Both of these conditions can be easily circumvented by the primary seller.</p>\n<ol>\n<li>He could transfer the NFT to a different wallet and sell it from there to break the first condition.</li>\n<li>He can make a private sale to himself for 1$  (paying the 15% fee on a dust amount) and then do a public auction with the real price.</li>\n</ol>\n<p>With any of these 2 methods, the primary seller can circumvent the 15% fee and pay 5% as a secondary seller which makes the primary seller fee optional to pay.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/39#issuecomment-1057366311\">NickCuso (Foundation) acknowledged amd commented</a>:</strong></p>\n<blockquote>\n<p>Yes, this <strong>is</strong> possible. It’s a good limitation to note and we should have it called out as a known issue / potential abuse path.</p>\n<p>It’s not clear how we could avoid this though while still keeping primary fees around - so I think all we can do is document it for now. This has been true since our launch a year ago and we are not aware of anyone abusing it yet. We think that’s because NFT provenance is very important, so if it was being sold from a different account than the creator it’s possible that would not get as much attention and potentially sell for less than they could have gotten accepting the primary sale fee.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-missing-receiver-validation-in-withdrawfrom\" style=\"position:relative;\"><a href=\"#m-09-missing-receiver-validation-in-withdrawfrom\" aria-label=\"m 09 missing receiver validation in withdrawfrom permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/42\">[M-09] Missing receiver validation in <code>withdrawFrom</code></a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/FETH.sol#L433\">FETH.sol#L433</a><br></p>\n<p>The <code>FETH.withdrawFrom</code> function does not validate its <code>to</code> parameter.<br>\nFunds can be lost if <code>to</code> is the zero address.</p>\n<blockquote>\n<p>Similar issues have been judged as medium recently, see <a href=\"https://code4rena.com/reports/2022-01-sandclock/\">Sandclock M-15</a> / <a href=\"https://github.com/code-423n4/2022-01-sandclock-findings/issues/183#issuecomment-1024626171\">Github issue</a>.</p>\n</blockquote>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Check that <code>to != 0</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/42#issuecomment-1057368552\">NickCuso (Foundation) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Yes, this is a good recommendation which may prevent users losing their funds due to user error. We have made the following change as recommended:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">to</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FETH_Cannot_Withdraw_To_Address_Zero</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">to</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FETH_Cannot_Withdraw_To_FETH</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n</blockquote>\n<hr>\n<h2 id=\"m-10-lockedbalance-library-should-drop-parameters-to-9632-bits\" style=\"position:relative;\"><a href=\"#m-10-lockedbalance-library-should-drop-parameters-to-9632-bits\" aria-label=\"m 10 lockedbalance library should drop parameters to 9632 bits permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/44\">[M-10] <code>LockedBalance</code> library should drop parameters to 96/32 bits</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/libraries/LockedBalance.sol#L56\">LockedBalance.sol#L56</a><br></p>\n<p>The <code>LockedBalance</code> contract takes 256-bit amount values but performs bit math on them as if they were 96 bit values.\nBits could spill over to a different locked balance in the <code>else</code> part (<code>lockedBalance</code> stores <strong>two</strong> 128-bit locked balances in one 256-bit storage field):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">set</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">Lockups</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lockups</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expiration</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit-issue should drop totalAmount to 96, expiration to 128-96=32</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lockedBalanceBits</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalAmount</span><span class=\"mtk1\"> | (</span><span class=\"mtk12\">expiration</span><span class=\"mtk1\"> &lt;&lt; </span><span class=\"mtk7\">96</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">index</span><span class=\"mtk1\"> % </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// set first 128 bits.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">index</span><span class=\"mtk1\"> /= </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// @audit-info clears upper bits, then sets them</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">lockups</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lockups</span><span class=\"mtk1\">[</span><span class=\"mtk12\">index</span><span class=\"mtk1\">] = (</span><span class=\"mtk12\">lockups</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lockups</span><span class=\"mtk1\">[</span><span class=\"mtk12\">index</span><span class=\"mtk1\">] &amp; </span><span class=\"mtk12\">last128BitsMask</span><span class=\"mtk1\">) | (</span><span class=\"mtk12\">lockedBalanceBits</span><span class=\"mtk1\"> &lt;&lt; </span><span class=\"mtk7\">128</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// set last 128 bits.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">index</span><span class=\"mtk1\"> /= </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// @audit-info clears lower bits, then sets them</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// @audit-issue sets entire 256-bit lockedBalanceBits instead of just 128-bit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">lockups</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lockups</span><span class=\"mtk1\">[</span><span class=\"mtk12\">index</span><span class=\"mtk1\">] = (</span><span class=\"mtk12\">lockups</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lockups</span><span class=\"mtk1\">[</span><span class=\"mtk12\">index</span><span class=\"mtk1\">] &amp; </span><span class=\"mtk12\">first128BitsMask</span><span class=\"mtk1\">) | </span><span class=\"mtk12\">lockedBalanceBits</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>It could then increase the other, unrelated locked balance’s amount leading to stealing funds from the protocol.\nAll callers of this function currently seem to ensure that <code>totalAmount</code> is indeed less than 96 bits but the <code>LockedBalance</code> library should be self-contained and not depend on the calling side to perform all checks.<br></p>\n<p>If the code is ever extended and more calls to these functions are performed, it’ll likely cause issues.</p>\n<blockquote>\n<p>The same issue happens in <code>setTotalAmount</code></p>\n</blockquote>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Make sure that there are only 96/32 bits set in <code>totalAmount</code> and <code>expiration</code> by dropping them to their respective types.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">function set(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Lockups storage lockups,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  uint256 index,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  uint256 expiration,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  uint256 totalAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) internal {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256 lockedBalanceBits = totalAmount | (expiration &lt;&lt; 96);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    // cast it to uint256 again for the &lt;&lt; 96 to work on 256-bits</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 lockedBalanceBits = uint256(uint96(totalAmount)) | (uint256(uint32(expiration)) &lt;&lt; 96);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/44#issuecomment-1060632719\">NickCuso (Foundation) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>This is a good concern to flag. With this release we use a lot of slot packing strategies to try and save gas. We considered this suggestion, as well as potentially using the safe cast helpers from the OpenZeppelin library. For the moment at least, we decided not to make any changes here. We believe the assumptions behind these values are sound, and although it’s mathematically possible for the assumptions to be violated, we don’t believe it’ll occur in production.</p>\n<p>For <code>totalAmount</code> for example, that value is always bound by the amount of ETH a user has sent to the FETH contract. Here are some notes we have written up about the size assumptions in our codebase:</p>\n<ul>\n<li>\n<p>ETH: uint96</p>\n<ul>\n<li>Circulating supply is currently 119,440,269 ETH (119440269000000000000000000 wei / 1.2 * 10^26).</li>\n<li>Max uint96 is 7.9 * 10^28.</li>\n<li>Therefore any value capped by msg.value should never overflow uint96 assuming ETH total supply remains under 70,000,000,000 ETH.</li>\n<li>There is currently ~2% inflation in ETH total supply (which fluctuates) and this value is expected to do down. We expect Ether will become deflationary before the supply reaches more than 500x current values.</li>\n<li>96 bits packs perfectly into a single slot with an address.</li>\n</ul>\n</li>\n<li>\n<p>Dates: uint32</p>\n<ul>\n<li>Current date in seconds is 1643973923 (1.6 * 10^9).</li>\n<li>Max uint32 is 4 * 10^9.</li>\n<li>Dates will not overflow uint32 until 2104.</li>\n<li>To ensure we don’t behave unexpectedly in the future, we should require dates are &#x3C;= max uint32.</li>\n<li>uint40 would allow enough space for any date, but it’s an awkward size to pack with.</li>\n</ul>\n</li>\n<li>\n<p>Sequence ID indexes: uint32</p>\n<ul>\n<li>Our max sequence ID today is 149,819 auctions.</li>\n<li>Max uint32 is 4 * 10^9.</li>\n<li>Indexes will not overflow uint32 until we see >28,000x growth. This is the equiv to ~300 per block for every block in Ethereum to date.</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<hr>\n<h2 id=\"m-11-max_royalty_recipients_index-set-too-low\" style=\"position:relative;\"><a href=\"#m-11-max_royalty_recipients_index-set-too-low\" aria-label=\"m 11 max_royalty_recipients_index set too low permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/45\">[M-11] <code>MAX_ROYALTY_RECIPIENTS_INDEX</code> set too low</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L78\">NFTMarketFees.sol#L78</a><br></p>\n<p>The creator payouts are capped at <code>MAX_ROYALTY_RECIPIENTS_INDEX</code>. It’s currently set to <code>4</code> and only 5 creators are paid out.<br>\nOther creators are ignored.</p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>I don’t think cases with more than 5 creators / royalty receivers are unlikely.<br>\nIt can and should probably be increased, especially as the transfers are already gas restricted.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/45#issuecomment-1057382530\">NickCuso (Foundation) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Yes this is a fair point. The limit we put in place is arbitrary. We want some limit in order to ensure that the gas costs (which are often pushed to users other than the original creator) never get to be very expensive.</p>\n<p>What we can and should do is document this limitation so that it’s more clear what exactly will happen when too many recipients are defined. Additionally we should comment on a possible workaround: If you have a contract that splits with too many participants you could use the Royalty Override in order to define a single contract recipient instead to handle the splits - e.g. <a href=\"https://www.0xsplits.xyz/\">https://www.0xsplits.xyz/</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-12-private-sale-spoofing\" style=\"position:relative;\"><a href=\"#m-12-private-sale-spoofing\" aria-label=\"m 12 private sale spoofing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/46\">[M-12] Private sale spoofing</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketPrivateSale.sol#L156\">NFTMarketPrivateSale.sol#L156</a><br></p>\n<p>Similar to <a href=\"https://en.wikipedia.org/wiki/Spoofing_(finance)\">spoofing in finance</a>, users can create private sales with correct signatures but then frontrun the buy with a transfer to a different wallet they control.</p>\n<p>No funds are lost as the NFT &#x3C;> FETH exchange is atomic but it can be bad if third parties create a naive off-chain centralized NFT market based on this signature feature.<br>\nIt’s also frustrating for the users if they try to accept the private sale but their transaction fails.</p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>This is made possible because private sales do not keep the NFT in escrow.<br>\nConsider escrowing the NFT also for private sales.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/46#issuecomment-1057389683\">NickCuso (Foundation) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>We are actually considering moving private sales to an escrow system. But we’ll leave it as-is for now for backwards compatibility and to simplify our upcoming launch.</p>\n<p>We understand this could happen and will update the comments to make that more clear.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-13-escrowed-nft-can-be-stolen-by-anyone-if-no-active-buyprice-or-auction-exists-for-it\" style=\"position:relative;\"><a href=\"#m-13-escrowed-nft-can-be-stolen-by-anyone-if-no-active-buyprice-or-auction-exists-for-it\" aria-label=\"m 13 escrowed nft can be stolen by anyone if no active buyprice or auction exists for it permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/51\">[M-13] Escrowed NFT can be stolen by anyone if no active <code>buyPrice</code> or auction exists for it</a></h2>\n<p><em>Submitted by hyh, also found by wuwe1</em></p>\n<p>If a NFT happens to be in escrow with neither buyPrice, nor auction being initialised for it, there is a way to obtain it for free by any actor via <code>makeOffer</code>, <code>acceptOffer</code> combination.</p>\n<p>I.e. a malicious user can track the FNDNFTMarket contract and obtain any NFT from it for which there are no buyPrice or auction structures initialised. For example, if a NFT is mistakenly sent to the contract, an attacker can immediately steal it.</p>\n<p>This will happen as NFT is being guarded by buyPrice and auction structures only. The severity here is medium as normal usage of the system imply that either one of them is initialised (NFT was sent to escrow as a part of <code>setBuyPrice</code> or <code>createReserveAuction</code>, and so one of the structures is present), so this seems to leave only mistakenly sent assets exposed.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>An attacker can make a tiny offer with <code>makeOffer</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L189\">https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L189</a></p>\n<p>Then call <code>acceptOffer</code>, which will lead to <code>_acceptOffer</code>.</p>\n<p>Direct NFT transfer will fail in <code>_acceptOffer</code> as the NFT is being held by the contract and <code>_transferFromEscrow</code> will be called instead:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L262-L271\">https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L262-L271</a></p>\n<p><code>_transferFromEscrow</code> calls will proceed according to the FNDNFTMarket defined order:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _transferFromEscrow(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">) internal override(NFTMarketCore, NFTMarketReserveAuction, NFTMarketBuyPrice, NFTMarketOffer) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   super._transferFromEscrow(nftContract, tokenId, recipient, seller);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>If there are no corresponding structures, the NFTMarketOffer, NFTMarketBuyPrice and NFTMarketReserveAuction versions of <code>_transferFromEscrow</code> will pass through the call to NFTMarketCore’s plain transfer implementation:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketCore.sol#L77-L87\">https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketCore.sol#L77-L87</a></p>\n<p>This will effectively transfer the NFT to the attacker, which will pay gas costs and an arbitrary small offer price for it.</p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding additional checks to control who can obtain unallocated NFTs from the contract.</p>\n<p>Protocol controlled entity can handle such cases manually by initial sender’s request.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/51#issuecomment-1057448438\">NickCuso (Foundation) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Yes, this is an interesting scenario to raise! We do have more than one NFT in the market contract which was transferred directly (vs tracked as part of escrow). So there is some exposure already.</p>\n<p>We feel this is a <code>2 (Med Risk)</code>:</p>\n<ul>\n<li>It only impacts NFTs which were thought to be effectively burned as they were transferred to the Market contract with no way to get them back.</li>\n<li>Presumably the NFTs which get stuck in the Market contract like that were due to user error. So in theory this could have been thought of a sort of a feature - it allows those NFTs to be recovered, which is great for the original creator which will see royalties from future sales again.</li>\n</ul>\n<p>We have fixed this. We took a slightly different approach than what was recommended, but it should accomplish the same goal. <code>_transferFromEscrow</code> changed the <code>seller</code> param to <code>authorizeSeller</code>. As the call travels through each mixin, we change <code>authorizeSeller</code> to <code>address(0)</code> once an escrow manager is able to confirm ownership. Finally when the call reaches <code>NFTMarketCore</code> it requires that <code>authorizeSeller</code> is <code>address(0)</code> before executing the transfer — this confirms that one or more escrow managers (buy now or auctions) have positively confirmed the seller. So NFTs in the Market without being escrowed now reverts on this line.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-14-upgradable-escrow-contract\" style=\"position:relative;\"><a href=\"#m-14-upgradable-escrow-contract\" aria-label=\"m 14 upgradable escrow contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/53\">[M-14] Upgradable escrow contract</a></h2>\n<p><em>Submitted by gzeon</em></p>\n<p>Upgradable escrow contract poses great risk to user who approved their NFT to the contract. Most popular token / NFT exchange do not require user to approve their asset to admin upgradable contract.</p>\n<p>This also increases user gas usage because they would have to revoke approval when they are done with the protocol.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/FNDNFTMarket.sol\">https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/FNDNFTMarket.sol</a></p>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Separate the escrow contract to make it non-upgradable with a restricted set of functionality.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/53#issuecomment-1057450900\">NickCuso (Foundation) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>This is an interesting suggestion. I’m not sure if the recommendation really reduces the risk though. If we were to make the escrow portion immutable, the trust still depends on the upgradeable market contract to do the correct thing. If I’m understanding the suggestion correctly, the terms of the deal would still be defined in the upgradeable contract - so even with an immutable escrow manager we could theoretically upgrade the market to allow us to <code>buy</code> each of the NFTs for 0 ETH.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-15-royalties-can-be-distribution-unfairly-among-creatorrecipients-for-nft-contracts-with-non-standard-getroyalties-returns\" style=\"position:relative;\"><a href=\"#m-15-royalties-can-be-distribution-unfairly-among-creatorrecipients-for-nft-contracts-with-non-standard-getroyalties-returns\" aria-label=\"m 15 royalties can be distribution unfairly among creatorrecipients for nft contracts with non standard getroyalties returns permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/57\">[M-15] Royalties can be distribution unfairly among <code>creatorRecipients</code> for NFT contracts with non-standard <code>getRoyalties()</code> returns</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p>Based on our research, <code>getRoyalties()</code> is not a standardized API for NFT contracts to indicate how the royalties should be distributed among the recipients.</p>\n<p>However, in the current implementation, it always assumes that <code>getRoyalties()</code> return in terms of BPS.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketCreators.sol#L85-L112\">NFTMarketCreators.sol#L85-L112</a><br></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L86-L90\">NFTMarketFees.sol#L86-L90</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">creatorShares</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] &gt; </span><span class=\"mtk12\">BASIS_POINTS</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// If the numbers are &gt;100% we ignore the fee recipients and pay just the first instead</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">maxCreatorIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">break</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>As a result, if a particular implementation is returning <code>get Royalties()</code> with higher precision (say 1e6 for 100% instead of 1e4/BPS), the distribution of royalties can be distorted.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Given:</p>\n<ul>\n<li>\n<p><code>NFT-Token1</code> <code>Royalties</code>:</p>\n<ul>\n<li>Address0 = 10,000 (1%)</li>\n<li>Address1 = 10,000 (1%)</li>\n<li>Address2 = 100,000 (10%)</li>\n<li>Address3 = 880,000 (88%)</li>\n</ul>\n</li>\n<li>Alice owns the <code>NFT-Token1</code></li>\n<li>Alice <code>setBuyPrice()</code> and listed <code>NFT-Token1</code> for <code>10 ETH</code>;</li>\n<li>Bob <code>buy()</code> with <code>10 ETH</code>:</li>\n<li><code>foundationFee</code> = <code>0.5 ETH</code></li>\n<li><code>creatorFee</code> = <code>1 ETH</code></li>\n<li><code>ownerRev</code> = <code>8.5 ETH</code></li>\n</ul>\n<p>Since <code>creatorShares[address2]</code> > <code>BASIS_POINTS</code> (10,000), all the <code>creatorFee</code> will be sent to the first address: <code>Address0</code>, which is expected to receive only <code>1%</code> of the royalties.</p>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider removing this and change to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Determine the total shares defined so it can be leveraged to distribute below</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalShares</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// The array length cannot overflow 256 bits.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">maxCreatorIndex</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// The check above ensures totalShares wont overflow.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">totalShares</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">creatorShares</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">totalShares</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">maxCreatorIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/57#issuecomment-1062150873\">NickCuso (Foundation) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>This is a fair concern to raise, and a reasonable solution recommendation. We will consider making a change like this in the future.</p>\n<p>AFAIK this API was first introduced by Manifold, which named and implemented the return value to be in basis points. It’s true that since this is not a standard that others may use a different precision, however we have not yet encountered any example of that.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-16-inappropriate-support-of-eip-2981\" style=\"position:relative;\"><a href=\"#m-16-inappropriate-support-of-eip-2981\" aria-label=\"m 16 inappropriate support of eip 2981 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/58\">[M-16] Inappropriate support of EIP-2981</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketCreators.sol#L65-L82\">NFTMarketCreators.sol#L65-L82</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">nftContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">supportsERC165Interface</span><span class=\"mtk1\">(</span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IRoyaltyInfo</span><span class=\"mtk1\">).</span><span class=\"mtk12\">interfaceId</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IRoyaltyInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nftContract</span><span class=\"mtk1\">).</span><span class=\"mtk12\">royaltyInfo</span><span class=\"mtk1\">{ gas: </span><span class=\"mtk12\">READ_ONLY_GAS_LIMIT</span><span class=\"mtk1\"> }(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">BASIS_POINTS</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk3\">/* royaltyAmount */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">recipients</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">payable</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">recipients</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// splitPerRecipientInBasisPoints is not relevant when only 1 recipient is defined</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">seller</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">recipients</span><span class=\"mtk1\">, </span><span class=\"mtk12\">splitPerRecipientInBasisPoints</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  } </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// solhint-disable-next-line no-empty-blocks</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Fall through</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The current implementation of EIP-2981 support will always pass a constant <code>BASIS_POINTS</code> as the <code>_salePrice</code>.</p>\n<p>As a result, the recipients that are supposed to receive less than 1 BPS of the salePrice may end up not receiving any royalties.</p>\n<p>Furthermore, for the NFTs with the total royalties rate set less than 10% for some reason, the current implementation will scale it up to 10%.</p>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ol>\n<li>Instead of passing a constant of 10,000 as the <code>_salePrice</code>, we suggest using the actual <code>_salePrice</code>, so there the royalties can be paid for recipients with less than 1 BPS of the royalties.</li>\n<li>When the total royalties cut is lower than 10%, it should be honored. It’s capped at 10% only when the total royalties cut is higher than 10%.</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/58#issuecomment-1062159151\">NickCuso (Foundation) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Yes, these are valid points and something we will consider revisiting in the future.</p>\n<p>RE recommendations:</p>\n<ol>\n<li>This can only impact &#x3C; 0.01% of the payment so not a concern ATM. It may be more appropriate to better honor exact amounts, but it’s a non-trivial change to an important code path so we will leave it as-is for now. With payments that small, it’s probably more appropriate to be using a contract to manage the payouts - e.g. <a href=\"https://www.0xsplits.xyz/\">https://www.0xsplits.xyz/</a> could handle this well.</li>\n<li>I agree. ATM we always enforce exactly 10% so that there is a consistent experience with our market and on our website. We will revisit this in the future, and the idea of capping it to 10% but accepting lower is a great one.</li>\n</ol>\n</blockquote>\n<hr>\n<h2 id=\"m-17-there-is-no-support-for-the-trading-of-cryptopunks\" style=\"position:relative;\"><a href=\"#m-17-there-is-no-support-for-the-trading-of-cryptopunks\" aria-label=\"m 17 there is no support for the trading of cryptopunks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/74\">[M-17] There is no Support For The Trading of Cryptopunks</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p>Cryptopunks are at the core of the NFT ecosystem. As one of the first NFTs, it embodies the culture of NFT marketplaces. By not supporting the trading of cryptopunks, Foundation is at a severe disadvantage when compared to other marketplaces. Cryptopunks have their own internal marketplace which allows users to trade their NFTs to other users. As such, cryptopunks does not adhere to the <code>ERC721</code> standard, it will always fail when the protocol attempts to trade them.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Here is an example <a href=\"https://github.com/code-423n4/2021-12-nftx/blob/main/nftx-protocol-v2/contracts/solidity/NFTXStakingZap.sol#L417-L424\">implementation</a> of what it might look like to integrate cryptopunks into the Foundation protocol.</p>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider designing a wrapper contract for cryptopunks to facilitate standard <code>ERC721</code> transfers. The logic should be abstracted away from the user such that their user experience is not impacted.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/74#issuecomment-1058006585\">NickCuso (Foundation) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Yes, crypto punks is an important part of the ecosystem and this is on our radar. We are not planning on adding support at this time but we will revisiting this in the future.</p>\n<p>I like the idea of using a wrapper contract of sorts. We will be looking for a way to keep the complexity out of the market contract itself like you suggest if at all possible.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-18-fees-are-incorrectly-charged-on-unfinalized-nft-sales\" style=\"position:relative;\"><a href=\"#m-18-fees-are-incorrectly-charged-on-unfinalized-nft-sales\" aria-label=\"m 18 fees are incorrectly charged on unfinalized nft sales permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/73\">[M-18] Fees Are Incorrectly Charged on Unfinalized NFT Sales</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L255-L271\">NFTMarketOffer.sol#L255-L271</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketReserveAuction.sol#L557\">NFTMarketReserveAuction.sol#L557</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketReserveAuction.sol#L510-L515\">NFTMarketReserveAuction.sol#L510-L515</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketFees.sol#L188-L189\">NFTMarketFees.sol#L188-L189</a><br></p>\n<p>Once an auction has ended, the highest bidder now has sole rights to the underlying NFT. By finalizing the auction, fees are charged on the sale and the NFT is transferred to <code>auction.bidder</code>. However, if <code>auction.bidder</code> accepts an offer before finalization, fees will be charged on the <code>auction.bidder</code> sale before the original sale. As a result, it is possible to avoid paying the primary foundation fee as a creator if the NFT is sold by <code>auction.bidder</code> before finalization.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Consider the following scenario:</p>\n<ul>\n<li>Alice creates an auction and is the NFT creator.</li>\n<li>Bob bids on the auction and is the highest bidder.</li>\n<li>The auction ends but Alice leaves it in an unfinalized state.</li>\n<li>Carol makes an offer on the NFT which Bob accepts.</li>\n<li><code>_acceptOffer()</code> will distribute funds on the sale between Bob and Carol before distributing funds on the sale between Alice and Bob.</li>\n<li>The first call to <code>_distributeFunds()</code> will set the <code>_nftContractToTokenIdToFirstSaleCompleted</code> to true, meaning that future sales will only be charged the secondary foundation fee.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Ensure the <code>_nftContractToTokenIdToFirstSaleCompleted</code> is correctly tracked. It might be useful to ensure the distribution of funds are in the order of when the trades occurred. For example, an unfinalized auction should always have its fees paid before other sales.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/73#issuecomment-1058004784\">NickCuso (Foundation) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Yes! This is a good find.</p>\n<p>The core of the problem is we were calling <code>_distributeFunds</code> before calling <code>_transferFromEscrow</code> where the auction finalization would be processed. We have flipped those calls so now the auction will be fully settled before we calculate fees for the offer sale.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 20 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/89\">report highlighted below</a> by <strong>leastwood</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/25\">0xliumin</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/61\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/52\">hubble</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/80\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/36\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/84\">kenta</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/81\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/28\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/60\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/79\">0xwags</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/48\">cmichel</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/2\">robee</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/38\">CertoraInc</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/11\">kirk-baird</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/13\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/64\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/66\">TerrierLover</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/9\">jayjonah8</a>, and <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/56\">WatchPug</a>.</em></p>\n<h2 id=\"l-01-unhandled-marketlockupfor-edge-case\" style=\"position:relative;\"><a href=\"#l-01-unhandled-marketlockupfor-edge-case\" aria-label=\"l 01 unhandled marketlockupfor edge case permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Unhandled <code>marketLockupFor()</code> Edge Case</h2>\n<p><code>marketLockupFor()</code> will revert if too much <code>ETH</code> is provided. This can be modified to refund any surplus <code>ETH</code> to the user’s <code>FETH</code> balance.</p>\n<h2 id=\"n-01-signature-re-use\" style=\"position:relative;\"><a href=\"#n-01-signature-re-use\" aria-label=\"n 01 signature re use permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Signature Re-Use</h2>\n<p>The <code>adminAccountMigration()</code> function intends to allow a seller to update <code>auction.seller</code> in the event their account is compromised. However, the signature in <code>requireAuthorizedAccountMigration()</code> can be re-used because there is no use of a nonce to prevent this.</p>\n<p>Consider adding a nonce to account for this behaviour.</p>\n<h2 id=\"n-02-unclear-function-naming\" style=\"position:relative;\"><a href=\"#n-02-unclear-function-naming\" aria-label=\"n 02 unclear function naming permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] Unclear Function Naming</h2>\n<p>The <code>_cancelBuyersOffer()</code> function isn’t exactly clear as it will only cancel the offer if the buyer is <code>msg.sender</code>. Therefore, it would be more clear to rename this to <code>_cancelSellersOffer()</code> or similar to avoid confusion.</p>\n<h2 id=\"n-03-improper-basis_points-check-in-_distributefunds\" style=\"position:relative;\"><a href=\"#n-03-improper-basis_points-check-in-_distributefunds\" aria-label=\"n 03 improper basis_points check in _distributefunds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] Improper <code>BASIS_POINTS</code> Check in <code>_distributeFunds()</code></h2>\n<p>The <code>_distributeFunds()</code> function checks if <code>creatorShares[i] > BASIS_POINTS</code> when it should actually be checking if <code>totalShares > BASIS_POINTS</code>. This ensures that the sum of creator shares do not exceed an expected amount.</p>\n<h2 id=\"n-04-improper-state-handling\" style=\"position:relative;\"><a href=\"#n-04-improper-state-handling\" aria-label=\"n 04 improper state handling permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] Improper State Handling</h2>\n<p>If <code>_autoAcceptBuyPrice()</code> is executed by a new buyer that is not <code>offer.buyer</code>, then there will be an excess of <code>ETH</code>. The original <code>offer.buyer</code> will then have to wait until the offer expires as it isn’t invalidated.</p>\n<p>Ensure this is understood.</p>\n<h2 id=\"n-05-no-support-for-erc1155-tokens\" style=\"position:relative;\"><a href=\"#n-05-no-support-for-erc1155-tokens\" aria-label=\"n 05 no support for erc1155 tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-05] No Support For <code>ERC1155</code> Tokens</h2>\n<p>Many new NFT contracts adhere to the <code>ERC1155</code> standard. Currently, it is not possible to trade these tokens on the Foundation marketplace.</p>\n<p>Consider making the necessary integrations.</p>\n<h2 id=\"n-06-unclear-_recipients-array-restriction\" style=\"position:relative;\"><a href=\"#n-06-unclear-_recipients-array-restriction\" aria-label=\"n 06 unclear _recipients array restriction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-06] Unclear <code>_recipients</code> Array Restriction</h2>\n<p>The <code>_recipients</code> array is restricted to just 5 receivers. Ensure this is understand by NFT creators as they may intend to use additional receivers but these receivers may be disproportionally rewarded if the majority of creator shares are not included.</p>\n<h2 id=\"n-07-inconsistent-use-of-sendvalue\" style=\"position:relative;\"><a href=\"#n-07-inconsistent-use-of-sendvalue\" aria-label=\"n 07 inconsistent use of sendvalue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-07] Inconsistent Use of <code>sendValue()</code></h2>\n<p><code>_buy()</code> should make use of <code>_sendValueWithFallbackWithdraw()</code> instead of <code>sendValue()</code>. This will ensure invalid transfers are correctly handled.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/89#issuecomment-1062821351\">NickCuso (Foundation) commented</a>:</strong></p>\n<blockquote>\n<p>Thanks for the feedback!</p>\n<ul>\n<li><strong>[L-01] Unhandled marketLockupFor() Edge Case:</strong> ATM there is no use case we are aware of where it would make sense for too much ETH to be provided. Because of this we are going to revert instead of refunding - it’ll save a bit of gas for other users and may prevent an invalid transaction (possibly user error or a frontend bug).</li>\n<li><strong>[N-01] Signature re-use:</strong> In this use case, signature reuse is actually desirable. However after a different issue was reported we opted to remove the <code>adminAccountMigration</code> function completely instead. It’s not something we have used in some time.</li>\n<li><strong>[N-02] Unclear naming:</strong> Yes, we agree. The function has been renamed.</li>\n<li><strong>[N-03] Improper BASIS_POINTS Check:</strong> This is a fair point. It’s somewhat an arbitrary decision though. We are expecting values to be in BP and this logic is simply trying to handle invalid results gracefully. Either way we bring the total back down to 10% and guard against overflowing. ATM we are going to leave it as is.</li>\n<li><strong>[N-04] Improper State Handling:</strong> This is a valid concern but currently working as designed. When auto buy now applies we treat this the same as if they called buy directly. When someone purchases using <code>buy</code> we have opted to allow the highest offer to remain valid. It may not be common, but it’s not 100% clear that the offer should have been canceled. e.g. the new owner may accept that offer in order to have a fast exit at a small loss due to buyers remorse.</li>\n<li><strong>[N-05] No Support For ERC1155 Tokens:</strong> Agree, we will add support for ERC-1155 at some point. It’s a non trivial change though and we don’t want to rush into it just yet.</li>\n<li><strong>[N-06] Unclear _recipients Array Restriction:</strong> Agree. We need some cap in order to limit amount of gas that non-creators would be required to pay. 5 is arbitrary and we should at least provide clear documentation. For now, we have added some comments about this inline. Longer term we can continue to communicate this more clearly, and encourage those with more than 5 recipients to use solutions such as <a href=\"https://www.0xsplits.xyz/\">https://www.0xsplits.xyz/</a>.</li>\n<li><strong>[N-07] Inconsistent Use of sendValue():</strong> Yes, this is inconsistent. However the use case here is slightly different. Generally the use of <code>sendValueWithFallbackWithdraw</code> is when we are sending ETH to an address other than the msg.sender - we want to ensure that a malicious user cannot cause other user’s transactions to revert. Here the refund is going to the msg.sender - if they are non-receivable they should be able to retry using the correct value instead. So we are leaving it as-is for now. </li>\n</ul>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/89#issuecomment-1070690969\">Alberto Cuesta Cañada (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Unadjusted score: 100 (80 + 20 from clean formatting)</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 11 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/63\">report highlighted below</a> by <strong>Dravee</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/37\">CertoraInc</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/65\">TerrierLover</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/75\">thankthedark</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/10\">iain</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/15\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/32\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/54\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/78\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/83\">kenta</a>, and <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/1\">robee</a>.</em></p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<p>See <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/63\">original submission</a>.</p>\n<h2 id=\"foreword\" style=\"position:relative;\"><a href=\"#foreword\" aria-label=\"foreword permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Foreword</h2>\n<ul>\n<li><strong>Storage-reading optimizations</strong></li>\n</ul>\n<blockquote>\n<p>The code can be optimized by minimising the number of SLOADs. SLOADs are expensive (100 gas) compared to MLOADs/MSTOREs (3 gas). In the paragraphs below, please see the <code>@audit-issue</code> tags in the pieces of code’s comments for more information about SLOADs that could be saved by caching the mentioned <strong>storage</strong> variables in <strong>memory</strong> variables.</p>\n</blockquote>\n<ul>\n<li><strong>Unchecking arithmetics operations that can’t underflow/overflow</strong></li>\n</ul>\n<blockquote>\n<p>Solidity version 0.8+ comes with implicit overflow and underflow checks on unsigned integers. When an overflow or an underflow isn’t possible (as an example, when a comparison is made before the arithmetic operation, or the operation doesn’t depend on user input), some gas can be saved by using an <code>unchecked</code> block: <a href=\"https://docs.soliditylang.org/en/v0.8.10/control-structures.html#checked-or-unchecked-arithmetic\">https://docs.soliditylang.org/en/v0.8.10/control-structures.html#checked-or-unchecked-arithmetic</a></p>\n</blockquote>\n<ul>\n<li><strong><code>@audit</code> tags</strong></li>\n</ul>\n<blockquote>\n<p>The code is annotated at multiple places with <code>//@audit</code> comments to pinpoint the issues. Please, pay attention to them for more details.</p>\n</blockquote>\n<h2 id=\"file-fethsol\" style=\"position:relative;\"><a href=\"#file-fethsol\" aria-label=\"file fethsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File: FETH.sol</h2>\n<h3 id=\"function-_deductallowancefrom\" style=\"position:relative;\"><a href=\"#function-_deductallowancefrom\" aria-label=\"function _deductallowancefrom permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _deductAllowanceFrom()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: FETH.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">441:   function _deductAllowanceFrom(AccountInfo storage accountInfo, uint256 amount) private {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">442:     if (accountInfo.allowance[msg.sender] != type(uint256).max) { //@audit accountInfo.allowance[msg.sender] SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">443:       if (accountInfo.allowance[msg.sender] &lt; amount) { //@audit accountInfo.allowance[msg.sender] SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">444:         revert FETH_Insufficient_Allowance(accountInfo.allowance[msg.sender]); //@audit accountInfo.allowance[msg.sender] SLOAD 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">445:       }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">446:       // The check above ensures allowance cannot underflow.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">447:       unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">448:         accountInfo.allowance[msg.sender] -= amount; //@audit accountInfo.allowance[msg.sender] SLOAD 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">449:       }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">450:     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">451:   }</span></span></code></pre>\n<h4 id=\"cache-accountinfoallowancemsgsender\" style=\"position:relative;\"><a href=\"#cache-accountinfoallowancemsgsender\" aria-label=\"cache accountinfoallowancemsgsender permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>accountInfo.allowance[msg.sender]</code></h4>\n<p>Caching this in memory can save around 2 SLOADs (around 200 gas). This is due to the fact that both conditions will get evaluated before L448, which is using <code>-=</code> (therefore making a SLOAD + SSTORE)<br>\nI recommend caching this value and using it as such:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _deductAllowanceFrom(AccountInfo storage accountInfo, uint256 amount) private {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _allowance = accountInfo.allowance[msg.sender]; //@audit 1 MSTORE + 1 SLOAD</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_allowance != type(uint256).max) { //@audit 1 MLOAD spent</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      if (_allowance &lt; amount) { //@audit 1 SLOAD saved, 1 MLOAD spent</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        revert FETH_Insufficient_Allowance(_allowance); //@audit 1 SLOAD saved, 1 MLOAD spent</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // The check above ensures allowance cannot underflow.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        accountInfo.allowance[msg.sender] = _allowance - amount; //@audit 1 SLOAD saved, 1 MLOAD spent</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<h3 id=\"function-_deductbalancefrom\" style=\"position:relative;\"><a href=\"#function-_deductbalancefrom\" aria-label=\"function _deductbalancefrom permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _deductBalanceFrom()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: FETH.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">456:   function _deductBalanceFrom(AccountInfo storage accountInfo, uint256 amount) private {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">457:     // Free from escrow in order to consider any expired escrow balance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">458:     if (accountInfo.freedBalance &lt; amount) { //@audit accountInfo.freedBalance SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">459:       revert FETH_Insufficient_Available_Funds(accountInfo.freedBalance); //@audit accountInfo.freedBalance SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">460:     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">461:     // The check above ensures balance cannot underflow.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">462:     unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">463:       accountInfo.freedBalance -= uint96(amount); //@audit accountInfo.freedBalance SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">464:     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">465:   }</span></span></code></pre>\n<h4 id=\"cache-accountinfofreedbalance\" style=\"position:relative;\"><a href=\"#cache-accountinfofreedbalance\" aria-label=\"cache accountinfofreedbalance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>accountInfo.freedBalance</code></h4>\n<p>Caching this in memory can save around 1 SLOAD (around 100 gas).<br>\nI recommend caching this value and using it as such:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _deductBalanceFrom(AccountInfo storage accountInfo, uint256 amount) private {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _freedBalance = accountInfo.freedBalance; //@audit 1 MSTORE + 1 SLOAD</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Free from escrow in order to consider any expired escrow balance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_freedBalance &lt; amount) { ///@audit 1 MLOAD spent</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      revert FETH_Insufficient_Available_Funds(_freedBalance); //@audit 1 SLOAD saved, 1 MLOAD spent</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // The check above ensures balance cannot underflow.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      accountInfo.freedBalance = _freedBalance - uint96(amount); //@audit 1 SLOAD saved, 1 MLOAD spent</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<h3 id=\"function-_marketlockupfor\" style=\"position:relative;\"><a href=\"#function-_marketlockupfor\" aria-label=\"function _marketlockupfor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _marketLockupFor()</h3>\n<h4 id=\"cache-accountinfofreedbalance-or-call-_deductbalancefrom-to-save-gas-while-saving-some-size\" style=\"position:relative;\"><a href=\"#cache-accountinfofreedbalance-or-call-_deductbalancefrom-to-save-gas-while-saving-some-size\" aria-label=\"cache accountinfofreedbalance or call _deductbalancefrom to save gas while saving some size permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>accountInfo.freedBalance</code> or call <code>_deductBalanceFrom</code> to save gas while saving some size</h4>\n<p>Impacted code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: FETH.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">535:       // The check above prevents underflow with delta.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">536:       unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">537:         uint256 delta = amount - msg.value; //@audit just use / should call private _deductBalanceFrom(accountInfo, amount - msg.value); : 6.833 vs 6.894</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">538:         if (accountInfo.freedBalance &lt; delta) { //@audit accountInfo.freedBalance SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">539:           revert FETH_Insufficient_Available_Funds(accountInfo.freedBalance); //@audit accountInfo.freedBalance SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">540:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">541:         // The check above prevents underflow of freed balance.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">542:         accountInfo.freedBalance -= uint96(delta); //@audit accountInfo.freedBalance SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">543:       }</span></span></code></pre>\n<p>The optimization by caching <code>accountInfo.freedBalance</code> would be exactly the same as above, which would save around 100 gas. However, here, it’d be better to actually call the optimized <code>_deductBalanceFrom</code> to benefit from the previous gas-gains and reduce the contract’s size (0.061KB saved).</p>\n<p>The code should become:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: FETH.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">534:     if (msg.value &lt; amount) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">535:       _deductBalanceFrom(accountInfo, amount - msg.value);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">536:     } else if (msg.value != amount) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">537:       // There&#39;s no reason to send msg.value more than the amount being locked up</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">538:       revert FETH_Too_Much_ETH_Provided();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">539:     }</span></span></code></pre>\n<h2 id=\"file-nftmarketbuypricesol\" style=\"position:relative;\"><a href=\"#file-nftmarketbuypricesol\" aria-label=\"file nftmarketbuypricesol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File: NFTMarketBuyPrice.sol</h2>\n<h3 id=\"function-cancelbuyprice\" style=\"position:relative;\"><a href=\"#function-cancelbuyprice\" aria-label=\"function cancelbuyprice permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function cancelBuyPrice()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: NFTMarketBuyPrice.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">125:   function cancelBuyPrice(address nftContract, uint256 tokenId) external nonReentrant {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">126:     BuyPrice storage buyPrice = nftContractToTokenIdToBuyPrice[nftContract][tokenId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">127:     if (buyPrice.seller == address(0)) { //@audit buyPrice.seller SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">128:       // This check is redundant with the next one, but done in order to provide a more clear error message.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">129:       revert NFTMarketBuyPrice_Cannot_Cancel_Unset_Price();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">130:     } else if (buyPrice.seller != msg.sender) { //@audit buyPrice.seller SLOAD 2 (evaluated even if false)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">131:       revert NFTMarketBuyPrice_Only_Owner_Can_Cancel_Price(buyPrice.seller); //@audit buyPrice.seller SLOAD 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">132:     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">141:   }</span></span></code></pre>\n<h4 id=\"cache-buypriceseller\" style=\"position:relative;\"><a href=\"#cache-buypriceseller\" aria-label=\"cache buypriceseller permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>buyPrice.seller</code></h4>\n<p>Caching this in memory can save around 2 SLOADs (around 200 gas).</p>\n<h3 id=\"function-setbuyprice\" style=\"position:relative;\"><a href=\"#function-setbuyprice\" aria-label=\"function setbuyprice permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function setBuyPrice()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: NFTMarketBuyPrice.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">150:   function setBuyPrice(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">165:     BuyPrice storage buyPrice = nftContractToTokenIdToBuyPrice[nftContract][tokenId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">170:     if (buyPrice.seller == address(0)) { //@audit buyPrice.seller SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">171:       // Transfer the NFT into escrow, if it&#39;s already in escrow confirm the `msg.sender` is the owner.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">172:       _transferToEscrow(nftContract, tokenId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">173: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">174:       // The price was not previously set for this NFT, store the seller.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">175:       buyPrice.seller = payable(msg.sender); </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">176:     } else if (buyPrice.seller != msg.sender) { //@audit buyPrice.seller SLOAD 2 (evaluated even if false)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">177:       // Buy price was previously set by a different user</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">178:       revert NFTMarketBuyPrice_Only_Owner_Can_Set_Price(buyPrice.seller); //@audit buyPrice.seller SLOAD 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">179:     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">182:   }</span></span></code></pre>\n<h4 id=\"cache-buypriceseller-1\" style=\"position:relative;\"><a href=\"#cache-buypriceseller-1\" aria-label=\"cache buypriceseller 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>buyPrice.seller</code></h4>\n<p>Caching this in memory can save around 2 SLOADs (around 200 gas).</p>\n<h3 id=\"function-_transferfromescrow\" style=\"position:relative;\"><a href=\"#function-_transferfromescrow\" aria-label=\"function _transferfromescrow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _transferFromEscrow()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: NFTMarketBuyPrice.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">276:   function _transferFromEscrow(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">282:     BuyPrice storage buyPrice = nftContractToTokenIdToBuyPrice[nftContract][tokenId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">283:     if (buyPrice.seller != address(0)) { //@audit buyPrice.seller SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">284:       // A buy price was set for this NFT.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">285:       if (buyPrice.seller != seller) { //@audit buyPrice.seller SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">286:         // When there is a buy price set, the `buyPrice.seller` is the owner of the NFT.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">287:         revert NFTMarketBuyPrice_Seller_Mismatch(buyPrice.seller); //@audit buyPrice.seller SLOAD 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">288:       }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">294:   }</span></span></code></pre>\n<h4 id=\"cache-buypriceseller-2\" style=\"position:relative;\"><a href=\"#cache-buypriceseller-2\" aria-label=\"cache buypriceseller 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>buyPrice.seller</code></h4>\n<p>Caching this in memory can save around 2 SLOADs (around 200 gas).</p>\n<h3 id=\"function-_transfertoescrow\" style=\"position:relative;\"><a href=\"#function-_transfertoescrow\" aria-label=\"function _transfertoescrow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _transferToEscrow()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: NFTMarketBuyPrice.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">316:   function _transferToEscrow(address nftContract, uint256 tokenId) internal virtual override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">317:     BuyPrice storage buyPrice = nftContractToTokenIdToBuyPrice[nftContract][tokenId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">318:     if (buyPrice.seller == address(0)) { //@audit buyPrice.seller SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">319:       // The NFT is not in escrow for buy now.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">320:       super._transferToEscrow(nftContract, tokenId); </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">321:     } else if (buyPrice.seller != msg.sender) { //@audit buyPrice.seller SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">322:       // When there is a buy price set, the `buyPrice.seller` is the owner of the NFT.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">323:       revert NFTMarketBuyPrice_Seller_Mismatch(buyPrice.seller); //@audit buyPrice.seller SLOAD 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">324:     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">325:   }</span></span></code></pre>\n<h4 id=\"cache-buypriceseller-3\" style=\"position:relative;\"><a href=\"#cache-buypriceseller-3\" aria-label=\"cache buypriceseller 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>buyPrice.seller</code></h4>\n<p>Caching this in memory can save around 2 SLOADs (around 200 gas).</p>\n<h3 id=\"function-getbuyprice\" style=\"position:relative;\"><a href=\"#function-getbuyprice\" aria-label=\"function getbuyprice permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function getBuyPrice()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: NFTMarketBuyPrice.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">337:   function getBuyPrice(address nftContract, uint256 tokenId) external view returns (address seller, uint256 price) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">338:     BuyPrice storage buyPrice = nftContractToTokenIdToBuyPrice[nftContract][tokenId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">339:     if (buyPrice.seller == address(0)) { //@audit buyPrice.seller SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">340:       return (address(0), type(uint256).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">341:     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">342:     return (buyPrice.seller, buyPrice.price); //@audit buyPrice.seller SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">343:   }</span></span></code></pre>\n<h4 id=\"cache-buypriceseller-4\" style=\"position:relative;\"><a href=\"#cache-buypriceseller-4\" aria-label=\"cache buypriceseller 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>buyPrice.seller</code></h4>\n<p>Caching this in memory can save around 1 SLOAD (around 100 gas).</p>\n<h2 id=\"file-nftmarketfeessol\" style=\"position:relative;\"><a href=\"#file-nftmarketfeessol\" aria-label=\"file nftmarketfeessol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File: NFTMarketFees.sol</h2>\n<h3 id=\"function-_distributefunds\" style=\"position:relative;\"><a href=\"#function-_distributefunds\" aria-label=\"function _distributefunds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _distributeFunds()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: NFTMarketFees.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">48:   function _distributeFunds(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">74:     if (creatorFee &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">75:       if (creatorRecipients.length &gt; 1) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">76:         uint256 maxCreatorIndex = creatorRecipients.length - 1; //@audit should be unchecked too (see L75)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">77:         if (maxCreatorIndex &gt; MAX_ROYALTY_RECIPIENTS_INDEX) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">78:           maxCreatorIndex = MAX_ROYALTY_RECIPIENTS_INDEX;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">79:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">80: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">81:         // Determine the total shares defined so it can be leveraged to distribute below</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">82:         uint256 totalShares;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">83:         unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">84:           // The array length cannot overflow 256 bits.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">85:           for (uint256 i; i &lt;= maxCreatorIndex; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">86:             if (creatorShares[i] &gt; BASIS_POINTS) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">87:               // If the numbers are &gt;100% we ignore the fee recipients and pay just the first instead</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">88:               maxCreatorIndex = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">89:               break;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">90:             }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">91:             // The check above ensures totalShares wont overflow.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">92:             totalShares += creatorShares[i];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">93:           }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">94:         }</span></span></code></pre>\n<h4 id=\"uncheck-line-l76\" style=\"position:relative;\"><a href=\"#uncheck-line-l76\" aria-label=\"uncheck line l76 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uncheck line L76</h4>\n<p>This line can’t underflow due to L75. Therefore, it should be wrapped in an <code>unchecked</code> block.<br>\nI’d suggest starting the <code>unchecked</code> block L83 at line 76.</p>\n<h2 id=\"file-nftmarketoffersol\" style=\"position:relative;\"><a href=\"#file-nftmarketoffersol\" aria-label=\"file nftmarketoffersol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File: NFTMarketOffer.sol</h2>\n<h3 id=\"function-makeoffer\" style=\"position:relative;\"><a href=\"#function-makeoffer\" aria-label=\"function makeoffer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function makeOffer()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: NFTMarketOffer.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">189:   function makeOffer(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">204:     Offer storage offer = nftContractToIdToOffer[nftContract][tokenId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">205: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">206:     if (offer.expiration &lt; block.timestamp) { //@audit offer.expiration SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">211:     } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">214:       if (amount &lt; _getMinIncrement(offer.amount)) { //@audit offer.amount SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">215:         // A non-trivial increase in price is required to avoid sniping</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">216:         revert NFTMarketOffer_Offer_Must_Be_At_Least_Min_Amount(_getMinIncrement(offer.amount)); //@audit offer.amount SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">217:       }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">221:       expiration = feth.marketChangeLockup{ value: msg.value }(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">222:         offer.buyer,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">223:         offer.expiration, //@audit offer.expiration SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">224:         offer.amount, //@audit offer.amount SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">225:         msg.sender,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">226:         amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">227:       );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">228:     }</span></span></code></pre>\n<h4 id=\"cache-offerexpiration\" style=\"position:relative;\"><a href=\"#cache-offerexpiration\" aria-label=\"cache offerexpiration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>offer.expiration</code></h4>\n<p>Caching this in memory can save around 1 SLOAD (around 100 gas).</p>\n<h4 id=\"cache-offeramount\" style=\"position:relative;\"><a href=\"#cache-offeramount\" aria-label=\"cache offeramount permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>offer.amount</code></h4>\n<p>Caching this in memory can save around 1 SLOAD (around 100 gas).</p>\n<h3 id=\"function-getoffer\" style=\"position:relative;\"><a href=\"#function-getoffer\" aria-label=\"function getoffer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function getOffer()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: NFTMarketOffer.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">379:   function getOffer(address nftContract, uint256 tokenId)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">388:     Offer storage offer = nftContractToIdToOffer[nftContract][tokenId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">389:     if (offer.expiration &lt; block.timestamp) { //@audit offer.expiration SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">390:       // Offer not found or has expired</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">391:       return (address(0), 0, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">392:     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">393: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">394:     // An offer was found and it has not yet expired.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">395:     return (offer.buyer, offer.expiration, offer.amount); //@audit offer.expiration SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">396:   }</span></span></code></pre>\n<h4 id=\"cache-offerexpiration-1\" style=\"position:relative;\"><a href=\"#cache-offerexpiration-1\" aria-label=\"cache offerexpiration 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>offer.expiration</code></h4>\n<p>Caching this in memory can save around 1 SLOAD (around 100 gas).</p>\n<h2 id=\"file-nftmarketreserveauctionsol\" style=\"position:relative;\"><a href=\"#file-nftmarketreserveauctionsol\" aria-label=\"file nftmarketreserveauctionsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File: NFTMarketReserveAuction.sol</h2>\n<h3 id=\"function-adminaccountmigration\" style=\"position:relative;\"><a href=\"#function-adminaccountmigration\" aria-label=\"function adminaccountmigration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function adminAccountMigration()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: NFTMarketReserveAuction.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">263:   function adminAccountMigration(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">264:     uint256[] calldata listedAuctionIds,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">265:     address originalAddress,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">266:     address payable newAddress,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">267:     bytes memory signature //@audit gas should be calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">268:   ) external onlyFoundationOperator { </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">269:     // Validate the owner of the original account has approved this change.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">270:     originalAddress.requireAuthorizedAccountMigration(newAddress, signature);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">271: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">272:     unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">273:       // The array length cannot overflow 256 bits.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">274:       for (uint256 i; i &lt; listedAuctionIds.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">275:         uint256 auctionId = listedAuctionIds[i];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">276:         ReserveAuction storage auction = auctionIdToAuction[auctionId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">277:         if (auction.seller != address(0)) { //@audit auction.seller SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">278:           // Only if the auction was found and not finalized before this transaction.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">279: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">280:           if (auction.seller != originalAddress) { //@audit auction.seller SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">281:             // Confirm that the signature approval was the correct owner of this auction.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">282:             revert NFTMarketReserveAuction_Cannot_Migrate_Non_Matching_Seller(auction.seller); //@audit auction.seller SLOAD 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">283:           }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">284: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">285:           // Update the auction&#39;s seller address.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">286:           auction.seller = newAddress;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">287: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">288:           emit ReserveAuctionSellerMigrated(auctionId, originalAddress, newAddress);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">289:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">290:       }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">291:     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">292:   }</span></span></code></pre>\n<h3 id=\"use-calldata-instead-of-memory-for-external-functions-where-the-function-argument-is-read-only\" style=\"position:relative;\"><a href=\"#use-calldata-instead-of-memory-for-external-functions-where-the-function-argument-is-read-only\" aria-label=\"use calldata instead of memory for external functions where the function argument is read only permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use <code>calldata</code> instead of <code>memory</code> for external functions where the function argument is read-only</h3>\n<p>Here, <code>bytes memory signature</code> should be <code>bytes calldata signature</code></p>\n<h4 id=\"cache-auctionseller\" style=\"position:relative;\"><a href=\"#cache-auctionseller\" aria-label=\"cache auctionseller permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>auction.seller</code></h4>\n<p>Caching this in memory can save around 2 SLOADs (around 200 gas).</p>\n<h3 id=\"function-placebidof\" style=\"position:relative;\"><a href=\"#function-placebidof\" aria-label=\"function placebidof permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function placeBidOf()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: NFTMarketReserveAuction.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">386:   function placeBidOf(uint256 auctionId, uint256 amount) public payable nonReentrant {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">402:     ReserveAuction storage auction = auctionIdToAuction[auctionId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">403: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">404:     if (auction.amount == 0) { //@audit auction.amount SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">405:       // No auction found</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">406:       revert NFTMarketReserveAuction_Cannot_Bid_On_Nonexistent_Auction();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">407:     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">408: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">409:     if (auction.endTime == 0) { //@audit auction.endTime SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">410:       // This is the first bid, kicking off the auction.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">411: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">412:       if (auction.amount &gt; amount) { //@audit auction.amount SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">413:         // The bid must be &gt;= the reserve price.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">414:         revert NFTMarketReserveAuction_Cannot_Bid_Lower_Than_Reserve_Price(auction.amount); //@audit auction.amount SLOAD 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">415:       }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">429:     } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">430:       if (auction.endTime &lt; block.timestamp) { //@audit auction.endTime SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">431:         // The auction has already ended.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">432:         revert NFTMarketReserveAuction_Cannot_Bid_On_Ended_Auction(auction.endTime); //@audit auction.endTime SLOAD 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">433:       } else if (auction.bidder == msg.sender) { //@audit auction.bidder SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">434:         // We currently do not allow a bidder to increase their bid unless another user has outbid them first.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">435:         revert NFTMarketReserveAuction_Cannot_Rebid_Over_Outstanding_Bid();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">436:       } else if (amount &lt; _getMinIncrement(auction.amount)) { //@audit auction.amount SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">437:         // If this bid outbids another, it must be at least 10% greater than the last bid.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">438:         revert NFTMarketReserveAuction_Bid_Must_Be_At_Least_Min_Amount(_getMinIncrement(auction.amount)); //@audit auction.amount SLOAD 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">439:       }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">440: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">441:       // Cache and update bidder state</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">442:       uint256 originalAmount = auction.amount; //@audit auction.amount SLOAD 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">443:       address payable originalBidder = auction.bidder; //@audit auction.bidder SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">444:       auction.amount = amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">445:       auction.bidder = payable(msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">446: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">447:       unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">448:         // When a bid outbids another, check to see if a time extension should apply.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">449:         // We confirmed that the auction has not ended, so endTime is always &gt;= the current timestamp.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">450:         if (auction.endTime - block.timestamp &lt; auction.extensionDuration) { //@audit auction.endTime SLOAD 3 //@audit auction.extensionDuration SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">451:           // Current time plus extension duration (always 15 mins) cannot overflow.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">452:           auction.endTime = block.timestamp + auction.extensionDuration; //@audit auction.extensionDuration SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">453:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">454:       }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">455: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">456:       // Refund the previous bidder</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">457:       _sendValueWithFallbackWithdraw(originalBidder, originalAmount, SEND_VALUE_GAS_LIMIT_SINGLE_RECIPIENT);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">458:     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">459: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">460:     emit ReserveAuctionBidPlaced(auctionId, msg.sender, amount, auction.endTime); //@audit auction.endTime SLOAD 4</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">461:   }</span></span></code></pre>\n<h4 id=\"cache-auctionendtime\" style=\"position:relative;\"><a href=\"#cache-auctionendtime\" aria-label=\"cache auctionendtime permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>auction.endTime</code></h4>\n<p>Caching this in memory can save around 3 SLOADs (around 300 gas).</p>\n<h4 id=\"cache-auctionextensionduration\" style=\"position:relative;\"><a href=\"#cache-auctionextensionduration\" aria-label=\"cache auctionextensionduration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>auction.extensionDuration</code></h4>\n<p>Caching this in memory can save around 1 SLOAD (around 100 gas).</p>\n<h4 id=\"cache-auctionbidder\" style=\"position:relative;\"><a href=\"#cache-auctionbidder\" aria-label=\"cache auctionbidder permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>auction.bidder</code></h4>\n<p>Caching this in memory can save around 1 SLOAD (around 100 gas).</p>\n<h4 id=\"cache-auctionamount\" style=\"position:relative;\"><a href=\"#cache-auctionamount\" aria-label=\"cache auctionamount permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>auction.amount</code></h4>\n<p>Caching this in memory can save around 2 SLOADs (around 200 gas).</p>\n<h2 id=\"general-recommendations\" style=\"position:relative;\"><a href=\"#general-recommendations\" aria-label=\"general recommendations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>General recommendations</h2>\n<h3 id=\"for-loops\" style=\"position:relative;\"><a href=\"#for-loops\" aria-label=\"for loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>For-Loops</h3>\n<h4 id=\"an-arrays-length-should-be-cached-to-save-gas-in-for-loops\" style=\"position:relative;\"><a href=\"#an-arrays-length-should-be-cached-to-save-gas-in-for-loops\" aria-label=\"an arrays length should be cached to save gas in for loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>An array’s length should be cached to save gas in for-loops</h4>\n<p>Reading array length at each iteration of the loop takes 6 gas (3 for mload and 3 to place memory_offset) in the stack.<br>\nCaching the array length in the stack saves around 3 gas per iteration.<br>\nTherefore, it’s possible to save a significant amount of gas (>= 102 after 34 iterations).</p>\n<p>Here, I suggest storing the array’s length in a variable before the for-loop, and use it instead:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">mixins/OZ/ERC165Checker.sol:64:        for (uint256 i = 0; i &lt; interfaceIds.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mixins/OZ/ERC165Checker.sol:90:      for (uint256 i = 0; i &lt; interfaceIds.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mixins/NFTMarketCreators.sol:94:            for (uint256 i = 0; i &lt; _recipients.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mixins/NFTMarketCreators.sol:155:                for (uint256 i = 0; i &lt; _recipients.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mixins/NFTMarketCreators.sol:193:                for (uint256 i = 0; i &lt; _recipients.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mixins/NFTMarketOffer.sol:161:      for (uint256 i = 0; i &lt; nftContracts.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mixins/NFTMarketReserveAuction.sol:274:      for (uint256 i = 0; i &lt; listedAuctionIds.length; ++i) {</span></span></code></pre>\n<h4 id=\"increments-can-be-unchecked\" style=\"position:relative;\"><a href=\"#increments-can-be-unchecked\" aria-label=\"increments can be unchecked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Increments can be unchecked</h4>\n<p>In Solidity 0.8+, there’s a default overflow check on unsigned integers. It’s possible to uncheck this in for-loops and save a significant amount of gas at each iteration, but at the cost of some code readability, as this uncheck cannot be made inline.</p>\n<p><a href=\"https://github.com/ethereum/solidity/issues/10695\">ethereum/solidity#10695</a></p>\n<p>Instances include:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">mixins/OZ/ERC165Checker.sol:64:        for (uint256 i = 0; i &lt; interfaceIds.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mixins/OZ/ERC165Checker.sol:90:      for (uint256 i = 0; i &lt; interfaceIds.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mixins/NFTMarketCreators.sol:94:            for (uint256 i = 0; i &lt; _recipients.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mixins/NFTMarketCreators.sol:155:                for (uint256 i = 0; i &lt; _recipients.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mixins/NFTMarketCreators.sol:193:                for (uint256 i = 0; i &lt; _recipients.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mixins/NFTMarketOffer.sol:161:      for (uint256 i = 0; i &lt; nftContracts.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mixins/NFTMarketReserveAuction.sol:274:      for (uint256 i = 0; i &lt; listedAuctionIds.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">FETH.sol:552:      for (uint256 escrowIndex = accountInfo.lockupStartIndex; ; ++escrowIndex) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">FETH.sol:679:      for (uint256 escrowIndex = accountInfo.lockupStartIndex; ; ++escrowIndex) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">FETH.sol:713:      for (uint256 escrowIndex = accountInfo.lockupStartIndex; ; ++escrowIndex) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">FETH.sol:733:      for (uint256 escrowIndex = accountInfo.lockupStartIndex; ; ++escrowIndex) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">FETH.sol:760:      for (uint256 escrowIndex = accountInfo.lockupStartIndex; ; ++escrowIndex) {</span></span></code></pre>\n<p>The code would go from:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">for (uint256 i; i &lt; numIterations; ++i) {  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> // ...  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}  </span></span></code></pre>\n<p>to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">for (uint256 i; i &lt; numIterations;) {  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> // ...  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> unchecked { ++i; }  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}  </span></span></code></pre>\n<p>The risk of overflow is inexistant for a <code>uint256</code> here.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/63#issuecomment-1064038809\">NickCuso (Foundation) commented</a>:</strong></p>\n<blockquote>\n<p>This was a very detailed and helpful gas report! I love that you commented the code with the @audit tags and detailed exactly how much savings could be made and why. This was very useful when evaluating the recommendations. </p>\n<p>We have implemented many of the suggestions here. Some we chose not to change in order to preserve readability. Generally the savings is inline with the expected values you have stated here.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/63#issuecomment-1070987129\">Alberto Cuesta Cañada (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Great report. Score: 4300 (including +20% from formatting)</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-3\">High Risk Findings (3)</a></p>\n<ul>\n<li><a href=\"#h-01-nft-owner-can-create-multiple-auctions\">[H-01] NFT owner can create multiple auctions</a></li>\n<li><a href=\"#h-02-creators-can-steal-sale-revenue-from-owners-sales\">[H-02] Creators can steal sale revenue from owners’ sales</a></li>\n<li><a href=\"#h-03-an-offer-made-after-auction-end-can-be-stolen-by-an-auction-winner\">[H-03] An offer made after auction end can be stolen by an auction winner</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-18\">Medium Risk Findings (18)</a></p>\n<ul>\n<li><a href=\"#m-01-eip-712-signatures-can-be-re-used-in-private-sales\">[M-01] EIP-712 signatures can be re-used in private sales</a></li>\n<li><a href=\"#m-02-sendvaluewithfallbackwithdraw-withdrawfor-function-may-fail-to-withdraw-ether-recorded-in-pendingwithdrawals\">[M-02] <code>SendValueWithFallbackWithdraw</code>: <code>withdrawFor</code> function may fail to withdraw ether recorded in <code>pendingWithdrawals</code></a></li>\n<li><a href=\"#m-03-approve-race-condition-in-feth\">[M-03] Approve race condition in FETH</a></li>\n<li><a href=\"#m-04-adminaccountmigration-does-not-update-buypriceseller\">[M-04] <code>adminAccountMigration()</code> Does Not Update <code>buyPrice.seller</code></a></li>\n<li><a href=\"#m-05-exchange-does-not-split-royalty-revenue-correctly\">[M-05] Exchange does not split royalty revenue correctly</a></li>\n<li><a href=\"#m-06-buyfromprivatesalefor-will-fail-if-the-buyer-has-insufficient-balance-due-to-an-open-offer-on-the-same-nft\">[M-06] <code>buyFromPrivateSaleFor()</code> Will Fail if The Buyer Has Insufficient Balance Due to an Open Offer on The Same NFT</a></li>\n<li><a href=\"#m-07-_getcreatorpaymentinfo-is-not-equipped-to-handle-reverts-on-an-unbounded-_recipients-array\">[M-07] <code>_getCreatorPaymentInfo()</code> is Not Equipped to Handle Reverts on an Unbounded <code>_recipients</code> Array</a></li>\n<li><a href=\"#m-08-primary-seller-can-avoid-paying-the-primary-fee\">[M-08] Primary seller can avoid paying the primary fee</a></li>\n<li><a href=\"#m-09-missing-receiver-validation-in-withdrawfrom\">[M-09] Missing receiver validation in <code>withdrawFrom</code></a></li>\n<li><a href=\"#m-10-lockedbalance-library-should-drop-parameters-to-9632-bits\">[M-10] <code>LockedBalance</code> library should drop parameters to 96/32 bits</a></li>\n<li><a href=\"#m-11-max_royalty_recipients_index-set-too-low\">[M-11] <code>MAX_ROYALTY_RECIPIENTS_INDEX</code> set too low</a></li>\n<li><a href=\"#m-12-private-sale-spoofing\">[M-12] Private sale spoofing</a></li>\n<li><a href=\"#m-13-escrowed-nft-can-be-stolen-by-anyone-if-no-active-buyprice-or-auction-exists-for-it\">[M-13] Escrowed NFT can be stolen by anyone if no active <code>buyPrice</code> or auction exists for it</a></li>\n<li><a href=\"#m-14-upgradable-escrow-contract\">[M-14] Upgradable escrow contract</a></li>\n<li><a href=\"#m-15-royalties-can-be-distribution-unfairly-among-creatorrecipients-for-nft-contracts-with-non-standard-getroyalties-returns\">[M-15] Royalties can be distribution unfairly among <code>creatorRecipients</code> for NFT contracts with non-standard <code>getRoyalties()</code> returns</a></li>\n<li><a href=\"#m-16-inappropriate-support-of-eip-2981\">[M-16] Inappropriate support of EIP-2981</a></li>\n<li><a href=\"#m-17-there-is-no-support-for-the-trading-of-cryptopunks\">[M-17] There is no Support For The Trading of Cryptopunks</a></li>\n<li><a href=\"#m-18-fees-are-incorrectly-charged-on-unfinalized-nft-sales\">[M-18] Fees Are Incorrectly Charged on Unfinalized NFT Sales</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#l-01-unhandled-marketlockupfor-edge-case\">L-01 Unhandled <code>marketLockupFor()</code> Edge Case</a></li>\n<li><a href=\"#n-01-signature-re-use\">N-01 Signature Re-Use</a></li>\n<li><a href=\"#n-02-unclear-function-naming\">N-02 Unclear Function Naming</a></li>\n<li><a href=\"#n-03-improper-basis_points-check-in-_distributefunds\">N-03 Improper <code>BASIS_POINTS</code> Check in <code>_distributeFunds()</code></a></li>\n<li><a href=\"#n-04-improper-state-handling\">N-04 Improper State Handling</a></li>\n<li><a href=\"#n-05-no-support-for-erc1155-tokens\">N-05 No Support For <code>ERC1155</code> Tokens</a></li>\n<li><a href=\"#n-06-unclear-_recipients-array-restriction\">N-06 Unclear <code>_recipients</code> Array Restriction</a></li>\n<li><a href=\"#n-07-inconsistent-use-of-sendvalue\">N-07 Inconsistent Use of <code>sendValue()</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#table-of-contents\">Table of Contents</a></li>\n<li><a href=\"#foreword\">Foreword</a></li>\n<li><a href=\"#file-fethsol\">File: FETH.sol</a></li>\n<li><a href=\"#file-nftmarketbuypricesol\">File: NFTMarketBuyPrice.sol</a></li>\n<li><a href=\"#file-nftmarketfeessol\">File: NFTMarketFees.sol</a></li>\n<li><a href=\"#file-nftmarketoffersol\">File: NFTMarketOffer.sol</a></li>\n<li><a href=\"#file-nftmarketreserveauctionsol\">File: NFTMarketReserveAuction.sol</a></li>\n<li><a href=\"#general-recommendations\">General recommendations</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the Foundation smart contract system written in Solidity. The audit contest took place between February 24—March 2 2022.\n\n## Wardens\n\n34 Wardens contributed reports to the Foundation contest:\n\n  1. [leastwood](https://twitter.com/liam_eastwood13)\n  1. IllIllI\n  1. [cmichel](https://twitter.com/cmichelio)\n  1. WatchPug ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n  1. [0xliumin](https://twitter.com/0xliumin)\n  1. cccz\n  1. [gzeon](https://twitter.com/gzeon)\n  1. 0x1f8b\n  1. hyh\n  1. [Dravee](https://twitter.com/JustDravee)\n  1. [shenwilly](https://twitter.com/shenwilly_)\n  1. [wuwe1](https://twitter.com/wuwe19)\n  1. thankthedark (d4rk and thank_you)\n  1. CertoraInc ([danb](https://twitter.com/danbinnun), egjlmn1, [OriDabush](https://twitter.com/ori_dabush), ItayG, and shakedwinder)\n  1. [defsec](https://twitter.com/defsec_)\n  1. Afanasyevich\n  1. pedroais\n  1. TerrierLover\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. hubble (ksk2345 and shri4net)\n  1. kenta\n  1. [rfa](https://www.instagram.com/riyan_rfa/)\n  1. robee\n  1. [iain](http://twitter.com/isiain)\n  1. 0xwags\n  1. [kirk-baird](https://twitter.com/kirkthebaird)\n  1. [Ruhum](https://twitter.com/0xruhum)\n  1. jayjonah8\n\nThis contest was judged by [Alberto Cuesta Cañada](https://twitter.com/alcueca).\n\nFinal report assembled by [liveactionllama](https://twitter.com/liveactionllama).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 21 unique vulnerabilities. Of these vulnerabilities, 3 received a risk rating in the category of HIGH severity and 18 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 20 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 11 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 Foundation contest repository](https://github.com/code-423n4/2022-02-foundation), and is composed of 16 smart contracts written in the Solidity programming language and includes 1,689 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# High Risk Findings (3)\n## [[H-01] NFT owner can create multiple auctions](https://github.com/code-423n4/2022-02-foundation-findings/issues/23)\n_Submitted by 0xliumin, also found by leastwood_\n\n[NFTMarketReserveAuction.sol#L325-L349](https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketReserveAuction.sol#L325-L349)<br>\n[NFTMarketReserveAuction.sol#L596-L599](https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketReserveAuction.sol#L596-L599)<br>\n\nNFT owner can permanently lock funds of bidders.\n\n### Proof of Concept\n\nAlice (the attacker) calls `createReserveAuction`, and creates one like normal. let this be auction id 1.\n\nAlice calls `createReserveAuction` again, before any user has placed a bid (this is easy to guarantee with a deployed attacker contract). We'd expect that Alice wouldn't be able to create another auction, but she can, because `_transferToEscrow` doesn't revert if there's an existing auction. let this be Auction id 2.\n\nSince `nftContractToTokenIdToAuctionId[nftContract][tokenId]` will contain auction id 2, all bidders will see that auction as the one to bid on (unless they inspect contract events or data manually).\n\nAlice can now cancel auction id 1, then cancel auction id 2, locking up the funds of the last bidder on auction id 2 forever.\n\n### Recommended Mitigation Steps\n\nPrevent NFT owners from creating multiple auctions.\n\n**[NickCuso (Foundation) confirmed and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/23#issuecomment-1054614690):**\n > This is a great find!\n> \n> The impact of this bug is:\n>  - Bidder's funds are stuck in escrow in an unrecoverable way without an upgrade, and even with an upgrade it would have been non-trivial to offer a migration path to recover the funds (but it would have been possible to recover correctly).\n>  - It allows sellers to stop the clock and/or back out of an auction. Normally once a bid is received we do not allow the seller to cancel the auction. With this bug, they could have created a new auction and then cancel that in order to back out of the deal entirely. This violates trust with collectors.\n> \n> We have fixed this problem by adding the following code to `createReserveAuction`:\n> \n> ```solidity\n>     // This check must be after _transferToEscrow in case auto-settle was required\n>     if (nftContractToTokenIdToAuctionId[nftContract][tokenId] != 0) {\n>       revert NFTMarketReserveAuction_Already_Listed(nftContractToTokenIdToAuctionId[nftContract][tokenId]);\n>     }\n> ```\n\n\n\n***\n\n## [[H-02] Creators can steal sale revenue from owners' sales](https://github.com/code-423n4/2022-02-foundation-findings/issues/30)\n_Submitted by IllIllI_\n\n[NFTMarketCreators.sol#L158-L160](https://github.com/code-423n4/2022-02-foundation/blob/a03a7e198c1dfffb1021c0e8ec91ba4194b8aa12/contracts/mixins/NFTMarketCreators.sol#L158-L160)<br>\n[NFTMarketCreators.sol#L196-L198](https://github.com/code-423n4/2022-02-foundation/blob/a03a7e198c1dfffb1021c0e8ec91ba4194b8aa12/contracts/mixins/NFTMarketCreators.sol#L196-L198)<br>\n[NFTMarketCreators.sol#L97-L99](https://github.com/code-423n4/2022-02-foundation/blob/a03a7e198c1dfffb1021c0e8ec91ba4194b8aa12/contracts/mixins/NFTMarketCreators.sol#L97-L99)<br>\n\nAccording to the [`README.md`](<https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/README.md?plain=1#L21>):\n\n> All sales in the Foundation market will pay the creator 10% royalties on secondary sales. This is not specific to NFTs minted on Foundation, it should work for any NFT. If royalty information was not defined when the NFT was originally deployed, it may be added using the Royalty Registry which will be respected by our market contract.\n\nUsing the Royalty Registry an owner can decide to change the royalty information right before the sale is complete, affecting who gets what.\n\n### Impact\n\nBy updating the registry to include the seller as one of the royalty recipients, the creator can steal the sale price minus fees. This is because if code finds that the seller is a royalty recipient the royalties are all passed to the creator regardless of whether the owner is the seller or not.\n\n### Proof of Concept\n\n```solidity\n          // 4th priority: getRoyalties override\n          if (recipients.length == 0 && nftContract.supportsERC165Interface(type(IGetRoyalties).interfaceId)) {\n            try IGetRoyalties(nftContract).getRoyalties{ gas: READ_ONLY_GAS_LIMIT }(tokenId) returns (\n              address payable[] memory _recipients,\n              uint256[] memory recipientBasisPoints\n            ) {\n              if (_recipients.length > 0 && _recipients.length == recipientBasisPoints.length) {\n                bool hasRecipient;\n                for (uint256 i = 0; i < _recipients.length; ++i) {\n                  if (_recipients[i] != address(0)) {\n                    hasRecipient = true;\n                    if (_recipients[i] == seller) {\n                      return (_recipients, recipientBasisPoints, true);\n```\n\n<https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L127-L154>\n\nWhen `true` is returned as the final return value above, the following code leaves `ownerRev` as zero because `isCreator` is `true`.\n\n```solidity\n      uint256 ownerRev\n    )\n  {\n    bool isCreator;\n    (creatorRecipients, creatorShares, isCreator) = _getCreatorPaymentInfo(nftContract, tokenId, seller);\n\n    // Calculate the Foundation fee\n    uint256 fee;\n    if (isCreator && !_nftContractToTokenIdToFirstSaleCompleted[nftContract][tokenId]) {\n      fee = PRIMARY_FOUNDATION_FEE_BASIS_POINTS;\n    } else {\n      fee = SECONDARY_FOUNDATION_FEE_BASIS_POINTS;\n    }\n\n    foundationFee = (price * fee) / BASIS_POINTS;\n\n    if (creatorRecipients.length > 0) {\n      if (isCreator) {\n        // When sold by the creator, all revenue is split if applicable.\n        creatorRev = price - foundationFee;\n      } else {\n        // Rounding favors the owner first, then creator, and foundation last.\n        creatorRev = (price * CREATOR_ROYALTY_BASIS_POINTS) / BASIS_POINTS;\n        ownerRevTo = seller;\n        ownerRev = price - foundationFee - creatorRev;\n      }\n    } else {\n      // No royalty recipients found.\n      ownerRevTo = seller;\n      ownerRev = price - foundationFee;\n    }\n  }\n```\n\nIn addition, if the index of the seller in `_recipients` is greater than `MAX_ROYALTY_RECIPIENTS_INDEX`, then the seller is omitted from the calculation and gets zero (`_sendValueWithFallbackWithdraw()` doesn't complain when it sends zero).\n\n```solidity\n        uint256 maxCreatorIndex = creatorRecipients.length - 1;\n        if (maxCreatorIndex > MAX_ROYALTY_RECIPIENTS_INDEX) {\n          maxCreatorIndex = MAX_ROYALTY_RECIPIENTS_INDEX;\n        }\n```\n\n<https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L76-L79>\n\nThis issue does a lot of damage because the creator can choose whether and when to apply it on a sale-by-sale basis. Two other similar, but separate, exploits are available for the other blocks in `_getCreatorPaymentInfo()` that return arrays but they either require a malicious NFT implementation or can only specify a static seller for which this will affect things. In all cases, not only may the seller get zero dollars for the sale, but they'll potentially owe a lot of taxes based on the 'sale' price. The attacker may or may not be the creator - creators can be bribed with kickbacks.\n\n### Recommended Mitigation Steps\n\nAlways calculate owner/seller revenue separately from royalty revenue.\n\n**[NickCuso (Foundation) confirmed and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/30#issuecomment-1060623733):**\n > This is a great discovery and a creative way for creators to abuse the system, stealing funds from a secondary sale. Thank you for reporting this.\n> \n> It's a difficult one for us to address. We want to ensure that NFTs minted on our platform as a split continue to split revenue from the initial sale. We were using `isCreator` from `_getCreatorPaymentInfo` as our way of determining if all the revenue from a sale should go to the royalty recipients, which is a split contract for the use case we are concerned about here.\n> \n> The royalty override makes it easy for a creator to choose to abuse this feature at any time. So that was our primary focus for this fix.\n> \n> This is the change we have made in `_getFees`:\n> \n> ```solidity\n>     bool isCreator = false;\n>     // lookup for tokenCreator\n>     try ITokenCreator(nftContract).tokenCreator{ gas: READ_ONLY_GAS_LIMIT }(tokenId) returns (\n>       address payable _creator\n>     ) {\n>       isCreator = _creator == seller;\n>     } catch // solhint-disable-next-line no-empty-blocks\n>     {\n>       // Fall through\n>     }\n> \n>     (creatorRecipients, creatorShares) = _getCreatorPaymentInfo(nftContract, tokenId);\n> ```\n> \n> Since the royalty override is only considered in `_getCreatorPaymentInfo` we are no longer vulnerable to someone adding logic after the NFT has been released to try and rug pull the current owner(s).\n> \n> It is still possible for someone to try and abuse this logic, but to do so they must have built into the NFT contract itself a way to lie about who the `tokenCreator` is before the time of a sale. If we were to detect this happening, we would moderate that collection from the Foundation website. Additionally we will think about a longer term solution here so that this type of attack is strictly not possible with our market contract.\n\n\n\n***\n\n## [[H-03] An offer made after auction end can be stolen by an auction winner](https://github.com/code-423n4/2022-02-foundation-findings/issues/49)\n_Submitted by hyh, also found by leastwood, shenwilly, and WatchPug_\n\nAn Offer which is made for an NFT when auction has ended, but its winner hasn't received the NFT yet, can be stolen by this winner as `_transferFromEscrow` being called by `_acceptOffer` will transfer the NFT to the winner, finalising the auction, while no transfer to the user who made the offer will happen.\n\nThis way the auction winner will obtain both the NFT and the offer amount after the fees at no additional cost, at the expense of the user who made the offer.\n\n### Proof of Concept\n\nWhen an auction has ended, there is a possibility to make the offers for an auctioned NFT as:\n\n`makeOffer` checks `_isInActiveAuction`:\n\n<https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L200>\n\n`_isInActiveAuction` returns false when `auctionIdToAuction[auctionId].endTime < block.timestamp`, so `makeOffer` above can proceed:\n\n<https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketReserveAuction.sol#L666-L669>\n\nThen, the auction winner can call `acceptOffer -> _acceptOffer` (or `setBuyPrice -> _autoAcceptOffer -> _acceptOffer`).\n\n`_acceptOffer` will try to transfer directly, and then calls `_transferFromEscrow`:\n\n<https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L262-L271>\n\nIf the auction has ended, but a winner hasn't picked up the NFT yet, the direct transfer will fail, proceeding with `_transferFromEscrow` in the FNDNFTMarket defined order:\n\n    function _transferFromEscrow(\n    address nftContract,\n    uint256 tokenId,\n    address recipient,\n    address seller\n    ) internal override(NFTMarketCore, NFTMarketReserveAuction, NFTMarketBuyPrice, NFTMarketOffer) {\n    super._transferFromEscrow(nftContract, tokenId, recipient, seller);\n    }\n\nNFTMarketOffer.\\_transferFromEscrow will call super as `nftContractToIdToOffer` was already deleted:\n\n<https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L296-L302>\n\nNFTMarketBuyPrice.\\_transferFromEscrow will call super as there is no buy price set:\n\n<https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketBuyPrice.sol#L283-L293>\n\nFinally, NFTMarketReserveAuction.\\_transferFromEscrow will send the NFT to the winner via `_finalizeReserveAuction`, not to the user who made the offer:\n\n<https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketReserveAuction.sol#L556-L560>\n\nThe `recipient` user who made the offer is not present in this logic, the NFT is being transferred to the `auction.bidder`, and the original `acceptOffer` will go through successfully.\n\n### Recommended Mitigation Steps\n\nAn attempt to set a buy price from auction winner will lead to auction finalisation, so `_buy` cannot be called with a not yet finalised auction, this way the NFTMarketReserveAuction.\\_transferFromEscrow L550-L560 logic is called from the NFTMarketOffer.\\_acceptOffer only:\n\n<https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L270>\n\nis the only user of\n\n<https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketReserveAuction.sol#L550-L560>\n\nThis way the fix is to update L556-L560 for the described case as:\n\nNow:\n\n    // Finalization will revert if the auction has not yet ended.\n    _finalizeReserveAuction(auctionId, false);\n\n    // Finalize includes the transfer, so we are done here.\n    return;\n\nTo be, we leave the NFT in the escrow and let L564 super call to transfer it to the recipient:\n\n    // Finalization will revert if the auction has not yet ended.\n    _finalizeReserveAuction(auctionId, true);\n\n**[NickCuso (Foundation) confirmed and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/49#issuecomment-1060649574):**\n > Yes! This was a great find and a major issue with our implementation. I'm very happy that it was flagged by a few different people, it helps raise our confidence that several wardens really dove into the code.\n> \n> It was a big miss on our part that this was not thoroughly tested. Our tests for this scenario confirmed the events and payouts, but did not validate the ownership in the end!\n> \n> The proposed fix is perfect and exactly what we have implemented. This follows the patterns we established well, and actually simplifies the logic here so that things are easier to reason about.\n\n\n\n***\n \n# Medium Risk Findings (18)\n## [[M-01] EIP-712 signatures can be re-used in private sales](https://github.com/code-423n4/2022-02-foundation-findings/issues/68)\n_Submitted by thankthedark, also found by Afanasyevich and cmichel_\n\n[NFTMarketPrivateSale.sol#L123-L174](https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketPrivateSale.sol#L123-L174)<br>\n\nWithin a NFTMarketPrivateSale contract, buyers are allowed to purchase a seller's NFT. This is done through a seller providing a buyer a EIP-712 signature. The buyer can then call `#buyFromPrivateSaleFor` providing the v, r, and s values of the signature as well as any additional details to generate the message hash. If the signature is valid, then the NFT is transferred to the buyer.\n\nThe problem with the code is that EIP-712 signatures can be re-used within a small range of time assuming that the original seller takes back ownership of the NFT. This is because the NFTMarketPrivateSale#buyFromPrivateSaleFor method has no checks to determine if the EIP-712 signature has been used before.\n\n### Proof of Concept\n\nConsider the following example:\n\n1.  Joe the NFT owner sells a NFT to the malicious buyer Rachel via a private sale.\n2.  Rachel through this private sale obtains the EIP-712 signature and uses it to purchase a NFT.\n3.  Joe the NFT owner purchases back the NFT within two days of the original sale to Rachel.\n4.  Joe the NFT owner puts the NFT back on sale.\n5.  Rachel, who has the original EIP-712 signature, can re-purchase the NFT by calling `#buyFromPrivateSaleFor` again with the same parameters they provided in the original private sale purchase in step 1.\n\nThe `#buyFromPrivateSaleFor` [function](https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketPrivateSale.sol#L123) runs several validation checks before transferring the NFT over to the buyer. The validations are as follows:\n\n1.  L#132 - The signature has expired.\n2.  L#135 - The deadline is beyond 48 hours from now.\n3.  L#143 - The amount argument is greater than msg.value.\n4.  L#149 - The msg.value is greater than the amount set.\n5.  L#171 - This checks that the EIP-712 signature comes from the NFT seller.\n\nAs you can see, there are no checks that the EIP-712 signature has been used before. If the original NFT seller purchases back the NFT, then they are susceptible to having the original buyer taking back the NFT. This can be problematic if the NFT has risen in value, as the original buyer can utilize the same purchase amount from the first transaction in this malicious transaction.\n\n### Recommended Mitigation Steps\n\nMost contracts utilize nonces when generating EIP-712 signatures to ensure that the contract hasn't been used for. When a nonce is injected into a signature, it makes it impossible for re-use, assuming of course the nonce feature is done correctly.\n\n**[NickCuso (Foundation) confirmed and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/68#issuecomment-1057990473):**\n > Yes, this is a good point to raise and something like this could happen because it's not intuitive to think that the private sale remains valid after it's been used.\n> \n> This is mitigated by the short time window we use for Private Sales. Our frontend uses 24-hour expirations and in the contract we ensure the window is <= 48 hours.\n> \n> In order to remain backwards compatible with our existing integration and any signatures which are outstanding at the time of the upgrade, we decided not to use `nonce` as recommended. Instead we simply store a mapping tracking if the exact private sale terms have already been used.\n> \n> Here's the primary addition:\n> \n> ```solidity\n>     // Ensure that the offer can only be accepted once.\n>     if (privateSaleInvalidated[nftContract][tokenId][msg.sender][seller][amount][deadline]) {\n>       revert NFTMarketPrivateSale_Signature_Canceled_Or_Already_Claimed();\n>     }\n>     privateSaleInvalidated[nftContract][tokenId][msg.sender][seller][amount][deadline] = true;\n> ```\n\n\n\n***\n\n## [[M-02] `SendValueWithFallbackWithdraw`: `withdrawFor` function may fail to withdraw ether recorded in `pendingWithdrawals`](https://github.com/code-423n4/2022-02-foundation-findings/issues/12)\n_Submitted by cccz_\n\nThe NFTMarketFees contract and the NFTMarketReserveAuction contract use the \\_sendValueWithFallbackWithdraw function to send ether to FoundationTreasury, CreatorRecipients, Seller, Bidder.\nWhen the receiver fails to receive due to some reasons (exceeding the gas limit or the receiver contract cannot receive ether), it will record the ether to be sent in the pendingWithdrawals variable.\n\n      function _sendValueWithFallbackWithdraw(\n        address payable user,\n        uint256 amount,\n        uint256 gasLimit\n      ) internal {\n        if (amount == 0) {\n          return;\n        }\n        // Cap the gas to prevent consuming all available gas to block a tx from completing successfully\n        // solhint-disable-next-line avoid-low-level-calls\n        (bool success, ) = user.call{ value: amount, gas: gasLimit }(\"\");\n        if (!success) {\n          // Record failed sends for a withdrawal later\n          // Transfers could fail if sent to a multisig with non-trivial receiver logic\n          unchecked {\n            pendingWithdrawals[user] += amount;\n          }\n          emit WithdrawPending(user, amount);\n        }\n      }\n\nThe user can then withdraw ether via the withdraw or withdrawFor functions.\n\n      function withdraw() external {\n        withdrawFor(payable(msg.sender));\n      }\n      function withdrawFor(address payable user) public nonReentrant {\n        uint256 amount = pendingWithdrawals[user];\n        if (amount == 0) {\n          revert SendValueWithFallbackWithdraw_No_Funds_Available();\n        }\n        pendingWithdrawals[user] = 0;\n        user.sendValue(amount);\n        emit Withdrawal(user, amount);\n      }\n\nHowever, the withdrawFor function can only send ether to the address recorded in pendingWithdrawals. When the recipient is a contract that cannot receive ether, these ethers will be locked in the contract and cannot be withdrawn.\n\n### Proof of Concept\n\n<https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/SendValueWithFallbackWithdraw.sol#L37-L77>\n\n### Recommended Mitigation Steps\n\nAdd the withdrawTo function as follows:\n\n      function withdrawTo(address payable to) public nonReentrant {\n        uint256 amount = pendingWithdrawals[msg.sneder];\n        if (amount == 0) {\n          revert SendValueWithFallbackWithdraw_No_Funds_Available();\n        }\n        pendingWithdrawals[msg.sneder] = 0;\n        to.sendValue(amount);\n        emit Withdrawal(msg.sneder, amount);\n      }\n\n**[NickCuso (Foundation) confirmed, but disagreed with High severity and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/12#issuecomment-1051183216):**\n > We believe this is better classified as a `2 (Med Risk)`.\n>  - Worst case is funds for a user are trapped in escrow, however they are correctly attributed to that user and cannot be accessed by any other account. If we did not address this by launch, the issue could be corrected post launch via a contract upgrade and that user would then be made whole. So the funds are just temporarily unavailable to them.\n> \n> This is a great report and we will be making a change to address the problem!\n> \n> When reviewing the recommended mitigation we identified a new potential risk that could introduce. So we are going a slightly different way...\n> \n> The `_sendValueWithFallbackWithdraw` function will send `FETH` tokens when it fails to transfer ETH. For any account that currently has a non-zero `pendingWithdrawals` we will include a migration function allowing us to move the escrowed ETH out of the market contract and into that user's FETH account. \n> \n> Once that migration has been completed, we will delete the migration function and withdraw* functions -- simplifying the market contract and freeing up much needed contract size to make room for new features in the future.\n\n**[Alberto Cuesta Cañada (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/12#issuecomment-1072299920):**\n > The combination of upgradability with the limited scope of the vulnerability makes it reasonable to downgrade this to a medium severity.\n\n\n\n***\n\n## [[M-03] Approve race condition in FETH](https://github.com/code-423n4/2022-02-foundation-findings/issues/14)\n_Submitted by 0x1f8b_\n\n[FETH.sol#L212](https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/FETH.sol#L212)<br>\n\nFront running attack in approve.\n\n### Proof of Concept\n\nThe contract of the `FETH` does not have any protection against the well-known “Multiple Withdrawal Attack” attack on the Approve/TransferFrom methods of the ERC20 standard.\n\nAlthough this attack poses a limited risk in specific situations, it is worth mentioning to consider it for possible future operations.\n\nThere are solutions to mitigate this front running such as, to first reduce the spender's allowance to 0 and set the desired value afterwards; another solution could the one that Open Zeppelin offers, where the non-standard decreaseAllowance and increaseAllowance functions have been added to mitigate the well-known issues involving setting allowances.\n\n### Recommended Mitigation Steps\n\nAdd increase and decrease allowance.\n\n**[NickCuso (Foundation) acknowledged and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/14#issuecomment-1060614467):**\n > Yes, this is a good best practice to be following. We will add these functions in the near future. In the meantime we've added an inline comment about the potential risk.\n> \n> At first we don't expect there will be much interest in using FETH outside of Foundation itself. Thanks to the trusted relationship with the market contract, approvals are not necessary. So this is not an issue that should come up in the near term.\n> \n> We are not fixing this immediately because it introduces a risk associated with another contract our users have deployed, that contract was not part of the contest repo. We are looking to patch that vulnerability and then will add `increaseAllowance` to FETH.\n\n\n\n***\n\n## [[M-04] `adminAccountMigration()` Does Not Update `buyPrice.seller`](https://github.com/code-423n4/2022-02-foundation-findings/issues/87)\n_Submitted by leastwood, also found by cccz_\n\n[NFTMarketReserveAuction.sol#L263-L292](https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketReserveAuction.sol#L263-L292)<br>\n[NFTMarketBuyPrice.sol#L125-L141](https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketBuyPrice.sol#L125-L141)<br>\n\nThe `adminAccountMigration()` function is called by the operator role to update all sellers' auctions. The `auction.seller` account is updated to the new address, however, the protocol fails to update `buyPrice.seller`. As a result, the protocol is put in a deadlock situation where the new address cannot cancel the auction and withdraw their NFT without the compromised account first cancelling the buy price and vice-versa. This is only recoverable if the new account is migrated back to the compromised account and then `cancelBuyPrice()` is called before migrating back.\n\n### Recommended Mitigation Steps\n\nConsider invalidating the buy offer before account migration.\n\n**[NickCuso (Foundation) confirmed and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/87#issuecomment-1060628220):**\n > Correct - if we were to use `adminAccountMigration` while the NFT had both an auction reserve price and had a buy price set this would have created a deadlock type situation where the NFT is in a bad state and we'd likely need to migrate the NFT back to the original owner in order to correct it.\n> \n> There were two possible solutions to this:\n>  - Update `adminAccountMigration` to update both auction and buy price at the same time.\n>  - Cut `adminAccountMigration` completely.\n> \n> We went with the latter solution. This is not a feature we have used in some time and as we continue to grow, it's not scalable since it required Foundation to get involved directly and included manual verification steps.\n> \n> Removing this feature has saved over 2KB in contract space as well, which we really needed in order to make room for new features and changes.\n\n\n\n***\n\n## [[M-05] Exchange does not split royalty revenue correctly](https://github.com/code-423n4/2022-02-foundation-findings/issues/29)\n_Submitted by IllIllI_\n\nAccording to the [`README.md`](https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/README.md?plain=1#L21):\n\n> If royalty information was not defined when the NFT was originally deployed, it may be added using the Royalty Registry which will be respected by our market contract.\n\nThe actual exchange code only respects the Royalty Registry or other royalty information if the number of recipients is less than or equal to four.\n\n### Impact\n\nIf the `creatorRecipients.length` is more than four then the array is essentially truncated and the royalties are only split among the first four entries in the array. If the array happens to be sorted from low to high then the people who were supposed to get the largest portions of the royalties are given nothing.\n\n### Proof of Concept\n\n```solidity\n        uint256 maxCreatorIndex = creatorRecipients.length - 1;\n        if (maxCreatorIndex > MAX_ROYALTY_RECIPIENTS_INDEX) {\n          maxCreatorIndex = MAX_ROYALTY_RECIPIENTS_INDEX;\n        }\n```\n\n<https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L76-L79>\n\n```solidity\n        // Send payouts to each additional recipient if more than 1 was defined\n        uint256 totalDistributed;\n        for (uint256 i = 1; i <= maxCreatorIndex; ++i) {\n          uint256 share = (creatorFee * creatorShares[i]) / totalShares;\n          totalDistributed += share;\n          _sendValueWithFallbackWithdraw(creatorRecipients[i], share, SEND_VALUE_GAS_LIMIT_MULTIPLE_RECIPIENTS);\n        }\n```\n\n<https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L99-L105>\n\nCreators shouldn't have to settle the correct amounts amongst themselves afterwards and doing so may trigger unwanted tax consequences for the creators who got the larger shares of funds.\n\n### Recommended Mitigation Steps\n\nFetch the royalty information during offer creation, cache it for the final transfer, and reject any NFT for which the array size is more than `MAX_ROYALTY_RECIPIENTS_INDEX`.\n\n**[NickCuso (Foundation) acknowledged and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/29#issuecomment-1055329404):**\n > Yes, this is correct. This behavior is intended -- however we should be more clear about that in the readme and inline comments. I'll add some comments inline to clarify.\n> \n> The reason we have a cap at all is because any number of addresses could be returned by these APIs. That would be okay if the creator themselves always paid the gas costs to process them, but since the costs are often pushed to the collectors or secondary sellers - we wanted to ensure the worst case scenario never got unreasonably expensive.\n> \n> The actual limit we put in place is arbitrary. However some limit is necessary to ensure a reasonable experience for our users.\n> \n> If the creator does want payouts to go to many different addresses, the recommended approach would be to send the royalties to a contract with then handles the split internally in a gas efficient manner, e.g. with https://www.0xsplits.xyz/\n\n\n\n***\n\n## [[M-06] `buyFromPrivateSaleFor()` Will Fail if The Buyer Has Insufficient Balance Due to an Open Offer on The Same NFT](https://github.com/code-423n4/2022-02-foundation-findings/issues/77)\n_Submitted by leastwood_\n\n[NFTMarketPrivateSale.sol#L143-L150](https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketPrivateSale.sol#L143-L150)<br>\n\nThe `buyFromPrivateSaleFor()` function allows sellers to make private sales to users. If insufficient `ETH` is provided to the function call, the protocol will attempt to withdraw the amount difference from the user's unlocked balance. However, if the same user has an open offer on the same NFT, then these funds will remain locked until expiration. As a result, the user cannot make use of these locked funds even though they may be needed for a successful sale.\n\n### Recommended Mitigation Steps\n\nConsider adding a `_cancelBuyersOffer()` call to the `buyFromPrivateSaleFor()` function. This should be added only to the case where insufficient `ETH` was provided to the trade. By cancelling the buyer's offer on the same NFT, we can guarantee that the user has access to the correct amount of funds.\n\n**[NickCuso (Foundation) confirmed and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/77#issuecomment-1058017830):**\n > Yes - completely agree. This was an oversight on our end - and as a result it created an inconsistent experience for users. Since we leveraged an outstanding offer balance for a `buy` purchase, the same behavior should occur when using Private Sales so that user's are not in a state where they cannot make the purchase due to incorrectly having their funds locked up.\n> \n> As you point out without this change, it's possible that the buyer using private sales continues to have their funds locked up for an Offer that can now only be accepted by themselves. It's an awkward state that should be avoided.\n> \n> We have made the recommended change.\n\n\n\n***\n\n## [[M-07] `_getCreatorPaymentInfo()` is Not Equipped to Handle Reverts on an Unbounded `_recipients` Array](https://github.com/code-423n4/2022-02-foundation-findings/issues/85)\n_Submitted by leastwood_\n\n[NFTMarketCreators.sol#L49-L251](https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketCreators.sol#L49-L251)<br>\n\nThe `_getCreatorPaymentInfo()` function is utilised by `_distributeFunds()` whenever an NFT sale is made. The function uses `try` and `catch` statements to handle bad API endpoints. As such, a revert in this function would lead to NFTs that are locked in the contract. Some API endpoints receive an array of recipient addresses which are iterated over. If for whatever reason the function reverts inside of a `try` statement, the revert is actually not handled and it will not fall through to the empty `catch` statement.\n\n### Proof of Concept\n\nThe end result is that valid and honest NFT contracts may revert if the call runs out of gas due to an unbounded `_recipients` array. `try` statements are only able to handle external calls.\n\n### Recommended Mitigation Steps\n\nConsider bounding the number of iterations to `MAX_ROYALTY_RECIPIENTS_INDEX` as this is already enforced by `_distributeFunds()`. It may be useful to identify other areas where the `try` statement will not handle reverts on internal calls.\n\n**[NickCuso (Foundation) confirmed and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/85#issuecomment-1062826549):**\n > Yes - this code is trying to be very defensive so that NFTs cannot get stuck in escrow. This is a great suggestion on how we could continue to improve.\n> \n> Instead of capping the loop lengths in `_getCreatorPaymentInfo` we have opted to remove them entirely. There was another simplification that happened recently to this function that made removal a viable option. Now the only other loop for this data is in _distributeFunds and we already cap the max length there.\n\n\n\n***\n\n## [[M-08] Primary seller can avoid paying the primary fee](https://github.com/code-423n4/2022-02-foundation-findings/issues/39)\n_Submitted by pedroais, also found by leastwood and WatchPug_\n\nA primary seller can circumvent the 15% fee and pay 5% as a secondary seller.\n\n### Context\n\nThe Foundation protocol charges a 15% fee if the sale is a primary sale and 5% if it's a secondary sale.<br>\n<https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L40>\n\nThere are 2 conditions that must be met for a sale to be considered primary:\n\n1.  The seller is one of the creators in the NFT metadata.\n2.  It's the first time this NFT is sold on the foundation protocol.\n\n<https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L188>\n\n### Proof of Concept\n\nBoth of these conditions can be easily circumvented by the primary seller.\n\n1.  He could transfer the NFT to a different wallet and sell it from there to break the first condition.\n\n2.  He can make a private sale to himself for 1\\$  (paying the 15% fee on a dust amount) and then do a public auction with the real price.\n\nWith any of these 2 methods, the primary seller can circumvent the 15% fee and pay 5% as a secondary seller which makes the primary seller fee optional to pay.\n\n**[NickCuso (Foundation) acknowledged amd commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/39#issuecomment-1057366311):**\n > Yes, this **is** possible. It's a good limitation to note and we should have it called out as a known issue / potential abuse path.\n> \n> It's not clear how we could avoid this though while still keeping primary fees around - so I think all we can do is document it for now. This has been true since our launch a year ago and we are not aware of anyone abusing it yet. We think that's because NFT provenance is very important, so if it was being sold from a different account than the creator it's possible that would not get as much attention and potentially sell for less than they could have gotten accepting the primary sale fee.\n\n\n\n***\n\n## [[M-09] Missing receiver validation in `withdrawFrom`](https://github.com/code-423n4/2022-02-foundation-findings/issues/42)\n_Submitted by cmichel_\n\n[FETH.sol#L433](https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/FETH.sol#L433)<br>\n\nThe `FETH.withdrawFrom` function does not validate its `to` parameter.<br>\nFunds can be lost if `to` is the zero address.\n\n> Similar issues have been judged as medium recently, see [Sandclock M-15](https://code4rena.com/reports/2022-01-sandclock/) / [Github issue](https://github.com/code-423n4/2022-01-sandclock-findings/issues/183#issuecomment-1024626171).\n\n### Recommended Mitigation Steps\n\nCheck that `to != 0`.\n\n**[NickCuso (Foundation) confirmed and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/42#issuecomment-1057368552):**\n > Yes, this is a good recommendation which may prevent users losing their funds due to user error. We have made the following change as recommended:\n> \n> ```solidity\n>  } else if (to == address(0)) {\n>       revert FETH_Cannot_Withdraw_To_Address_Zero();\n>     } else if (to == address(this)) {\n>       revert FETH_Cannot_Withdraw_To_FETH();\n>     }\n> ```\n\n\n\n***\n\n## [[M-10] `LockedBalance` library should drop parameters to 96/32 bits](https://github.com/code-423n4/2022-02-foundation-findings/issues/44)\n_Submitted by cmichel_\n\n[LockedBalance.sol#L56](https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/libraries/LockedBalance.sol#L56)<br>\n\nThe `LockedBalance` contract takes 256-bit amount values but performs bit math on them as if they were 96 bit values.\nBits could spill over to a different locked balance in the `else` part (`lockedBalance` stores **two** 128-bit locked balances in one 256-bit storage field):\n\n```solidity\nfunction set(\n  Lockups storage lockups,\n  uint256 index,\n  uint256 expiration,\n  uint256 totalAmount\n) internal {\n  unchecked {\n    // @audit-issue should drop totalAmount to 96, expiration to 128-96=32\n    uint256 lockedBalanceBits = totalAmount | (expiration << 96);\n    if (index % 2 == 0) {\n      // set first 128 bits.\n      index /= 2;\n      // @audit-info clears upper bits, then sets them\n      lockups.lockups[index] = (lockups.lockups[index] & last128BitsMask) | (lockedBalanceBits << 128);\n    } else {\n      // set last 128 bits.\n      index /= 2;\n      // @audit-info clears lower bits, then sets them\n      // @audit-issue sets entire 256-bit lockedBalanceBits instead of just 128-bit\n      lockups.lockups[index] = (lockups.lockups[index] & first128BitsMask) | lockedBalanceBits;\n    }\n  }\n}\n```\n\nIt could then increase the other, unrelated locked balance's amount leading to stealing funds from the protocol.\nAll callers of this function currently seem to ensure that `totalAmount` is indeed less than 96 bits but the `LockedBalance` library should be self-contained and not depend on the calling side to perform all checks.<br>\n\nIf the code is ever extended and more calls to these functions are performed, it'll likely cause issues.\n\n> The same issue happens in `setTotalAmount`\n\n### Recommended Mitigation Steps\n\nMake sure that there are only 96/32 bits set in `totalAmount` and `expiration` by dropping them to their respective types.\n\n```diff\nfunction set(\n  Lockups storage lockups,\n  uint256 index,\n  uint256 expiration,\n  uint256 totalAmount\n) internal {\n  unchecked {\n-    uint256 lockedBalanceBits = totalAmount | (expiration << 96);\n+    // cast it to uint256 again for the << 96 to work on 256-bits\n+    uint256 lockedBalanceBits = uint256(uint96(totalAmount)) | (uint256(uint32(expiration)) << 96);\n    \n    ...\n  }\n}\n```\n\n**[NickCuso (Foundation) acknowledged and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/44#issuecomment-1060632719):**\n > This is a good concern to flag. With this release we use a lot of slot packing strategies to try and save gas. We considered this suggestion, as well as potentially using the safe cast helpers from the OpenZeppelin library. For the moment at least, we decided not to make any changes here. We believe the assumptions behind these values are sound, and although it's mathematically possible for the assumptions to be violated, we don't believe it'll occur in production.\n> \n> For `totalAmount` for example, that value is always bound by the amount of ETH a user has sent to the FETH contract. Here are some notes we have written up about the size assumptions in our codebase:\n> \n> - ETH: uint96\n>   - Circulating supply is currently 119,440,269 ETH (119440269000000000000000000 wei / 1.2 \\* 10^26).\n>   - Max uint96 is 7.9 \\* 10^28.\n>   - Therefore any value capped by msg.value should never overflow uint96 assuming ETH total supply remains under 70,000,000,000 ETH.\n>     - There is currently ~2% inflation in ETH total supply (which fluctuates) and this value is expected to do down. We expect Ether will become deflationary before the supply reaches more than 500x current values.\n>   - 96 bits packs perfectly into a single slot with an address.\n> - Dates: uint32\n>   - Current date in seconds is 1643973923 (1.6 \\* 10^9).\n>   - Max uint32 is 4 \\* 10^9.\n>   - Dates will not overflow uint32 until 2104.\n>   - To ensure we don't behave unexpectedly in the future, we should require dates are <= max uint32.\n>   - uint40 would allow enough space for any date, but it's an awkward size to pack with.\n> - Sequence ID indexes: uint32\n>   - Our max sequence ID today is 149,819 auctions.\n>   - Max uint32 is 4 \\* 10^9.\n>   - Indexes will not overflow uint32 until we see >28,000x growth. This is the equiv to ~300 per block for every block in Ethereum to date.\n\n\n\n***\n\n## [[M-11] `MAX_ROYALTY_RECIPIENTS_INDEX` set too low](https://github.com/code-423n4/2022-02-foundation-findings/issues/45)\n_Submitted by cmichel_\n\n[NFTMarketFees.sol#L78](https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L78)<br>\n\nThe creator payouts are capped at `MAX_ROYALTY_RECIPIENTS_INDEX`. It's currently set to `4` and only 5 creators are paid out.<br>\nOther creators are ignored.\n\n### Recommended Mitigation Steps\n\nI don't think cases with more than 5 creators / royalty receivers are unlikely.<br>\nIt can and should probably be increased, especially as the transfers are already gas restricted.\n\n**[NickCuso (Foundation) acknowledged and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/45#issuecomment-1057382530):**\n > Yes this is a fair point. The limit we put in place is arbitrary. We want some limit in order to ensure that the gas costs (which are often pushed to users other than the original creator) never get to be very expensive.\n> \n> What we can and should do is document this limitation so that it's more clear what exactly will happen when too many recipients are defined. Additionally we should comment on a possible workaround: If you have a contract that splits with too many participants you could use the Royalty Override in order to define a single contract recipient instead to handle the splits - e.g. https://www.0xsplits.xyz/\n\n\n\n***\n\n## [[M-12] Private sale spoofing](https://github.com/code-423n4/2022-02-foundation-findings/issues/46)\n_Submitted by cmichel_\n\n[NFTMarketPrivateSale.sol#L156](https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketPrivateSale.sol#L156)<br>\n\nSimilar to [spoofing in finance](https://en.wikipedia.org/wiki/Spoofing_\\(finance\\)), users can create private sales with correct signatures but then frontrun the buy with a transfer to a different wallet they control.\n\nNo funds are lost as the NFT <> FETH exchange is atomic but it can be bad if third parties create a naive off-chain centralized NFT market based on this signature feature.<br>\nIt's also frustrating for the users if they try to accept the private sale but their transaction fails.\n\n### Recommended Mitigation Steps\n\nThis is made possible because private sales do not keep the NFT in escrow.<br>\nConsider escrowing the NFT also for private sales.\n\n**[NickCuso (Foundation) acknowledged and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/46#issuecomment-1057389683):**\n > We are actually considering moving private sales to an escrow system. But we'll leave it as-is for now for backwards compatibility and to simplify our upcoming launch.\n> \n> We understand this could happen and will update the comments to make that more clear.\n\n\n\n***\n\n## [[M-13] Escrowed NFT can be stolen by anyone if no active `buyPrice` or auction exists for it](https://github.com/code-423n4/2022-02-foundation-findings/issues/51)\n_Submitted by hyh, also found by wuwe1_\n\nIf a NFT happens to be in escrow with neither buyPrice, nor auction being initialised for it, there is a way to obtain it for free by any actor via `makeOffer`, `acceptOffer` combination.\n\nI.e. a malicious user can track the FNDNFTMarket contract and obtain any NFT from it for which there are no buyPrice or auction structures initialised. For example, if a NFT is mistakenly sent to the contract, an attacker can immediately steal it.\n\nThis will happen as NFT is being guarded by buyPrice and auction structures only. The severity here is medium as normal usage of the system imply that either one of them is initialised (NFT was sent to escrow as a part of `setBuyPrice` or `createReserveAuction`, and so one of the structures is present), so this seems to leave only mistakenly sent assets exposed.\n\n### Proof of Concept\n\nAn attacker can make a tiny offer with `makeOffer`:\n\n<https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L189>\n\nThen call `acceptOffer`, which will lead to `_acceptOffer`.\n\nDirect NFT transfer will fail in `_acceptOffer` as the NFT is being held by the contract and `_transferFromEscrow` will be called instead:\n\n<https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L262-L271>\n\n`_transferFromEscrow` calls will proceed according to the FNDNFTMarket defined order:\n\n    function _transferFromEscrow(\n    ...\n    ) internal override(NFTMarketCore, NFTMarketReserveAuction, NFTMarketBuyPrice, NFTMarketOffer) {\n       super._transferFromEscrow(nftContract, tokenId, recipient, seller);\n    }\n\nIf there are no corresponding structures, the NFTMarketOffer, NFTMarketBuyPrice and NFTMarketReserveAuction versions of `_transferFromEscrow` will pass through the call to NFTMarketCore's plain transfer implementation:\n\n<https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketCore.sol#L77-L87>\n\nThis will effectively transfer the NFT to the attacker, which will pay gas costs and an arbitrary small offer price for it.\n\n### Recommended Mitigation Steps\n\nConsider adding additional checks to control who can obtain unallocated NFTs from the contract.\n\nProtocol controlled entity can handle such cases manually by initial sender's request.\n\n**[NickCuso (Foundation) confirmed and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/51#issuecomment-1057448438):**\n > Yes, this is an interesting scenario to raise! We do have more than one NFT in the market contract which was transferred directly (vs tracked as part of escrow). So there is some exposure already.\n> \n> We feel this is a `2 (Med Risk)`:\n>  - It only impacts NFTs which were thought to be effectively burned as they were transferred to the Market contract with no way to get them back.\n>  - Presumably the NFTs which get stuck in the Market contract like that were due to user error. So in theory this could have been thought of a sort of a feature - it allows those NFTs to be recovered, which is great for the original creator which will see royalties from future sales again.\n> \n> We have fixed this. We took a slightly different approach than what was recommended, but it should accomplish the same goal. `_transferFromEscrow` changed the `seller` param to `authorizeSeller`. As the call travels through each mixin, we change `authorizeSeller` to `address(0)` once an escrow manager is able to confirm ownership. Finally when the call reaches `NFTMarketCore` it requires that `authorizeSeller` is `address(0)` before executing the transfer -- this confirms that one or more escrow managers (buy now or auctions) have positively confirmed the seller. So NFTs in the Market without being escrowed now reverts on this line.\n\n\n\n***\n\n## [[M-14] Upgradable escrow contract](https://github.com/code-423n4/2022-02-foundation-findings/issues/53)\n_Submitted by gzeon_\n\nUpgradable escrow contract poses great risk to user who approved their NFT to the contract. Most popular token / NFT exchange do not require user to approve their asset to admin upgradable contract.\n\nThis also increases user gas usage because they would have to revoke approval when they are done with the protocol.\n\n### Proof of Concept\n\n<https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/FNDNFTMarket.sol>\n\n### Recommended Mitigation Steps\n\nSeparate the escrow contract to make it non-upgradable with a restricted set of functionality.\n\n**[NickCuso (Foundation) acknowledged and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/53#issuecomment-1057450900):**\n > This is an interesting suggestion. I'm not sure if the recommendation really reduces the risk though. If we were to make the escrow portion immutable, the trust still depends on the upgradeable market contract to do the correct thing. If I'm understanding the suggestion correctly, the terms of the deal would still be defined in the upgradeable contract - so even with an immutable escrow manager we could theoretically upgrade the market to allow us to `buy` each of the NFTs for 0 ETH.\n\n\n\n***\n\n## [[M-15] Royalties can be distribution unfairly among `creatorRecipients` for NFT contracts with non-standard `getRoyalties()` returns](https://github.com/code-423n4/2022-02-foundation-findings/issues/57)\n_Submitted by WatchPug_\n\nBased on our research, `getRoyalties()` is not a standardized API for NFT contracts to indicate how the royalties should be distributed among the recipients.\n\nHowever, in the current implementation, it always assumes that `getRoyalties()` return in terms of BPS.\n\n[NFTMarketCreators.sol#L85-L112](https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketCreators.sol#L85-L112)<br>\n\n[NFTMarketFees.sol#L86-L90](https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketFees.sol#L86-L90)<br>\n\n```solidity\nif (creatorShares[i] > BASIS_POINTS) {\n    // If the numbers are >100% we ignore the fee recipients and pay just the first instead\n    maxCreatorIndex = 0;\n    break;\n}\n```\n\nAs a result, if a particular implementation is returning `get Royalties()` with higher precision (say 1e6 for 100% instead of 1e4/BPS), the distribution of royalties can be distorted.\n\n### Proof of Concept\n\nGiven:\n\n*   `NFT-Token1` `Royalties`:\n\n    *   Address0 = 10,000 (1%)\n    *   Address1 = 10,000 (1%)\n    *   Address2 = 100,000 (10%)\n    *   Address3 = 880,000 (88%)\n\n*   Alice owns the `NFT-Token1`\n\n1.  Alice `setBuyPrice()` and listed `NFT-Token1` for `10 ETH`;\n\n2.  Bob `buy()` with `10 ETH`:\n\n*   `foundationFee` = `0.5 ETH`\n*   `creatorFee` = `1 ETH`\n*   `ownerRev` = ` 8.5 ETH  `\n\nSince `creatorShares[address2]` > `BASIS_POINTS` (10,000), all the `creatorFee` will be sent to the first address: `Address0`, which is expected to receive only `1%` of the royalties.\n\n### Recommended Mitigation Steps\n\nConsider removing this and change to:\n\n```solidity\n// Determine the total shares defined so it can be leveraged to distribute below\nuint256 totalShares;\nunchecked {\n  // The array length cannot overflow 256 bits.\n  for (uint256 i = 0; i <= maxCreatorIndex; ++i) {\n    // The check above ensures totalShares wont overflow.\n    totalShares += creatorShares[i];\n  }\n}\nif (totalShares == 0) {\n  maxCreatorIndex = 0;\n}\n```\n\n**[NickCuso (Foundation) acknowledged and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/57#issuecomment-1062150873):**\n > This is a fair concern to raise, and a reasonable solution recommendation. We will consider making a change like this in the future.\n> \n> AFAIK this API was first introduced by Manifold, which named and implemented the return value to be in basis points. It's true that since this is not a standard that others may use a different precision, however we have not yet encountered any example of that.\n\n\n\n***\n\n## [[M-16] Inappropriate support of EIP-2981](https://github.com/code-423n4/2022-02-foundation-findings/issues/58)\n_Submitted by WatchPug_\n\n[NFTMarketCreators.sol#L65-L82](https://github.com/code-423n4/2022-02-foundation/blob/4d8c8931baffae31c7506872bf1100e1598f2754/contracts/mixins/NFTMarketCreators.sol#L65-L82)<br>\n\n```solidity\nif (nftContract.supportsERC165Interface(type(IRoyaltyInfo).interfaceId)) {\n  try IRoyaltyInfo(nftContract).royaltyInfo{ gas: READ_ONLY_GAS_LIMIT }(tokenId, BASIS_POINTS) returns (\n    address receiver,\n    uint256 /* royaltyAmount */\n  ) {\n    if (receiver != address(0)) {\n      recipients = new address payable[](1);\n      recipients[0] = payable(receiver);\n      // splitPerRecipientInBasisPoints is not relevant when only 1 recipient is defined\n      if (receiver == seller) {\n        return (recipients, splitPerRecipientInBasisPoints, true);\n      }\n    }\n  } catch // solhint-disable-next-line no-empty-blocks\n  {\n    // Fall through\n  }\n}\n```\n\nThe current implementation of EIP-2981 support will always pass a constant `BASIS_POINTS` as the `_salePrice`.\n\nAs a result, the recipients that are supposed to receive less than 1 BPS of the salePrice may end up not receiving any royalties.\n\nFurthermore, for the NFTs with the total royalties rate set less than 10% for some reason, the current implementation will scale it up to 10%.\n\n### Recommended Mitigation Steps\n\n1.  Instead of passing a constant of 10,000 as the `_salePrice`, we suggest using the actual `_salePrice`, so there the royalties can be paid for recipients with less than 1 BPS of the royalties.\n2.  When the total royalties cut is lower than 10%, it should be honored. It's capped at 10% only when the total royalties cut is higher than 10%.\n\n**[NickCuso (Foundation) acknowledged and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/58#issuecomment-1062159151):**\n > Yes, these are valid points and something we will consider revisiting in the future.\n> \n> RE recommendations:\n>  1) This can only impact < 0.01% of the payment so not a concern ATM. It may be more appropriate to better honor exact amounts, but it's a non-trivial change to an important code path so we will leave it as-is for now. With payments that small, it's probably more appropriate to be using a contract to manage the payouts - e.g. https://www.0xsplits.xyz/ could handle this well.\n>  2) I agree. ATM we always enforce exactly 10% so that there is a consistent experience with our market and on our website. We will revisit this in the future, and the idea of capping it to 10% but accepting lower is a great one.\n\n\n\n***\n\n## [[M-17] There is no Support For The Trading of Cryptopunks](https://github.com/code-423n4/2022-02-foundation-findings/issues/74)\n_Submitted by leastwood_\n\nCryptopunks are at the core of the NFT ecosystem. As one of the first NFTs, it embodies the culture of NFT marketplaces. By not supporting the trading of cryptopunks, Foundation is at a severe disadvantage when compared to other marketplaces. Cryptopunks have their own internal marketplace which allows users to trade their NFTs to other users. As such, cryptopunks does not adhere to the `ERC721` standard, it will always fail when the protocol attempts to trade them.\n\n### Proof of Concept\n\nHere is an example [implementation](https://github.com/code-423n4/2021-12-nftx/blob/main/nftx-protocol-v2/contracts/solidity/NFTXStakingZap.sol#L417-L424) of what it might look like to integrate cryptopunks into the Foundation protocol.\n\n### Recommended Mitigation Steps\n\nConsider designing a wrapper contract for cryptopunks to facilitate standard `ERC721` transfers. The logic should be abstracted away from the user such that their user experience is not impacted.\n\n**[NickCuso (Foundation) acknowledged and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/74#issuecomment-1058006585):**\n > Yes, crypto punks is an important part of the ecosystem and this is on our radar. We are not planning on adding support at this time but we will revisiting this in the future.\n> \n> I like the idea of using a wrapper contract of sorts. We will be looking for a way to keep the complexity out of the market contract itself like you suggest if at all possible.\n\n\n\n***\n\n## [[M-18] Fees Are Incorrectly Charged on Unfinalized NFT Sales](https://github.com/code-423n4/2022-02-foundation-findings/issues/73)\n_Submitted by leastwood_\n\n[NFTMarketOffer.sol#L255-L271](https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketOffer.sol#L255-L271)<br>\n[NFTMarketReserveAuction.sol#L557](https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketReserveAuction.sol#L557)<br>\n[NFTMarketReserveAuction.sol#L510-L515](https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketReserveAuction.sol#L510-L515)<br>\n[NFTMarketFees.sol#L188-L189](https://github.com/code-423n4/2022-02-foundation/blob/main/contracts/mixins/NFTMarketFees.sol#L188-L189)<br>\n\nOnce an auction has ended, the highest bidder now has sole rights to the underlying NFT. By finalizing the auction, fees are charged on the sale and the NFT is transferred to `auction.bidder`. However, if `auction.bidder` accepts an offer before finalization, fees will be charged on the `auction.bidder` sale before the original sale. As a result, it is possible to avoid paying the primary foundation fee as a creator if the NFT is sold by `auction.bidder` before finalization.\n\n### Proof of Concept\n\nConsider the following scenario:\n\n*   Alice creates an auction and is the NFT creator.\n*   Bob bids on the auction and is the highest bidder.\n*   The auction ends but Alice leaves it in an unfinalized state.\n*   Carol makes an offer on the NFT which Bob accepts.\n*   `_acceptOffer()` will distribute funds on the sale between Bob and Carol before distributing funds on the sale between Alice and Bob.\n*   The first call to `_distributeFunds()` will set the `_nftContractToTokenIdToFirstSaleCompleted` to true, meaning that future sales will only be charged the secondary foundation fee.\n\n### Recommended Mitigation Steps\n\nEnsure the `_nftContractToTokenIdToFirstSaleCompleted` is correctly tracked. It might be useful to ensure the distribution of funds are in the order of when the trades occurred. For example, an unfinalized auction should always have its fees paid before other sales.\n\n**[NickCuso (Foundation) confirmed and commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/73#issuecomment-1058004784):**\n > Yes! This is a good find.\n> \n> The core of the problem is we were calling `_distributeFunds` before calling `_transferFromEscrow` where the auction finalization would be processed. We have flipped those calls so now the auction will be fully settled before we calculate fees for the offer sale.\n\n\n\n***\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 20 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-02-foundation-findings/issues/89) by **leastwood** received the top score from the judge.\n\n*The following wardens also submitted reports: [0xliumin](https://github.com/code-423n4/2022-02-foundation-findings/issues/25), [defsec](https://github.com/code-423n4/2022-02-foundation-findings/issues/61), [hubble](https://github.com/code-423n4/2022-02-foundation-findings/issues/52), [Dravee](https://github.com/code-423n4/2022-02-foundation-findings/issues/80), [csanuragjain](https://github.com/code-423n4/2022-02-foundation-findings/issues/36), [kenta](https://github.com/code-423n4/2022-02-foundation-findings/issues/84), [rfa](https://github.com/code-423n4/2022-02-foundation-findings/issues/81), [IllIllI](https://github.com/code-423n4/2022-02-foundation-findings/issues/28), [gzeon](https://github.com/code-423n4/2022-02-foundation-findings/issues/60), [0xwags](https://github.com/code-423n4/2022-02-foundation-findings/issues/79), [cmichel](https://github.com/code-423n4/2022-02-foundation-findings/issues/48), [robee](https://github.com/code-423n4/2022-02-foundation-findings/issues/2), [CertoraInc](https://github.com/code-423n4/2022-02-foundation-findings/issues/38), [kirk-baird](https://github.com/code-423n4/2022-02-foundation-findings/issues/11), [0x1f8b](https://github.com/code-423n4/2022-02-foundation-findings/issues/13), [Ruhum](https://github.com/code-423n4/2022-02-foundation-findings/issues/64), [TerrierLover](https://github.com/code-423n4/2022-02-foundation-findings/issues/66), [jayjonah8](https://github.com/code-423n4/2022-02-foundation-findings/issues/9), and [WatchPug](https://github.com/code-423n4/2022-02-foundation-findings/issues/56).*\n\n## [L-01] Unhandled `marketLockupFor()` Edge Case\n\n`marketLockupFor()` will revert if too much `ETH` is provided. This can be modified to refund any surplus `ETH` to the user's `FETH` balance.\n\n## [N-01] Signature Re-Use\n\nThe `adminAccountMigration()` function intends to allow a seller to update `auction.seller` in the event their account is compromised. However, the signature in `requireAuthorizedAccountMigration()` can be re-used because there is no use of a nonce to prevent this.\n\nConsider adding a nonce to account for this behaviour.\n\n## [N-02] Unclear Function Naming\n\nThe `_cancelBuyersOffer()` function isn't exactly clear as it will only cancel the offer if the buyer is `msg.sender`. Therefore, it would be more clear to rename this to `_cancelSellersOffer()` or similar to avoid confusion.\n\n## [N-03] Improper `BASIS_POINTS` Check in `_distributeFunds()`\n\nThe `_distributeFunds()` function checks if `creatorShares[i] > BASIS_POINTS` when it should actually be checking if `totalShares > BASIS_POINTS`. This ensures that the sum of creator shares do not exceed an expected amount.\n\n## [N-04] Improper State Handling\n\nIf `_autoAcceptBuyPrice()` is executed by a new buyer that is not `offer.buyer`, then there will be an excess of `ETH`. The original `offer.buyer` will then have to wait until the offer expires as it isn't invalidated.\n\nEnsure this is understood.\n\n## [N-05] No Support For `ERC1155` Tokens\n\nMany new NFT contracts adhere to the `ERC1155` standard. Currently, it is not possible to trade these tokens on the Foundation marketplace.\n\nConsider making the necessary integrations.\n\n## [N-06] Unclear `_recipients` Array Restriction\n\nThe `_recipients` array is restricted to just 5 receivers. Ensure this is understand by NFT creators as they may intend to use additional receivers but these receivers may be disproportionally rewarded if the majority of creator shares are not included.\n\n## [N-07] Inconsistent Use of `sendValue()`\n\n`_buy()` should make use of `_sendValueWithFallbackWithdraw()` instead of `sendValue()`. This will ensure invalid transfers are correctly handled.\n\n**[NickCuso (Foundation) commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/89#issuecomment-1062821351):**\n > Thanks for the feedback!\n> \n>  - **[L-01] Unhandled marketLockupFor() Edge Case:** ATM there is no use case we are aware of where it would make sense for too much ETH to be provided. Because of this we are going to revert instead of refunding - it'll save a bit of gas for other users and may prevent an invalid transaction (possibly user error or a frontend bug).\n>  - **[N-01] Signature re-use:** In this use case, signature reuse is actually desirable. However after a different issue was reported we opted to remove the `adminAccountMigration` function completely instead. It's not something we have used in some time.\n>  - **[N-02] Unclear naming:** Yes, we agree. The function has been renamed.\n>  - **[N-03] Improper BASIS_POINTS Check:** This is a fair point. It's somewhat an arbitrary decision though. We are expecting values to be in BP and this logic is simply trying to handle invalid results gracefully. Either way we bring the total back down to 10% and guard against overflowing. ATM we are going to leave it as is.\n>  - **[N-04] Improper State Handling:** This is a valid concern but currently working as designed. When auto buy now applies we treat this the same as if they called buy directly. When someone purchases using `buy` we have opted to allow the highest offer to remain valid. It may not be common, but it's not 100% clear that the offer should have been canceled. e.g. the new owner may accept that offer in order to have a fast exit at a small loss due to buyers remorse.\n>  - **[N-05] No Support For ERC1155 Tokens:** Agree, we will add support for ERC-1155 at some point. It's a non trivial change though and we don't want to rush into it just yet.\n>  - **[N-06] Unclear _recipients Array Restriction:** Agree. We need some cap in order to limit amount of gas that non-creators would be required to pay. 5 is arbitrary and we should at least provide clear documentation. For now, we have added some comments about this inline. Longer term we can continue to communicate this more clearly, and encourage those with more than 5 recipients to use solutions such as https://www.0xsplits.xyz/.\n>  - **[N-07] Inconsistent Use of sendValue():** Yes, this is inconsistent. However the use case here is slightly different. Generally the use of `sendValueWithFallbackWithdraw` is when we are sending ETH to an address other than the msg.sender - we want to ensure that a malicious user cannot cause other user's transactions to revert. Here the refund is going to the msg.sender - if they are non-receivable they should be able to retry using the correct value instead. So we are leaving it as-is for now. \n\n**[Alberto Cuesta Cañada (judge) commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/89#issuecomment-1070690969):**\n > Unadjusted score: 100 (80 + 20 from clean formatting)\n\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 11 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-02-foundation-findings/issues/63) by **Dravee** received the top score from the judge.\n\n*The following wardens also submitted reports: [CertoraInc](https://github.com/code-423n4/2022-02-foundation-findings/issues/37), [TerrierLover](https://github.com/code-423n4/2022-02-foundation-findings/issues/65), [thankthedark](https://github.com/code-423n4/2022-02-foundation-findings/issues/75), [iain](https://github.com/code-423n4/2022-02-foundation-findings/issues/10), [0x1f8b](https://github.com/code-423n4/2022-02-foundation-findings/issues/15), [csanuragjain](https://github.com/code-423n4/2022-02-foundation-findings/issues/32), [gzeon](https://github.com/code-423n4/2022-02-foundation-findings/issues/54), [rfa](https://github.com/code-423n4/2022-02-foundation-findings/issues/78), [kenta](https://github.com/code-423n4/2022-02-foundation-findings/issues/83), and [robee](https://github.com/code-423n4/2022-02-foundation-findings/issues/1).*\n\n## Table of Contents\n\nSee [original submission](https://github.com/code-423n4/2022-02-foundation-findings/issues/63).\n\n## Foreword\n\n*   **Storage-reading optimizations**\n\n> The code can be optimized by minimising the number of SLOADs. SLOADs are expensive (100 gas) compared to MLOADs/MSTOREs (3 gas). In the paragraphs below, please see the `@audit-issue` tags in the pieces of code's comments for more information about SLOADs that could be saved by caching the mentioned **storage** variables in **memory** variables.\n\n*   **Unchecking arithmetics operations that can't underflow/overflow**\n\n> Solidity version 0.8+ comes with implicit overflow and underflow checks on unsigned integers. When an overflow or an underflow isn't possible (as an example, when a comparison is made before the arithmetic operation, or the operation doesn't depend on user input), some gas can be saved by using an `unchecked` block: <https://docs.soliditylang.org/en/v0.8.10/control-structures.html#checked-or-unchecked-arithmetic>\n\n*   **`@audit` tags**\n\n> The code is annotated at multiple places with `//@audit` comments to pinpoint the issues. Please, pay attention to them for more details.\n\n## File: FETH.sol\n\n### function \\_deductAllowanceFrom()\n\n    File: FETH.sol\n    441:   function _deductAllowanceFrom(AccountInfo storage accountInfo, uint256 amount) private {\n    442:     if (accountInfo.allowance[msg.sender] != type(uint256).max) { //@audit accountInfo.allowance[msg.sender] SLOAD 1\n    443:       if (accountInfo.allowance[msg.sender] < amount) { //@audit accountInfo.allowance[msg.sender] SLOAD 2\n    444:         revert FETH_Insufficient_Allowance(accountInfo.allowance[msg.sender]); //@audit accountInfo.allowance[msg.sender] SLOAD 3\n    445:       }\n    446:       // The check above ensures allowance cannot underflow.\n    447:       unchecked {\n    448:         accountInfo.allowance[msg.sender] -= amount; //@audit accountInfo.allowance[msg.sender] SLOAD 3\n    449:       }\n    450:     }\n    451:   }\n\n#### Cache `accountInfo.allowance[msg.sender]`\n\nCaching this in memory can save around 2 SLOADs (around 200 gas). This is due to the fact that both conditions will get evaluated before L448, which is using `-=` (therefore making a SLOAD + SSTORE)<br>\nI recommend caching this value and using it as such:\n\n      function _deductAllowanceFrom(AccountInfo storage accountInfo, uint256 amount) private {\n        uint256 _allowance = accountInfo.allowance[msg.sender]; //@audit 1 MSTORE + 1 SLOAD\n        if (_allowance != type(uint256).max) { //@audit 1 MLOAD spent\n          if (_allowance < amount) { //@audit 1 SLOAD saved, 1 MLOAD spent\n            revert FETH_Insufficient_Allowance(_allowance); //@audit 1 SLOAD saved, 1 MLOAD spent\n          }\n          // The check above ensures allowance cannot underflow.\n          unchecked {\n            accountInfo.allowance[msg.sender] = _allowance - amount; //@audit 1 SLOAD saved, 1 MLOAD spent\n          }\n        }\n      }\n\n### function \\_deductBalanceFrom()\n\n    File: FETH.sol\n    456:   function _deductBalanceFrom(AccountInfo storage accountInfo, uint256 amount) private {\n    457:     // Free from escrow in order to consider any expired escrow balance\n    458:     if (accountInfo.freedBalance < amount) { //@audit accountInfo.freedBalance SLOAD 1\n    459:       revert FETH_Insufficient_Available_Funds(accountInfo.freedBalance); //@audit accountInfo.freedBalance SLOAD 2\n    460:     }\n    461:     // The check above ensures balance cannot underflow.\n    462:     unchecked {\n    463:       accountInfo.freedBalance -= uint96(amount); //@audit accountInfo.freedBalance SLOAD 2\n    464:     }\n    465:   }\n\n#### Cache `accountInfo.freedBalance`\n\nCaching this in memory can save around 1 SLOAD (around 100 gas).<br>\nI recommend caching this value and using it as such:\n\n      function _deductBalanceFrom(AccountInfo storage accountInfo, uint256 amount) private {\n        uint256 _freedBalance = accountInfo.freedBalance; //@audit 1 MSTORE + 1 SLOAD\n        // Free from escrow in order to consider any expired escrow balance\n        if (_freedBalance < amount) { ///@audit 1 MLOAD spent\n          revert FETH_Insufficient_Available_Funds(_freedBalance); //@audit 1 SLOAD saved, 1 MLOAD spent\n        }\n        // The check above ensures balance cannot underflow.\n        unchecked {\n          accountInfo.freedBalance = _freedBalance - uint96(amount); //@audit 1 SLOAD saved, 1 MLOAD spent\n        }\n      }\n\n### function \\_marketLockupFor()\n\n#### Cache `accountInfo.freedBalance` or call `_deductBalanceFrom` to save gas while saving some size\n\nImpacted code:\n\n    File: FETH.sol\n    535:       // The check above prevents underflow with delta.\n    536:       unchecked {\n    537:         uint256 delta = amount - msg.value; //@audit just use / should call private _deductBalanceFrom(accountInfo, amount - msg.value); : 6.833 vs 6.894\n    538:         if (accountInfo.freedBalance < delta) { //@audit accountInfo.freedBalance SLOAD 1\n    539:           revert FETH_Insufficient_Available_Funds(accountInfo.freedBalance); //@audit accountInfo.freedBalance SLOAD 2\n    540:         }\n    541:         // The check above prevents underflow of freed balance.\n    542:         accountInfo.freedBalance -= uint96(delta); //@audit accountInfo.freedBalance SLOAD 2\n    543:       }\n\nThe optimization by caching `accountInfo.freedBalance` would be exactly the same as above, which would save around 100 gas. However, here, it'd be better to actually call the optimized `_deductBalanceFrom` to benefit from the previous gas-gains and reduce the contract's size (0.061KB saved).\n\nThe code should become:\n\n    File: FETH.sol\n    534:     if (msg.value < amount) {\n    535:       _deductBalanceFrom(accountInfo, amount - msg.value);\n    536:     } else if (msg.value != amount) {\n    537:       // There's no reason to send msg.value more than the amount being locked up\n    538:       revert FETH_Too_Much_ETH_Provided();\n    539:     }\n\n## File: NFTMarketBuyPrice.sol\n\n### function cancelBuyPrice()\n\n    File: NFTMarketBuyPrice.sol\n    125:   function cancelBuyPrice(address nftContract, uint256 tokenId) external nonReentrant {\n    126:     BuyPrice storage buyPrice = nftContractToTokenIdToBuyPrice[nftContract][tokenId];\n    127:     if (buyPrice.seller == address(0)) { //@audit buyPrice.seller SLOAD 1\n    128:       // This check is redundant with the next one, but done in order to provide a more clear error message.\n    129:       revert NFTMarketBuyPrice_Cannot_Cancel_Unset_Price();\n    130:     } else if (buyPrice.seller != msg.sender) { //@audit buyPrice.seller SLOAD 2 (evaluated even if false)\n    131:       revert NFTMarketBuyPrice_Only_Owner_Can_Cancel_Price(buyPrice.seller); //@audit buyPrice.seller SLOAD 3\n    132:     }\n    ...\n    141:   }\n\n#### Cache `buyPrice.seller`\n\nCaching this in memory can save around 2 SLOADs (around 200 gas).\n\n### function setBuyPrice()\n\n```\nFile: NFTMarketBuyPrice.sol\n150:   function setBuyPrice(\n...\n165:     BuyPrice storage buyPrice = nftContractToTokenIdToBuyPrice[nftContract][tokenId];\n...\n170:     if (buyPrice.seller == address(0)) { //@audit buyPrice.seller SLOAD 1\n171:       // Transfer the NFT into escrow, if it's already in escrow confirm the `msg.sender` is the owner.\n172:       _transferToEscrow(nftContract, tokenId);\n173: \n174:       // The price was not previously set for this NFT, store the seller.\n175:       buyPrice.seller = payable(msg.sender); \n176:     } else if (buyPrice.seller != msg.sender) { //@audit buyPrice.seller SLOAD 2 (evaluated even if false)\n177:       // Buy price was previously set by a different user\n178:       revert NFTMarketBuyPrice_Only_Owner_Can_Set_Price(buyPrice.seller); //@audit buyPrice.seller SLOAD 3\n179:     }\n...\n182:   }\n\n```\n\n#### Cache `buyPrice.seller`\n\nCaching this in memory can save around 2 SLOADs (around 200 gas).\n\n### function \\_transferFromEscrow()\n\n    File: NFTMarketBuyPrice.sol\n    276:   function _transferFromEscrow(\n    ...\n    282:     BuyPrice storage buyPrice = nftContractToTokenIdToBuyPrice[nftContract][tokenId];\n    283:     if (buyPrice.seller != address(0)) { //@audit buyPrice.seller SLOAD 1\n    284:       // A buy price was set for this NFT.\n    285:       if (buyPrice.seller != seller) { //@audit buyPrice.seller SLOAD 2\n    286:         // When there is a buy price set, the `buyPrice.seller` is the owner of the NFT.\n    287:         revert NFTMarketBuyPrice_Seller_Mismatch(buyPrice.seller); //@audit buyPrice.seller SLOAD 3\n    288:       }\n    ...\n    294:   }\n\n#### Cache `buyPrice.seller`\n\nCaching this in memory can save around 2 SLOADs (around 200 gas).\n\n### function \\_transferToEscrow()\n\n```\nFile: NFTMarketBuyPrice.sol\n316:   function _transferToEscrow(address nftContract, uint256 tokenId) internal virtual override {\n317:     BuyPrice storage buyPrice = nftContractToTokenIdToBuyPrice[nftContract][tokenId];\n318:     if (buyPrice.seller == address(0)) { //@audit buyPrice.seller SLOAD 1\n319:       // The NFT is not in escrow for buy now.\n320:       super._transferToEscrow(nftContract, tokenId); \n321:     } else if (buyPrice.seller != msg.sender) { //@audit buyPrice.seller SLOAD 2\n322:       // When there is a buy price set, the `buyPrice.seller` is the owner of the NFT.\n323:       revert NFTMarketBuyPrice_Seller_Mismatch(buyPrice.seller); //@audit buyPrice.seller SLOAD 3\n324:     }\n325:   }\n\n```\n\n#### Cache `buyPrice.seller`\n\nCaching this in memory can save around 2 SLOADs (around 200 gas).\n\n### function getBuyPrice()\n\n    File: NFTMarketBuyPrice.sol\n    337:   function getBuyPrice(address nftContract, uint256 tokenId) external view returns (address seller, uint256 price) {\n    338:     BuyPrice storage buyPrice = nftContractToTokenIdToBuyPrice[nftContract][tokenId];\n    339:     if (buyPrice.seller == address(0)) { //@audit buyPrice.seller SLOAD 1\n    340:       return (address(0), type(uint256).max);\n    341:     }\n    342:     return (buyPrice.seller, buyPrice.price); //@audit buyPrice.seller SLOAD 2\n    343:   }\n\n#### Cache `buyPrice.seller`\n\nCaching this in memory can save around 1 SLOAD (around 100 gas).\n\n## File: NFTMarketFees.sol\n\n### function \\_distributeFunds()\n\n    File: NFTMarketFees.sol\n    48:   function _distributeFunds(\n    ...\n    74:     if (creatorFee > 0) {\n    75:       if (creatorRecipients.length > 1) {\n    76:         uint256 maxCreatorIndex = creatorRecipients.length - 1; //@audit should be unchecked too (see L75)\n    77:         if (maxCreatorIndex > MAX_ROYALTY_RECIPIENTS_INDEX) {\n    78:           maxCreatorIndex = MAX_ROYALTY_RECIPIENTS_INDEX;\n    79:         }\n    80: \n    81:         // Determine the total shares defined so it can be leveraged to distribute below\n    82:         uint256 totalShares;\n    83:         unchecked {\n    84:           // The array length cannot overflow 256 bits.\n    85:           for (uint256 i; i <= maxCreatorIndex; ++i) {\n    86:             if (creatorShares[i] > BASIS_POINTS) {\n    87:               // If the numbers are >100% we ignore the fee recipients and pay just the first instead\n    88:               maxCreatorIndex = 0;\n    89:               break;\n    90:             }\n    91:             // The check above ensures totalShares wont overflow.\n    92:             totalShares += creatorShares[i];\n    93:           }\n    94:         }\n\n#### Uncheck line L76\n\nThis line can't underflow due to L75. Therefore, it should be wrapped in an `unchecked` block.<br>\nI'd suggest starting the `unchecked` block L83 at line 76.\n\n## File: NFTMarketOffer.sol\n\n### function makeOffer()\n\n    File: NFTMarketOffer.sol\n    189:   function makeOffer(\n    ...\n    204:     Offer storage offer = nftContractToIdToOffer[nftContract][tokenId];\n    205: \n    206:     if (offer.expiration < block.timestamp) { //@audit offer.expiration SLOAD 1\n    ...\n    211:     } else {\n    ...\n    214:       if (amount < _getMinIncrement(offer.amount)) { //@audit offer.amount SLOAD 1\n    215:         // A non-trivial increase in price is required to avoid sniping\n    216:         revert NFTMarketOffer_Offer_Must_Be_At_Least_Min_Amount(_getMinIncrement(offer.amount)); //@audit offer.amount SLOAD 2\n    217:       }\n    ...\n    221:       expiration = feth.marketChangeLockup{ value: msg.value }(\n    222:         offer.buyer,\n    223:         offer.expiration, //@audit offer.expiration SLOAD 2\n    224:         offer.amount, //@audit offer.amount SLOAD 2\n    225:         msg.sender,\n    226:         amount\n    227:       );\n    228:     }\n\n#### Cache `offer.expiration`\n\nCaching this in memory can save around 1 SLOAD (around 100 gas).\n\n#### Cache `offer.amount`\n\nCaching this in memory can save around 1 SLOAD (around 100 gas).\n\n### function getOffer()\n\n    File: NFTMarketOffer.sol\n    379:   function getOffer(address nftContract, uint256 tokenId)\n    ...\n    388:     Offer storage offer = nftContractToIdToOffer[nftContract][tokenId];\n    389:     if (offer.expiration < block.timestamp) { //@audit offer.expiration SLOAD 1\n    390:       // Offer not found or has expired\n    391:       return (address(0), 0, 0);\n    392:     }\n    393: \n    394:     // An offer was found and it has not yet expired.\n    395:     return (offer.buyer, offer.expiration, offer.amount); //@audit offer.expiration SLOAD 2\n    396:   }\n\n#### Cache `offer.expiration`\n\nCaching this in memory can save around 1 SLOAD (around 100 gas).\n\n## File: NFTMarketReserveAuction.sol\n\n### function adminAccountMigration()\n\n    File: NFTMarketReserveAuction.sol\n    263:   function adminAccountMigration(\n    264:     uint256[] calldata listedAuctionIds,\n    265:     address originalAddress,\n    266:     address payable newAddress,\n    267:     bytes memory signature //@audit gas should be calldata\n    268:   ) external onlyFoundationOperator { \n    269:     // Validate the owner of the original account has approved this change.\n    270:     originalAddress.requireAuthorizedAccountMigration(newAddress, signature);\n    271: \n    272:     unchecked {\n    273:       // The array length cannot overflow 256 bits.\n    274:       for (uint256 i; i < listedAuctionIds.length; ++i) {\n    275:         uint256 auctionId = listedAuctionIds[i];\n    276:         ReserveAuction storage auction = auctionIdToAuction[auctionId];\n    277:         if (auction.seller != address(0)) { //@audit auction.seller SLOAD 1\n    278:           // Only if the auction was found and not finalized before this transaction.\n    279: \n    280:           if (auction.seller != originalAddress) { //@audit auction.seller SLOAD 2\n    281:             // Confirm that the signature approval was the correct owner of this auction.\n    282:             revert NFTMarketReserveAuction_Cannot_Migrate_Non_Matching_Seller(auction.seller); //@audit auction.seller SLOAD 3\n    283:           }\n    284: \n    285:           // Update the auction's seller address.\n    286:           auction.seller = newAddress;\n    287: \n    288:           emit ReserveAuctionSellerMigrated(auctionId, originalAddress, newAddress);\n    289:         }\n    290:       }\n    291:     }\n    292:   }\n\n### Use `calldata` instead of `memory` for external functions where the function argument is read-only\n\nHere, `bytes memory signature` should be `bytes calldata signature`\n\n#### Cache `auction.seller`\n\nCaching this in memory can save around 2 SLOADs (around 200 gas).\n\n### function placeBidOf()\n\n    File: NFTMarketReserveAuction.sol\n    386:   function placeBidOf(uint256 auctionId, uint256 amount) public payable nonReentrant {\n    ...\n    402:     ReserveAuction storage auction = auctionIdToAuction[auctionId];\n    403: \n    404:     if (auction.amount == 0) { //@audit auction.amount SLOAD 1\n    405:       // No auction found\n    406:       revert NFTMarketReserveAuction_Cannot_Bid_On_Nonexistent_Auction();\n    407:     }\n    408: \n    409:     if (auction.endTime == 0) { //@audit auction.endTime SLOAD 1\n    410:       // This is the first bid, kicking off the auction.\n    411: \n    412:       if (auction.amount > amount) { //@audit auction.amount SLOAD 2\n    413:         // The bid must be >= the reserve price.\n    414:         revert NFTMarketReserveAuction_Cannot_Bid_Lower_Than_Reserve_Price(auction.amount); //@audit auction.amount SLOAD 3\n    415:       }\n    ...\n    429:     } else {\n    430:       if (auction.endTime < block.timestamp) { //@audit auction.endTime SLOAD 2\n    431:         // The auction has already ended.\n    432:         revert NFTMarketReserveAuction_Cannot_Bid_On_Ended_Auction(auction.endTime); //@audit auction.endTime SLOAD 3\n    433:       } else if (auction.bidder == msg.sender) { //@audit auction.bidder SLOAD 1\n    434:         // We currently do not allow a bidder to increase their bid unless another user has outbid them first.\n    435:         revert NFTMarketReserveAuction_Cannot_Rebid_Over_Outstanding_Bid();\n    436:       } else if (amount < _getMinIncrement(auction.amount)) { //@audit auction.amount SLOAD 2\n    437:         // If this bid outbids another, it must be at least 10% greater than the last bid.\n    438:         revert NFTMarketReserveAuction_Bid_Must_Be_At_Least_Min_Amount(_getMinIncrement(auction.amount)); //@audit auction.amount SLOAD 3\n    439:       }\n    440: \n    441:       // Cache and update bidder state\n    442:       uint256 originalAmount = auction.amount; //@audit auction.amount SLOAD 3\n    443:       address payable originalBidder = auction.bidder; //@audit auction.bidder SLOAD 2\n    444:       auction.amount = amount;\n    445:       auction.bidder = payable(msg.sender);\n    446: \n    447:       unchecked {\n    448:         // When a bid outbids another, check to see if a time extension should apply.\n    449:         // We confirmed that the auction has not ended, so endTime is always >= the current timestamp.\n    450:         if (auction.endTime - block.timestamp < auction.extensionDuration) { //@audit auction.endTime SLOAD 3 //@audit auction.extensionDuration SLOAD 1\n    451:           // Current time plus extension duration (always 15 mins) cannot overflow.\n    452:           auction.endTime = block.timestamp + auction.extensionDuration; //@audit auction.extensionDuration SLOAD 2\n    453:         }\n    454:       }\n    455: \n    456:       // Refund the previous bidder\n    457:       _sendValueWithFallbackWithdraw(originalBidder, originalAmount, SEND_VALUE_GAS_LIMIT_SINGLE_RECIPIENT);\n    458:     }\n    459: \n    460:     emit ReserveAuctionBidPlaced(auctionId, msg.sender, amount, auction.endTime); //@audit auction.endTime SLOAD 4\n    461:   }\n\n#### Cache `auction.endTime`\n\nCaching this in memory can save around 3 SLOADs (around 300 gas).\n\n#### Cache `auction.extensionDuration`\n\nCaching this in memory can save around 1 SLOAD (around 100 gas).\n\n#### Cache `auction.bidder`\n\nCaching this in memory can save around 1 SLOAD (around 100 gas).\n\n#### Cache `auction.amount`\n\nCaching this in memory can save around 2 SLOADs (around 200 gas).\n\n## General recommendations\n\n### For-Loops\n\n#### An array's length should be cached to save gas in for-loops\n\nReading array length at each iteration of the loop takes 6 gas (3 for mload and 3 to place memory_offset) in the stack.<br>\nCaching the array length in the stack saves around 3 gas per iteration.<br>\nTherefore, it's possible to save a significant amount of gas (>= 102 after 34 iterations).\n\nHere, I suggest storing the array's length in a variable before the for-loop, and use it instead:\n\n    mixins/OZ/ERC165Checker.sol:64:        for (uint256 i = 0; i < interfaceIds.length; ++i) {\n    mixins/OZ/ERC165Checker.sol:90:      for (uint256 i = 0; i < interfaceIds.length; ++i) {\n    mixins/NFTMarketCreators.sol:94:            for (uint256 i = 0; i < _recipients.length; ++i) {\n    mixins/NFTMarketCreators.sol:155:                for (uint256 i = 0; i < _recipients.length; ++i) {\n    mixins/NFTMarketCreators.sol:193:                for (uint256 i = 0; i < _recipients.length; ++i) {\n    mixins/NFTMarketOffer.sol:161:      for (uint256 i = 0; i < nftContracts.length; ++i) {\n    mixins/NFTMarketReserveAuction.sol:274:      for (uint256 i = 0; i < listedAuctionIds.length; ++i) {\n\n#### Increments can be unchecked\n\nIn Solidity 0.8+, there's a default overflow check on unsigned integers. It's possible to uncheck this in for-loops and save a significant amount of gas at each iteration, but at the cost of some code readability, as this uncheck cannot be made inline.\n\n[ethereum/solidity#10695](https://github.com/ethereum/solidity/issues/10695)\n\nInstances include:\n\n    mixins/OZ/ERC165Checker.sol:64:        for (uint256 i = 0; i < interfaceIds.length; ++i) {\n    mixins/OZ/ERC165Checker.sol:90:      for (uint256 i = 0; i < interfaceIds.length; ++i) {\n    mixins/NFTMarketCreators.sol:94:            for (uint256 i = 0; i < _recipients.length; ++i) {\n    mixins/NFTMarketCreators.sol:155:                for (uint256 i = 0; i < _recipients.length; ++i) {\n    mixins/NFTMarketCreators.sol:193:                for (uint256 i = 0; i < _recipients.length; ++i) {\n    mixins/NFTMarketOffer.sol:161:      for (uint256 i = 0; i < nftContracts.length; ++i) {\n    mixins/NFTMarketReserveAuction.sol:274:      for (uint256 i = 0; i < listedAuctionIds.length; ++i) {\n    FETH.sol:552:      for (uint256 escrowIndex = accountInfo.lockupStartIndex; ; ++escrowIndex) {\n    FETH.sol:679:      for (uint256 escrowIndex = accountInfo.lockupStartIndex; ; ++escrowIndex) {\n    FETH.sol:713:      for (uint256 escrowIndex = accountInfo.lockupStartIndex; ; ++escrowIndex) {\n    FETH.sol:733:      for (uint256 escrowIndex = accountInfo.lockupStartIndex; ; ++escrowIndex) {\n    FETH.sol:760:      for (uint256 escrowIndex = accountInfo.lockupStartIndex; ; ++escrowIndex) {\n\nThe code would go from:\n\n    for (uint256 i; i < numIterations; ++i) {  \n     // ...  \n    }  \n\nto:\n\n    for (uint256 i; i < numIterations;) {  \n     // ...  \n     unchecked { ++i; }  \n    }  \n\nThe risk of overflow is inexistant for a `uint256` here.\n\n**[NickCuso (Foundation) commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/63#issuecomment-1064038809):**\n > This was a very detailed and helpful gas report! I love that you commented the code with the @audit tags and detailed exactly how much savings could be made and why. This was very useful when evaluating the recommendations. \n> \n> We have implemented many of the suggestions here. Some we chose not to change in order to preserve readability. Generally the savings is inline with the expected values you have stated here.\n\n**[Alberto Cuesta Cañada (judge) commented](https://github.com/code-423n4/2022-02-foundation-findings/issues/63#issuecomment-1070987129):**\n > Great report. Score: 4300 (including +20% from formatting)\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}