{
  "circa": {
    "title": "Concur Finance contest",
    "sponsor": "Concur Finance",
    "slug": "2022-02-concur",
    "date": "2022-05-24",
    "findings": "https://github.com/code-423n4/2022-02-concur-findings/issues",
    "contest": 83
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Concur Finance smart contract system written in Solidity. The audit contest took place between February 3—February 9 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>58 Wardens contributed reports to the Concur Finance contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/liam_eastwood13\">leastwood</a></li>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li><a href=\"https://twitter.com/HickupH\">hickuphh3</a></li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li><a href=\"https://twitter.com/wuwe19\">wuwe1</a></li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li>hyh</li>\n<li><a href=\"https://twitter.com/Throt7le\">throttle</a></li>\n<li><a href=\"https://twitter.com/_Czar102\">Czar102</a></li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li><a href=\"https://twitter.com/kirkthebaird\">kirk-baird</a></li>\n<li>IllIllI</li>\n<li>0x1f8b</li>\n<li>0xw4rd3n</li>\n<li>CertoraInc (<a href=\"https://twitter.com/danbinnun\">danb</a>, egjlmn1, <a href=\"https://twitter.com/ori_dabush\">OriDabush</a>, ItayG, and shakedwinder)</li>\n<li>cccz</li>\n<li><a href=\"https://twitter.com/0xliumin\">0xliumin</a></li>\n<li><a href=\"https://twitter.com/JustDravee\">Dravee</a></li>\n<li>harleythedog</li>\n<li>reassor</li>\n<li>kenta</li>\n<li><a href=\"https://twitter.com/danbinnun\">danb</a></li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>hubble (ksk2345 and shri4net)</li>\n<li>Jujic</li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"https://twitter.com/VladToie/\">bobi</a></li>\n<li><a href=\"https://twitter.com/randyyramadhan\">Randyyy</a></li>\n<li><a href=\"https://twitter.com/ShadowyNoobDev\">ShadowyNoobDev</a></li>\n<li>bitbopper</li>\n<li>SolidityScan (<a href=\"https://twitter.com/cyberboyIndia\">cyberboy</a> and <a href=\"https://blog.dixitaditya.com/\">zombie</a>)</li>\n<li>Heartless</li>\n<li><a href=\"https://twitter.com/BouSalman\">BouSalman</a></li>\n<li>mtz</li>\n<li>robee</li>\n<li><a href=\"https://www.instagram.com/riyan_rfa/\">rfa</a></li>\n<li><a href=\"https://twitter.com/morphean_sec\">Sleepy</a></li>\n<li>peritoflores</li>\n<li><a href=\"https://twitter.com/_ye0lde\">ye0lde</a></li>\n<li><a href=\"https://twitter.com/rhynorater\">Rhynorater</a></li>\n<li>samruna</li>\n<li>cryptphi</li>\n<li><a href=\"https://twitter.com/ngndev\">0xngndev</a></li>\n<li>0x0x0x</li>\n<li>0xNot0rious</li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li>0x510c</li>\n<li><a href=\"https://twitter.com/sabtikw\">sabtikw</a></li>\n<li>GeekyLumberjack</li>\n<li><a href=\"https://twitter.com/ckksec\">ckksec</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/GalloDaSballo\">Alex the Entreprenerd</a>. The judge also competed in the contest as a warden, but forfeited their winnings.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 42 unique vulnerabilities. Of these vulnerabilities, 11 received a risk rating in the category of HIGH severity and 31 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 36 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 33 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-02-concur\">C4 Concur Finance contest repository</a>, and is composed of 8 smart contracts written in the Solidity programming language and includes 1,213 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-11\" style=\"position:relative;\"><a href=\"#high-risk-findings-11\" aria-label=\"high risk findings 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (11)</h1>\n<h2 id=\"h-01-wrong-reward-token-calculation-in-masterchef-contract\" style=\"position:relative;\"><a href=\"#h-01-wrong-reward-token-calculation-in-masterchef-contract\" aria-label=\"h 01 wrong reward token calculation in masterchef contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/219\">[H-01] Wrong reward token calculation in MasterChef contract</a></h2>\n<p><em>Submitted by throttle, also found by cccz, cmichel, and leastwood</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L86\">MasterChef.sol#L86</a><br></p>\n<p>When adding new token pool for staking in MasterChef contract</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_allocationPoints</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_depositFee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_startBlock</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>All other, already added, pools should be updated but currently they are not.<br>\nInstead, only totalPoints is updated. Therefore, old (and not updated) pools will lose it’s share during the next update.<br>\nTherefore, user rewards are not computed correctly (will be always smaller).</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Scenario 1:</p>\n<ol>\n<li>Owner adds new pool (first pool) for staking with points = 100 (totalPoints=100)<br>\nand 1 block later Alice stakes 10 tokens in the first pool.</li>\n<li>1 week passes</li>\n<li>Alice withdraws her 10 tokens and claims X amount of reward tokens.<br>\nand 1 block later Bob stakes 10 tokens in the first pool.</li>\n<li>1 week passes</li>\n<li>Owner adds new pool (second pool) for staking with points = 100 (totalPoints=200)<br>\nand 1 block later Bob withdraws his 10 tokens and claims X/2 amount of reward tokens.<br>\nBut he should get X amount</li>\n</ol>\n<p>Scenario 2:</p>\n<ol>\n<li>Owner adds new pool (first pool) for staking with points = 100 (totalPoints=100).</li>\n<li>1 block later Alice, Bob and Charlie stake 10 tokens there (at the same time).</li>\n<li>1 week passes</li>\n<li>Owner adds new pool (second pool) for staking with points = 400 (totalPoints=500)</li>\n<li>Right after that, when Alice, Bob or Charlie wants to withdraw tokens and claim rewards they will only be able to claim 20% of what they should be eligible for, because their pool is updated with 20% (100/500) rewards instead of 100% (100/100) rewards for the past week.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Update all existing pools before adding new pool. Use the massUdpate() function which is already present … but unused.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/219\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/219#issuecomment-1092858699\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified a fallacy in how <code>add</code>s logic work.</p>\n<p>Ultimately rewards in this contract have to be linearly vested over time, adding a new pool would change the rate at which vesting in all pools will go.</p>\n<p>For that reason, it is necessary to accrue the rewards that each pool generated up to that point, before changing the slope at which rewards will be distributed.</p>\n<p>In this case add should massUpdateFirst.</p>\n<p>Because this vulnerability ultimately breaks the accounting of the protocol, I believe High Severity to be appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-masterchef-improper-handling-of-deposit-fee\" style=\"position:relative;\"><a href=\"#h-02-masterchef-improper-handling-of-deposit-fee\" aria-label=\"h 02 masterchef improper handling of deposit fee permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/138\">[H-02] Masterchef: Improper handling of deposit fee</a></h2>\n<p><em>Submitted by hickuphh3, also found by leastwood</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L170-L172\">MasterChef.sol#L170-L172</a><br></p>\n<p>If a pool’s deposit fee is non-zero, it is subtracted from the amount to be credited to the user.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositFeeBP</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositFeeBP</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_perMille</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">depositFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>However, the deposit fee is not credited to anyone, leading to permanent lockups of deposit fees in the relevant depositor contracts (StakingRewards and ConvexStakingWrapper for now).</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<h4 id=\"example-1-convexstakingwrapper\" style=\"position:relative;\"><a href=\"#example-1-convexstakingwrapper\" aria-label=\"example 1 convexstakingwrapper permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example 1: ConvexStakingWrapper</h4>\n<p>Assume the following</p>\n<ul>\n<li>The <a href=\"https://etherscan.io/address/0x9fC689CCaDa600B6DF723D9E47D84d76664a1F23\">curve cDai / cUSDC / cUSDT LP token</a> corresponds to <code>pid = 1</code> in the convex booster contract.</li>\n<li>Pool is added in Masterchef with <code>depositFeeBP = 100 (10%)</code>.</li>\n<li>Alice deposits 1000 LP tokens via the ConvexStakingWrapper contract. A deposit fee of 100 LP tokens is charged. Note that the <code>deposits</code> mapping of the ConvexStakingWrapper contract credits 1000 LP tokens to her.</li>\n<li>However, Alice will only be able to withdraw 900 LP tokens. The 100 LP tokens is not credited to any party, and is therefore locked up permanently (essentially becomes protocol-owned liquidity). While she is able to do <code>requestWithdraw()</code> for 1000 LP tokens, attempts to execute <code>withdraw()</code> with amount = 1000 will revert because she is only credited 900 LP tokens in the Masterchef contract.</li>\n</ul>\n<h4 id=\"example-2-stakingrewards\" style=\"position:relative;\"><a href=\"#example-2-stakingrewards\" aria-label=\"example 2 stakingrewards permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example 2: StakingRewards</h4>\n<ul>\n<li>CRV pool is added in Masterchef with <code>depositFeeBP = 100 (10%)</code>.</li>\n<li>Alice deposits 1000 CRV into the StakingRewards contract. A deposit fee of 100 CRV is charged.</li>\n<li>Alice is only able to withdraw 900 CRV tokens, while the 100 CRV is not credited to any party, and is therefore locked up permanently.</li>\n</ul>\n<p>These examples are non-exhaustive as more depositors can be added / removed from the Masterchef contract.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>I recommend shifting the deposit fee logic out of the masterchef contract into the depositor contracts themselves, as additional logic would have to be added in the masterchef to update the fee recipient’s state (rewardDebt, send pending concur rewards, update amount), which further complicates matters. As the fee recipient is likely to be the treasury, it is also not desirable for it to accrue concur rewards.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositFeeBP</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositFeeBP</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_perMille</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">depositFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">UserInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feeRecipient</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">userInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">feeRecipient</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// TODO: update and send feeRecipient pending concur rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">feeRecipient</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">feeRecipient</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">depositFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// TODO: update fee recipient&#39;s rewardDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/138\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/138#issuecomment-1092873088\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified a way for funds to be forever lost, because of that reason I believe High Severity to be appropriate.</p>\n<p>Mitigation could be as simple as transferring the fee to a <code>feeReceiver</code> or adding a way to pull those fees.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-03-repeated-calls-to-shelterwithdraw-can-drain-all-funds-in-shelter\" style=\"position:relative;\"><a href=\"#h-03-repeated-calls-to-shelterwithdraw-can-drain-all-funds-in-shelter\" aria-label=\"h 03 repeated calls to shelterwithdraw can drain all funds in shelter permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/246\">[H-03] Repeated Calls to Shelter.withdraw Can Drain All Funds in Shelter</a></h2>\n<p><em>Submitted by mtz, also found by 0x1f8b, 0xliumin, bitbopper, cccz, cmichel, csanuragjain, Czar102, danb, Alex the Entreprenerd, GeekyLumberjack, gzeon, hickuphh3, hyh, leastwood, Randyyy, Rhynorater, Ruhum, and ShadowyNoobDev</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/Shelter.sol#L52-L57\">Shelter.sol#L52-L57</a><br></p>\n<p>tl;dr Anyone who can call <code>withdraw</code> to withdraw their own funds can call it repeatedly to withdraw the funds of others. <code>withdraw</code> should only succeed if the user hasn’t withdrawn the token already.</p>\n<p>The shelter can be used for users to withdraw funds in the event of an emergency. The <code>withdraw</code> function allows callers to withdraw tokens based on the tokens they have deposited into the shelter client: ConvexStakingWrapper. However, <code>withdraw</code> does not check if a user has already withdrawn their tokens. Thus a user that can <code>withdraw</code> tokens, can call withdraw repeatedly to steal the tokens of others.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>tl;dr an attacker that can successfully call <code>withdraw</code> once on a shelter, can call it repeatedly to steal the funds of others. Below is a detailed scenario where this situation can be exploited.</p>\n<ol>\n<li>Mallory deposits 1 <code>wETH</code> into <code>ConvexStakingWrapper</code> using <a href=\"https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol#L280\"><code>deposit</code></a>. Let’s also assume that other users have deposited 2 <code>wETH</code> into the same contract.</li>\n<li>An emergency happens and the owner of <code>ConvexStakingWrapper</code> calls <code>setShelter(shelter)</code> and <code>enterShelter([pidOfWETHToken, ...])</code>. Now <code>shelter</code> has 3 <code>wETH</code> and is activated for <code>wETH</code>.</li>\n<li>Mallory calls <code>shelter.withdraw(wETHAddr, MalloryAddr)</code>, Mallory will rightfully receive 1 wETH because her share of wETH in the shelter is 1/3.</li>\n<li>Mallory calls <code>shelter.withdraw(wETHAddr, MalloryAddr)</code> again, receiving 1/3*2 = 2/3 wETH. <code>withdraw</code> does not check that she has already withdrawn. This time, the wETH does not belong to her, she has stolen the wETH of the other users. She can continue calling <code>withdraw</code> to steal the rest of the funds</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>To mitigate this, <code>withdraw</code> must first check that <code>msg.sender</code> has not withdrawn this token before and <code>withdraw</code> must also record that <code>msg.sender</code> has withdrawn the token.\nThe exact steps for this are below:</p>\n<ol>\n<li>Add the following line to the beginning of <code>withdraw</code> (line 53):</li>\n</ol>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">require(!claimed[_token][msg.sender], &quot;already claimed&quot;)</span></span></code></pre>\n<ol start=\"2\">\n<li>Replace <a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/Shelter.sol#L55\">line 55</a> with the following:</li>\n</ol>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">claimed[_token][msg.sender] = true;</span></span></code></pre>\n<p>This replacement is necessary because we want to record who is withdrawing, not where they are sending the token which isn’t really useful info.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/246\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/246#issuecomment-1092877228\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified a logical fallacy in the <code>Shelter</code> contract.</p>\n<p>This would allow a caller to claim their tokens multiple times, as long as they send them to a new address.</p>\n<p>Mitigation is as simple as checking claims against <code>msg.sender</code>, however because all funds can be drained, this finding is of High Severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-04-convexstakingwrapper-stakingrewards-wrong-implementation-will-send-concur-rewards-to-the-wrong-receiver\" style=\"position:relative;\"><a href=\"#h-04-convexstakingwrapper-stakingrewards-wrong-implementation-will-send-concur-rewards-to-the-wrong-receiver\" aria-label=\"h 04 convexstakingwrapper stakingrewards wrong implementation will send concur rewards to the wrong receiver permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/205\">[H-04] <code>ConvexStakingWrapper</code>, <code>StakingRewards</code> Wrong implementation will send <code>concur</code> rewards to the wrong receiver</a></h2>\n<p><em>Submitted by WatchPug, also found by bobi, CertoraInc, csanuragjain, danb, hickuphh3, and leastwood</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L246\">ConvexStakingWrapper.sol#L246</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L99\">StakingRewards.sol#L99</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L159-L167\">MasterChef.sol#L159-L167</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">UserInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">userInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">][</span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">()];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">updatePool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pending</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">accConcurPerShare</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">_concurShareMultiplier</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewardDebt</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pending</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">safeConcurTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pending</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><code>ConvexStakingWrapper</code>, <code>StakingRewards</code> is using <code>masterChef.deposit()</code>, <code>masterChef.withdraw()</code>, and these two functions on <code>masterChef</code> will take <code>_msgSender()</code> as the user address, which is actually the address of <code>ConvexStakingWrapper</code> and <code>StakingRewards</code>.</p>\n<p>As a result, when calling <code>ConvexStakingWrapper.deposit()</code>, <code>ConvexStakingWrapper.withdraw()</code>, <code>StakingRewards.stake()</code>, <code>StakingRewards.withdraw()</code>, the <code>concur</code> rewards belongs to all the users of ConvexStakingWrapper / StakingRewards will be sent to the caller wrongfully.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Alice deposits <code>1,000,000</code> token to <code>pid 1</code></li>\n</ol>\n<p>Actual results on <code>masterChef</code>:</p>\n<ul>\n<li>userInfo[1][address(ConvexStakingWrapper)] = <code>1,000,000</code></li>\n</ul>\n<p>Expected results:</p>\n<ul>\n<li>userInfo[1][address(Alice)] = <code>1,000,000</code></li>\n<li>1 day later, Bob deposits <code>1</code> token to <code>pid 1</code></li>\n</ul>\n<p>Actual results on <code>masterChef</code>:</p>\n<ul>\n<li>userInfo[1][address(ConvexStakingWrapper)] = <code>1,000,001</code></li>\n<li>all <code>pending rewards</code> sent to Bob</li>\n</ul>\n<p>Expected results:</p>\n<ul>\n<li>userInfo[1][address(Alice)] = <code>1,000,000</code></li>\n<li>userInfo[1][address(Bob)] = <code>1</code></li>\n<li>all <code>pending rewards</code> should be sent to Alice</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding two new functions to MasterChef: <code>depositFor()</code> and <code>withdrawFor()</code>.</p>\n<p><code>ConvexStakingWrapper</code>, <code>StakingRewards</code> can utilize these two functions and get the accounting right.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">depositFor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyDepositor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">PoolInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pool</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">poolInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">UserInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">userInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_user</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/205\">ryuheimat (Concur) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-05-usdmpegrecovery-risk-of-fund-locked-due-to-discrepancy-between-curvelp-token-value-against-internal-contract-math\" style=\"position:relative;\"><a href=\"#h-05-usdmpegrecovery-risk-of-fund-locked-due-to-discrepancy-between-curvelp-token-value-against-internal-contract-math\" aria-label=\"h 05 usdmpegrecovery risk of fund locked due to discrepancy between curvelp token value against internal contract math permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/70\">[H-05] <code>USDMPegRecovery</code> Risk of fund locked, due to discrepancy between curveLP token value against internal contract math</a></h2>\n<p><em>Submitted by Alex the Entreprenerd, also found by gzeon, IllIllI, and leastwood</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/USDMPegRecovery.sol#L90\">USDMPegRecovery.sol#L90</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/USDMPegRecovery.sol#L110\">USDMPegRecovery.sol#L110</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/USDMPegRecovery.sol#L73\">USDMPegRecovery.sol#L73</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/USDMPegRecovery.sol#L84\">USDMPegRecovery.sol#L84</a><br></p>\n<p>In <code>USDMPegRecovery</code> <code>deposit</code> and <code>withdraw</code> allow for direct deposits of a specific token (3crv or usdm).</p>\n<p>The balances are directly changed and tracked in storage.</p>\n<p><code>provide</code> seems to be using the real balances (not the ones store) to provide liquidity.<br>\nBecause of how curve works, you’ll be able (first deposit) to provide exactly matching liquidity.<br>\nBut after (even just 1 or) multiple swaps, the pool will be slightly imbalanced, adding or removing liquidity at that point will drastically change the balances in the contract from the ones tracked in storage.</p>\n<p>Eventually users won’t be able to withdraw the exact amounts they deposited.</p>\n<p>This will culminate with real balances not matching user deposits, sometimes to user advantage and other times to user disadvantage, ultimately to the protocol dismay.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Deposit equal usdm and 3crv<br>\nLP<br>\nDo one trade on CRV<br>\nWithdraw the LP</p>\n<p>The real balances are not matching the balances in storage.</p>\n<p>User tries to withdraw all their balances, inevitable revert.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Either find a way to price the user contribution based on the LP tokens (use virtual_price)<br>\nOr simply have people deposit the LP token directly (avoiding the IL math which is a massive headache)</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/70\">leekt (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/70#issuecomment-1097330571\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I’m forfeitting winnings as I am judging the contest.</p>\n<p>The sponsor confirmed.</p>\n<p>I believe the closest findings are <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/191\">#191</a> and <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/94\">#94</a> these both focus on the provide aspect.<br>\nHowever, this finding shows how the Curve LP Math will cause the internal balances to break after just one LP provision.</p>\n<p>Because this breaks accounting of the protocol and will cause funds to be stuck I believe High Severity to be appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-06-convexstakingwrappersol_calcrewardintegral-wrong-implementation-can-disrupt-rewards-calculation-and-distribution\" style=\"position:relative;\"><a href=\"#h-06-convexstakingwrappersol_calcrewardintegral-wrong-implementation-can-disrupt-rewards-calculation-and-distribution\" aria-label=\"h 06 convexstakingwrappersol_calcrewardintegral wrong implementation can disrupt rewards calculation and distribution permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/199\">[H-06] <code>ConvexStakingWrapper.sol#_calcRewardIntegral</code> Wrong implementation can disrupt rewards calculation and distribution</a></h2>\n<p><em>Submitted by WatchPug, also found by cmichel, harleythedog, hickuphh3, kirk-baird, and leastwood</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L175-L204\">ConvexStakingWrapper.sol#L175-L204</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bal</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">d_reward</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">bal</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">remaining</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// send 20 % of cvx / crv reward to treasury</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">cvx</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">crv</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">treasury</span><span class=\"mtk1\">, </span><span class=\"mtk12\">d_reward</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">5</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">d_reward</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">d_reward</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">4</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">5</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">claimContract</span><span class=\"mtk1\">), </span><span class=\"mtk12\">d_reward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_supply</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">d_reward</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">integral</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">integral</span><span class=\"mtk1\"> +</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">((</span><span class=\"mtk12\">d_reward</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e20</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">_supply</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//update user integrals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userI</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">userReward</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_index</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_account</span><span class=\"mtk1\">].</span><span class=\"mtk12\">integral</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">userI</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">integral</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">userReward</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_index</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_account</span><span class=\"mtk1\">].</span><span class=\"mtk12\">integral</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">integral</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">claimContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">pushReward</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_account</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">_balance</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">integral</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">userI</span><span class=\"mtk1\">)) / </span><span class=\"mtk7\">1e20</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//update remaining reward here since balance could have changed if claiming</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bal</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">remaining</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">remaining</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bal</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The problems in the current implementation:</p>\n<ul>\n<li><code>reward.remaining</code> is not a global state; the <code>reward.remaining</code> of other <code>reward</code>s with the same rewardToken are not updated;</li>\n<li><code>bal</code> should be refreshed before <code>reward.remaining = uint128(bal);</code>;</li>\n<li>L175 should not use <code>balanceOf</code> but take the diff before and after <code>getReward()</code>.</li>\n</ul>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ul>\n<li>convexPool[1] is incentivized with CRV as the reward token, <code>1000 lpToken</code> can get <code>10 CRV</code> per day;</li>\n<li>convexPool[2] is incentivized with CRV as the reward token, <code>1000 lpToken</code> can get <code>20 CRV</code> per day.</li>\n<li>Alice deposits <code>1,000</code> lpToken to <code>_pid</code> = <code>1</code></li>\n<li>1 day later, Alice deposits <code>500</code> lpToken to <code>_pid</code> = <code>1</code></li>\n<li>convexPool <code>getReward()</code> sends <code>10 CRV</code> as reward to contract</li>\n<li><code>d_reward</code> = 10, <code>2 CRV</code> sends to <code>treasury</code>, <code>8 CRV</code> send to <code>claimContract</code></li>\n<li><code>rewards[1][0].remaining</code> = 10</li>\n<li>0.5 day later, Alice deposits <code>500</code> lpToken to <code>_pid</code> = <code>1</code>, and the tx will fail:</li>\n<li>convexPool <code>getReward()</code> sends <code>7.5 CRV</code> as reward to contract</li>\n<li><code>reward.remaining</code> = 10</li>\n<li><code>bal</code> = 7.5</li>\n<li><code>bal - reward.remaining</code> will fail due to underflow</li>\n<li>0.5 day later, Alice deposits <code>500</code> lpToken to <code>_pid</code> = <code>1</code>, most of the reward tokens will be left in the contract:</li>\n<li>convexPool <code>getReward()</code> sends <code>15 CRV</code> as reward to the contract;</li>\n<li><code>d_reward = bal - reward.remaining</code> = 5</li>\n<li><code>1 CRV</code> got sent to <code>treasury</code>, <code>4 CRV</code> sent to <code>claimContract</code>, <code>10 CRV</code> left in the contract;</li>\n<li><code>rewards[1][0].remaining</code> = 15</li>\n</ul>\n<p>Expected Results:</p>\n<p>All the <code>15 CRV</code> get distributed: <code>3 CRV</code> to the <code>treasury</code>, and <code>12 CRV</code> to <code>claimContract</code>.</p>\n<p>Actual Results:</p>\n<p>Only <code>5 CRV</code> got distributed. The other <code>10 CRV</code> got left in the contract which can be frozen in the contract, see below for the details:</p>\n<ol start=\"5\">\n<li>Bob deposits <code>1,000</code> lpToken to <code>_pid</code> = <code>2</code></li>\n<li>convexPool <code>getReward()</code> sends <code>0 CRV</code> as reward to the contract</li>\n<li><code>d_reward = bal - reward.remaining</code> = 10</li>\n<li><code>2 CRV</code> sent to <code>treasury</code>, <code>8 CRV</code> sent to <code>claimContract</code> without calling <code>pushReward()</code>, so the <code>8 CRV</code> are now frozen in <code>claimContract</code>;</li>\n<li><code>rewards[2][0].remaining</code> = 10</li>\n</ol>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<ul>\n<li>The two most important methods: <code>deposit()</code> and <code>withdraw()</code> will frequently fail as the tx will revert at <code>_calcRewardIntegral()</code>;</li>\n<li>Rewards distributed to users can often be fewer than expected;</li>\n<li>If there are different pools that use the same token as rewards, part of the rewards can be frozen at <code>claimContract</code> and no one can claim them.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider comparing the <code>balanceOf</code> reward token before and after <code>getReward()</code> to get the actual rewarded amount, and <code>reward.remaining</code> should be removed.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/199\">leekt (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/199#issuecomment-1102806558\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how <code>_calcRewardIntegral</code> can be broken in multiple ways.</p>\n<p>While I believe a set of similar findings have been reported, this one is extremely well written so I think this can stand on it’s own.</p>\n<p>Because <code>_calRewardIntegral</code> is a core functionality of the contract (giving out reward) and the warden has shown how it can be broken, I agree with High Severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-07-shelter-claimed-mapping-is-set-with-_to-address-and-not-msgsender\" style=\"position:relative;\"><a href=\"#h-07-shelter-claimed-mapping-is-set-with-_to-address-and-not-msgsender\" aria-label=\"h 07 shelter claimed mapping is set with _to address and not msgsender permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/103\">[H-07] Shelter <code>claimed</code> mapping is set with <code>_to</code> address and not <code>msg.sender</code></a></h2>\n<p><em>Submitted by 0xliumin, also found by cmichel, leastwood, and pauliax</em></p>\n<p>Any user can withdraw all the funds from the shelter. This is done by calling withdraw repeatedly until all funds are drained. You only need to have a small share.</p>\n<p>Even if the <code>claimed</code> mapping was checked, there would still be a vulnerability. This is because the <code>claimed</code> mapping is updated with the <code>_to</code> address, not the <code>msg.sender</code> address.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Remediation is to change the <code>_to</code> to <code>msg.sender</code>.<br>\n<a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/Shelter.sol#L55\">Shelter.sol#L55</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/103\">leekt (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/103#issuecomment-1102697656\">Alex the Entreprenerd (judge) increased severity to High and commented</a>:</strong></p>\n<blockquote>\n<p>Am marking this as a unique finding as this one shows another issue with the Shelter withdraw function.</p>\n<p>Because this also allows for draining of all rewards, am raising to High Severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-08-masterchefsol-users-wont-be-able-to-receive-the-concur-rewards\" style=\"position:relative;\"><a href=\"#h-08-masterchefsol-users-wont-be-able-to-receive-the-concur-rewards\" aria-label=\"h 08 masterchefsol users wont be able to receive the concur rewards permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/200\">[H-08] <code>MasterChef.sol</code> Users won’t be able to receive the <code>concur</code> rewards</a></h2>\n<p><em>Submitted by WatchPug, also found by hickuphh3 and leastwood</em></p>\n<p>According to:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-02-concur#-masterchef\">README</a></li>\n<li>Implementation of <code>deposit()</code>: <a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L157-L180\">/contracts/MasterChef.sol#L157-L180</a></li>\n</ul>\n<p>MasterChef is only recording the deposited amount in the states, it’s not actually holding the <code>depositToken</code>.</p>\n<p><code>depositToken</code> won’t be transferred from <code>_msgSender()</code> to the MasterChef contract.</p>\n<p>Therefore, in <code>updatePool()</code> L140 <code>lpSupply = pool.depositToken.balanceOf(address(this))</code> will always be <code>0</code>. And the <code>updatePool()</code> will be returned at L147.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L135-L154\">MasterChef.sol#L135-L154</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">updatePool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">PoolInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pool</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">poolInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastRewardBlock</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lpSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">lpSupply</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">allocPoint</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastRewardBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastRewardBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getMultiplier</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastRewardBlock</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">concurReward</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">concurPerBlock</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">allocPoint</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalAllocPoint</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">accConcurPerShare</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">accConcurPerShare</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">concurReward</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_concurShareMultiplier</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lpSupply</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastRewardBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<ul>\n<li>The MasterChef contract fail to implement the most essential function;</li>\n<li>Users won’t be able to receive any <code>Concur</code> rewards from MasterChef;</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider creating a receipt token to represent the invested token and use the receipt tokens in MasterChef.</p>\n<p>See: <a href=\"https://github.com/convex-eth/platform/blob/883ffd4ebcaee12e64d18f75bdfe404bcd900616/contracts/contracts/Booster.sol#L272-L277\">https://github.com/convex-eth/platform/blob/883ffd4ebcaee12e64d18f75bdfe404bcd900616/contracts/contracts/Booster.sol#L272-L277</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/200\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/200#issuecomment-1100908295\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified a logical flaw in the <code>Masterchef</code> contract.</p>\n<p>The contract is expecting <code>lpTokens</code> (deposited in another depositor contract) to be in the <code>Masterchef</code> at the time in which <code>updatePool</code> is called.</p>\n<p>However, due to the fact that the <code>lpToken</code> will be somewhere else, a more appropriate check would be to ask the depositor contract for the total supply.</p>\n<p>Given this finding, the Masterchef contract will always reward 0 tokens.</p>\n<p>This should classify the finding as Medium Severity (loss of Yield).</p>\n<p>However, because the finding shows how this can happen reliably, and effectively breaks the purpose of the contract, I believe High Severity to be more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-09-deposit-in-convexstakingwrapper-will-most-certainly-revert\" style=\"position:relative;\"><a href=\"#h-09-deposit-in-convexstakingwrapper-will-most-certainly-revert\" aria-label=\"h 09 deposit in convexstakingwrapper will most certainly revert permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/33\">[H-09] deposit in <code>ConvexStakingWrapper</code> will most certainly revert</a></h2>\n<p><em>Submitted by wuwe1, also found by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/ConvexStakingWrapper.sol#L94-L99\">ConvexStakingWrapper.sol#L94-L99</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mainPool</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IRewardStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">convexBooster</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">poolInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk12\">crvRewards</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pids</span><span class=\"mtk1\">[</span><span class=\"mtk11\">IRewardStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">convexBooster</span><span class=\"mtk1\">).</span><span class=\"mtk11\">poolInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">).</span><span class=\"mtk12\">lptoken</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">convexPool</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">mainPool</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><code>convexPool[_pid]</code> is set to <code>IRewardStaking(convexBooster).poolInfo(_pid).crvRewards;</code></p>\n<p><code>crvRewards</code> is a <code>BaseRewardPool</code> like this one: <a href=\"https://etherscan.io/address/0x8B55351ea358e5Eda371575B031ee24F462d503e#code\">https://etherscan.io/address/0x8B55351ea358e5Eda371575B031ee24F462d503e#code</a>.</p>\n<p><code>BaseRewardPool</code> does not implement <code>poolInfo</code></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/ConvexStakingWrapper.sol#L238\">ConvexStakingWrapper.sol#L238</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">IRewardStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">convexPool</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">poolInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">).</span><span class=\"mtk12\">lptoken</span></span></span></code></pre>\n<p>Above line calls <code>poolInfo</code> of  <code>crvRewards</code> which causes revert.</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>According to Booster’s code</p>\n<p><a href=\"https://etherscan.io/address/0xF403C135812408BFbE8713b5A23a04b3D48AAE31#code\">https://etherscan.io/address/0xF403C135812408BFbE8713b5A23a04b3D48AAE31#code</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//deposit lp tokens and stake</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_stake</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk12\">isShutdown</span><span class=\"mtk1\">,</span><span class=\"mtk8\">&quot;shutdown&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">PoolInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pool</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">poolInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">shutdown</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;pool is closed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//send to proxy to stake</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lptoken</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lptoken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lptoken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">staker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><code>convexBooster</code> requires <code>poolInfo[_pid].lptoken</code>.</p>\n<p>change L238 to</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">IRewardStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">convexBooster</span><span class=\"mtk1\">).</span><span class=\"mtk11\">poolInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">).</span><span class=\"mtk12\">lptoken</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/33\">leekt (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/33#issuecomment-1101856224\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how an improper assumption about the pool contract can cause reverts.</p>\n<p>While the risk of loss of funds is non-existent because all calls will revert, I believe the core functionality of the code is broken. For that reason, I think High Severity to be the proper severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-10-convexstakingwrapperexitshelter-will-lock-lp-tokens-preventing-users-from-withdrawing\" style=\"position:relative;\"><a href=\"#h-10-convexstakingwrapperexitshelter-will-lock-lp-tokens-preventing-users-from-withdrawing\" aria-label=\"h 10 convexstakingwrapperexitshelter will lock lp tokens preventing users from withdrawing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/144\">[H-10] <code>ConvexStakingWrapper.exitShelter()</code> Will Lock LP Tokens, Preventing Users From Withdrawing</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p>The shelter mechanism provides emergency functionality in an effort to protect users’ funds. The <code>enterShelter</code> function will withdraw all LP tokens from the pool, transfer them to the shelter contract and activate the shelter for the target LP token. Conversely, the <code>exitShelter</code> function will deactivate the shelter and transfer all LP tokens back to the <code>ConvexStakingWrapper.sol</code> contract.</p>\n<p>Unfortunately, LP tokens aren’t restaked in the pool, causing LP tokens to be stuck within the contract. Users will be unable to withdraw their LP tokens as the <code>withdraw</code> function attempts to <code>withdrawAndUnwrap</code> LP tokens from the staking pool. As a result, this function will always revert due to insufficient staked balance. If other users decide to deposit their LP tokens, then these tokens can be swiped by users who have had their LP tokens locked in the contract.</p>\n<p>This guarantees poor UX for the protocol and will most definitely lead to LP token loss.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol#L121-L130\">ConvexStakingWrapper.sol#L121-L130</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function exitShelter(uint256[] calldata _pids) external onlyOwner {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    for(uint256 i = 0; i&lt;_pids.length; i++){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IRewardStaking pool = IRewardStaking(convexPool[_pids[i]]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20 lpToken = IERC20(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            pool.poolInfo(_pids[i]).lptoken</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        amountInShelter[lpToken] = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        shelter.deactivate(lpToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol#L309-L331\">ConvexStakingWrapper.sol#L309-L331</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function withdraw(uint256 _pid, uint256 _amount)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    nonReentrant</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    whenNotInShelter(_pid)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    WithdrawRequest memory request = withdrawRequest[_pid][msg.sender];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(request.epoch &lt; currentEpoch() &amp;&amp; deposits[_pid][msg.sender].epoch + 1 &lt; currentEpoch(), &quot;wait&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(request.amount &gt;= _amount, &quot;too much&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _checkpoint(_pid, msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    deposits[_pid][msg.sender].amount -= uint192(_amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_amount &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IRewardStaking(convexPool[_pid]).withdrawAndUnwrap(_amount, false);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20 lpToken = IERC20(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IRewardStaking(convexPool[_pid]).poolInfo(_pid).lptoken</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lpToken.safeTransfer(msg.sender, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 pid = masterChef.pid(address(lpToken));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        masterChef.withdraw(msg.sender, pid, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    delete withdrawRequest[_pid][msg.sender];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //events</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit Withdrawn(msg.sender, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual code review.<br>\nConfirmation from Taek.</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider re-depositing LP tokens upon calling <code>exitShelter</code>. This should ensure the same tokens can be reclaimed by users wishing to exit the <code>ConvexStakingWrapper.sol</code> contract.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/144\">leekt (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/144#issuecomment-1101875875\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified how through a combination of using the shelter and sending funds back, the funds would actually end up being stuck and non-withdrawable by depositors.</p>\n<p>I believe that generally speaking this would be a Medium Severity finding as the funds would be stuck if the sponsor were to activate the shelter and then send the tokens back (conditionality).</p>\n<p>However, the warden has shown that the system of Contract + Shelter is effectively broken, and for this reason I believe the finding is of High Severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-11-convexstakingwrapper_calcrewardintegral-can-be-manipulated-to-steal-tokens-from-other-pools\" style=\"position:relative;\"><a href=\"#h-11-convexstakingwrapper_calcrewardintegral-can-be-manipulated-to-steal-tokens-from-other-pools\" aria-label=\"h 11 convexstakingwrapper_calcrewardintegral can be manipulated to steal tokens from other pools permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/146\">[H-11] <code>ConvexStakingWrapper._calcRewardIntegral()</code> Can Be Manipulated To Steal Tokens From Other Pools</a></h2>\n<p><em>Submitted by leastwood, also found by cmichel and kirk-baird</em></p>\n<p>The <code>ConvexStakingWrapper.sol</code> implementation makes several modifications to the original design. One of the key changes is the ability to add multiple pools into the wrapper contract, where each pool is represented by a unique <code>_pid</code>. By doing this, we are able to aggregate pools and their LP tokens to simplify the token distribution process.</p>\n<p>However, the interdependence between pools introduces new problems. Because the original implementation uses the contract’s reward token balance to track newly claimed tokens, it is possible for a malicious user to abuse the unguarded <code>getReward</code> function to maximise the profit they are able to generate. By calling <code>getReward</code> on multiple pools with the same reward token (i.e. <code>cvx</code>), users are able to siphon rewards from other pools. This inevitably leads to certain loss of rewards for users who have deposited LP tokens into these victim pools. As <code>crv</code> and <code>cvx</code> are reward tokens by default, it is very likely that someone will want to exploit this issue.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Let’s consider the following scenario:</p>\n<ul>\n<li>There are two convex pools with <code>_pid</code> 0 and 1.</li>\n<li>Both pools currently only distribute <code>cvx</code> tokens.</li>\n<li>Alice deposits LP tokens into the pool with <code>_pid</code> 0.</li>\n<li>Both pools earn 100 <code>cvx</code> tokens which are to be distributed to the holders of the two pools.</li>\n<li>While Alice is a sole staker of the pool with <code>_pid</code> 0, the pool with <code>_pid</code> 1 has several stakers.</li>\n<li>Alice decides she wants to maximise her potential rewards, so she directly calls the unguarded <code>IRewardStaking(convexPool[_pid]).getReward</code> function on both pools, resulting in 200 <code>cvx</code> tokens being sent to the contract.</li>\n<li>She then decides to deposit the 0 amount to execute the <code>_calcRewardIntegral</code> function on the pool with <code>_pid</code> 0. However, this function will calculate <code>d_reward</code> as <code>bal - reward.remaining</code> which is effectively the change in contract balance. As we have directly claimed <code>cvx</code> tokens over the two pools, this <code>d_reward</code> will be equal to 200.</li>\n<li>Alice is then entitled to the entire 200 tokens as she is the sole staker of her pool. So instead of receiving 100 tokens, she is able to siphon rewards from other pools.</li>\n</ul>\n<p>Altogether, this will lead to the loss of rewards for other stakers as they are unable to then claim their rewards.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol#L216-L259\">ConvexStakingWrapper.sol#L216-L259</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _calcRewardIntegral(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _pid,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _index,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _account,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _balance,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _supply</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    RewardType memory reward = rewards[_pid][_index];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //get difference in balance and remaining rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //getReward is unguarded so we use remaining to keep track of how much was actually claimed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 bal = IERC20(reward.token).balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 d_reward = bal - reward.remaining;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // send 20 % of cvx / crv reward to treasury</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (reward.token == cvx || reward.token == crv) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20(reward.token).transfer(treasury, d_reward / 5);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        d_reward = (d_reward * 4) / 5;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IERC20(reward.token).transfer(address(claimContract), d_reward);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_supply &gt; 0 &amp;&amp; d_reward &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        reward.integral =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            reward.integral +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint128((d_reward * 1e20) / _supply);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //update user integrals</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 userI = userReward[_pid][_index][_account].integral;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (userI &lt; reward.integral) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        userReward[_pid][_index][_account].integral = reward.integral;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        claimContract.pushReward(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _account,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            reward.token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            (_balance * (reward.integral - userI)) / 1e20</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //update remaining reward here since balance could have changed if claiming</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (bal != reward.remaining) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        reward.remaining = uint128(bal);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    rewards[_pid][_index] = reward;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual code review.<br>\nConfirmation from Taek.</p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider redesigning this mechanism such that all pools have their <code>getReward</code> function called in <code>_checkpoint</code>. The <code>_calcRewardIntegral</code> function can then ensure that each pool is allocated only a fraction of the total rewards instead of the change in contract balance. Other implementations might be more ideal, so it is important that careful consideration is taken when making these changes.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/146\">leekt (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/146#issuecomment-1101894485\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, by having the same token as rewards for multiple pools, the math for claiming can be broken, allowing the depositor of one pool to claim a portion of the token reward earned by all pools.</p>\n<p>Normally this would be contingent on implementation or overlap of the tokens, however, because we’re dealing with CVX we already know for certain that CVX and cvxCRV is going to be a reward for the majority of the pools.</p>\n<p>This finding ultimately shows how to break the accounting of the reward contract while stealing yield from all other pools, and for that reason, I believe High Severity to be valid.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-31\" style=\"position:relative;\"><a href=\"#medium-risk-findings-31\" aria-label=\"medium risk findings 31 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (31)</h1>\n<h2 id=\"m-01-deposits-after-the-grace-period-should-not-be-allowed\" style=\"position:relative;\"><a href=\"#m-01-deposits-after-the-grace-period-should-not-be-allowed\" aria-label=\"m 01 deposits after the grace period should not be allowed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/251\">[M-01] Deposits after the grace period should not be allowed</a></h2>\n<p><em>Submitted by pauliax</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/Shelter.sol#L34\">Shelter.sol#L34</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/Shelter.sol#L54\">Shelter.sol#L54</a><br></p>\n<p>Function donate in Shelter shouldn’t allow new deposits after the grace period ends, when the claim period begins.<br>\nOtherwise, it will be possible to increase savedTokens[_token], and thus new user claim amounts will increase after some users might already have withdrawn their shares.</p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Based on my understanding, it should contain this check:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">activated</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">GRACE_PERIOD</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;too late&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/251\">leekt (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/251#issuecomment-1088035152\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Separating between a rescuing period and a redemption period does make sense and avoids losing on future rewards by withdrawing early.</p>\n<p>The sponsor confirmed, I believe medium severity to be appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-unconstrained-fee\" style=\"position:relative;\"><a href=\"#m-02-unconstrained-fee\" aria-label=\"m 02 unconstrained fee permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/242\">[M-02] Unconstrained fee</a></h2>\n<p><em>Submitted by Czar102, also found by defsec, Dravee, harleythedog, hickuphh3, and throttle</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L86-L101\">MasterChef.sol#L86-L101</a><br></p>\n<p>Token fee in <code>MasterChef</code> can be set to more than 100%, (for example, by accident) causing all <code>deposit</code> calls to fail due to underflow on subtraction when reward is lowered by the fee, thus breaking essential mechanics. Note that after the fee has been set to any value, it cannot be undone. A token cannot be removed, added, or added the second time. Thus, mistakenly (or deliberately, maliciously) added fee that is larger than 100% will make the contract impossible to recover from not being able to use the token.</p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>On setting fee ensure that it is below a set maximum, which is set to no more than 100%.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/242\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/242#issuecomment-1088039177\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified admin privilege that would enable them to set the deposit fee to 100%.<br>\nThe value can also be increased above 100% to cause a denial of service to the user.</p>\n<p>Mitigation would require offering a more appropriate upper limit to the fee.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-usdmpegrecoverysolwithdraw-withdraw-may-often-fail\" style=\"position:relative;\"><a href=\"#m-03-usdmpegrecoverysolwithdraw-withdraw-may-often-fail\" aria-label=\"m 03 usdmpegrecoverysolwithdraw withdraw may often fail permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/212\">[M-03] <code>USDMPegRecovery.sol#withdraw()</code> withdraw may often fail</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p>Per the doc:</p>\n<blockquote>\n<p>USDM deposits are locked based on the KPI’s from carrot.eth.</p>\n</blockquote>\n<blockquote>\n<p>3Crv deposits are not locked.</p>\n</blockquote>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/USDMPegRecovery.sol#L110-L128\">USDMPegRecovery.sol#L110-L128</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Liquidity</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_withdrawal</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Liquidity</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">total</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalLiquidity</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Liquidity</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">userLiquidity</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_withdrawal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">usdm</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">unlockable</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;!unlock usdm&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">usdm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_withdrawal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">usdm</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">total</span><span class=\"mtk1\">.</span><span class=\"mtk12\">usdm</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">_withdrawal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">usdm</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">usdm</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">_withdrawal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">usdm</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_withdrawal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool3</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pool3</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_withdrawal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool3</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">total</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool3</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">_withdrawal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool3</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool3</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">_withdrawal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pool3</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">totalLiquidity</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">total</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">userLiquidity</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">user</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_withdrawal</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>However, because the <code>withdraw()</code> function takes funds from the balance of the contract, once the majority of the funds are added to the curve pool via <code>provide()</code>. The <code>withdraw()</code> may often fail due to insufficient funds in the balance.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Alice deposits <code>4M</code> USDM and <code>4M</code> pool3 tokens;</li>\n<li>Guardian calls <code>provide()</code> and all the <code>usdm</code> and <code>pool3</code> to <code>usdm3crv</code>;</li>\n<li>Alice calls <code>withdraw()</code>, the tx will fail, due to insufficient balance.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider calling <code>usdm3crv.remove_liquidity_one_coin()</code> when the balance is insufficient for the user’s withdrawal.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/212\">leekt (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/212#issuecomment-1088104169\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified a specific scenario in which user funds would not be withdrawable</p>\n<p>Because the code uses internal storage for accounting rather than “value” this scenario can happen fairly reliably.</p>\n<p>I believe mitigation requires further thought than just withdrawing and ideally it would be best to setup a system similar to Vault Shares so that a withdrawal could be triggered either by available liquidity or via a withdrawal from the pool.</p>\n<p>I think Medium severity is appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-usdmpegrecoverysolprovide-improper-designimplementation-make-it-often-unable-to-add-liquidity-to-the-usdm3crv-pool\" style=\"position:relative;\"><a href=\"#m-04-usdmpegrecoverysolprovide-improper-designimplementation-make-it-often-unable-to-add-liquidity-to-the-usdm3crv-pool\" aria-label=\"m 04 usdmpegrecoverysolprovide improper designimplementation make it often unable to add liquidity to the usdm3crv pool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/191\">[M-04] <code>USDMPegRecovery.sol#provide()</code> Improper design/implementation make it often unable to add liquidity to the <code>usdm3crv</code> pool</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/02d286253cd5570d4e595527618366f77627cdaf/contracts/USDMPegRecovery.sol#L73-L82\">USDMPegRecovery.sol#L73-L82</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">provide</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_minimumLP</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGuardian</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usdm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) &gt;= </span><span class=\"mtk12\">totalLiquidity</span><span class=\"mtk1\">.</span><span class=\"mtk12\">usdm</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&lt;liquidity&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// truncate amounts under step</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addingLiquidity</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">usdm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) / </span><span class=\"mtk12\">step</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">step</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// match usdm : pool3 = 1 : 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\"> = [</span><span class=\"mtk12\">addingLiquidity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">addingLiquidity</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">usdm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usdm3crv</span><span class=\"mtk1\">), </span><span class=\"mtk12\">addingLiquidity</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">pool3</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usdm3crv</span><span class=\"mtk1\">), </span><span class=\"mtk12\">addingLiquidity</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">usdm3crv</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add_liquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_minimumLP</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>In the current implementation of <code>USDMPegRecovery.sol#provide()</code>, <code>addingLiquidity</code> is calculated solely based on <code>usdm</code> balance (truncate at a step of 250k), and it always uses the same amount of 3pool tokens to add_liquidity with.</p>\n<p>Based on other functions of the contract, the balance of <code>usdm</code> can usually be more than the <code>pool3</code> balance, in that case, <code>usdm3crv.add_liquidity()</code> will fail.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>When the balance of <code>pool3</code> is less than <code>usdm</code> (which is can be a common scenario), funds cannot be added to the curve pool.</p>\n<p>For example:</p>\n<p>When the contract got 5M of USDM and 4.2M of <code>pool3</code> tokens, it won’t be possible to call <code>provide()</code> and add liquidity to the <code>usdm3crv</code> pool, as there are not enough pool3 tokens to match the 5M of USDM yet.</p>\n<p>We expect it to add liquidity with 4M of USDM and 4M of pool3 tokens in that case.</p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">provide</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_minimumLP</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGuardian</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usdm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) &gt;= </span><span class=\"mtk12\">totalLiquidity</span><span class=\"mtk1\">.</span><span class=\"mtk12\">usdm</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&lt;liquidity&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk11\">min</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usdm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">pool3</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// truncate amounts under step</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addingLiquidity</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">tokenBalance</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">step</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">step</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// match usdm : pool3 = 1 : 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\"> = [</span><span class=\"mtk12\">addingLiquidity</span><span class=\"mtk1\">, </span><span class=\"mtk12\">addingLiquidity</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">usdm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usdm3crv</span><span class=\"mtk1\">), </span><span class=\"mtk12\">addingLiquidity</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">pool3</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usdm3crv</span><span class=\"mtk1\">), </span><span class=\"mtk12\">addingLiquidity</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">usdm3crv</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add_liquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_minimumLP</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/191\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/191#issuecomment-1088106517\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I agree with the finding, ultimately liquidity addition won’t be at a 1:1 rate and the code won’t adapt to that situation causing reverts.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-usdm-locked-unless-guardian-remove-liquidity\" style=\"position:relative;\"><a href=\"#m-05-usdm-locked-unless-guardian-remove-liquidity\" aria-label=\"m 05 usdm locked unless guardian remove liquidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/187\">[M-05] USDM locked unless guardian remove liquidity</a></h2>\n<p><em>Submitted by gzeon</em></p>\n<p>In README.me:</p>\n<blockquote>\n<p>USDM deposits are locked based on the KPI’s from carrot.eth</p>\n</blockquote>\n<p>However, USDM deposits are also locked until guardian remove liquidity because there are no mechanism to remove deposited USDM in <code>withdraw</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/USDMPegRecovery.sol#L90\">USDMPegRecovery.sol#L90</a><br></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/187\">leekt (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/187#issuecomment-1088108967\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified Admin Privilege in that the deposit contract is controlled by the admin and liquidity LPd into the Curve Pool cannot be withdrawn by user (although code for redemption is present).</p>\n<p>Ultimately a refactoring that transforms this contract in something similar to a Yield Bearing Vault would solve for accounting while allowing an easier time adding and removing liquidity.</p>\n<p>Personally I’d recommend the sponsor to denominate the deposit token in the CRV_LP token to avoid issues with Single Sided Exposure, which other findings in this contest already discuss.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-stakingrewardssol-recovererc20-can-be-used-as-a-backdoor-by-the-owner-to-retrieve-rewardstoken\" style=\"position:relative;\"><a href=\"#m-06-stakingrewardssol-recovererc20-can-be-used-as-a-backdoor-by-the-owner-to-retrieve-rewardstoken\" aria-label=\"m 06 stakingrewardssol recovererc20 can be used as a backdoor by the owner to retrieve rewardstoken permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/210\">[M-06] <code>StakingRewards.sol</code> <code>recoverERC20()</code> can be used as a backdoor by the <code>owner</code> to retrieve <code>rewardsToken</code></a></h2>\n<p><em>Submitted by WatchPug, also found by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L166-L176\">StakingRewards.sol#L166-L176</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">recoverERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlyOwner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;Cannot withdraw the staking token&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Recovered</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Users can lose all the rewards to the malicious/compromised <code>owner</code>.</p>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">recoverERC20</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardsToken</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;20&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Recovered</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/210\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/210#issuecomment-1088110273\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding, ultimately a simple check would provide stronger security guarantees.</p>\n<p>Because this is contingent on a malicious owner, I believe Medium Severity to be more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-fee-on-transfer-token-donations-in-shelter-break-withdrawals\" style=\"position:relative;\"><a href=\"#m-07-fee-on-transfer-token-donations-in-shelter-break-withdrawals\" aria-label=\"m 07 fee on transfer token donations in shelter break withdrawals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/180\">[M-07] Fee-on-transfer token donations in <code>Shelter</code> break withdrawals</a></h2>\n<p><em>Submitted by cmichel, also found by Dravee, IllIllI, and Ruhum</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/Shelter.sol#L34\">Shelter.sol#L34</a><br></p>\n<p>The <code>Sheler.donate</code> function <code>transferFrom</code>s <code>_amount</code> and adds the entire <code>_amount</code> to <code>savedTokens[_token]</code>.<br>\nBut the actual received token amount from the transfer can be less for fee-on-transfer tokens.</p>\n<p>The last person to withdraw will not be able to as <code>withdraw</code> uses a share computation for the entire <code>savedTokens[_token]</code> amount.<br>\nThe calculated <code>amount</code> will then be higher than the actual contract balance.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">donate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">activated</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">] != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;!activated&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">savedTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit fee-on-transfer. then fails for last person in `withdraw`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit percentage on storage var, not on actual balance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">savedTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">] * </span><span class=\"mtk12\">client</span><span class=\"mtk1\">.</span><span class=\"mtk11\">shareOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">client</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalShare</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit amount might not be in contract anymore as savedTokens[_token] is over-reported</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>In <code>donate</code>, add only the actual transferred amounts (computed by <code>post-transfer balance - pre-transfer balance</code>) to <code>savedTokens[_token]</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/180\">leekt (Concur) acknowledged</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/180#issuecomment-1088119261\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified a specific interaction between a <code>feeOnTransfer</code> token and the Shelter Contract.</p>\n<p>Because the Shelter Contract can receive any token, and anyone could claim them based on percentage, and because some people will lose the ability to claim due to the internal accounting being incorrect, I believe that in this instance the finding is valid, and of medium severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-donated-tokens-cannot-be-recovered-if-a-shelter-is-deactivated\" style=\"position:relative;\"><a href=\"#m-08-donated-tokens-cannot-be-recovered-if-a-shelter-is-deactivated\" aria-label=\"m 08 donated tokens cannot be recovered if a shelter is deactivated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/173\">[M-08] Donated Tokens Cannot Be Recovered If A Shelter Is Deactivated</a></h2>\n<p><em>Submitted by leastwood, also found by reassor</em></p>\n<p>The shelter mechanism can be activated and deactivated on a target LP token. The owner of the <code>ConvexStakingWrapper.sol</code> contract can initiate the shelter whereby LP tokens are sent to the <code>Shelter.sol</code> contract. However, if the owner decides to deactivate the shelter before the grace period has passed, all LP tokens are transferred back to the <code>ConvexStakingWrapper.sol</code> contract. Donated tokens are also sent back to the contract. As a result, these tokens do not actually belong to any user and will effectively be lost in the contract.</p>\n<h4 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/Shelter.sol#L32-L36\">Shelter.sol#L32-L36</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function donate(IERC20 _token, uint256 _amount) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(activated[_token] != 0, &quot;!activated&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    savedTokens[_token] += _amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _token.safeTransferFrom(msg.sender, address(this), _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol#L107-L130\">ConvexStakingWrapper.sol#L107-L130</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function enterShelter(uint256[] calldata _pids) external onlyOwner {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    for(uint256 i = 0; i&lt;_pids.length; i++){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IRewardStaking pool = IRewardStaking(convexPool[_pids[i]]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount = pool.balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pool.withdrawAndUnwrap(amount, false);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20 lpToken = IERC20(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            pool.poolInfo(_pids[i]).lptoken</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        amountInShelter[lpToken] = amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lpToken.safeTransfer(address(shelter), amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        shelter.activate(lpToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function exitShelter(uint256[] calldata _pids) external onlyOwner {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    for(uint256 i = 0; i&lt;_pids.length; i++){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IRewardStaking pool = IRewardStaking(convexPool[_pids[i]]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20 lpToken = IERC20(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            pool.poolInfo(_pids[i]).lptoken</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        amountInShelter[lpToken] = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        shelter.deactivate(lpToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider allocating donated LP tokens to the contract owner when a shelter is deactivated. This can be done by checking for an excess of LP tokens. Anything greater than <code>amountInShelter</code> can be considered as donated.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/173\">leekt (Concur) acknowledged</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/173#issuecomment-1092314721\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has indentified a way to potentially lose tokens, ultimately the contract could be rewritten to constantly allow redemption.</p>\n<p>For those reasons, and because the sponsor acknowledged, I believe the finding to be valid and of medium severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-stakingrewardssolnotifyrewardamount-improper-reward-balance-checks-can-make-some-users-unable-to-withdraw-their-rewards\" style=\"position:relative;\"><a href=\"#m-09-stakingrewardssolnotifyrewardamount-improper-reward-balance-checks-can-make-some-users-unable-to-withdraw-their-rewards\" aria-label=\"m 09 stakingrewardssolnotifyrewardamount improper reward balance checks can make some users unable to withdraw their rewards permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/209\">[M-09] <code>StakingRewards.sol#notifyRewardAmount()</code> Improper reward balance checks can make some users unable to withdraw their rewards</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L154-L158\">StakingRewards.sol#L154-L158</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rewardsToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rewardRate</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">rewardsDuration</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;Provided reward too high&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span></code></pre>\n<p>In the current implementation, the contract only checks if balanceOf <code>rewardsToken</code> is greater than or equal to the future rewards.</p>\n<p>However, under normal circumstances, since users can not withdraw all their rewards in time, the balance in the contract contains rewards that belong to the users but have not been withdrawn yet. This means the current checks can not be sufficient enough to make sure the contract has enough amount of rewardsToken.</p>\n<p>As a result, if the <code>rewardsDistribution</code> mistakenly <code>notifyRewardAmount</code> with a larger amount, the contract may end up in a wrong state that makes some users unable to claim their rewards.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Given:</p>\n<ul>\n<li>rewardsDuration = 7 days;</li>\n<li>Alice stakes <code>1,000</code> stakingToken;</li>\n<li><code>rewardsDistribution</code> sends <code>100</code> rewardsToken to the contract;</li>\n<li><code>rewardsDistribution</code> calls <code>notifyRewardAmount()</code> with <code>amount</code> = <code>100</code>;</li>\n<li>7 days later, Alice calls <code>earned()</code> and it returns <code>100</code> rewardsToken, but Alice choose not to <code>getReward()</code> for now;</li>\n<li><code>rewardsDistribution</code> calls <code>notifyRewardAmount()</code> with <code>amount</code> = <code>100</code> without send any fund to contract, the tx will succees;</li>\n<li>7 days later, Alice calls <code>earned()</code> <code>200</code> rewardsToken, when Alice tries to call <code>getReward()</code>, the transaction will fail due to insufficient balance of rewardsToken.</li>\n</ul>\n<p>Expected Results:</p>\n<p>The tx in step 5 should revert.</p>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider changing the function <code>notifyRewardAmount</code> to <code>addRward</code> and use <code>transferFrom</code> to transfer rewardsToken into the contract:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addRward</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reward</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">updateReward</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">(0))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">rewardsDistribution</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;Caller is not RewardsDistribution contract&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">periodFinish</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rewardRate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">reward</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">rewardsDuration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">periodFinish</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">leftover</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">rewardRate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rewardRate</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">reward</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">leftover</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">rewardsDuration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">rewardsToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">reward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">lastUpdateTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">periodFinish</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">rewardsDuration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RewardAdded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/209\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/209#issuecomment-1104079338\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Given the code available, the warden has shown a possible scenario where certain depositors cannot receive reward tokens.</p>\n<p>Because this is contingent on an improper configuration and because this relates to loss of Yield, I believe Medium Severity to be more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-users-will-lose-rewards-if-the-shelter-mechanism-is-enacted-before-a-recent-checkpoint\" style=\"position:relative;\"><a href=\"#m-10-users-will-lose-rewards-if-the-shelter-mechanism-is-enacted-before-a-recent-checkpoint\" aria-label=\"m 10 users will lose rewards if the shelter mechanism is enacted before a recent checkpoint permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/115\">[M-10] Users Will Lose Rewards If The Shelter Mechanism Is Enacted Before A Recent Checkpoint</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p>The shelter mechanism aims to protect the protocol’s users by draining funds into a separate contract in the event of an emergency. However, while users are able to reclaim their funds through the <code>Shelter.sol</code> contract, they will still have a deposited balance from the perspective of <code>ConvexStakingWrapper.sol</code>.</p>\n<p>Because users will only receive their rewards upon depositing/withdrawing their funds due to how the checkpointing mechanism works, it is likely that by draining funds to the <code>Shelter.sol</code> contract, users will lose out on any rewards they had accrued up and until that point. These rewards are unrecoverable and can potentially be locked within the contract if the reward token is unique and only belongs to the sheltered <code>_pid</code>.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol\">ConvexStakingWrapper.sol</a><br></p>\n<h3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider allowing users to call a public facing <code>_checkpoint</code> function once their funds have been drained to the <code>Shelter.sol</code> contract. This should ensure they receive their fair share of rewards. Careful consideration needs to be made when designing this mechanism, as by giving users full control of the <code>_checkpoint</code> function may allow them to continue receiving rewards after they have withdrawn their LP tokens.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/115\">leekt (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/115#issuecomment-1092816117\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how using the Shelter can cause depositors to lose yield they had accrued.</p>\n<p>Specifically the loss of yield will be for the time of new rewards accrued since the last <code>_checkpoint</code>.</p>\n<p>Moving to a global index (to compare user accrual against global rewards), or modifying the shelter to account for yield could be a potential way to mitigate.</p>\n<p>The sponsor confirmed and I believe medium severity to be appropriate because this is a Owner Privilege + Yield Loss finding.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-convexstakingwrapperentershelter-may-erroneously-overwrite-amountinshelter-leading-to-locked-tokens\" style=\"position:relative;\"><a href=\"#m-11-convexstakingwrapperentershelter-may-erroneously-overwrite-amountinshelter-leading-to-locked-tokens\" aria-label=\"m 11 convexstakingwrapperentershelter may erroneously overwrite amountinshelter leading to locked tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/109\">[M-11] <code>ConvexStakingWrapper.enterShelter()</code> May Erroneously Overwrite <code>amountInShelter</code> Leading To Locked Tokens</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p>The shelter mechanism provides emergency functionality in an effort to protect users’ funds. The <code>enterShelter</code> function will withdraw all LP tokens from the pool, transfer them to the shelter contract and activate the shelter for the target LP token. If this function is called again on the same LP token, the <code>amountInShelter</code> value is overwritten, potentially by the zero amount. As a result  its possible that the shelter is put in a state where no users can withdraw from it or only a select few users with a finite number of shares are able to. Once the shelter has passed its grace period, these tokens may forever be locked in the shelter contract.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol#L107-L119\">ConvexStakingWrapper.sol#L107-L119</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function enterShelter(uint256[] calldata _pids) external onlyOwner {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    for(uint256 i = 0; i&lt;_pids.length; i++){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IRewardStaking pool = IRewardStaking(convexPool[_pids[i]]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount = pool.balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pool.withdrawAndUnwrap(amount, false);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20 lpToken = IERC20(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            pool.poolInfo(_pids[i]).lptoken</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        amountInShelter[lpToken] = amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lpToken.safeTransfer(address(shelter), amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        shelter.activate(lpToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol#L132-L135\">ConvexStakingWrapper.sol#L132-L135</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function totalShare(IERC20 _token) external view override returns(uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // this will be zero if shelter is not activated</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return amountInShelter[_token];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding to the <code>amountInShelter[lpToken]</code> mapping instead of overwriting it altogether. This will allow <code>enterShelter</code> to be called multiple times with no loss of funds for the protocol’s users.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/109\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/109#issuecomment-1092826151\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The finding is valid, the owner can overwrite the <code>amountInShelter</code> storage variable causing  the math in <code>Shelter.withdraw</code>. This will cause issues with distributing previously sheltered tokens.</p>\n<p>I believe using += instead of overwriting the value may be a sufficient remediation.</p>\n<p>Because this is contingent on a “distracted / malicious” admin, I believe Medium Severity to be appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-12-usdmpegrecoveryprovide-will-fail-if-there-is-an-excess-of-usdm-tokens\" style=\"position:relative;\"><a href=\"#m-12-usdmpegrecoveryprovide-will-fail-if-there-is-an-excess-of-usdm-tokens\" aria-label=\"m 12 usdmpegrecoveryprovide will fail if there is an excess of usdm tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/94\">[M-12] <code>USDMPegRecovery.provide()</code> Will Fail If There Is An Excess Of <code>usdm</code> Tokens</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p>The <code>provide</code> function does not take a <code>_steps</code> argument and will instead calculate <code>addingLiquidity</code> by truncating amounts under <code>step</code>. As a result, if there is an excess of <code>usdm</code> such that the truncated amount exceeds the contract’s <code>pool3</code> truncated balance, then the function will revert due to insufficient <code>pool3</code> collateral.</p>\n<p>This will prevent guardians from effectively providing liquidity whenever tokens are available. Consider the following example:</p>\n<ul>\n<li>The contract has <code>500000e18</code> <code>usdm</code> tokens and <code>250000e18</code> <code>pool3</code> tokens.</li>\n<li><code>addingLiquidity</code> will be calculated as <code>500000e18 / 250000e18 * 250000e18</code>.</li>\n<li>The function will attempt to add <code>500000e18</code> <code>usdm</code> and <code>pool3</code> tokens in which there are insufficient <code>pool3</code> tokens in the contract. As a result, it will revert even though there is an abundance of tokens that satisfy the <code>step</code> amount.</li>\n</ul>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/USDMPegRecovery.sol#L73-L82\">USDMPegRecovery.sol#L73-L82</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function provide(uint256 _minimumLP) external onlyGuardian {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(usdm.balanceOf(address(this)) &gt;= totalLiquidity.usdm, &quot;&lt;liquidity&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // truncate amounts under step</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 addingLiquidity = (usdm.balanceOf(address(this)) / step) * step;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // match usdm : pool3 = 1 : 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256[2] memory amounts = [addingLiquidity, addingLiquidity];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    usdm.approve(address(usdm3crv), addingLiquidity);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pool3.approve(address(usdm3crv), addingLiquidity);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    usdm3crv.add_liquidity(amounts, _minimumLP);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual code review.<br>\nDiscussions with Taek.</p>\n<h3 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider modifying the <code>provide</code> function such that a <code>_steps</code> argument can be supplied. This will allow guardians to maximise the amount of liquidity provided to the Curve pool.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/94\">leekt (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/94#issuecomment-1095700551\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden identified a logical fallacy that would prevent the code from providing liquidity.</p>\n<p>This is because the code is only accounting for one token, ignoring the other token’s amount.</p>\n<p>Given the information I have, I agree with validity and severity of the finding. Mitigation could be achieved by following the warden’s advice or by also using the balance of the <code>pool3</code> token to calculate the LP amounts.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-13-stakingrewardsrecovererc20-allows-owner-to-rug-the-rewardstoken\" style=\"position:relative;\"><a href=\"#m-13-stakingrewardsrecovererc20-allows-owner-to-rug-the-rewardstoken\" aria-label=\"m 13 stakingrewardsrecovererc20 allows owner to rug the rewardstoken permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/69\">[M-13] <code>StakingRewards.recoverERC20</code> allows owner to rug the <code>rewardsToken</code></a></h2>\n<p><em>Submitted by Alex the Entreprenerd, also found by pauliax</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/StakingRewards.sol#L166\">StakingRewards.sol#L166</a><br></p>\n<p><code>StakingRewards.recoverERC20</code> rightfully checks against the <code>stakingToken</code> being sweeped away.<br>\nHowever, there’s no check against the <code>rewardsToken</code> which over time will sit in this contract.</p>\n<p>This is the case of an admin privilege, which allows the owner to sweep the rewards tokens, perhaps as a way to rug depositors.</p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Calling <code>StakingRewards.recoverERC20(rewardsToken, rewardsToken.balanceOf(this))</code> enables the <code>owner</code> to sweep the token.</p>\n<h3 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add an additional check</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            tokenAddress != address(rewardsToken),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            &quot;Cannot withdraw the rewards token&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/69\">leekt (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/69#issuecomment-1095712080\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Because I’m judging the contest, I am forfeiting any warden winnings.</p>\n<p>The sponsor confirms and I believe this to be medium severity as it is contingent on a malicious owner.<br>\nAdding the extra check removes the rug vector.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-14-owner-can-steal-concur-rewards\" style=\"position:relative;\"><a href=\"#m-14-owner-can-steal-concur-rewards\" aria-label=\"m 14 owner can steal concur rewards permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/239\">[M-14] Owner can steal Concur rewards</a></h2>\n<p><em>Submitted by Czar102</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L78-L80\">MasterChef.sol#L78-L80</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L157-L180\">MasterChef.sol#L157-L180</a><br></p>\n<p>Owner can steal Concur rewards by adding a depositor and inflating other depositors’ assigned balance of the token within the contract. Thus, the owner-managed depositor can get most (all but one wei) of the created tokens.</p>\n<h3 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Do not allow the owner to add depositors after the depositors have been configured.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/239#issuecomment-1041831023\">ryuheimat (Concur) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Owner is a multisig &#x26; timelock. New depositors can be added later as well.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/239#issuecomment-1097277800\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I think the warden could have done a better job at writing a POC.</p>\n<p>That said the finding is valid. The sponsor could set a <code>depositor</code> to be any EOA and because there’s no transfer of tokens the balances could be inflated. Setting an immutable depositor would bring stronger security guarantees instead of allowing any contract to become a depositor.</p>\n<p>Because this is contingent on admin privilege, I believe medium severity to be more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-15-owner-can-lock-tokens-in-masterchef\" style=\"position:relative;\"><a href=\"#m-15-owner-can-lock-tokens-in-masterchef\" aria-label=\"m 15 owner can lock tokens in masterchef permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/238\">[M-15] Owner can lock tokens in <code>MasterChef</code></a></h2>\n<p><em>Submitted by Czar102, also found by csanuragjain and Jujic</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L82-L84\">MasterChef.sol#L82-L84</a><br></p>\n<p>Owner can remove a depositor. Since only depositors can deposit and withdraw, the owner may add a contract to the whitelist, let users deposit in the contract and remove the depositor from the whitelist. Depositor’s reward cannot be withdrawn then. And takes a share of Concur tokens that will not be distributed.</p>\n<h3 id=\"recommended-mitigation-steps-24\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-24\" aria-label=\"recommended mitigation steps 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Remove <code>onlyDepositor</code> modifier from the <code>withdraw</code> function.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/238\">leekt (Concur) disputed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/238#issuecomment-1097278842\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The finding is valid in that the sponsor / owner can remove all depositors.</p>\n<p>I believe having an immutable depositor that can’t be changed would give stronger security guarantees.</p>\n<p>While the finding is valid, because it is contingent on a malicious owner, I believe Medium Severity to be more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-16-rewards-get-diluted-because-totalallocpoint-can-only-increase\" style=\"position:relative;\"><a href=\"#m-16-rewards-get-diluted-because-totalallocpoint-can-only-increase\" aria-label=\"m 16 rewards get diluted because totalallocpoint can only increase permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/221\">[M-16] Rewards get diluted because <code>totalAllocPoint</code> can only increase.</a></h2>\n<p><em>Submitted by throttle</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol\">MasterChef.sol</a><br></p>\n<p>There is no functionality for removing pools/setting pool’s allocPoints. Therefore <code>totalAllocPoint</code> only increases and rewards for pool decreases.</p>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Scenario:</p>\n<ol>\n<li>Owner adds new pool (first pool) for staking with points = 900 (totalAllocPoint=900).</li>\n<li>1 week passes.</li>\n<li>First pool staking period ends (or for other reasons that pool is not meaningfully anymore).</li>\n<li>Owner adds new pool (second pool) for staking with points = 100 (totalAllocPoint=1000).</li>\n<li>1 block later Alice stake 10 tokens there (at the same time).</li>\n<li>1 week passes.</li>\n<li>After some time Alice claims rewards. But she is eligible only for 10% of the rewards. 90% goes to unused pool.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-25\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-25\" aria-label=\"recommended mitigation steps 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add functionality for removing pool or functionality for setting pool’s <code>totalAllocPoint</code> param.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/221\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/221#issuecomment-1097286920\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>While the problem can seem trivial, the warden has proven that the contract can over time end up leaking excess value as any additional pool will dilute the <code>totalAllocPoint</code> and old pools cannot be retired.</p>\n<p>The sponsor also confirms.</p>\n<p>I believe the finding to be valid, but because the leak is contingent on settings, I believe Medium Severity to be more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-17-deactivate-function-can-be-bypassed\" style=\"position:relative;\"><a href=\"#m-17-deactivate-function-can-be-bypassed\" aria-label=\"m 17 deactivate function can be bypassed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/28\">[M-17] Deactivate function can be bypassed</a></h2>\n<p><em>Submitted by csanuragjain, also found by gzeon</em></p>\n<p>onlyClient can deactivate a token even after deadline is passed and transfer all token balance to itself.</p>\n<h3 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Navigate to contract <a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/Shelter.sol\">Shelter.sol</a></li>\n<li>Observe that token can only be deactivated if activated[_token] + GRACE_PERIOD > block.timestamp. We will bypass this</li>\n<li>onlyClient activates a token X using the activate function</li>\n<li>Assume Grace period is crossed such that activated[_token] + GRACE_PERIOD &#x3C; block.timestamp</li>\n<li>Now if onlyClient calls deactivate function, it fails with “too late”</li>\n<li>But onlyClient can bypass this by calling activate function again on token X which will reset the timestamp to latest in activated[_token] and hence onlyClient can now call deactivate function to disable the token and retrieve all funds present in the contract to his own address</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-26\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-26\" aria-label=\"recommended mitigation steps 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add below condition to activate function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function activate(IERC20 _token) external override onlyClient {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">require(activated[_token]==0, &quot;Already activated&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        activated[_token] = block.timestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        savedTokens[_token] = _token.balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit ShelterActivated(_token);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/28\">leekt (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/28#issuecomment-1097312844\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified a way for the client to trick the shelter into sending all tokens to the client, effectively rugging all other users.</p>\n<p>Because this is contingent on a malicious client, I believe Medium Severity to be more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-18-users-will-lose-concur-rewards-if-the-shelter-mechanism-is-enacted-on-a-pool\" style=\"position:relative;\"><a href=\"#m-18-users-will-lose-concur-rewards-if-the-shelter-mechanism-is-enacted-on-a-pool\" aria-label=\"m 18 users will lose concur rewards if the shelter mechanism is enacted on a pool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/116\">[M-18] Users Will Lose Concur Rewards If The Shelter Mechanism Is Enacted On A Pool</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p>The shelter mechanism aims to protect the protocol’s users by draining funds into a separate contract in the event of an emergency. However, while users are able to reclaim their funds through the <code>Shelter.sol</code> contract, they will still have a deposited balance from the perspective of <code>ConvexStakingWrapper.sol</code>.</p>\n<p>However, if the shelter mechanism is enacted before users are able to claim their Concur rewards, any accrued tokens will be lost and the <code>MasterChef.sol</code> contract will continue to allocate tokens to the sheltered pool which will be forever locked within this contract.</p>\n<p>There is currently no way to remove sheltered pools from the <code>MasterChef.sol</code> contract, hence any balance lost in the contract cannot be recovered due to a lack of a sweep mechanism which can be called by the contract owner.</p>\n<h3 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol\">ConvexStakingWrapper.sol</a><br></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/MasterChef.sol\">MasterChef.sol</a><br></p>\n<h3 id=\"recommended-mitigation-steps-27\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-27\" aria-label=\"recommended mitigation steps 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider removing sheltered pools from the <code>MasterChef.sol</code> Concur token distribution. It is important to ensure <code>massUpdatePools</code> is called before making any changes to the list of pools. Additionally, removing pools from this list may also create issues with how <code>_pid</code> is produced on each new pool. Therefore, it may be worthwhile to rethink this mechanism such that <code>_pid</code> tracks some counter variable and not <code>poolInfo.length - 1</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/116\">leekt (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/116#issuecomment-1098587000\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how the Shelter Mechanism can cause depositors to lose the unharvested field they were entitled to.</p>\n<p>This is contingent on the Shelter being used by the admin.</p>\n<p>For that reason (and because the finding is for loss of yield), I believe Medium Severity to be more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-19-rogue-pool-in-shelter\" style=\"position:relative;\"><a href=\"#m-19-rogue-pool-in-shelter\" aria-label=\"m 19 rogue pool in shelter permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/74\">[M-19] Rogue pool in Shelter</a></h2>\n<p><em>Submitted by 0x1f8b</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/Shelter.sol#L38-L42\">Shelter.sol#L38-L42</a><br></p>\n<p>Shelter contract can steal user tokens.</p>\n<h3 id=\"proof-of-concept-18\" style=\"position:relative;\"><a href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Shelter <code>client</code> can call <code>activate</code> on an already activated token, this will reset its start time, so if the client activate a token when it <code>GRACE_PERIOD</code> is almost finished, it will reset this time.<br>\nThis will prevent the user to call <code>withdraw</code> because the condition <code>activated[_token] + GRACE_PERIOD &#x3C; block.timestamp</code> but will allow the client to call <code>deactivate</code> and receive all funds from the users because it will satisfy the condition <code>activated[_token] + GRACE_PERIOD > block.timestamp</code>.</p>\n<p>Steps:</p>\n<ul>\n<li>client <code>activate</code> tokenA.</li>\n<li>Users deposit tokenA using <code>donate</code>.</li>\n<li>client <code>activate</code> tokenA again until they has enough tokens.</li>\n<li>More users use <code>donate</code>.</li>\n<li>client deactivate tokenA and receive all tokens.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-28\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-28\" aria-label=\"recommended mitigation steps 28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>Avoid <code>activate</code> twice for the same token</li>\n<li><code>donate</code> only after the <code>GRACE_PERIOD</code></li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/74\">leekt (Concur) disputed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/74#issuecomment-1100456084\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I believe the finding to be valid. The warden has shown how the Shelter design allows the client to repeatedly call <code>activate</code> to prevent anyone from withdrawing the tokens.</p>\n<p>Because this is contingent on a malicious admin, I believe Medium Severity to be more appropraite.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-20-masterchefupdatepool-fails-to-update-reward-variables-if-blocknumber--endblock\" style=\"position:relative;\"><a href=\"#m-20-masterchefupdatepool-fails-to-update-reward-variables-if-blocknumber--endblock\" aria-label=\"m 20 masterchefupdatepool fails to update reward variables if blocknumber  endblock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/107\">[M-20] <code>MasterChef.updatePool()</code> Fails To Update Reward Variables If <code>block.number >= endBlock</code></a></h2>\n<p><em>Submitted by leastwood, also found by CertoraInc, csanuragjain, Czar102, hickuphh3, kirk-baird, and WatchPug</em></p>\n<p>The <code>updatePool</code> function intends to calculate the accumulated Concur rewards by tracking the number of blocks passed since the last update to correctly determine how many Concur tokens to distribute to each share. The reward distribution has a start and end block which dictates the timeframe by which rewards will be distributed to the underlying pool.</p>\n<p>If a pool has not recently updated itself and has reached the  <code>block.number >= endBlock</code> statement in <code>updatePool</code>, then any rewards that it would normally be entitled to prior to reaching <code>endBlock</code> will not be attributed to the pool. Therefore, once rewards are no longer being distributed, pools who had not recently called <code>updatePool</code> before reaching <code>endBlock</code> are at a disadvantage as compared to more active pools.</p>\n<h4 id=\"proof-of-concept-19\" style=\"position:relative;\"><a href=\"#proof-of-concept-19\" aria-label=\"proof of concept 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L135-L154\">MasterChef.sol#L135-L154</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// Update reward variables of the given pool to be up-to-date.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function updatePool(uint _pid) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    PoolInfo storage pool = poolInfo[_pid];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (block.number &lt;= pool.lastRewardBlock) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint lpSupply = pool.depositToken.balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (lpSupply == 0 || pool.allocPoint == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pool.lastRewardBlock = block.number;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if(block.number &gt;= endBlock) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pool.lastRewardBlock = block.number;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }        </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint multiplier = getMultiplier(pool.lastRewardBlock, block.number);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint concurReward = multiplier.mul(concurPerBlock).mul(pool.allocPoint).div(totalAllocPoint);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pool.accConcurPerShare = pool.accConcurPerShare.add(concurReward.mul(_concurShareMultiplier).div(lpSupply));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pool.lastRewardBlock = block.number;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-29\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-29\" aria-label=\"recommended mitigation steps 29 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Ensure that once the <code>block.number >= endBlock</code> statement has been reached, the <code>pool.accConcurPerShare</code> is updated to reflect the number of blocks that have passed up until <code>endBlock</code>. The number of blocks should be equal to <code>endBlock - pool.lastRewardBlock</code>. This will ensure stale pools are not negatively impacted once <code>endBlock</code> has been reached by the contract.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/107\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/107#issuecomment-1103304716\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified a way in which the contract will not release rewards that are due for a depositor.</p>\n<p>Because the check doesn’t accrue until the last eligible block, the reward loss can be quantified as:<br>\nLastTimeAccrueBeforeEndBlock - endBlock</p>\n<p>The finding is valid, but because it pertains to loss of yield, and because the loss can be quantified and reduced by simply calling at the last available block, I believe Medium Severity to be more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-21-concurrewardpool-possible-reentrancy-when-claiming-rewards\" style=\"position:relative;\"><a href=\"#m-21-concurrewardpool-possible-reentrancy-when-claiming-rewards\" aria-label=\"m 21 concurrewardpool possible reentrancy when claiming rewards permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/86\">[M-21] [ConcurRewardPool] Possible reentrancy when claiming rewards</a></h2>\n<p><em>Submitted by ShadowyNoobDev, also found by 0xw4rd3n, CertoraInc, ckksec, Czar102, defsec, Alex the Entreprenerd, Heartless, IllIllI, Jujic, kirk-baird, leastwood, pauliax, peritoflores, Randyyy, reassor, Rhynorater, Sleepy, SolidityScan, and wuwe1</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/ConcurRewardPool.sol#L34\">ConcurRewardPool.sol#L34</a><br></p>\n<p>Since the reward tokens are transferred before the balances are set to 0, it is possible to perform a reentrancy attack if the reward token has some kind of call back functionality e.g. ERC777. pBTC is an ERC777 token that is currently available on Convex. A similar attack occurred with <a href=\"https://zengo.com/imbtc-defi-hack-explained/\">imBTC on uniswap v1</a>.</p>\n<h3 id=\"proof-of-concept-20\" style=\"position:relative;\"><a href=\"#proof-of-concept-20\" aria-label=\"proof of concept 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ul>\n<li>\n<p>Preparation</p>\n<ol>\n<li>Assume that pBTC is used as extra rewards for this victim convex pool.</li>\n<li>A malicious user interacts with Concur through a smart contract. He follows the standard flow and has some rewards to be claimed.</li>\n<li>The malicious user interacts with this smart contract to register a bad <code>tokensToSend()</code> callback function through the ERC-1820 contract.</li>\n<li>In this <code>tokensToSend()</code> function, he calls <code>ConcurRewardPool.claimRewards()</code> n-1 more times to drain contract.</li>\n</ol>\n</li>\n<li>\n<p>Attack</p>\n<ol>\n<li>When he calls <code>ConcurRewardPool.claimRewards()</code> for the first time, the pBTC reward tokens are transferred.</li>\n<li>You can see from the <a href=\"https://etherscan.io/address/0x5228a22e72ccc52d415ecfd199f99d0665e7733b#code\">pBTC contract</a> on line 871 that <code>_callTokensToSend(from, from, recipient, amount, \"\", \"\");</code> is called inside the <code>transfer()</code> function.</li>\n<li>If you trace to the <code>_callTokensToSend</code> function definition to line 1147, you will notice that it calls <code>IERC777Sender(implementer).tokensToSend(operator, from, to, amount, userData, operatorData);</code> on line 1159.</li>\n<li>Since the malicious user already registered a bad <code>tokensToSend()</code> function, this function will be called thus draining majority of the pBTC rewards available on the <code>ConcurRewardPool</code> contract.</li>\n</ol>\n</li>\n</ul>\n<p>You can also find a walkthrough replicating a similar attack <a href=\"https://medium.com/amber-group/preventing-re-entrancy-attacks-lessons-from-history-c2d96480fac3\">here</a>.</p>\n<h3 id=\"recommended-mitigation-steps-30\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-30\" aria-label=\"recommended mitigation steps 30 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>Use a nonReentrant modifier</li>\n<li>set balances to 0 first before disbursing the rewards</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/86\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/86#issuecomment-1100908724\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how using a specific reward token can lead to reentrancy for the function <code>claimRewards</code>.</p>\n<p>Because the finding is contingent on a specific token that enables the exploit, I believe Medium Severity to be appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-22-if-the-staking-token-exists-in-both-stakingrewardssol-and-convexstakingwrappersol-then-it-will-be-possible-to-continue-claiming-concur-rewards-after-the-shelter-has-been-activated\" style=\"position:relative;\"><a href=\"#m-22-if-the-staking-token-exists-in-both-stakingrewardssol-and-convexstakingwrappersol-then-it-will-be-possible-to-continue-claiming-concur-rewards-after-the-shelter-has-been-activated\" aria-label=\"m 22 if the staking token exists in both stakingrewardssol and convexstakingwrappersol then it will be possible to continue claiming concur rewards after the shelter has been activated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/117\">[M-22] If The Staking Token Exists In Both <code>StakingRewards.sol</code> And <code>ConvexStakingWrapper.sol</code> Then It Will Be Possible To Continue Claiming Concur Rewards After The Shelter Has Been Activated</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p>Staking tokens are used to deposit into the <code>StakingRewards.sol</code> and <code>ConvexStakingWrapper.sol</code> contracts. Once deposited, the user is entitled to Concur rewards in proportion to their staked balance and the underlying pool’s <code>allocPoint</code> in the <code>MasterChef.sol</code> contract.</p>\n<p>The <code>Shelter.sol</code> mechanism allows the owner of the <code>ConvexStakingWrapper.sol</code> to react to emergency events and protect depositor’s assets. The staking tokens can be withdrawn after the grace period has passed. However, these staking tokens can be deposited into the <code>StakingRewards.sol</code> contract to continue receiving Concur rewards not only for <code>StakingRewards.sol</code> but also for their <code>ConvexStakingWrapper.sol</code> deposited balance which has not been wiped. As a result, users are able to effectively claim double the amount of Concur rewards they should be receiving.</p>\n<h4 id=\"proof-of-concept-21\" style=\"position:relative;\"><a href=\"#proof-of-concept-21\" aria-label=\"proof of concept 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/MasterChef.sol\">MasterChef.sol</a><br></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/StakingRewards.sol\">StakingRewards.sol</a><br></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol\">ConvexStakingWrapper.sol</a><br></p>\n<h3 id=\"recommended-mitigation-steps-31\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-31\" aria-label=\"recommended mitigation steps 31 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Ensure that staking tokens cannot be deposited in both the <code>StakingRewards.sol</code> and <code>ConvexStakingWrapper.sol</code> contracts. If this is intended behaviour, it may be worthwhile to ensure that the sheltered users have their deposited balance wiped from the <code>MasterChef.sol</code> contract upon being sheltered.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/117\">leekt (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/117#issuecomment-1101852856\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown that because the shelter mechanism doesn’t wipe the balance in the contract, those same tokens can be used to further break the accounting of the contract, with the goal of extracting further rewards.</p>\n<p>While I believe the wardens work is commendable and have considered High Severity because the accounting of the protocol has been broken, I believe Medium Severity to be more appropriate because the finding:</p>\n<ul>\n<li>Is contingent on the Shelter being used</li>\n<li>There must be more rewards in the StakingRewardsContract</li>\n<li>The impact is limited to the additional rewards and nothing else</li>\n</ul>\n</blockquote>\n<hr>\n<h2 id=\"m-23-transfer-to-treasury-can-register-as-succeeded-when-failing-in-_calcrewardintegral\" style=\"position:relative;\"><a href=\"#m-23-transfer-to-treasury-can-register-as-succeeded-when-failing-in-_calcrewardintegral\" aria-label=\"m 23 transfer to treasury can register as succeeded when failing in _calcrewardintegral permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/120\">[M-23] Transfer to treasury can register as succeeded when failing in <code>_calcRewardIntegral</code></a></h2>\n<p><em>Submitted by 0xw4rd3n</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L126\">StakingRewards.sol#L126</a><br></p>\n<p>If the transfer of the reward token fails to the treasury (due to insufficient funds for example), the function <code>_calcRewardIntegral</code> will still update accounting and cause devastating accounting discrepancies in the contract.</p>\n<h3 id=\"proof-of-concept-22\" style=\"position:relative;\"><a href=\"#proof-of-concept-22\" aria-label=\"proof of concept 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Provide direct links to all referenced code in GitHub. Add screenshots, logs, or any other relevant proof that illustrates the concept.</p>\n<h3 id=\"recommended-mitigation-steps-32\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-32\" aria-label=\"recommended mitigation steps 32 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p><code>require(IERC20(reward.token).transfer(treasury, d_reward / 5), \"ERROR_MESSAGE\");</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/120\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/120#issuecomment-1101854716\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>All in all this report is the classic “No safeApprove”. But with an actual idea of a POC.<br>\nUltimately the risk is contingent on the specific reward.token being a nonRevertingOnError.</p>\n<p>For that reason, I believe Medium Severity to be more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-24-rewards-distribution-can-be-disrupted-by-a-early-user\" style=\"position:relative;\"><a href=\"#m-24-rewards-distribution-can-be-disrupted-by-a-early-user\" aria-label=\"m 24 rewards distribution can be disrupted by a early user permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/193\">[M-24] Rewards distribution can be disrupted by a early user</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/02d286253cd5570d4e595527618366f77627cdaf/contracts/ConvexStakingWrapper.sol#L184-L188\">ConvexStakingWrapper.sol#L184-L188</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_supply</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">d_reward</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">integral</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">integral</span><span class=\"mtk1\"> +</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">((</span><span class=\"mtk12\">d_reward</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e20</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">_supply</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><code>reward.integral</code> is <code>uint128</code>, if an early user deposits with just <code>1</code> Wei of <code>lpToken</code>, and make <code>_supply == 1</code>, and then transferring <code>5e18</code> of <code>reward_token</code> to the contract.</p>\n<p>As a result, <code>reward.integral</code> can exceed <code>type(uint128).max</code> and overflow, causing the rewards distribution to be disrupted.</p>\n<h3 id=\"recommended-mitigation-steps-33\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-33\" aria-label=\"recommended mitigation steps 33 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider <code>wrap</code> a certain amount of initial totalSupply at deployment, e.g. <code>1e8</code>, and never burn it. And consider using uint256 instead of uint128 for <code>reward.integral</code>. Also, consider lower <code>1e20</code> down to <code>1e12</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/193\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/193#issuecomment-1102684394\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown a way to break the uint128 accounting system in place.</p>\n<p>This is contingent on frontrunning the pool and depositing a small amount to cause the division to fail.<br>\nAdditionally, this will cause a DOS that prevents other people from depositing.</p>\n<p>I believe that this could be unstuck by continuously (via loop) depositing 1 wei as to slowly increase the totalSupply again.</p>\n<p>Mitigation can be attained by either refactoring or by ensuring that the first deposit is big enough (18 decimals) to keep numbers to rational values.</p>\n<p>Because the finding is contingent on a setup and because tokens will be rescuable, I believe Medium Severity to be more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-25-convexstakingwrapperdeposit-depositors-may-lose-their-funds-when-the-_amount-is-huge\" style=\"position:relative;\"><a href=\"#m-25-convexstakingwrapperdeposit-depositors-may-lose-their-funds-when-the-_amount-is-huge\" aria-label=\"m 25 convexstakingwrapperdeposit depositors may lose their funds when the _amount is huge permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/194\">[M-25] <code>ConvexStakingWrapper#deposit()</code> depositors may lose their funds when the <code>_amount</code> is huge</a></h2>\n<p><em>Submitted by WatchPug, also found by danb, gzeon, Heartless, and pauliax</em></p>\n<p>When the value of <code>_amount</code> is larger than <code>type(uint192).max</code>, due to unsafe type casting, the recorded deposited amount can be much smaller than their invested amount.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L228-L250\">ConvexStakingWrapper.sol#L228-L250</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">whenNotPaused</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_checkpoint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">deposits</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">].</span><span class=\"mtk12\">epoch</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">currentEpoch</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">deposits</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">].</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">uint192</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lpToken</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">IRewardStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">convexPool</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">poolInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">).</span><span class=\"mtk12\">lptoken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">lpToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">lpToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">convexBooster</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IConvexDeposits</span><span class=\"mtk1\">(</span><span class=\"mtk12\">convexBooster</span><span class=\"mtk1\">).</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">lpToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">convexBooster</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pid</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">masterChef</span><span class=\"mtk1\">.</span><span class=\"mtk11\">pid</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lpToken</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">masterChef</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Deposited</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-23\" style=\"position:relative;\"><a href=\"#proof-of-concept-23\" aria-label=\"proof of concept 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When <code>_amount</code> = <code>uint256(type(uint192).max) + 1</code>:</p>\n<ul>\n<li>At L235, <code>uint192(_amount)</code> = <code>0</code>, <code>deposits[_pid][msg.sender].amount</code> = <code>0</code>;</li>\n<li>At L241, <code>uint256(type(uint192).max) + 1</code> will be transferFrom <code>msg.sender</code>.</li>\n</ul>\n<p>Expected results:</p>\n<p><code>deposits[_pid][msg.sender].amount</code> == <code>uint256(type(uint192).max) + 1</code>;</p>\n<p>Actual results:</p>\n<p><code>deposits[_pid][msg.sender].amount</code> = <code>0</code>.</p>\n<p>The depositor loses all their invested funds.</p>\n<h3 id=\"recommended-mitigation-steps-34\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-34\" aria-label=\"recommended mitigation steps 34 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding a upper limit for the <code>_amount</code> parameter:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint192</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;...&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/194\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/194#issuecomment-1102717086\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how casting without safe checks can cause the accounting to break and cause end users to lose deposited tokens.</p>\n<p>While the finding has merit, I believe that because this applies to niche situations, and is conditional on specific inputs, that Medium Severity is more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-26-stakingrewardssetrewardsduration-allows-setting-near-zero-or-enormous-rewardsduration-which-breaks-reward-logic\" style=\"position:relative;\"><a href=\"#m-26-stakingrewardssetrewardsduration-allows-setting-near-zero-or-enormous-rewardsduration-which-breaks-reward-logic\" aria-label=\"m 26 stakingrewardssetrewardsduration allows setting near zero or enormous rewardsduration which breaks reward logic permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/223\">[M-26] <code>StakingRewards.setRewardsDuration</code> allows setting near zero or enormous <code>rewardsDuration</code>, which breaks reward logic</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p>notifyRewardAmount will be inoperable if rewardsDuration is set to zero. If will cease to produce meaningful results if rewardsDuration is too small or too big.</p>\n<h3 id=\"proof-of-concept-24\" style=\"position:relative;\"><a href=\"#proof-of-concept-24\" aria-label=\"proof of concept 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The setter does not control the value, allowing zero/near zero/enormous duration:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/StakingRewards.sol#L178-185\">StakingRewards.sol#L178-185</a></p>\n<p>Division by the duration is used in notifyRewardAmount:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/StakingRewards.sol#L143-156\">StakingRewards.sol#L143-156</a></p>\n<h3 id=\"recommended-mitigation-steps-35\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-35\" aria-label=\"recommended mitigation steps 35 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Check for min and max range in the rewardsDuration setter, as too small or too big rewardsDuration breaks the logic.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/223\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/223#issuecomment-1102777977\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Finding is valid. Ultimately contingent on admin privilege so I believe Medium Severity to be appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-27-masterchefsol-a-depositor-can-deposit-an-arbitrary-amount-without-no-cost\" style=\"position:relative;\"><a href=\"#m-27-masterchefsol-a-depositor-can-deposit-an-arbitrary-amount-without-no-cost\" aria-label=\"m 27 masterchefsol a depositor can deposit an arbitrary amount without no cost permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/208\">[M-27] <code>MasterChef.sol</code> A <code>depositor</code> can deposit an arbitrary amount without no cost</a></h2>\n<p><em>Submitted by WatchPug, also found by cmichel</em></p>\n<p>The owner of <code>MasterChef.sol</code> can add a <code>depositor</code> with <code>addDepositor()</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L78-L80\">MasterChef.sol#L78-L80</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addDepositor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_depositor</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">isDepositor</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_depositor</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>A <code>depositor</code> can deposit with an arbitrary amount, without any cost.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L157-L180\">MasterChef.sol#L157-L180</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyDepositor</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">PoolInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pool</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">poolInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">UserInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">userInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">][</span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">()];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">updatePool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pending</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">accConcurPerShare</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">_concurShareMultiplier</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewardDebt</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pending</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">safeConcurTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pending</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositFeeBP</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositFeeBP</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_perMille</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">depositFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }     </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewardDebt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">accConcurPerShare</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">_concurShareMultiplier</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This allows a malicious/compromised depositor to take the majority share (nearly 100%) of all pools simply by calling <code>deposit()</code> with extremely large amounts, and take all the rewards.</p>\n<h3 id=\"recommended-mitigation-steps-36\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-36\" aria-label=\"recommended mitigation steps 36 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>See the <code>Recommendation</code> section on <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/200\">issue #200</a> and remove the <code>depositor</code> role.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/208#issuecomment-1041878778\">ryuheimat (Concur) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>This function will be called by whitelisted depositor contract and the actual token transfer will be done there.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/208#issuecomment-1102815322\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Because the’re a mapping that allows any contract to be set as depositor, I believe the warden has shown a potential admin privilege that can cause issues with the fair distribution of rewards.</p>\n<p>Because this is contingent on a malicious admin, I believe Medium Severity to be more appropriate.</p>\n<p>Mitigation would be as simple as having one depositor, alternative a more complicated architecture may need to be used.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-28-during-stake-or-deposit-users-would-not-be-rewarded-the-correct-concur-token-when-masterchef-has-under-supply-of-it\" style=\"position:relative;\"><a href=\"#m-28-during-stake-or-deposit-users-would-not-be-rewarded-the-correct-concur-token-when-masterchef-has-under-supply-of-it\" aria-label=\"m 28 during stake or deposit users would not be rewarded the correct concur token when masterchef has under supply of it permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/262\">[M-28] During stake or deposit, users would not be rewarded the correct Concur token, when MasterChef has under-supply of it</a></h2>\n<p><em>Submitted by hubble, also found by CertoraInc and Czar102</em></p>\n<p>During stake or deposit, users would not be transferred the correct Concur token, when MasterChef has under-supply of it.</p>\n<p>There is an assumption that MasterChef contract would own enough Concur tokens so as to distribute to users as reward, during deposit or withdraw. But say, due to excess user activity, MasterChef runs out of Concur tokens. All deposits &#x26; withdraws that happen after that, would have zero transfer of Concur token to the user. This will continue until the MasterChef contract is replenished again.</p>\n<h3 id=\"proof-of-concept-25\" style=\"position:relative;\"><a href=\"#proof-of-concept-25\" aria-label=\"proof of concept 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L205-L206\">MasterChef.sol#L205-L206</a><br></p>\n<p>Makeshift unit test\nNote: Temporarily modify the private function MasterChef.safeConcurTransfer to public function, for unit test validation</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"bash\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">//Unit Test starts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  it(</span><span class=\"mtk8\">&quot;MasterChef - Zero Concur balance&quot;</span><span class=\"mtk1\">, async </span><span class=\"mtk11\">function</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    await concurToken.mint(masterChef.address, 100);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    console.log(await concurToken.balanceOf(masterChef.address), await concurToken.balanceOf(user1.address));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    await masterChef.safeConcurTransfer(user1.address, 60); // user1 is rewarded correctly.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    console.log(await concurToken.balanceOf(masterChef.address), await concurToken.balanceOf(user1.address));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    await masterChef.safeConcurTransfer(user1.address, 60); // user1 is rewarded lesser by 10.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    console.log(await concurToken.balanceOf(masterChef.address), await concurToken.balanceOf(user1.address));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    await masterChef.safeConcurTransfer(user1.address, 60); // user1 is totally not rewarded.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    console.log(await concurToken.balanceOf(masterChef.address), await concurToken.balanceOf(user1.address));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">//Unit Test ends</span></span></span></code></pre>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual review, &#x26; makeshift Unit test</p>\n<h3 id=\"recommended-mitigation-steps-37\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-37\" aria-label=\"recommended mitigation steps 37 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Minimal recommended fix:</p>\n<p>To <code>MasterChef.safeConcurTransfer</code> function, add the following require statement. This will at least ensure that, when there is zero balance in MasterChef contract, the safeConcurTransfer function will not succeed.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"bash\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">safeConcurTransfer(address</span><span class=\"mtk1\"> _to, uint _amount) private {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint concurBalance = concur.balanceOf(address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        require(concurBalance&gt;0, </span><span class=\"mtk8\">&quot;safeConcurTransfer: balance is zero.&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/262\">leekt (Concur) acknowledged</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/262#issuecomment-1088033822\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The finding is valid as in that depositors could not receive token incentives, am not fully convinced this should be of medium severity as ultimately the contract will eventually run out of tokens and as such this is a situation that has to be handled.</p>\n<p>If anything, reverting may cause the tokens to be stuck.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/262#issuecomment-1103027832\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>While I feel like this is a situational finding, it ultimately is a loss of yield finding with a very clear example.<br>\nFor that reason I believe Medium Severity to be appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-29-convexstakingwrapper-deposits-and-withdraws-will-frequently-be-disabled-if-a-token-that-doesnt-allow-zero-value-transfers-will-be-added-as-a-reward-one\" style=\"position:relative;\"><a href=\"#m-29-convexstakingwrapper-deposits-and-withdraws-will-frequently-be-disabled-if-a-token-that-doesnt-allow-zero-value-transfers-will-be-added-as-a-reward-one\" aria-label=\"m 29 convexstakingwrapper deposits and withdraws will frequently be disabled if a token that doesnt allow zero value transfers will be added as a reward one permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/231\">[M-29] <code>ConvexStakingWrapper</code> deposits and withdraws will frequently be disabled if a token that doesn’t allow zero value transfers will be added as a reward one</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p>If deposits and withdraws are done frequently enough, the reward update operation they invoke will deal mostly with the case when there is nothing to add yet, i.e. <code>reward.remaining</code> match the reward token balance.</p>\n<p>If reward token doesn’t allow for zero value transfers, the reward update function will fail on an empty incremental reward transfer, which is now done unconditionally, reverting the caller deposit/withdrawal functionality</p>\n<h3 id=\"proof-of-concept-26\" style=\"position:relative;\"><a href=\"#proof-of-concept-26\" aria-label=\"proof of concept 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When ConvexStakingWrapper isn’t paused, every deposit and withdraw update current rewards via <code>_checkpoint</code> function before proceeding:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/ConvexStakingWrapper.sol#L233\">ConvexStakingWrapper.sol#L233</a><br></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/ConvexStakingWrapper.sol#L260\">ConvexStakingWrapper.sol#L260</a><br></p>\n<p><code>_checkpoint</code> calls <code>_calcRewardIntegral</code> for each of the reward tokens of the pid:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/ConvexStakingWrapper.sol#L220\">ConvexStakingWrapper.sol#L220</a><br></p>\n<p><code>_calcRewardIntegral</code> updates the incremental reward for the token, running the logic even if reward is zero, which is frequently the case:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/ConvexStakingWrapper.sol#L182\">ConvexStakingWrapper.sol#L182</a><br></p>\n<p>If the reward token doesn’t allow zero value transfers, this transfer will fail, reverting the corresponding deposit or withdraw.</p>\n<h3 id=\"recommended-mitigation-steps-38\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-38\" aria-label=\"recommended mitigation steps 38 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider checking the reward before doing transfer (and the related computations as an efficiency measure):</p>\n<p>Now:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">IERC20(reward.token).transfer(address(claimContract), d_reward);</span></span></code></pre>\n<p>To be:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (d_reward &gt; 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tIERC20(reward.token).transfer(address(claimContract), d_reward);</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/231\">ryuheimat (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/231#issuecomment-1103083291\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, due to a pattern that always transfers the reward token to the claim contract, in the case of a 0 transfer, certain transfers could fail, causing reverts.</p>\n<p>While there can be an argument that this finding may not happen in reality, I believe that ultimately the system has been shown to be flawed in it’s conception, perhaps adding a storage variable for the amount to claim would be more appropriate instead of dripping the rewards each time.</p>\n<p>For that reason, and because the finding is contingent on a reward token that does revert on 0 transfer, I believe Medium Severity to be appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-30-stakingrewards-reward-rate-can-be-dragged-out-and-diluted\" style=\"position:relative;\"><a href=\"#m-30-stakingrewards-reward-rate-can-be-dragged-out-and-diluted\" aria-label=\"m 30 stakingrewards reward rate can be dragged out and diluted permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/183\">[M-30] <code>StakingRewards</code> reward rate can be dragged out and diluted</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L161\">StakingRewards.sol#L161</a><br></p>\n<p>The <code>StakingRewards.notifyRewardAmount</code> function receives a <code>reward</code> amount and extends the current reward end time to <code>now + rewardsDuration</code>.<br>\nIt rebases the currently remaining rewards + the new rewards (<code>reward + leftover</code>) over this new <code>rewardsDuration</code> period.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">activated</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">] != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">activated</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">GRACE_PERIOD</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;shelter not activated&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit uses `msg.sender`&#39;s share but sets `claimed` for _to! can claim for many `_to`s</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">savedTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">] * </span><span class=\"mtk12\">client</span><span class=\"mtk1\">.</span><span class=\"mtk11\">shareOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">client</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalShare</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">claimed</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ExitShelter</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This can lead to a dilution of the reward rate and rewards being dragged out forever by malicious new reward deposits.</p>\n<h3 id=\"proof-of-concept-27\" style=\"position:relative;\"><a href=\"#proof-of-concept-27\" aria-label=\"proof of concept 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Imagine the current rewardRate is <code>1000 rewards / rewardsDuration</code>.<br>\n20% of the <code>rewardsDuration</code> passed, i.e., <code>now = lastUpdateTime + 20% * rewardsDuration</code>.<br>\nA malicious actor notifies the contract with a reward of <code>0</code>: <code>notifyRewardAmount(0)</code>.<br>\nThen the new <code>rewardRate = (reward + leftover) / rewardsDuration = (0 + 800) / rewardsDuration = 800 / rewardsDuration</code>.<br>\nThe <code>rewardRate</code> just dropped by 20%.<br>\nThis can be repeated infinitely.<br>\nAfter another 20% of reward time passed, they trigger <code>notifyRewardAmount(0)</code> to reduce it by another 20% again:<br>\n<code>rewardRate = (0 + 640) / rewardsDuration = 640 / rewardsDuration</code>.</p>\n<h3 id=\"recommended-mitigation-steps-39\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-39\" aria-label=\"recommended mitigation steps 39 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Imo, the <code>rewardRate</code> should never decrease by a <code>notifyRewardAmount</code> call.<br>\nConsider not extending the reward payouts by <code>rewardsDuration</code> on every call.<br>\n<code>periodFinish</code> probably shouldn’t change at all, the <code>rewardRate</code> should just increase by <code>rewardRate += reward / (periodFinish - block.timestamp)</code>.</p>\n<p>Alternatively, consider keeping the <code>rewardRate</code> constant but extend <code>periodFinish</code> time by <code>+= reward / rewardRate</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/183#issuecomment-1043693880\">ryuheimat (Concur) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>notifyRewardAmount check msg.sender’s permission.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/183#issuecomment-1103139704\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden is pointing out an admin privilege that would allow the admin to dilute current rewards.</p>\n<p>While the sponsor claims this won’t happen, I can only judge based on the code that is available to me.<br>\nAnd at this point there seems to be no code for the <code>rewardsDistribution</code> contract that would be calling <code>notifyRewardAmount</code></p>\n<p>Given this, I believe the finding to be valid as the POC works out to demonstrate how a malicious owner could dilute the rewardRate.</p>\n<p>This would cause loss of yield for all depositors, which makes the finding of Medium Severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-31-execute-in-voteproxy-should-be-payable\" style=\"position:relative;\"><a href=\"#m-31-execute-in-voteproxy-should-be-payable\" aria-label=\"m 31 execute in voteproxy should be payable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/17\">[M-31] execute in VoteProxy should be payable</a></h2>\n<p><em>Submitted by wuwe1</em></p>\n<p><code>execute</code> will revert when <code>msg.value > 0</code></p>\n<h3 id=\"proof-of-concept-28\" style=\"position:relative;\"><a href=\"#proof-of-concept-28\" aria-label=\"proof of concept 28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Lacking <code>payable</code> mutability specifier.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/VoteProxy.sol#L28-L35\">VoteProxy.sol#L28-L35</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">execute</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">result</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">_data</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">result</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-40\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-40\" aria-label=\"recommended mitigation steps 40 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add <code>payable</code> mutability specifier.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/17\">leekt (Concur) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/17#issuecomment-1095728527\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@leekt Can you tell me what you’d need <a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/VoteProxy.sol#L28\"><code>execute</code></a> to be used for?</p>\n<p>Do you really need it to be payable?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/17#issuecomment-1103158805\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>After some thinking, I do believe that it would be wise to allow for payable calls.</p>\n<p>Will mark as valid and because this is contingent on a specific usage, I think Medium Severity to be appropriate.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 36 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/128\">report highlighted below</a> by <strong>hickuphh3</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/36\">wuwe1</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/254\">pauliax</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/171\">kenta</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/161\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/217\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/227\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/197\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/26\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/80\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/215\">SolidityScan</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/163\">CertoraInc</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/13\">samruna</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/62\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/198\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/263\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/230\">Randyyy</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/66\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/45\">robee</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/241\">Czar102</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/65\">BouSalman</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/85\">ShadowyNoobDev</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/174\">throttle</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/220\">ye0lde</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/186\">Sleepy</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/63\">cryptphi</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/145\">harleythedog</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/19\">kirk-baird</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/98\">leastwood</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/201\">peritoflores</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/248\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/261\">Rhynorater</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/153\">bitbopper</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/253\">mtz</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/127\">0xw4rd3n</a>, and <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/202\">hubble</a>.</em></p>\n<h2 id=\"codebase-impressions--summary\" style=\"position:relative;\"><a href=\"#codebase-impressions--summary\" aria-label=\"codebase impressions  summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Codebase Impressions &#x26; Summary</h2>\n<p>Overall, code quality was fair. A number of contracts were taken from various sources, such as StakingRewards, Masterchef and the ConvexStakingWrapper. Modifications were made to include custom features like taking a 20% fee on CVX and CRV rewards for the treasury, and to not require stake token transfers for deposits / withdrawals into the Masterchef contract.</p>\n<p>I found <code>10</code> high severity issues, majority of which are found in the Masterchef contract. They were simple logic bugs that would have been discovered with unit tests.</p>\n<p>In addition, I made <code>2</code> medium severity, <code>7</code> low severity, and <code>1</code> non-critical findings.</p>\n<p>Note that during the contest, an example shelter client was added and pushed to a <a href=\"https://github.com/code-423n4/2022-02-concur/tree/shelter-client/contracts\">new branch</a> for wardens to understand how the shelter would operate. The integration of the ConvexStakingWrapper with the Shelter in that branch has a few bugs, but I assume it is outside the current contest scope to report them.</p>\n<p>Due to the number of issues raised, I strongly recommend the team to write unit tests for their contracts, and to consider running a mitigation contest.</p>\n<h2 id=\"l-01-masterchef-pendingconcur-shows-increasing-reward-amounts-after-mining-period-ends\" style=\"position:relative;\"><a href=\"#l-01-masterchef-pendingconcur-shows-increasing-reward-amounts-after-mining-period-ends\" aria-label=\"l 01 masterchef pendingconcur shows increasing reward amounts after mining period ends permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01]: Masterchef: pendingConcur() shows increasing reward amounts after mining period ends</h2>\n<h3 id=\"line-references\" style=\"position:relative;\"><a href=\"#line-references\" aria-label=\"line references permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L113-L124\">MasterChef.sol#L113-L124</a></p>\n<h3 id=\"description\" style=\"position:relative;\"><a href=\"#description\" aria-label=\"description permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>Even though rewards distribution cease after <code>endBlock</code>, <code>pendingConcur()</code> will calculate as if reward distribution has not.</p>\n<p>Distribution of rewards will cease after <code>endBlock</code>, but <code>pendingConcur()</code> will show increasing pending rewards because it does not account for <code>endBlock</code>.</p>\n<h3 id=\"recommended-mitigation-steps-41\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-41\" aria-label=\"recommended mitigation steps 41 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pendingConcur</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_user</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">// take the minimum of endBlock and currentBlock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">endRewardBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">endRewardBlock</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastRewardBlock</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">lpSupply</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getMultiplier</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastRewardBlock</span><span class=\"mtk1\">, </span><span class=\"mtk12\">endRewardBlock</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 id=\"l-02-masterchef-safeconcurtransfer-potentially-reverts-for-zero-amount\" style=\"position:relative;\"><a href=\"#l-02-masterchef-safeconcurtransfer-potentially-reverts-for-zero-amount\" aria-label=\"l 02 masterchef safeconcurtransfer potentially reverts for zero amount permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02]: Masterchef: <code>safeConcurTransfer()</code> potentially reverts for zero amount</h2>\n<h3 id=\"line-references-1\" style=\"position:relative;\"><a href=\"#line-references-1\" aria-label=\"line references 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L205-L210\">MasterChef.sol#L205-L210</a></p>\n<h3 id=\"description-1\" style=\"position:relative;\"><a href=\"#description-1\" aria-label=\"description 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>If the contract has zero concur tokens, the following may revert because of zero amount. This is of course dependent on the concur token implementation.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// couple of lines omitted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">transferSuccess</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">concur</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">concurBalance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">transferSuccess</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;safeConcurTransfer: transfer failed&quot;</span><span class=\"mtk1\">); </span></span></span></code></pre>\n<h2 id=\"l-03-convexstakingwrapper-small-rounding-error-in-_calcrewardintegral\" style=\"position:relative;\"><a href=\"#l-03-convexstakingwrapper-small-rounding-error-in-_calcrewardintegral\" aria-label=\"l 03 convexstakingwrapper small rounding error in _calcrewardintegral permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03]: ConvexStakingWrapper: Small rounding error in <code>_calcRewardIntegral()</code></h2>\n<h3 id=\"line-references-2\" style=\"position:relative;\"><a href=\"#line-references-2\" aria-label=\"line references 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/ConvexStakingWrapper.sol#L179-L180\">ConvexStakingWrapper.sol#L179-L180</a></p>\n<h3 id=\"description-2\" style=\"position:relative;\"><a href=\"#description-2\" aria-label=\"description 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>The treasury takes a 20% fee of rewards. The calculation will possibly leave 1 wei unaccounted for.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">treasury</span><span class=\"mtk1\">, </span><span class=\"mtk12\">d_reward</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">5</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">d_reward</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">d_reward</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">4</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">5</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>For instance, assume <code>d_reward = 21</code>. The treasury receives <code>4</code> wei while the user receives <code>16</code> wei, leaving 1 wei unaccounted for.</p>\n<h3 id=\"recommended-mitigation-steps-42\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-42\" aria-label=\"recommended mitigation steps 42 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">d_reward</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">5</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">treasury</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rewardFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">d_reward</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">rewardFee</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"l-04-usdmpegrecovery-40m-or-4m-threshold\" style=\"position:relative;\"><a href=\"#l-04-usdmpegrecovery-40m-or-4m-threshold\" aria-label=\"l 04 usdmpegrecovery 40m or 4m threshold permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04]: USDMPegRecovery: 40M or 4M threshold?</h2>\n<h3 id=\"line-references-3\" style=\"position:relative;\"><a href=\"#line-references-3\" aria-label=\"line references 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/USDMPegRecovery.sol#L100\">USDMPegRecovery.sol#L100</a></p>\n<h3 id=\"description-3\" style=\"position:relative;\"><a href=\"#description-3\" aria-label=\"description 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>The README says <em>“Once 40m USDM is deposited, 3Crv side of the contract starts accepting deposits.”</em> However, the code accepts 3CRV deposits after 4M USDM is deposited instead.</p>\n<h3 id=\"recommended-mitigation-steps-43\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-43\" aria-label=\"recommended mitigation steps 43 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Specify the threshold as an internal constant, and use underscores for readability. I also recommend double-checking the values of declared variables in all contracts, such as <code>step</code> and <code>concurPerBlock</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MIN_USDM_AMOUNT</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">40_000_000e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalLiquidity</span><span class=\"mtk1\">.</span><span class=\"mtk12\">usdm</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">MIN_USDM_AMOUNT</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;usdm low&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// or</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalLiquidity</span><span class=\"mtk1\">.</span><span class=\"mtk12\">usdm</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">40_000_000e18</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;usdm low&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"n-01-masterchef-incorrect-comment-on-endblock\" style=\"position:relative;\"><a href=\"#n-01-masterchef-incorrect-comment-on-endblock\" aria-label=\"n 01 masterchef incorrect comment on endblock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01]: Masterchef: Incorrect comment on endBlock</h2>\n<h3 id=\"line-references-4\" style=\"position:relative;\"><a href=\"#line-references-4\" aria-label=\"line references 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L52-L53\">MasterChef.sol#L52-L53</a></p>\n<h3 id=\"description-4\" style=\"position:relative;\"><a href=\"#description-4\" aria-label=\"description 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p><code>uint public endBlock; // The block number when mining starts.</code> is incorrect, as it should be the end of the mining period, not the start. Its comment applies to <code>startBlock</code>.</p>\n<p>Note that <code>uint public startBlock</code> does not have a comment. Consider adding it.</p>\n<h3 id=\"recommended-mitigation-steps-44\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-44\" aria-label=\"recommended mitigation steps 44 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// The block number when mining starts.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// The block number when mining ends.</span></span></span></code></pre>\n<h2 id=\"n-02-stakingrewards-incorrect-revert-statement-in-setrewardsdistribution\" style=\"position:relative;\"><a href=\"#n-02-stakingrewards-incorrect-revert-statement-in-setrewardsdistribution\" aria-label=\"n 02 stakingrewards incorrect revert statement in setrewardsdistribution permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02]: StakingRewards: Incorrect revert statement in <code>setRewardsDistribution()</code></h2>\n<h3 id=\"line-references-5\" style=\"position:relative;\"><a href=\"#line-references-5\" aria-label=\"line references 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/StakingRewards.sol#L191-L194\">StakingRewards.sol#L191-L194</a></p>\n<h3 id=\"description-5\" style=\"position:relative;\"><a href=\"#description-5\" aria-label=\"description 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p><code>setRewardsDistribution()</code> has the following check:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">periodFinish</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk8\">&quot;Previous rewards period must be complete before changing the duration for the new period&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The statement is incorrect because it’s <code>rewardsDistribution</code> that is being changed, not the rewards duration.</p>\n<h3 id=\"recommended-mitigation-steps-45\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-45\" aria-label=\"recommended mitigation steps 45 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Actually, the check is redundant, because there is no harm changing <code>rewardsDistribution</code> while distribution is ongoing. I suggest removing the check entirely. Otherwise, change the comment to </p>\n<p><code>\"Previous rewards period must be complete before changing rewardsDistribution\"</code></p>\n<h2 id=\"n-03-masterchef-radss--concurs\" style=\"position:relative;\"><a href=\"#n-03-masterchef-radss--concurs\" aria-label=\"n 03 masterchef radss  concurs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03]: Masterchef: RADSs → Concurs</h2>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L25\">MasterChef.sol#L25</a></p>\n<p>Rename <code>RADSs</code> to <code>Concurs</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/128#issuecomment-1110223177\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>[L-01]: Masterchef: pendingConcur() shows increasing reward amounts after mining period ends<br>\nValid finding</p>\n<p>[L-02]: Masterchef: safeConcurTransfer() potentially reverts for zero amount<br>\nI don’t believe it will cause issues, but think 0 check is low per industry standard.</p>\n<p>[L-03]: ConvexStakingWrapper: Small rounding error in _calcRewardIntegral()<br>\nAfter further consideration, I agree.</p>\n<p>[L-04]: USDMPegRecovery: 40M or 4M threshold?<br>\nI feel like this is the only case where I’d give low vs non-critical as the comment and the code have a meaningful, and significant difference for the end users.</p>\n<p>[N-01]: Masterchef: Incorrect comment on endBlock<br>\nNon-critical IMO</p>\n<p>[N-02]: StakingRewards: Incorrect revert statement in setRewardsDistribution()<br>\nDisagree with [low] severity.</p>\n<p>[N-03]: Masterchef: RADSs → Concurs<br>\nValid finding.</p>\n</blockquote>\n<p>Report has plenty of content, formatting is good, I think most findings are over-emphasized though and under further scrutiny this is basically equivalent to 4 findings.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/128#issuecomment-1110224140\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Adding <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/137\">#137</a> does make the report more well rounded and adding <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/136\">#136</a> makes this the most interesting report thus far, 6.5 findings at this time</p>\n<p>6++ with very good formatting</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/128#issuecomment-1112664899\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>[L-01]: Masterchef: pendingConcur() shows increasing reward amounts after mining period ends<br>\nLow</p>\n<p>[L-02]: Masterchef: safeConcurTransfer() potentially reverts for zero amount<br>\nLow</p>\n<p>[L-03]: ConvexStakingWrapper: Small rounding error in _calcRewardIntegral()<br>\nLow</p>\n<p>[L-04]: USDMPegRecovery: 40M or 4M threshold?<br>\nLow</p>\n<p>[N-01]: Masterchef: Incorrect comment on endBlock<br>\nNon-Critical</p>\n<p>[N-02]: StakingRewards: Incorrect revert statement in setRewardsDistribution()<br>\nNon Critical</p>\n<p>[N-03]: Masterchef: RADSs → Concurs<br>\nNon-Critical</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/137\">#137</a> -> Non-Critical</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/136\">#136</a> -> Low Severity</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 33 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/216\">report highlighted below</a> by <strong>WatchPug</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/167\">throttle</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/24\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/203\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/256\">pauliax</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/73\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/110\">Jujic</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/25\">BouSalman</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/211\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/67\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/129\">hickuphh3</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/247\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/44\">robee</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/185\">0xngndev</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/169\">kenta</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/91\">ye0lde</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/192\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/154\">bitbopper</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/218\">SolidityScan</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/37\">wuwe1</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/258\">0x0x0x</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/265\">0xNot0rious</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/245\">Tomio</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/40\">0x510c</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/2\">Heartless</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/255\">mtz</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/233\">Randyyy</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/168\">Sleepy</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/259\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/41\">sabtikw</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/84\">ShadowyNoobDev</a>, <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/228\">peritoflores</a>, and <a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/164\">CertoraInc</a>.</em></p>\n<h2 id=\"g-01-cache-external-call-result-in-the-stack-can-save-gas\" style=\"position:relative;\"><a href=\"#g-01-cache-external-call-result-in-the-stack-can-save-gas\" aria-label=\"g 01 cache external call result in the stack can save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Cache external call result in the stack can save gas</h2>\n<p><em>Note: Suggested optimation, save a decent amount of gas without compromising readability.</em></p>\n<p>Every call to an external contract costs a decent amount of gas. For optimization of gas usage, external call results should be cached if they are being used for more than one time.</p>\n<p>For example:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L93-L140\">ConvexStakingWrapper.sol#L93-L140</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mainPool</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IRewardStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">convexBooster</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .</span><span class=\"mtk11\">poolInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .</span><span class=\"mtk12\">crvRewards</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pids</span><span class=\"mtk1\">[</span><span class=\"mtk11\">IRewardStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">convexBooster</span><span class=\"mtk1\">).</span><span class=\"mtk11\">poolInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">).</span><span class=\"mtk12\">lptoken</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><code>IRewardStaking(convexBooster).poolInfo(_pid)</code> can be cached to avoid an extra external call.</p>\n<h2 id=\"g-02-cache-external-call-result-in-storage-can-save-gas\" style=\"position:relative;\"><a href=\"#g-02-cache-external-call-result-in-storage-can-save-gas\" aria-label=\"g 02 cache external call result in storage can save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Cache external call result in storage can save gas</h2>\n<p><em>Note: Suggested optimation, save a decent amount of gas without compromising readability.</em></p>\n<p>For the unchanged results of an external call that will be reused multiple times, cache and read from storage rather than initiate a fresh external call can save gas.</p>\n<p>Instances include:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L237-L239\">ConvexStakingWrapper.sol#L237-L239</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lpToken</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IRewardStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">convexPool</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">poolInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">).</span><span class=\"mtk12\">lptoken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L264-L266\">ConvexStakingWrapper.sol#L264-L266</a>>br</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lpToken</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IRewardStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">convexPool</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">poolInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">).</span><span class=\"mtk12\">lptoken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><code>lpToken</code> of <code>_pid</code> can be cached when <code>addRewards()</code> to avoid extra external calls.</p>\n<h2 id=\"g-03-safemath-is-no-longer-needed\" style=\"position:relative;\"><a href=\"#g-03-safemath-is-no-longer-needed\" aria-label=\"g 03 safemath is no longer needed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] `SafeMath is no longer needed</h2>\n<p><em>Note: Suggested optimation, save a decent amount of gas without compromising readability.</em></p>\n<p><code>SafeMath</code> is no longer needed starting with Solidity 0.8. The compiler now has built in overflow checking.</p>\n<p>Removing <code>SafeMath</code> can save some gas.</p>\n<p>Instances include:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L89-L89\">MasterChef.sol#L89-L89</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">totalAllocPoint</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalAllocPoint</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_allocationPoints</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L109-L109\">MasterChef.sol#L109-L109</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sub</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L120-L121\">MasterChef.sol#L120-L121</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">concurReward</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">concurPerBlock</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">allocPoint</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalAllocPoint</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">accConcurPerShare</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">accConcurPerShare</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">concurReward</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_concurShareMultiplier</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lpSupply</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<h2 id=\"g-04-change-unnecessary-storage-variables-to-constants-can-save-gas\" style=\"position:relative;\"><a href=\"#g-04-change-unnecessary-storage-variables-to-constants-can-save-gas\" aria-label=\"g 04 change unnecessary storage variables to constants can save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Change unnecessary storage variables to constants can save gas</h2>\n<p><em>Note: Suggested optimation, save a decent amount of gas without compromising readability.</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L56-L57\">MasterChef.sol#L56-L57</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_concurShareMultiplier</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_perMille</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 100%</span></span></span></code></pre>\n<p>Some storage variables include <code>_concurShareMultiplier</code>, <code>_perMille</code> will never be changed and they should not be.</p>\n<p>Changing them to <code>constant</code> can save gas.</p>\n<h2 id=\"g-05-setting-bool-variables-to-false-is-redundant\" style=\"position:relative;\"><a href=\"#g-05-setting-bool-variables-to-false-is-redundant\" aria-label=\"g 05 setting bool variables to false is redundant permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Setting <code>bool</code> variables to <code>false</code> is redundant</h2>\n<p><em>Note: Minor optimation, the amount of gas saved is minor, change when you see fit.</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L204-L204\">MasterChef.sol#L204-L204</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transferSuccess</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Setting <code>bool</code> variables to <code>false</code> is redundant as they default to <code>false</code>.</p>\n<p>See <a href=\"https://docs.soliditylang.org/en/v0.8.11/control-structures.html#default-value\">https://docs.soliditylang.org/en/v0.8.11/control-structures.html#default-value</a></p>\n<h2 id=\"g-06-using-immutable-variable-can-save-gas\" style=\"position:relative;\"><a href=\"#g-06-using-immutable-variable-can-save-gas\" aria-label=\"g 06 using immutable variable can save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Using immutable variable can save gas</h2>\n<p><em>Note: Suggested optimation, save a decent amount of gas without compromising readability.</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L52-L71\">MasterChef.sol#L52-L71</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// The block number when mining starts.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">concur</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_concurShareMultiplier</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_perMille</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 100%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_concur</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_startBlock</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_endBlock</span><span class=\"mtk1\">) </span><span class=\"mtk11\">Ownable</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">startBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_startBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">endBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_endBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">concur</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_concur</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Considering that <code>startBlock</code>, <code>endBlock</code> and <code>concur</code> will never change, changing them to immutable variables instead of storages variable can save gas.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L19-L20\">StakingRewards.sol#L19-L20</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardsToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L37-L47\">StakingRewards.sol#L37-L47</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rewardsDistribution</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rewardsToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_stakingToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">MasterChef</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_masterChef</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rewardsToken</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_rewardsToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_stakingToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rewardsDistribution</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_rewardsDistribution</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">masterChef</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_masterChef</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Considering that <code>rewardsToken</code> and <code>stakingToken</code> will never change, changing them to immutable variables instead of storages variable can save gas.</p>\n<h2 id=\"g-07-use-short-reason-strings-can-save-gas\" style=\"position:relative;\"><a href=\"#g-07-use-short-reason-strings-can-save-gas\" aria-label=\"g 07 use short reason strings can save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] Use short reason strings can save gas</h2>\n<p><em>Note: Minor optimation, the amount of gas saved is minor, change when you see fit.</em></p>\n<p>Every reason string takes at least 32 bytes.</p>\n<p>Use short reason strings that fits in 32 bytes or it will become more expensive.</p>\n<p>Instances include:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L179-L182\">StakingRewards.sol#L179-L182</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">periodFinish</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&quot;Previous rewards period must be complete before changing the duration for the new period&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L191-L194\">StakingRewards.sol#L191-L194</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">periodFinish</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&quot;Previous rewards period must be complete before changing the duration for the new period&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L137-L140\">StakingRewards.sol#L137-L140</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">rewardsDistribution</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&quot;Caller is not RewardsDistribution contract&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L170-L173\">StakingRewards.sol#L170-L173</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&quot;Cannot withdraw the staking token&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L210-L210\">MasterChef.sol#L210-L210</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">transferSuccess</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;safeConcurTransfer: transfer failed&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"g-08-setting-uint256-variables-to-0-is-redundant\" style=\"position:relative;\"><a href=\"#g-08-setting-uint256-variables-to-0-is-redundant\" aria-label=\"g 08 setting uint256 variables to 0 is redundant permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] Setting <code>uint256</code> variables to <code>0</code> is redundant</h2>\n<p><em>Note: Minor optimation, the amount of gas saved is minor, change when you see fit.</em></p>\n<p>Setting <code>uint256</code> variables to <code>0</code> is redundant as they default to <code>0</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L21-L22\">StakingRewards.sol#L21-L22</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">periodFinish</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardRate</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-46\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-46\" aria-label=\"recommended mitigation steps 46 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change to <code>uint256 public periodFinish;</code> <code>uint256 public rewardRate;</code> can make the code simpler and save some gas.</p>\n<h2 id=\"g-09-adding-unchecked-directive-can-save-gas\" style=\"position:relative;\"><a href=\"#g-09-adding-unchecked-directive-can-save-gas\" aria-label=\"g 09 adding unchecked directive can save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] Adding unchecked directive can save gas</h2>\n<p><em>Note: Minor optimation, the amount of gas saved is minor, change when you see fit.</em></p>\n<p>For the arithmetic operations that will never over/underflow, using the unchecked directive (Solidity v0.8 has default overflow/underflow checks) can save some gas from the unnecessary internal over/underflow checks.</p>\n<p>For example:</p>\n<ol>\n<li><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L88-L101\">StakingRewards.sol#L88-L101</a></li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">stake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">whenNotPaused</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">updateReward</span><span class=\"mtk1\">(msg.sender)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Cannot stake 0&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pid</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">masterChef</span><span class=\"mtk1\">.</span><span class=\"mtk11\">pid</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">masterChef</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Staked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><code>_balances[msg.sender] += amount</code> will never overflow if <code>_totalSupply += amount;</code> does not revert.</p>\n<ol start=\"2\">\n<li><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L103-L115\">StakingRewards.sol#L103-L115</a></li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">updateReward</span><span class=\"mtk1\">(msg.sender)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Cannot withdraw 0&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pid</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">masterChef</span><span class=\"mtk1\">.</span><span class=\"mtk11\">pid</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">masterChef</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Withdrawn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><code>_totalSupply -= amount</code> will never underflow if <code>_balances[msg.sender] -= amount;</code> does not underflow revert.</p>\n<p>Therefore it can be changed to for gas saving:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"g-10--0-is-less-efficient-than--0-for-unsigned-integers\" style=\"position:relative;\"><a href=\"#g-10--0-is-less-efficient-than--0-for-unsigned-integers\" aria-label=\"g 10  0 is less efficient than  0 for unsigned integers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10] ”> 0” is less efficient than “!= 0” for unsigned integers</h2>\n<p><em>Note: Minor optimation, the amount of gas saved is minor, change when you see fit.</em></p>\n<p>It is cheaper to use <code>!= 0</code> than <code>> 0</code> for uint256.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L94-L94\">StakingRewards.sol#L94-L94</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Cannot stake 0&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L108-L108\">StakingRewards.sol#L108-L108</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Cannot withdraw 0&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L119-L119\">StakingRewards.sol#L119-L119</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"73\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">reward</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<h2 id=\"g-11-i-is-more-efficient-than-i\" style=\"position:relative;\"><a href=\"#g-11-i-is-more-efficient-than-i\" aria-label=\"g 11 i is more efficient than i permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-11] <code>++i</code> is more efficient than <code>i++</code></h2>\n<p><em>Note: Minor optimation, the amount of gas saved is minor, change when you see fit.</em></p>\n<p>Using <code>++i</code> is more gas efficient than <code>i++</code>, especially in a loop.</p>\n<p>For example:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L121-L121\">ConvexStakingWrapper.sol#L121-L121</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"74\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">extraCount</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L219-L219\">ConvexStakingWrapper.sol#L219-L219</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"75\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">rewardCount</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConcurRewardPool.sol#L35-L35\">ConcurRewardPool.sol#L35-L35</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"76\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_tokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<h2 id=\"g-12-reuse-existing-external-calls-cache-can-save-gas\" style=\"position:relative;\"><a href=\"#g-12-reuse-existing-external-calls-cache-can-save-gas\" aria-label=\"g 12 reuse existing external calls cache can save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-12] Reuse existing external call’s cache can save gas</h2>\n<p><em>Note: Suggested optimation, save a decent amount of gas without compromising readability.</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L120-L139\">ConvexStakingWrapper.sol#L120-L139</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"77\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">extraCount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IRewardStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mainPool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">extraRewardsLength</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">extraCount</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">extraPool</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IRewardStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mainPool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">extraRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">extraToken</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IRewardStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">extraPool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">rewardToken</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">extraToken</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">cvx</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//no-op for cvx, crv rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">CVX_INDEX</span><span class=\"mtk1\">].</span><span class=\"mtk12\">pool</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">extraPool</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">registeredRewards</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">extraToken</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//add new token to list</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">].</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">RewardType</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">token:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IRewardStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">extraPool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">rewardToken</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">pool:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">extraPool</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">integral:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">remaining:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">registeredRewards</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">extraToken</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//mark registered at index+1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><code>IRewardStaking(extraPool).rewardToken()</code> at L131 is already cached in the local variable <code>extraToken</code> at L123.</p>\n<p>Reusing the cached local variable in the stack instead of initiating an external call again can save gas.</p>\n<h2 id=\"g-13-unnecessary-checked-arithmetic-in-for-loops\" style=\"position:relative;\"><a href=\"#g-13-unnecessary-checked-arithmetic-in-for-loops\" aria-label=\"g 13 unnecessary checked arithmetic in for loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-13] Unnecessary checked arithmetic in for loops</h2>\n<p><em>Note: Non-preferred, the amount of gas saved is at cost of readability, only apply when gas saving is a top priority.</em></p>\n<p>There is no risk of overflow caused by increamenting the iteration index in for loops (the <code>i++</code> in for <code>for (uint256 i = 0; i &#x3C; rewardCount; i++)</code>).</p>\n<p>Increments perform overflow checks that are not necessary in this case.</p>\n<h3 id=\"recommended-mitigation-steps-47\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-47\" aria-label=\"recommended mitigation steps 47 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Surround the increment expressions with an <code>unchecked { ... }</code> block to avoid the default overflow checks. For example, change the for loop:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L219-L221\">ConvexStakingWrapper.sol#L219-L221</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"78\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">rewardCount</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_calcRewardIntegral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">i</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">depositedBalance</span><span class=\"mtk1\">, </span><span class=\"mtk12\">supply</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"79\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">rewardCount</span><span class=\"mtk1\">;) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_calcRewardIntegral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">i</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">depositedBalance</span><span class=\"mtk1\">, </span><span class=\"mtk12\">supply</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 id=\"g-14-cache-array-length-in-for-loops-can-save-gas\" style=\"position:relative;\"><a href=\"#g-14-cache-array-length-in-for-loops-can-save-gas\" aria-label=\"g 14 cache array length in for loops can save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-14] Cache array length in for loops can save gas</h2>\n<p><em>Note: Minor optimation, the amount of gas saved is minor, change when you see fit.</em></p>\n<p>Reading array length at each iteration of the loop takes 6 gas (3 for mload and 3 to place memory_offset) in the stack.</p>\n<p>Caching the array length in the stack saves around 3 gas per iteration.</p>\n<p>Instances include:</p>\n<ul>\n<li>\n<p><code>ConcurRewardPool.sol#claimRewards()</code></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConcurRewardPool.sol#L35-L39\">ConcurRewardPool.sol#L35-L39</a></p>\n</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-concur-findings/issues/216#issuecomment-1087619318\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p><strong>[G-01] Cache external call result in the stack can save gas</strong><br>\nWould save 100 gas for STATICALL + the cost of reading from Storage again, let’s say another 100, at the cost of 6 for MSTORE + MLOAD = 194 gas saved</p>\n<p><strong>[G-02] Cache external call result in storage can save gas</strong><br>\nWould save 91 gas (First call costs 6 more, second costs 97 less)</p>\n<p><strong>[G-03] `SafeMath is no longer needed</strong><br>\nIn contrast to other findings the warden has listed all instances that are unnecessary, for thus reason I will add the gas savings to this report<br>\n8 instances, 20 gas per instance = 160 gas saved</p>\n<p><strong>[G-04] Change unnecessary storage variables to constants can save gas</strong><br>\nBecause the warden didn’t list the other savings, I’ll give one COLD SLOAD per variable<br>\n2100 * 2 = 4200</p>\n<p><strong>[G-05] Setting bool variables to false is redundant</strong><br>\n3 gas</p>\n<p><strong>[G-06] Using immutable variable can save gas</strong><br>\nSimilar to S4<br>\n5 * 2100 = 10500</p>\n<p><strong>[G-07] Use short reason strings can save gas</strong><br>\n5 * 2500 per discussion on other reports <br>\n12500</p>\n<p><strong>[G-08] Setting uint256 variables to 0 is redundant</strong><br>\n200</p>\n<p><strong>[G-09] Adding unchecked directive can save gas</strong><br>\n2 * 20 = 40</p>\n<p><strong>[G-10] ”> 0” is less efficient than “!= 0” for unsigned integers</strong><br>\nOnly for require<br>\n2 * 6 = 12</p>\n<p><strong>[G-11] ++i is more efficient than i++</strong><br>\n3 * 3 = 9</p>\n<p><strong>[G-12] Reuse existing external call’s cache can save gas</strong><br>\n91 gas saved (97 -  6)</p>\n<p><strong>[G-13] Unnecessary checked arithmetic in for loops</strong><br>\n20 gas</p>\n<p><strong>[G-14] Cache array length in for loops can save gas</strong><br>\n3 gas</p>\n<p>Overall the report is short and sweet, the formatting is excellent and there’s a little more detail than in other reports.<br>\nWould have liked to see the storage to constant gas savings explicitly shown as that would have made the report as close to complete as it could have been.</p>\n<p>Total Gas Saved:<br>\n28023</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-11\">High Risk Findings (11)</a></p>\n<ul>\n<li><a href=\"#h-01-wrong-reward-token-calculation-in-masterchef-contract\">[H-01] Wrong reward token calculation in MasterChef contract</a></li>\n<li><a href=\"#h-02-masterchef-improper-handling-of-deposit-fee\">[H-02] Masterchef: Improper handling of deposit fee</a></li>\n<li><a href=\"#h-03-repeated-calls-to-shelterwithdraw-can-drain-all-funds-in-shelter\">[H-03] Repeated Calls to Shelter.withdraw Can Drain All Funds in Shelter</a></li>\n<li><a href=\"#h-04-convexstakingwrapper-stakingrewards-wrong-implementation-will-send-concur-rewards-to-the-wrong-receiver\">[H-04] <code>ConvexStakingWrapper</code>, <code>StakingRewards</code> Wrong implementation will send <code>concur</code> rewards to the wrong receiver</a></li>\n<li><a href=\"#h-05-usdmpegrecovery-risk-of-fund-locked-due-to-discrepancy-between-curvelp-token-value-against-internal-contract-math\">[H-05] <code>USDMPegRecovery</code> Risk of fund locked, due to discrepancy between curveLP token value against internal contract math</a></li>\n<li><a href=\"#h-06-convexstakingwrappersol_calcrewardintegral-wrong-implementation-can-disrupt-rewards-calculation-and-distribution\">[H-06] <code>ConvexStakingWrapper.sol#_calcRewardIntegral</code> Wrong implementation can disrupt rewards calculation and distribution</a></li>\n<li><a href=\"#h-07-shelter-claimed-mapping-is-set-with-_to-address-and-not-msgsender\">[H-07] Shelter <code>claimed</code> mapping is set with <code>_to</code> address and not <code>msg.sender</code></a></li>\n<li><a href=\"#h-08-masterchefsol-users-wont-be-able-to-receive-the-concur-rewards\">[H-08] <code>MasterChef.sol</code> Users won’t be able to receive the <code>concur</code> rewards</a></li>\n<li><a href=\"#h-09-deposit-in-convexstakingwrapper-will-most-certainly-revert\">[H-09] deposit in <code>ConvexStakingWrapper</code> will most certainly revert</a></li>\n<li><a href=\"#h-10-convexstakingwrapperexitshelter-will-lock-lp-tokens-preventing-users-from-withdrawing\">[H-10] <code>ConvexStakingWrapper.exitShelter()</code> Will Lock LP Tokens, Preventing Users From Withdrawing</a></li>\n<li><a href=\"#h-11-convexstakingwrapper_calcrewardintegral-can-be-manipulated-to-steal-tokens-from-other-pools\">[H-11] <code>ConvexStakingWrapper._calcRewardIntegral()</code> Can Be Manipulated To Steal Tokens From Other Pools</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-31\">Medium Risk Findings (31)</a></p>\n<ul>\n<li><a href=\"#m-01-deposits-after-the-grace-period-should-not-be-allowed\">[M-01] Deposits after the grace period should not be allowed</a></li>\n<li><a href=\"#m-02-unconstrained-fee\">[M-02] Unconstrained fee</a></li>\n<li><a href=\"#m-03-usdmpegrecoverysolwithdraw-withdraw-may-often-fail\">[M-03] <code>USDMPegRecovery.sol#withdraw()</code> withdraw may often fail</a></li>\n<li><a href=\"#m-04-usdmpegrecoverysolprovide-improper-designimplementation-make-it-often-unable-to-add-liquidity-to-the-usdm3crv-pool\">[M-04] <code>USDMPegRecovery.sol#provide()</code> Improper design/implementation make it often unable to add liquidity to the <code>usdm3crv</code> pool</a></li>\n<li><a href=\"#m-05-usdm-locked-unless-guardian-remove-liquidity\">[M-05] USDM locked unless guardian remove liquidity</a></li>\n<li><a href=\"#m-06-stakingrewardssol-recovererc20-can-be-used-as-a-backdoor-by-the-owner-to-retrieve-rewardstoken\">[M-06] <code>StakingRewards.sol</code> <code>recoverERC20()</code> can be used as a backdoor by the <code>owner</code> to retrieve <code>rewardsToken</code></a></li>\n<li><a href=\"#m-07-fee-on-transfer-token-donations-in-shelter-break-withdrawals\">[M-07] Fee-on-transfer token donations in <code>Shelter</code> break withdrawals</a></li>\n<li><a href=\"#m-08-donated-tokens-cannot-be-recovered-if-a-shelter-is-deactivated\">[M-08] Donated Tokens Cannot Be Recovered If A Shelter Is Deactivated</a></li>\n<li><a href=\"#m-09-stakingrewardssolnotifyrewardamount-improper-reward-balance-checks-can-make-some-users-unable-to-withdraw-their-rewards\">[M-09] <code>StakingRewards.sol#notifyRewardAmount()</code> Improper reward balance checks can make some users unable to withdraw their rewards</a></li>\n<li><a href=\"#m-10-users-will-lose-rewards-if-the-shelter-mechanism-is-enacted-before-a-recent-checkpoint\">[M-10] Users Will Lose Rewards If The Shelter Mechanism Is Enacted Before A Recent Checkpoint</a></li>\n<li><a href=\"#m-11-convexstakingwrapperentershelter-may-erroneously-overwrite-amountinshelter-leading-to-locked-tokens\">[M-11] <code>ConvexStakingWrapper.enterShelter()</code> May Erroneously Overwrite <code>amountInShelter</code> Leading To Locked Tokens</a></li>\n<li><a href=\"#m-12-usdmpegrecoveryprovide-will-fail-if-there-is-an-excess-of-usdm-tokens\">[M-12] <code>USDMPegRecovery.provide()</code> Will Fail If There Is An Excess Of <code>usdm</code> Tokens</a></li>\n<li><a href=\"#m-13-stakingrewardsrecovererc20-allows-owner-to-rug-the-rewardstoken\">[M-13] <code>StakingRewards.recoverERC20</code> allows owner to rug the <code>rewardsToken</code></a></li>\n<li><a href=\"#m-14-owner-can-steal-concur-rewards\">[M-14] Owner can steal Concur rewards</a></li>\n<li><a href=\"#m-15-owner-can-lock-tokens-in-masterchef\">[M-15] Owner can lock tokens in <code>MasterChef</code></a></li>\n<li><a href=\"#m-16-rewards-get-diluted-because-totalallocpoint-can-only-increase\">[M-16] Rewards get diluted because <code>totalAllocPoint</code> can only increase.</a></li>\n<li><a href=\"#m-17-deactivate-function-can-be-bypassed\">[M-17] Deactivate function can be bypassed</a></li>\n<li><a href=\"#m-18-users-will-lose-concur-rewards-if-the-shelter-mechanism-is-enacted-on-a-pool\">[M-18] Users Will Lose Concur Rewards If The Shelter Mechanism Is Enacted On A Pool</a></li>\n<li><a href=\"#m-19-rogue-pool-in-shelter\">[M-19] Rogue pool in Shelter</a></li>\n<li><a href=\"#m-20-masterchefupdatepool-fails-to-update-reward-variables-if-blocknumber--endblock\">[M-20] <code>MasterChef.updatePool()</code> Fails To Update Reward Variables If <code>block.number >= endBlock</code></a></li>\n<li><a href=\"#m-21-concurrewardpool-possible-reentrancy-when-claiming-rewards\">[M-21] [ConcurRewardPool] Possible reentrancy when claiming rewards</a></li>\n<li><a href=\"#m-22-if-the-staking-token-exists-in-both-stakingrewardssol-and-convexstakingwrappersol-then-it-will-be-possible-to-continue-claiming-concur-rewards-after-the-shelter-has-been-activated\">[M-22] If The Staking Token Exists In Both <code>StakingRewards.sol</code> And <code>ConvexStakingWrapper.sol</code> Then It Will Be Possible To Continue Claiming Concur Rewards After The Shelter Has Been Activated</a></li>\n<li><a href=\"#m-23-transfer-to-treasury-can-register-as-succeeded-when-failing-in-_calcrewardintegral\">[M-23] Transfer to treasury can register as succeeded when failing in <code>_calcRewardIntegral</code></a></li>\n<li><a href=\"#m-24-rewards-distribution-can-be-disrupted-by-a-early-user\">[M-24] Rewards distribution can be disrupted by a early user</a></li>\n<li><a href=\"#m-25-convexstakingwrapperdeposit-depositors-may-lose-their-funds-when-the-_amount-is-huge\">[M-25] <code>ConvexStakingWrapper#deposit()</code> depositors may lose their funds when the <code>_amount</code> is huge</a></li>\n<li><a href=\"#m-26-stakingrewardssetrewardsduration-allows-setting-near-zero-or-enormous-rewardsduration-which-breaks-reward-logic\">[M-26] <code>StakingRewards.setRewardsDuration</code> allows setting near zero or enormous <code>rewardsDuration</code>, which breaks reward logic</a></li>\n<li><a href=\"#m-27-masterchefsol-a-depositor-can-deposit-an-arbitrary-amount-without-no-cost\">[M-27] <code>MasterChef.sol</code> A <code>depositor</code> can deposit an arbitrary amount without no cost</a></li>\n<li><a href=\"#m-28-during-stake-or-deposit-users-would-not-be-rewarded-the-correct-concur-token-when-masterchef-has-under-supply-of-it\">[M-28] During stake or deposit, users would not be rewarded the correct Concur token, when MasterChef has under-supply of it</a></li>\n<li><a href=\"#m-29-convexstakingwrapper-deposits-and-withdraws-will-frequently-be-disabled-if-a-token-that-doesnt-allow-zero-value-transfers-will-be-added-as-a-reward-one\">[M-29] <code>ConvexStakingWrapper</code> deposits and withdraws will frequently be disabled if a token that doesn’t allow zero value transfers will be added as a reward one</a></li>\n<li><a href=\"#m-30-stakingrewards-reward-rate-can-be-dragged-out-and-diluted\">[M-30] <code>StakingRewards</code> reward rate can be dragged out and diluted</a></li>\n<li><a href=\"#m-31-execute-in-voteproxy-should-be-payable\">[M-31] execute in VoteProxy should be payable</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#codebase-impressions--summary\">Codebase Impressions &#x26; Summary</a></li>\n<li><a href=\"#l-01-masterchef-pendingconcur-shows-increasing-reward-amounts-after-mining-period-ends\">L-01: Masterchef: pendingConcur() shows increasing reward amounts after mining period ends</a></li>\n<li><a href=\"#l-02-masterchef-safeconcurtransfer-potentially-reverts-for-zero-amount\">L-02: Masterchef: <code>safeConcurTransfer()</code> potentially reverts for zero amount</a></li>\n<li><a href=\"#l-03-convexstakingwrapper-small-rounding-error-in-_calcrewardintegral\">L-03: ConvexStakingWrapper: Small rounding error in <code>_calcRewardIntegral()</code></a></li>\n<li><a href=\"#l-04-usdmpegrecovery-40m-or-4m-threshold\">L-04: USDMPegRecovery: 40M or 4M threshold?</a></li>\n<li><a href=\"#n-01-masterchef-incorrect-comment-on-endblock\">N-01: Masterchef: Incorrect comment on endBlock</a></li>\n<li><a href=\"#n-02-stakingrewards-incorrect-revert-statement-in-setrewardsdistribution\">N-02: StakingRewards: Incorrect revert statement in <code>setRewardsDistribution()</code></a></li>\n<li><a href=\"#n-03-masterchef-radss--concurs\">N-03: Masterchef: RADSs → Concurs</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-cache-external-call-result-in-the-stack-can-save-gas\">[G-01] Cache external call result in the stack can save gas</a></li>\n<li><a href=\"#g-02-cache-external-call-result-in-storage-can-save-gas\">[G-02] Cache external call result in storage can save gas</a></li>\n<li><a href=\"#g-03-safemath-is-no-longer-needed\">[G-03] `SafeMath is no longer needed</a></li>\n<li><a href=\"#g-04-change-unnecessary-storage-variables-to-constants-can-save-gas\">[G-04] Change unnecessary storage variables to constants can save gas</a></li>\n<li><a href=\"#g-05-setting-bool-variables-to-false-is-redundant\">[G-05] Setting <code>bool</code> variables to <code>false</code> is redundant</a></li>\n<li><a href=\"#g-06-using-immutable-variable-can-save-gas\">[G-06] Using immutable variable can save gas</a></li>\n<li><a href=\"#g-07-use-short-reason-strings-can-save-gas\">[G-07] Use short reason strings can save gas</a></li>\n<li><a href=\"#g-08-setting-uint256-variables-to-0-is-redundant\">[G-08] Setting <code>uint256</code> variables to <code>0</code> is redundant</a></li>\n<li><a href=\"#g-09-adding-unchecked-directive-can-save-gas\">[G-09] Adding unchecked directive can save gas</a></li>\n<li><a href=\"#g-10--0-is-less-efficient-than--0-for-unsigned-integers\">[G-10] ”> 0” is less efficient than “!= 0” for unsigned integers</a></li>\n<li><a href=\"#g-11-i-is-more-efficient-than-i\">[G-11] <code>++i</code> is more efficient than <code>i++</code></a></li>\n<li><a href=\"#g-12-reuse-existing-external-calls-cache-can-save-gas\">[G-12] Reuse existing external call’s cache can save gas</a></li>\n<li><a href=\"#g-13-unnecessary-checked-arithmetic-in-for-loops\">[G-13] Unnecessary checked arithmetic in for loops</a></li>\n<li><a href=\"#g-14-cache-array-length-in-for-loops-can-save-gas\">[G-14] Cache array length in for loops can save gas</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the Concur Finance smart contract system written in Solidity. The audit contest took place between February 3—February 9 2022.\n\n## Wardens\n\n58 Wardens contributed reports to the Concur Finance contest:\n\n  1. [leastwood](https://twitter.com/liam_eastwood13)\n  1. WatchPug ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n  1. [cmichel](https://twitter.com/cmichelio)\n  1. [hickuphh3](https://twitter.com/HickupH)\n  1. [pauliax](https://twitter.com/SolidityDev)\n  1. [wuwe1](https://twitter.com/wuwe19)\n  1. [gzeon](https://twitter.com/gzeon)\n  1. hyh\n  1. [throttle](https://twitter.com/Throt7le)\n  1. [Czar102](https://twitter.com/_Czar102)\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. [kirk-baird](https://twitter.com/kirkthebaird)\n  1. IllIllI\n  1. 0x1f8b\n  1. 0xw4rd3n\n  1. CertoraInc ([danb](https://twitter.com/danbinnun), egjlmn1, [OriDabush](https://twitter.com/ori_dabush), ItayG, and shakedwinder)\n  1. cccz\n  1. [0xliumin](https://twitter.com/0xliumin)\n  1. [Dravee](https://twitter.com/JustDravee)\n  1. harleythedog\n  1. reassor\n  1. kenta\n  1. [danb](https://twitter.com/danbinnun)\n  1. [Ruhum](https://twitter.com/0xruhum)\n  1. hubble (ksk2345 and shri4net)\n  1. Jujic\n  1. [defsec](https://twitter.com/defsec_)\n  1. [bobi](https://twitter.com/VladToie/)\n  1. [Randyyy](https://twitter.com/randyyramadhan)\n  1. [ShadowyNoobDev](https://twitter.com/ShadowyNoobDev)\n  1. bitbopper\n  1. SolidityScan ([cyberboy](https://twitter.com/cyberboyIndia) and [zombie](https://blog.dixitaditya.com/))\n  1. Heartless\n  1. [BouSalman](https://twitter.com/BouSalman)\n  1. mtz\n  1. robee\n  1. [rfa](https://www.instagram.com/riyan_rfa/)\n  1. [Sleepy](https://twitter.com/morphean_sec)\n  1. peritoflores\n  1. [ye0lde](https://twitter.com/_ye0lde)\n  1. [Rhynorater](https://twitter.com/rhynorater)\n  1. samruna\n  1. cryptphi\n  1. [0xngndev](https://twitter.com/ngndev)\n  1. 0x0x0x\n  1. 0xNot0rious\n  1. [Tomio](https://twitter.com/meidhiwirara)\n  1. 0x510c\n  1. [sabtikw](https://twitter.com/sabtikw)\n  1. GeekyLumberjack\n  1. [ckksec](https://twitter.com/ckksec)\n\nThis contest was judged by [Alex the Entreprenerd](https://twitter.com/GalloDaSballo). The judge also competed in the contest as a warden, but forfeited their winnings.\n\nFinal report assembled by [liveactionllama](https://twitter.com/liveactionllama).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 42 unique vulnerabilities. Of these vulnerabilities, 11 received a risk rating in the category of HIGH severity and 31 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 36 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 33 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 Concur Finance contest repository](https://github.com/code-423n4/2022-02-concur), and is composed of 8 smart contracts written in the Solidity programming language and includes 1,213 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# High Risk Findings (11)\n## [[H-01] Wrong reward token calculation in MasterChef contract](https://github.com/code-423n4/2022-02-concur-findings/issues/219)\n_Submitted by throttle, also found by cccz, cmichel, and leastwood_\n\n[MasterChef.sol#L86](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L86)<br>\n\nWhen adding new token pool for staking in MasterChef contract\n\n```javascript\nfunction add(address _token, uint _allocationPoints, uint16 _depositFee, uint _startBlock)\n```\n\nAll other, already added, pools should be updated but currently they are not.<br>\nInstead, only totalPoints is updated. Therefore, old (and not updated) pools will lose it's share during the next update.<br>\nTherefore, user rewards are not computed correctly (will be always smaller).\n\n### Proof of Concept\n\nScenario 1:\n\n1.  Owner adds new pool (first pool) for staking with points = 100 (totalPoints=100)<br>\n    and 1 block later Alice stakes 10 tokens in the first pool.\n2.  1 week passes\n3.  Alice withdraws her 10 tokens and claims X amount of reward tokens.<br>\n    and 1 block later Bob stakes 10 tokens in the first pool.\n4.  1 week passes\n5.  Owner adds new pool (second pool) for staking with points = 100 (totalPoints=200)<br>\n    and 1 block later Bob withdraws his 10 tokens and claims X/2 amount of reward tokens.<br>\n    But he should get X amount\n\nScenario 2:\n\n1.  Owner adds new pool (first pool) for staking with points = 100 (totalPoints=100).\n2.  1 block later Alice, Bob and Charlie stake 10 tokens there (at the same time).\n3.  1 week passes\n4.  Owner adds new pool (second pool) for staking with points = 400 (totalPoints=500)\n5.  Right after that, when Alice, Bob or Charlie wants to withdraw tokens and claim rewards they will only be able to claim 20% of what they should be eligible for, because their pool is updated with 20% (100/500) rewards instead of 100% (100/100) rewards for the past week.\n\n### Recommended Mitigation Steps\n\nUpdate all existing pools before adding new pool. Use the massUdpate() function which is already present ... but unused.\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/219)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/219#issuecomment-1092858699):**\n > The warden has identified a fallacy in how `add`s logic work.\n> \n> Ultimately rewards in this contract have to be linearly vested over time, adding a new pool would change the rate at which vesting in all pools will go.\n> \n> For that reason, it is necessary to accrue the rewards that each pool generated up to that point, before changing the slope at which rewards will be distributed.\n> \n> In this case add should massUpdateFirst.\n> \n> Because this vulnerability ultimately breaks the accounting of the protocol, I believe High Severity to be appropriate.\n\n\n\n***\n\n## [[H-02] Masterchef: Improper handling of deposit fee](https://github.com/code-423n4/2022-02-concur-findings/issues/138)\n_Submitted by hickuphh3, also found by leastwood_\n\n[MasterChef.sol#L170-L172](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L170-L172)<br>\n\nIf a pool’s deposit fee is non-zero, it is subtracted from the amount to be credited to the user.\n\n```jsx\nif (pool.depositFeeBP > 0) {\n  uint depositFee = _amount.mul(pool.depositFeeBP).div(_perMille);\n  user.amount = SafeCast.toUint128(user.amount + _amount - depositFee);\n}\n```\n\nHowever, the deposit fee is not credited to anyone, leading to permanent lockups of deposit fees in the relevant depositor contracts (StakingRewards and ConvexStakingWrapper for now).\n\n### Proof of Concept\n\n#### Example 1: ConvexStakingWrapper\n\nAssume the following\n\n*   The [curve cDai / cUSDC / cUSDT LP token](https://etherscan.io/address/0x9fC689CCaDa600B6DF723D9E47D84d76664a1F23) corresponds to `pid = 1` in the convex booster contract.\n*   Pool is added in Masterchef with `depositFeeBP = 100 (10%)`.\n\n1.  Alice deposits 1000 LP tokens via the ConvexStakingWrapper contract. A deposit fee of 100 LP tokens is charged. Note that the `deposits` mapping of the ConvexStakingWrapper contract credits 1000 LP tokens to her.\n2.  However, Alice will only be able to withdraw 900 LP tokens. The 100 LP tokens is not credited to any party, and is therefore locked up permanently (essentially becomes protocol-owned liquidity). While she is able to do `requestWithdraw()` for 1000 LP tokens, attempts to execute `withdraw()` with amount = 1000 will revert because she is only credited 900 LP tokens in the Masterchef contract.\n\n#### Example 2: StakingRewards\n\n*   CRV pool is added in Masterchef with `depositFeeBP = 100 (10%)`.\n\n1.  Alice deposits 1000 CRV into the StakingRewards contract. A deposit fee of 100 CRV is charged.\n2.  Alice is only able to withdraw 900 CRV tokens, while the 100 CRV is not credited to any party, and is therefore locked up permanently.\n\nThese examples are non-exhaustive as more depositors can be added / removed from the Masterchef contract.\n\n### Recommended Mitigation Steps\n\nI recommend shifting the deposit fee logic out of the masterchef contract into the depositor contracts themselves, as additional logic would have to be added in the masterchef to update the fee recipient’s state (rewardDebt, send pending concur rewards, update amount), which further complicates matters. As the fee recipient is likely to be the treasury, it is also not desirable for it to accrue concur rewards.\n\n```jsx\nif (pool.depositFeeBP > 0) {\n  uint depositFee = _amount.mul(pool.depositFeeBP).div(_perMille);\n  user.amount = SafeCast.toUint128(user.amount + _amount - depositFee);\n  UserInfo storage feeRecipient = userInfo[_pid][feeRecipient];\n  // TODO: update and send feeRecipient pending concur rewards\n  feeRecipient.amount = SafeCast.toUint128(feeRecipient.amount + depositFee);\n  // TODO: update fee recipient's rewardDebt\n}\n```\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/138)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/138#issuecomment-1092873088):**\n > The warden has identified a way for funds to be forever lost, because of that reason I believe High Severity to be appropriate.\n> \n> Mitigation could be as simple as transferring the fee to a `feeReceiver` or adding a way to pull those fees.\n\n\n\n***\n\n## [[H-03] Repeated Calls to Shelter.withdraw Can Drain All Funds in Shelter](https://github.com/code-423n4/2022-02-concur-findings/issues/246)\n_Submitted by mtz, also found by 0x1f8b, 0xliumin, bitbopper, cccz, cmichel, csanuragjain, Czar102, danb, Alex the Entreprenerd, GeekyLumberjack, gzeon, hickuphh3, hyh, leastwood, Randyyy, Rhynorater, Ruhum, and ShadowyNoobDev_\n\n[Shelter.sol#L52-L57](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/Shelter.sol#L52-L57)<br>\n\ntl;dr Anyone who can call `withdraw` to withdraw their own funds can call it repeatedly to withdraw the funds of others. `withdraw` should only succeed if the user hasn't withdrawn the token already.\n\nThe shelter can be used for users to withdraw funds in the event of an emergency. The `withdraw` function allows callers to withdraw tokens based on the tokens they have deposited into the shelter client: ConvexStakingWrapper. However, `withdraw` does not check if a user has already withdrawn their tokens. Thus a user that can `withdraw` tokens, can call withdraw repeatedly to steal the tokens of others.\n\n### Proof of Concept\n\ntl;dr an attacker that can successfully call `withdraw` once on a shelter, can call it repeatedly to steal the funds of others. Below is a detailed scenario where this situation can be exploited.\n\n1.  Mallory deposits 1 `wETH` into `ConvexStakingWrapper` using [`deposit`](https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol#L280). Let's also assume that other users have deposited 2 `wETH` into the same contract.\n2.  An emergency happens and the owner of `ConvexStakingWrapper` calls `setShelter(shelter)` and `enterShelter([pidOfWETHToken, ...])`. Now `shelter` has 3 `wETH` and is activated for `wETH`.\n3.  Mallory calls `shelter.withdraw(wETHAddr, MalloryAddr)`, Mallory will rightfully receive 1 wETH because her share of wETH in the shelter is 1/3.\n4.  Mallory calls `shelter.withdraw(wETHAddr, MalloryAddr)` again, receiving 1/3\\*2 = 2/3 wETH. `withdraw` does not check that she has already withdrawn. This time, the wETH does not belong to her, she has stolen the wETH of the other users. She can continue calling `withdraw` to steal the rest of the funds\n\n### Recommended Mitigation Steps\n\nTo mitigate this, `withdraw` must first check that `msg.sender` has not withdrawn this token before and `withdraw` must also record that `msg.sender` has withdrawn the token.\nThe exact steps for this are below:\n\n1.  Add the following line to the beginning of `withdraw` (line 53):\n\n<!---->\n\n    require(!claimed[_token][msg.sender], \"already claimed\")\n\n2.  Replace [line 55](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/Shelter.sol#L55) with the following:\n\n<!---->\n\n    claimed[_token][msg.sender] = true;\n\nThis replacement is necessary because we want to record who is withdrawing, not where they are sending the token which isn't really useful info.\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/246)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/246#issuecomment-1092877228):**\n > The warden has identified a logical fallacy in the `Shelter` contract.\n> \n> This would allow a caller to claim their tokens multiple times, as long as they send them to a new address.\n> \n> Mitigation is as simple as checking claims against `msg.sender`, however because all funds can be drained, this finding is of High Severity.\n\n\n\n***\n\n## [[H-04] `ConvexStakingWrapper`, `StakingRewards` Wrong implementation will send `concur` rewards to the wrong receiver](https://github.com/code-423n4/2022-02-concur-findings/issues/205)\n_Submitted by WatchPug, also found by bobi, CertoraInc, csanuragjain, danb, hickuphh3, and leastwood_\n\n[ConvexStakingWrapper.sol#L246](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L246)<br>\n[StakingRewards.sol#L99](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L99)<br>\n[MasterChef.sol#L159-L167](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L159-L167)<br>\n\n```solidity\nUserInfo storage user = userInfo[_pid][_msgSender()];\nupdatePool(_pid);\n\nif(user.amount > 0) {  \n    uint pending = user.amount * pool.accConcurPerShare / _concurShareMultiplier - user.rewardDebt;\n    if (pending > 0) {\n        safeConcurTransfer(_recipient, pending);\n    }\n}\n```\n\n`ConvexStakingWrapper`, `StakingRewards` is using `masterChef.deposit()`, `masterChef.withdraw()`, and these two functions on `masterChef` will take `_msgSender()` as the user address, which is actually the address of `ConvexStakingWrapper` and `StakingRewards`.\n\nAs a result, when calling `ConvexStakingWrapper.deposit()`, `ConvexStakingWrapper.withdraw()`, `StakingRewards.stake()`, `StakingRewards.withdraw()`, the `concur` rewards belongs to all the users of ConvexStakingWrapper / StakingRewards will be sent to the caller wrongfully.\n\n### Proof of Concept\n\n1.  Alice deposits `1,000,000` token to `pid 1`\n\nActual results on `masterChef`:\n\n*   userInfo\\[1]\\[address(ConvexStakingWrapper)] = `1,000,000`\n\nExpected results:\n\n*   userInfo\\[1]\\[address(Alice)] = `1,000,000`\n\n2.  1 day later, Bob deposits `1` token to `pid 1`\n\nActual results on `masterChef`:\n\n*   userInfo\\[1]\\[address(ConvexStakingWrapper)] = `1,000,001`\n*   all `pending rewards` sent to Bob\n\nExpected results:\n\n*   userInfo\\[1]\\[address(Alice)] = `1,000,000`\n\n*   userInfo\\[1]\\[address(Bob)] = `1`\n\n*   all `pending rewards` should be sent to Alice\n\n### Recommended Mitigation Steps\n\nConsider adding two new functions to MasterChef: `depositFor()` and `withdrawFor()`.\n\n`ConvexStakingWrapper`, `StakingRewards` can utilize these two functions and get the accounting right.\n\n```solidity\nfunction depositFor(address _user, uint _pid, uint _amount) external nonReentrant onlyDepositor {\n    PoolInfo storage pool = poolInfo[_pid];\n    UserInfo storage user = userInfo[_pid][_user];\n```\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/205)**\n\n\n\n***\n\n## [[H-05] `USDMPegRecovery` Risk of fund locked, due to discrepancy between curveLP token value against internal contract math](https://github.com/code-423n4/2022-02-concur-findings/issues/70)\n_Submitted by Alex the Entreprenerd, also found by gzeon, IllIllI, and leastwood_\n\n[USDMPegRecovery.sol#L90](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/USDMPegRecovery.sol#L90)<br>\n[USDMPegRecovery.sol#L110](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/USDMPegRecovery.sol#L110)<br>\n[USDMPegRecovery.sol#L73](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/USDMPegRecovery.sol#L73)<br>\n[USDMPegRecovery.sol#L84](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/USDMPegRecovery.sol#L84)<br>\n\nIn `USDMPegRecovery` `deposit` and `withdraw` allow for direct deposits of a specific token (3crv or usdm).\n\nThe balances are directly changed and tracked in storage.\n\n`provide` seems to be using the real balances (not the ones store) to provide liquidity.<br>\nBecause of how curve works, you'll be able (first deposit) to provide exactly matching liquidity.<br>\nBut after (even just 1 or) multiple swaps, the pool will be slightly imbalanced, adding or removing liquidity at that point will drastically change the balances in the contract from the ones tracked in storage.\n\nEventually users won't be able to withdraw the exact amounts they deposited.\n\nThis will culminate with real balances not matching user deposits, sometimes to user advantage and other times to user disadvantage, ultimately to the protocol dismay.\n\n### Proof of Concept\n\nDeposit equal usdm and 3crv<br>\nLP<br>\nDo one trade on CRV<br>\nWithdraw the LP\n\nThe real balances are not matching the balances in storage.\n\nUser tries to withdraw all their balances, inevitable revert.\n\n### Recommended Mitigation Steps\n\nEither find a way to price the user contribution based on the LP tokens (use virtual_price)<br>\nOr simply have people deposit the LP token directly (avoiding the IL math which is a massive headache)\n\n**[leekt (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/70)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/70#issuecomment-1097330571):**\n > I'm forfeitting winnings as I am judging the contest.\n> \n> The sponsor confirmed.\n> \n> I believe the closest findings are [#191](https://github.com/code-423n4/2022-02-concur-findings/issues/191) and [#94](https://github.com/code-423n4/2022-02-concur-findings/issues/94) these both focus on the provide aspect.<br>\n> However, this finding shows how the Curve LP Math will cause the internal balances to break after just one LP provision.\n> \n> Because this breaks accounting of the protocol and will cause funds to be stuck I believe High Severity to be appropriate.\n\n\n\n***\n\n## [[H-06] `ConvexStakingWrapper.sol#_calcRewardIntegral` Wrong implementation can disrupt rewards calculation and distribution](https://github.com/code-423n4/2022-02-concur-findings/issues/199)\n_Submitted by WatchPug, also found by cmichel, harleythedog, hickuphh3, kirk-baird, and leastwood_\n\n[ConvexStakingWrapper.sol#L175-L204](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L175-L204)<br>\n\n```solidity\n    uint256 bal = IERC20(reward.token).balanceOf(address(this));\n    uint256 d_reward = bal - reward.remaining;\n    // send 20 % of cvx / crv reward to treasury\n    if (reward.token == cvx || reward.token == crv) {\n        IERC20(reward.token).transfer(treasury, d_reward / 5);\n        d_reward = (d_reward * 4) / 5;\n    }\n    IERC20(reward.token).transfer(address(claimContract), d_reward);\n\n    if (_supply > 0 && d_reward > 0) {\n        reward.integral =\n            reward.integral +\n            uint128((d_reward * 1e20) / _supply);\n    }\n\n    //update user integrals\n    uint256 userI = userReward[_pid][_index][_account].integral;\n    if (userI < reward.integral) {\n        userReward[_pid][_index][_account].integral = reward.integral;\n        claimContract.pushReward(\n            _account,\n            reward.token,\n            (_balance * (reward.integral - userI)) / 1e20\n        );\n    }\n\n    //update remaining reward here since balance could have changed if claiming\n    if (bal != reward.remaining) {\n        reward.remaining = uint128(bal);\n    }\n```\n\nThe problems in the current implementation:\n\n*   `reward.remaining` is not a global state; the `reward.remaining` of other `reward`s with the same rewardToken are not updated;\n*   `bal` should be refreshed before `reward.remaining = uint128(bal);`;\n*   L175 should not use `balanceOf` but take the diff before and after `getReward()`.\n\n### Proof of Concept\n\n*   convexPool\\[1] is incentivized with CRV as the reward token, `1000 lpToken` can get `10 CRV` per day;\n*   convexPool\\[2] is incentivized with CRV as the reward token, `1000 lpToken` can get `20 CRV` per day.\n\n1.  Alice deposits `1,000` lpToken to `_pid` = `1`\n2.  1 day later, Alice deposits `500` lpToken to `_pid` = `1`\n\n*   convexPool `getReward()` sends `10 CRV` as reward to contract\n*   `d_reward` = 10, `2 CRV` sends to `treasury`, `8 CRV` send to `claimContract`\n*   `rewards[1][0].remaining` = 10\n\n3.  0.5 day later, Alice deposits `500` lpToken to `_pid` = `1`, and the tx will fail:\n\n*   convexPool `getReward()` sends `7.5 CRV` as reward to contract\n*   `reward.remaining` = 10\n*   `bal` = 7.5\n*   `bal - reward.remaining` will fail due to underflow\n\n4.  0.5 day later, Alice deposits `500` lpToken to `_pid` = `1`, most of the reward tokens will be left in the contract:\n\n*   convexPool `getReward()` sends `15 CRV` as reward to the contract;\n*   `d_reward = bal - reward.remaining` = 5\n*   `1 CRV` got sent to `treasury`, `4 CRV` sent to `claimContract`, `10 CRV` left in the contract;\n*   `rewards[1][0].remaining` = 15\n\nExpected Results:\n\nAll the `15 CRV` get distributed: `3 CRV` to the `treasury`, and `12 CRV` to `claimContract`.\n\nActual Results:\n\nOnly `5 CRV` got distributed. The other `10 CRV` got left in the contract which can be frozen in the contract, see below for the details:\n\n5.  Bob deposits `1,000` lpToken to `_pid` = `2`\n\n*   convexPool `getReward()` sends `0 CRV` as reward to the contract\n*   `d_reward = bal - reward.remaining` = 10\n*   `2 CRV` sent to `treasury`, `8 CRV` sent to `claimContract` without calling `pushReward()`, so the `8 CRV` are now frozen in `claimContract`;\n*   `rewards[2][0].remaining` = 10\n\n### Impact\n\n*   The two most important methods: `deposit()` and `withdraw()` will frequently fail as the tx will revert at `_calcRewardIntegral()`;\n*   Rewards distributed to users can often be fewer than expected;\n*   If there are different pools that use the same token as rewards, part of the rewards can be frozen at `claimContract` and no one can claim them.\n\n### Recommended Mitigation Steps\n\nConsider comparing the `balanceOf` reward token before and after `getReward()` to get the actual rewarded amount, and `reward.remaining` should be removed.\n\n**[leekt (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/199)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/199#issuecomment-1102806558):**\n > The warden has shown how `_calcRewardIntegral` can be broken in multiple ways.\n> \n> While I believe a set of similar findings have been reported, this one is extremely well written so I think this can stand on it's own.\n>\n > Because `_calRewardIntegral` is a core functionality of the contract (giving out reward) and the warden has shown how it can be broken, I agree with High Severity.\n\n\n\n***\n\n## [[H-07] Shelter `claimed` mapping is set with `_to` address and not `msg.sender`](https://github.com/code-423n4/2022-02-concur-findings/issues/103)\n_Submitted by 0xliumin, also found by cmichel, leastwood, and pauliax_\n\nAny user can withdraw all the funds from the shelter. This is done by calling withdraw repeatedly until all funds are drained. You only need to have a small share.\n\nEven if the `claimed` mapping was checked, there would still be a vulnerability. This is because the `claimed` mapping is updated with the `_to` address, not the `msg.sender` address.\n\n### Recommended Mitigation Steps\n\nRemediation is to change the `_to` to `msg.sender`.<br>\n[Shelter.sol#L55](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/Shelter.sol#L55)\n\n**[leekt (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/103)**\n\n**[Alex the Entreprenerd (judge) increased severity to High and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/103#issuecomment-1102697656):**\n > Am marking this as a unique finding as this one shows another issue with the Shelter withdraw function.\n> \n> Because this also allows for draining of all rewards, am raising to High Severity.\n\n\n\n***\n\n## [[H-08] `MasterChef.sol` Users won't be able to receive the `concur` rewards](https://github.com/code-423n4/2022-02-concur-findings/issues/200)\n_Submitted by WatchPug, also found by hickuphh3 and leastwood_\n\nAccording to:\n\n*   [README](https://github.com/code-423n4/2022-02-concur#-masterchef)\n*   Implementation of `deposit()`: [/contracts/MasterChef.sol#L157-L180](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L157-L180)\n\nMasterChef is only recording the deposited amount in the states, it's not actually holding the `depositToken`.\n\n`depositToken` won't be transferred from `_msgSender()` to the MasterChef contract.\n\nTherefore, in `updatePool()` L140 `lpSupply = pool.depositToken.balanceOf(address(this))` will always be `0`. And the `updatePool()` will be returned at L147.\n\n[MasterChef.sol#L135-L154](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L135-L154)\n\n```solidity\nfunction updatePool(uint _pid) public {\n    PoolInfo storage pool = poolInfo[_pid];\n    if (block.number <= pool.lastRewardBlock) {\n        return;\n    }\n    uint lpSupply = pool.depositToken.balanceOf(address(this));\n    if (lpSupply == 0 || pool.allocPoint == 0) {\n        pool.lastRewardBlock = block.number;\n        return;\n    }\n    if(block.number >= endBlock) {\n        pool.lastRewardBlock = block.number;\n        return;\n    }        \n\n    uint multiplier = getMultiplier(pool.lastRewardBlock, block.number);\n    uint concurReward = multiplier.mul(concurPerBlock).mul(pool.allocPoint).div(totalAllocPoint);\n    pool.accConcurPerShare = pool.accConcurPerShare.add(concurReward.mul(_concurShareMultiplier).div(lpSupply));\n    pool.lastRewardBlock = block.number;\n}\n```\n\n### Impact\n\n*   The MasterChef contract fail to implement the most essential function;\n*   Users won't be able to receive any `Concur` rewards from MasterChef;\n\n### Recommended Mitigation Steps\n\nConsider creating a receipt token to represent the invested token and use the receipt tokens in MasterChef.\n\nSee: <https://github.com/convex-eth/platform/blob/883ffd4ebcaee12e64d18f75bdfe404bcd900616/contracts/contracts/Booster.sol#L272-L277>\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/200)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/200#issuecomment-1100908295):**\n > The warden has identified a logical flaw in the `Masterchef` contract.\n> \n> The contract is expecting `lpTokens` (deposited in another depositor contract) to be in the `Masterchef` at the time in which `updatePool` is called.\n> \n> However, due to the fact that the `lpToken` will be somewhere else, a more appropriate check would be to ask the depositor contract for the total supply.\n> \n> Given this finding, the Masterchef contract will always reward 0 tokens.\n> \n> This should classify the finding as Medium Severity (loss of Yield).\n> \n> However, because the finding shows how this can happen reliably, and effectively breaks the purpose of the contract, I believe High Severity to be more appropriate.\n\n\n\n***\n\n## [[H-09] deposit in `ConvexStakingWrapper` will most certainly revert](https://github.com/code-423n4/2022-02-concur-findings/issues/33)\n_Submitted by wuwe1, also found by WatchPug_\n\n[ConvexStakingWrapper.sol#L94-L99](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/ConvexStakingWrapper.sol#L94-L99)<br>\n\n```solidity\n        address mainPool = IRewardStaking(convexBooster)\n            .poolInfo(_pid)\n            .crvRewards;\n        if (rewards[_pid].length == 0) {\n            pids[IRewardStaking(convexBooster).poolInfo(_pid).lptoken] = _pid;\n            convexPool[_pid] = mainPool;\n```\n\n`convexPool[_pid]` is set to `IRewardStaking(convexBooster).poolInfo(_pid).crvRewards;`\n\n`crvRewards` is a `BaseRewardPool` like this one: <https://etherscan.io/address/0x8B55351ea358e5Eda371575B031ee24F462d503e#code>.\n\n`BaseRewardPool` does not implement `poolInfo`\n\n[ConvexStakingWrapper.sol#L238](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/ConvexStakingWrapper.sol#L238)\n\n```solidity\nIRewardStaking(convexPool[_pid]).poolInfo(_pid).lptoken\n```\n\nAbove line calls `poolInfo` of  `crvRewards` which causes revert.\n\n### Recommended Mitigation Steps\n\nAccording to Booster's code\n\n<https://etherscan.io/address/0xF403C135812408BFbE8713b5A23a04b3D48AAE31#code>\n\n```solidity\n    //deposit lp tokens and stake\n    function deposit(uint256 _pid, uint256 _amount, bool _stake) public returns(bool){\n        require(!isShutdown,\"shutdown\");\n        PoolInfo storage pool = poolInfo[_pid];\n        require(pool.shutdown == false, \"pool is closed\");\n\n        //send to proxy to stake\n        address lptoken = pool.lptoken;\n        IERC20(lptoken).safeTransferFrom(msg.sender, staker, _amount);\n```\n\n`convexBooster` requires `poolInfo[_pid].lptoken`.\n\nchange L238 to\n\n```solidity\nIRewardStaking(convexBooster).poolInfo(_pid).lptoken\n```\n\n**[leekt (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/33)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/33#issuecomment-1101856224):**\n > The warden has shown how an improper assumption about the pool contract can cause reverts.\n> \n> While the risk of loss of funds is non-existent because all calls will revert, I believe the core functionality of the code is broken. For that reason, I think High Severity to be the proper severity.\n\n\n\n***\n\n## [[H-10] `ConvexStakingWrapper.exitShelter()` Will Lock LP Tokens, Preventing Users From Withdrawing](https://github.com/code-423n4/2022-02-concur-findings/issues/144)\n_Submitted by leastwood_\n\nThe shelter mechanism provides emergency functionality in an effort to protect users' funds. The `enterShelter` function will withdraw all LP tokens from the pool, transfer them to the shelter contract and activate the shelter for the target LP token. Conversely, the `exitShelter` function will deactivate the shelter and transfer all LP tokens back to the `ConvexStakingWrapper.sol` contract.\n\nUnfortunately, LP tokens aren't restaked in the pool, causing LP tokens to be stuck within the contract. Users will be unable to withdraw their LP tokens as the `withdraw` function attempts to `withdrawAndUnwrap` LP tokens from the staking pool. As a result, this function will always revert due to insufficient staked balance. If other users decide to deposit their LP tokens, then these tokens can be swiped by users who have had their LP tokens locked in the contract.\n\nThis guarantees poor UX for the protocol and will most definitely lead to LP token loss.\n\n### Proof of Concept\n\n[ConvexStakingWrapper.sol#L121-L130](https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol#L121-L130)\n\n    function exitShelter(uint256[] calldata _pids) external onlyOwner {\n        for(uint256 i = 0; i<_pids.length; i++){\n            IRewardStaking pool = IRewardStaking(convexPool[_pids[i]]);\n            IERC20 lpToken = IERC20(\n                pool.poolInfo(_pids[i]).lptoken\n            );\n            amountInShelter[lpToken] = 0;\n            shelter.deactivate(lpToken);\n        }\n    }\n\n[ConvexStakingWrapper.sol#L309-L331](https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol#L309-L331)\n\n    function withdraw(uint256 _pid, uint256 _amount)\n        external\n        nonReentrant\n        whenNotInShelter(_pid)\n    {\n        WithdrawRequest memory request = withdrawRequest[_pid][msg.sender];\n        require(request.epoch < currentEpoch() && deposits[_pid][msg.sender].epoch + 1 < currentEpoch(), \"wait\");\n        require(request.amount >= _amount, \"too much\");\n        _checkpoint(_pid, msg.sender);\n        deposits[_pid][msg.sender].amount -= uint192(_amount);\n        if (_amount > 0) {\n            IRewardStaking(convexPool[_pid]).withdrawAndUnwrap(_amount, false);\n            IERC20 lpToken = IERC20(\n                IRewardStaking(convexPool[_pid]).poolInfo(_pid).lptoken\n            );\n            lpToken.safeTransfer(msg.sender, _amount);\n            uint256 pid = masterChef.pid(address(lpToken));\n            masterChef.withdraw(msg.sender, pid, _amount);\n        }\n        delete withdrawRequest[_pid][msg.sender];\n        //events\n        emit Withdrawn(msg.sender, _amount);\n    }\n\n### Tools Used\n\nManual code review.<br>\nConfirmation from Taek.\n\n### Recommended Mitigation Steps\n\nConsider re-depositing LP tokens upon calling `exitShelter`. This should ensure the same tokens can be reclaimed by users wishing to exit the `ConvexStakingWrapper.sol` contract.\n\n**[leekt (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/144)**\n\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/144#issuecomment-1101875875):**\n > The warden has identified how through a combination of using the shelter and sending funds back, the funds would actually end up being stuck and non-withdrawable by depositors.\n> \n> I believe that generally speaking this would be a Medium Severity finding as the funds would be stuck if the sponsor were to activate the shelter and then send the tokens back (conditionality).\n> \n> However, the warden has shown that the system of Contract + Shelter is effectively broken, and for this reason I believe the finding is of High Severity.\n\n\n\n***\n\n## [[H-11] `ConvexStakingWrapper._calcRewardIntegral()` Can Be Manipulated To Steal Tokens From Other Pools](https://github.com/code-423n4/2022-02-concur-findings/issues/146)\n_Submitted by leastwood, also found by cmichel and kirk-baird_\n\nThe `ConvexStakingWrapper.sol` implementation makes several modifications to the original design. One of the key changes is the ability to add multiple pools into the wrapper contract, where each pool is represented by a unique `_pid`. By doing this, we are able to aggregate pools and their LP tokens to simplify the token distribution process.\n\nHowever, the interdependence between pools introduces new problems. Because the original implementation uses the contract's reward token balance to track newly claimed tokens, it is possible for a malicious user to abuse the unguarded `getReward` function to maximise the profit they are able to generate. By calling `getReward` on multiple pools with the same reward token (i.e. `cvx`), users are able to siphon rewards from other pools. This inevitably leads to certain loss of rewards for users who have deposited LP tokens into these victim pools. As `crv` and `cvx` are reward tokens by default, it is very likely that someone will want to exploit this issue.\n\n### Proof of Concept\n\nLet's consider the following scenario:\n\n*   There are two convex pools with `_pid` 0 and 1.\n*   Both pools currently only distribute `cvx` tokens.\n*   Alice deposits LP tokens into the pool with `_pid` 0.\n*   Both pools earn 100 `cvx` tokens which are to be distributed to the holders of the two pools.\n*   While Alice is a sole staker of the pool with `_pid` 0, the pool with `_pid` 1 has several stakers.\n*   Alice decides she wants to maximise her potential rewards, so she directly calls the unguarded `IRewardStaking(convexPool[_pid]).getReward` function on both pools, resulting in 200 `cvx` tokens being sent to the contract.\n*   She then decides to deposit the 0 amount to execute the `_calcRewardIntegral` function on the pool with `_pid` 0. However, this function will calculate `d_reward` as `bal - reward.remaining` which is effectively the change in contract balance. As we have directly claimed `cvx` tokens over the two pools, this `d_reward` will be equal to 200.\n*   Alice is then entitled to the entire 200 tokens as she is the sole staker of her pool. So instead of receiving 100 tokens, she is able to siphon rewards from other pools.\n\nAltogether, this will lead to the loss of rewards for other stakers as they are unable to then claim their rewards.\n\n[ConvexStakingWrapper.sol#L216-L259](https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol#L216-L259)\n\n    function _calcRewardIntegral(\n        uint256 _pid,\n        uint256 _index,\n        address _account,\n        uint256 _balance,\n        uint256 _supply\n    ) internal {\n        RewardType memory reward = rewards[_pid][_index];\n\n        //get difference in balance and remaining rewards\n        //getReward is unguarded so we use remaining to keep track of how much was actually claimed\n        uint256 bal = IERC20(reward.token).balanceOf(address(this));\n        uint256 d_reward = bal - reward.remaining;\n        // send 20 % of cvx / crv reward to treasury\n        if (reward.token == cvx || reward.token == crv) {\n            IERC20(reward.token).transfer(treasury, d_reward / 5);\n            d_reward = (d_reward * 4) / 5;\n        }\n        IERC20(reward.token).transfer(address(claimContract), d_reward);\n\n        if (_supply > 0 && d_reward > 0) {\n            reward.integral =\n                reward.integral +\n                uint128((d_reward * 1e20) / _supply);\n        }\n\n        //update user integrals\n        uint256 userI = userReward[_pid][_index][_account].integral;\n        if (userI < reward.integral) {\n            userReward[_pid][_index][_account].integral = reward.integral;\n            claimContract.pushReward(\n                _account,\n                reward.token,\n                (_balance * (reward.integral - userI)) / 1e20\n            );\n        }\n\n        //update remaining reward here since balance could have changed if claiming\n        if (bal != reward.remaining) {\n            reward.remaining = uint128(bal);\n        }\n\n        rewards[_pid][_index] = reward;\n    }\n\n### Tools Used\n\nManual code review.<br>\nConfirmation from Taek.\n\n### Recommended Mitigation Steps\n\nConsider redesigning this mechanism such that all pools have their `getReward` function called in `_checkpoint`. The `_calcRewardIntegral` function can then ensure that each pool is allocated only a fraction of the total rewards instead of the change in contract balance. Other implementations might be more ideal, so it is important that careful consideration is taken when making these changes.\n\n**[leekt (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/146)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/146#issuecomment-1101894485):**\n > The warden has shown how, by having the same token as rewards for multiple pools, the math for claiming can be broken, allowing the depositor of one pool to claim a portion of the token reward earned by all pools.\n> \n> Normally this would be contingent on implementation or overlap of the tokens, however, because we're dealing with CVX we already know for certain that CVX and cvxCRV is going to be a reward for the majority of the pools.\n> \n> This finding ultimately shows how to break the accounting of the reward contract while stealing yield from all other pools, and for that reason, I believe High Severity to be valid.\n\n\n\n***\n \n# Medium Risk Findings (31)\n## [[M-01] Deposits after the grace period should not be allowed](https://github.com/code-423n4/2022-02-concur-findings/issues/251)\n_Submitted by pauliax_\n\n[Shelter.sol#L34](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/Shelter.sol#L34)<br>\n[Shelter.sol#L54](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/Shelter.sol#L54)<br>\n\nFunction donate in Shelter shouldn't allow new deposits after the grace period ends, when the claim period begins.<br>\nOtherwise, it will be possible to increase savedTokens\\[\\_token], and thus new user claim amounts will increase after some users might already have withdrawn their shares.\n\n### Recommended Mitigation Steps\n\nBased on my understanding, it should contain this check:\n\n```solidity\n  require(activated[_token] + GRACE_PERIOD > block.timestamp, \"too late\");\n```\n\n**[leekt (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/251)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/251#issuecomment-1088035152):**\n > Separating between a rescuing period and a redemption period does make sense and avoids losing on future rewards by withdrawing early.\n> \n> The sponsor confirmed, I believe medium severity to be appropriate.\n\n\n\n***\n\n## [[M-02] Unconstrained fee](https://github.com/code-423n4/2022-02-concur-findings/issues/242)\n_Submitted by Czar102, also found by defsec, Dravee, harleythedog, hickuphh3, and throttle_\n\n[MasterChef.sol#L86-L101](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L86-L101)<br>\n\nToken fee in `MasterChef` can be set to more than 100%, (for example, by accident) causing all `deposit` calls to fail due to underflow on subtraction when reward is lowered by the fee, thus breaking essential mechanics. Note that after the fee has been set to any value, it cannot be undone. A token cannot be removed, added, or added the second time. Thus, mistakenly (or deliberately, maliciously) added fee that is larger than 100% will make the contract impossible to recover from not being able to use the token.\n\n### Recommended Mitigation Steps\n\nOn setting fee ensure that it is below a set maximum, which is set to no more than 100%.\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/242)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/242#issuecomment-1088039177):**\n > The warden has identified admin privilege that would enable them to set the deposit fee to 100%.<br>\n> The value can also be increased above 100% to cause a denial of service to the user.\n> \n> Mitigation would require offering a more appropriate upper limit to the fee.\n\n\n\n***\n\n## [[M-03] `USDMPegRecovery.sol#withdraw()` withdraw may often fail](https://github.com/code-423n4/2022-02-concur-findings/issues/212)\n_Submitted by WatchPug_\n\nPer the doc:\n\n> USDM deposits are locked based on the KPI’s from carrot.eth.\n\n> 3Crv deposits are not locked.\n\n[USDMPegRecovery.sol#L110-L128](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/USDMPegRecovery.sol#L110-L128)<br>\n\n```solidity\nfunction withdraw(Liquidity calldata _withdrawal) external {\n        Liquidity memory total = totalLiquidity;\n        Liquidity memory user = userLiquidity[msg.sender];\n        if(_withdrawal.usdm > 0) {\n            require(unlockable, \"!unlock usdm\");\n            usdm.safeTransfer(msg.sender, uint256(_withdrawal.usdm));\n            total.usdm -= _withdrawal.usdm;\n            user.usdm -= _withdrawal.usdm;\n        }\n\n        if(_withdrawal.pool3 > 0) {\n            pool3.safeTransfer(msg.sender, uint256(_withdrawal.pool3));\n            total.pool3 -= _withdrawal.pool3;\n            user.pool3 -= _withdrawal.pool3;\n        }\n        totalLiquidity = total;\n        userLiquidity[msg.sender] = user;\n        emit Withdraw(msg.sender, _withdrawal);\n    }\n```\n\nHowever, because the `withdraw()` function takes funds from the balance of the contract, once the majority of the funds are added to the curve pool via `provide()`. The `withdraw()` may often fail due to insufficient funds in the balance.\n\n### Proof of Concept\n\n1.  Alice deposits `4M` USDM and `4M` pool3 tokens;\n2.  Guardian calls `provide()` and all the `usdm` and `pool3` to `usdm3crv`;\n3.  Alice calls `withdraw()`, the tx will fail, due to insufficient balance.\n\n### Recommended Mitigation Steps\n\nConsider calling `usdm3crv.remove_liquidity_one_coin()` when the balance is insufficient for the user's withdrawal.\n\n**[leekt (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/212)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/212#issuecomment-1088104169):**\n > The warden has identified a specific scenario in which user funds would not be withdrawable\n> \n> Because the code uses internal storage for accounting rather than \"value\" this scenario can happen fairly reliably.\n> \n> I believe mitigation requires further thought than just withdrawing and ideally it would be best to setup a system similar to Vault Shares so that a withdrawal could be triggered either by available liquidity or via a withdrawal from the pool.\n> \n> I think Medium severity is appropriate.\n\n\n\n***\n\n## [[M-04] `USDMPegRecovery.sol#provide()` Improper design/implementation make it often unable to add liquidity to the `usdm3crv` pool](https://github.com/code-423n4/2022-02-concur-findings/issues/191)\n_Submitted by WatchPug_\n\n[USDMPegRecovery.sol#L73-L82](https://github.com/code-423n4/2022-02-concur/blob/02d286253cd5570d4e595527618366f77627cdaf/contracts/USDMPegRecovery.sol#L73-L82)<br>\n\n```solidity\nfunction provide(uint256 _minimumLP) external onlyGuardian {\n    require(usdm.balanceOf(address(this)) >= totalLiquidity.usdm, \"<liquidity\");\n    // truncate amounts under step\n    uint256 addingLiquidity = (usdm.balanceOf(address(this)) / step) * step;\n    // match usdm : pool3 = 1 : 1\n    uint256[2] memory amounts = [addingLiquidity, addingLiquidity];\n    usdm.approve(address(usdm3crv), addingLiquidity);\n    pool3.approve(address(usdm3crv), addingLiquidity);\n    usdm3crv.add_liquidity(amounts, _minimumLP);\n}\n```\n\nIn the current implementation of `USDMPegRecovery.sol#provide()`, `addingLiquidity` is calculated solely based on `usdm` balance (truncate at a step of 250k), and it always uses the same amount of 3pool tokens to add_liquidity with.\n\nBased on other functions of the contract, the balance of `usdm` can usually be more than the `pool3` balance, in that case, `usdm3crv.add_liquidity()` will fail.\n\n### Impact\n\nWhen the balance of `pool3` is less than `usdm` (which is can be a common scenario), funds cannot be added to the curve pool.\n\nFor example:\n\nWhen the contract got 5M of USDM and 4.2M of `pool3` tokens, it won't be possible to call `provide()` and add liquidity to the `usdm3crv` pool, as there are not enough pool3 tokens to match the 5M of USDM yet.\n\nWe expect it to add liquidity with 4M of USDM and 4M of pool3 tokens in that case.\n\n### Recommended Mitigation Steps\n\nChange to:\n\n```solidity\nfunction provide(uint256 _minimumLP) external onlyGuardian {\n    require(usdm.balanceOf(address(this)) >= totalLiquidity.usdm, \"<liquidity\");\n    uint256 tokenBalance = Math.min(usdm.balanceOf(address(this), pool3.balanceOf(address(this));\n    // truncate amounts under step\n    uint256 addingLiquidity = (tokenBalance / step) * step;\n    // match usdm : pool3 = 1 : 1\n    uint256[2] memory amounts = [addingLiquidity, addingLiquidity];\n    usdm.approve(address(usdm3crv), addingLiquidity);\n    pool3.approve(address(usdm3crv), addingLiquidity);\n    usdm3crv.add_liquidity(amounts, _minimumLP);\n}\n```\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/191)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/191#issuecomment-1088106517):**\n > I agree with the finding, ultimately liquidity addition won't be at a 1:1 rate and the code won't adapt to that situation causing reverts.\n\n\n\n***\n\n## [[M-05] USDM locked unless guardian remove liquidity](https://github.com/code-423n4/2022-02-concur-findings/issues/187)\n_Submitted by gzeon_\n\nIn README.me:\n\n> USDM deposits are locked based on the KPI’s from carrot.eth\n\nHowever, USDM deposits are also locked until guardian remove liquidity because there are no mechanism to remove deposited USDM in `withdraw`.\n\n[USDMPegRecovery.sol#L90](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/USDMPegRecovery.sol#L90)<br>\n\n**[leekt (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/187)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/187#issuecomment-1088108967):**\n > The warden has identified Admin Privilege in that the deposit contract is controlled by the admin and liquidity LPd into the Curve Pool cannot be withdrawn by user (although code for redemption is present).\n> \n> Ultimately a refactoring that transforms this contract in something similar to a Yield Bearing Vault would solve for accounting while allowing an easier time adding and removing liquidity.\n> \n> Personally I'd recommend the sponsor to denominate the deposit token in the CRV_LP token to avoid issues with Single Sided Exposure, which other findings in this contest already discuss.\n\n\n\n***\n\n## [[M-06] `StakingRewards.sol` `recoverERC20()` can be used as a backdoor by the `owner` to retrieve `rewardsToken`](https://github.com/code-423n4/2022-02-concur-findings/issues/210)\n_Submitted by WatchPug, also found by cmichel_\n\n[StakingRewards.sol#L166-L176](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L166-L176)<br>\n\n```solidity\n    function recoverERC20(address tokenAddress, uint256 tokenAmount)\n        external\n        onlyOwner\n    {\n        require(\n            tokenAddress != address(stakingToken),\n            \"Cannot withdraw the staking token\"\n        );\n        IERC20(tokenAddress).safeTransfer(owner(), tokenAmount);\n        emit Recovered(tokenAddress, tokenAmount);\n    }\n```\n\n### Impact\n\nUsers can lose all the rewards to the malicious/compromised `owner`.\n\n### Recommended Mitigation Steps\n\nChange to:\n\n```solidity\n function recoverERC20(\n    address tokenAddress,\n    address to,\n    uint256 amount\n) external onlyOwner {\n    require(tokenAddress != address(stakingToken) && tokenAddress != address(rewardsToken), \"20\");\n\n    IERC20(tokenAddress).safeTransfer(to, amount);\n    emit Recovered(tokenAddress, to, amount);\n}\n```\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/210)**\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/210#issuecomment-1088110273):**\n > Agree with the finding, ultimately a simple check would provide stronger security guarantees.\n> \n> Because this is contingent on a malicious owner, I believe Medium Severity to be more appropriate.\n\n\n\n***\n\n## [[M-07] Fee-on-transfer token donations in `Shelter` break withdrawals](https://github.com/code-423n4/2022-02-concur-findings/issues/180)\n_Submitted by cmichel, also found by Dravee, IllIllI, and Ruhum_\n\n[Shelter.sol#L34](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/Shelter.sol#L34)<br>\n\nThe `Sheler.donate` function `transferFrom`s `_amount` and adds the entire `_amount` to `savedTokens[_token]`.<br>\nBut the actual received token amount from the transfer can be less for fee-on-transfer tokens.\n\nThe last person to withdraw will not be able to as `withdraw` uses a share computation for the entire `savedTokens[_token]` amount.<br>\nThe calculated `amount` will then be higher than the actual contract balance.\n\n```solidity\nfunction donate(IERC20 _token, uint256 _amount) external {\n    require(activated[_token] != 0, \"!activated\");\n    savedTokens[_token] += _amount;\n    // @audit fee-on-transfer. then fails for last person in `withdraw`\n    _token.safeTransferFrom(msg.sender, address(this), _amount);\n}\n\nfunction withdraw(IERC20 _token, address _to) external override {\n    // @audit percentage on storage var, not on actual balance\n    uint256 amount = savedTokens[_token] * client.shareOf(_token, msg.sender) / client.totalShare(_token);\n    // @audit amount might not be in contract anymore as savedTokens[_token] is over-reported\n    _token.safeTransfer(_to, amount);\n}\n```\n\n### Recommended Mitigation Steps\n\nIn `donate`, add only the actual transferred amounts (computed by `post-transfer balance - pre-transfer balance`) to `savedTokens[_token]`.\n\n**[leekt (Concur) acknowledged](https://github.com/code-423n4/2022-02-concur-findings/issues/180)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/180#issuecomment-1088119261):**\n > The warden has identified a specific interaction between a `feeOnTransfer` token and the Shelter Contract.\n> \n> Because the Shelter Contract can receive any token, and anyone could claim them based on percentage, and because some people will lose the ability to claim due to the internal accounting being incorrect, I believe that in this instance the finding is valid, and of medium severity.\n\n\n\n***\n\n## [[M-08] Donated Tokens Cannot Be Recovered If A Shelter Is Deactivated](https://github.com/code-423n4/2022-02-concur-findings/issues/173)\n_Submitted by leastwood, also found by reassor_\n\nThe shelter mechanism can be activated and deactivated on a target LP token. The owner of the `ConvexStakingWrapper.sol` contract can initiate the shelter whereby LP tokens are sent to the `Shelter.sol` contract. However, if the owner decides to deactivate the shelter before the grace period has passed, all LP tokens are transferred back to the `ConvexStakingWrapper.sol` contract. Donated tokens are also sent back to the contract. As a result, these tokens do not actually belong to any user and will effectively be lost in the contract.\n\n#### Proof of Concept\n\n[Shelter.sol#L32-L36](https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/Shelter.sol#L32-L36)<br>\n\n    function donate(IERC20 _token, uint256 _amount) external {\n        require(activated[_token] != 0, \"!activated\");\n        savedTokens[_token] += _amount;\n        _token.safeTransferFrom(msg.sender, address(this), _amount);\n    }\n\n[ConvexStakingWrapper.sol#L107-L130](https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol#L107-L130)<br>\n\n    function enterShelter(uint256[] calldata _pids) external onlyOwner {\n        for(uint256 i = 0; i<_pids.length; i++){\n            IRewardStaking pool = IRewardStaking(convexPool[_pids[i]]);\n            uint256 amount = pool.balanceOf(address(this));\n            pool.withdrawAndUnwrap(amount, false);\n            IERC20 lpToken = IERC20(\n                pool.poolInfo(_pids[i]).lptoken\n            );\n            amountInShelter[lpToken] = amount;\n            lpToken.safeTransfer(address(shelter), amount);\n            shelter.activate(lpToken);\n        }\n    }\n\n    function exitShelter(uint256[] calldata _pids) external onlyOwner {\n        for(uint256 i = 0; i<_pids.length; i++){\n            IRewardStaking pool = IRewardStaking(convexPool[_pids[i]]);\n            IERC20 lpToken = IERC20(\n                pool.poolInfo(_pids[i]).lptoken\n            );\n            amountInShelter[lpToken] = 0;\n            shelter.deactivate(lpToken);\n        }\n    }\n\n### Recommended Mitigation Steps\n\nConsider allocating donated LP tokens to the contract owner when a shelter is deactivated. This can be done by checking for an excess of LP tokens. Anything greater than `amountInShelter` can be considered as donated.\n\n**[leekt (Concur) acknowledged](https://github.com/code-423n4/2022-02-concur-findings/issues/173)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/173#issuecomment-1092314721):**\n > The warden has indentified a way to potentially lose tokens, ultimately the contract could be rewritten to constantly allow redemption.\n> \n> For those reasons, and because the sponsor acknowledged, I believe the finding to be valid and of medium severity.\n\n\n\n***\n\n## [[M-09] `StakingRewards.sol#notifyRewardAmount()` Improper reward balance checks can make some users unable to withdraw their rewards](https://github.com/code-423n4/2022-02-concur-findings/issues/209)\n_Submitted by WatchPug_\n\n[StakingRewards.sol#L154-L158](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L154-L158)<br>\n\n```solidity\n    uint256 balance = rewardsToken.balanceOf(address(this));\n    require(\n        rewardRate <= balance / rewardsDuration,\n        \"Provided reward too high\"\n    );\n```\n\nIn the current implementation, the contract only checks if balanceOf `rewardsToken` is greater than or equal to the future rewards.\n\nHowever, under normal circumstances, since users can not withdraw all their rewards in time, the balance in the contract contains rewards that belong to the users but have not been withdrawn yet. This means the current checks can not be sufficient enough to make sure the contract has enough amount of rewardsToken.\n\nAs a result, if the `rewardsDistribution` mistakenly `notifyRewardAmount` with a larger amount, the contract may end up in a wrong state that makes some users unable to claim their rewards.\n\n### Proof of Concept\n\nGiven:\n\n*   rewardsDuration = 7 days;\n\n1.  Alice stakes `1,000` stakingToken;\n2.  `rewardsDistribution` sends `100` rewardsToken to the contract;\n3.  `rewardsDistribution` calls `notifyRewardAmount()` with `amount` = `100`;\n4.  7 days later, Alice calls `earned()` and it returns `100` rewardsToken, but Alice choose not to `getReward()` for now;\n5.  `rewardsDistribution` calls `notifyRewardAmount()` with `amount` = `100` without send any fund to contract, the tx will succees;\n6.  7 days later, Alice calls `earned()` `200` rewardsToken, when Alice tries to call `getReward()`, the transaction will fail due to insufficient balance of rewardsToken.\n\nExpected Results:\n\nThe tx in step 5 should revert.\n\n### Recommended Mitigation Steps\n\nConsider changing the function `notifyRewardAmount` to `addRward` and use `transferFrom` to transfer rewardsToken into the contract:\n\n```solidity\nfunction addRward(uint256 reward)\n    external\n    updateReward(address(0))\n{\n    require(\n        msg.sender == rewardsDistribution,\n        \"Caller is not RewardsDistribution contract\"\n    );\n\n    if (block.timestamp >= periodFinish) {\n        rewardRate = reward / rewardsDuration;\n    } else {\n        uint256 remaining = periodFinish - block.timestamp;\n        uint256 leftover = remaining * rewardRate;\n        rewardRate = (reward + leftover) / rewardsDuration;\n    }\n\n    rewardsToken.safeTransferFrom(msg.sender, address(this), reward);\n\n    lastUpdateTime = block.timestamp;\n    periodFinish = block.timestamp + rewardsDuration;\n    emit RewardAdded(reward);\n}\n```\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/209)**\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/209#issuecomment-1104079338):**\n > Given the code available, the warden has shown a possible scenario where certain depositors cannot receive reward tokens.\n> \n> Because this is contingent on an improper configuration and because this relates to loss of Yield, I believe Medium Severity to be more appropriate.\n\n\n\n***\n\n## [[M-10] Users Will Lose Rewards If The Shelter Mechanism Is Enacted Before A Recent Checkpoint](https://github.com/code-423n4/2022-02-concur-findings/issues/115)\n_Submitted by leastwood_\n\nThe shelter mechanism aims to protect the protocol's users by draining funds into a separate contract in the event of an emergency. However, while users are able to reclaim their funds through the `Shelter.sol` contract, they will still have a deposited balance from the perspective of `ConvexStakingWrapper.sol`.\n\nBecause users will only receive their rewards upon depositing/withdrawing their funds due to how the checkpointing mechanism works, it is likely that by draining funds to the `Shelter.sol` contract, users will lose out on any rewards they had accrued up and until that point. These rewards are unrecoverable and can potentially be locked within the contract if the reward token is unique and only belongs to the sheltered `_pid`.\n\n### Proof of Concept\n\n[ConvexStakingWrapper.sol](https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol)<br>\n\n### Recommended Mitigation Steps\n\nConsider allowing users to call a public facing `_checkpoint` function once their funds have been drained to the `Shelter.sol` contract. This should ensure they receive their fair share of rewards. Careful consideration needs to be made when designing this mechanism, as by giving users full control of the `_checkpoint` function may allow them to continue receiving rewards after they have withdrawn their LP tokens.\n\n**[leekt (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/115)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/115#issuecomment-1092816117):**\n > The warden has shown how using the Shelter can cause depositors to lose yield they had accrued.\n> \n> Specifically the loss of yield will be for the time of new rewards accrued since the last `_checkpoint`.\n> \n> Moving to a global index (to compare user accrual against global rewards), or modifying the shelter to account for yield could be a potential way to mitigate.\n> \n> The sponsor confirmed and I believe medium severity to be appropriate because this is a Owner Privilege + Yield Loss finding.\n\n\n\n***\n\n## [[M-11] `ConvexStakingWrapper.enterShelter()` May Erroneously Overwrite `amountInShelter` Leading To Locked Tokens](https://github.com/code-423n4/2022-02-concur-findings/issues/109)\n_Submitted by leastwood_\n\nThe shelter mechanism provides emergency functionality in an effort to protect users' funds. The `enterShelter` function will withdraw all LP tokens from the pool, transfer them to the shelter contract and activate the shelter for the target LP token. If this function is called again on the same LP token, the `amountInShelter` value is overwritten, potentially by the zero amount. As a result  its possible that the shelter is put in a state where no users can withdraw from it or only a select few users with a finite number of shares are able to. Once the shelter has passed its grace period, these tokens may forever be locked in the shelter contract.\n\n### Proof of Concept\n\n[ConvexStakingWrapper.sol#L107-L119](https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol#L107-L119)<br>\n\n    function enterShelter(uint256[] calldata _pids) external onlyOwner {\n        for(uint256 i = 0; i<_pids.length; i++){\n            IRewardStaking pool = IRewardStaking(convexPool[_pids[i]]);\n            uint256 amount = pool.balanceOf(address(this));\n            pool.withdrawAndUnwrap(amount, false);\n            IERC20 lpToken = IERC20(\n                pool.poolInfo(_pids[i]).lptoken\n            );\n            amountInShelter[lpToken] = amount;\n            lpToken.safeTransfer(address(shelter), amount);\n            shelter.activate(lpToken);\n        }\n    }\n\n[ConvexStakingWrapper.sol#L132-L135](https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol#L132-L135)<br>\n\n    function totalShare(IERC20 _token) external view override returns(uint256) {\n        // this will be zero if shelter is not activated\n        return amountInShelter[_token];\n    }\n\n### Recommended Mitigation Steps\n\nConsider adding to the `amountInShelter[lpToken]` mapping instead of overwriting it altogether. This will allow `enterShelter` to be called multiple times with no loss of funds for the protocol's users.\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/109)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/109#issuecomment-1092826151):**\n > The finding is valid, the owner can overwrite the `amountInShelter` storage variable causing  the math in `Shelter.withdraw`. This will cause issues with distributing previously sheltered tokens.\n> \n> I believe using += instead of overwriting the value may be a sufficient remediation.\n> \n> Because this is contingent on a \"distracted / malicious\" admin, I believe Medium Severity to be appropriate.\n\n\n\n***\n\n## [[M-12] `USDMPegRecovery.provide()` Will Fail If There Is An Excess Of `usdm` Tokens](https://github.com/code-423n4/2022-02-concur-findings/issues/94)\n_Submitted by leastwood_\n\nThe `provide` function does not take a `_steps` argument and will instead calculate `addingLiquidity` by truncating amounts under `step`. As a result, if there is an excess of `usdm` such that the truncated amount exceeds the contract's `pool3` truncated balance, then the function will revert due to insufficient `pool3` collateral.\n\nThis will prevent guardians from effectively providing liquidity whenever tokens are available. Consider the following example:\n\n*   The contract has `500000e18` `usdm` tokens and `250000e18` `pool3` tokens.\n*   `addingLiquidity` will be calculated as `500000e18 / 250000e18 * 250000e18`.\n*   The function will attempt to add `500000e18` `usdm` and `pool3` tokens in which there are insufficient `pool3` tokens in the contract. As a result, it will revert even though there is an abundance of tokens that satisfy the `step` amount.\n\n### Proof of Concept\n\n[USDMPegRecovery.sol#L73-L82](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/USDMPegRecovery.sol#L73-L82)<br>\n\n    function provide(uint256 _minimumLP) external onlyGuardian {\n        require(usdm.balanceOf(address(this)) >= totalLiquidity.usdm, \"<liquidity\");\n        // truncate amounts under step\n        uint256 addingLiquidity = (usdm.balanceOf(address(this)) / step) * step;\n        // match usdm : pool3 = 1 : 1\n        uint256[2] memory amounts = [addingLiquidity, addingLiquidity];\n        usdm.approve(address(usdm3crv), addingLiquidity);\n        pool3.approve(address(usdm3crv), addingLiquidity);\n        usdm3crv.add_liquidity(amounts, _minimumLP);\n    }\n\n### Tools Used\n\nManual code review.<br>\nDiscussions with Taek.\n\n### Recommended Mitigation Steps\n\nConsider modifying the `provide` function such that a `_steps` argument can be supplied. This will allow guardians to maximise the amount of liquidity provided to the Curve pool.\n\n**[leekt (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/94)**\n\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/94#issuecomment-1095700551):**\n > The warden identified a logical fallacy that would prevent the code from providing liquidity.\n> \n> This is because the code is only accounting for one token, ignoring the other token's amount.\n> \n> Given the information I have, I agree with validity and severity of the finding. Mitigation could be achieved by following the warden's advice or by also using the balance of the `pool3` token to calculate the LP amounts.\n\n\n\n***\n\n## [[M-13] `StakingRewards.recoverERC20` allows owner to rug the `rewardsToken`](https://github.com/code-423n4/2022-02-concur-findings/issues/69)\n_Submitted by Alex the Entreprenerd, also found by pauliax_\n\n[StakingRewards.sol#L166](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/StakingRewards.sol#L166)<br>\n\n`StakingRewards.recoverERC20` rightfully checks against the `stakingToken` being sweeped away.<br>\nHowever, there's no check against the `rewardsToken` which over time will sit in this contract.\n\nThis is the case of an admin privilege, which allows the owner to sweep the rewards tokens, perhaps as a way to rug depositors.\n\n### Proof of Concept\n\nCalling `StakingRewards.recoverERC20(rewardsToken, rewardsToken.balanceOf(this))` enables the `owner` to sweep the token.\n\n### Recommended Mitigation Steps\n\nAdd an additional check\n\n            require(\n                tokenAddress != address(rewardsToken),\n                \"Cannot withdraw the rewards token\"\n            );\n\n**[leekt (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/69)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/69#issuecomment-1095712080):**\n > Because I'm judging the contest, I am forfeiting any warden winnings.\n> \n> The sponsor confirms and I believe this to be medium severity as it is contingent on a malicious owner.<br>\n> Adding the extra check removes the rug vector.\n\n\n\n***\n\n## [[M-14] Owner can steal Concur rewards](https://github.com/code-423n4/2022-02-concur-findings/issues/239)\n_Submitted by Czar102_\n\n[MasterChef.sol#L78-L80](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L78-L80)<br>\n[MasterChef.sol#L157-L180](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L157-L180)<br>\n\nOwner can steal Concur rewards by adding a depositor and inflating other depositors' assigned balance of the token within the contract. Thus, the owner-managed depositor can get most (all but one wei) of the created tokens.\n\n### Recommended Mitigation Steps\n\nDo not allow the owner to add depositors after the depositors have been configured.\n\n**[ryuheimat (Concur) disputed and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/239#issuecomment-1041831023):**\n > Owner is a multisig & timelock. New depositors can be added later as well.\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/239#issuecomment-1097277800):**\n > I think the warden could have done a better job at writing a POC.\n> \n> That said the finding is valid. The sponsor could set a `depositor` to be any EOA and because there's no transfer of tokens the balances could be inflated. Setting an immutable depositor would bring stronger security guarantees instead of allowing any contract to become a depositor.\n> \n> Because this is contingent on admin privilege, I believe medium severity to be more appropriate.\n\n\n\n***\n\n## [[M-15] Owner can lock tokens in `MasterChef`](https://github.com/code-423n4/2022-02-concur-findings/issues/238)\n_Submitted by Czar102, also found by csanuragjain and Jujic_\n\n[MasterChef.sol#L82-L84](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L82-L84)<br>\n\nOwner can remove a depositor. Since only depositors can deposit and withdraw, the owner may add a contract to the whitelist, let users deposit in the contract and remove the depositor from the whitelist. Depositor's reward cannot be withdrawn then. And takes a share of Concur tokens that will not be distributed.\n\n### Recommended Mitigation Steps\n\nRemove `onlyDepositor` modifier from the `withdraw` function.\n\n**[leekt (Concur) disputed](https://github.com/code-423n4/2022-02-concur-findings/issues/238)**\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/238#issuecomment-1097278842):**\n > The finding is valid in that the sponsor / owner can remove all depositors.\n> \n> I believe having an immutable depositor that can't be changed would give stronger security guarantees.\n> \n> While the finding is valid, because it is contingent on a malicious owner, I believe Medium Severity to be more appropriate.\n\n\n\n***\n\n## [[M-16] Rewards get diluted because `totalAllocPoint` can only increase.](https://github.com/code-423n4/2022-02-concur-findings/issues/221)\n_Submitted by throttle_\n\n[MasterChef.sol](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol)<br>\n\nThere is no functionality for removing pools/setting pool's allocPoints. Therefore `totalAllocPoint` only increases and rewards for pool decreases.\n\n### Proof of Concept\n\nScenario:\n\n1.  Owner adds new pool (first pool) for staking with points = 900 (totalAllocPoint=900).\n2.  1 week passes.\n3.  First pool staking period ends (or for other reasons that pool is not meaningfully anymore).\n4.  Owner adds new pool (second pool) for staking with points = 100 (totalAllocPoint=1000).\n5.  1 block later Alice stake 10 tokens there (at the same time).\n6.  1 week passes.\n7.  After some time Alice claims rewards. But she is eligible only for 10% of the rewards. 90% goes to unused pool.\n\n### Recommended Mitigation Steps\n\nAdd functionality for removing pool or functionality for setting pool's `totalAllocPoint` param.\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/221)**\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/221#issuecomment-1097286920):**\n > While the problem can seem trivial, the warden has proven that the contract can over time end up leaking excess value as any additional pool will dilute the `totalAllocPoint` and old pools cannot be retired.\n> \n> The sponsor also confirms.\n> \n> I believe the finding to be valid, but because the leak is contingent on settings, I believe Medium Severity to be more appropriate.\n\n\n\n***\n\n## [[M-17] Deactivate function can be bypassed](https://github.com/code-423n4/2022-02-concur-findings/issues/28)\n_Submitted by csanuragjain, also found by gzeon_\n\nonlyClient can deactivate a token even after deadline is passed and transfer all token balance to itself.\n\n### Proof of Concept\n\n1.  Navigate to contract [Shelter.sol](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/Shelter.sol)\n\n2.  Observe that token can only be deactivated if activated\\[\\_token] + GRACE_PERIOD > block.timestamp. We will bypass this\n\n3.  onlyClient activates a token X using the activate function\n\n4.  Assume Grace period is crossed such that activated\\[\\_token] + GRACE_PERIOD < block.timestamp\n\n5.  Now if onlyClient calls deactivate function, it fails with \"too late\"\n\n6.  But onlyClient can bypass this by calling activate function again on token X which will reset the timestamp to latest in activated\\[\\_token] and hence onlyClient can now call deactivate function to disable the token and retrieve all funds present in the contract to his own address\n\n### Recommended Mitigation Steps\n\nAdd below condition to activate function:\n\n    function activate(IERC20 _token) external override onlyClient {\n    require(activated[_token]==0, \"Already activated\");\n            activated[_token] = block.timestamp;\n            savedTokens[_token] = _token.balanceOf(address(this));\n            emit ShelterActivated(_token);\n        }\n\n**[leekt (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/28)**\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/28#issuecomment-1097312844):**\n > The warden has identified a way for the client to trick the shelter into sending all tokens to the client, effectively rugging all other users.\n> \n> Because this is contingent on a malicious client, I believe Medium Severity to be more appropriate.\n\n\n\n***\n\n## [[M-18] Users Will Lose Concur Rewards If The Shelter Mechanism Is Enacted On A Pool](https://github.com/code-423n4/2022-02-concur-findings/issues/116)\n_Submitted by leastwood_\n\nThe shelter mechanism aims to protect the protocol's users by draining funds into a separate contract in the event of an emergency. However, while users are able to reclaim their funds through the `Shelter.sol` contract, they will still have a deposited balance from the perspective of `ConvexStakingWrapper.sol`.\n\nHowever, if the shelter mechanism is enacted before users are able to claim their Concur rewards, any accrued tokens will be lost and the `MasterChef.sol` contract will continue to allocate tokens to the sheltered pool which will be forever locked within this contract.\n\nThere is currently no way to remove sheltered pools from the `MasterChef.sol` contract, hence any balance lost in the contract cannot be recovered due to a lack of a sweep mechanism which can be called by the contract owner.\n\n### Proof of Concept\n\n[ConvexStakingWrapper.sol](https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol)<br>\n\n[MasterChef.sol](https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/MasterChef.sol)<br>\n\n### Recommended Mitigation Steps\n\nConsider removing sheltered pools from the `MasterChef.sol` Concur token distribution. It is important to ensure `massUpdatePools` is called before making any changes to the list of pools. Additionally, removing pools from this list may also create issues with how `_pid` is produced on each new pool. Therefore, it may be worthwhile to rethink this mechanism such that `_pid` tracks some counter variable and not `poolInfo.length - 1`.\n\n**[leekt (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/116)**\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/116#issuecomment-1098587000):**\n > The warden has shown how the Shelter Mechanism can cause depositors to lose the unharvested field they were entitled to.\n> \n> This is contingent on the Shelter being used by the admin.\n> \n> For that reason (and because the finding is for loss of yield), I believe Medium Severity to be more appropriate.\n\n\n\n***\n\n## [[M-19] Rogue pool in Shelter](https://github.com/code-423n4/2022-02-concur-findings/issues/74)\n_Submitted by 0x1f8b_\n\n[Shelter.sol#L38-L42](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/Shelter.sol#L38-L42)<br>\n\nShelter contract can steal user tokens.\n\n### Proof of Concept\n\nShelter `client` can call `activate` on an already activated token, this will reset its start time, so if the client activate a token when it `GRACE_PERIOD` is almost finished, it will reset this time.<br>\nThis will prevent the user to call `withdraw` because the condition `activated[_token] + GRACE_PERIOD < block.timestamp` but will allow the client to call `deactivate` and receive all funds from the users because it will satisfy the condition `activated[_token] + GRACE_PERIOD > block.timestamp`.\n\nSteps:\n\n*   client `activate` tokenA.\n*   Users deposit tokenA using `donate`.\n*   client `activate` tokenA again until they has enough tokens.\n*   More users use `donate`.\n*   client deactivate tokenA and receive all tokens.\n\n### Recommended Mitigation Steps\n\n*   Avoid `activate` twice for the same token\n*   `donate` only after the `GRACE_PERIOD`\n\n**[leekt (Concur) disputed](https://github.com/code-423n4/2022-02-concur-findings/issues/74)**\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/74#issuecomment-1100456084):**\n > I believe the finding to be valid. The warden has shown how the Shelter design allows the client to repeatedly call `activate` to prevent anyone from withdrawing the tokens.\n> \n> Because this is contingent on a malicious admin, I believe Medium Severity to be more appropraite.\n\n\n\n***\n\n## [[M-20] `MasterChef.updatePool()` Fails To Update Reward Variables If `block.number >= endBlock`](https://github.com/code-423n4/2022-02-concur-findings/issues/107)\n_Submitted by leastwood, also found by CertoraInc, csanuragjain, Czar102, hickuphh3, kirk-baird, and WatchPug_\n\nThe `updatePool` function intends to calculate the accumulated Concur rewards by tracking the number of blocks passed since the last update to correctly determine how many Concur tokens to distribute to each share. The reward distribution has a start and end block which dictates the timeframe by which rewards will be distributed to the underlying pool.\n\nIf a pool has not recently updated itself and has reached the  `block.number >= endBlock` statement in `updatePool`, then any rewards that it would normally be entitled to prior to reaching `endBlock` will not be attributed to the pool. Therefore, once rewards are no longer being distributed, pools who had not recently called `updatePool` before reaching `endBlock` are at a disadvantage as compared to more active pools.\n\n#### Proof of Concept\n\n[MasterChef.sol#L135-L154](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L135-L154)\n\n    // Update reward variables of the given pool to be up-to-date.\n    function updatePool(uint _pid) public {\n        PoolInfo storage pool = poolInfo[_pid];\n        if (block.number <= pool.lastRewardBlock) {\n            return;\n        }\n        uint lpSupply = pool.depositToken.balanceOf(address(this));\n        if (lpSupply == 0 || pool.allocPoint == 0) {\n            pool.lastRewardBlock = block.number;\n            return;\n        }\n        if(block.number >= endBlock) {\n            pool.lastRewardBlock = block.number;\n            return;\n        }        \n\n        uint multiplier = getMultiplier(pool.lastRewardBlock, block.number);\n        uint concurReward = multiplier.mul(concurPerBlock).mul(pool.allocPoint).div(totalAllocPoint);\n        pool.accConcurPerShare = pool.accConcurPerShare.add(concurReward.mul(_concurShareMultiplier).div(lpSupply));\n        pool.lastRewardBlock = block.number;\n    }\n\n### Recommended Mitigation Steps\n\nEnsure that once the `block.number >= endBlock` statement has been reached, the `pool.accConcurPerShare` is updated to reflect the number of blocks that have passed up until `endBlock`. The number of blocks should be equal to `endBlock - pool.lastRewardBlock`. This will ensure stale pools are not negatively impacted once `endBlock` has been reached by the contract.\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/107)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/107#issuecomment-1103304716):**\n > The warden has identified a way in which the contract will not release rewards that are due for a depositor.\n> \n> Because the check doesn't accrue until the last eligible block, the reward loss can be quantified as:<br>\n> LastTimeAccrueBeforeEndBlock - endBlock\n> \n> The finding is valid, but because it pertains to loss of yield, and because the loss can be quantified and reduced by simply calling at the last available block, I believe Medium Severity to be more appropriate.\n\n\n\n***\n\n## [[M-21] [ConcurRewardPool] Possible reentrancy when claiming rewards](https://github.com/code-423n4/2022-02-concur-findings/issues/86)\n_Submitted by ShadowyNoobDev, also found by 0xw4rd3n, CertoraInc, ckksec, Czar102, defsec, Alex the Entreprenerd, Heartless, IllIllI, Jujic, kirk-baird, leastwood, pauliax, peritoflores, Randyyy, reassor, Rhynorater, Sleepy, SolidityScan, and wuwe1_\n\n[ConcurRewardPool.sol#L34](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/ConcurRewardPool.sol#L34)<br>\n\nSince the reward tokens are transferred before the balances are set to 0, it is possible to perform a reentrancy attack if the reward token has some kind of call back functionality e.g. ERC777. pBTC is an ERC777 token that is currently available on Convex. A similar attack occurred with [imBTC on uniswap v1](https://zengo.com/imbtc-defi-hack-explained/).\n\n### Proof of Concept\n\n*   Preparation\n    1.  Assume that pBTC is used as extra rewards for this victim convex pool.\n    2.  A malicious user interacts with Concur through a smart contract. He follows the standard flow and has some rewards to be claimed.\n    3.  The malicious user interacts with this smart contract to register a bad `tokensToSend()` callback function through the ERC-1820 contract.\n    4.  In this `tokensToSend()` function, he calls `ConcurRewardPool.claimRewards()` n-1 more times to drain contract.\n*   Attack\n    1.  When he calls `ConcurRewardPool.claimRewards()` for the first time, the pBTC reward tokens are transferred.\n    2.  You can see from the [pBTC contract](https://etherscan.io/address/0x5228a22e72ccc52d415ecfd199f99d0665e7733b#code) on line 871 that `_callTokensToSend(from, from, recipient, amount, \"\", \"\");` is called inside the `transfer()` function.\n    3.  If you trace to the `_callTokensToSend` function definition to line 1147, you will notice that it calls `IERC777Sender(implementer).tokensToSend(operator, from, to, amount, userData, operatorData);` on line 1159.\n    4.  Since the malicious user already registered a bad `tokensToSend()` function, this function will be called thus draining majority of the pBTC rewards available on the `ConcurRewardPool` contract.\n\nYou can also find a walkthrough replicating a similar attack [here](https://medium.com/amber-group/preventing-re-entrancy-attacks-lessons-from-history-c2d96480fac3).\n\n### Recommended Mitigation Steps\n\n*   Use a nonReentrant modifier\n*   set balances to 0 first before disbursing the rewards\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/86)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/86#issuecomment-1100908724):**\n > The warden has shown how using a specific reward token can lead to reentrancy for the function `claimRewards`.\n> \n> Because the finding is contingent on a specific token that enables the exploit, I believe Medium Severity to be appropriate.\n\n\n\n***\n\n## [[M-22] If The Staking Token Exists In Both `StakingRewards.sol` And `ConvexStakingWrapper.sol` Then It Will Be Possible To Continue Claiming Concur Rewards After The Shelter Has Been Activated](https://github.com/code-423n4/2022-02-concur-findings/issues/117)\n_Submitted by leastwood_\n\nStaking tokens are used to deposit into the `StakingRewards.sol` and `ConvexStakingWrapper.sol` contracts. Once deposited, the user is entitled to Concur rewards in proportion to their staked balance and the underlying pool's `allocPoint` in the `MasterChef.sol` contract.\n\nThe `Shelter.sol` mechanism allows the owner of the `ConvexStakingWrapper.sol` to react to emergency events and protect depositor's assets. The staking tokens can be withdrawn after the grace period has passed. However, these staking tokens can be deposited into the `StakingRewards.sol` contract to continue receiving Concur rewards not only for `StakingRewards.sol` but also for their `ConvexStakingWrapper.sol` deposited balance which has not been wiped. As a result, users are able to effectively claim double the amount of Concur rewards they should be receiving.\n\n#### Proof of Concept\n\n[MasterChef.sol](https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/MasterChef.sol)<br>\n\n[StakingRewards.sol](https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/StakingRewards.sol)<br>\n\n[ConvexStakingWrapper.sol](https://github.com/code-423n4/2022-02-concur/blob/shelter-client/contracts/ConvexStakingWrapper.sol)<br>\n\n### Recommended Mitigation Steps\n\nEnsure that staking tokens cannot be deposited in both the `StakingRewards.sol` and `ConvexStakingWrapper.sol` contracts. If this is intended behaviour, it may be worthwhile to ensure that the sheltered users have their deposited balance wiped from the `MasterChef.sol` contract upon being sheltered.\n\n**[leekt (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/117)**\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/117#issuecomment-1101852856):**\n > The warden has shown that because the shelter mechanism doesn't wipe the balance in the contract, those same tokens can be used to further break the accounting of the contract, with the goal of extracting further rewards.\n> \n> While I believe the wardens work is commendable and have considered High Severity because the accounting of the protocol has been broken, I believe Medium Severity to be more appropriate because the finding:\n> - Is contingent on the Shelter being used\n> - There must be more rewards in the StakingRewardsContract\n> - The impact is limited to the additional rewards and nothing else\n\n\n\n***\n\n## [[M-23] Transfer to treasury can register as succeeded when failing in `_calcRewardIntegral`](https://github.com/code-423n4/2022-02-concur-findings/issues/120)\n_Submitted by 0xw4rd3n_\n\n[StakingRewards.sol#L126](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L126)<br>\n\nIf the transfer of the reward token fails to the treasury (due to insufficient funds for example), the function `_calcRewardIntegral` will still update accounting and cause devastating accounting discrepancies in the contract.\n\n### Proof of Concept\n\nProvide direct links to all referenced code in GitHub. Add screenshots, logs, or any other relevant proof that illustrates the concept.\n\n### Recommended Mitigation Steps\n\n`require(IERC20(reward.token).transfer(treasury, d_reward / 5), \"ERROR_MESSAGE\");`\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/120)**\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/120#issuecomment-1101854716):**\n > All in all this report is the classic \"No safeApprove\". But with an actual idea of a POC.<br>\n> Ultimately the risk is contingent on the specific reward.token being a nonRevertingOnError.\n> \n> For that reason, I believe Medium Severity to be more appropriate.\n\n\n\n***\n\n## [[M-24] Rewards distribution can be disrupted by a early user](https://github.com/code-423n4/2022-02-concur-findings/issues/193)\n_Submitted by WatchPug_\n\n[ConvexStakingWrapper.sol#L184-L188](https://github.com/code-423n4/2022-02-concur/blob/02d286253cd5570d4e595527618366f77627cdaf/contracts/ConvexStakingWrapper.sol#L184-L188)<br>\n\n```solidity\nif (_supply > 0 && d_reward > 0) {\n    reward.integral =\n        reward.integral +\n        uint128((d_reward * 1e20) / _supply);\n}\n```\n\n`reward.integral` is `uint128`, if an early user deposits with just `1` Wei of `lpToken`, and make `_supply == 1`, and then transferring `5e18` of `reward_token` to the contract.\n\nAs a result, `reward.integral` can exceed `type(uint128).max` and overflow, causing the rewards distribution to be disrupted.\n\n### Recommended Mitigation Steps\n\nConsider `wrap` a certain amount of initial totalSupply at deployment, e.g. `1e8`, and never burn it. And consider using uint256 instead of uint128 for `reward.integral`. Also, consider lower `1e20` down to `1e12`.\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/193)**\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/193#issuecomment-1102684394):**\n > The warden has shown a way to break the uint128 accounting system in place.\n> \n> This is contingent on frontrunning the pool and depositing a small amount to cause the division to fail.<br>\n> Additionally, this will cause a DOS that prevents other people from depositing.\n> \n> I believe that this could be unstuck by continuously (via loop) depositing 1 wei as to slowly increase the totalSupply again.\n> \n> Mitigation can be attained by either refactoring or by ensuring that the first deposit is big enough (18 decimals) to keep numbers to rational values.\n> \n> Because the finding is contingent on a setup and because tokens will be rescuable, I believe Medium Severity to be more appropriate.\n\n\n\n***\n\n## [[M-25] `ConvexStakingWrapper#deposit()` depositors may lose their funds when the `_amount` is huge](https://github.com/code-423n4/2022-02-concur-findings/issues/194)\n_Submitted by WatchPug, also found by danb, gzeon, Heartless, and pauliax_\n\nWhen the value of `_amount` is larger than `type(uint192).max`, due to unsafe type casting, the recorded deposited amount can be much smaller than their invested amount.\n\n[ConvexStakingWrapper.sol#L228-L250](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L228-L250)<br>\n\n```solidity\nfunction deposit(uint256 _pid, uint256 _amount)\n    external\n    whenNotPaused\n    nonReentrant\n{\n    _checkpoint(_pid, msg.sender);\n    deposits[_pid][msg.sender].epoch = currentEpoch();\n    deposits[_pid][msg.sender].amount += uint192(_amount);\n    if (_amount > 0) {\n        IERC20 lpToken = IERC20(\n            IRewardStaking(convexPool[_pid]).poolInfo(_pid).lptoken\n        );\n\n        lpToken.safeTransferFrom(msg.sender, address(this), _amount);\n        lpToken.safeApprove(convexBooster, _amount);\n        IConvexDeposits(convexBooster).deposit(_pid, _amount, true);\n        lpToken.safeApprove(convexBooster, 0);\n        uint256 pid = masterChef.pid(address(lpToken));\n        masterChef.deposit(msg.sender, pid, _amount);\n    }\n\n    emit Deposited(msg.sender, _amount);\n}\n```\n\n### Proof of Concept\n\nWhen `_amount` = `uint256(type(uint192).max) + 1`:\n\n*   At L235, `uint192(_amount)` = `0`, `deposits[_pid][msg.sender].amount` = `0`;\n*   At L241, `uint256(type(uint192).max) + 1` will be transferFrom `msg.sender`.\n\nExpected results:\n\n`deposits[_pid][msg.sender].amount` == `uint256(type(uint192).max) + 1`;\n\nActual results:\n\n`deposits[_pid][msg.sender].amount` = `0`.\n\nThe depositor loses all their invested funds.\n\n### Recommended Mitigation Steps\n\nConsider adding a upper limit for the `_amount` parameter:\n\n```solidity\nrequire(_amount <= type(uint192).max, \"...\");\n```\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/194)**\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/194#issuecomment-1102717086):**\n > The warden has shown how casting without safe checks can cause the accounting to break and cause end users to lose deposited tokens.\n> \n> While the finding has merit, I believe that because this applies to niche situations, and is conditional on specific inputs, that Medium Severity is more appropriate.\n\n\n\n***\n\n## [[M-26] `StakingRewards.setRewardsDuration` allows setting near zero or enormous `rewardsDuration`, which breaks reward logic](https://github.com/code-423n4/2022-02-concur-findings/issues/223)\n_Submitted by hyh_\n\nnotifyRewardAmount will be inoperable if rewardsDuration is set to zero. If will cease to produce meaningful results if rewardsDuration is too small or too big.\n\n### Proof of Concept\n\nThe setter does not control the value, allowing zero/near zero/enormous duration:\n\n[StakingRewards.sol#L178-185](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/StakingRewards.sol#L178-185)\n\nDivision by the duration is used in notifyRewardAmount:\n\n[StakingRewards.sol#L143-156](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/StakingRewards.sol#L143-156)\n\n### Recommended Mitigation Steps\n\nCheck for min and max range in the rewardsDuration setter, as too small or too big rewardsDuration breaks the logic.\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/223)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/223#issuecomment-1102777977):**\n > Finding is valid. Ultimately contingent on admin privilege so I believe Medium Severity to be appropriate.\n\n\n\n***\n\n## [[M-27] `MasterChef.sol` A `depositor` can deposit an arbitrary amount without no cost](https://github.com/code-423n4/2022-02-concur-findings/issues/208)\n_Submitted by WatchPug, also found by cmichel_\n\nThe owner of `MasterChef.sol` can add a `depositor` with `addDepositor()`.\n\n[MasterChef.sol#L78-L80](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L78-L80)<br>\n\n```solidity\nfunction addDepositor(address _depositor) external onlyOwner {\n    isDepositor[_depositor] = true;\n}\n```\n\nA `depositor` can deposit with an arbitrary amount, without any cost.\n\n[MasterChef.sol#L157-L180](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L157-L180)<br>\n\n```solidity\nfunction deposit(address _recipient, uint _pid, uint _amount) external nonReentrant onlyDepositor {\n    PoolInfo storage pool = poolInfo[_pid];\n    UserInfo storage user = userInfo[_pid][_msgSender()];\n    updatePool(_pid);\n    \n    if(user.amount > 0) {  \n        uint pending = user.amount * pool.accConcurPerShare / _concurShareMultiplier - user.rewardDebt;\n        if (pending > 0) {\n            safeConcurTransfer(_recipient, pending);\n        }\n    }\n\n    if (_amount > 0) {\n        if (pool.depositFeeBP > 0) {\n            uint depositFee = _amount.mul(pool.depositFeeBP).div(_perMille);\n            user.amount = SafeCast.toUint128(user.amount + _amount - depositFee);\n        } else {\n            user.amount = SafeCast.toUint128(user.amount + _amount);\n        }\n    }     \n\n    user.rewardDebt = SafeCast.toUint128(user.amount * pool.accConcurPerShare / _concurShareMultiplier);\n    emit Deposit(_recipient, _pid, _amount);\n}\n```\n\nThis allows a malicious/compromised depositor to take the majority share (nearly 100%) of all pools simply by calling `deposit()` with extremely large amounts, and take all the rewards.\n\n### Recommended Mitigation Steps\n\nSee the `Recommendation` section on [issue #200](https://github.com/code-423n4/2022-02-concur-findings/issues/200) and remove the `depositor` role.\n\n**[ryuheimat (Concur) disputed and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/208#issuecomment-1041878778):**\n > This function will be called by whitelisted depositor contract and the actual token transfer will be done there.\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/208#issuecomment-1102815322):**\n > Because the're a mapping that allows any contract to be set as depositor, I believe the warden has shown a potential admin privilege that can cause issues with the fair distribution of rewards.\n> \n> Because this is contingent on a malicious admin, I believe Medium Severity to be more appropriate.\n> \n> Mitigation would be as simple as having one depositor, alternative a more complicated architecture may need to be used.\n\n\n\n***\n\n## [[M-28] During stake or deposit, users would not be rewarded the correct Concur token, when MasterChef has under-supply of it](https://github.com/code-423n4/2022-02-concur-findings/issues/262)\n_Submitted by hubble, also found by CertoraInc and Czar102_\n\nDuring stake or deposit, users would not be transferred the correct Concur token, when MasterChef has under-supply of it.\n\nThere is an assumption that MasterChef contract would own enough Concur tokens so as to distribute to users as reward, during deposit or withdraw. But say, due to excess user activity, MasterChef runs out of Concur tokens. All deposits & withdraws that happen after that, would have zero transfer of Concur token to the user. This will continue until the MasterChef contract is replenished again.\n\n### Proof of Concept\n\n[MasterChef.sol#L205-L206](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L205-L206)<br>\n\nMakeshift unit test\nNote: Temporarily modify the private function MasterChef.safeConcurTransfer to public function, for unit test validation\n\n```bash\n//Unit Test starts\n  it(\"MasterChef - Zero Concur balance\", async function() {\n    await concurToken.mint(masterChef.address, 100);\n    console.log(await concurToken.balanceOf(masterChef.address), await concurToken.balanceOf(user1.address));\n    await masterChef.safeConcurTransfer(user1.address, 60); // user1 is rewarded correctly.\n    console.log(await concurToken.balanceOf(masterChef.address), await concurToken.balanceOf(user1.address));\n    await masterChef.safeConcurTransfer(user1.address, 60); // user1 is rewarded lesser by 10.\n    console.log(await concurToken.balanceOf(masterChef.address), await concurToken.balanceOf(user1.address));\n    await masterChef.safeConcurTransfer(user1.address, 60); // user1 is totally not rewarded.\n    console.log(await concurToken.balanceOf(masterChef.address), await concurToken.balanceOf(user1.address));\n  });\n//Unit Test ends\n```\n\n### Tools Used\n\nManual review, & makeshift Unit test\n\n### Recommended Mitigation Steps\n\nMinimal recommended fix:\n\nTo `MasterChef.safeConcurTransfer` function, add the following require statement. This will at least ensure that, when there is zero balance in MasterChef contract, the safeConcurTransfer function will not succeed.\n\n```bash\n    function safeConcurTransfer(address _to, uint _amount) private {\n        uint concurBalance = concur.balanceOf(address(this));\n        require(concurBalance>0, \"safeConcurTransfer: balance is zero.\");\n```\n\n**[leekt (Concur) acknowledged](https://github.com/code-423n4/2022-02-concur-findings/issues/262)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/262#issuecomment-1088033822):**\n > The finding is valid as in that depositors could not receive token incentives, am not fully convinced this should be of medium severity as ultimately the contract will eventually run out of tokens and as such this is a situation that has to be handled.\n> \n> If anything, reverting may cause the tokens to be stuck.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/262#issuecomment-1103027832):**\n > While I feel like this is a situational finding, it ultimately is a loss of yield finding with a very clear example.<br>\n> For that reason I believe Medium Severity to be appropriate.\n\n\n\n***\n\n## [[M-29] `ConvexStakingWrapper` deposits and withdraws will frequently be disabled if a token that doesn't allow zero value transfers will be added as a reward one](https://github.com/code-423n4/2022-02-concur-findings/issues/231)\n_Submitted by hyh_\n\nIf deposits and withdraws are done frequently enough, the reward update operation they invoke will deal mostly with the case when there is nothing to add yet, i.e. `reward.remaining` match the reward token balance.\n\nIf reward token doesn't allow for zero value transfers, the reward update function will fail on an empty incremental reward transfer, which is now done unconditionally, reverting the caller deposit/withdrawal functionality\n\n### Proof of Concept\n\nWhen ConvexStakingWrapper isn't paused, every deposit and withdraw update current rewards via `_checkpoint` function before proceeding:\n\n[ConvexStakingWrapper.sol#L233](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/ConvexStakingWrapper.sol#L233)<br>\n\n[ConvexStakingWrapper.sol#L260](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/ConvexStakingWrapper.sol#L260)<br>\n\n`_checkpoint` calls `_calcRewardIntegral` for each of the reward tokens of the pid:\n\n[ConvexStakingWrapper.sol#L220](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/ConvexStakingWrapper.sol#L220)<br>\n\n`_calcRewardIntegral` updates the incremental reward for the token, running the logic even if reward is zero, which is frequently the case:\n\n[ConvexStakingWrapper.sol#L182](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/ConvexStakingWrapper.sol#L182)<br>\n\nIf the reward token doesn't allow zero value transfers, this transfer will fail, reverting the corresponding deposit or withdraw.\n\n### Recommended Mitigation Steps\n\nConsider checking the reward before doing transfer (and the related computations as an efficiency measure):\n\nNow:\n\n    IERC20(reward.token).transfer(address(claimContract), d_reward);\n\nTo be:\n\n    if (d_reward > 0)\n    \tIERC20(reward.token).transfer(address(claimContract), d_reward);\n\n**[ryuheimat (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/231)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/231#issuecomment-1103083291):**\n > The warden has shown how, due to a pattern that always transfers the reward token to the claim contract, in the case of a 0 transfer, certain transfers could fail, causing reverts.\n> \n> While there can be an argument that this finding may not happen in reality, I believe that ultimately the system has been shown to be flawed in it's conception, perhaps adding a storage variable for the amount to claim would be more appropriate instead of dripping the rewards each time.\n> \n> For that reason, and because the finding is contingent on a reward token that does revert on 0 transfer, I believe Medium Severity to be appropriate.\n\n\n\n***\n\n## [[M-30] `StakingRewards` reward rate can be dragged out and diluted](https://github.com/code-423n4/2022-02-concur-findings/issues/183)\n_Submitted by cmichel_\n\n[StakingRewards.sol#L161](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L161)<br>\n\nThe `StakingRewards.notifyRewardAmount` function receives a `reward` amount and extends the current reward end time to `now + rewardsDuration`.<br>\nIt rebases the currently remaining rewards + the new rewards (`reward + leftover`) over this new `rewardsDuration` period.\n\n```solidity\nfunction withdraw(IERC20 _token, address _to) external override {\n    require(activated[_token] != 0 && activated[_token] + GRACE_PERIOD < block.timestamp, \"shelter not activated\");\n    // @audit uses `msg.sender`'s share but sets `claimed` for _to! can claim for many `_to`s\n    uint256 amount = savedTokens[_token] * client.shareOf(_token, msg.sender) / client.totalShare(_token);\n    claimed[_token][_to] = true;\n    emit ExitShelter(_token, msg.sender, _to, amount);\n    _token.safeTransfer(_to, amount);\n}\n```\n\nThis can lead to a dilution of the reward rate and rewards being dragged out forever by malicious new reward deposits.\n\n### Proof of Concept\n\nImagine the current rewardRate is `1000 rewards / rewardsDuration`.<br>\n20% of the `rewardsDuration` passed, i.e., `now = lastUpdateTime + 20% * rewardsDuration`.<br>\nA malicious actor notifies the contract with a reward of `0`: `notifyRewardAmount(0)`.<br>\nThen the new `rewardRate = (reward + leftover) / rewardsDuration = (0 + 800) / rewardsDuration = 800 / rewardsDuration`.<br>\nThe `rewardRate` just dropped by 20%.<br>\nThis can be repeated infinitely.<br>\nAfter another 20% of reward time passed, they trigger `notifyRewardAmount(0)` to reduce it by another 20% again:<br>\n`rewardRate = (0 + 640) / rewardsDuration = 640 / rewardsDuration`.\n\n### Recommended Mitigation Steps\n\nImo, the `rewardRate` should never decrease by a `notifyRewardAmount` call.<br>\nConsider not extending the reward payouts by `rewardsDuration` on every call.<br>\n`periodFinish` probably shouldn't change at all, the `rewardRate` should just increase by `rewardRate += reward / (periodFinish - block.timestamp)`.\n\nAlternatively, consider keeping the `rewardRate` constant but extend `periodFinish` time by `+= reward / rewardRate`.\n\n**[ryuheimat (Concur) disputed and commented](https://github.com/code-423n4/2022-02-concur-findings/issues/183#issuecomment-1043693880):**\n > notifyRewardAmount check msg.sender's permission.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/183#issuecomment-1103139704):**\n > The warden is pointing out an admin privilege that would allow the admin to dilute current rewards.\n> \n> While the sponsor claims this won't happen, I can only judge based on the code that is available to me.<br>\n> And at this point there seems to be no code for the `rewardsDistribution` contract that would be calling `notifyRewardAmount`\n> \n> Given this, I believe the finding to be valid as the POC works out to demonstrate how a malicious owner could dilute the rewardRate.\n> \n> This would cause loss of yield for all depositors, which makes the finding of Medium Severity.\n\n\n\n***\n\n## [[M-31] execute in VoteProxy should be payable](https://github.com/code-423n4/2022-02-concur-findings/issues/17)\n_Submitted by wuwe1_\n\n`execute` will revert when `msg.value > 0`\n\n### Proof of Concept\n\nLacking `payable` mutability specifier.\n\n[VoteProxy.sol#L28-L35](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/VoteProxy.sol#L28-L35)<br>\n\n```solidity\n    function execute(\n        address _to,\n        uint256 _value,\n        bytes calldata _data\n    ) external onlyOwner returns (bool, bytes memory) {\n        (bool success, bytes memory result) = _to.call{value: _value}(_data);\n        return (success, result);\n    }\n```\n\n### Recommended Mitigation Steps\n\nAdd `payable` mutability specifier.\n\n**[leekt (Concur) confirmed](https://github.com/code-423n4/2022-02-concur-findings/issues/17)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/17#issuecomment-1095728527):**\n > @leekt Can you tell me what you'd need [`execute`](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/VoteProxy.sol#L28) to be used for?\n> \n> Do you really need it to be payable?\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/17#issuecomment-1103158805):**\n > After some thinking, I do believe that it would be wise to allow for payable calls.\n> \n> Will mark as valid and because this is contingent on a specific usage, I think Medium Severity to be appropriate.\n\n\n\n***\n\n\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 36 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-02-concur-findings/issues/128) by **hickuphh3** received the top score from the judge.\n\n*The following wardens also submitted reports: [wuwe1](https://github.com/code-423n4/2022-02-concur-findings/issues/36), [pauliax](https://github.com/code-423n4/2022-02-concur-findings/issues/254), [kenta](https://github.com/code-423n4/2022-02-concur-findings/issues/171), [IllIllI](https://github.com/code-423n4/2022-02-concur-findings/issues/161), [WatchPug](https://github.com/code-423n4/2022-02-concur-findings/issues/217), [hyh](https://github.com/code-423n4/2022-02-concur-findings/issues/227), [gzeon](https://github.com/code-423n4/2022-02-concur-findings/issues/197), [csanuragjain](https://github.com/code-423n4/2022-02-concur-findings/issues/26), [0x1f8b](https://github.com/code-423n4/2022-02-concur-findings/issues/80), [SolidityScan](https://github.com/code-423n4/2022-02-concur-findings/issues/215), [CertoraInc](https://github.com/code-423n4/2022-02-concur-findings/issues/163), [samruna](https://github.com/code-423n4/2022-02-concur-findings/issues/13), [cccz](https://github.com/code-423n4/2022-02-concur-findings/issues/62), [defsec](https://github.com/code-423n4/2022-02-concur-findings/issues/198), [Dravee](https://github.com/code-423n4/2022-02-concur-findings/issues/263), [Randyyy](https://github.com/code-423n4/2022-02-concur-findings/issues/230), [Ruhum](https://github.com/code-423n4/2022-02-concur-findings/issues/66), [robee](https://github.com/code-423n4/2022-02-concur-findings/issues/45), [Czar102](https://github.com/code-423n4/2022-02-concur-findings/issues/241), [BouSalman](https://github.com/code-423n4/2022-02-concur-findings/issues/65), [ShadowyNoobDev](https://github.com/code-423n4/2022-02-concur-findings/issues/85), [throttle](https://github.com/code-423n4/2022-02-concur-findings/issues/174), [ye0lde](https://github.com/code-423n4/2022-02-concur-findings/issues/220), [Sleepy](https://github.com/code-423n4/2022-02-concur-findings/issues/186), [cryptphi](https://github.com/code-423n4/2022-02-concur-findings/issues/63), [harleythedog](https://github.com/code-423n4/2022-02-concur-findings/issues/145), [kirk-baird](https://github.com/code-423n4/2022-02-concur-findings/issues/19), [leastwood](https://github.com/code-423n4/2022-02-concur-findings/issues/98), [peritoflores](https://github.com/code-423n4/2022-02-concur-findings/issues/201), [rfa](https://github.com/code-423n4/2022-02-concur-findings/issues/248), [Rhynorater](https://github.com/code-423n4/2022-02-concur-findings/issues/261), [bitbopper](https://github.com/code-423n4/2022-02-concur-findings/issues/153), [mtz](https://github.com/code-423n4/2022-02-concur-findings/issues/253), [0xw4rd3n](https://github.com/code-423n4/2022-02-concur-findings/issues/127), and [hubble](https://github.com/code-423n4/2022-02-concur-findings/issues/202).*\n\n## Codebase Impressions & Summary\n\nOverall, code quality was fair. A number of contracts were taken from various sources, such as StakingRewards, Masterchef and the ConvexStakingWrapper. Modifications were made to include custom features like taking a 20% fee on CVX and CRV rewards for the treasury, and to not require stake token transfers for deposits / withdrawals into the Masterchef contract.\n\nI found `10` high severity issues, majority of which are found in the Masterchef contract. They were simple logic bugs that would have been discovered with unit tests.\n\nIn addition, I made `2` medium severity, `7` low severity, and `1` non-critical findings.\n\nNote that during the contest, an example shelter client was added and pushed to a [new branch](https://github.com/code-423n4/2022-02-concur/tree/shelter-client/contracts) for wardens to understand how the shelter would operate. The integration of the ConvexStakingWrapper with the Shelter in that branch has a few bugs, but I assume it is outside the current contest scope to report them.\n\nDue to the number of issues raised, I strongly recommend the team to write unit tests for their contracts, and to consider running a mitigation contest.\n\n## [L-01]: Masterchef: pendingConcur() shows increasing reward amounts after mining period ends\n\n### Line References\n\n[MasterChef.sol#L113-L124](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L113-L124)\n\n### Description\n\nEven though rewards distribution cease after `endBlock`, `pendingConcur()` will calculate as if reward distribution has not.\n\nDistribution of rewards will cease after `endBlock`, but `pendingConcur()` will show increasing pending rewards because it does not account for `endBlock`.\n\n### Recommended Mitigation Steps\n\n```jsx\nfunction pendingConcur(uint _pid, address _user) external view returns (uint) {\n\t...\n\t// take the minimum of endBlock and currentBlock\n\tuint endRewardBlock = endBlock >= block.number ? block.number : endBlock;\n\tif (endRewardBlock > pool.lastRewardBlock && lpSupply != 0) {\n\t\tuint multiplier = getMultiplier(pool.lastRewardBlock, endRewardBlock);\n\t\t...\n\t}\n\t...\n}\n```\n\n## [L-02]: Masterchef: `safeConcurTransfer()` potentially reverts for zero amount\n\n### Line References\n\n[MasterChef.sol#L205-L210](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L205-L210)\n\n### Description\n\nIf the contract has zero concur tokens, the following may revert because of zero amount. This is of course dependent on the concur token implementation.\n\n```jsx\n// couple of lines omitted\ntransferSuccess = concur.transfer(_to, concurBalance);\nrequire(transferSuccess, \"safeConcurTransfer: transfer failed\"); \n```\n\n## [L-03]: ConvexStakingWrapper: Small rounding error in `_calcRewardIntegral()`\n\n### Line References\n\n[ConvexStakingWrapper.sol#L179-L180](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/ConvexStakingWrapper.sol#L179-L180)\n\n### Description\n\nThe treasury takes a 20% fee of rewards. The calculation will possibly leave 1 wei unaccounted for.\n\n```jsx\nIERC20(reward.token).transfer(treasury, d_reward / 5);\nd_reward = (d_reward * 4) / 5;\n```\n\nFor instance, assume `d_reward = 21`. The treasury receives `4` wei while the user receives `16` wei, leaving 1 wei unaccounted for.\n\n### Recommended Mitigation Steps\n\n```jsx\nuint256 rewardFee = d_reward / 5;\nIERC20(reward.token).transfer(treasury, rewardFee);\nd_reward -= rewardFee;\n```\n\n## [L-04]: USDMPegRecovery: 40M or 4M threshold?\n\n### Line References\n\n[USDMPegRecovery.sol#L100](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/USDMPegRecovery.sol#L100)\n\n### Description\n\nThe README says *“Once 40m USDM is deposited, 3Crv side of the contract starts accepting deposits.”* However, the code accepts 3CRV deposits after 4M USDM is deposited instead.\n\n### Recommended Mitigation Steps\n\nSpecify the threshold as an internal constant, and use underscores for readability. I also recommend double-checking the values of declared variables in all contracts, such as `step` and `concurPerBlock`.\n\n```jsx\nuint256 internal constant MIN_USDM_AMOUNT = 40_000_000e18;\nrequire(totalLiquidity.usdm > MIN_USDM_AMOUNT, \"usdm low\");\n\n// or\nrequire(totalLiquidity.usdm > 40_000_000e18, \"usdm low\");\n```\n\n## [N-01]: Masterchef: Incorrect comment on endBlock\n\n### Line References\n\n[MasterChef.sol#L52-L53](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L52-L53)\n\n### Description\n\n`uint public endBlock; // The block number when mining starts.` is incorrect, as it should be the end of the mining period, not the start. Its comment applies to `startBlock`.\n\nNote that `uint public startBlock` does not have a comment. Consider adding it.\n\n### Recommended Mitigation Steps\n\n```jsx\nuint public startBlock; // The block number when mining starts.\nuint public endBlock; // The block number when mining ends.\n```\n\n## [N-02]: StakingRewards: Incorrect revert statement in `setRewardsDistribution()`\n\n### Line References\n\n[StakingRewards.sol#L191-L194](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/StakingRewards.sol#L191-L194)\n\n### Description\n\n`setRewardsDistribution()` has the following check:\n\n```jsx\nrequire(\n  block.timestamp > periodFinish,\n  \"Previous rewards period must be complete before changing the duration for the new period\"\n);\n```\n\nThe statement is incorrect because it’s `rewardsDistribution` that is being changed, not the rewards duration.\n\n### Recommended Mitigation Steps\n\nActually, the check is redundant, because there is no harm changing `rewardsDistribution` while distribution is ongoing. I suggest removing the check entirely. Otherwise, change the comment to \n\n`\"Previous rewards period must be complete before changing rewardsDistribution\"`\n\n## [N-03]: Masterchef: RADSs → Concurs\n\n[MasterChef.sol#L25](https://github.com/code-423n4/2022-02-concur/blob/main/contracts/MasterChef.sol#L25)\n\nRename `RADSs` to `Concurs`\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/128#issuecomment-1110223177):**\n > [L-01]: Masterchef: pendingConcur() shows increasing reward amounts after mining period ends<br>\n> Valid finding\n> \n> [L-02]: Masterchef: safeConcurTransfer() potentially reverts for zero amount<br>\n> I don't believe it will cause issues, but think 0 check is low per industry standard.\n> \n> [L-03]: ConvexStakingWrapper: Small rounding error in _calcRewardIntegral()<br>\n> After further consideration, I agree.\n> \n> [L-04]: USDMPegRecovery: 40M or 4M threshold?<br>\n> I feel like this is the only case where I'd give low vs non-critical as the comment and the code have a meaningful, and significant difference for the end users.\n> \n> [N-01]: Masterchef: Incorrect comment on endBlock<br>\n> Non-critical IMO\n> \n> [N-02]: StakingRewards: Incorrect revert statement in setRewardsDistribution()<br>\n> Disagree with [low] severity.\n> \n> [N-03]: Masterchef: RADSs → Concurs<br>\n> Valid finding.\n\nReport has plenty of content, formatting is good, I think most findings are over-emphasized though and under further scrutiny this is basically equivalent to 4 findings.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/128#issuecomment-1110224140):**\n > Adding [#137](https://github.com/code-423n4/2022-02-concur-findings/issues/137) does make the report more well rounded and adding [#136](https://github.com/code-423n4/2022-02-concur-findings/issues/136) makes this the most interesting report thus far, 6.5 findings at this time\n>\n> 6++ with very good formatting\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/128#issuecomment-1112664899):**\n > [L-01]: Masterchef: pendingConcur() shows increasing reward amounts after mining period ends<br>\n> Low\n> \n> [L-02]: Masterchef: safeConcurTransfer() potentially reverts for zero amount<br>\n> Low\n> \n> [L-03]: ConvexStakingWrapper: Small rounding error in _calcRewardIntegral()<br>\n> Low\n> \n> [L-04]: USDMPegRecovery: 40M or 4M threshold?<br>\n> Low\n>\n> [N-01]: Masterchef: Incorrect comment on endBlock<br>\n> Non-Critical\n> \n> [N-02]: StakingRewards: Incorrect revert statement in setRewardsDistribution()<br>\n> Non Critical\n> \n> [N-03]: Masterchef: RADSs → Concurs<br>\n> Non-Critical\n> \n> [#137](https://github.com/code-423n4/2022-02-concur-findings/issues/137) -> Non-Critical\n> \n> [#136](https://github.com/code-423n4/2022-02-concur-findings/issues/136) -> Low Severity\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 33 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-02-concur-findings/issues/216) by **WatchPug** received the top score from the judge.\n\n*The following wardens also submitted reports: [throttle](https://github.com/code-423n4/2022-02-concur-findings/issues/167), [csanuragjain](https://github.com/code-423n4/2022-02-concur-findings/issues/24), [Dravee](https://github.com/code-423n4/2022-02-concur-findings/issues/203), [pauliax](https://github.com/code-423n4/2022-02-concur-findings/issues/256), [0x1f8b](https://github.com/code-423n4/2022-02-concur-findings/issues/73), [Jujic](https://github.com/code-423n4/2022-02-concur-findings/issues/110), [BouSalman](https://github.com/code-423n4/2022-02-concur-findings/issues/25), [defsec](https://github.com/code-423n4/2022-02-concur-findings/issues/211), [Ruhum](https://github.com/code-423n4/2022-02-concur-findings/issues/67), [hickuphh3](https://github.com/code-423n4/2022-02-concur-findings/issues/129), [rfa](https://github.com/code-423n4/2022-02-concur-findings/issues/247), [robee](https://github.com/code-423n4/2022-02-concur-findings/issues/44), [0xngndev](https://github.com/code-423n4/2022-02-concur-findings/issues/185), [kenta](https://github.com/code-423n4/2022-02-concur-findings/issues/169), [ye0lde](https://github.com/code-423n4/2022-02-concur-findings/issues/91), [gzeon](https://github.com/code-423n4/2022-02-concur-findings/issues/192), [bitbopper](https://github.com/code-423n4/2022-02-concur-findings/issues/154), [SolidityScan](https://github.com/code-423n4/2022-02-concur-findings/issues/218), [wuwe1](https://github.com/code-423n4/2022-02-concur-findings/issues/37), [0x0x0x](https://github.com/code-423n4/2022-02-concur-findings/issues/258), [0xNot0rious](https://github.com/code-423n4/2022-02-concur-findings/issues/265), [Tomio](https://github.com/code-423n4/2022-02-concur-findings/issues/245), [0x510c](https://github.com/code-423n4/2022-02-concur-findings/issues/40), [Heartless](https://github.com/code-423n4/2022-02-concur-findings/issues/2), [mtz](https://github.com/code-423n4/2022-02-concur-findings/issues/255), [Randyyy](https://github.com/code-423n4/2022-02-concur-findings/issues/233), [Sleepy](https://github.com/code-423n4/2022-02-concur-findings/issues/168), [IllIllI](https://github.com/code-423n4/2022-02-concur-findings/issues/259), [sabtikw](https://github.com/code-423n4/2022-02-concur-findings/issues/41), [ShadowyNoobDev](https://github.com/code-423n4/2022-02-concur-findings/issues/84), [peritoflores](https://github.com/code-423n4/2022-02-concur-findings/issues/228), and [CertoraInc](https://github.com/code-423n4/2022-02-concur-findings/issues/164).*\n\n## \\[G-01] Cache external call result in the stack can save gas\n\n*Note: Suggested optimation, save a decent amount of gas without compromising readability.*\n\nEvery call to an external contract costs a decent amount of gas. For optimization of gas usage, external call results should be cached if they are being used for more than one time.\n\nFor example:\n\n[ConvexStakingWrapper.sol#L93-L140](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L93-L140)<br>\n\n```solidity\nfunction addRewards(uint256 _pid) public {\n    address mainPool = IRewardStaking(convexBooster)\n        .poolInfo(_pid)\n        .crvRewards;\n    if (rewards[_pid].length == 0) {\n        pids[IRewardStaking(convexBooster).poolInfo(_pid).lptoken] = _pid;\n        // ...\n    }\n    // ...\n}\n```\n\n`IRewardStaking(convexBooster).poolInfo(_pid)` can be cached to avoid an extra external call.\n\n## \\[G-02] Cache external call result in storage can save gas\n\n*Note: Suggested optimation, save a decent amount of gas without compromising readability.*\n\nFor the unchanged results of an external call that will be reused multiple times, cache and read from storage rather than initiate a fresh external call can save gas.\n\nInstances include:\n\n[ConvexStakingWrapper.sol#L237-L239](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L237-L239)<br>\n\n```solidity\nIERC20 lpToken = IERC20(\n    IRewardStaking(convexPool[_pid]).poolInfo(_pid).lptoken\n);\n```\n\n[ConvexStakingWrapper.sol#L264-L266](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L264-L266)>br\n\n```solidity\nIERC20 lpToken = IERC20(\n    IRewardStaking(convexPool[_pid]).poolInfo(_pid).lptoken\n);\n```\n\n`lpToken` of `_pid` can be cached when `addRewards()` to avoid extra external calls.\n\n## \\[G-03] \\`SafeMath is no longer needed\n\n*Note: Suggested optimation, save a decent amount of gas without compromising readability.*\n\n`SafeMath` is no longer needed starting with Solidity 0.8. The compiler now has built in overflow checking.\n\nRemoving `SafeMath` can save some gas.\n\nInstances include:\n\n[MasterChef.sol#L89-L89](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L89-L89)<br>\n\n```solidity\ntotalAllocPoint = totalAllocPoint.add(_allocationPoints);\n```\n\n[MasterChef.sol#L109-L109](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L109-L109)<br>\n\n```solidity\nreturn _to.sub(_from);\n```\n\n[MasterChef.sol#L120-L121](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L120-L121)<br>\n\n```solidity\nuint concurReward = multiplier.mul(concurPerBlock).mul(pool.allocPoint).div(totalAllocPoint);\naccConcurPerShare = accConcurPerShare.add(concurReward.mul(_concurShareMultiplier).div(lpSupply));\n```\n\n## \\[G-04] Change unnecessary storage variables to constants can save gas\n\n*Note: Suggested optimation, save a decent amount of gas without compromising readability.*\n\n[MasterChef.sol#L56-L57](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L56-L57)<br>\n\n```solidity\nuint private _concurShareMultiplier = 1e18;\nuint private _perMille = 1000; // 100%\n```\n\nSome storage variables include `_concurShareMultiplier`, `_perMille` will never be changed and they should not be.\n\nChanging them to `constant` can save gas.\n\n## \\[G-05] Setting `bool` variables to `false` is redundant\n\n*Note: Minor optimation, the amount of gas saved is minor, change when you see fit.*\n\n[MasterChef.sol#L204-L204](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L204-L204)<br>\n\n```solidity\nbool transferSuccess = false;\n```\n\nSetting `bool` variables to `false` is redundant as they default to `false`.\n\nSee <https://docs.soliditylang.org/en/v0.8.11/control-structures.html#default-value>\n\n## \\[G-06] Using immutable variable can save gas\n\n*Note: Suggested optimation, save a decent amount of gas without compromising readability.*\n\n[MasterChef.sol#L52-L71](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L52-L71)<br>\n\n```solidity\nuint public startBlock;\nuint public endBlock; // The block number when mining starts.\nIERC20 public concur;\n\nuint private _concurShareMultiplier = 1e18;\nuint private _perMille = 1000; // 100%\n\nconstructor(IERC20 _concur, uint _startBlock, uint _endBlock) Ownable() {\n    startBlock = _startBlock;\n    endBlock = _endBlock;\n    concur = _concur;\n    // ...\n}\n```\n\nConsidering that `startBlock`, `endBlock` and `concur` will never change, changing them to immutable variables instead of storages variable can save gas.\n\n[StakingRewards.sol#L19-L20](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L19-L20)<br>\n\n```solidity\n    IERC20 public rewardsToken;\n    IERC20 public stakingToken;\n```\n\n[StakingRewards.sol#L37-L47](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L37-L47)<br>\n\n```solidity\n    constructor(\n        address _rewardsDistribution,\n        address _rewardsToken,\n        address _stakingToken,\n        MasterChef _masterChef\n    ) {\n        rewardsToken = IERC20(_rewardsToken);\n        stakingToken = IERC20(_stakingToken);\n        rewardsDistribution = _rewardsDistribution;\n        masterChef = _masterChef;\n    }\n```\n\nConsidering that `rewardsToken` and `stakingToken` will never change, changing them to immutable variables instead of storages variable can save gas.\n\n## \\[G-07] Use short reason strings can save gas\n\n*Note: Minor optimation, the amount of gas saved is minor, change when you see fit.*\n\nEvery reason string takes at least 32 bytes.\n\nUse short reason strings that fits in 32 bytes or it will become more expensive.\n\nInstances include:\n\n[StakingRewards.sol#L179-L182](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L179-L182)<br>\n\n```solidity\nrequire(\n    block.timestamp > periodFinish,\n    \"Previous rewards period must be complete before changing the duration for the new period\"\n);\n```\n\n[StakingRewards.sol#L191-L194](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L191-L194)<br>\n\n```solidity\nrequire(\n    block.timestamp > periodFinish,\n    \"Previous rewards period must be complete before changing the duration for the new period\"\n);\n```\n\n[StakingRewards.sol#L137-L140](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L137-L140)<br>\n\n```solidity\nrequire(\n    msg.sender == rewardsDistribution,\n    \"Caller is not RewardsDistribution contract\"\n);\n```\n\n[StakingRewards.sol#L170-L173](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L170-L173)<br>\n\n```solidity\nrequire(\n    tokenAddress != address(stakingToken),\n    \"Cannot withdraw the staking token\"\n);\n```\n\n[MasterChef.sol#L210-L210](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/MasterChef.sol#L210-L210)<br>\n\n```solidity\nrequire(transferSuccess, \"safeConcurTransfer: transfer failed\");\n```\n\n## \\[G-08] Setting `uint256` variables to `0` is redundant\n\n*Note: Minor optimation, the amount of gas saved is minor, change when you see fit.*\n\nSetting `uint256` variables to `0` is redundant as they default to `0`.\n\n[StakingRewards.sol#L21-L22](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L21-L22)<br>\n\n```solidity\n    uint256 public periodFinish = 0;\n    uint256 public rewardRate = 0;\n```\n\n### Recommended Mitigation Steps\n\nChange to `uint256 public periodFinish;` `uint256 public rewardRate;` can make the code simpler and save some gas.\n\n## \\[G-09] Adding unchecked directive can save gas\n\n*Note: Minor optimation, the amount of gas saved is minor, change when you see fit.*\n\nFor the arithmetic operations that will never over/underflow, using the unchecked directive (Solidity v0.8 has default overflow/underflow checks) can save some gas from the unnecessary internal over/underflow checks.\n\nFor example:\n\n1.  [StakingRewards.sol#L88-L101](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L88-L101)\n\n```solidity\nfunction stake(uint256 amount)\n    external\n    nonReentrant\n    whenNotPaused\n    updateReward(msg.sender)\n{\n    require(amount > 0, \"Cannot stake 0\");\n    _totalSupply += amount;\n    _balances[msg.sender] += amount;\n    stakingToken.safeTransferFrom(msg.sender, address(this), amount);\n    uint256 pid = masterChef.pid(address(stakingToken));\n    masterChef.deposit(msg.sender, pid, amount);\n    emit Staked(msg.sender, amount);\n}\n```\n\n`_balances[msg.sender] += amount` will never overflow if `_totalSupply += amount;` does not revert.\n\n2.  [StakingRewards.sol#L103-L115](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L103-L115)\n\n```solidity\nfunction withdraw(uint256 amount)\n    public\n    nonReentrant\n    updateReward(msg.sender)\n{\n    require(amount > 0, \"Cannot withdraw 0\");\n    _totalSupply -= amount;\n    _balances[msg.sender] -= amount;\n    stakingToken.safeTransfer(msg.sender, amount);\n    uint256 pid = masterChef.pid(address(stakingToken));\n    masterChef.withdraw(msg.sender, pid, amount);\n    emit Withdrawn(msg.sender, amount);\n}\n```\n\n`_totalSupply -= amount` will never underflow if `_balances[msg.sender] -= amount;` does not underflow revert.\n\nTherefore it can be changed to for gas saving:\n\n```solidity\n    _balances[msg.sender] -= amount;\n    unchecked {\n        _totalSupply -= amount;\n    }\n```\n\n## \\[G-10] \"> 0\" is less efficient than \"!= 0\" for unsigned integers\n\n*Note: Minor optimation, the amount of gas saved is minor, change when you see fit.*\n\nIt is cheaper to use `!= 0` than `> 0` for uint256.\n\n[StakingRewards.sol#L94-L94](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L94-L94)<br>\n\n```solidity\nrequire(amount > 0, \"Cannot stake 0\");\n```\n\n[StakingRewards.sol#L108-L108](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L108-L108)<br>\n\n```solidity\nrequire(amount > 0, \"Cannot withdraw 0\");\n```\n\n[StakingRewards.sol#L119-L119](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/StakingRewards.sol#L119-L119)<br>\n\n```solidity\nif (reward > 0) {\n```\n\n## \\[G-11] `++i` is more efficient than `i++`\n\n*Note: Minor optimation, the amount of gas saved is minor, change when you see fit.*\n\nUsing `++i` is more gas efficient than `i++`, especially in a loop.\n\nFor example:\n\n[ConvexStakingWrapper.sol#L121-L121](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L121-L121)<br>\n\n```solidity\nfor (uint256 i = 0; i < extraCount; i++) {\n```\n\n[ConvexStakingWrapper.sol#L219-L219](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L219-L219)<br>\n\n```solidity\nfor (uint256 i = 0; i < rewardCount; i++) {\n```\n\n[ConcurRewardPool.sol#L35-L35](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConcurRewardPool.sol#L35-L35)<br>\n\n```solidity\nfor (uint256 i = 0; i < _tokens.length; i++) {\n```\n\n## \\[G-12] Reuse existing external call's cache can save gas\n\n*Note: Suggested optimation, save a decent amount of gas without compromising readability.*\n\n[ConvexStakingWrapper.sol#L120-L139](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L120-L139)<br>\n\n```solidity\nuint256 extraCount = IRewardStaking(mainPool).extraRewardsLength();\nfor (uint256 i = 0; i < extraCount; i++) {\n    address extraPool = IRewardStaking(mainPool).extraRewards(i);\n    address extraToken = IRewardStaking(extraPool).rewardToken();\n    if (extraToken == cvx) {\n        //no-op for cvx, crv rewards\n        rewards[_pid][CVX_INDEX].pool = extraPool;\n    } else if (registeredRewards[_pid][extraToken] == 0) {\n        //add new token to list\n        rewards[_pid].push(\n            RewardType({\n                token: IRewardStaking(extraPool).rewardToken(),\n                pool: extraPool,\n                integral: 0,\n                remaining: 0\n            })\n        );\n        registeredRewards[_pid][extraToken] = rewards[_pid].length; //mark registered at index+1\n    }\n}\n```\n\n`IRewardStaking(extraPool).rewardToken()` at L131 is already cached in the local variable `extraToken` at L123.\n\nReusing the cached local variable in the stack instead of initiating an external call again can save gas.\n\n## \\[G-13] Unnecessary checked arithmetic in for loops\n\n*Note: Non-preferred, the amount of gas saved is at cost of readability, only apply when gas saving is a top priority.*\n\nThere is no risk of overflow caused by increamenting the iteration index in for loops (the `i++` in for `for (uint256 i = 0; i < rewardCount; i++)`).\n\nIncrements perform overflow checks that are not necessary in this case.\n\n### Recommended Mitigation Steps\n\nSurround the increment expressions with an `unchecked { ... }` block to avoid the default overflow checks. For example, change the for loop:\n\n[ConvexStakingWrapper.sol#L219-L221](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConvexStakingWrapper.sol#L219-L221)<br>\n\n```solidity\nfor (uint256 i = 0; i < rewardCount; i++) {\n    _calcRewardIntegral(_pid, i, _account, depositedBalance, supply);\n}\n```\n\nto:\n\n```solidity\nfor (uint256 i = 0; i < rewardCount;) {\n    _calcRewardIntegral(_pid, i, _account, depositedBalance, supply);\n    unchecked { ++i; }\n}\n```\n\n## \\[G-14] Cache array length in for loops can save gas\n\n*Note: Minor optimation, the amount of gas saved is minor, change when you see fit.*\n\nReading array length at each iteration of the loop takes 6 gas (3 for mload and 3 to place memory_offset) in the stack.\n\nCaching the array length in the stack saves around 3 gas per iteration.\n\nInstances include:\n\n*   `ConcurRewardPool.sol#claimRewards()`\n\n    [ConcurRewardPool.sol#L35-L39](https://github.com/code-423n4/2022-02-concur/blob/72b5216bfeaa7c52983060ebfc56e72e0aa8e3b0/contracts/ConcurRewardPool.sol#L35-L39)\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-concur-findings/issues/216#issuecomment-1087619318):**\n > **[G-01] Cache external call result in the stack can save gas**<br>\n> Would save 100 gas for STATICALL + the cost of reading from Storage again, let's say another 100, at the cost of 6 for MSTORE + MLOAD = 194 gas saved\n> \n> **[G-02] Cache external call result in storage can save gas**<br>\n> Would save 91 gas (First call costs 6 more, second costs 97 less)\n> \n> **[G-03] `SafeMath is no longer needed**<br>\n> In contrast to other findings the warden has listed all instances that are unnecessary, for thus reason I will add the gas savings to this report<br>\n> 8 instances, 20 gas per instance = 160 gas saved\n> \n> **[G-04] Change unnecessary storage variables to constants can save gas**<br>\n> Because the warden didn't list the other savings, I'll give one COLD SLOAD per variable<br>\n> 2100 * 2 = 4200\n> \n> **[G-05] Setting bool variables to false is redundant**<br>\n> 3 gas\n> \n> **[G-06] Using immutable variable can save gas**<br>\n> Similar to S4<br>\n> 5 * 2100 = 10500\n> \n> **[G-07] Use short reason strings can save gas**<br>\n> 5 * 2500 per discussion on other reports <br>\n> 12500\n> \n> **[G-08] Setting uint256 variables to 0 is redundant**<br>\n> 200\n> \n> **[G-09] Adding unchecked directive can save gas**<br>\n> 2 * 20 = 40\n> \n> **[G-10] \"> 0\" is less efficient than \"!= 0\" for unsigned integers**<br>\n> Only for require<br>\n> 2 * 6 = 12\n> \n> **[G-11] ++i is more efficient than i++**<br>\n> 3 * 3 = 9\n> \n> **[G-12] Reuse existing external call's cache can save gas**<br>\n> 91 gas saved (97 -  6)\n> \n> **[G-13] Unnecessary checked arithmetic in for loops**<br>\n> 20 gas\n> \n> **[G-14] Cache array length in for loops can save gas**<br>\n> 3 gas\n> \n> Overall the report is short and sweet, the formatting is excellent and there's a little more detail than in other reports.<br>\n> Would have liked to see the storage to constant gas savings explicitly shown as that would have made the report as close to complete as it could have been.\n> \n> Total Gas Saved:<br>\n> 28023\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}