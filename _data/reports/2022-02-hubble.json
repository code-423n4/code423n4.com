{
  "circa": {
    "title": "Hubble contest",
    "sponsor": "Hubble",
    "slug": "2022-02-hubble",
    "date": "2022-06-02",
    "findings": "https://github.com/code-423n4/2022-02-hubble-findings/issues",
    "contest": 89
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Hubble smart contract system written in Solidity. The audit contest took place between February 17—February 23 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>45 Wardens contributed reports to the Hubble contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/JustDravee\">Dravee</a></li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li><a href=\"https://twitter.com/kirkthebaird\">kirk-baird</a></li>\n<li>hyh</li>\n<li><a href=\"https://twitter.com/0xliumin\">0xliumin</a></li>\n<li><a href=\"https://twitter.com/danbinnun\">danb</a></li>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li>robee</li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li><a href=\"https://twitter.com/Throt7le\">throttle</a></li>\n<li>0x1f8b</li>\n<li><a href=\"https://twitter.com/liam_eastwood13\">leastwood</a></li>\n<li><a href=\"https://twitter.com/itsmeSTYJ\">itsmeSTYJ</a></li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li><a href=\"https://twitter.com/omikomikomik\">Omik</a></li>\n<li>minhquanym</li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li><a href=\"https://twitter.com/Meta0xNull\">Meta0xNull</a></li>\n<li>IllIllI</li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li><a href=\"https://www.instagram.com/riyan_rfa/\">rfa</a></li>\n<li><a href=\"https://twitter.com/_ye0lde\">ye0lde</a></li>\n<li>kenta</li>\n<li><a href=\"https://github.com/bernard-wagner\">bw</a></li>\n<li>hubble (ksk2345 and shri4net)</li>\n<li>cccz</li>\n<li><a href=\"https://twitter.com/_0v3rf10w\">0v3rf10w</a></li>\n<li>sorrynotsorry</li>\n<li>CertoraInc (<a href=\"https://twitter.com/danbinnun\">danb</a>, egjlmn1, <a href=\"https://twitter.com/ori_dabush\">OriDabush</a>, ItayG, and shakedwinder)</li>\n<li>Jujic</li>\n<li><a href=\"https://twitter.com/VladToie/\">bobi</a></li>\n<li>peritoflores</li>\n<li>0xwags</li>\n<li>0x0x0x</li>\n<li>jayjonah8</li>\n<li>Nikolay</li>\n<li>d4rk</li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n</ol>\n<p>This contest was judged by the Float Capital team: <a href=\"https://github.com/moose-code\">moose-code</a> and <a href=\"https://github.com/JasoonS\">JasoonS</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 20 unique vulnerabilities. Of these vulnerabilities, 3 received a risk rating in the category of HIGH severity and 17 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 30 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 21 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-02-hubble\">C4 Hubble contest repository</a>, and is composed of 7 smart contracts written in the Solidity programming language (2,109 lines of code) as well as 3 contracts written in the Vyper programming language (1,561 lines of code).</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-3\" style=\"position:relative;\"><a href=\"#high-risk-findings-3\" aria-label=\"high risk findings 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (3)</h1>\n<h2 id=\"h-01-update-initializer-modifier-to-prevent-reentrancy-during-initialization\" style=\"position:relative;\"><a href=\"#h-01-update-initializer-modifier-to-prevent-reentrancy-during-initialization\" aria-label=\"h 01 update initializer modifier to prevent reentrancy during initialization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/81\">[H-01] Update initializer modifier to prevent reentrancy during initialization</a></h2>\n<p><em>Submitted by Dravee</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/package.json#L17\">https://github.com/code-423n4/2022-02-hubble/blob/main/package.json#L17</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/legos/Governable.sol#L5\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/legos/Governable.sol#L5</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/legos/Governable.sol#L24\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/legos/Governable.sol#L24</a></p>\n<p>While Governable.sol is out of scope, I figured this issue would still be fair game.</p>\n<p>The solution uses: <code>\"@openzeppelin/contracts\": \"4.2.0\"</code>.<br>\nThis dependency has a known high severity vulnerability: <a href=\"https://security.snyk.io/vuln/SNYK-JS-OPENZEPPELINCONTRACTS-2320176\">https://security.snyk.io/vuln/SNYK-JS-OPENZEPPELINCONTRACTS-2320176</a><br>\nWhich makes this contract vulnerable:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: Governable.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">05: import { Initializable } from &quot;@openzeppelin/contracts/proxy/utils/Initializable.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">24: contract Governable is VanillaGovernable, Initializable {}</span></span></code></pre>\n<p>This contract is inherited at multiple places:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">contracts/AMM.sol:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  11: contract AMM is IAMM, Governable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contracts/InsuranceFund.sol:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  13: contract InsuranceFund is VanillaGovernable, ERC20Upgradeable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contracts/Oracle.sol:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  11: contract Oracle is Governable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contracts/legos/HubbleBase.sol:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  15: contract HubbleBase is Governable, Pausable, ERC2771Context {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contracts/ClearingHouse.sol:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  11: contract ClearingHouse is IClearingHouse, HubbleBase {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contracts/MarginAccount.sol:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  25: contract MarginAccount is IMarginAccount, HubbleBase {</span></span></code></pre>\n<p>ìnitializer()` is used here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">contracts/AMM.sol:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  99:     ) external initializer {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contracts/ClearingHouse.sol:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  44:     ) external initializer {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contracts/MarginAccount.sol:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  124:     ) external initializer {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contracts/Oracle.sol:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  20:     function initialize(address _governance) external initializer {</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Upgrade <code>@openzeppelin/contracts</code> to version 4.4.1 or higher.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/81\">atvanguard (Hubble) confirmed and resolved</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/81#issuecomment-1059916859\">moose-code (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agreed. Other issues such as <a href=\"https://forum.openzeppelin.com/t/security-advisory-initialize-uups-implementation-contracts/15301\">this</a> have also popped up, so always safest to be on the newest OZ. This includes for contracts and contracts-upgradeable packages.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-denial-of-service\" style=\"position:relative;\"><a href=\"#h-02-denial-of-service\" aria-label=\"h 02 denial of service permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/119\">[H-02] denial of service</a></h2>\n<p><em>Submitted by danb, also found by cmichel, csanuragjain, hyh, kirk-baird, leastwood, Meta0xNull, minhquanym, Omik, robee, Ruhum, and throttle</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/VUSD.sol#L53\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/VUSD.sol#L53</a><br></p>\n<p>processWithdrawals can process limited amount in each call.<br>\nAn attacker can push to withdrawals enormous amount of withdrawals with amount = 0.<br>\nIn order to stop the dos attack and process the withdrawal, the governance needs to spend as much gas as the attacker.<br>\nIf the governance doesn’t have enough money to pay for the gas, the withdrawals can’t be processed.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Alice wants to attack vusd, she spends 1 millions dollars for gas to push as many withdrawals of amount = 0 as she can.<br>\nIf the governance wants to process the deposits after Alices empty deposits, they also need to spend at least 1 million dollars for gas in order to process Alice’s withdrawals first.<br>\nBut the governance doesn’t have 1 million dollars so the funds will be locked.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Set a minimum amount of withdrawal. e.g. 1 dollar</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function withdraw(uint amount) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(amount &gt;= 10 ** 6);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        burn(amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        withdrawals.push(Withdrawal(msg.sender, amount));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/119#issuecomment-1049473996\">atvanguard (Hubble) confirmed, but disagreed with High severity and commented</a>:</strong></p>\n<blockquote>\n<p>Confirming this is an issue. Would classify it as <code>2 (Med Risk)</code> because this attack is expensive to carry out.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/119\">atvanguard (Hubble) resolved</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/119#issuecomment-1059971562\">moose-code (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Would be interested to see the exact gas cost of executing withdraw. The thing is the grievance costs only gas to execute and the withdraw function is relatively cheap from first glance. The main issue here is that it can become SUPER expensive to clear the que in gas. I.e. if the attacker builds up a que of 200 withdrawals, some unknowning sucker is going to pay for more than 200 erc20 transfers in order to get their money out. Thats more than anyone would want to pay, and further since so much gas limit would be needed for this to be executed, to fit into a block you are going to have to pay a huge price. </p>\n<p>So basically it costs attacker x to execute, which means it is also going to cost next user likely even more than x to fix the problem. </p>\n<p>Also the que is not cleared so processWithdrawals becomes a really expensive function. If the items were cleared and set back to zero it would make it less expensive to de-que the que. </p>\n<p>This being said we definitely have this at at least medium severity. $10k in gas to constantly brick users withdrawls from protocol for a week is a serious issue and not the biggest cost for an attack. </p>\n<p>@JasoonS, going to put this as medium. Let’s discuss whether we want to have it as high. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/119#issuecomment-1059983807\">moose-code (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Okay, going to keep this as high severity. The cost to fix the attack can be more than what the attack costs in total. It also burdens a random unsuspecting user with a really high gas cost to try and get their withdrawal. There are many good suggestions on how to fix this. </p>\n</blockquote>\n<hr>\n<h2 id=\"h-03-insurancefund-depositors-can-be-priced-out--deposits-can-be-stolen\" style=\"position:relative;\"><a href=\"#h-03-insurancefund-depositors-can-be-priced-out--deposits-can-be-stolen\" aria-label=\"h 03 insurancefund depositors can be priced out  deposits can be stolen permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/42\">[H-03] InsuranceFund depositors can be priced out &#x26; deposits can be stolen</a></h2>\n<p><em>Submitted by cmichel, also found by danb</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/InsuranceFund.sol#L44-L54\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/InsuranceFund.sol#L44-L54</a><br></p>\n<p>The <code>InsuranceFund.deposit</code> function mints initial <code>shares</code> equal to the deposited amount.<br>\nThe deposit / withdraw functions also use the VUSD contract balance for the shares computation. (<code>balance() = vusd.balanceOf(address(this))</code>)</p>\n<p>It’s possible to increase the share price to very high amounts and price out smaller depositors.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ul>\n<li><code>deposit(_amount = 1)</code>: Deposit the smallest unit of VUSD as the first depositor. Mint 1 share and set the total supply and VUSD balance to <code>1</code>.</li>\n<li>Perform a direct transfer of <code>1000.0</code> VUSD to the <code>InsuranceFund</code>. The <code>balance()</code> is now <code>1000e6 + 1</code></li>\n<li>Doing any deposits of less than <code>1000.0</code> VUSD will mint zero shares: <code>shares = _amount * _totalSupply / _pool = 1000e6 * 1 / (1000e6 + 1) = 0</code>.</li>\n<li>The attacker can call <code>withdraw(1)</code> to burn their single share and receive the entire pool balance, making a profit. (<code>balance() * _shares / totalSupply() = balance()</code>)</li>\n</ul>\n<p>I give this a high severity as the same concept can be used to always steal the initial insurance fund deposit by frontrunning it and doing the above-mentioned steps, just sending the frontrunned deposit amount to the contract instead of the fixed <code>1000.0</code>.\nThey can then even repeat the steps to always frontrun and steal any deposits.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The way <a href=\"https://github.com/Uniswap/v2-core/blob/4dd59067c76dea4a0e8e4bfdda41877a6b16dedc/contracts/UniswapV2Pair.sol#L121\">UniswapV2 prevents this</a> is by requiring a minimum deposit amount and sending <code>1000</code> initial shares to the zero address to make this attack more expensive.\nThe same mitigation can be done here.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/42\">atvanguard (Hubble) confirmed</a></strong></p>\n<hr>\n<h1 id=\"medium-risk-findings-17\" style=\"position:relative;\"><a href=\"#medium-risk-findings-17\" aria-label=\"medium risk findings 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (17)</h1>\n<h2 id=\"m-01-liquidations-can-be-run-on-the-bogus-oracle-prices\" style=\"position:relative;\"><a href=\"#m-01-liquidations-can-be-run-on-the-bogus-oracle-prices\" aria-label=\"m 01 liquidations can be run on the bogus oracle prices permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/46\">[M-01] Liquidations can be run on the bogus Oracle prices</a></h2>\n<p><em>Submitted by hyh, also found by 0x1f8b, cccz, csanuragjain, defsec, hubble, leastwood, pauliax, WatchPug, and ye0lde</em></p>\n<p>If the price feed is manipulated in any way or there is any malfunction based volatility on the market, a malicious user can use this to liquidate a healthy position.</p>\n<p>An attacker can setup a monitoring of the used Oracle feed and act on observing a price outbreak (for example, zero price, which is usually a subject to filtration), liquidating the trader position which is perfectly healthy otherwise, obtaining the collateral with a substantial discount at the expense of the trader.</p>\n<p>The same is for a flash crash kind of scenario, i.e. a price outbreak of any nature will allow for non-market liquidation by an attacker, who has the incentives to setup such a monitoring and act on such an outbreak, knowing that it will not be smoothed or filtered out, allowing a liquidation at a non-market price that happen to be printed in the Oracle feed</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Oracle.getUnderlyingPrice just passes on the latest Oracle answer, not checking it anyhow:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/Oracle.sol#L24-L35\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/Oracle.sol#L24-L35</a></p>\n<p>It is then used in liquidation triggers providing isLiquidatable and _getLiquidationInfo functions:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/MarginAccount.sol#L249\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/MarginAccount.sol#L249</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/MarginAccount.sol#L465\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/MarginAccount.sol#L465</a></p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a non-zero Oracle price check, possibly add an additional Oracle feed information usage to control that the price is fresh. Please consult the Chainlink for that as OCR introduction might have changed the state of the art approach (i.e. whether and how to use latestRoundData returned data):</p>\n<p><a href=\"https://docs.chain.link/docs/off-chain-reporting/\">https://docs.chain.link/docs/off-chain-reporting/</a></p>\n<p>Regarding any price spikes it is straightforward to construct a mitigation mechanics for such cases, so the system will be affected by sustainable price movements only.</p>\n<p>As price outrages provide a substantial attack surface for the project it’s worth adding some complexity to the implementation.</p>\n<p>One of the approaches is to track both current and TWAP prices, and condition all state changing actions, including liquidations, on the current price being within a threshold of the TWAP one. If the liquidation margin level is conservative enough and TWAP window is small enough this is safe for the overall stability of the system, while providing substantial mitigation mechanics by allowing state changes on the locally calm market only.</p>\n<p>Another approach is to introduce time delay between liquidation request and actual liquidation. Again, conservative enough margin level plus small enough delay keeps the system safe, while requiring that market conditions allow for liquidation both at request time and at execution time provides ample filtration against price feed outbreaks</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/46\">atvanguard (Hubble) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/46\">moose-code (judge) decreased severity from High to Medium</a></strong></p>\n<hr>\n<h2 id=\"m-02-hidden-governance\" style=\"position:relative;\"><a href=\"#m-02-hidden-governance\" aria-label=\"m 02 hidden governance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/11\">[M-02] Hidden governance</a></h2>\n<p><em>Submitted by 0x1f8b</em></p>\n<p>The contract use two governance model, one looks hidden.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/VUSD.sol#L11\">VUSD contract</a> uses <code>VanillaGovernable</code> but inherits from <code>ERC20PresetMinterPauserUpgradeable</code> and this contract uses roles to use some administrative methods like <code>pause</code> or <code>mint</code>.</p>\n<p>This two-governance model does not seem necessary and can hide or raise suspicion about a rogue pool, thus damaging the user’s trust.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Unify governance in only one, VanillaGovernable or role based.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/11\">atvanguard (Hubble) confirmed and resolved</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/11#issuecomment-1059926864\">moose-code (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Yes, a good suggestion to keep governance more tightly coupled. OZ has AccessControlledAndUpgradeable which is really nice. Various roles for varying level of admin functionality. Allows tighter controls on more controversial items and easier control on less controversial items. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-clearinghouse-may-whitelist-duplicate-amms\" style=\"position:relative;\"><a href=\"#m-03-clearinghouse-may-whitelist-duplicate-amms\" aria-label=\"m 03 clearinghouse may whitelist duplicate amms permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/50\">[M-03] ClearingHouse May Whitelist Duplicate AMMs</a></h2>\n<p><em>Submitted by kirk-baird</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L339-L342\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L339-L342</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L269-L282\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L269-L282</a></p>\n<p><code>ClearingHouse.sol</code> allows the Governance protocol to whitelist <code>AMM.sol</code> contracts. These contracts allow users to earn profits based on the price of a base asset against a quote asset.</p>\n<p>It is possible to add the same <code>AMM</code> twice in the function <code>whitelistAmm()</code>. The impact is that unrealized profits will be counted multiple times. As a result the liquidation calculations will be incorrect, potentially allowing users to trade while insolvent or incorrectly liquidating solvent users.</p>\n<p>Note <code>whitelistAmm()</code> may only be called by Governance.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The function <code>getTotalNotionalPositionAndUnrealizedPnl()</code> will iterate over all <code>amms</code> summing the <code>unrealizedPnl</code>  and <code>notinoalPosition</code>, thus if an <code>amm</code> is repeated the <code>unrealizedPnl</code> and <code>notionalPosition</code> of that asset will be counted multiple times.</p>\n<p>This is used in <code>_calcMarginFraction()</code> which calculates a users margin as a fraction of the total position. The margin fraction is used to determine if a user is liquitable or is allowed to open new positions.</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider ensuring the <code>AMM</code> does not already exist in the list when adding a new <code>AMM</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function whitelistAmm(address _amm) external onlyGovernance {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint256 i; i &lt; amm.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(amm[i] != IAMM(_amm), &quot;AMM already whitelisted&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit MarketAdded(amms.length, _amm);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        amms.push(IAMM(_amm));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/50#issuecomment-1049571812\">atvanguard (Hubble) confirmed, but disagreed with Medium severity and commented</a>:</strong></p>\n<blockquote>\n<p>As mentioned in <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/40\">#40</a>, the system relies on the admin to do the right thing; hence disagreeing with the severity. Still, it’s a good idea to have this check.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/50\">atvanguard (Hubble) resolved</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/50#issuecomment-1059926048\">moose-code (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Practical advice that prevents a catastrophic issue that could very possibly occur (having run deployment / whitelist and many other scripts, it’s way too easy to run something again etc and end up in this situation - even though it feels like it would never be possible). </p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-settlefunding-will-exceed-block-gas-with-more-markets-and-activity\" style=\"position:relative;\"><a href=\"#m-04-settlefunding-will-exceed-block-gas-with-more-markets-and-activity\" aria-label=\"m 04 settlefunding will exceed block gas with more markets and activity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/97\">[M-04] <code>settleFunding</code> will exceed block gas with more markets and activity</a></h2>\n<p><em>Submitted by bw, also found by cmichel, Dravee, gzeon, Omik, and Ruhum</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L129\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L129</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L678\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L678</a></p>\n<p>As the number of supported markets grow, <code>settleFunding</code> will reach a point were it exceeds the block gas limit on Avalanche C-Chain. This will prevent users from calling the function and cause a wide spread Denial of Service.</p>\n<p>Looking at transactions for the current testnet deployment, <code>settleFunding</code> already reaches almost 10% of the block gas limit. This is due settle funding iteratively looping through each market, with each iteration entering an unbounded <code>while</code> loop in <code>_calcTwap</code>. The more active the markets are, the more gas intensive <code>_calcTwap</code> becomes, as more snapshots need to be traversed.</p>\n<p>The combination of more active markets and an increase in available markets make it very likely that some users will be unable to call <code>settleFunding</code> in the long run.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Example of transactions on testnet:</p>\n<table>\n<thead>\n<tr>\n<th>Gas</th>\n<th>Limit%</th>\n<th>Link</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>658428</td>\n<td>8.2%</td>\n<td><a href=\"https://testnet.snowtrace.io/tx/0x8123a5658a98e694e7428e66c9e5f9d5cbff8af93d543ed51a80cb367bcccd2c\">https://testnet.snowtrace.io/tx/0x8123a5658a98e694e7428e66c9e5f9d5cbff8af93d543ed51a80cb367bcccd2c</a></td>\n</tr>\n<tr>\n<td>653810</td>\n<td>8.1%</td>\n<td><a href=\"https://testnet.snowtrace.io/tx/0xf126eb05245580a73981228d6f0f8d607ad038ca0b68593f0c903e210c1c2c57\">https://testnet.snowtrace.io/tx/0xf126eb05245580a73981228d6f0f8d607ad038ca0b68593f0c903e210c1c2c57</a></td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Users should be allowed to settle funding per market or using an array of markets opposed to all markets at once.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">settleFundingForMarkets</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IAMM</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">markets</span><span class=\"mtk1\">) </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenNotPaused</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">markets</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">markets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk11\">settleFunding</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>In this way the gas cost will not increase with the number of markets created over time.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/97#issuecomment-1049492999\">atvanguard (Hubble) acknowledged, but disagreed with High severity and commented</a>:</strong></p>\n<blockquote>\n<p>It’s a known issue that adding many more markets will eventually exceed block gas limit on many operations (not just <code>settleFunding</code>). For that reason, DAO governance has to be careful with not adding too many markets. Would classify this as <code>0 (Informational)</code>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/97#issuecomment-1059975203\">moose-code (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This is definitely more than informational. You can see in the gas profiler on only a limited amount of markets with not much action, lots of gas was used. This has potential to be a much bigger issue in the future. </p>\n<p>Very rightly so the warden points out <code>_calcTwap</code> as intensive which is shown on the profiler below for the one market. Calculating a TWAP across many different markets could blow this function up very quickly. </p>\n<p>Further more, if you take ALL the gas in a single block, this becomes really expensive and difficult as you need to push out a lot of other high priority transactions that are pending. If this was needing to be executed during an NFT minting spree it would be tough.</p>\n<p><img src=\"https://user-images.githubusercontent.com/20556729/156927846-bbd71770-ea09-4e3e-bffb-83256e665398.png\" alt=\"image\"></p>\n<p>@JasoonS, let’s discuss on medium vs high for this one. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/97#issuecomment-1059985901\">moose-code (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Going to have this as medium. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-oraclegetunderlyingprice-could-have-wrong-decimals\" style=\"position:relative;\"><a href=\"#m-05-oraclegetunderlyingprice-could-have-wrong-decimals\" aria-label=\"m 05 oraclegetunderlyingprice could have wrong decimals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/44\">[M-05] <code>Oracle.getUnderlyingPrice</code> could have wrong decimals</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/Oracle.sol#L34\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/Oracle.sol#L34</a><br></p>\n<p>The <code>Oracle.getUnderlyingPrice</code> function divides the chainlink price by <code>100</code>.<br>\nIt probably assumes that the answer for the underlying is in 8 decimals but then wants to reduce it for 6 decimals to match USDC.</p>\n<p>However, arbitrary <code>underlying</code> tokens are used and the chainlink oracles can have different decimals.</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>While most USD price feeds use 8 decimals, it’s better to take the on-chain reported decimals into account by doing <code>AggregatorV3Interface(chainLinkAggregatorMap[underlying]).decimals()</code>, see <a href=\"https://docs.chain.link/docs/get-the-latest-price/#getting-a-different-price-denomination\">Chainlink docs</a>.<br>\nThe price should then be scaled down to 6 decimals.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/44#issuecomment-1049511584\">atvanguard (Hubble) confirmed, but disagreed with High severity and commented</a>:</strong></p>\n<blockquote>\n<p>All chainlink USD pairings are expected to have 8 decimals hence disagreeing with severity; but yes agree that asserting this check when adding a new asset is a good idea. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/44#issuecomment-1059976567\">moose-code (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Downgrading to medium. Dividing by magic numbers (100) should clearly comment assumptions.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-after-debt-seizure-from-insurancefund-user-can-dilute-all-past-participants\" style=\"position:relative;\"><a href=\"#m-06-after-debt-seizure-from-insurancefund-user-can-dilute-all-past-participants\" aria-label=\"m 06 after debt seizure from insurancefund user can dilute all past participants permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/129\">[M-06] After debt seizure from <code>InsuranceFund</code>, user can dilute all past participants.</a></h2>\n<p><em>Submitted by 0xliumin</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/InsuranceFund.sol#L56\">https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/InsuranceFund.sol#L56</a><br></p>\n<p>A user can get a much larger portion of the pool as it recovers from a debt seizure. The intent of the insurance pool seems to be that it could recover from a bad debt event.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Alice is the first LP to the insurance pool, and deposits 1e18 shares.</li>\n<li><code>seizeBadDebt</code> is called with 2e18. Now, there are <code>pendingObligations = 1e18</code>, and there is 0 vusd in the insurance fund.</li>\n<li>Bob (the attacker) directly transfers 1e18 + 1 vUSD.</li>\n<li>Bob calls deposit with 1e18 vUSD. All pending obligations will be settled, but there will only be 1 vUSD left in the pool before Bob’s deposit. Bob receives <code>shares = 1e18 * 1e18 / 1</code>. As a result, Bob will get <code>1e36</code> shares, diluting Alice’s share of the pool. Bob will be able to take a much larger share of all future profits from the insurance fund until more bad debt is seized. Bob only provided 2e18 + 1 liqudiity, but received an exponentially larger number of shares than Alice.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It depends on how you want this to work. You could keep track of the total amount ever contributed by users, and use that for calculations. Or just make staking 1 vUSD = 1 share if the pool total is below the total number of shares.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/129#issuecomment-1055797267\">atvanguard (Hubble) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Disputing this. It is by design. LPs who were in the insurance fund will be burnt during a bad debt settlement.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/129\">JasoonS (judge) decreased severity to Medium</a></strong></p>\n<hr>\n<h2 id=\"m-07-clearinghouse-margin-calculations-will-break-up-if-an-amm-returning-non-6-decimals-positions-be-white-listed\" style=\"position:relative;\"><a href=\"#m-07-clearinghouse-margin-calculations-will-break-up-if-an-amm-returning-non-6-decimals-positions-be-white-listed\" aria-label=\"m 07 clearinghouse margin calculations will break up if an amm returning non 6 decimals positions be white listed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/37\">[M-07] ClearingHouse margin calculations will break up if an AMM returning non-6 decimals positions be white listed</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L332\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L332</a><br></p>\n<p>It is assumed that VAMM returned positions have exactly <code>6</code> decimals for all AMMs white listed in ClearingHouse.</p>\n<p>In the same time an array of different AMMs/VAMMs is supported, and there are no guarantees/checks of the precision of the position values they return.</p>\n<p>If an VAMM that have different precision is whitelisted, for example having 18 decimals for position figures, then margin requirements checks become invalid.</p>\n<p>This will lead to various malfunctions, say perfectly valid positions will be liquidated by any attacker noticing that the calculations are skewed.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>ClearingHouse’s _calcMarginFraction is the function that is used for margin requirements checks:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L163-L167\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L163-L167</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L188-L189\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L188-L189</a></p>\n<p>_calcMarginFraction calls getNotionalPositionAndMargin:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L319-L320\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L319-L320</a></p>\n<p>getNotionalPositionAndMargin calls getTotalNotionalPositionAndUnrealizedPnl:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L291\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L291</a></p>\n<p>getTotalNotionalPositionAndUnrealizedPnl sums up AMM’s getNotionalPositionAndUnrealizedPnl results:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L269-L282\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L269-L282</a></p>\n<p>AMM’s getNotionalPositionAndUnrealizedPnl returns vamm.get_notional result:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L395-L410\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L395-L410</a></p>\n<p>The above calls are linear decimals wise (i.e. do subtractions/additions kind of operations, preserving the decimals).</p>\n<p>Then, _getMarginFraction mixes up these notionalPosition and margin, obtained from AMM without rescaling, as if they are PRECISION scaled:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L332\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L332</a></p>\n<p>PRECISION is hard coded to be <code>1e6</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L15\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L15</a></p>\n<p>For other VAMM operations base precision is set to <code>1e18</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L17\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L17</a></p>\n<p>For example, VAMM returned supply is assumed to have 18 decimals:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L523\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L523</a></p>\n<p>Comment says that exchangeExactOut returned quantity will have 6 decimals precision:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L495\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L495</a></p>\n<p>As the system imply that VAMMs can vary it is neither guaranteed, nor checked in any way (briefly checked dydx api code, it looks like there are no explicit guarantees either).</p>\n<p>If any of VAMM referenced via white listed AMMs return VAMM.get<em>notional with decimals different from <code>6</code>, the \\</em>calcMarginFraction result will become grossly incorrect.</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>If AMM contract is desired to deal with various VAMMs, consider removing decimals related hard coding, adding decimals variables and scaling VAMM returned results accordingly, so that position and margin values’ decimals of 6, implied by ClearingHouse logic, be ensured.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/37#issuecomment-1049514297\">atvanguard (Hubble) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Protocols developers will ensure that correct decimals are used everywhere. It’s not possible to assert this in code at all places.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/37#issuecomment-1059993161\">JasoonS (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Set to medium as unlikely that this would be done. However, checks and notices in the documentation of this code would be very important to prevent new devs from making these mistakes.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-all-amms-have-to-be-past-nextfundingtime-to-update\" style=\"position:relative;\"><a href=\"#m-08-all-amms-have-to-be-past-nextfundingtime-to-update\" aria-label=\"m 08 all amms have to be past nextfundingtime to update permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/130\">[M-08] All AMMs have to be past nextFundingTime to update</a></h2>\n<p><em>Submitted by 0xliumin</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/AMM.sol#L348\">https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/AMM.sol#L348</a><br></p>\n<p>settleFunding calls will revert until all AMMs are ready to be updated.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>AMM 1 has a nextFundingTime of now. AMM 2 has a nextFundingTime in 30 minutes. AMM 1 won’t be able to be updated until after AMM 2’s nextFundingTime elapses.</p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>You shouldn’t revert at the place mentioned in the links to affected code. Just return so that the other AMMs can still get updated.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/130\">atvanguard (Hubble) confirmed and resolved</a></strong></p>\n<hr>\n<h2 id=\"m-09-ownership-of-swapvy-cannot-be-transferred\" style=\"position:relative;\"><a href=\"#m-09-ownership-of-swapvy-cannot-be-transferred\" aria-label=\"m 09 ownership of swapvy cannot be transferred permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/93\">[M-09] Ownership of <code>Swap.vy</code> cannot be transferred</a></h2>\n<p><em>Submitted by gzeon</em></p>\n<p>Ownership transfer function of Swap.vy is commented out. Fund can be stuck if an AMM and governance change/upgrade is required.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/curve-v2/Swap.vy#L1129\">https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/curve-v2/Swap.vy#L1129</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/93#issuecomment-1049565326\">atvanguard (Hubble) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Intended behavior because we don’t use <code>self.owner</code> after the initial setup.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/93#issuecomment-1060013853\">JasoonS (judge) commented</a>:</strong></p>\n<blockquote>\n<p>If that is the case, then shouldn’t this function have a check that the AMM can’t be set multiple times?\n<a href=\"https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/curve-v2/Swap.vy#L966-L970\">https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/curve-v2/Swap.vy#L966-L970</a></p>\n<p>There is risk if the owner keys get compromised - also there is no progressive security if you can’t change this.</p>\n<p>IE it could start as an EOA - and progress to a multisig owner etc.</p>\n<p>Leaving at medium severity - if you have an owner, there should always be a way to update it as to improve the security (and potentially decentralization) of the system over time.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-blocking-of-the-vusd-withdrawals-is-possible-if-the-reserve-token-doesnt-support-zero-value-transfers\" style=\"position:relative;\"><a href=\"#m-10-blocking-of-the-vusd-withdrawals-is-possible-if-the-reserve-token-doesnt-support-zero-value-transfers\" aria-label=\"m 10 blocking of the vusd withdrawals is possible if the reserve token doesnt support zero value transfers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/29\">[M-10] Blocking of the VUSD withdrawals is possible if the reserve token doesn’t support zero value transfers</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p>VUSD withdraw queue will be blocked and user funds frozen simply by requesting a zero value withdraw, if the reserve token doesn’t support zero value transfers.</p>\n<p>Putting it medium only on an assumption that reserve will be USDC and the probability is low, but VUSD do allow any reserve token and the impact here is both funds freeze and stopping of the operations</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>It is possible to burn zero amount in OZ implementation:</p>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts-upgradeable/blob/master/contracts/token/ERC20/ERC20Upgradeable.sol#L285-L300\">https://github.com/OpenZeppelin/openzeppelin-contracts-upgradeable/blob/master/contracts/token/ERC20/ERC20Upgradeable.sol#L285-L300</a></p>\n<p>So, withdraw will burn zero amount and put it to the queue:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/VUSD.sol#L48\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/VUSD.sol#L48</a></p>\n<p>USDC does support zero value transfers, but not all the tokens do:</p>\n<p><a href=\"https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers\">https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers</a></p>\n<p>Currently VUSD can use any reserve token:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/VUSD.sol#L33\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/VUSD.sol#L33</a></p>\n<p>Withdraw queue position can be modified in the <code>processWithdrawals</code> function only.</p>\n<p>But it will fail every time on the zero amount entry, as there is no way to skip it (and mint VUSD back, for example), so anything else after this zero entry will not be processed:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/VUSD.sol#L62\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/VUSD.sol#L62</a></p>\n<p>This way the withdrawal functionality and the corresponding user funds will be frozen within VUSD contract, which will become inoperable</p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding a zero amount check, as it doesn’t cost much, while zero transfer doesn’t make sense anyway.</p>\n<p>Now:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">reserveToken.safeTransfer(withdrawal.usr, withdrawal.amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">reserve -= withdrawal.amount;</span></span></code></pre>\n<p>To be:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (withdrawal.amount &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\treserveToken.safeTransfer(withdrawal.usr, withdrawal.amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\treserve -= withdrawal.amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/29#issuecomment-1049602014\">atvanguard (Hubble) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Not an issue because reserveToken is intended to be USDC.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/29#issuecomment-1060019732\">JasoonS (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Not specified in spec for the audit. Giving to submitter.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-users-are-able-to-front-run-bad-debt-settlements-to-avoid-insurance-costs\" style=\"position:relative;\"><a href=\"#m-11-users-are-able-to-front-run-bad-debt-settlements-to-avoid-insurance-costs\" aria-label=\"m 11 users are able to front run bad debt settlements to avoid insurance costs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/59\">[M-11] Users are able to front-run bad debt settlements to avoid insurance costs</a></h2>\n<p><em>Submitted by kirk-baird, also found by itsmeSTYJ</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/InsuranceFund.sol#L71-L75\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/InsuranceFund.sol#L71-L75</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/InsuranceFund.sol#L62-L69\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/InsuranceFund.sol#L62-L69</a></p>\n<p>A user is able to front-run the call to <code>seizeBadDebt()</code> in <code>InsuranceFund.sol</code> to avoid paying the insurance costs.</p>\n<p><code>seizeBadDebt()</code> is called by <code>MarginAccount.settleBadDebt()</code> which is a public function. When this functions is called the transaction will appear in the mem pool.  A user may then call <code>InsuranceFund.withdraw()</code> to withdraw all of their shares. If they do this with a higher gas fee it will likely be processed before the <code>settleBadDebt()</code> transaction. In this way they will avoid incurring any cost from the assets being seized.</p>\n<p>The impact is that users may gain their share of the insurance funding payments with minimal risk (minimal as there is a change the front-run will not succeed) of having to repay these costs.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function withdraw(uint _shares) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        settlePendingObligation();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(pendingObligation == 0, &quot;IF.withdraw.pending_obligations&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint amount = balance() * _shares / totalSupply();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _burn(msg.sender, _shares);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vusd.safeTransfer(msg.sender, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit FundsWithdrawn(msg.sender, amount, block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function seizeBadDebt(uint amount) external onlyMarginAccount {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pendingObligation += amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit BadDebtAccumulated(amount, block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        settlePendingObligation();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider making the withdrawals a two step process. The first step requests a withdrawal and marks the time. The second request processes the withdrawal but requires a period of time to elapse since the first step.</p>\n<p>To avoid having users constantly having pending withdrawal, each withdrawal should have an expiry time and also a recharge time. The if the second step is not called within expiry amount of time it should be considered invalid. The first step must not be able to be called until recharge time has passed.</p>\n<p>Another solution involves a design change where the insurance fund is slowly filled up over time without external deposits. However, this has the disadvantage that bad debts received early in the protocols life time may not have sufficient insurance capital to cover them.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/59\">atvanguard (Hubble) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-12-amm-cannot-be-initialize-except-by-governance\" style=\"position:relative;\"><a href=\"#m-12-amm-cannot-be-initialize-except-by-governance\" aria-label=\"m 12 amm cannot be initialize except by governance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/51\">[M-12] AMM Cannot Be <code>initialize()</code> Except By Governance</a></h2>\n<p><em>Submitted by kirk-baird</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L93-L108\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L93-L108</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L730-L734\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L730-L734</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/legos/Governable.sol#L10-L13\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/legos/Governable.sol#L10-L13</a><br></p>\n<p>The contact <code>AMM.sol</code> cannot be initialize unless it is called from the <code>_governance</code> address.</p>\n<p>This prevents the use of a deployer account and requires the governance to be able to deploy proxy contracts and encode the required arguements. If this is not feasible then the contract cannot be deployed.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>initialize()</code> calls <code>_setGovernace(_governance);</code> which will store the governance address.</p>\n<p>Following this it will call <code>syncDeps(_registry);</code> which has <code>onlyGovernance</code> modifier.  Thus, if the <code>msg.sender</code> of <code>initialize()</code> is not the same as the parameter <code>_governance</code> then the initialisation will revert.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_registry</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_underlyingAsset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vamm</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_governance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_setGovernace</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_governance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vamm</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IVAMM</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vamm</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_underlyingAsset</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">name</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">fundingBufferPeriod</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">15</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minutes</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">syncDeps</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_registry</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding the steps manually to <code>initialize()</code>. i.e.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_registry</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_underlyingAsset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vamm</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_governance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_setGovernace</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_governance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vamm</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IVAMM</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vamm</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">underlyingAsset</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_underlyingAsset</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">name</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">fundingBufferPeriod</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">15</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minutes</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IRegistry</span><span class=\"mtk1\"> </span><span class=\"mtk12\">registry</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IRegistry</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_registry</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">clearingHouse</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">registry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">clearingHouse</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">oracle</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IOracle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">registry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">oracle</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/51\">atvanguard (Hubble) confirmed and resolved</a></strong></p>\n<hr>\n<h2 id=\"m-13-assets-sent-from-marginaccount-to-insurancefund-will-be-locked-forever\" style=\"position:relative;\"><a href=\"#m-13-assets-sent-from-marginaccount-to-insurancefund-will-be-locked-forever\" aria-label=\"m 13 assets sent from marginaccount to insurancefund will be locked forever permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/128\">[M-13] Assets sent from <code>MarginAccount</code> to <code>InsuranceFund</code> will be locked forever</a></h2>\n<p><em>Submitted by 0xliumin, also found by hyh, minhquanym, and WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/MarginAccount.sol#L377\">https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/MarginAccount.sol#L377</a><br></p>\n<p>Assets sent from MarginAccount to InsuranceFund will be locked forever.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The insurance fund doesn’t have a way to transfer non-vusd out of the contract.</p>\n<p>Assets transferred to the InsuranceFund will be locked forever.</p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Have a way for governance to sweep tokens to swap them.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/128#issuecomment-1049469298\">atvanguard (Hubble) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Yes, this a known issue and already on our roadmap.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/128#issuecomment-1059916382\">moose-code (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The insurance fund contract is also upgradeable so it’s a fairly simple fix upgrade and to sweep the tokens out when the time comes - i.e. tokens won’t be lost forever. Still would be better to have it in from the start to avoid this process. Considering moving to medium. Assessing other issues first, will circle back.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/128#issuecomment-1063363578\">moose-code (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Moving to medium as contracts are upgradeable so the tokens can always be collected later. If the contract was non-upgradeable I would have left as high.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-14-liquidation-is-vulnerable-to-sandwich-attacks\" style=\"position:relative;\"><a href=\"#m-14-liquidation-is-vulnerable-to-sandwich-attacks\" aria-label=\"m 14 liquidation is vulnerable to sandwich attacks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/113\">[M-14] Liquidation is vulnerable to sandwich attacks</a></h2>\n<p><em>Submitted by danb, also found by leastwood</em></p>\n<p>When an account is liquidated, there is no minimum amount of the swap, which makes it vulnerable for sandwich attacks.</p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Alice’s long position can be liquidated, bob notices it and creates a short position,<br>\nthen liquidates her position, thus swapping the base asset to the quote asset,<br>\ntherefore reducing the base asset price,<br>\nthen he redeems his short position and profits because the price went down.</p>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Set quoteAssetLimit in <code>_reducePosition</code> to prevent the attack.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/113#issuecomment-1049483200\">atvanguard (Hubble) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>This is a known issue and is already <a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L142\">documented as a @todo</a> in the code.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/113#issuecomment-1063373394\">moose-code (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>After long discussion we are going to side with warden on this one. The todo is a bit sparse and the warden really digs on what precautions need to be put in place and the ramifications if they are not adhered. In general, think sprinkle of todos should not indemnify issues related around them as this might let things slip through cracks as wardens will ignore these critical pieces.  </p>\n<p>With the caveat of putting this in the medium and not high risk category.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-15-wp-h7-insurancefundsyncdeps-may-cause-users-fund-loss\" style=\"position:relative;\"><a href=\"#m-15-wp-h7-insurancefundsyncdeps-may-cause-users-fund-loss\" aria-label=\"m 15 wp h7 insurancefundsyncdeps may cause users fund loss permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/100\">[M-15] [WP-H7] <code>InsuranceFund#syncDeps()</code> may cause users’ fund loss</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/InsuranceFund.sol#L116-L119\">https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/InsuranceFund.sol#L116-L119</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">syncDeps</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IRegistry</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_registry</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernance</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vusd</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_registry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vusd</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">marginAccount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_registry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">marginAccount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The <code>Governance</code> address can call <code>InsuranceFund.sol#syncDeps()</code> to change the contract address of <code>vusd</code> anytime.</p>\n<p>However, since the tx to set a new address for <code>vusd</code> can get in between users’ txs to deposit and withdraw, in some edge cases, it can result in users’ loss of funds.</p>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Alice deposited <code>1,000,000 VUSD</code> to <code>InsuranceFund</code>;</li>\n<li>Gov called <code>syncDeps()</code> and set <code>vusd</code> to the address of <code>VUSDv2</code>;</li>\n<li>Alice called <code>withdraw()</code> with all the <code>shares</code> and get back <code>0 VUSDv2</code>.</li>\n</ol>\n<p>As a result, Alice suffered a fund loss of <code>1,000,000 VUSD</code>.</p>\n<h5 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h5>\n<ol>\n<li>Consider making <code>vusd</code> unchangeable;</li>\n<li>If a possible migration of <code>vusd</code> must be considered, consider changing the <code>syncDeps()</code> to:</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">syncDeps</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IRegistry</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_registry</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyGovernance</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_balance</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">balance</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vusd</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_registry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vusd</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">balance</span><span class=\"mtk1\">() &gt;= </span><span class=\"mtk12\">_balance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">marginAccount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_registry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">marginAccount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/100#issuecomment-1049491356\">atvanguard (Hubble) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Acknowledging but yes system heavily relies on the admins to do the right thing, the right way. We might remove several such upgradeability rights during a broader refactor of the entire system.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/100#issuecomment-1063884365\">moose-code (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Downgrading to medium as this is largely admin related. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-16-usdc-blacklisted-accounts-can-dos-the-withdrawal-system\" style=\"position:relative;\"><a href=\"#m-16-usdc-blacklisted-accounts-can-dos-the-withdrawal-system\" aria-label=\"m 16 usdc blacklisted accounts can dos the withdrawal system permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/76\">[M-16] USDC blacklisted accounts can DoS the withdrawal system</a></h2>\n<p><em>Submitted by throttle</em></p>\n<p>DoS of USDC withdrawal system</p>\n<h3 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Currently, withdrawals are queued in an array and processed sequentially in a for loop.<br>\nHowever, a <code>safeTransfer()</code> to USDC blacklisted user will fail. It will also brick the withdrawal system because the blacklisted user is never cleared.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/VUSD.sol#L53-L67\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/VUSD.sol#L53-L67</a></p>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Possible solutions:<br>\n1st solution:<br>\nImplement 2-step withdrawals:<br>\n- In a for loop, increase the user’s amount that can be safely withdrawn.<br>\n- A user himself withdraws his balance<br></p>\n<p>2nd solution:<br>\nSkip blacklisted users in a processWithdrawals loop</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/76\">atvanguard (Hubble) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/76#issuecomment-1059987539\">moose-code (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Interesting! Yes, this would be bad.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-17-usage-of-an-incorrect-version-of-ownable-library-can-potentially-malfunction-all-onlyowner-functions\" style=\"position:relative;\"><a href=\"#m-17-usage-of-an-incorrect-version-of-ownable-library-can-potentially-malfunction-all-onlyowner-functions\" aria-label=\"m 17 usage of an incorrect version of ownable library can potentially malfunction all onlyowner functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/140\">[M-17] Usage of an incorrect version of Ownable library can potentially malfunction all <code>onlyOwner</code> functions</a></h2>\n<p><em>Submitted by robee</em></p>\n<p>The current implementaion is using a non-upgradeable version of the Ownable library. Instead of the upgradeable version: @openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol.</p>\n<p>A regular, non-upgradeable Ownable library will make the deployer the default owner in the constructor. Due to a requirement of the proxy-based upgradeability system, no constructors can be used in upgradeable contracts. Therefore, there will be no owner when the contract is deployed as a proxy contract</p>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use @openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol and @openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol instead.</p>\n<p>And add _<em>Ownable</em>init(); at the beginning of the initializer.</p>\n<p>Oracle.sol<br>\nAMM.sol</p>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 30 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/92\">report highlighted below</a> by <strong>defsec</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/94\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/19\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/63\">itsmeSTYJ</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/3\">robee</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/118\">Omik</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/89\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/78\">kenta</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/105\">pauliax</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/115\">ye0lde</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/32\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/7\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/107\">bobi</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/109\">peritoflores</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/131\">leastwood</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/112\">0v3rf10w</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/134\">0xwags</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/69\">Meta0xNull</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/74\">0x0x0x</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/91\">hubble</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/33\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/124\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/86\">sorrynotsorry</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/114\">danb</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/30\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/16\">jayjonah8</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/48\">kirk-baird</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/96\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/35\">CertoraInc</a>, and <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/17\">Nikolay</a>.</em></p>\n<h2 id=\"l-01--prevent-div-by-0\" style=\"position:relative;\"><a href=\"#l-01--prevent-div-by-0\" aria-label=\"l 01  prevent div by 0 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01]  PREVENT DIV BY 0</h2>\n<p>On several locations in the code precautions are taken not to divide by 0, because this will revert the code. However on some locations this isn’t done.</p>\n<p>Oracle price is not checked. That will cause to revert on the several functions.</p>\n<h3 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Navigate to the following contract:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/Oracle.sol#L34\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/Oracle.sol#L34</a></p>\n<h3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Recommend making sure division by 0 won’t occur by checking the variables beforehand and handling this edge case.</p>\n<h2 id=\"l-02-single-step-change-of-governance-address-is-extremely-risky\" style=\"position:relative;\"><a href=\"#l-02-single-step-change-of-governance-address-is-extremely-risky\" aria-label=\"l 02 single step change of governance address is extremely risky permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Single-step change of governance address is extremely risky</h2>\n<p>Single-step change of critical governance address and lack of zero address check is extremely risky. If a zero address or incorrect address (private key not available) is used accidentally, or maliciously changed by a compromised governance account then the entire governance of the protocol is locked forever or lost to an attacker. No governance changes can be made by authorized governance account and protocol will have to be redeployed. The reputation of the protocol will take a huge hit. There may be significant fund lock/loss as well.</p>\n<p>Interestingly, this 2-step process is applied to the changing of Strategist address but not Governance address. Governance has more authority in the protocol because it can change the Strategist among other things. So this 2-step should definitely be applied to Governance as well.</p>\n<p>Given the magnitude of the impact, i.e. permanent lock of all governance actions, potential lock/loss of funds, and the known/documented failures of wallet opsec, this risk is classified as medium severity.</p>\n<h3 id=\"proof-of-concept-18\" style=\"position:relative;\"><a href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/legos/Governable.sol#L20\">https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/legos/Governable.sol#L20</a></p>\n<h3 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change of the most critical protocol address i.e. governance should be timelocked and be a 2-step process: approve+claim in two different transactions, instead of a single-step change.</p>\n<h2 id=\"l-03-front-runnable-initializers\" style=\"position:relative;\"><a href=\"#l-03-front-runnable-initializers\" aria-label=\"l 03 front runnable initializers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Front-runnable Initializers</h2>\n<p>All contract <strong>initializers</strong> were missing access controls, allowing any user to initialize the contract. By front-running the contract deployers to initialize the contract, the incorrect parameters may be supplied, leaving the contract needing to be redeployed.</p>\n<h3 id=\"proof-of-concept-19\" style=\"position:relative;\"><a href=\"#proof-of-concept-19\" aria-label=\"proof of concept 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>\n<p>Navigate to the following contracts:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/AMM.sol#L93\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/AMM.sol#L93</a><br></li>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/Oracle.sol#L20\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/Oracle.sol#L20</a><br></li>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/VUSD.sol#L38\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/VUSD.sol#L38</a><br></li>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccount.sol#L121\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccount.sol#L121</a><br></li>\n</ul>\n</li>\n<li>Initialize functions does not have access control. They are vulnerable to front-running.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>While the code that can be run in contract constructors is limited, setting the owner in the contract’s constructor to the <code>msg.sender</code> and adding the <code>onlyOwner</code> modifier to all <strong>initializers</strong> would be a sufficient level of access control.</p>\n<h2 id=\"l-04-incompatibility-with-rebasingdeflationaryinflationary-tokens\" style=\"position:relative;\"><a href=\"#l-04-incompatibility-with-rebasingdeflationaryinflationary-tokens\" aria-label=\"l 04 incompatibility with rebasingdeflationaryinflationary tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Incompatibility With Rebasing/Deflationary/Inflationary tokens</h2>\n<p>The protocol do not appear to support rebasing/deflationary/inflationary tokens whose balance changes during transfers or over time. The necessary checks include at least verifying the amount of tokens transferred to contracts before and after the actual transfer to infer any fees/interest.</p>\n<h3 id=\"proof-of-concept-20\" style=\"position:relative;\"><a href=\"#proof-of-concept-20\" aria-label=\"proof of concept 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Navigate to the following contracts:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccount.sol#L155\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccount.sol#L155</a><br></li>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccountHelper.sol#L29\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccountHelper.sol#L29</a><br></li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>Ensure that to check previous balance/after balance  equals to amount for any rebasing/inflation/deflation</li>\n<li>Add support in contracts for such tokens before accepting user-supplied tokens</li>\n<li>Consider supporting deflationary / rebasing / etc tokens by extra checking the balances before/after or strictly inform your users not to use such tokens if they don’t want to lose them.</li>\n</ul>\n<h2 id=\"l-05-missing-zero-address-check-in-constructors-and-the-setter-functions\" style=\"position:relative;\"><a href=\"#l-05-missing-zero-address-check-in-constructors-and-the-setter-functions\" aria-label=\"l 05 missing zero address check in constructors and the setter functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] Missing zero-address check in constructors and the setter functions</h2>\n<p>Missing checks for zero-addresses may lead to infunctional protocol, if the variable addresses are updated incorrectly.</p>\n<h3 id=\"proof-of-concept-21\" style=\"position:relative;\"><a href=\"#proof-of-concept-21\" aria-label=\"proof of concept 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Navigate to the following contract functions:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccountHelper.sol#L19\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccountHelper.sol#L19</a><br></li>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/VUSD.sol#L39\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/VUSD.sol#L39</a><br></li>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/legos/Governable.sol#L16\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/legos/Governable.sol#L16</a><br></li>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/InsuranceFund.sol#L35\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/InsuranceFund.sol#L35</a><br></li>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccount.sol#L121\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccount.sol#L121</a><br></li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding zero-address checks in the discussed constructors:<br>\nrequire(newAddr != address(0));.</p>\n<h2 id=\"l-06-missing-events-for-governor-only-functions-that-change-critical-parameters\" style=\"position:relative;\"><a href=\"#l-06-missing-events-for-governor-only-functions-that-change-critical-parameters\" aria-label=\"l 06 missing events for governor only functions that change critical parameters permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-06] Missing events for governor only functions that change critical parameters</h2>\n<p>The governor only functions that change critical parameters should emit events. Events allow capturing the changed parameters so that off-chain tools/interfaces can register such changes with timelocks that allow users to evaluate them and consider if they would like to engage/exit based on how they perceive the changes as affecting the trustworthiness of the protocol or profitability of the implemented financial services. The alternative of directly querying on-chain contract state for such changes is not considered practical for most users/usages.</p>\n<p>Missing events and timelocks do not promote transparency and if such changes immediately affect users’ perception of fairness or trustworthiness, they could exit the protocol causing a reduction in liquidity which could negatively impact protocol TVL and reputation.</p>\n<p>There are owner functions that do not emit any events in the contracts.</p>\n<h3 id=\"proof-of-concept-22\" style=\"position:relative;\"><a href=\"#proof-of-concept-22\" aria-label=\"proof of concept 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Navigate to the following contracts:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccount.sol#L616\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccount.sol#L616</a><br></li>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/legos/Governable.sol#L19\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/legos/Governable.sol#L19</a><br></li>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/Oracle.sol#L162\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/Oracle.sol#L162</a><br></li>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/VUSD.sol#L74\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/VUSD.sol#L74</a><br></li>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/AMM.sol#L722\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/AMM.sol#L722</a><br></li>\n<li><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/AMM.sol#L737\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/AMM.sol#L737</a><br></li>\n</ul>\n<p>See similar High-severity H03 finding <a href=\"https://blog.openzeppelin.com/audius-contracts-audit/#high\">OpenZeppelin’s Audit of Audius</a> and Medium-severity M01 finding <a href=\"https://blog.openzeppelin.com/uma-audit-phase-4/\">OpenZeppelin’s Audit of UMA Phase 4</a>.</p>\n<h3 id=\"recommended-mitigation-steps-24\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-24\" aria-label=\"recommended mitigation steps 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add events to all admin/privileged functions that change critical parameters.</p>\n<h2 id=\"l-07-deprecated-safeapprove-function\" style=\"position:relative;\"><a href=\"#l-07-deprecated-safeapprove-function\" aria-label=\"l 07 deprecated safeapprove function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-07] Deprecated safeApprove() function</h2>\n<p>Detailed description of the impact of this finding.</p>\n<p>Using this deprecated function can lead to unintended reverts and potentially the locking of funds. A deeper discussion on the deprecation of this function is in <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2219\">OZ issue #2219</a>. The OpenZeppelin ERC20 <code>safeApprove()</code> function has been deprecated, as seen in the comments of the OpenZeppelin code.</p>\n<h3 id=\"proof-of-concept-23\" style=\"position:relative;\"><a href=\"#proof-of-concept-23\" aria-label=\"proof of concept 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Navigate to the following contract functions:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccountHelper.sol#L24\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccountHelper.sol#L24</a></p>\n<h3 id=\"recommended-mitigation-steps-25\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-25\" aria-label=\"recommended mitigation steps 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>As suggested by the OpenZeppelin comment, replace <code>safeApprove()</code> with <code>safeIncreaseAllowance()</code> or <code>safeDecreaseAllowance()</code> instead.</p>\n<h2 id=\"l-08-the-contract-should-approve0-first\" style=\"position:relative;\"><a href=\"#l-08-the-contract-should-approve0-first\" aria-label=\"l 08 the contract should approve0 first permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-08] The Contract Should Approve(0) first</h2>\n<p>Some tokens (like USDT L199) do not work when changing the allowance from an existing non-zero allowance value.<br>\nThey must first be approved by zero and then the actual allowance must be approved.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">IERC20(token).approve(address(operator), 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">IERC20(token).approve(address(operator), amount);</span></span></code></pre>\n<h3 id=\"proof-of-concept-24\" style=\"position:relative;\"><a href=\"#proof-of-concept-24\" aria-label=\"proof of concept 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Navigate to the following contract functions:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccountHelper.sol#L24\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccountHelper.sol#L24</a></p>\n<h3 id=\"recommended-mitigation-steps-26\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-26\" aria-label=\"recommended mitigation steps 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Approve with a zero amount first before setting the actual amount.</p>\n<h2 id=\"l-09-missing-pause-modifier-on-the-insurancefunds-contract\" style=\"position:relative;\"><a href=\"#l-09-missing-pause-modifier-on-the-insurancefunds-contract\" aria-label=\"l 09 missing pause modifier on the insurancefunds contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-09] Missing Pause Modifier On the InsuranceFunds contract</h2>\n<p>In case a hack occurs or an exploit is discovered, the team should be able to pause functionality until the necessary changes are made to the system.  The deposits should be paused with Pause modifier.</p>\n<h3 id=\"proof-of-concept-25\" style=\"position:relative;\"><a href=\"#proof-of-concept-25\" aria-label=\"proof of concept 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Navigate to the following contract functions:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/InsuranceFund.sol#L39\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/InsuranceFund.sol#L39</a><br></p>\n<p>There is no pause mechanism has been defined.</p>\n<h3 id=\"recommended-mitigation-steps-27\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-27\" aria-label=\"recommended mitigation steps 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Pause functionality on the contract would have helped secure the funds quickly.</p>\n<h2 id=\"n-01-use-of-blocktimestamp\" style=\"position:relative;\"><a href=\"#n-01-use-of-blocktimestamp\" aria-label=\"n 01 use of blocktimestamp permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Use of Block.timestamp</h2>\n<p>Block timestamps have historically been used for a variety of applications, such as entropy for random numbers (see the Entropy Illusion for further details), locking funds for periods of time, and various state-changing conditional statements that are time-dependent. Miners have the ability to adjust timestamps slightly, which can prove to be dangerous if block timestamps are used incorrectly in smart contracts.</p>\n<h3 id=\"proof-of-concept-26\" style=\"position:relative;\"><a href=\"#proof-of-concept-26\" aria-label=\"proof of concept 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Navigate to the following contract:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/legos/HubbleBase.sol#L49\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/legos/HubbleBase.sol#L49</a></p>\n<h3 id=\"recommended-mitigation-steps-28\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-28\" aria-label=\"recommended mitigation steps 28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Block timestamps should not be used for entropy or generating random numbers—i.e., they should not be the deciding factor (either directly or through some derivation) for winning a game or changing an important state.</p>\n<p>Time-sensitive logic is sometimes required; e.g., for unlocking contracts (time-locking), completing an ICO after a few weeks, or enforcing expiry dates. It is sometimes recommended to use block.number and an average block time to estimate times; with a 10 second block time, 1 week equates to approximately, 60480 blocks. Thus, specifying a block number at which to change a contract state can be more secure, as miners are unable to easily manipulate the block number.</p>\n<h2 id=\"n-02-missing-re-entrancy-guard\" style=\"position:relative;\"><a href=\"#n-02-missing-re-entrancy-guard\" aria-label=\"n 02 missing re entrancy guard permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] Missing Re-entrancy Guard</h2>\n<p>The re-entrancy guard is missing on the Eth anchor interaction. The external router interaction can cause to the re-entrancy vulnerability.</p>\n<h3 id=\"proof-of-concept-27\" style=\"position:relative;\"><a href=\"#proof-of-concept-27\" aria-label=\"proof of concept 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Navigate to the following contract functions:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/InsuranceFund.sol#L39\">https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/InsuranceFund.sol#L39</a></p>\n<h3 id=\"recommended-mitigation-steps-29\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-29\" aria-label=\"recommended mitigation steps 29 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Follow the check effect interaction pattern or put re-entrancy guard.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/92#issuecomment-1051705553\">atvanguard (Hubble) commented</a>:</strong></p>\n<blockquote>\n<p>Good QA report.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/92#issuecomment-1059792709\">moose-code (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Lots of good insights here <img class=\"emoji-icon\" alt=\"emoji-100\" data-icon=\"emoji-100\" style=\"display: inline; margin: 0; margin-top: 1px; position: relative; top: 5px; width: 25px\" src=\"data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAMMUlEQVR4Ae3YhXtcx90o4HfOnhVZlpntkMN0nTK3TsrMzPdjZmZmvh8zM5SZuQ04zInMsiVb0kq7e2jmPnBRj11t5HLy/gcz88Px4PaQhwRf5Q6xJQFTViAc9OWV2FVyVc6tq5hEZXlj0zylxxNKzkr0hng7/nMdo6OkQIFkGXnbl95mwn1c1mFvyWWBqxpuq/k13Oz0bOeyeZ5Z8eKaR9a0ARtyPpy4aophfBhdywj7fOGt5ZySrTUziQPoAwyxteDJJc+teXnBUAQEvnML78BQn5M4ArCGUHPhAt9d8LKS9RGBMjCVeMsovz3KD3cZrvkeTFlG3vWFs47xkkfP85zIwxpuj/wWbocxtvV4c8l39NgcgTrQCZzIaNW8MHFRw3vxz7CBrM+mgu/o8uqK1WgCdwf2tbg2510ZWY9rKhb6rDKAvOfMXUS2yLo+T6/4/YK1NVo8OvI23L6D8Q6vKPixPiNIgfnAvowbW3y2zTv7/Ejk+ZE7AXqM1Dx7kVfXrIaMycivXMff30WB9Houx9bIbM3orxKQOL38F52Zv6DVZUfJq0q+q8eaBIj0a9IjCEd4Rs3r+4xAoJPxlgV+LOPoBM0mth/hrJrViVHYSTbPtprvqhhPCFT4pxbveQT9R+AswmHaEYl2ZPhJg1zAk6zcq2iVnNfnG7t8Y8lYIgBSxoEhjvdZt8DVJVcAKuyb4+f6HELTwVb2JM5uCBkjEFnX4qXznJ/IkQKfyXgnDgNEVo9y1QIhUOU0Ocky8twZedI839Fjb814AgAEbsH0LC9oeFpFDoH7Mn43cv8QDUDFeYHNgdkWx6DDpoZXxv8nchr+YIHPIQKsZ0vimQ2txGgiRMvLo5V5Ga+e51t67ImsOsXh+yVvW82JeR5bcw4EOhmf6PG+EUoAmOfKhq2J+cjoYwn72F1wcSJDzHhn4LPj9ACgYSxxViIgS6Sjlpcf9cB8P5fO8aI5XlZyWUNuKZqMzzZcu55Lj3NJTRtwZ+IfRjhpiZK1kTbKRO8+zm7xmooRpECn4V8jBywRyRMTgGw1F7+Bu7Ho9ORvMJh15ImHH+fba66p2BoRaDLm0GpYAyga/jJw/yKvi1yaECgDtxR8whLnsesoayIC7YywwJaKpyWgCdzUsA89S+SUkWlA1mJ3xsiyF5AZTMFQ4vUFL60ZBtyaeG+L4cArGiBmHFvkExez4TiPaVgP2N/i42MsWIoGCTCacW6kU7ARUODtQ0w7hUATKAGpoQgky8gbg6lJiZPYH5hI3Jj4+1V8KOM5JV8PKPCREToFz6w5JwIxcH2bDziFjBMtOhENApdiy/97qTXvi3ScQs3amrMBqeTuPj3LyBcMZoh+4teHmKrZ2OMtuHYdj57juRUtwHzNPyZO9LkmsjWixULgpoK7ndpFGROAAltqzk1AHZhM7A/UlriMsaNcWLELAWWXyf+gbxn5PxhYwkn8LsBP0p7m4Q2PS0ATONjjhnMY6XBBZCwgcGiI+51GyeMj50VkzCXUnA2oA/cPUzmFDmdHri4ZRhOYyum+jGQZ+cusXM1ZFY8omIBAt8W+TfTa7K3ZFAGR2xtudgqbyDs8pWZ7RJteoFfTAnQi/xboOoVFzqt5RgKqFjePM2sA+biVK3gMHhuBhKmGt+Y0NY9NTECgjFzb5SZLnE2G3QXnR4YDArOJuQYQWFzk5i6VJR5Odow1NZsAZeBzgb4B5MHK9djdsDshY7bFuxven9FUXIhRCBxrc7BNbYlIhidENkQE6hbtwASgCUxH5kaIluKynGf1CICy4loUBpCXVuYcdkxxQU07AJMN/4xOzSpsSrQhcKTFcaewQNbieZHNgE7GIoYgULY4PE7hFGa5tOJJCUiBk13umaUygPyIldnOExJXNgjAzAL7YJiAjWj9PxcwY4kNtGseMcMVkREIHMw4FDkPkGE4d2oFGxu2A7oZn8uZ3kg0gHyjlVngUZHdCYF+xtQBClgHDCcCoMgoLFGRJ17YsDEhIPLhjLsjFwJakXEEANhJXvHoWa6pyQHTDX87TNeA8mEP3FlcfJQralYF4N7EO9s0kCylSFQAsJV2j0sWeGZiDAJTkY+1WahpQSJEhgtqAGiz6SQvq9gbESgDdxzlY/PUBpTf6YHbxEsjl0cgJm7t8Y4dVE5tKNACgFlW1XxdlwsTOeBDLfbl7EIDyLBuA/9tHSfaFInRBfYW7K1YCzgWeMduFpAMKL/K4NYQsHmWqyPbINAJ3D3GCQBAAMAliceM089oAqnDI0teWzMMGYcTb9nPPZsZTxwGBOwo+b45ZhKdjLU1j49cCIEC1y/wnwskg5MfM7hxQuA5BefUANyZ8SkAyEiJk9iBVs0VGd/S52osBpqG51WMA8rAf+R8cjfVRm6b5UMZeyMTibGCl9VoEJAAaHBrxr9+gANIBif8oMG9iaHI78zyipq1gSrxW9fzE+gDXM1w4rs7fGvDDgQkJABkgH7GtRXfPcnnkOBRXN7le3u8ODGODAAQUWTcE/jTm/lDFB6g8EcG81Syhp3z/GefPZGQcW2Ln8d/WGIVYxW/1OdlDRuQIwASInotPt3nJ2f5HAqAS2lVnF3yhj6vj2xAQEDKmM74eOLvT/JB9KxAeJvBXMhI4jtn+N6aTYGY+KVZfhWzTmEX6xPPqHh5zSMiGxPtQCfj9sB7Kv5ugftRWuJcWn3GF1nTZ11D3mZrw2xgZoSTLebQt0LhEwazitV4S4fHRYYC70z8/P/gE0hO4ycZX2RjwZqK8chIRtliZojjh5hBtIx9hDHCHoZmqFE7c8LfDRb+4Rg7e3ysYBcWEz+c8RdYNDi/Q0DyFSK83PJ+hXaXR83ynw0bMybxzXinM+c81k5QonuQx7U4F/2aNW3ua3PfOo7NcU6i3Ml9aJw5+T9Z3iRDOZdE8oTAVIt5K7CLbX1297m4oVWz5ijbJkmJ+RaPztiZKBLjOBw5eJSZwI5EdZybRvngBm5C1xnIj1texVDDJWhD5AZMWcZljMyys2BLl2012w9zduBS7Im0IusTrRpQIyEBAhdBCxHQ0K954hy/gfc7A+FTljfBxobfmeWFWEh8W8Vb0QOAKwld1lVsX2RLwzkZD09cUnNpzeYGEQnBaaVAjQBIaLCAk4HhRBH55U/z50hWKP+I5T2bVmIDQotPRG4dpgcAZ5PPsLPi+XhazeNK1tdIlpIySpTI0EGT6GMxcDLQQQCkQA+TQ9ycMVFzuMdnEc7oAgygZihyMVoZ+07zN7+m4SUL/GJFjgCAGiXKQC8wHTja4giG8NkW8wX3d7i7y3Sg2EwEQIJEQkAaJT3ZmcmfbHkZDaaxYYGPTzFtia2kSF3TABrEQDdjMnBTxh2RW6a5bgOziAhokBATsSQhHXBayRdIfq/lXUkv8IEWWWDm72ks8WRmI+8Z5dkl3RY3N0wW3Bo4MMxioApU91HcR/LlJ/y25T2bdsVli7yx4Tew3ykM08bOPrFNt6Y4SQ+VZVzCeEZ7DfOzjGPoLGYOMYYFgMTqnSwiOnNCMpi7GeqwM3AIhRXaQ+sgOyq2VuwNzCVGKi7qsjMxhKGGLKNAnugOcxCrarY0yJka4a5hPrmGT2PeCoQpXzwl2xLbe+zpc2XF+P/u/ZgI7E70kWN9wwQkJAQAZHQxlMgTAiljGpOBD67mb3CTByjc4gvjUlqHuKhmU5eLFtmOsxMbcWHi/EiWEJGQAAkQfH4B6GacwGxiBE3G+0b4A9ziAcoLK7ObdoftfXb12HoDuxJXYWvkipqtEc3nP2AM1IEmsIATWIgcQxMYbzgYqCHQD8zkTGVMR4YTZeSmD3OnFQi/aXAvJU9s6rG54OLEoxJX1VzcsK06zZQXKNELdBIFmsi9gZOBMqPb4jgOtJgpuKumGmPD9dxUUEACyi95F4BnkWNPyTMbHlfyiJJNjaXUgQL9xFxgJnAw52hgMnEiUNzDW2boRaDwZZIbUGQ48S3zvLRmNQAiKvQxnzGZcTjjvsinulw/x5GlX+a7Sbt9+YVPG8wqxvBzc7y2YQIlqoy5wF2BT0c+vMjnxilzYkOzSET0FSq812C2ESLrSn6sZqLPO/vcntPP6QzTayhQ+ioSPuaBGWNLRdZl7pP0EX0VC7/gwS3zIPfQBTx0AQ9yD12AB7mHLsCD3EMX4EHufwJIOEs9kLQJngAAAABJRU5ErkJggg==\" title=\"emoji-100\" /> </p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 21 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/135\">report highlighted below</a> by <strong>Dravee</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/60\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/82\">Jujic</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/102\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/18\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/108\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/125\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/2\">robee</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/126\">throttle</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/111\">0v3rf10w</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/34\">CertoraInc</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/12\">d4rk</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/88\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/79\">kenta</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/85\">sorrynotsorry</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/6\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/68\">Meta0xNull</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/117\">Omik</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/95\">Tomio</a>, <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/106\">pauliax</a>, and <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/120\">danb</a>.</em></p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<p>See <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/135\">original submission</a> for table of contents.</p>\n<h2 id=\"foreword\" style=\"position:relative;\"><a href=\"#foreword\" aria-label=\"foreword permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Foreword</h2>\n<ul>\n<li><strong>Storage-reading optimizations</strong></li>\n</ul>\n<blockquote>\n<p>The code can be optimized by minimising the number of SLOADs. SLOADs are expensive (100 gas) compared to MLOADs/MSTOREs (3 gas). In the paragraphs below, please see the <code>@audit-issue</code> tags in the pieces of code’s comments for more information about SLOADs that could be saved by caching the mentioned <strong>storage</strong> variables in <strong>memory</strong> variables.</p>\n</blockquote>\n<ul>\n<li><strong>Unchecking arithmetics operations that can’t underflow/overflow</strong></li>\n</ul>\n<blockquote>\n<p>Solidity version 0.8+ comes with implicit overflow and underflow checks on unsigned integers. When an overflow or an underflow isn’t possible (as an example, when a comparison is made before the arithmetic operation, or the operation doesn’t depend on user input), some gas can be saved by using an <code>unchecked</code> block: <a href=\"https://docs.soliditylang.org/en/v0.8.10/control-structures.html#checked-or-unchecked-arithmetic\">https://docs.soliditylang.org/en/v0.8.10/control-structures.html#checked-or-unchecked-arithmetic</a></p>\n</blockquote>\n<ul>\n<li><strong><code>@audit</code> tags</strong></li>\n</ul>\n<blockquote>\n<p>The code is annotated at multiple places with <code>//@audit</code> comments to pinpoint the issues. Please, pay attention to them for more details.</p>\n</blockquote>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<ul>\n<li>One pattern that was often seen is caching structs in memory when it’s not needed. A copy in memory of a storage struct will trigger as many SLOADs as there are slots. If the struct’s fields are only read once, or if the number of storage reading would be inferior to the number of slots: don’t cache the struct in memory.</li>\n</ul>\n<h2 id=\"file-ammsol\" style=\"position:relative;\"><a href=\"#file-ammsol\" aria-label=\"file ammsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File: AMM.sol</h2>\n<h3 id=\"function-initialize\" style=\"position:relative;\"><a href=\"#function-initialize\" aria-label=\"function initialize permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function initialize()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">093:     function initialize(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">094:         address _registry,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">095:         address _underlyingAsset,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">096:         string memory _name,//@audit readonly: calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">097:         address _vamm,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">098:         address _governance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">099:     ) external initializer {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">100:         _setGovernace(_governance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">101: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">102:         vamm = IVAMM(_vamm);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">103:         underlyingAsset = _underlyingAsset;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">104:         name = _name;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">105:         fundingBufferPeriod = 15 minutes;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">106: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">107:         syncDeps(_registry);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">108:     }</span></span></code></pre>\n<h4 id=\"use-calldata-instead-of-memory-for-string-_name\" style=\"position:relative;\"><a href=\"#use-calldata-instead-of-memory-for-string-_name\" aria-label=\"use calldata instead of memory for string _name permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use <code>calldata</code> instead of <code>memory</code> for <code>string _name</code></h4>\n<p>An external function passing a readonly variable should mark it as <code>calldata</code> and not <code>memory</code></p>\n<h3 id=\"function-openposition\" style=\"position:relative;\"><a href=\"#function-openposition\" aria-label=\"function openposition permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function openPosition()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">113:     function openPosition(address trader, int256 baseAssetQuantity, uint quoteAssetLimit)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">114:         override</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">115:         external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">116:         onlyClearingHouse</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">117:         returns (int realizedPnl, uint quoteAsset, bool isPositionIncreased)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">118:     {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">119:         require(ammState == AMMState.Active, &quot;AMM.openPosition.not_active&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">120:         Position memory position = positions[trader]; //@audit 3 SLOADs vs 1 enough</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">121:         bool isNewPosition = position.size == 0 ? true : false;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">122:         Side side = baseAssetQuantity &gt; 0 ? Side.LONG : Side.SHORT;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">123:         if (isNewPosition || (position.size &gt; 0 ? Side.LONG : Side.SHORT) == side) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">124:             // realizedPnl = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">125:             quoteAsset = _increasePosition(trader, baseAssetQuantity, quoteAssetLimit);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">126:             isPositionIncreased = true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">127:         } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">128:             (realizedPnl, quoteAsset, isPositionIncreased) = _openReversePosition(trader, baseAssetQuantity, quoteAssetLimit);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">129:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">130:         _emitPositionChanged(trader, realizedPnl);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">131:     }</span></span></code></pre>\n<h4 id=\"do-not-cache-positionstrader-in-memory\" style=\"position:relative;\"><a href=\"#do-not-cache-positionstrader-in-memory\" aria-label=\"do not cache positionstrader in memory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Do not cache <code>positions[trader]</code> in memory</h4>\n<p>As a copy in memory of a struct makes as many SLOADs as there are slots, here a copy costs 3 SLOADs:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">41:     struct Position {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">42:         int256 size;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">43:         uint256 openNotional;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">44:         int256 lastPremiumFraction;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">45:     }</span></span></code></pre>\n<p>However, only the <code>size</code> field is read twice. Therefore, only this field should get cached: <code>int256 _size = positions[trader].size;</code></p>\n<h3 id=\"function-liquidateposition\" style=\"position:relative;\"><a href=\"#function-liquidateposition\" aria-label=\"function liquidateposition permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function liquidatePosition()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">133:     function liquidatePosition(address trader)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">134:         override</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">135:         external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">136:         onlyClearingHouse</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">137:         returns (int realizedPnl, uint quoteAsset)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">138:     {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">139:         // don&#39;t need an ammState check because there should be no active positions</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">140:         Position memory position = positions[trader]; //@audit 3 SLOADs vs 1 enough</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">141:         bool isLongPosition = position.size &gt; 0 ? true : false;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">142:         // sending market orders can fk the trader. @todo put some safe guards around price of liquidations</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">143:         if (isLongPosition) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">144:             (realizedPnl, quoteAsset) = _reducePosition(trader, -position.size, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">145:         } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">146:             (realizedPnl, quoteAsset) = _reducePosition(trader, -position.size, type(uint).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">147:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">148:         _emitPositionChanged(trader, realizedPnl);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">149:     }</span></span></code></pre>\n<h4 id=\"do-not-cache-positionstrader-in-memory-1\" style=\"position:relative;\"><a href=\"#do-not-cache-positionstrader-in-memory-1\" aria-label=\"do not cache positionstrader in memory 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Do not cache <code>positions[trader]</code> in memory</h4>\n<p>Similar to <a href=\"#do-not-cache-positionstrader-in-memory\">Do not cache <code>positions[trader]</code> in memory</a>.</p>\n<p>However, only the <code>size</code> field is read 3 times. Therefore, only this field should get cached: <code>int256 _size = positions[trader].size;</code></p>\n<h3 id=\"function-removeliquidity\" style=\"position:relative;\"><a href=\"#function-removeliquidity\" aria-label=\"function removeliquidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function removeLiquidity()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">133:     function liquidatePosition(address trader)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">134:         override</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">135:         external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">136:         onlyClearingHouse</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">137:         returns (int realizedPnl, uint quoteAsset)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">138:     {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">139:         // don&#39;t need an ammState check because there should be no active positions</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">140:         Position memory position = positions[trader]; //@audit 3 SLOADs vs 1 enough</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">141:         bool isLongPosition = position.size &gt; 0 ? true : false;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">142:         // sending market orders can fk the trader. @todo put some safe guards around price of liquidations</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">143:         if (isLongPosition) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">144:             (realizedPnl, quoteAsset) = _reducePosition(trader, -position.size, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">145:         } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">146:             (realizedPnl, quoteAsset) = _reducePosition(trader, -position.size, type(uint).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">147:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">148:         _emitPositionChanged(trader, realizedPnl);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">149:     }</span></span></code></pre>\n<h4 id=\"do-not-cache-positionsmaker-in-memory\" style=\"position:relative;\"><a href=\"#do-not-cache-positionsmaker-in-memory\" aria-label=\"do not cache positionsmaker in memory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Do not cache <code>positions[maker]</code> in memory</h4>\n<p>Similar to <a href=\"#do-not-cache-positionstrader-in-memory\">Do not cache <code>positions[trader]</code> in memory</a>.\nHowever, here, even the fields shouldn’t get cached, as they are read only once:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">220:         Position memory _taker = positions[maker];//@audit 3 SLOADs vs 2 enough</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">233:             _taker.size,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">234:             _taker.openNotional</span></span></code></pre>\n<p>Therefore, use <code>220: Position storage _taker = positions[maker];</code></p>\n<h4 id=\"do-not-cache-makersmaker-in-memory\" style=\"position:relative;\"><a href=\"#do-not-cache-makersmaker-in-memory\" aria-label=\"do not cache makersmaker in memory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Do not cache <code>makers[maker]</code> in memory</h4>\n<p>Similarly, a copy in memory for <code>Maker</code> costs 7 SLOADs:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">48:     struct Maker {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">49:         uint vUSD;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">50:         uint vAsset;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">51:         uint dToken;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">52:         int pos; // position</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">53:         int posAccumulator; // value of global.posAccumulator until which pos has been updated</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">54:         int lastPremiumFraction;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">55:         int lastPremiumPerDtoken;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">56:     }</span></span></code></pre>\n<p>Here, caching the first 5 fields in memory is enough.</p>\n<h3 id=\"function-getnotionalpositionandunrealizedpnl\" style=\"position:relative;\"><a href=\"#function-getnotionalpositionandunrealizedpnl\" aria-label=\"function getnotionalpositionandunrealizedpnl permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function getNotionalPositionAndUnrealizedPnl()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">395:     function getNotionalPositionAndUnrealizedPnl(address trader)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">396:         override</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">397:         external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">398:         view</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">399:         returns(uint256 notionalPosition, int256 unrealizedPnl, int256 size, uint256 openNotional)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">400:     {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">401:         Position memory _taker = positions[trader];//@audit 3 SLOADs vs 2 enough</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">402:         Maker memory _maker = makers[trader];//@audit 7 SLOADs vs 3 enough</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">403: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">404:         (notionalPosition, size, unrealizedPnl, openNotional) = vamm.get_notional(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">405:             _maker.dToken,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">406:             _maker.vUSD,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">407:             _maker.vAsset,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">408:             _taker.size,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">409:             _taker.openNotional</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">410:         );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">411:     }</span></span></code></pre>\n<h4 id=\"do-not-cache-positionstrader-in-memory-2\" style=\"position:relative;\"><a href=\"#do-not-cache-positionstrader-in-memory-2\" aria-label=\"do not cache positionstrader in memory 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Do not cache <code>positions[trader]</code> in memory</h4>\n<p>Here, we need <code>Position storage _taker = positions[trader];</code></p>\n<h4 id=\"do-not-cache-makerstrader-in-memory\" style=\"position:relative;\"><a href=\"#do-not-cache-makerstrader-in-memory\" aria-label=\"do not cache makerstrader in memory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Do not cache <code>makers[trader]</code> in memory</h4>\n<p>Here, we need <code>Maker storage _maker = makers[trader];</code></p>\n<h3 id=\"function-getpendingfundingpayment\" style=\"position:relative;\"><a href=\"#function-getpendingfundingpayment\" aria-label=\"function getpendingfundingpayment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function getPendingFundingPayment()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">425:         Position memory taker = positions[trader];//@audit 3 SLOADs vs 2 enough</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">434:         Maker memory maker = makers[trader];//@audit 7 SLOADs vs 5 enough</span></span></code></pre>\n<h4 id=\"do-not-cache-positionstrader-in-memory-3\" style=\"position:relative;\"><a href=\"#do-not-cache-positionstrader-in-memory-3\" aria-label=\"do not cache positionstrader in memory 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Do not cache <code>positions[trader]</code> in memory</h4>\n<p>Here, we need <code>Position storage _taker = positions[trader];</code></p>\n<h4 id=\"do-not-cache-makerstrader-in-memory-1\" style=\"position:relative;\"><a href=\"#do-not-cache-makerstrader-in-memory-1\" aria-label=\"do not cache makerstrader in memory 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Do not cache <code>makers[trader]</code> in memory</h4>\n<p>Here, we need <code>Maker storage _maker = makers[trader];</code></p>\n<h3 id=\"function-gettakernotionalpositionandunrealizedpnl\" style=\"position:relative;\"><a href=\"#function-gettakernotionalpositionandunrealizedpnl\" aria-label=\"function gettakernotionalpositionandunrealizedpnl permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function getTakerNotionalPositionAndUnrealizedPnl()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">458:     function getTakerNotionalPositionAndUnrealizedPnl(address trader) override public view returns(uint takerNotionalPosition, int256 unrealizedPnl) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">459:         Position memory position = positions[trader];//@audit 3 SLOADs vs 2 enough</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">460:         if (position.size &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">461:             takerNotionalPosition = vamm.get_dy(1, 0, position.size.toUint256());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">462:             unrealizedPnl = takerNotionalPosition.toInt256() - position.openNotional.toInt256();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">463:         } else if (position.size &lt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">464:             takerNotionalPosition = vamm.get_dx(0, 1, (-position.size).toUint256());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">465:             unrealizedPnl = position.openNotional.toInt256() - takerNotionalPosition.toInt256();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">466:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">467:     }</span></span></code></pre>\n<h4 id=\"do-not-cache-positionstrader-in-memory-4\" style=\"position:relative;\"><a href=\"#do-not-cache-positionstrader-in-memory-4\" aria-label=\"do not cache positionstrader in memory 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Do not cache <code>positions[trader]</code> in memory</h4>\n<p>Here, we need to cache these fields: <code>size</code> and <code>openNotional</code></p>\n<h3 id=\"function-_emitpositionchanged\" style=\"position:relative;\"><a href=\"#function-_emitpositionchanged\" aria-label=\"function _emitpositionchanged permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _emitPositionChanged()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">527:     function _emitPositionChanged(address trader, int256 realizedPnl) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">528:         Position memory position = positions[trader];//@audit 3 SLOADs vs 2 enough</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">529:         emit PositionChanged(trader, position.size, position.openNotional, realizedPnl);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">530:     }</span></span></code></pre>\n<h4 id=\"do-not-cache-positionstrader-in-memory-5\" style=\"position:relative;\"><a href=\"#do-not-cache-positionstrader-in-memory-5\" aria-label=\"do not cache positionstrader in memory 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Do not cache <code>positions[trader]</code> in memory</h4>\n<p>Here, we need <code>Position storage _taker = positions[trader];</code></p>\n<h3 id=\"function-_openreverseposition\" style=\"position:relative;\"><a href=\"#function-_openreverseposition\" aria-label=\"function _openreverseposition permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _openReversePosition()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">584:     function _openReversePosition(address trader, int256 baseAssetQuantity, uint quoteAssetLimit)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">585:         internal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">586:         returns (int realizedPnl, uint quoteAsset, bool isPositionIncreased)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">587:     {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">588:         Position memory position = positions[trader];//@audit 3 SLOADs vs 1 enough</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">589:         if (abs(position.size) &gt;= abs(baseAssetQuantity)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">590:             (realizedPnl, quoteAsset) = _reducePosition(trader, baseAssetQuantity, quoteAssetLimit);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">591:         } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">592:             uint closedRatio = (quoteAssetLimit * abs(position.size).toUint256()) / abs(baseAssetQuantity).toUint256();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">593:             (realizedPnl, quoteAsset) = _reducePosition(trader, -position.size, closedRatio);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">594: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">595:             // this is required because the user might pass a very less value (slippage-prone) while shorting</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">596:             if (quoteAssetLimit &gt;= quoteAsset) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">597:                 quoteAssetLimit -= quoteAsset; //@audit uncheck (see L596)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">598:             }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">599:             quoteAsset += _increasePosition(trader, baseAssetQuantity + position.size, quoteAssetLimit);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">600:             isPositionIncreased = true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">601:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">602:     }</span></span></code></pre>\n<h4 id=\"do-not-cache-positionstrader-in-memory-6\" style=\"position:relative;\"><a href=\"#do-not-cache-positionstrader-in-memory-6\" aria-label=\"do not cache positionstrader in memory 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Do not cache <code>positions[trader]</code> in memory</h4>\n<p>Here, we need to cache the <code>size</code> field</p>\n<h4 id=\"unchecked-block-l597\" style=\"position:relative;\"><a href=\"#unchecked-block-l597\" aria-label=\"unchecked block l597 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unchecked block L597</h4>\n<p>This line can’t underflow due to the condition L596. Therefore, it should be wrapped in an <code>unchecked</code> block</p>\n<h3 id=\"function-_calctwap\" style=\"position:relative;\"><a href=\"#function-_calctwap\" aria-label=\"function _calctwap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _calcTwap()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">656:     function _calcTwap(uint256 _intervalInSeconds)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">657:         internal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">658:         view</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">659:         returns (uint256)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">660:     {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">661:         uint256 snapshotIndex = reserveSnapshots.length - 1; //@audit reserveSnapshots.length  SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">662:         uint256 currentPrice = reserveSnapshots[snapshotIndex].lastPrice;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">663:         if (_intervalInSeconds == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">664:             return currentPrice;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">665:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">666: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">667:         uint256 baseTimestamp = _blockTimestamp() - _intervalInSeconds;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">668:         ReserveSnapshot memory currentSnapshot = reserveSnapshots[snapshotIndex];//@audit 3 SLOADs vs 1 enough</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">669:         // return the latest snapshot price directly</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">670:         // if only one snapshot or the timestamp of latest snapshot is earlier than asking for</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">671:         if (reserveSnapshots.length == 1 || currentSnapshot.timestamp &lt;= baseTimestamp) {//@audit reserveSnapshots.length  SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">675:         uint256 previousTimestamp = currentSnapshot.timestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">676:         uint256 period = _blockTimestamp() - previousTimestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">677:         uint256 weightedPrice = currentPrice * period;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">678:         while (true) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">680:             if (snapshotIndex == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">681:                 return weightedPrice / period;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">682:             }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">684:             snapshotIndex = snapshotIndex - 1; //@audit uncheck (see L680-L682)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">685:             currentSnapshot = reserveSnapshots[snapshotIndex];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">686:             currentPrice = reserveSnapshots[snapshotIndex].lastPrice; //@audit use currentSnapshot.lastPrice</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">689:             if (currentSnapshot.timestamp &lt;= baseTimestamp) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">698:             uint256 timeFraction = previousTimestamp - currentSnapshot.timestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">701:             previousTimestamp = currentSnapshot.timestamp;</span></span></code></pre>\n<h4 id=\"do-not-cache-reservesnapshotssnapshotindex-in-memory\" style=\"position:relative;\"><a href=\"#do-not-cache-reservesnapshotssnapshotindex-in-memory\" aria-label=\"do not cache reservesnapshotssnapshotindex in memory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Do not cache <code>reserveSnapshots[snapshotIndex]</code> in memory</h4>\n<p>Here, we need to cache the <code>timestamp</code> field. Copying the struct in memory costs 3 SLOADs.</p>\n<h4 id=\"cache-reservesnapshotslength-in-memory\" style=\"position:relative;\"><a href=\"#cache-reservesnapshotslength-in-memory\" aria-label=\"cache reservesnapshotslength in memory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>reserveSnapshots.length</code> in memory</h4>\n<p>This would save 1 SLOAD</p>\n<h4 id=\"unchecked-block-l684\" style=\"position:relative;\"><a href=\"#unchecked-block-l684\" aria-label=\"unchecked block l684 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unchecked block L684</h4>\n<p>This line can’t underflow due to the condition L680-L682. Therefore, it should be wrapped in an <code>unchecked</code> block</p>\n<h4 id=\"use-the-cache-for-calculation\" style=\"position:relative;\"><a href=\"#use-the-cache-for-calculation\" aria-label=\"use the cache for calculation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use the cache for calculation</h4>\n<p>As we already have <code>currentSnapshot = reserveSnapshots[snapshotIndex];</code>: use it here: <code>currentPrice = currentSnapshot.lastPrice;</code></p>\n<h2 id=\"file-clearinghousesol\" style=\"position:relative;\"><a href=\"#file-clearinghousesol\" aria-label=\"file clearinghousesol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File: ClearingHouse.sol</h2>\n<h3 id=\"function-_disperseliquidationfee\" style=\"position:relative;\"><a href=\"#function-_disperseliquidationfee\" aria-label=\"function _disperseliquidationfee permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _disperseLiquidationFee()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">210:     function _disperseLiquidationFee(uint liquidationFee) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">211:         if (liquidationFee &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">212:             uint toInsurance = liquidationFee / 2;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">213:             marginAccount.transferOutVusd(address(insuranceFund), toInsurance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">214:             marginAccount.transferOutVusd(_msgSender(), liquidationFee - toInsurance); //@audit uncheck (see L212)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">215:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">216:     }</span></span></code></pre>\n<h4 id=\"unchecked-block-l214\" style=\"position:relative;\"><a href=\"#unchecked-block-l214\" aria-label=\"unchecked block l214 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unchecked block L214</h4>\n<p>This line can’t underflow due to the condition L212. Therefore, it should be wrapped in an <code>unchecked</code> block</p>\n<h2 id=\"file-insurancefundsol\" style=\"position:relative;\"><a href=\"#file-insurancefundsol\" aria-label=\"file insurancefundsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File: InsuranceFund.sol</h2>\n<h3 id=\"function-pricepershare\" style=\"position:relative;\"><a href=\"#function-pricepershare\" aria-label=\"function pricepershare permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function pricePerShare()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: InsuranceFund.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">094:     function pricePerShare() external view returns (uint) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">095:         uint _totalSupply = totalSupply();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">096:         uint _balance = balance();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">097:         _balance -= Math.min(_balance, pendingObligation); //@audit uncheck</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">098:         if (_totalSupply == 0 || _balance == 0) </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">099:             return PRECISION;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">100:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">101:         return _balance * PRECISION / </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">_totalSupply;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">102:     }</span></span></code></pre>\n<h4 id=\"unchecked-block-l97\" style=\"position:relative;\"><a href=\"#unchecked-block-l97\" aria-label=\"unchecked block l97 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unchecked block L97</h4>\n<p>This line can’t underflow for obvious mathematical reasons (<code>_balance</code> substracting at most itself). Therefore, it should be wrapped in an <code>unchecked</code> block</p>\n<h2 id=\"file-oraclesol\" style=\"position:relative;\"><a href=\"#file-oraclesol\" aria-label=\"file oraclesol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File: Oracle.sol</h2>\n<h3 id=\"function-getunderlyingtwapprice\" style=\"position:relative;\"><a href=\"#function-getunderlyingtwapprice\" aria-label=\"function getunderlyingtwapprice permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function getUnderlyingTwapPrice()</h3>\n<h4 id=\"unchecked-block-l81\" style=\"position:relative;\"><a href=\"#unchecked-block-l81\" aria-label=\"unchecked block l81 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unchecked block L81</h4>\n<p>This line can’t underflow due to L76-L79. Therefore, it should be wrapped in an <code>unchecked</code> block</p>\n<h2 id=\"file-interfacessol\" style=\"position:relative;\"><a href=\"#file-interfacessol\" aria-label=\"file interfacessol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File: Interfaces.sol</h2>\n<h3 id=\"struct-collateral\" style=\"position:relative;\"><a href=\"#struct-collateral\" aria-label=\"struct collateral permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>struct Collateral</h3>\n<h4 id=\"tight-packing-structs-to-save-slots\" style=\"position:relative;\"><a href=\"#tight-packing-structs-to-save-slots\" aria-label=\"tight packing structs to save slots permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tight packing structs to save slots</h4>\n<p>While this file is out of scope, it deeply impacts MarginAccount.sol.\nI suggest going from:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">94:     struct Collateral {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">95:         IERC20 token; //@audit 20 bytes</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">96:         uint weight; //@audit 32 bytes</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">97:         uint8 decimals; //@audit 1 byte</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">98:     }</span></span></code></pre>\n<p>to</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">94:     struct Collateral {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">95:         IERC20 token; //@audit 20 bytes</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">96:         uint8 decimals; //@audit 1 byte</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">97:         uint weight; //@audit 32 bytes</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">98:     }</span></span></code></pre>\n<p>To save 1 slot per array element in MarginAccount.sol’s storage</p>\n<h2 id=\"file-marginaccountsol\" style=\"position:relative;\"><a href=\"#file-marginaccountsol\" aria-label=\"file marginaccountsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File: MarginAccount.sol</h2>\n<h3 id=\"function-_getliquidationinfo\" style=\"position:relative;\"><a href=\"#function-_getliquidationinfo\" aria-label=\"function _getliquidationinfo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _getLiquidationInfo()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">460:     function _getLiquidationInfo(address trader, uint idx) internal view returns (LiquidationBuffer memory buffer) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">461:         require(idx &gt; VUSD_IDX &amp;&amp; idx &lt; supportedCollateral.length, &quot;collateral not seizable&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">462:         (buffer.status, buffer.repayAble, buffer.incentivePerDollar) = isLiquidatable(trader, false);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">463:         if (buffer.status == IMarginAccount.LiquidationStatus.IS_LIQUIDATABLE) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">464:             Collateral memory coll = supportedCollateral[idx];//@audit 3 SLOADs vs 2 enough</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">465:             buffer.priceCollateral = oracle.getUnderlyingPrice(address(coll.token)).toUint256();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">466:             buffer.decimals = coll.decimals;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">467:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">468:     }</span></span></code></pre>\n<h4 id=\"do-not-cache-supportedcollateralidx-in-memory\" style=\"position:relative;\"><a href=\"#do-not-cache-supportedcollateralidx-in-memory\" aria-label=\"do not cache supportedcollateralidx in memory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Do not cache <code>supportedCollateral[idx]</code> in memory</h4>\n<p>Here, we need <code>Collateral storage coll = supportedCollateral[idx];</code>. Copying the struct in memory costs 3 SLOADs.</p>\n<h3 id=\"function-_transferoutvusd\" style=\"position:relative;\"><a href=\"#function-_transferoutvusd\" aria-label=\"function _transferoutvusd permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _transferOutVusd()</h3>\n<h4 id=\"unchecked-block-l588\" style=\"position:relative;\"><a href=\"#unchecked-block-l588\" aria-label=\"unchecked block l588 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unchecked block L588</h4>\n<p>This line can’t underflow due to L583. Therefore, it should be wrapped in an <code>unchecked</code> block</p>\n<h2 id=\"file-vusdsol\" style=\"position:relative;\"><a href=\"#file-vusdsol\" aria-label=\"file vusdsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File: VUSD.sol</h2>\n<h3 id=\"function-processwithdrawals\" style=\"position:relative;\"><a href=\"#function-processwithdrawals\" aria-label=\"function processwithdrawals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function processWithdrawals()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">53:     function processWithdrawals() external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">54:         uint reserve = reserveToken.balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">55:         require(reserve &gt;= withdrawals[start].amount, &#39;Cannot process withdrawals at this time: Not enough balance&#39;); //@audit start SLOAD 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">56:         uint i = start;//@audit start SLOAD 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">57:         while (i &lt; withdrawals.length &amp;&amp; (i - start) &lt;= maxWithdrawalProcesses) { //@audit uncheck whole //@audit start SLOAD 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">58:             Withdrawal memory withdrawal = withdrawals[i]; //@audit-ok</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">59:             if (reserve &lt; withdrawal.amount) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">60:                 break;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">61:             }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">62:             reserveToken.safeTransfer(withdrawal.usr, withdrawal.amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">63:             reserve -= withdrawal.amount;  //@audit uncheck (see L59-L61)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">64:             i += 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">65:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">66:         start = i;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">67:     }</span></span></code></pre>\n<h4 id=\"unchecked-block-l57-l65\" style=\"position:relative;\"><a href=\"#unchecked-block-l57-l65\" aria-label=\"unchecked block l57 l65 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unchecked block L57-L65</h4>\n<p>The whole while-loop can’t underflow. Therefore, it should be wrapped in an <code>unchecked</code> block</p>\n<h4 id=\"cache-start-in-memory\" style=\"position:relative;\"><a href=\"#cache-start-in-memory\" aria-label=\"cache start in memory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>start</code> in memory</h4>\n<p>Cache <code>start</code> in memory as <code>initialStart</code> and use it L55 + L57 (compare <code>i</code> to it in the while-loop)</p>\n<h2 id=\"general-recommendations\" style=\"position:relative;\"><a href=\"#general-recommendations\" aria-label=\"general recommendations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>General Recommendations</h2>\n<h3 id=\"variables\" style=\"position:relative;\"><a href=\"#variables\" aria-label=\"variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Variables</h3>\n<h4 id=\"no-need-to-explicitly-initialize-variables-with-default-values\" style=\"position:relative;\"><a href=\"#no-need-to-explicitly-initialize-variables-with-default-values\" aria-label=\"no need to explicitly initialize variables with default values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>No need to explicitly initialize variables with default values</h4>\n<p>If a variable is not set/initialized, it is assumed to have the default value (<code>0</code> for <code>uint</code>, <code>false</code> for <code>bool</code>, <code>address(0)</code> for address…). Explicitly initializing it with its default value is an anti-pattern and wastes gas.</p>\n<p>As an example: <code>for (uint256 i = 0; i &#x3C; numIterations; ++i) {</code> should be replaced with <code>for (uint256 i; i &#x3C; numIterations; ++i) {</code></p>\n<p>Instances include:  </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:122:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:130:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:170:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:194:        for (uint i = 0; i &lt; amms.length; i++) { // liquidate all positions</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:251:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:263:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:277:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">InsuranceFund.sol:52:        uint shares = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:31:    uint constant VUSD_IDX = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:331:        for (uint i = 0; i &lt; idxs.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:521:        for (uint i = 0; i &lt; assets.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:552:        for (uint i = 0; i &lt; _collaterals.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccountHelper.sol:13:    uint constant VUSD_IDX = 0;</span></span></code></pre>\n<p>I suggest removing explicit initializations for default values.</p>\n<h4 id=\"pre-increments-cost-less-gas-compared-to-post-increments\" style=\"position:relative;\"><a href=\"#pre-increments-cost-less-gas-compared-to-post-increments\" aria-label=\"pre increments cost less gas compared to post increments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pre-increments cost less gas compared to post-increments</h4>\n<h3 id=\"comparisons\" style=\"position:relative;\"><a href=\"#comparisons\" aria-label=\"comparisons permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comparisons</h3>\n<h4 id=\"-0-is-less-efficient-than--0-for-unsigned-integers-with-proof\" style=\"position:relative;\"><a href=\"#-0-is-less-efficient-than--0-for-unsigned-integers-with-proof\" aria-label=\" 0 is less efficient than  0 for unsigned integers with proof permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code>> 0</code> is less efficient than <code>!= 0</code> for unsigned integers (with proof)</h4>\n<p><code>!= 0</code> costs less gas compared to <code>> 0</code> for unsigned integers in <code>require</code> statements with the optimizer enabled (6 gas)</p>\n<p>Proof: While it may seem that <code>> 0</code> is cheaper than <code>!=</code>, this is only true without the optimizer enabled and outside a require statement. If you enable the optimizer at 10k AND you’re in a <code>require</code> statement, this will save gas. You can see this tweet for more proofs: <a href=\"https://twitter.com/gzeon/status/1485428085885640706\">https://twitter.com/gzeon/status/1485428085885640706</a></p>\n<p><code>> 0</code> in require statements are used in the following location(s):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">AMM.sol:487:        require(baseAssetQuantity &gt; 0, &quot;VAMM._long: baseAssetQuantity is &lt;= 0&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">AMM.sol:511:        require(baseAssetQuantity &lt; 0, &quot;VAMM._short: baseAssetQuantity is &gt;= 0&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:51:        require(_maintenanceMargin &gt; 0, &quot;_maintenanceMargin &lt; 0&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:150:        require(amount &gt; 0, &quot;Add non-zero margin&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Oracle.sol:153:        require(_round &gt; 0, &quot;Not enough history&quot;);</span></span></code></pre>\n<p>I suggest you change <code>> 0</code> with <code>!= 0</code> in require statements. Also, enable the Optimizer.</p>\n<h3 id=\"for-loops\" style=\"position:relative;\"><a href=\"#for-loops\" aria-label=\"for loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>For-Loops</h3>\n<h4 id=\"an-arrays-length-should-be-cached-to-save-gas-in-for-loops\" style=\"position:relative;\"><a href=\"#an-arrays-length-should-be-cached-to-save-gas-in-for-loops\" aria-label=\"an arrays length should be cached to save gas in for loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>An array’s length should be cached to save gas in for-loops</h4>\n<p>Reading array length at each iteration of the loop takes 6 gas (3 for mload and 3 to place memory_offset) in the stack.  </p>\n<p>Caching the array length in the stack saves around 3 gas per iteration.  </p>\n<p>Here, I suggest storing the array’s length in a variable before the for-loop, and use it instead:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:122:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:130:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:170:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:194:        for (uint i = 0; i &lt; amms.length; i++) { // liquidate all positions</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:251:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:263:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:277:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:331:        for (uint i = 0; i &lt; idxs.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:373:        for (uint i = 1 /* skip vusd */; i &lt; assets.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:521:        for (uint i = 0; i &lt; assets.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:552:        for (uint i = 0; i &lt; _collaterals.length; i++) {</span></span></code></pre>\n<h4 id=\"i-costs-less-gas-compared-to-i\" style=\"position:relative;\"><a href=\"#i-costs-less-gas-compared-to-i\" aria-label=\"i costs less gas compared to i permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code>++i</code> costs less gas compared to <code>i++</code></h4>\n<p><code>++i</code> costs less gas compared to <code>i++</code> for unsigned integer, as pre-increment is cheaper (about 5 gas per iteration)  </p>\n<p><code>i++</code> increments <code>i</code> and returns the initial value of <code>i</code>. Which means:  </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint i = 1;  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">i++; // == 1 but i == 2  </span></span></code></pre>\n<p>But <code>++i</code> returns the actual incremented value:  </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint i = 1;  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">++i; // == 2 and i == 2 too, so no need for a temporary variable  </span></span></code></pre>\n<p>In the first case, the compiler has to create a temporary variable (when used) for returning <code>1</code> instead of <code>2</code>  </p>\n<p>Instances include:  </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:122:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:130:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:170:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:194:        for (uint i = 0; i &lt; amms.length; i++) { // liquidate all positions</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:251:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:263:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:277:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:331:        for (uint i = 0; i &lt; idxs.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:373:        for (uint i = 1 /* skip vusd */; i &lt; assets.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:521:        for (uint i = 0; i &lt; assets.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:552:        for (uint i = 0; i &lt; _collaterals.length; i++) {</span></span></code></pre>\n<p>I suggest using <code>++i</code> instead of <code>i++</code> to increment the value of an uint variable.</p>\n<h4 id=\"increments-can-be-unchecked\" style=\"position:relative;\"><a href=\"#increments-can-be-unchecked\" aria-label=\"increments can be unchecked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Increments can be unchecked</h4>\n<p>In Solidity 0.8+, there’s a default overflow check on unsigned integers. It’s possible to uncheck this in for-loops and save some gas at each iteration, but at the cost of some code readability, as this uncheck cannot be made inline.  </p>\n<p><a href=\"https://github.com/ethereum/solidity/issues/10695\">ethereum/solidity#10695</a></p>\n<p>Instances include:  </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:122:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:130:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:170:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:194:        for (uint i = 0; i &lt; amms.length; i++) { // liquidate all positions</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:251:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:263:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:277:        for (uint i = 0; i &lt; amms.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:331:        for (uint i = 0; i &lt; idxs.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:373:        for (uint i = 1 /* skip vusd */; i &lt; assets.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:521:        for (uint i = 0; i &lt; assets.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:552:        for (uint i = 0; i &lt; _collaterals.length; i++) {</span></span></code></pre>\n<p>The code would go from:  </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">for (uint256 i; i &lt; numIterations; i++) {  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> // ...  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}  </span></span></code></pre>\n<p>to:  </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">for (uint256 i; i &lt; numIterations;) {  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> // ...  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> unchecked { ++i; }  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}  </span></span></code></pre>\n<p>The risk of overflow is inexistant for a <code>uint256</code> here.</p>\n<h3 id=\"arithmetics\" style=\"position:relative;\"><a href=\"#arithmetics\" aria-label=\"arithmetics permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Arithmetics</h3>\n<h4 id=\"shift-right-instead-of-dividing-by-2\" style=\"position:relative;\"><a href=\"#shift-right-instead-of-dividing-by-2\" aria-label=\"shift right instead of dividing by 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Shift Right instead of Dividing by 2</h4>\n<p>A division by 2 can be calculated by shifting one to the right.  </p>\n<p>While the <code>DIV</code> opcode uses 5 gas, the <code>SHR</code> opcode only uses 3 gas. Furthermore, Solidity’s division operation also includes a division-by-0 prevention which is bypassed using shifting.  </p>\n<p>I suggest replacing <code>/ 2</code> with <code>>> 1</code> here:  </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:212:            uint toInsurance = liquidationFee / 2;</span></span></code></pre>\n<h3 id=\"errors\" style=\"position:relative;\"><a href=\"#errors\" aria-label=\"errors permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Errors</h3>\n<h4 id=\"reduce-the-size-of-error-messages-long-revert-strings\" style=\"position:relative;\"><a href=\"#reduce-the-size-of-error-messages-long-revert-strings\" aria-label=\"reduce the size of error messages long revert strings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reduce the size of error messages (Long revert Strings)</h4>\n<p>Shortening revert strings to fit in 32 bytes will decrease deployment time gas and will decrease runtime gas when the revert condition is met.</p>\n<p>Revert strings that are longer than 32 bytes require at least one additional mstore, along with additional overhead for computing memory offset, etc.</p>\n<p>Revert strings > 32 bytes are here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">AMM.sol:487:        require(baseAssetQuantity &gt; 0, &quot;VAMM._long: baseAssetQuantity is &lt;= 0&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">AMM.sol:511:        require(baseAssetQuantity &lt; 0, &quot;VAMM._short: baseAssetQuantity is &gt;= 0&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:84:            require(isAboveMinAllowableMargin(trader), &quot;CH: Below Minimum Allowable Margin&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ClearingHouse.sol:101:        require(isAboveMinAllowableMargin(maker), &quot;CH: Below Minimum Allowable Margin&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:174:        require(margin[VUSD_IDX][trader] &gt;= 0, &quot;Cannot remove margin when vusd balance is negative&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:354:        require(notionalPosition == 0, &quot;Liquidate positions before settling bad debt&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">MarginAccount.sol:453:        require(repay &lt;= maxRepay, &quot;Need to repay more to seize that much&quot;); </span></span></code></pre>\n<p>I suggest shortening the revert strings to fit in 32 bytes, or that using custom errors as described next.</p>\n<h4 id=\"use-custom-errors-instead-of-revert-strings-to-save-gas\" style=\"position:relative;\"><a href=\"#use-custom-errors-instead-of-revert-strings-to-save-gas\" aria-label=\"use custom errors instead of revert strings to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use Custom Errors instead of Revert Strings to save Gas</h4>\n<p>Custom errors from Solidity 0.8.4 are cheaper than revert strings (cheaper deployment cost and runtime cost when the revert condition is met)</p>\n<p>Source: <a href=\"https://blog.soliditylang.org/2021/04/21/custom-errors/\">https://blog.soliditylang.org/2021/04/21/custom-errors/</a>:</p>\n<blockquote>\n<p>Starting from <a href=\"https://github.com/ethereum/solidity/releases/tag/v0.8.4\">Solidity v0.8.4</a>, there is a convenient and gas-efficient way to explain to users why an operation failed through the use of custom errors. Until now, you could already use strings to give more information about failures (e.g., <code>revert(\"Insufficient funds.\");</code>), but they are rather expensive, especially when it comes to deploy cost, and it is difficult to use dynamic information in them.</p>\n</blockquote>\n<p>Custom errors are defined using the <code>error</code> statement, which can be used inside and outside of contracts (including interfaces and libraries).</p>\n<p>See <a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/135\">original submission</a> for instances.</p>\n<p>I suggest replacing revert strings with custom errors.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/135#issuecomment-1051794463\">atvanguard (Hubble) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Amazing report! ⭐</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-hubble-findings/issues/135#issuecomment-1059781117\">moose-code (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Really detailed and well constructed report. 💯 </p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-3\">High Risk Findings (3)</a></p>\n<ul>\n<li><a href=\"#h-01-update-initializer-modifier-to-prevent-reentrancy-during-initialization\">[H-01] Update initializer modifier to prevent reentrancy during initialization</a></li>\n<li><a href=\"#h-02-denial-of-service\">[H-02] denial of service</a></li>\n<li><a href=\"#h-03-insurancefund-depositors-can-be-priced-out--deposits-can-be-stolen\">[H-03] InsuranceFund depositors can be priced out &#x26; deposits can be stolen</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-17\">Medium Risk Findings (17)</a></p>\n<ul>\n<li><a href=\"#m-01-liquidations-can-be-run-on-the-bogus-oracle-prices\">[M-01] Liquidations can be run on the bogus Oracle prices</a></li>\n<li><a href=\"#m-02-hidden-governance\">[M-02] Hidden governance</a></li>\n<li><a href=\"#m-03-clearinghouse-may-whitelist-duplicate-amms\">[M-03] ClearingHouse May Whitelist Duplicate AMMs</a></li>\n<li><a href=\"#m-04-settlefunding-will-exceed-block-gas-with-more-markets-and-activity\">[M-04] <code>settleFunding</code> will exceed block gas with more markets and activity</a></li>\n<li><a href=\"#m-05-oraclegetunderlyingprice-could-have-wrong-decimals\">[M-05] <code>Oracle.getUnderlyingPrice</code> could have wrong decimals</a></li>\n<li><a href=\"#m-06-after-debt-seizure-from-insurancefund-user-can-dilute-all-past-participants\">[M-06] After debt seizure from <code>InsuranceFund</code>, user can dilute all past participants.</a></li>\n<li><a href=\"#m-07-clearinghouse-margin-calculations-will-break-up-if-an-amm-returning-non-6-decimals-positions-be-white-listed\">[M-07] ClearingHouse margin calculations will break up if an AMM returning non-6 decimals positions be white listed</a></li>\n<li><a href=\"#m-08-all-amms-have-to-be-past-nextfundingtime-to-update\">[M-08] All AMMs have to be past nextFundingTime to update</a></li>\n<li><a href=\"#m-09-ownership-of-swapvy-cannot-be-transferred\">[M-09] Ownership of <code>Swap.vy</code> cannot be transferred</a></li>\n<li><a href=\"#m-10-blocking-of-the-vusd-withdrawals-is-possible-if-the-reserve-token-doesnt-support-zero-value-transfers\">[M-10] Blocking of the VUSD withdrawals is possible if the reserve token doesn’t support zero value transfers</a></li>\n<li><a href=\"#m-11-users-are-able-to-front-run-bad-debt-settlements-to-avoid-insurance-costs\">[M-11] Users are able to front-run bad debt settlements to avoid insurance costs</a></li>\n<li><a href=\"#m-12-amm-cannot-be-initialize-except-by-governance\">[M-12] AMM Cannot Be <code>initialize()</code> Except By Governance</a></li>\n<li><a href=\"#m-13-assets-sent-from-marginaccount-to-insurancefund-will-be-locked-forever\">[M-13] Assets sent from <code>MarginAccount</code> to <code>InsuranceFund</code> will be locked forever</a></li>\n<li><a href=\"#m-14-liquidation-is-vulnerable-to-sandwich-attacks\">[M-14] Liquidation is vulnerable to sandwich attacks</a></li>\n<li><a href=\"#m-15-wp-h7-insurancefundsyncdeps-may-cause-users-fund-loss\">[M-15] [WP-H7] <code>InsuranceFund#syncDeps()</code> may cause users’ fund loss</a></li>\n<li><a href=\"#m-16-usdc-blacklisted-accounts-can-dos-the-withdrawal-system\">[M-16] USDC blacklisted accounts can DoS the withdrawal system</a></li>\n<li><a href=\"#m-17-usage-of-an-incorrect-version-of-ownable-library-can-potentially-malfunction-all-onlyowner-functions\">[M-17] Usage of an incorrect version of Ownable library can potentially malfunction all <code>onlyOwner</code> functions</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#l-01--prevent-div-by-0\">L-01  PREVENT DIV BY 0</a></li>\n<li><a href=\"#l-02-single-step-change-of-governance-address-is-extremely-risky\">L-02 Single-step change of governance address is extremely risky</a></li>\n<li><a href=\"#l-03-front-runnable-initializers\">L-03 Front-runnable Initializers</a></li>\n<li><a href=\"#l-04-incompatibility-with-rebasingdeflationaryinflationary-tokens\">L-04 Incompatibility With Rebasing/Deflationary/Inflationary tokens</a></li>\n<li><a href=\"#l-05-missing-zero-address-check-in-constructors-and-the-setter-functions\">L-05 Missing zero-address check in constructors and the setter functions</a></li>\n<li><a href=\"#l-06-missing-events-for-governor-only-functions-that-change-critical-parameters\">L-06 Missing events for governor only functions that change critical parameters</a></li>\n<li><a href=\"#l-07-deprecated-safeapprove-function\">L-07 Deprecated safeApprove() function</a></li>\n<li><a href=\"#l-08-the-contract-should-approve0-first\">L-08 The Contract Should Approve(0) first</a></li>\n<li><a href=\"#l-09-missing-pause-modifier-on-the-insurancefunds-contract\">L-09 Missing Pause Modifier On the InsuranceFunds contract</a></li>\n<li><a href=\"#n-01-use-of-blocktimestamp\">N-01 Use of Block.timestamp</a></li>\n<li><a href=\"#n-02-missing-re-entrancy-guard\">N-02 Missing Re-entrancy Guard</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#table-of-contents\">Table of Contents</a></li>\n<li><a href=\"#foreword\">Foreword</a></li>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#file-ammsol\">File: AMM.sol</a></li>\n<li><a href=\"#file-clearinghousesol\">File: ClearingHouse.sol</a></li>\n<li><a href=\"#file-insurancefundsol\">File: InsuranceFund.sol</a></li>\n<li><a href=\"#file-oraclesol\">File: Oracle.sol</a></li>\n<li><a href=\"#file-interfacessol\">File: Interfaces.sol</a></li>\n<li><a href=\"#file-marginaccountsol\">File: MarginAccount.sol</a></li>\n<li><a href=\"#file-vusdsol\">File: VUSD.sol</a></li>\n<li><a href=\"#general-recommendations\">General Recommendations</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the Hubble smart contract system written in Solidity. The audit contest took place between February 17—February 23 2022.\n\n## Wardens\n\n45 Wardens contributed reports to the Hubble contest:\n\n  1. [Dravee](https://twitter.com/JustDravee)\n  1. [cmichel](https://twitter.com/cmichelio)\n  1. [kirk-baird](https://twitter.com/kirkthebaird)\n  1. hyh\n  1. [0xliumin](https://twitter.com/0xliumin)\n  1. [danb](https://twitter.com/danbinnun)\n  1. WatchPug ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n  1. robee\n  1. [gzeon](https://twitter.com/gzeon)\n  1. [throttle](https://twitter.com/Throt7le)\n  1. 0x1f8b\n  1. [leastwood](https://twitter.com/liam_eastwood13)\n  1. [itsmeSTYJ](https://twitter.com/itsmeSTYJ)\n  1. [defsec](https://twitter.com/defsec_)\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. [Omik](https://twitter.com/omikomikomik)\n  1. minhquanym\n  1. [Ruhum](https://twitter.com/0xruhum)\n  1. [Meta0xNull](https://twitter.com/Meta0xNull)\n  1. IllIllI\n  1. [pauliax](https://twitter.com/SolidityDev)\n  1. [rfa](https://www.instagram.com/riyan_rfa/)\n  1. [ye0lde](https://twitter.com/_ye0lde)\n  1. kenta\n  1. [bw](https://github.com/bernard-wagner)\n  1. hubble (ksk2345 and shri4net)\n  1. cccz\n  1. [0v3rf10w](https://twitter.com/_0v3rf10w)\n  1. sorrynotsorry\n  1. CertoraInc ([danb](https://twitter.com/danbinnun), egjlmn1, [OriDabush](https://twitter.com/ori_dabush), ItayG, and shakedwinder)\n  1. Jujic\n  1. [bobi](https://twitter.com/VladToie/)\n  1. peritoflores\n  1. 0xwags\n  1. 0x0x0x\n  1. jayjonah8\n  1. Nikolay\n  1. d4rk\n  1. [Tomio](https://twitter.com/meidhiwirara)\n\nThis contest was judged by the Float Capital team: [moose-code](https://github.com/moose-code) and [JasoonS](https://github.com/JasoonS).\n\nFinal report assembled by [liveactionllama](https://twitter.com/liveactionllama).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 20 unique vulnerabilities. Of these vulnerabilities, 3 received a risk rating in the category of HIGH severity and 17 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 30 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 21 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 Hubble contest repository](https://github.com/code-423n4/2022-02-hubble), and is composed of 7 smart contracts written in the Solidity programming language (2,109 lines of code) as well as 3 contracts written in the Vyper programming language (1,561 lines of code).\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# High Risk Findings (3)\n## [[H-01] Update initializer modifier to prevent reentrancy during initialization](https://github.com/code-423n4/2022-02-hubble-findings/issues/81)\n_Submitted by Dravee_\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/package.json#L17><br>\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/legos/Governable.sol#L5><br>\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/legos/Governable.sol#L24>\n\nWhile Governable.sol is out of scope, I figured this issue would still be fair game.\n\nThe solution uses: `\"@openzeppelin/contracts\": \"4.2.0\"`.<br>\nThis dependency has a known high severity vulnerability: <https://security.snyk.io/vuln/SNYK-JS-OPENZEPPELINCONTRACTS-2320176><br>\nWhich makes this contract vulnerable:\n\n    File: Governable.sol\n    05: import { Initializable } from \"@openzeppelin/contracts/proxy/utils/Initializable.sol\";\n    ...\n    24: contract Governable is VanillaGovernable, Initializable {}\n\nThis contract is inherited at multiple places:\n\n    contracts/AMM.sol:\n      11: contract AMM is IAMM, Governable {\n\n    contracts/InsuranceFund.sol:\n      13: contract InsuranceFund is VanillaGovernable, ERC20Upgradeable {\n\n    contracts/Oracle.sol:\n      11: contract Oracle is Governable {\n\n    contracts/legos/HubbleBase.sol:\n      15: contract HubbleBase is Governable, Pausable, ERC2771Context {\n\n    contracts/ClearingHouse.sol:\n      11: contract ClearingHouse is IClearingHouse, HubbleBase {\n\n    contracts/MarginAccount.sol:\n      25: contract MarginAccount is IMarginAccount, HubbleBase {\n\nìnitializer()\\` is used here:\n\n```\ncontracts/AMM.sol:\n  99:     ) external initializer {\n\ncontracts/ClearingHouse.sol:\n  44:     ) external initializer {\n\ncontracts/MarginAccount.sol:\n  124:     ) external initializer {\n\ncontracts/Oracle.sol:\n  20:     function initialize(address _governance) external initializer {\n\n```\n\n### Recommended Mitigation Steps\n\nUpgrade `@openzeppelin/contracts` to version 4.4.1 or higher.\n\n**[atvanguard (Hubble) confirmed and resolved](https://github.com/code-423n4/2022-02-hubble-findings/issues/81)**\n\n**[moose-code (judge) commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/81#issuecomment-1059916859):**\n > Agreed. Other issues such as [this](https://forum.openzeppelin.com/t/security-advisory-initialize-uups-implementation-contracts/15301) have also popped up, so always safest to be on the newest OZ. This includes for contracts and contracts-upgradeable packages.\n\n\n\n***\n\n## [[H-02] denial of service](https://github.com/code-423n4/2022-02-hubble-findings/issues/119)\n_Submitted by danb, also found by cmichel, csanuragjain, hyh, kirk-baird, leastwood, Meta0xNull, minhquanym, Omik, robee, Ruhum, and throttle_\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/VUSD.sol#L53><br>\n\nprocessWithdrawals can process limited amount in each call.<br>\nAn attacker can push to withdrawals enormous amount of withdrawals with amount = 0.<br>\nIn order to stop the dos attack and process the withdrawal, the governance needs to spend as much gas as the attacker.<br>\nIf the governance doesn't have enough money to pay for the gas, the withdrawals can't be processed.\n\n### Proof of Concept\n\nAlice wants to attack vusd, she spends 1 millions dollars for gas to push as many withdrawals of amount = 0 as she can.<br>\nIf the governance wants to process the deposits after Alices empty deposits, they also need to spend at least 1 million dollars for gas in order to process Alice's withdrawals first.<br>\nBut the governance doesn't have 1 million dollars so the funds will be locked.\n\n### Recommended Mitigation Steps\n\nSet a minimum amount of withdrawal. e.g. 1 dollar\n\n        function withdraw(uint amount) external {\n            require(amount >= 10 ** 6);\n            burn(amount);\n            withdrawals.push(Withdrawal(msg.sender, amount));\n        }\n\n**[atvanguard (Hubble) confirmed, but disagreed with High severity and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/119#issuecomment-1049473996):**\n > Confirming this is an issue. Would classify it as `2 (Med Risk)` because this attack is expensive to carry out.\n\n**[atvanguard (Hubble) resolved](https://github.com/code-423n4/2022-02-hubble-findings/issues/119)**\n\n**[moose-code (judge) commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/119#issuecomment-1059971562):**\n > Would be interested to see the exact gas cost of executing withdraw. The thing is the grievance costs only gas to execute and the withdraw function is relatively cheap from first glance. The main issue here is that it can become SUPER expensive to clear the que in gas. I.e. if the attacker builds up a que of 200 withdrawals, some unknowning sucker is going to pay for more than 200 erc20 transfers in order to get their money out. Thats more than anyone would want to pay, and further since so much gas limit would be needed for this to be executed, to fit into a block you are going to have to pay a huge price. \n> \n> So basically it costs attacker x to execute, which means it is also going to cost next user likely even more than x to fix the problem. \n> \n> Also the que is not cleared so processWithdrawals becomes a really expensive function. If the items were cleared and set back to zero it would make it less expensive to de-que the que. \n> \n> This being said we definitely have this at at least medium severity. \\$10k in gas to constantly brick users withdrawls from protocol for a week is a serious issue and not the biggest cost for an attack. \n> \n> @JasoonS, going to put this as medium. Let's discuss whether we want to have it as high. \n\n**[moose-code (judge) commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/119#issuecomment-1059983807):**\n > Okay, going to keep this as high severity. The cost to fix the attack can be more than what the attack costs in total. It also burdens a random unsuspecting user with a really high gas cost to try and get their withdrawal. There are many good suggestions on how to fix this. \n\n\n\n***\n\n## [[H-03] InsuranceFund depositors can be priced out & deposits can be stolen](https://github.com/code-423n4/2022-02-hubble-findings/issues/42)\n_Submitted by cmichel, also found by danb_\n\n<https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/InsuranceFund.sol#L44-L54><br>\n\nThe `InsuranceFund.deposit` function mints initial `shares` equal to the deposited amount.<br>\nThe deposit / withdraw functions also use the VUSD contract balance for the shares computation. (`balance() = vusd.balanceOf(address(this))`)\n\nIt's possible to increase the share price to very high amounts and price out smaller depositors.\n\n### Proof of Concept\n\n*   `deposit(_amount = 1)`: Deposit the smallest unit of VUSD as the first depositor. Mint 1 share and set the total supply and VUSD balance to `1`.\n*   Perform a direct transfer of `1000.0` VUSD to the `InsuranceFund`. The `balance()` is now `1000e6 + 1`\n*   Doing any deposits of less than `1000.0` VUSD will mint zero shares: `shares = _amount * _totalSupply / _pool = 1000e6 * 1 / (1000e6 + 1) = 0`.\n*   The attacker can call `withdraw(1)` to burn their single share and receive the entire pool balance, making a profit. (`balance() * _shares / totalSupply() = balance()`)\n\nI give this a high severity as the same concept can be used to always steal the initial insurance fund deposit by frontrunning it and doing the above-mentioned steps, just sending the frontrunned deposit amount to the contract instead of the fixed `1000.0`.\nThey can then even repeat the steps to always frontrun and steal any deposits.\n\n### Recommended Mitigation Steps\n\nThe way [UniswapV2 prevents this](https://github.com/Uniswap/v2-core/blob/4dd59067c76dea4a0e8e4bfdda41877a6b16dedc/contracts/UniswapV2Pair.sol#L121) is by requiring a minimum deposit amount and sending `1000` initial shares to the zero address to make this attack more expensive.\nThe same mitigation can be done here.\n\n**[atvanguard (Hubble) confirmed](https://github.com/code-423n4/2022-02-hubble-findings/issues/42)**\n\n\n\n***\n \n# Medium Risk Findings (17)\n## [[M-01] Liquidations can be run on the bogus Oracle prices](https://github.com/code-423n4/2022-02-hubble-findings/issues/46)\n_Submitted by hyh, also found by 0x1f8b, cccz, csanuragjain, defsec, hubble, leastwood, pauliax, WatchPug, and ye0lde_\n\nIf the price feed is manipulated in any way or there is any malfunction based volatility on the market, a malicious user can use this to liquidate a healthy position.\n\nAn attacker can setup a monitoring of the used Oracle feed and act on observing a price outbreak (for example, zero price, which is usually a subject to filtration), liquidating the trader position which is perfectly healthy otherwise, obtaining the collateral with a substantial discount at the expense of the trader.\n\nThe same is for a flash crash kind of scenario, i.e. a price outbreak of any nature will allow for non-market liquidation by an attacker, who has the incentives to setup such a monitoring and act on such an outbreak, knowing that it will not be smoothed or filtered out, allowing a liquidation at a non-market price that happen to be printed in the Oracle feed\n\n### Proof of Concept\n\nOracle.getUnderlyingPrice just passes on the latest Oracle answer, not checking it anyhow:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/Oracle.sol#L24-L35>\n\nIt is then used in liquidation triggers providing isLiquidatable and \\_getLiquidationInfo functions:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/MarginAccount.sol#L249>\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/MarginAccount.sol#L465>\n\n### Recommended Mitigation Steps\n\nAdd a non-zero Oracle price check, possibly add an additional Oracle feed information usage to control that the price is fresh. Please consult the Chainlink for that as OCR introduction might have changed the state of the art approach (i.e. whether and how to use latestRoundData returned data):\n\n<https://docs.chain.link/docs/off-chain-reporting/>\n\nRegarding any price spikes it is straightforward to construct a mitigation mechanics for such cases, so the system will be affected by sustainable price movements only.\n\nAs price outrages provide a substantial attack surface for the project it's worth adding some complexity to the implementation.\n\nOne of the approaches is to track both current and TWAP prices, and condition all state changing actions, including liquidations, on the current price being within a threshold of the TWAP one. If the liquidation margin level is conservative enough and TWAP window is small enough this is safe for the overall stability of the system, while providing substantial mitigation mechanics by allowing state changes on the locally calm market only.\n\nAnother approach is to introduce time delay between liquidation request and actual liquidation. Again, conservative enough margin level plus small enough delay keeps the system safe, while requiring that market conditions allow for liquidation both at request time and at execution time provides ample filtration against price feed outbreaks\n\n**[atvanguard (Hubble) confirmed](https://github.com/code-423n4/2022-02-hubble-findings/issues/46)**\n\n**[moose-code (judge) decreased severity from High to Medium](https://github.com/code-423n4/2022-02-hubble-findings/issues/46)**\n\n\n\n***\n\n## [[M-02] Hidden governance](https://github.com/code-423n4/2022-02-hubble-findings/issues/11)\n_Submitted by 0x1f8b_\n\nThe contract use two governance model, one looks hidden.\n\n### Proof of Concept\n\nThe [VUSD contract](https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/VUSD.sol#L11) uses `VanillaGovernable` but inherits from `ERC20PresetMinterPauserUpgradeable` and this contract uses roles to use some administrative methods like `pause` or `mint`.\n\nThis two-governance model does not seem necessary and can hide or raise suspicion about a rogue pool, thus damaging the user's trust.\n\n### Recommended Mitigation Steps\n\nUnify governance in only one, VanillaGovernable or role based.\n\n**[atvanguard (Hubble) confirmed and resolved](https://github.com/code-423n4/2022-02-hubble-findings/issues/11)**\n\n**[moose-code (judge) commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/11#issuecomment-1059926864):**\n > Yes, a good suggestion to keep governance more tightly coupled. OZ has AccessControlledAndUpgradeable which is really nice. Various roles for varying level of admin functionality. Allows tighter controls on more controversial items and easier control on less controversial items. \n\n\n\n***\n\n## [[M-03] ClearingHouse May Whitelist Duplicate AMMs](https://github.com/code-423n4/2022-02-hubble-findings/issues/50)\n_Submitted by kirk-baird_\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L339-L342><br>\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L269-L282>\n\n`ClearingHouse.sol` allows the Governance protocol to whitelist `AMM.sol` contracts. These contracts allow users to earn profits based on the price of a base asset against a quote asset.\n\nIt is possible to add the same `AMM` twice in the function `whitelistAmm()`. The impact is that unrealized profits will be counted multiple times. As a result the liquidation calculations will be incorrect, potentially allowing users to trade while insolvent or incorrectly liquidating solvent users.\n\nNote `whitelistAmm()` may only be called by Governance.\n\n### Proof of Concept\n\nThe function `getTotalNotionalPositionAndUnrealizedPnl()` will iterate over all `amms` summing the `unrealizedPnl`  and `notinoalPosition`, thus if an `amm` is repeated the `unrealizedPnl` and `notionalPosition` of that asset will be counted multiple times.\n\nThis is used in `_calcMarginFraction()` which calculates a users margin as a fraction of the total position. The margin fraction is used to determine if a user is liquitable or is allowed to open new positions.\n\n### Recommended Mitigation Steps\n\nConsider ensuring the `AMM` does not already exist in the list when adding a new `AMM`.\n\n        function whitelistAmm(address _amm) external onlyGovernance {\n            for (uint256 i; i < amm.length; i++) {\n                require(amm[i] != IAMM(_amm), \"AMM already whitelisted\");\n            }\n            emit MarketAdded(amms.length, _amm);\n            amms.push(IAMM(_amm));\n        }\n\n**[atvanguard (Hubble) confirmed, but disagreed with Medium severity and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/50#issuecomment-1049571812):**\n > As mentioned in [#40](https://github.com/code-423n4/2022-02-hubble-findings/issues/40), the system relies on the admin to do the right thing; hence disagreeing with the severity. Still, it's a good idea to have this check.\n\n**[atvanguard (Hubble) resolved](https://github.com/code-423n4/2022-02-hubble-findings/issues/50)**\n\n**[moose-code (judge) commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/50#issuecomment-1059926048):**\n > Practical advice that prevents a catastrophic issue that could very possibly occur (having run deployment / whitelist and many other scripts, it's way too easy to run something again etc and end up in this situation - even though it feels like it would never be possible). \n\n\n\n***\n\n## [[M-04] `settleFunding` will exceed block gas with more markets and activity](https://github.com/code-423n4/2022-02-hubble-findings/issues/97)\n_Submitted by bw, also found by cmichel, Dravee, gzeon, Omik, and Ruhum_\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L129><br>\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L678>\n\nAs the number of supported markets grow, `settleFunding` will reach a point were it exceeds the block gas limit on Avalanche C-Chain. This will prevent users from calling the function and cause a wide spread Denial of Service.\n\nLooking at transactions for the current testnet deployment, `settleFunding` already reaches almost 10% of the block gas limit. This is due settle funding iteratively looping through each market, with each iteration entering an unbounded `while` loop in `_calcTwap`. The more active the markets are, the more gas intensive `_calcTwap` becomes, as more snapshots need to be traversed.\n\nThe combination of more active markets and an increase in available markets make it very likely that some users will be unable to call `settleFunding` in the long run.\n\n### Proof of Concept\n\nExample of transactions on testnet:\n\n| Gas    | Limit% | Link                                                                                                 |\n| ------ | ------ | ---------------------------------------------------------------------------------------------------- |\n| 658428 | 8.2%   | <https://testnet.snowtrace.io/tx/0x8123a5658a98e694e7428e66c9e5f9d5cbff8af93d543ed51a80cb367bcccd2c> |\n| 653810 | 8.1%   | <https://testnet.snowtrace.io/tx/0xf126eb05245580a73981228d6f0f8d607ad038ca0b68593f0c903e210c1c2c57> |\n\n### Recommended Mitigation Steps\n\nUsers should be allowed to settle funding per market or using an array of markets opposed to all markets at once.\n\n```solidity\nfunction settleFundingForMarkets(IAMM[] markets) override external whenNotPaused {\n     for (uint i = 0; i < markets.length; i++) {\n          markets[i].settleFunding();\n     }\n}\n```\n\nIn this way the gas cost will not increase with the number of markets created over time.\n\n**[atvanguard (Hubble) acknowledged, but disagreed with High severity and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/97#issuecomment-1049492999):**\n > It's a known issue that adding many more markets will eventually exceed block gas limit on many operations (not just `settleFunding`). For that reason, DAO governance has to be careful with not adding too many markets. Would classify this as `0 (Informational)`.\n\n**[moose-code (judge) commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/97#issuecomment-1059975203):**\n > This is definitely more than informational. You can see in the gas profiler on only a limited amount of markets with not much action, lots of gas was used. This has potential to be a much bigger issue in the future. \n> \n> Very rightly so the warden points out `_calcTwap` as intensive which is shown on the profiler below for the one market. Calculating a TWAP across many different markets could blow this function up very quickly. \n> \n> Further more, if you take ALL the gas in a single block, this becomes really expensive and difficult as you need to push out a lot of other high priority transactions that are pending. If this was needing to be executed during an NFT minting spree it would be tough.\n> \n> ![image](https://user-images.githubusercontent.com/20556729/156927846-bbd71770-ea09-4e3e-bffb-83256e665398.png)\n> \n> @JasoonS, let's discuss on medium vs high for this one. \n\n**[moose-code (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/97#issuecomment-1059985901):**\n > Going to have this as medium. \n\n\n\n***\n\n## [[M-05] `Oracle.getUnderlyingPrice` could have wrong decimals](https://github.com/code-423n4/2022-02-hubble-findings/issues/44)\n_Submitted by cmichel_\n\n<https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/Oracle.sol#L34><br>\n\nThe `Oracle.getUnderlyingPrice` function divides the chainlink price by `100`.<br>\nIt probably assumes that the answer for the underlying is in 8 decimals but then wants to reduce it for 6 decimals to match USDC.\n\nHowever, arbitrary `underlying` tokens are used and the chainlink oracles can have different decimals.\n\n### Recommended Mitigation Steps\n\nWhile most USD price feeds use 8 decimals, it's better to take the on-chain reported decimals into account by doing `AggregatorV3Interface(chainLinkAggregatorMap[underlying]).decimals()`, see [Chainlink docs](https://docs.chain.link/docs/get-the-latest-price/#getting-a-different-price-denomination).<br>\nThe price should then be scaled down to 6 decimals.\n\n**[atvanguard (Hubble) confirmed, but disagreed with High severity and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/44#issuecomment-1049511584):**\n > All chainlink USD pairings are expected to have 8 decimals hence disagreeing with severity; but yes agree that asserting this check when adding a new asset is a good idea. \n\n**[moose-code (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/44#issuecomment-1059976567):**\n > Downgrading to medium. Dividing by magic numbers (100) should clearly comment assumptions.\n\n\n\n***\n\n## [[M-06] After debt seizure from `InsuranceFund`, user can dilute all past participants.](https://github.com/code-423n4/2022-02-hubble-findings/issues/129)\n_Submitted by 0xliumin_\n\n<https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/InsuranceFund.sol#L56><br>\n\nA user can get a much larger portion of the pool as it recovers from a debt seizure. The intent of the insurance pool seems to be that it could recover from a bad debt event.\n\n### Proof of Concept\n\n1.  Alice is the first LP to the insurance pool, and deposits 1e18 shares.\n2.  `seizeBadDebt` is called with 2e18. Now, there are `pendingObligations = 1e18`, and there is 0 vusd in the insurance fund.\n3.  Bob (the attacker) directly transfers 1e18 + 1 vUSD.\n4.  Bob calls deposit with 1e18 vUSD. All pending obligations will be settled, but there will only be 1 vUSD left in the pool before Bob's deposit. Bob receives `shares = 1e18 * 1e18 / 1`. As a result, Bob will get `1e36` shares, diluting Alice's share of the pool. Bob will be able to take a much larger share of all future profits from the insurance fund until more bad debt is seized. Bob only provided 2e18 + 1 liqudiity, but received an exponentially larger number of shares than Alice.\n\n### Recommended Mitigation Steps\n\nIt depends on how you want this to work. You could keep track of the total amount ever contributed by users, and use that for calculations. Or just make staking 1 vUSD = 1 share if the pool total is below the total number of shares.\n\n**[atvanguard (Hubble) disputed and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/129#issuecomment-1055797267):**\n > Disputing this. It is by design. LPs who were in the insurance fund will be burnt during a bad debt settlement.\n\n**[JasoonS (judge) decreased severity to Medium](https://github.com/code-423n4/2022-02-hubble-findings/issues/129)**\n\n\n\n***\n\n## [[M-07] ClearingHouse margin calculations will break up if an AMM returning non-6 decimals positions be white listed](https://github.com/code-423n4/2022-02-hubble-findings/issues/37)\n_Submitted by hyh_\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L332><br>\n\nIt is assumed that VAMM returned positions have exactly `6` decimals for all AMMs white listed in ClearingHouse.\n\nIn the same time an array of different AMMs/VAMMs is supported, and there are no guarantees/checks of the precision of the position values they return.\n\nIf an VAMM that have different precision is whitelisted, for example having 18 decimals for position figures, then margin requirements checks become invalid.\n\nThis will lead to various malfunctions, say perfectly valid positions will be liquidated by any attacker noticing that the calculations are skewed.\n\n### Proof of Concept\n\nClearingHouse's \\_calcMarginFraction is the function that is used for margin requirements checks:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L163-L167>\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L188-L189>\n\n\\_calcMarginFraction calls getNotionalPositionAndMargin:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L319-L320>\n\ngetNotionalPositionAndMargin calls getTotalNotionalPositionAndUnrealizedPnl:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L291>\n\ngetTotalNotionalPositionAndUnrealizedPnl sums up AMM's getNotionalPositionAndUnrealizedPnl results:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L269-L282>\n\nAMM's getNotionalPositionAndUnrealizedPnl returns vamm.get_notional result:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L395-L410>\n\nThe above calls are linear decimals wise (i.e. do subtractions/additions kind of operations, preserving the decimals).\n\nThen, \\_getMarginFraction mixes up these notionalPosition and margin, obtained from AMM without rescaling, as if they are PRECISION scaled:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L332>\n\nPRECISION is hard coded to be `1e6`:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/ClearingHouse.sol#L15>\n\nFor other VAMM operations base precision is set to `1e18`:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L17>\n\nFor example, VAMM returned supply is assumed to have 18 decimals:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L523>\n\nComment says that exchangeExactOut returned quantity will have 6 decimals precision:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L495>\n\nAs the system imply that VAMMs can vary it is neither guaranteed, nor checked in any way (briefly checked dydx api code, it looks like there are no explicit guarantees either).\n\nIf any of VAMM referenced via white listed AMMs return VAMM.get_notional with decimals different from `6`, the \\_calcMarginFraction result will become grossly incorrect.\n\n### Recommended Mitigation Steps\n\nIf AMM contract is desired to deal with various VAMMs, consider removing decimals related hard coding, adding decimals variables and scaling VAMM returned results accordingly, so that position and margin values' decimals of 6, implied by ClearingHouse logic, be ensured.\n\n**[atvanguard (Hubble) disputed and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/37#issuecomment-1049514297):**\n > Protocols developers will ensure that correct decimals are used everywhere. It's not possible to assert this in code at all places.\n\n**[JasoonS (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/37#issuecomment-1059993161):**\n > Set to medium as unlikely that this would be done. However, checks and notices in the documentation of this code would be very important to prevent new devs from making these mistakes.\n\n\n\n***\n\n## [[M-08] All AMMs have to be past nextFundingTime to update](https://github.com/code-423n4/2022-02-hubble-findings/issues/130)\n_Submitted by 0xliumin_\n\n<https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/AMM.sol#L348><br>\n\nsettleFunding calls will revert until all AMMs are ready to be updated.\n\n### Proof of Concept\n\nAMM 1 has a nextFundingTime of now. AMM 2 has a nextFundingTime in 30 minutes. AMM 1 won't be able to be updated until after AMM 2's nextFundingTime elapses.\n\n### Recommended Mitigation Steps\n\nYou shouldn't revert at the place mentioned in the links to affected code. Just return so that the other AMMs can still get updated.\n\n**[atvanguard (Hubble) confirmed and resolved](https://github.com/code-423n4/2022-02-hubble-findings/issues/130)**\n\n\n\n***\n\n## [[M-09] Ownership of `Swap.vy` cannot be transferred](https://github.com/code-423n4/2022-02-hubble-findings/issues/93)\n_Submitted by gzeon_\n\nOwnership transfer function of Swap.vy is commented out. Fund can be stuck if an AMM and governance change/upgrade is required.\n\n### Proof of Concept\n\n<https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/curve-v2/Swap.vy#L1129>\n\n**[atvanguard (Hubble) disputed and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/93#issuecomment-1049565326):**\n > Intended behavior because we don't use `self.owner` after the initial setup.\n\n**[JasoonS (judge) commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/93#issuecomment-1060013853):**\n> If that is the case, then shouldn't this function have a check that the AMM can't be set multiple times?\n> https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/curve-v2/Swap.vy#L966-L970\n> \n> There is risk if the owner keys get compromised - also there is no progressive security if you can't change this.\n> \n> IE it could start as an EOA - and progress to a multisig owner etc.\n> \n> Leaving at medium severity - if you have an owner, there should always be a way to update it as to improve the security (and potentially decentralization) of the system over time.\n\n\n\n***\n\n## [[M-10] Blocking of the VUSD withdrawals is possible if the reserve token doesn't support zero value transfers](https://github.com/code-423n4/2022-02-hubble-findings/issues/29)\n_Submitted by hyh_\n\nVUSD withdraw queue will be blocked and user funds frozen simply by requesting a zero value withdraw, if the reserve token doesn't support zero value transfers.\n\nPutting it medium only on an assumption that reserve will be USDC and the probability is low, but VUSD do allow any reserve token and the impact here is both funds freeze and stopping of the operations\n\n### Proof of Concept\n\nIt is possible to burn zero amount in OZ implementation:\n\n<https://github.com/OpenZeppelin/openzeppelin-contracts-upgradeable/blob/master/contracts/token/ERC20/ERC20Upgradeable.sol#L285-L300>\n\nSo, withdraw will burn zero amount and put it to the queue:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/VUSD.sol#L48>\n\nUSDC does support zero value transfers, but not all the tokens do:\n\n<https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers>\n\nCurrently VUSD can use any reserve token:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/VUSD.sol#L33>\n\nWithdraw queue position can be modified in the `processWithdrawals` function only.\n\nBut it will fail every time on the zero amount entry, as there is no way to skip it (and mint VUSD back, for example), so anything else after this zero entry will not be processed:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/VUSD.sol#L62>\n\nThis way the withdrawal functionality and the corresponding user funds will be frozen within VUSD contract, which will become inoperable\n\n### Recommended Mitigation Steps\n\nConsider adding a zero amount check, as it doesn’t cost much, while zero transfer doesn't make sense anyway.\n\nNow:\n\n    reserveToken.safeTransfer(withdrawal.usr, withdrawal.amount);\n    reserve -= withdrawal.amount;\n\nTo be:\n\n    if (withdrawal.amount > 0) {\n    \treserveToken.safeTransfer(withdrawal.usr, withdrawal.amount);\n    \treserve -= withdrawal.amount;\n    }\n\n**[atvanguard (Hubble) disputed and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/29#issuecomment-1049602014):**\n > Not an issue because reserveToken is intended to be USDC.\n\n**[JasoonS (judge) commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/29#issuecomment-1060019732):**\n> Not specified in spec for the audit. Giving to submitter.\n\n\n\n***\n\n## [[M-11] Users are able to front-run bad debt settlements to avoid insurance costs](https://github.com/code-423n4/2022-02-hubble-findings/issues/59)\n_Submitted by kirk-baird, also found by itsmeSTYJ_\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/InsuranceFund.sol#L71-L75><br>\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/InsuranceFund.sol#L62-L69>\n\nA user is able to front-run the call to `seizeBadDebt()` in `InsuranceFund.sol` to avoid paying the insurance costs.\n\n`seizeBadDebt()` is called by `MarginAccount.settleBadDebt()` which is a public function. When this functions is called the transaction will appear in the mem pool.  A user may then call `InsuranceFund.withdraw()` to withdraw all of their shares. If they do this with a higher gas fee it will likely be processed before the `settleBadDebt()` transaction. In this way they will avoid incurring any cost from the assets being seized.\n\nThe impact is that users may gain their share of the insurance funding payments with minimal risk (minimal as there is a change the front-run will not succeed) of having to repay these costs.\n\n### Proof of Concept\n\n        function withdraw(uint _shares) external {\n            settlePendingObligation();\n            require(pendingObligation == 0, \"IF.withdraw.pending_obligations\");\n            uint amount = balance() * _shares / totalSupply();\n            _burn(msg.sender, _shares);\n            vusd.safeTransfer(msg.sender, amount);\n            emit FundsWithdrawn(msg.sender, amount, block.timestamp);\n        }\n\n<!---->\n\n        function seizeBadDebt(uint amount) external onlyMarginAccount {\n            pendingObligation += amount;\n            emit BadDebtAccumulated(amount, block.timestamp);\n            settlePendingObligation();\n        }\n\n### Recommended Mitigation Steps\n\nConsider making the withdrawals a two step process. The first step requests a withdrawal and marks the time. The second request processes the withdrawal but requires a period of time to elapse since the first step.\n\nTo avoid having users constantly having pending withdrawal, each withdrawal should have an expiry time and also a recharge time. The if the second step is not called within expiry amount of time it should be considered invalid. The first step must not be able to be called until recharge time has passed.\n\nAnother solution involves a design change where the insurance fund is slowly filled up over time without external deposits. However, this has the disadvantage that bad debts received early in the protocols life time may not have sufficient insurance capital to cover them.\n\n**[atvanguard (Hubble) confirmed](https://github.com/code-423n4/2022-02-hubble-findings/issues/59)**\n\n\n\n***\n\n## [[M-12] AMM Cannot Be `initialize()` Except By Governance](https://github.com/code-423n4/2022-02-hubble-findings/issues/51)\n_Submitted by kirk-baird_\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L93-L108><br>\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L730-L734><br>\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/legos/Governable.sol#L10-L13><br>\n\nThe contact `AMM.sol` cannot be initialize unless it is called from the `_governance` address.\n\nThis prevents the use of a deployer account and requires the governance to be able to deploy proxy contracts and encode the required arguements. If this is not feasible then the contract cannot be deployed.\n\n### Proof of Concept\n\n`initialize()` calls `_setGovernace(_governance);` which will store the governance address.\n\nFollowing this it will call `syncDeps(_registry);` which has `onlyGovernance` modifier.  Thus, if the `msg.sender` of `initialize()` is not the same as the parameter `_governance` then the initialisation will revert.\n\n```solidity\n    function initialize(\n        address _registry,\n        address _underlyingAsset,\n        string memory _name,\n        address _vamm,\n        address _governance\n    ) external initializer {\n        _setGovernace(_governance);\n\n        vamm = IVAMM(_vamm);\n        underlyingAsset = _underlyingAsset;\n        name = _name;\n        fundingBufferPeriod = 15 minutes;\n\n        syncDeps(_registry);\n    }\n```\n\n### Recommended Mitigation Steps\n\nConsider adding the steps manually to `initialize()`. i.e.\n\n```solidity\n    function initialize(\n        address _registry,\n        address _underlyingAsset,\n        string memory _name,\n        address _vamm,\n        address _governance\n    ) external initializer {\n        _setGovernace(_governance);\n\n        vamm = IVAMM(_vamm);\n        underlyingAsset = _underlyingAsset;\n        name = _name;\n        fundingBufferPeriod = 15 minutes;\n\n        IRegistry registry = IRegistry(_registry);\n        clearingHouse = registry.clearingHouse();\n        oracle = IOracle(registry.oracle());\n}\n```\n\n**[atvanguard (Hubble) confirmed and resolved](https://github.com/code-423n4/2022-02-hubble-findings/issues/51)**\n\n\n\n***\n\n## [[M-13] Assets sent from `MarginAccount` to `InsuranceFund` will be locked forever](https://github.com/code-423n4/2022-02-hubble-findings/issues/128)\n_Submitted by 0xliumin, also found by hyh, minhquanym, and WatchPug_\n\n<https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/MarginAccount.sol#L377><br>\n\nAssets sent from MarginAccount to InsuranceFund will be locked forever.\n\n### Proof of Concept\n\nThe insurance fund doesn't have a way to transfer non-vusd out of the contract.\n\nAssets transferred to the InsuranceFund will be locked forever.\n\n### Recommended Mitigation Steps\n\nHave a way for governance to sweep tokens to swap them.\n\n**[atvanguard (Hubble) confirmed and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/128#issuecomment-1049469298):**\n > Yes, this a known issue and already on our roadmap.\n\n**[moose-code (judge) commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/128#issuecomment-1059916382):**\n > The insurance fund contract is also upgradeable so it's a fairly simple fix upgrade and to sweep the tokens out when the time comes - i.e. tokens won't be lost forever. Still would be better to have it in from the start to avoid this process. Considering moving to medium. Assessing other issues first, will circle back.\n\n**[moose-code (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/128#issuecomment-1063363578):**\n > Moving to medium as contracts are upgradeable so the tokens can always be collected later. If the contract was non-upgradeable I would have left as high.\n\n\n\n***\n\n## [[M-14] Liquidation is vulnerable to sandwich attacks](https://github.com/code-423n4/2022-02-hubble-findings/issues/113)\n_Submitted by danb, also found by leastwood_\n\nWhen an account is liquidated, there is no minimum amount of the swap, which makes it vulnerable for sandwich attacks.\n\n### Proof of Concept\n\nAlice's long position can be liquidated, bob notices it and creates a short position,<br>\nthen liquidates her position, thus swapping the base asset to the quote asset,<br>\ntherefore reducing the base asset price,<br>\nthen he redeems his short position and profits because the price went down.\n\n### Recommended Mitigation Steps\n\nSet quoteAssetLimit in `_reducePosition` to prevent the attack.\n\n**[atvanguard (Hubble) disputed and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/113#issuecomment-1049483200):**\n > This is a known issue and is already [documented as a @todo](https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/AMM.sol#L142) in the code.\n\n**[moose-code (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/113#issuecomment-1063373394):**\n > After long discussion we are going to side with warden on this one. The todo is a bit sparse and the warden really digs on what precautions need to be put in place and the ramifications if they are not adhered. In general, think sprinkle of todos should not indemnify issues related around them as this might let things slip through cracks as wardens will ignore these critical pieces.  \n>\n> With the caveat of putting this in the medium and not high risk category.\n\n\n\n***\n\n## [[M-15] [WP-H7] `InsuranceFund#syncDeps()` may cause users' fund loss](https://github.com/code-423n4/2022-02-hubble-findings/issues/100)\n_Submitted by WatchPug_\n\n<https://github.com/code-423n4/2022-02-hubble/blob/ed1d885d5dbc2eae24e43c3ecbf291a0f5a52765/contracts/InsuranceFund.sol#L116-L119>\n\n```solidity\nfunction syncDeps(IRegistry _registry) public onlyGovernance {\n    vusd = IERC20(_registry.vusd());\n    marginAccount = _registry.marginAccount();\n}\n```\n\nThe `Governance` address can call `InsuranceFund.sol#syncDeps()` to change the contract address of `vusd` anytime.\n\nHowever, since the tx to set a new address for `vusd` can get in between users' txs to deposit and withdraw, in some edge cases, it can result in users' loss of funds.\n\n### Proof of Concept\n\n1.  Alice deposited `1,000,000 VUSD` to `InsuranceFund`;\n2.  Gov called `syncDeps()` and set `vusd` to the address of `VUSDv2`;\n3.  Alice called `withdraw()` with all the `shares` and get back `0 VUSDv2`.\n\nAs a result, Alice suffered a fund loss of `1,000,000 VUSD`.\n\n##### Recommended Mitigation Steps\n\n1.  Consider making `vusd` unchangeable;\n2.  If a possible migration of `vusd` must be considered, consider changing the `syncDeps()` to:\n\n```solidity\nfunction syncDeps(IRegistry _registry) public onlyGovernance {\n    uint _balance = balance();\n    vusd = IERC20(_registry.vusd());\n    require(balance() >= _balance);\n    marginAccount = _registry.marginAccount();\n}\n```\n\n**[atvanguard (Hubble) acknowledged and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/100#issuecomment-1049491356):**\n > Acknowledging but yes system heavily relies on the admins to do the right thing, the right way. We might remove several such upgradeability rights during a broader refactor of the entire system.\n\n**[moose-code (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/100#issuecomment-1063884365):**\n > Downgrading to medium as this is largely admin related. \n\n\n\n***\n\n## [[M-16] USDC blacklisted accounts can DoS the withdrawal system](https://github.com/code-423n4/2022-02-hubble-findings/issues/76)\n_Submitted by throttle_\n\nDoS of USDC withdrawal system\n\n### Proof of Concept\n\nCurrently, withdrawals are queued in an array and processed sequentially in a for loop.<br>\nHowever, a `safeTransfer()` to USDC blacklisted user will fail. It will also brick the withdrawal system because the blacklisted user is never cleared.\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/VUSD.sol#L53-L67>\n\n### Recommended Mitigation Steps\n\nPossible solutions:<br>\n1st solution:<br>\nImplement 2-step withdrawals:<br>\n\\- In a for loop, increase the user's amount that can be safely withdrawn.<br>\n\\- A user himself withdraws his balance<br>\n\n2nd solution:<br>\nSkip blacklisted users in a processWithdrawals loop\n\n**[atvanguard (Hubble) confirmed](https://github.com/code-423n4/2022-02-hubble-findings/issues/76)**\n\n**[moose-code (judge) commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/76#issuecomment-1059987539):**\n > Interesting! Yes, this would be bad.\n\n\n\n***\n\n## [[M-17] Usage of an incorrect version of Ownable library can potentially malfunction all `onlyOwner` functions](https://github.com/code-423n4/2022-02-hubble-findings/issues/140)\n_Submitted by robee_\n\nThe current implementaion is using a non-upgradeable version of the Ownable library. Instead of the upgradeable version: @openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol.\n\nA regular, non-upgradeable Ownable library will make the deployer the default owner in the constructor. Due to a requirement of the proxy-based upgradeability system, no constructors can be used in upgradeable contracts. Therefore, there will be no owner when the contract is deployed as a proxy contract\n\n### Recommended Mitigation Steps\n\nUse @openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol and @openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol instead.\n\nAnd add __Ownable_init(); at the beginning of the initializer.\n    \nOracle.sol<br>\nAMM.sol\n\n\n\n***\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 30 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-02-hubble-findings/issues/92) by **defsec** received the top score from the judge.\n\n*The following wardens also submitted reports: [Dravee](https://github.com/code-423n4/2022-02-hubble-findings/issues/94), [csanuragjain](https://github.com/code-423n4/2022-02-hubble-findings/issues/19), [itsmeSTYJ](https://github.com/code-423n4/2022-02-hubble-findings/issues/63), [robee](https://github.com/code-423n4/2022-02-hubble-findings/issues/3), [Omik](https://github.com/code-423n4/2022-02-hubble-findings/issues/118), [gzeon](https://github.com/code-423n4/2022-02-hubble-findings/issues/89), [kenta](https://github.com/code-423n4/2022-02-hubble-findings/issues/78), [pauliax](https://github.com/code-423n4/2022-02-hubble-findings/issues/105), [ye0lde](https://github.com/code-423n4/2022-02-hubble-findings/issues/115), [IllIllI](https://github.com/code-423n4/2022-02-hubble-findings/issues/32), [0x1f8b](https://github.com/code-423n4/2022-02-hubble-findings/issues/7), [bobi](https://github.com/code-423n4/2022-02-hubble-findings/issues/107), [peritoflores](https://github.com/code-423n4/2022-02-hubble-findings/issues/109), [leastwood](https://github.com/code-423n4/2022-02-hubble-findings/issues/131), [0v3rf10w](https://github.com/code-423n4/2022-02-hubble-findings/issues/112), [0xwags](https://github.com/code-423n4/2022-02-hubble-findings/issues/134), [Meta0xNull](https://github.com/code-423n4/2022-02-hubble-findings/issues/69), [0x0x0x](https://github.com/code-423n4/2022-02-hubble-findings/issues/74), [hubble](https://github.com/code-423n4/2022-02-hubble-findings/issues/91), [cccz](https://github.com/code-423n4/2022-02-hubble-findings/issues/33), [rfa](https://github.com/code-423n4/2022-02-hubble-findings/issues/124), [sorrynotsorry](https://github.com/code-423n4/2022-02-hubble-findings/issues/86), [danb](https://github.com/code-423n4/2022-02-hubble-findings/issues/114), [hyh](https://github.com/code-423n4/2022-02-hubble-findings/issues/30), [jayjonah8](https://github.com/code-423n4/2022-02-hubble-findings/issues/16), [kirk-baird](https://github.com/code-423n4/2022-02-hubble-findings/issues/48), [WatchPug](https://github.com/code-423n4/2022-02-hubble-findings/issues/96), [CertoraInc](https://github.com/code-423n4/2022-02-hubble-findings/issues/35), and [Nikolay](https://github.com/code-423n4/2022-02-hubble-findings/issues/17).*\n\n## [L-01]  PREVENT DIV BY 0\n\nOn several locations in the code precautions are taken not to divide by 0, because this will revert the code. However on some locations this isn’t done.\n\nOracle price is not checked. That will cause to revert on the several functions.\n\n### Proof of Concept\n\nNavigate to the following contract:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/Oracle.sol#L34>\n\n### Recommended Mitigation Steps\n\nRecommend making sure division by 0 won’t occur by checking the variables beforehand and handling this edge case.\n\n## [L-02] Single-step change of governance address is extremely risky\n\nSingle-step change of critical governance address and lack of zero address check is extremely risky. If a zero address or incorrect address (private key not available) is used accidentally, or maliciously changed by a compromised governance account then the entire governance of the protocol is locked forever or lost to an attacker. No governance changes can be made by authorized governance account and protocol will have to be redeployed. The reputation of the protocol will take a huge hit. There may be significant fund lock/loss as well.\n\nInterestingly, this 2-step process is applied to the changing of Strategist address but not Governance address. Governance has more authority in the protocol because it can change the Strategist among other things. So this 2-step should definitely be applied to Governance as well.\n\nGiven the magnitude of the impact, i.e. permanent lock of all governance actions, potential lock/loss of funds, and the known/documented failures of wallet opsec, this risk is classified as medium severity.\n\n### Proof of Concept\n\n<https://github.com/code-423n4/2022-02-hubble/blob/main/contracts/legos/Governable.sol#L20>\n\n### Recommended Mitigation Steps\n\nChange of the most critical protocol address i.e. governance should be timelocked and be a 2-step process: approve+claim in two different transactions, instead of a single-step change.\n\n## [L-03] Front-runnable Initializers\n\nAll contract **initializers** were missing access controls, allowing any user to initialize the contract. By front-running the contract deployers to initialize the contract, the incorrect parameters may be supplied, leaving the contract needing to be redeployed.\n\n### Proof of Concept\n\n1. Navigate to the following contracts:\n\n    * <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/AMM.sol#L93><br>\n\n    * <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/Oracle.sol#L20><br>\n\n    * <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/VUSD.sol#L38><br>\n\n    * <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccount.sol#L121><br>\n\n2. Initialize functions does not have access control. They are vulnerable to front-running.\n\n### Recommended Mitigation Steps\n\nWhile the code that can be run in contract constructors is limited, setting the owner in the contract's constructor to the `msg.sender` and adding the `onlyOwner` modifier to all **initializers** would be a sufficient level of access control.\n\n## [L-04] Incompatibility With Rebasing/Deflationary/Inflationary tokens\n\nThe protocol do not appear to support rebasing/deflationary/inflationary tokens whose balance changes during transfers or over time. The necessary checks include at least verifying the amount of tokens transferred to contracts before and after the actual transfer to infer any fees/interest.\n\n### Proof of Concept\n\nNavigate to the following contracts:\n\n* <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccount.sol#L155><br>\n\n* <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccountHelper.sol#L29><br>\n\n### Recommended Mitigation Steps\n\n- Ensure that to check previous balance/after balance  equals to amount for any rebasing/inflation/deflation\n- Add support in contracts for such tokens before accepting user-supplied tokens\n- Consider supporting deflationary / rebasing / etc tokens by extra checking the balances before/after or strictly inform your users not to use such tokens if they don't want to lose them.\n\n## [L-05] Missing zero-address check in constructors and the setter functions\n\nMissing checks for zero-addresses may lead to infunctional protocol, if the variable addresses are updated incorrectly.\n\n### Proof of Concept\n\nNavigate to the following contract functions:\n\n* <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccountHelper.sol#L19><br>\n\n* <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/VUSD.sol#L39><br>\n\n* <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/legos/Governable.sol#L16><br>\n\n* <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/InsuranceFund.sol#L35><br>\n\n* <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccount.sol#L121><br>\n\n### Recommended Mitigation Steps\n\nConsider adding zero-address checks in the discussed constructors:<br>\nrequire(newAddr != address(0));.\n\n## [L-06] Missing events for governor only functions that change critical parameters\n\nThe governor only functions that change critical parameters should emit events. Events allow capturing the changed parameters so that off-chain tools/interfaces can register such changes with timelocks that allow users to evaluate them and consider if they would like to engage/exit based on how they perceive the changes as affecting the trustworthiness of the protocol or profitability of the implemented financial services. The alternative of directly querying on-chain contract state for such changes is not considered practical for most users/usages.\n\nMissing events and timelocks do not promote transparency and if such changes immediately affect users’ perception of fairness or trustworthiness, they could exit the protocol causing a reduction in liquidity which could negatively impact protocol TVL and reputation.\n\nThere are owner functions that do not emit any events in the contracts.\n\n### Proof of Concept\n\nNavigate to the following contracts:\n\n* <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccount.sol#L616><br>\n\n* <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/legos/Governable.sol#L19><br>\n\n* <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/Oracle.sol#L162><br>\n\n* <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/VUSD.sol#L74><br>\n\n* <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/AMM.sol#L722><br>\n\n* <https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/AMM.sol#L737><br>\n\nSee similar High-severity H03 finding [OpenZeppelin’s Audit of Audius](https://blog.openzeppelin.com/audius-contracts-audit/#high) and Medium-severity M01 finding [OpenZeppelin’s Audit of UMA Phase 4](https://blog.openzeppelin.com/uma-audit-phase-4/).\n\n### Recommended Mitigation Steps\n\nAdd events to all admin/privileged functions that change critical parameters.\n\n## [L-07] Deprecated safeApprove() function\n\nDetailed description of the impact of this finding.\n\nUsing this deprecated function can lead to unintended reverts and potentially the locking of funds. A deeper discussion on the deprecation of this function is in [OZ issue #2219](https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2219). The OpenZeppelin ERC20 `safeApprove()` function has been deprecated, as seen in the comments of the OpenZeppelin code.\n\n### Proof of Concept\n\nNavigate to the following contract functions:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccountHelper.sol#L24>\n\n### Recommended Mitigation Steps\n\nAs suggested by the OpenZeppelin comment, replace `safeApprove()` with `safeIncreaseAllowance()` or `safeDecreaseAllowance()` instead.\n\n## [L-08] The Contract Should Approve(0) first\n\nSome tokens (like USDT L199) do not work when changing the allowance from an existing non-zero allowance value.<br>\nThey must first be approved by zero and then the actual allowance must be approved.\n\n```\nIERC20(token).approve(address(operator), 0);\nIERC20(token).approve(address(operator), amount);\n```\n\n### Proof of Concept\n\nNavigate to the following contract functions:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/MarginAccountHelper.sol#L24>\n\n### Recommended Mitigation Steps\n\nApprove with a zero amount first before setting the actual amount.\n\n## [L-09] Missing Pause Modifier On the InsuranceFunds contract\n\nIn case a hack occurs or an exploit is discovered, the team should be able to pause functionality until the necessary changes are made to the system.  The deposits should be paused with Pause modifier.\n\n### Proof of Concept\n\nNavigate to the following contract functions:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/InsuranceFund.sol#L39><br>\n\nThere is no pause mechanism has been defined.\n\n### Recommended Mitigation Steps\n\nPause functionality on the contract would have helped secure the funds quickly.\n\n## [N-01] Use of Block.timestamp\n\nBlock timestamps have historically been used for a variety of applications, such as entropy for random numbers (see the Entropy Illusion for further details), locking funds for periods of time, and various state-changing conditional statements that are time-dependent. Miners have the ability to adjust timestamps slightly, which can prove to be dangerous if block timestamps are used incorrectly in smart contracts.\n\n### Proof of Concept\n\nNavigate to the following contract:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/legos/HubbleBase.sol#L49>\n\n### Recommended Mitigation Steps\n\nBlock timestamps should not be used for entropy or generating random numbers—i.e., they should not be the deciding factor (either directly or through some derivation) for winning a game or changing an important state.\n\nTime-sensitive logic is sometimes required; e.g., for unlocking contracts (time-locking), completing an ICO after a few weeks, or enforcing expiry dates. It is sometimes recommended to use block.number and an average block time to estimate times; with a 10 second block time, 1 week equates to approximately, 60480 blocks. Thus, specifying a block number at which to change a contract state can be more secure, as miners are unable to easily manipulate the block number.\n\n## [N-02] Missing Re-entrancy Guard\n\nThe re-entrancy guard is missing on the Eth anchor interaction. The external router interaction can cause to the re-entrancy vulnerability.\n\n### Proof of Concept\n\nNavigate to the following contract functions:\n\n<https://github.com/code-423n4/2022-02-hubble/blob/8c157f519bc32e552f8cc832ecc75dc381faa91e/contracts/InsuranceFund.sol#L39>\n\n### Recommended Mitigation Steps\n\nFollow the check effect interaction pattern or put re-entrancy guard.\n\n**[atvanguard (Hubble) commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/92#issuecomment-1051705553):**\n > Good QA report.\n\n**[moose-code (judge) commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/92#issuecomment-1059792709):**\n > Lots of good insights here :100: \n\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 21 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-02-hubble-findings/issues/135) by **Dravee** received the top score from the judge.\n\n*The following wardens also submitted reports: [IllIllI](https://github.com/code-423n4/2022-02-hubble-findings/issues/60), [Jujic](https://github.com/code-423n4/2022-02-hubble-findings/issues/82), [WatchPug](https://github.com/code-423n4/2022-02-hubble-findings/issues/102), [csanuragjain](https://github.com/code-423n4/2022-02-hubble-findings/issues/18), [defsec](https://github.com/code-423n4/2022-02-hubble-findings/issues/108), [rfa](https://github.com/code-423n4/2022-02-hubble-findings/issues/125), [robee](https://github.com/code-423n4/2022-02-hubble-findings/issues/2), [throttle](https://github.com/code-423n4/2022-02-hubble-findings/issues/126), [0v3rf10w](https://github.com/code-423n4/2022-02-hubble-findings/issues/111), [CertoraInc](https://github.com/code-423n4/2022-02-hubble-findings/issues/34), [d4rk](https://github.com/code-423n4/2022-02-hubble-findings/issues/12), [gzeon](https://github.com/code-423n4/2022-02-hubble-findings/issues/88), [kenta](https://github.com/code-423n4/2022-02-hubble-findings/issues/79), [sorrynotsorry](https://github.com/code-423n4/2022-02-hubble-findings/issues/85), [0x1f8b](https://github.com/code-423n4/2022-02-hubble-findings/issues/6), [Meta0xNull](https://github.com/code-423n4/2022-02-hubble-findings/issues/68), [Omik](https://github.com/code-423n4/2022-02-hubble-findings/issues/117), [Tomio](https://github.com/code-423n4/2022-02-hubble-findings/issues/95), [pauliax](https://github.com/code-423n4/2022-02-hubble-findings/issues/106), and [danb](https://github.com/code-423n4/2022-02-hubble-findings/issues/120).*\n\n## Table of Contents\n\nSee [original submission](https://github.com/code-423n4/2022-02-hubble-findings/issues/135) for table of contents.\n\n## Foreword\n\n- **Storage-reading optimizations**\n\n> The code can be optimized by minimising the number of SLOADs. SLOADs are expensive (100 gas) compared to MLOADs/MSTOREs (3 gas). In the paragraphs below, please see the `@audit-issue` tags in the pieces of code's comments for more information about SLOADs that could be saved by caching the mentioned **storage** variables in **memory** variables.\n\n- **Unchecking arithmetics operations that can't underflow/overflow**\n\n> Solidity version 0.8+ comes with implicit overflow and underflow checks on unsigned integers. When an overflow or an underflow isn't possible (as an example, when a comparison is made before the arithmetic operation, or the operation doesn't depend on user input), some gas can be saved by using an `unchecked` block: <https://docs.soliditylang.org/en/v0.8.10/control-structures.html#checked-or-unchecked-arithmetic>\n\n- **`@audit` tags**\n\n> The code is annotated at multiple places with `//@audit` comments to pinpoint the issues. Please, pay attention to them for more details.\n\n## Summary\n\n- One pattern that was often seen is caching structs in memory when it's not needed. A copy in memory of a storage struct will trigger as many SLOADs as there are slots. If the struct's fields are only read once, or if the number of storage reading would be inferior to the number of slots: don't cache the struct in memory.\n\n## File: AMM.sol\n\n### function initialize()\n\n```\n093:     function initialize(\n094:         address _registry,\n095:         address _underlyingAsset,\n096:         string memory _name,//@audit readonly: calldata\n097:         address _vamm,\n098:         address _governance\n099:     ) external initializer {\n100:         _setGovernace(_governance);\n101: \n102:         vamm = IVAMM(_vamm);\n103:         underlyingAsset = _underlyingAsset;\n104:         name = _name;\n105:         fundingBufferPeriod = 15 minutes;\n106: \n107:         syncDeps(_registry);\n108:     }\n```\n\n#### Use `calldata` instead of `memory` for `string _name`\n\nAn external function passing a readonly variable should mark it as `calldata` and not `memory`\n\n### function openPosition()\n\n```\n113:     function openPosition(address trader, int256 baseAssetQuantity, uint quoteAssetLimit)\n114:         override\n115:         external\n116:         onlyClearingHouse\n117:         returns (int realizedPnl, uint quoteAsset, bool isPositionIncreased)\n118:     {\n119:         require(ammState == AMMState.Active, \"AMM.openPosition.not_active\");\n120:         Position memory position = positions[trader]; //@audit 3 SLOADs vs 1 enough\n121:         bool isNewPosition = position.size == 0 ? true : false;\n122:         Side side = baseAssetQuantity > 0 ? Side.LONG : Side.SHORT;\n123:         if (isNewPosition || (position.size > 0 ? Side.LONG : Side.SHORT) == side) {\n124:             // realizedPnl = 0;\n125:             quoteAsset = _increasePosition(trader, baseAssetQuantity, quoteAssetLimit);\n126:             isPositionIncreased = true;\n127:         } else {\n128:             (realizedPnl, quoteAsset, isPositionIncreased) = _openReversePosition(trader, baseAssetQuantity, quoteAssetLimit);\n129:         }\n130:         _emitPositionChanged(trader, realizedPnl);\n131:     }\n```\n\n#### Do not cache `positions[trader]` in memory\n\nAs a copy in memory of a struct makes as many SLOADs as there are slots, here a copy costs 3 SLOADs:\n\n```\n41:     struct Position {\n42:         int256 size;\n43:         uint256 openNotional;\n44:         int256 lastPremiumFraction;\n45:     }\n```\n\nHowever, only the `size` field is read twice. Therefore, only this field should get cached: `int256 _size = positions[trader].size;`\n\n### function liquidatePosition()\n\n```\n133:     function liquidatePosition(address trader)\n134:         override\n135:         external\n136:         onlyClearingHouse\n137:         returns (int realizedPnl, uint quoteAsset)\n138:     {\n139:         // don't need an ammState check because there should be no active positions\n140:         Position memory position = positions[trader]; //@audit 3 SLOADs vs 1 enough\n141:         bool isLongPosition = position.size > 0 ? true : false;\n142:         // sending market orders can fk the trader. @todo put some safe guards around price of liquidations\n143:         if (isLongPosition) {\n144:             (realizedPnl, quoteAsset) = _reducePosition(trader, -position.size, 0);\n145:         } else {\n146:             (realizedPnl, quoteAsset) = _reducePosition(trader, -position.size, type(uint).max);\n147:         }\n148:         _emitPositionChanged(trader, realizedPnl);\n149:     }\n```\n\n#### Do not cache `positions[trader]` in memory\n\nSimilar to [Do not cache `positions[trader]` in memory](#do-not-cache-positionstrader-in-memory).\n\nHowever, only the `size` field is read 3 times. Therefore, only this field should get cached: `int256 _size = positions[trader].size;`\n\n### function removeLiquidity()\n\n```\n133:     function liquidatePosition(address trader)\n134:         override\n135:         external\n136:         onlyClearingHouse\n137:         returns (int realizedPnl, uint quoteAsset)\n138:     {\n139:         // don't need an ammState check because there should be no active positions\n140:         Position memory position = positions[trader]; //@audit 3 SLOADs vs 1 enough\n141:         bool isLongPosition = position.size > 0 ? true : false;\n142:         // sending market orders can fk the trader. @todo put some safe guards around price of liquidations\n143:         if (isLongPosition) {\n144:             (realizedPnl, quoteAsset) = _reducePosition(trader, -position.size, 0);\n145:         } else {\n146:             (realizedPnl, quoteAsset) = _reducePosition(trader, -position.size, type(uint).max);\n147:         }\n148:         _emitPositionChanged(trader, realizedPnl);\n149:     }\n```\n\n#### Do not cache `positions[maker]` in memory\n\nSimilar to [Do not cache `positions[trader]` in memory](#do-not-cache-positionstrader-in-memory).\nHowever, here, even the fields shouldn't get cached, as they are read only once:\n\n```\n220:         Position memory _taker = positions[maker];//@audit 3 SLOADs vs 2 enough\n...\n233:             _taker.size,\n234:             _taker.openNotional\n```\n\nTherefore, use `220:         Position storage _taker = positions[maker];`\n\n#### Do not cache `makers[maker]` in memory\n\nSimilarly, a copy in memory for `Maker` costs 7 SLOADs:\n\n```\n48:     struct Maker {\n49:         uint vUSD;\n50:         uint vAsset;\n51:         uint dToken;\n52:         int pos; // position\n53:         int posAccumulator; // value of global.posAccumulator until which pos has been updated\n54:         int lastPremiumFraction;\n55:         int lastPremiumPerDtoken;\n56:     }\n```\n\nHere, caching the first 5 fields in memory is enough.\n\n### function getNotionalPositionAndUnrealizedPnl()\n\n```\n395:     function getNotionalPositionAndUnrealizedPnl(address trader)\n396:         override\n397:         external\n398:         view\n399:         returns(uint256 notionalPosition, int256 unrealizedPnl, int256 size, uint256 openNotional)\n400:     {\n401:         Position memory _taker = positions[trader];//@audit 3 SLOADs vs 2 enough\n402:         Maker memory _maker = makers[trader];//@audit 7 SLOADs vs 3 enough\n403: \n404:         (notionalPosition, size, unrealizedPnl, openNotional) = vamm.get_notional(\n405:             _maker.dToken,\n406:             _maker.vUSD,\n407:             _maker.vAsset,\n408:             _taker.size,\n409:             _taker.openNotional\n410:         );\n411:     }\n```\n\n#### Do not cache `positions[trader]` in memory\n\nHere, we need `Position storage _taker = positions[trader];`\n\n#### Do not cache `makers[trader]` in memory\n\nHere, we need `Maker storage _maker = makers[trader];`\n\n### function getPendingFundingPayment()\n\n```\n425:         Position memory taker = positions[trader];//@audit 3 SLOADs vs 2 enough\n...\n434:         Maker memory maker = makers[trader];//@audit 7 SLOADs vs 5 enough\n```\n\n#### Do not cache `positions[trader]` in memory\n\nHere, we need `Position storage _taker = positions[trader];`\n\n#### Do not cache `makers[trader]` in memory\n\nHere, we need `Maker storage _maker = makers[trader];`\n\n### function getTakerNotionalPositionAndUnrealizedPnl()\n\n```\n458:     function getTakerNotionalPositionAndUnrealizedPnl(address trader) override public view returns(uint takerNotionalPosition, int256 unrealizedPnl) {\n459:         Position memory position = positions[trader];//@audit 3 SLOADs vs 2 enough\n460:         if (position.size > 0) {\n461:             takerNotionalPosition = vamm.get_dy(1, 0, position.size.toUint256());\n462:             unrealizedPnl = takerNotionalPosition.toInt256() - position.openNotional.toInt256();\n463:         } else if (position.size < 0) {\n464:             takerNotionalPosition = vamm.get_dx(0, 1, (-position.size).toUint256());\n465:             unrealizedPnl = position.openNotional.toInt256() - takerNotionalPosition.toInt256();\n466:         }\n467:     }\n```\n\n#### Do not cache `positions[trader]` in memory\n\nHere, we need to cache these fields: `size` and `openNotional`\n\n### function _emitPositionChanged()\n\n```\n527:     function _emitPositionChanged(address trader, int256 realizedPnl) internal {\n528:         Position memory position = positions[trader];//@audit 3 SLOADs vs 2 enough\n529:         emit PositionChanged(trader, position.size, position.openNotional, realizedPnl);\n530:     }\n```\n\n#### Do not cache `positions[trader]` in memory\n\nHere, we need `Position storage _taker = positions[trader];`\n\n### function _openReversePosition()\n\n```\n584:     function _openReversePosition(address trader, int256 baseAssetQuantity, uint quoteAssetLimit)\n585:         internal\n586:         returns (int realizedPnl, uint quoteAsset, bool isPositionIncreased)\n587:     {\n588:         Position memory position = positions[trader];//@audit 3 SLOADs vs 1 enough\n589:         if (abs(position.size) >= abs(baseAssetQuantity)) {\n590:             (realizedPnl, quoteAsset) = _reducePosition(trader, baseAssetQuantity, quoteAssetLimit);\n591:         } else {\n592:             uint closedRatio = (quoteAssetLimit * abs(position.size).toUint256()) / abs(baseAssetQuantity).toUint256();\n593:             (realizedPnl, quoteAsset) = _reducePosition(trader, -position.size, closedRatio);\n594: \n595:             // this is required because the user might pass a very less value (slippage-prone) while shorting\n596:             if (quoteAssetLimit >= quoteAsset) {\n597:                 quoteAssetLimit -= quoteAsset; //@audit uncheck (see L596)\n598:             }\n599:             quoteAsset += _increasePosition(trader, baseAssetQuantity + position.size, quoteAssetLimit);\n600:             isPositionIncreased = true;\n601:         }\n602:     }\n```\n\n#### Do not cache `positions[trader]` in memory\n\nHere, we need to cache the `size` field\n\n#### Unchecked block L597\n\nThis line can't underflow due to the condition L596. Therefore, it should be wrapped in an `unchecked` block\n\n### function _calcTwap()\n\n```\n656:     function _calcTwap(uint256 _intervalInSeconds)\n657:         internal\n658:         view\n659:         returns (uint256)\n660:     {\n661:         uint256 snapshotIndex = reserveSnapshots.length - 1; //@audit reserveSnapshots.length  SLOAD 1\n662:         uint256 currentPrice = reserveSnapshots[snapshotIndex].lastPrice;\n663:         if (_intervalInSeconds == 0) {\n664:             return currentPrice;\n665:         }\n666: \n667:         uint256 baseTimestamp = _blockTimestamp() - _intervalInSeconds;\n668:         ReserveSnapshot memory currentSnapshot = reserveSnapshots[snapshotIndex];//@audit 3 SLOADs vs 1 enough\n669:         // return the latest snapshot price directly\n670:         // if only one snapshot or the timestamp of latest snapshot is earlier than asking for\n671:         if (reserveSnapshots.length == 1 || currentSnapshot.timestamp <= baseTimestamp) {//@audit reserveSnapshots.length  SLOAD 2\n...\n675:         uint256 previousTimestamp = currentSnapshot.timestamp;\n676:         uint256 period = _blockTimestamp() - previousTimestamp;\n677:         uint256 weightedPrice = currentPrice * period;\n678:         while (true) {\n...\n680:             if (snapshotIndex == 0) {\n681:                 return weightedPrice / period;\n682:             }\n...\n684:             snapshotIndex = snapshotIndex - 1; //@audit uncheck (see L680-L682)\n685:             currentSnapshot = reserveSnapshots[snapshotIndex];\n686:             currentPrice = reserveSnapshots[snapshotIndex].lastPrice; //@audit use currentSnapshot.lastPrice\n...\n689:             if (currentSnapshot.timestamp <= baseTimestamp) {\n...\n698:             uint256 timeFraction = previousTimestamp - currentSnapshot.timestamp;\n...\n701:             previousTimestamp = currentSnapshot.timestamp;\n```\n\n#### Do not cache `reserveSnapshots[snapshotIndex]` in memory\n\nHere, we need to cache the `timestamp` field. Copying the struct in memory costs 3 SLOADs.\n\n#### Cache `reserveSnapshots.length` in memory\n\nThis would save 1 SLOAD\n\n#### Unchecked block L684\n\nThis line can't underflow due to the condition L680-L682. Therefore, it should be wrapped in an `unchecked` block\n\n#### Use the cache for calculation\n\nAs we already have `currentSnapshot = reserveSnapshots[snapshotIndex];`: use it here: `currentPrice = currentSnapshot.lastPrice;`\n\n## File: ClearingHouse.sol\n\n### function _disperseLiquidationFee()\n\n```\n210:     function _disperseLiquidationFee(uint liquidationFee) internal {\n211:         if (liquidationFee > 0) {\n212:             uint toInsurance = liquidationFee / 2;\n213:             marginAccount.transferOutVusd(address(insuranceFund), toInsurance);\n214:             marginAccount.transferOutVusd(_msgSender(), liquidationFee - toInsurance); //@audit uncheck (see L212)\n215:         }\n216:     }\n```\n\n#### Unchecked block L214\n\nThis line can't underflow due to the condition L212. Therefore, it should be wrapped in an `unchecked` block\n\n## File: InsuranceFund.sol\n\n### function pricePerShare()\n\n```\nFile: InsuranceFund.sol\n094:     function pricePerShare() external view returns (uint) {\n095:         uint _totalSupply = totalSupply();\n096:         uint _balance = balance();\n097:         _balance -= Math.min(_balance, pendingObligation); //@audit uncheck\n098:         if (_totalSupply == 0 || _balance == 0) \n099:             return PRECISION;\n100:         }\n101:         return _balance * PRECISION / \n_totalSupply;\n102:     }\n```\n\n#### Unchecked block L97\n\nThis line can't underflow for obvious mathematical reasons (`_balance` substracting at most itself). Therefore, it should be wrapped in an `unchecked` block\n\n## File: Oracle.sol\n\n### function getUnderlyingTwapPrice()\n\n#### Unchecked block L81\n\nThis line can't underflow due to L76-L79. Therefore, it should be wrapped in an `unchecked` block\n\n## File: Interfaces.sol\n\n### struct Collateral\n\n#### Tight packing structs to save slots\n\nWhile this file is out of scope, it deeply impacts MarginAccount.sol.\nI suggest going from:\n\n```\n94:     struct Collateral {\n95:         IERC20 token; //@audit 20 bytes\n96:         uint weight; //@audit 32 bytes\n97:         uint8 decimals; //@audit 1 byte\n98:     }\n```\n\nto\n\n```\n94:     struct Collateral {\n95:         IERC20 token; //@audit 20 bytes\n96:         uint8 decimals; //@audit 1 byte\n97:         uint weight; //@audit 32 bytes\n98:     }\n```\n\nTo save 1 slot per array element in MarginAccount.sol's storage\n\n## File: MarginAccount.sol\n\n### function _getLiquidationInfo()\n\n```\n460:     function _getLiquidationInfo(address trader, uint idx) internal view returns (LiquidationBuffer memory buffer) {\n461:         require(idx > VUSD_IDX && idx < supportedCollateral.length, \"collateral not seizable\");\n462:         (buffer.status, buffer.repayAble, buffer.incentivePerDollar) = isLiquidatable(trader, false);\n463:         if (buffer.status == IMarginAccount.LiquidationStatus.IS_LIQUIDATABLE) {\n464:             Collateral memory coll = supportedCollateral[idx];//@audit 3 SLOADs vs 2 enough\n465:             buffer.priceCollateral = oracle.getUnderlyingPrice(address(coll.token)).toUint256();\n466:             buffer.decimals = coll.decimals;\n467:         }\n468:     }\n```\n\n#### Do not cache `supportedCollateral[idx]` in memory\n\nHere, we need `Collateral storage coll = supportedCollateral[idx];`. Copying the struct in memory costs 3 SLOADs.\n\n### function _transferOutVusd()\n\n#### Unchecked block L588\n\nThis line can't underflow due to L583. Therefore, it should be wrapped in an `unchecked` block\n\n## File: VUSD.sol\n\n### function processWithdrawals()\n\n```\n53:     function processWithdrawals() external {\n54:         uint reserve = reserveToken.balanceOf(address(this));\n55:         require(reserve >= withdrawals[start].amount, 'Cannot process withdrawals at this time: Not enough balance'); //@audit start SLOAD 1\n56:         uint i = start;//@audit start SLOAD 2\n57:         while (i < withdrawals.length && (i - start) <= maxWithdrawalProcesses) { //@audit uncheck whole //@audit start SLOAD 3\n58:             Withdrawal memory withdrawal = withdrawals[i]; //@audit-ok\n59:             if (reserve < withdrawal.amount) {\n60:                 break;\n61:             }\n62:             reserveToken.safeTransfer(withdrawal.usr, withdrawal.amount);\n63:             reserve -= withdrawal.amount;  //@audit uncheck (see L59-L61)\n64:             i += 1;\n65:         }\n66:         start = i;\n67:     }\n```\n\n#### Unchecked block L57-L65\n\nThe whole while-loop can't underflow. Therefore, it should be wrapped in an `unchecked` block\n\n#### Cache `start` in memory\n\nCache `start` in memory as `initialStart` and use it L55 + L57 (compare `i` to it in the while-loop)\n\n## General Recommendations\n\n### Variables\n\n#### No need to explicitly initialize variables with default values\n\nIf a variable is not set/initialized, it is assumed to have the default value (`0` for `uint`, `false` for `bool`, `address(0)` for address...). Explicitly initializing it with its default value is an anti-pattern and wastes gas.\n\nAs an example: `for (uint256 i = 0; i < numIterations; ++i) {` should be replaced with `for (uint256 i; i < numIterations; ++i) {`\n\nInstances include:  \n\n```\nClearingHouse.sol:122:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:130:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:170:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:194:        for (uint i = 0; i < amms.length; i++) { // liquidate all positions\nClearingHouse.sol:251:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:263:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:277:        for (uint i = 0; i < amms.length; i++) {\nInsuranceFund.sol:52:        uint shares = 0;\nMarginAccount.sol:31:    uint constant VUSD_IDX = 0;\nMarginAccount.sol:331:        for (uint i = 0; i < idxs.length; i++) {\nMarginAccount.sol:521:        for (uint i = 0; i < assets.length; i++) {\nMarginAccount.sol:552:        for (uint i = 0; i < _collaterals.length; i++) {\nMarginAccountHelper.sol:13:    uint constant VUSD_IDX = 0;\n```\n\nI suggest removing explicit initializations for default values.\n\n#### Pre-increments cost less gas compared to post-increments\n\n### Comparisons\n\n#### `> 0` is less efficient than `!= 0` for unsigned integers (with proof)\n\n`!= 0` costs less gas compared to `> 0` for unsigned integers in `require` statements with the optimizer enabled (6 gas)\n\nProof: While it may seem that `> 0` is cheaper than `!=`, this is only true without the optimizer enabled and outside a require statement. If you enable the optimizer at 10k AND you're in a `require` statement, this will save gas. You can see this tweet for more proofs: <https://twitter.com/gzeon/status/1485428085885640706>\n\n`> 0` in require statements are used in the following location(s):\n\n```\nAMM.sol:487:        require(baseAssetQuantity > 0, \"VAMM._long: baseAssetQuantity is <= 0\");\nAMM.sol:511:        require(baseAssetQuantity < 0, \"VAMM._short: baseAssetQuantity is >= 0\");\nClearingHouse.sol:51:        require(_maintenanceMargin > 0, \"_maintenanceMargin < 0\");\nMarginAccount.sol:150:        require(amount > 0, \"Add non-zero margin\");\nOracle.sol:153:        require(_round > 0, \"Not enough history\");\n```\n\nI suggest you change `> 0` with `!= 0` in require statements. Also, enable the Optimizer.\n\n### For-Loops\n\n#### An array's length should be cached to save gas in for-loops\n\nReading array length at each iteration of the loop takes 6 gas (3 for mload and 3 to place memory_offset) in the stack.  \n  \nCaching the array length in the stack saves around 3 gas per iteration.  \n\nHere, I suggest storing the array's length in a variable before the for-loop, and use it instead:\n\n```\nClearingHouse.sol:122:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:130:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:170:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:194:        for (uint i = 0; i < amms.length; i++) { // liquidate all positions\nClearingHouse.sol:251:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:263:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:277:        for (uint i = 0; i < amms.length; i++) {\nMarginAccount.sol:331:        for (uint i = 0; i < idxs.length; i++) {\nMarginAccount.sol:373:        for (uint i = 1 /* skip vusd */; i < assets.length; i++) {\nMarginAccount.sol:521:        for (uint i = 0; i < assets.length; i++) {\nMarginAccount.sol:552:        for (uint i = 0; i < _collaterals.length; i++) {\n```\n\n#### `++i` costs less gas compared to `i++`\n\n`++i` costs less gas compared to `i++` for unsigned integer, as pre-increment is cheaper (about 5 gas per iteration)  \n\n`i++` increments `i` and returns the initial value of `i`. Which means:  \n  \n```\nuint i = 1;  \ni++; // == 1 but i == 2  \n```\n  \nBut `++i` returns the actual incremented value:  \n  \n```\nuint i = 1;  \n++i; // == 2 and i == 2 too, so no need for a temporary variable  \n```\n  \nIn the first case, the compiler has to create a temporary variable (when used) for returning `1` instead of `2`  \n  \nInstances include:  \n\n```\nClearingHouse.sol:122:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:130:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:170:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:194:        for (uint i = 0; i < amms.length; i++) { // liquidate all positions\nClearingHouse.sol:251:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:263:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:277:        for (uint i = 0; i < amms.length; i++) {\nMarginAccount.sol:331:        for (uint i = 0; i < idxs.length; i++) {\nMarginAccount.sol:373:        for (uint i = 1 /* skip vusd */; i < assets.length; i++) {\nMarginAccount.sol:521:        for (uint i = 0; i < assets.length; i++) {\nMarginAccount.sol:552:        for (uint i = 0; i < _collaterals.length; i++) {\n```\n\nI suggest using `++i` instead of `i++` to increment the value of an uint variable.\n\n#### Increments can be unchecked\n\nIn Solidity 0.8+, there's a default overflow check on unsigned integers. It's possible to uncheck this in for-loops and save some gas at each iteration, but at the cost of some code readability, as this uncheck cannot be made inline.  \n  \n[ethereum/solidity#10695](https://github.com/ethereum/solidity/issues/10695)\n\nInstances include:  \n\n```\nClearingHouse.sol:122:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:130:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:170:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:194:        for (uint i = 0; i < amms.length; i++) { // liquidate all positions\nClearingHouse.sol:251:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:263:        for (uint i = 0; i < amms.length; i++) {\nClearingHouse.sol:277:        for (uint i = 0; i < amms.length; i++) {\nMarginAccount.sol:331:        for (uint i = 0; i < idxs.length; i++) {\nMarginAccount.sol:373:        for (uint i = 1 /* skip vusd */; i < assets.length; i++) {\nMarginAccount.sol:521:        for (uint i = 0; i < assets.length; i++) {\nMarginAccount.sol:552:        for (uint i = 0; i < _collaterals.length; i++) {\n```\n\nThe code would go from:  \n  \n```\nfor (uint256 i; i < numIterations; i++) {  \n // ...  \n}  \n```\n\nto:  \n\n```\nfor (uint256 i; i < numIterations;) {  \n // ...  \n unchecked { ++i; }  \n}  \n```\n\nThe risk of overflow is inexistant for a `uint256` here.\n\n### Arithmetics  \n\n#### Shift Right instead of Dividing by 2\n\nA division by 2 can be calculated by shifting one to the right.  \n  \nWhile the `DIV` opcode uses 5 gas, the `SHR` opcode only uses 3 gas. Furthermore, Solidity's division operation also includes a division-by-0 prevention which is bypassed using shifting.  \n\nI suggest replacing `/ 2` with `>> 1` here:  \n\n```  \nClearingHouse.sol:212:            uint toInsurance = liquidationFee / 2;\n```  \n\n### Errors\n\n#### Reduce the size of error messages (Long revert Strings)\n\nShortening revert strings to fit in 32 bytes will decrease deployment time gas and will decrease runtime gas when the revert condition is met.\n\nRevert strings that are longer than 32 bytes require at least one additional mstore, along with additional overhead for computing memory offset, etc.\n\nRevert strings > 32 bytes are here:\n\n```\nAMM.sol:487:        require(baseAssetQuantity > 0, \"VAMM._long: baseAssetQuantity is <= 0\");\nAMM.sol:511:        require(baseAssetQuantity < 0, \"VAMM._short: baseAssetQuantity is >= 0\");\nClearingHouse.sol:84:            require(isAboveMinAllowableMargin(trader), \"CH: Below Minimum Allowable Margin\");\nClearingHouse.sol:101:        require(isAboveMinAllowableMargin(maker), \"CH: Below Minimum Allowable Margin\");\nMarginAccount.sol:174:        require(margin[VUSD_IDX][trader] >= 0, \"Cannot remove margin when vusd balance is negative\");\nMarginAccount.sol:354:        require(notionalPosition == 0, \"Liquidate positions before settling bad debt\");\nMarginAccount.sol:453:        require(repay <= maxRepay, \"Need to repay more to seize that much\"); \n```\n\nI suggest shortening the revert strings to fit in 32 bytes, or that using custom errors as described next.\n\n#### Use Custom Errors instead of Revert Strings to save Gas\n\nCustom errors from Solidity 0.8.4 are cheaper than revert strings (cheaper deployment cost and runtime cost when the revert condition is met)\n\nSource: <https://blog.soliditylang.org/2021/04/21/custom-errors/>:\n> Starting from [Solidity v0.8.4](https://github.com/ethereum/solidity/releases/tag/v0.8.4), there is a convenient and gas-efficient way to explain to users why an operation failed through the use of custom errors. Until now, you could already use strings to give more information about failures (e.g., `revert(\"Insufficient funds.\");`), but they are rather expensive, especially when it comes to deploy cost, and it is difficult to use dynamic information in them.\n\nCustom errors are defined using the `error` statement, which can be used inside and outside of contracts (including interfaces and libraries).\n\nSee [original submission](https://github.com/code-423n4/2022-02-hubble-findings/issues/135) for instances.\n\nI suggest replacing revert strings with custom errors.\n\n**[atvanguard (Hubble) confirmed and commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/135#issuecomment-1051794463):**\n > Amazing report! ⭐\n\n**[moose-code (judge) commented](https://github.com/code-423n4/2022-02-hubble-findings/issues/135#issuecomment-1059781117):**\n > Really detailed and well constructed report. 💯 \n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}