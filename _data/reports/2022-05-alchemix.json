{
  "circa": {
    "title": "Alchemix contest",
    "sponsor": "Alchemix",
    "slug": "2022-05-alchemix",
    "date": "2022-07-18",
    "findings": "https://github.com/code-423n4/2022-05-alchemix-findings/issues",
    "contest": 120
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Alchemix smart contract system written in Solidity. The audit contest took place between May 5—May 18 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>74 Wardens contributed reports to the Alchemix contest:</p>\n<ol>\n<li>hyh</li>\n<li>AuditsAreUS</li>\n<li>TerrierLover</li>\n<li><a href=\"https://twitter.com/WatchPug_\">WatchPug</a> (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li>cccz</li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>0x52</li>\n<li><a href=\"https://twitter.com/CertoraInc\">CertoraInc</a> (egjlmn1, <a href=\"https://twitter.com/ori_dabush\">OriDabush</a>, ItayG, and shakedwinder)</li>\n<li>0x1337</li>\n<li>dirk_y</li>\n<li><a href=\"https://github.com/alex-ppg\">0xsomeone</a></li>\n<li>IllIllI</li>\n<li>tintin</li>\n<li>GimelSec (<a href=\"https://twitter.com/rayn731\">rayn</a> and sces60107)</li>\n<li>BowTiedWardens (BowTiedHeron and BowTiedPickle and <a href=\"BowTiedETHernal\">m4rio_eth</a> and <a href=\"https://twitter.com/JustDravee\">Dravee</a> and BowTiedFirefox)</li>\n<li><a href=\"https://twitter.com/JoeStakey\">joestakey</a></li>\n<li>0x1f8b</li>\n<li>0xDjango</li>\n<li>mics</li>\n<li>0xkatana</li>\n<li><a href=\"https://twitter.com/father0fBl0cks\">fatherOfBlocks</a></li>\n<li>robee</li>\n<li>0x4non</li>\n<li>simon135</li>\n<li><a href=\"https://twitter.com/0xNazgul\">0xNazgul</a></li>\n<li>samruna</li>\n<li><a href=\"https://twitter.com/MaratCerby\">MaratCerby</a></li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li>sikorico</li>\n<li>horsefacts</li>\n<li><a href=\"https://twitter.com/catchup22\">catchup</a></li>\n<li><a href=\"https://twitter.com/ellahinator\">ellahi</a></li>\n<li>oyc_109</li>\n<li><a href=\"https://milotruck.github.io/\">MiloTruck</a></li>\n<li><a href=\"https://instagram.com/vanensurya\">Funen</a></li>\n<li><a href=\"https://twitter.com/Throt7le\">throttle</a></li>\n<li>Cityscape</li>\n<li>bobirichman</li>\n<li>Hawkeye (0xwags and 0xmint)</li>\n<li>Waze</li>\n<li>hake</li>\n<li>kenta</li>\n<li><a href=\"https://twitter.com/sm4rtcontr4ct\">JC</a></li>\n<li><a href=\"https://twitter.com/shenwilly_\">shenwilly</a></li>\n<li>AlleyCat</li>\n<li>jayjonah8</li>\n<li><a href=\"https://twitter.com/thePicodes\">Picodes</a></li>\n<li>cryptphi</li>\n<li><a href=\"https://twitter.com/BouSalman\">BouSalman</a></li>\n<li>delfin454000</li>\n<li>kebabsec (okkothejawa and <a href=\"https://twitter.com/FlameHorizon1\">FlameHorizon</a>)</li>\n<li>sashik_eth</li>\n<li>0xf15ers (remora and twojoy)</li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li>_Adam</li>\n<li><a href=\"https://twitter.com/hansfriese\">hansfriese</a></li>\n<li><a href=\"https://twitter.com/igncarmona\">ignacio</a></li>\n<li><a href=\"https://twitter.com/_0v3rf10w\">0v3rf10w</a></li>\n<li><a href=\"https://twitter.com/fitraldys\">Fitraldys</a></li>\n<li><a href=\"https://twitter.com/randyyramadhan\">Randyyy</a></li>\n<li>UnusualTurtle</li>\n<li><a href=\"https://augustcomputing.com/\">augustg</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/liam_eastwood13\">0xleastwood</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/itsmetechjay\">itsmetechjay</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 17 unique vulnerabilities. Of these vulnerabilities, 0 received a risk rating in the category of HIGH severity and 17 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 46 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 46 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-05-alchemix\">C4 Alchemix contest repository</a>, and is composed of 27 smart contracts written in the Solidity programming language and includes 7,000 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"medium-risk-findings-17\" style=\"position:relative;\"><a href=\"#medium-risk-findings-17\" aria-label=\"medium risk findings 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (17)</h1>\n<h2 id=\"m-01-alchemist-can-mint-altokens-above-their-assigned-ceiling-by-calling-lowerhasminted\" style=\"position:relative;\"><a href=\"#m-01-alchemist-can-mint-altokens-above-their-assigned-ceiling-by-calling-lowerhasminted\" aria-label=\"m 01 alchemist can mint altokens above their assigned ceiling by calling lowerhasminted permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/166\">[M-01] Alchemist can mint <code>AlTokens</code> above their assigned ceiling by calling <code>lowerHasMinted()</code></a></h2>\n<p><em>Submitted by tintin, also found by 0xsomeone, AuditsAreUS, and hyh</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemicTokenV2Base.sol#L111-L124\">AlchemicTokenV2Base.sol#L111-L124</a><br>\n<a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemicTokenV2Base.sol#L189-L191\">AlchemicTokenV2Base.sol#L189-L191</a><br></p>\n<p>An alchemist / user can mint more than their alloted amount of AlTokens by calling <code>lowerHasMinted()</code> before they reach their minting cap.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Function <code>mint()</code> in <code>AlchemicTokenV2Base.sol</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyWhitelisted</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">paused</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IllegalState</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">total</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">totalMinted</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">total</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">mintCeiling</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IllegalState</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">totalMinted</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">total</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>Note the require conditional check that <code>total > mintCeiling[msg.sender]</code>.</p>\n<p>In the same contract, there is the function <code>lowerHasMinted()</code> with the same permission level as mint and is thus callable by the same user as well.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">lowerHasMinted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyWhitelisted</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">totalMinted</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">totalMinted</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>It is clear that a user can accumulate an infinite (within supply) amount of AlTokens by calling <code>lowerHasMinted()</code> before any action that would make them exceed their minting cap.</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual review, VScode</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change the permissioning on <code>lowerHasMinted()</code> to be restricted to a higher permissioned role like <code>onlySentinel()</code> , or deprecate this function as I could not find any uses of it throughout the codebase or in tests.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/166#issuecomment-1140762092\">0xfoobar (Alchemix) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/166#issuecomment-1145217432\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Great find! This would allow whitelisted account to mint any number of tokens. However, as this pertains to only whitelisted accounts, I think <code>medium</code> severity is justified and correct.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-transmuterbuffersol-calls-depositunderlying-with-no-slippage-bounds-\" style=\"position:relative;\"><a href=\"#m-02-transmuterbuffersol-calls-depositunderlying-with-no-slippage-bounds-\" aria-label=\"m 02 transmuterbuffersol calls depositunderlying with no slippage bounds  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/222\">[M-02] TransmuterBuffer.sol calls depositUnderlying with no slippage bounds </a></h2>\n<p><em>Submitted by 0x52</em></p>\n<p>Loss of funds in TransmuterBuffer</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>If the buffer is called during and unfavorable time then a large portion of deposited funds may be lost due to slippage because deposit is called with 0 as the minimum out allowing any level of slippage</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Implement a slippage calculation similar to <code>\\_alchemistWithdraw</code> to protect against it</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/222#issuecomment-1133985891\">0xfoobar (Alchemix) acknowledged, disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>This function is only called by keeper bots harvesting yields, which should not be subject to large slippage and could be sent through a private mempool if necessary. However, we acknowledge that a configurable parameter could enable greater protection, even if in practice the issue does not occur.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/222#issuecomment-1146180192\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Because this requires the keeper role to sandwich attack the protocol when yield is harvested, this better fits the criteria of a <code>medium</code> severity issue.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-dos-in-wrap-and-unwrap\" style=\"position:relative;\"><a href=\"#m-03-dos-in-wrap-and-unwrap\" aria-label=\"m 03 dos in wrap and unwrap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/159\">[M-03] DoS in wrap and unwrap</a></h2>\n<p><em>Submitted by CertoraInc</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/adapters/fuse/FuseTokenAdapterV1.sol#L76\">FuseTokenAdapterV1.sol#L76</a><br>\n<a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/adapters/fuse/FuseTokenAdapterV1.sol#L98\">FuseTokenAdapterV1.sol#L98</a><br></p>\n<p>The code is doing wrong check, so when things will work it will revert.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In the function <code>wrap()</code> there is this lines:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">   if ((error = ICERC20(token).mint(amount)) != NO_ERROR) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            revert FuseError(error);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p>but <code>mint</code> returns the amount that minted, so when <code>error = amount</code> the check will fail even though it worked good.</p>\n<p>Same in <code>unwrap</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if ((error = ICERC20(token).redeem(amount)) != NO_ERROR) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            revert FuseError(error);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p>the redeem returns the amount.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>I recommend to change the lines like this:\nin wrap:\n<code>if ((error = ICERC20(token).mint(amount)) != amount) { revert FuseError(error); }</code>\nand in unwrap:\n<code>if ((error = ICERC20(token).redeem(amount)) != amount) { revert FuseError(error); }</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/159#issuecomment-1133987052\">0xfoobar (Alchemix) confirmed, disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>This would not cause any loss of user funds because the deposit function would revert, but it is a needed fix in the Fuse Adapter. So recommend a lower severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/159#issuecomment-1146198103\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>As no assets are at risk, medium risk seems correct because only the availability of the protocol is impacted.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-yearntokenadapter-allows-a-maximum-loss-of-100-when-withdrawing\" style=\"position:relative;\"><a href=\"#m-04-yearntokenadapter-allows-a-maximum-loss-of-100-when-withdrawing\" aria-label=\"m 04 yearntokenadapter allows a maximum loss of 100 when withdrawing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/60\">[M-04] YearnTokenAdapter allows a maximum loss of 100% when withdrawing</a></h2>\n<p><em>Submitted by Ruhum</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/adapters/yearn/YearnTokenAdapter.sol#L13\">YearnTokenAdapter.sol#L13</a><br>\n<a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/adapters/yearn/YearnTokenAdapter.sol#L43\">YearnTokenAdapter.sol#L43</a><br></p>\n<p>YearnTokenAdapter allows slippage of 100% when withdrawing from the vault which will cause a loss of funds.</p>\n<p>Here’s the documentation straight from the vault contract: <a href=\"https://github.com/yearn/yearn-vaults/blob/main/contracts/Vault.vy#L1025-L1073\">https://github.com/yearn/yearn-vaults/blob/main/contracts/Vault.vy#L1025-L1073</a>\nIt allows the user to specify the <code>maxLoss</code> as the last parameter. It determines how many shares can be burned to fulfill the withdrawal. Currently, the contract uses 10.000 which is 100%. Meaning there is no slippage check at all. This is bound to cause a loss of funds.</p>\n<p>I’d suggest letting the user determine the slippage check themselves instead of hardcoding it.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Current <code>maxLoss</code> value: <a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/adapters/yearn/YearnTokenAdapter.sol#L13\">https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/adapters/yearn/YearnTokenAdapter.sol#L13</a></p>\n<p>call to Yearn vault’s <code>withdraw()</code> function: <a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/adapters/yearn/YearnTokenAdapter.sol#L43\">https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/adapters/yearn/YearnTokenAdapter.sol#L43</a></p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Allow the user to specify the slippage value themselves:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">unwrap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxLoss</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">TokenUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">TokenUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeBalanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountWithdrawn</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IYearnVaultV2</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">maxLoss</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceAfter</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">TokenUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeBalanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// If the Yearn vault did not burn all of the shares then revert. This is critical in mathematical operations</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// performed by the system because the system always expects that all of the tokens were unwrapped. In Yearn,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// this sometimes does not happen in cases where strategies cannot withdraw all of the requested tokens (an</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// example strategy where this can occur is with Compound and AAVE where funds may not be accessible because</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// they were lent out).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">balanceAfter</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IllegalState</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountWithdrawn</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>If you don’t want to change the ITokenAdapter interface you can also leave the value blank. The vault will then use the default value (<code>0.01%</code>)</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/60#issuecomment-1133991312\">0xfoobar (Alchemix) acknowledged, disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>This could be made more configurable by the end user but yearn vaults do not frequently experience high slippage. Slippage is handled upstream in the Alchemist contract. The reason why this slippage is set to 100% is so to permit handling of slippage in the Alchemist for all cases.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/60#issuecomment-1146206028\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Because we can’t know how the yearn strategy implements withdrawals, its possible that it might contain custom swap logic which exposes itself to sandwich attacks. However, at face value, the current use of <code>MAXIMUM_SLIPPAGE</code> allows the contract to successfully unwrap their tokens under poor network conditions, but it makes sense for the user to have more control over this. Downgrading this to medium risk as I believe it is more in line with that.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-no-storage-gap-for-upgradeable-contract-might-lead-to-storage-slot-collision\" style=\"position:relative;\"><a href=\"#m-05-no-storage-gap-for-upgradeable-contract-might-lead-to-storage-slot-collision\" aria-label=\"m 05 no storage gap for upgradeable contract might lead to storage slot collision permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/44\">[M-05] No Storage Gap for Upgradeable Contract Might Lead to Storage Slot Collision</a></h2>\n<p><em>Submitted by 0x1337</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemicTokenV2Base.sol#L20\">AlchemicTokenV2Base.sol#L20</a><br>\n<a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/CrossChainCanonicalBase.sol#L12\">CrossChainCanonicalBase.sol#L12</a><br>\n<a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/TransmuterV2.sol#L26\">TransmuterV2.sol#L26</a><br>\n<a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/CrossChainCanonicalAlchemicTokenV2.sol#L7\">CrossChainCanonicalAlchemicTokenV2.sol#L7</a><br></p>\n<p>For upgradeable contracts, there must be storage gap to “allow developers to freely add new state variables in the future without compromising the storage compatibility with existing deployments” (quote OpenZeppelin). Otherwise it may be very difficult to write new implementation code. Without storage gap, the variable in child contract might be overwritten by the upgraded base contract if new variables are added to the base contract. This could have unintended and very serious consequences to the child contracts, potentially causing loss of user fund or cause the contract to malfunction completely.</p>\n<p>Refer to the bottom part of this article: <a href=\"https://docs.openzeppelin.com/upgrades-plugins/1.x/writing-upgradeable\">https://docs.openzeppelin.com/upgrades-plugins/1.x/writing-upgradeable</a></p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Several contracts are intended to be upgradeable contracts in the code base, including</p>\n<ul>\n<li>AlchemicTokenV2Base</li>\n<li>CrossChainCanonicalBase</li>\n<li>CrossChainCanonicalAlchemicTokenV2</li>\n<li>TransmuterV2</li>\n</ul>\n<p>However, none of these contracts contain storage gap. The storage gap is essential for upgradeable contract because “It allows us to freely add new state variables in the future without compromising the storage compatibility with existing deployments”. Refer to the bottom part of this article:</p>\n<p><a href=\"https://docs.openzeppelin.com/contracts/3.x/upgradeable\">https://docs.openzeppelin.com/contracts/3.x/upgradeable</a></p>\n<p>As an example, both the <code>AlchemicTokenV2Base</code> and the <code>CrossChainCanonicalBase</code> are intended to act as the base contracts in the project. If the contract inheriting the base contract contains additional variable, then the base contract cannot be upgraded to include any additional variable, because it would overwrite the variable declared in its child contract. This greatly limits contract upgradeability.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Recommend adding appropriate storage gap at the end of upgradeable contracts such as the below. Please reference OpenZeppelin upgradeable contract templates.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[</span><span class=\"mtk7\">50</span><span class=\"mtk1\">] </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">__gap</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/44#issuecomment-1140765969\">0xfoobar (Alchemix) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/44#issuecomment-1153292612\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with warden and severity. Storage gaps are essential wherever inheritance is used by an upgradeable contract.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-ethassetmanager-and-threepoolassetmanager-dont-control-meta-tokens-decimals\" style=\"position:relative;\"><a href=\"#m-06-ethassetmanager-and-threepoolassetmanager-dont-control-meta-tokens-decimals\" aria-label=\"m 06 ethassetmanager and threepoolassetmanager dont control meta tokens decimals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/63\">[M-06] EthAssetManager and ThreePoolAssetManager don’t control Meta tokens decimals</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p>Both contracts treat meta assets as if they have fixed decimals of 18. Minting logic breaks when it’s not the case. However, meta tokens decimals aren’t controlled.</p>\n<p>If actual meta assets have any other decimals, minting slippage control logic of both contracts will break up as <code>total</code> is calculated as a plain sum of token amounts.</p>\n<p>In the higher token decimals case <code>minTotalAmount</code> will be magnitudes higher than actual amount Curve can provide and minting becomes unavailable.</p>\n<p>In the lower token decimals case <code>minTotalAmount</code> will lack value and slippage control will be rendered void, which opens up a possibility of a fund loss from the excess slippage.</p>\n<p>Setting severity to medium as the contract can be used with various meta tokens (<code>_metaPoolAssetCache</code>  can be filled with any assets) and, whenever decimals differ from 18 <code>add_liquidity</code> uses, its logic be broken: the inability to mint violates the contract purpose, the lack of slippage control can lead to fund losses.</p>\n<p>I.e. this is system breaking impact conditional on a low probability assumption of different meta token decimals.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Meta tokens decimals are de facto hard coded into the contract as plain amounts are used (L. 905):</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/ThreePoolAssetManager.sol#L896-L905\">ThreePoolAssetManager.sol#L896-L905</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_mintMetaPoolTokens</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[</span><span class=\"mtk12\">NUM_META_COINS</span><span class=\"mtk1\">] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amounts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minted</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\">[</span><span class=\"mtk12\">NUM_META_COINS</span><span class=\"mtk1\">] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokens</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_metaPoolAssetCache</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">total</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">NUM_META_COINS</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">continue</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">total</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/ThreePoolAssetManager.sol#L915-L919\">ThreePoolAssetManager.sol#L915-L919</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expectedOutput</span><span class=\"mtk1\">    = </span><span class=\"mtk12\">total</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">CURVE_PRECISION</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">metaPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get_virtual_price</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minimumMintAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">expectedOutput</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">metaPoolSlippage</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">SLIPPAGE_PRECISION</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Add the liquidity to the pool.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">minted</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">metaPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add_liquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minimumMintAmount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The same plain sum approach is used in EthAssetManager._mintMetaPoolTokens:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/EthAssetManager.sol#L566-L573\">EthAssetManager.sol#L566-L573</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">total</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">NUM_META_COINS</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Skip over approving WETH since we are directly swapping ETH.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">i</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MetaPoolAsset</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ETH</span><span class=\"mtk1\">)) </span><span class=\"mtk15\">continue</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">continue</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">total</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<p>When this decimals assumption doesn’t hold, the slippage logic will not hold too: either the mint be blocked or slippage control disabled.</p>\n<p>Notice, that ThreePoolAssetManager.calculateRebalance do query alUSD decimals (which is inconsistent with the above as it’s either fix and control on inception or do not fix and accommodate the logic):</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/ThreePoolAssetManager.sol#L338-L338\">ThreePoolAssetManager.sol#L338-L338</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">decimals</span><span class=\"mtk1\">     = </span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectDecimals</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alUSD</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>If meta assets are always supposed to have fixed decimals of 18, consider controlling it at the construction time.</p>\n<p>I.e. the decimals can be controlled in constructors:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/EthAssetManager.sol#L214-L219\">EthAssetManager.sol#L214-L219</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">NUM_META_COINS</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_metaPoolAssetCache</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">metaPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">coins</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_metaPoolAssetCache</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] == </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_metaPoolAssetCache</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+           } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+           \t</span><span class=\"mtk3\">// check the decimals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/ThreePoolAssetManager.sol#L254-L256\">ThreePoolAssetManager.sol#L254-L256</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">NUM_META_COINS</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_metaPoolAssetCache</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">metaPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">coins</span><span class=\"mtk1\">(</span><span class=\"mtk12\">i</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+           </span><span class=\"mtk3\">// check the decimals            </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>In this case further decimals reading as it’s done in calculateRebalance() is redundant.</p>\n<p>Otherwise (which is less recommended as fixed decimals assumption is viable and simplify the logic) the meta token decimals can be added to calculations similarly to stables:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/ThreePoolAssetManager.sol#L779-L779\">ThreePoolAssetManager.sol#L779-L779</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">normalizedTotal</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] * </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk12\">missingDecimals</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/63#issuecomment-1141380260\">0xfoobar (Alchemix) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/63#issuecomment-1153292871\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with issue and its severity. <code>minTotalAmount</code> is affected by a change in a token’s decimals, leading to improper handling by the contract. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-autoleveragebase-must-approve-0-first\" style=\"position:relative;\"><a href=\"#m-07-autoleveragebase-must-approve-0-first\" aria-label=\"m 07 autoleveragebase must approve 0 first permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/144\">[M-07] AutoleverageBase: Must approve 0 first</a></h2>\n<p><em>Submitted by cccz</em></p>\n<p>Some tokens (like USDT) do not work when changing the allowance from an existing non-zero allowance value.They must first be approved by zero and then the actual allowance must be approved.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/AutoleverageBase.sol#L61-L63\">AutoleverageBase.sol#L61-L63</a><br></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/AutoleverageBase.sol#L147-L147\">AutoleverageBase.sol#L147-L147</a><br></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/AutoleverageBase.sol#L178-L179\">AutoleverageBase.sol#L178-L179</a><br></p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function approve(address token, address spender) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    +  IERC20(token).approve(spender, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20(token).approve(spender, type(uint256).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/144#issuecomment-1134868843\">0xtao (Alchemix) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This implementation will not work for tokens like USDT where the approval is not set to <code>0</code> initially</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/144#issuecomment-1146364549\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>It seems like <code>approve()</code> will fail to execute on non-standard tokens which require the approval amount to start from zero. This is valid and should be updated to handle such tokens.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-yearntokenadapters-wrap-can-become-stuck-as-it-uses-one-step-approval-for-an-arbitrary-underlying\" style=\"position:relative;\"><a href=\"#m-08-yearntokenadapters-wrap-can-become-stuck-as-it-uses-one-step-approval-for-an-arbitrary-underlying\" aria-label=\"m 08 yearntokenadapters wrap can become stuck as it uses one step approval for an arbitrary underlying permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/99\">[M-08] YearnTokenAdapter’s wrap can become stuck as it uses one step approval for an arbitrary underlying</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p>Some tokens do not allow for approval of positive amount when allowance is positive already (to handle approval race condition, most known example is USDT).</p>\n<p>This can cause the function to stuck whenever a combination of such a token and leftover approval be met. The latter can be possible if, for example, yearn vault is becoming full on a particular wrap() call and accepts only a part of amount, not utilizing the approval fully.</p>\n<p>Then each next safeApprove will revert and wrap becomes permanently unavailable. Setting the severity to medium as depositing (wrapping) is core functionality for the contract and its availability is affected.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>wrap use one step approve:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/adapters/yearn/YearnTokenAdapter.sol#L30-L32\">YearnTokenAdapter.sol#L30-L32</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">wrap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">TokenUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">TokenUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Some ERC20 forbid the approval of positive amount when the allowance is positive:</p>\n<p><a href=\"https://github.com/d-xo/weird-erc20#approval-race-protections\">https://github.com/d-xo/weird-erc20#approval-race-protections</a></p>\n<p>For example, USDT is supported by Yearn and can be the underlying asset:</p>\n<p><a href=\"https://yearn.finance/#/vault/0x7Da96a3891Add058AdA2E826306D812C638D87a7\">https://yearn.finance/#/vault/0x7Da96a3891Add058AdA2E826306D812C638D87a7</a></p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>As the most general approach consider approving zero before doing so for the amount:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">wrap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">TokenUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+      </span><span class=\"mtk12\">TokenUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">TokenUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/99#issuecomment-1141378852\">0xfoobar (Alchemix) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/99#issuecomment-1146364671\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>It seems like <code>approve()</code> will fail to execute on non-standard tokens which require the approval amount to start from zero. This is valid and should be updated to handle such tokens.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-transmuterbuffers-setalchemist-will-freeze-deposited-funds\" style=\"position:relative;\"><a href=\"#m-09-transmuterbuffers-setalchemist-will-freeze-deposited-funds\" aria-label=\"m 09 transmuterbuffers setalchemist will freeze deposited funds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/117\">[M-09] TransmuterBuffer’s setAlchemist will freeze deposited funds</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p>Currently setAlchemist doesn’t check whether there are any open positions left with the old Alchemist before switching to the new one.</p>\n<p>As this require a number of checks the probability of operational mistake isn’t low and it’s prudent to introduce the main controls directly to the code to minimize it. In the case if the system go on with new Alchemist before realizing that there are some funds left in the old one, tedious and error prone manual recovery will be needed. There is also going to be a corresponding reputational damage.</p>\n<p>Setting the severity to medium as while the function is admin only, the impact is up to massive user fund freeze, i.e. this is system breaking with external assumptions.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Alchemist implementation change can happen while there are open deposits remaining with the current contract. As there looks to be no process to transfer them in the code, such TransmuterBuffer’s funds will be frozen with old alchemist:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-hardhat/TransmuterBuffer.sol#L230-L232\">TransmuterBuffer.sol#L230-L232</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setAlchemist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_alchemist</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyAdmin</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">sources</span><span class=\"mtk1\">[</span><span class=\"mtk12\">alchemist</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">sources</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_alchemist</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider requiring that all exposure to the old Alchemist is closed, for example both <code>getAvailableFlow</code> and <code>getTotalCredit</code> is zero.</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/TransmuterBuffer.sol#L230-L231\">TransmuterBuffer.sol#L230-L231</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setAlchemist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_alchemist</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyAdmin</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+\t\t  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getTotalCredit</span><span class=\"mtk1\">() == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Credit exists with old Alchemist&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+       </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">registeredUnderlyings</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">j</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">getTotalUnderlyingBuffered</span><span class=\"mtk1\">[</span><span class=\"mtk12\">registeredUnderlyings</span><span class=\"mtk1\">[</span><span class=\"mtk12\">j</span><span class=\"mtk1\">]] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Buffer exists with old Alchemist&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+       }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">sources</span><span class=\"mtk1\">[</span><span class=\"mtk12\">alchemist</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/117#issuecomment-1140762972\">0xfoobar (Alchemix) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/117#issuecomment-1153293529\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This is useful in preventing loss of funds when changing the protocol’s alchemist contract.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-new-galcx-token-denomination-can-be-depressed-by-the-first-depositor\" style=\"position:relative;\"><a href=\"#m-10-new-galcx-token-denomination-can-be-depressed-by-the-first-depositor\" aria-label=\"m 10 new galcx token denomination can be depressed by the first depositor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/135\">[M-10] New gALCX token denomination can be depressed by the first depositor</a></h2>\n<p><em>Submitted by hyh, also found by 0xsomeone</em></p>\n<p>An attacker can become the first depositor for a recently created gALCX contract, providing a tiny amount of ALCX tokens by calling <code>stake(1)</code> (raw values here, <code>1</code> is <code>1 wei</code>, <code>1e18</code> is <code>1 ALCX</code>). Then the attacker can directly transfer, for example, <code>10^6 * 1e18 - 1</code> of ALCX to the gALCX contract and run bumpExchangeRate(), effectively setting the cost of <code>1</code> gALCX to be <code>10^6 * 1e18</code> of ALCX. The attacker will still own 100% of the gALCX’s ALCX pool being the only depositor.</p>\n<p>All subsequent depositors will have their ALCX token investments rounded to <code>10^6 * 1e18</code>, due to the lack of precision which initial tiny deposit caused, with the remainder divided between all current depositors, i.e. the subsequent depositors lose value to the attacker.</p>\n<p>For example, if the second depositor brings in <code>1.9*10^6 * 1e18</code> of ALCX, only <code>1</code> of new vault to be issued as <code>1.9*10^6 * 1e18</code> divided by <code>10^6 * 1e18</code> will yield just <code>1</code>, which means that <code>2.9*10^6 * 1e18</code> total ALCX pool will be divided 50/50 between the second depositor and the attacker, as each will have <code>1 wei</code> of the total <code>2 wei</code> of vault tokens, i.e. the depositor lost and the attacker gained <code>0.45 * 10^6 * 1e18</code> of ALCX tokens.</p>\n<p>As there are no penalties to exit with gALCX.unstake(), the attacker can remain staked for an arbitrary time, gathering the share of all new deposits’ remainder amounts.</p>\n<p>Placing severity to be medium as this is principal funds loss scenario for many users (most of depositors), easily executable, but only new gALCX contract instances are vulnerable.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>gAmount of gALCX to be minted is determined as a quotient of <code>amount</code> provided and <code>exchangeRate</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-hardhat/gALCX.sol#L93-L94\">gALCX.sol#L93-L94</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">gAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">exchangeRatePrecision</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">exchangeRate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">gAmount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/gALCX.sol#L15\">gALCX.sol#L15</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">exchangeRatePrecision</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><code>exchangeRate</code> accumulates balance increments relative to total gALCX supply:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/gALCX.sol#L69-L76\">gALCX.sol#L69-L76</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">bumpExchangeRate</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Claim from pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pools</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claim</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Bump exchange rate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">alcx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">exchangeRate</span><span class=\"mtk1\"> += (</span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">exchangeRatePrecision</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>When gALCX contract is new, the very first stake -> bumpExchangeRate() yields nothing as the balance is empty, i.e. <code>exchangeRate</code> is still <code>1e18</code> and <code>gAmount == amount</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/gALCX.sol#L85-L93\">gALCX.sol#L85-L93</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">stake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Get current exchange rate between ALCX and gALCX</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">bumpExchangeRate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Then receive new deposits</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">alcx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Transfer failed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pools</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// gAmount always &lt;= amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">gAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">exchangeRatePrecision</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">exchangeRate</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>This way, as there is no minimum amount or special treatment for the first deposit, the very first <code>gAmount</code> can be made <code>1 wei</code> with <code>stake(1)</code> call.</p>\n<p>Then, a combination of direct ALCX transfer and bumpExchangeRate() will make <code>exchangeRate</code> equal to the total amount provided by the attacker, say <code>10^6 * 1e18 * 1e18</code>, as totalSupply is <code>1 wei</code>.</p>\n<p>When a second depositor enters, the amount of gALCX to be minted is calculated as <code>amount * exchangeRatePrecision / exchangeRate</code>, which is <code>amount / (10^6 * 1e18)</code>, which will trunk the <code>amount</code> to the nearest divisor of <code>10^6 * 1e18</code>, effectively dividing the remainder between the depositor and the attacker.</p>\n<p>For example, if the second depositor brings in <code>1.9*10^6</code> ALCX, only <code>1</code> (<code>1 wei</code>) of gALCX to be issued as <code>1.9*10^6 * 1e18 * 1e18 / (10^6 * 1e18 * 1e18)</code> = <code>1</code>.</p>\n<p>As the attacker and depositor both have <code>1</code> of gALCX, each owns <code>(2.9 / 2)*10^6 * 1e18 = 1.45*10^6 * 1e18</code>, so the attacker effectively stole <code>0.45*10^6 * 1e18</code> from the depositor.</p>\n<p>Any deposit lower than total attacker’s stake, <code>10^6 * 1e18</code>, will be fully stolen from the depositor as <code>0</code> gALCX tokens will be issued in this case.</p>\n<h3 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>References</h3>\n<p>The issue is similar to the <code>TOB-YEARN-003</code> one of the Trail of Bits audit of Yearn Finance:</p>\n<p><a href=\"https://github.com/yearn/yearn-security/tree/master/audits/20210719_ToB_yearn_vaultsv2\">https://github.com/yearn/yearn-security/tree/master/audits/20210719_ToB_yearn_vaultsv2</a></p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>A minimum for deposit value can drastically reduce the economic viability of the attack. I.e. stake() can require each amount to surpass the threshold, and then an attacker would have to provide too big direct investment to capture any meaningful share of the subsequent deposits.</p>\n<p>An alternative is to require only the first depositor to freeze big enough initial amount of liquidity. This approach has been used long enough by various projects, for example in Uniswap V2:</p>\n<p><a href=\"https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol#L119-L121\">Uniswap/UniswapV2Pair.sol#L119-L121</a><br></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/135#issuecomment-1140704865\">0xfoobar (Alchemix) acknowledged, disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Not a risk with current >400 tokenholders, but good to incorporated into future designs.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/135#issuecomment-1146370503\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I think from the perspective of the contest, it is fair to assume that contracts are somewhat fresh. I’d be inclined to keep this as medium because it outlines a viable attack path that should be made public.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-galcxsol-attacker-can-make-the-contract-unusable-when-totalsupply-is-0\" style=\"position:relative;\"><a href=\"#m-11-galcxsol-attacker-can-make-the-contract-unusable-when-totalsupply-is-0\" aria-label=\"m 11 galcxsol attacker can make the contract unusable when totalsupply is 0 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/198\">[M-11] [gALCX.sol] Attacker can make the contract unusable when totalSupply is 0</a></h2>\n<p><em>Submitted by TerrierLover</em></p>\n<p>An attacker can make the contract unusable when totalSupply is 0. Specifically,  <code>bumpExchangeRate</code> function does not work correctly which results in making <code>stake</code>, <code>unstake</code> and <code>migrateSource</code> functions that do not work as expected.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Here are steps on how the <code>gALCX</code> contract can be unusable.</p>\n<ol>\n<li><code>gALCX</code> contract is deployed</li>\n<li>The attacker sends the <code>ALCX</code> token to the deployed <code>gALCX</code> contract directly instead of using <code>stake</code> function so that the following <code>balance</code> variable has value.</li>\n</ol>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-hardhat/gALCX.sol#L73-L75\">gALCX.sol#L73-L75</a><br>\nuint balance = alcx.balanceOf(address(this));</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (balance &gt; 0) {</span></span></code></pre>\n<ol start=\"3\">\n<li>Since the <code>ALCX</code> token is given to the <code>gALCX</code> contract directly, <code>totalSupply == 0</code> and <code>alcx.balanceOf(address(this)) > 0</code> becomes true.</li>\n</ol>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-hardhat/gALCX.sol#L76\">gALCX.sol#L76</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">exchangeRate += (balance * exchangeRatePrecision) / totalSupply;</span></span></code></pre>\n<ol start=\"4\">\n<li>Non attackers try to call <code>stake</code> function, but <code>bumpExchangeRate</code> function fails because of <code>(balance * exchangeRatePrecision) / totalSupply</code> when totalSupply is 0.</li>\n<li>Owner cannot call <code>migrateSource</code> function since <code>bumpExchangeRate</code> will be in the same situation mentioned in the step4 above</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add handling when <code>totalSupply</code> is 0 but <code>alcx.balanceOf(address(this))</code> is more than 0.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/198#issuecomment-1133996854\">0xfoobar (Alchemix) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Given that the gALCX deployment has 412 unique tokenholders on mainnet, this series of events is extraordinarily unlikely to occur. But we will keep it in mind for future deployments.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/198#issuecomment-1146895463\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Nice find! Early stakers can DoS new contract deployments, making it impossible for other users to participate in the protocol. As this does not lead to lost funds and is recoverable through redeployment, I believe medium severity to be justified by the warden.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-12-registerasset-misuse-can-permanently-disable-transmuterbuffer-and-break-the-system\" style=\"position:relative;\"><a href=\"#m-12-registerasset-misuse-can-permanently-disable-transmuterbuffer-and-break-the-system\" aria-label=\"m 12 registerasset misuse can permanently disable transmuterbuffer and break the system permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/113\">[M-12] registerAsset misuse can permanently disable TransmuterBuffer and break the system</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p>TransmuterBuffer’s refreshStrategies() is the only way to actualize _yieldTokens array. The function requires registeredUnderlyings array to match current Alchemist’s _supportedUnderlyingTokens. In the same time registeredUnderlyings can be only increased via registerAsset(): there is no way to reduce, remove or reconstruct the array.</p>\n<p>This way if registerAsset() was mistakenly called extra time or alchemist was switched with setAlchemist to a new one with less supported assets, then the strategy refresh becomes impossible and the TransmuterBuffer be blocked as it cannot be properly used without synchronization with Alchemist.</p>\n<p>The redeployment of the contract doesn’t provide an easy fix as it holds the accounting data that needs to be recreated (flowAvailable, currentExchanged mappings).</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>refreshStrategies require registeredUnderlyings to be equal to Alchemist’s supportedUnderlyingTokens:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/TransmuterBuffer.sol#L377-L379\">TransmuterBuffer.sol#L377-L379</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">registeredUnderlyings</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">supportedUnderlyingTokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IllegalState</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>If registeredUnderlyings has length more than Alchemist’s _supportedUnderlyingTokens it doesn’t look to be fixable and prohibits the future use of the contract, i.e. breaks the system.</p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The issue is that there is no way to unregister the asset, so consider introducing a function to remove the underlying or simply delete the array so it can be reconstructed with a sequence of registerAsset calls.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/113#issuecomment-1139901087\">thetechnocratic (Alchemix) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>There is no way for <code>registerAsset</code> to be accidentally called too many times, and it reverts if an asset doesn’t exist in the Alchemist or has already been registered.<br>\nThe TransmuterBuffer <em>could</em> be assigned a new Alchemist with fewer assets, but it is safe to assume that the operator will not make such a grand oversight.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/113#issuecomment-1153294243\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Useful mitigation to prevent the TransmuterBuffer from being assigned a new Alchemist with fewer assets. In this event, the availability of the protocol is impacted. Valid medium.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-13-transmuterbuffers-_alchemistwithdraw-use-hard-coded-slippage-that-can-lead-to-user-losses\" style=\"position:relative;\"><a href=\"#m-13-transmuterbuffers-_alchemistwithdraw-use-hard-coded-slippage-that-can-lead-to-user-losses\" aria-label=\"m 13 transmuterbuffers _alchemistwithdraw use hard coded slippage that can lead to user losses permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/127\">[M-13] TransmuterBuffer’s _alchemistWithdraw use hard coded slippage that can lead to user losses</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p>exchange() -> _exchange() -> _alchemistWithdraw() is user funds utilizing call sequence and the slippage hard coded to 1% there can cause a range of issues.</p>\n<p>For example, if there is not enough shares, the number of shares to withdraw will be unconditionally reduced to the number of the shares available. This can pass under 1% slippage and user will give away up to 1% without giving a consent to such a fee, which is big enough to notice.</p>\n<p>On the other hand, in a similar situation when there is not enough shares available a user might knowingly want to execute with even bigger fee, but hard coded slippage will not be met and the withdraw be unavailable and funds frozen.</p>\n<p>Setting the severity to medium as the end impact is either modest user fund loss or exchange functionality unavailability.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>_alchemistWithdraw uses hard coded 1% slippage threshold and rewrites wantShares to be availableShares once TransmuterBuffer’s position isn’t big enough:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-hardhat/TransmuterBuffer.sol#L511-L524\">TransmuterBuffer.sol#L511-L524</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_alchemistWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountUnderlying</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">TokenUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectDecimals</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pricePerShare</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IAlchemistV2</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alchemist</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getUnderlyingTokensPerShare</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wantShares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amountUnderlying</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk12\">decimals</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">pricePerShare</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">availableShares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastAccruedWeight</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">IAlchemistV2</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alchemist</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positions</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">token</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">wantShares</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">availableShares</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">wantShares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">availableShares</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Allow 1% slippage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minimumAmountOut</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amountUnderlying</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amountUnderlying</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">wantShares</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">IAlchemistV2</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alchemist</span><span class=\"mtk1\">).</span><span class=\"mtk11\">withdrawUnderlying</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">wantShares</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">minimumAmountOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Alchemist’s _unwrap will revert withdrawUnderlying call once minimumAmountOut isn’t met:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemistV2.sol#L1344-L1346\">AlchemistV2.sol#L1344-L1346</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amountUnwrapped</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">minimumAmountOut</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SlippageExceeded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amountUnwrapped</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minimumAmountOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>There are 2 use cases for the function:</p>\n<p>exchange (onlyKeeper) -> _exchange -> _alchemistWithdraw,</p>\n<p>setFlowRate (onlyAdmin) -> _exchange -> _alchemistWithdraw</p>\n<p>exchange() is the most crucial as it should be able to fulfil various types of user funds exchange requests:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/TransmuterBuffer.sol#L526-L546\">TransmuterBuffer.sol#L526-L546</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @notice Pull necessary funds from the Alchemist and exchange them.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">///</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param underlyingToken The underlying-token to exchange.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_exchange</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_updateFlow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalUnderlyingBuffered</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getTotalUnderlyingBuffered</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">initialLocalBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">TokenUtils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeBalanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">want</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Here we assume the invariant underlyingToken.balanceOf(address(this)) &gt;= currentExchanged[underlyingToken].</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">totalUnderlyingBuffered</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">flowAvailable</span><span class=\"mtk1\">[</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Pull the rest of the funds from the Alchemist.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">want</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalUnderlyingBuffered</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">initialLocalBalance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">initialLocalBalance</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">flowAvailable</span><span class=\"mtk1\">[</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// totalUnderlyingBuffered &gt; flowAvailable so we have funds available to pull.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">want</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">flowAvailable</span><span class=\"mtk1\">[</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">] - </span><span class=\"mtk12\">initialLocalBalance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">want</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_alchemistAction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">want</span><span class=\"mtk1\">, </span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_alchemistWithdraw</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>This way, one issue here is that user can end up giving away the full 1% unconditionally to market situation because there are not enough shares available.</p>\n<p>Another one is that knowing that the conditions are bad or that there are not enough shares available and willing to run the exchange with bigger slippage the user will not be able to as there are no means to control it and the functionality will end up unavailable, being reverted by Alchemist’s _unwrap check.</p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding the function argument with a default value of 1%, so the slippage can be tuned when it is needed.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/127#issuecomment-1139827436\">thetechnocratic (Alchemix) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Allowing for a caller-defined slippage would enable more flexibility when using the <code>exchange()</code> and <code>setFlowRate()</code> calls.  However, the possibility of needing this flexibility at this time is very small, and because these functions are run by admins/keepers, there is room to modify the code if and when the flexibility becomes required.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/127#issuecomment-1153294479\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with warden. During periods of high volatility, assets will be locked within the contract. As this limits protocol availability, potentially leading to further loss of funds as users cannot freely exit the protocol and sell tokens, medium risk is justified.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-14-a-well-financed-attacker-could-prevent-any-other-users-from-minting-synthetic-tokens\" style=\"position:relative;\"><a href=\"#m-14-a-well-financed-attacker-could-prevent-any-other-users-from-minting-synthetic-tokens\" aria-label=\"m 14 a well financed attacker could prevent any other users from minting synthetic tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/155\">[M-14] A well financed attacker could prevent any other users from minting synthetic tokens</a></h2>\n<p><em>Submitted by dirk</em>y_</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/AlchemistV2.sol#L676-L683\">AlchemistV2.sol#L676-L683</a><br>\n<a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/AlchemistV2.sol#L704\">AlchemistV2.sol#L704</a><br>\n<a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/libraries/Limiters.sol#L84\">Limiters.sol#L84</a><br></p>\n<p>In the <code>AlchemistV2</code> contract, users can deposit collateral to then borrow/mint the synthetic tokens offered by the protocol. The protocol also defines a minting limit that specifies how many synthetic tokens can be minted in a given time period. This exists to prevent unbounded minting of synthetic tokens.</p>\n<p>Every time a user calls <code>mint</code>, the internal <code>_mint</code> method decreases the current mint limit. This works as intended. However, there is nothing stopping an attacker from immediately burning their synthetic tokens by calling <code>burn</code> and then calling <code>mint</code> again. This is possible because the debt position is updated during the <code>burn</code> phase, which lets the user then mint again against the same deposited collateral.</p>\n<p>In most cases this probably wouldn’t be a problem if the mint limit is sufficiently high. However, it is currently possible for a well financed attacker to grief the contract by repeatedly minting and burning synthetic tokens to keep the contract pegged at the mint limit. This will prevent any normal users from minting any synthetic tokens, and hence prevents the protocol from performing as it should.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>An attacker can repeatedly call <code>mint</code> followed by <code>burn</code> after depositing some collateral with <code>deposit</code>. If this is appropriately sized and timed, it can cause the <code>mint</code> call to fail for another user due to the check <a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/AlchemistV2.sol#L1068\">here</a> that is called during <code>mint</code> <a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/AlchemistV2.sol#L1192\">here</a>.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>There should be an additional method added to the <code>Limiters</code> library that can increment the mint limit. This method can then be called during a <code>burn</code> call in the <code>AlchemistV2</code> contract.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function increase(LinearGrowthLimiter storage self, uint256 amount) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  uint256 value = self.get();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  self.lastValue = value + amount &gt; self.maximum ? self.maximum : value + amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/155#issuecomment-1134046370\">0xfoobar (Alchemix) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>If somebody griefed, let alone the insanely high capital requirements, governance could simply raise the mint limit.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/155#issuecomment-1147232259\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>As far as I can tell, this seems like a valid griefing attack. Assuming no fees are charged on mint/burn actions, it would be viable to use a flash loan to use up the entire mint limit, preventing other users from participating in the protocol. This could be mostly mitigated by charging a small fee on mints, which is sent to the protocol’s governance contract or distributed to pre-existing stakers. Could you confirm this @0xfoobar ?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/155#issuecomment-1147991797\">0xfoobar (Alchemix) commented</a>:</strong></p>\n<blockquote>\n<p>Upon further review the griefing action of</p>\n<ol>\n<li>initiate flashloan</li>\n<li>deposit</li>\n<li>mint</li>\n<li>burn</li>\n<li>repay flashloan</li>\n</ol>\n<p>would be a valid approach to grief the protocol. No funds are at risk but we’ll discuss internally how to best mitigate this.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/155#issuecomment-1149856681\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agreed, keeping this issue as is!</p>\n<p>This could have been upgraded to high risk if the ease of attack involved:</p>\n<ul>\n<li>Limits on burning tokens.</li>\n<li>The griefing attack is somewhat cheap, making it easy for attackers to maintain.</li>\n</ul>\n<p>But as the issue raised does not lead to a loss of user’s funds, I believe medium risk to be justified.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-15-lido-adapter-incorrectly-calculates-the-price-of-the-underlying-token\" style=\"position:relative;\"><a href=\"#m-15-lido-adapter-incorrectly-calculates-the-price-of-the-underlying-token\" aria-label=\"m 15 lido adapter incorrectly calculates the price of the underlying token permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/97\">[M-15] Lido adapter incorrectly calculates the price of the underlying token</a></h2>\n<p><em>Submitted by AuditsAreUS</em></p>\n<p>The Lido adapter incorrectly calculates the price of WETH in terms of WstETH.</p>\n<p>The function returns the price of WstETH in terms of stETH. The underlying token which we desire is WETH.\nSince stETH does not have the same value as WETH the output price incorrect.</p>\n<p>The impact is severe as all the balance calculations require the price of the yield token converted to underlying. The incorrect price may over or understate the harvestable amount which is a core calculation in the protocol.</p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The function <code>IWstETH(token).getStETHByWstETH()</code> only converts WstETH to stETH. Thus, <code>price()</code> returns the value of WstETH in terms of stETH.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">price</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IWstETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getStETHByWstETH</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectDecimals</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add extra steps to <code>price()</code> to approximate the rate for converting stETH to ETH. This can be done using the same curve pool that is used to convert stETH to ETH in <code>unwrap()</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/97#issuecomment-1133989793\">0xfoobar (Alchemix) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>The design mechanism relies upon stETH reaching eventual 1:1 redeemability for ETH after the merge and shanghai enables withdrawals. This is core to out like-kind collateral/asset model. We will update the stETH token adapter at that time to do direct redemptions instead of Curve swaps. So in the meantime, the protocol accrues discounted assets.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/97#issuecomment-1150012226\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>While the sponsor’s comments suggest that this will be a non-issue after the merge/shanghai enables withdrawals, I believe there is legitimacy in the fact that the protocol will accrue discounted assets. It does not lead to the loss of assets, but value can be leaked if <code>WETH</code> is priced incorrectly. As such, I’m downgrading this to medium severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-16-if-totalshares-for-a-token-falls-to-zero-while-there-is-pendingcredit-the-contract-will-become-stuck\" style=\"position:relative;\"><a href=\"#m-16-if-totalshares-for-a-token-falls-to-zero-while-there-is-pendingcredit-the-contract-will-become-stuck\" aria-label=\"m 16 if totalshares for a token falls to zero while there is pendingcredit the contract will become stuck permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/104\">[M-16] If <code>totalShares</code> for a token falls to zero while there is <code>pendingCredit</code> the contract will become stuck</a></h2>\n<p><em>Submitted by AuditsAreUS</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemistV2.sol#L1290-L1300\">AlchemistV2.sol#L1290-L1300</a><br>\n<a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemistV2.sol#L1268\">AlchemistV2.sol#L1268</a><br>\n<a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemistV2.sol#L1532\">AlchemistV2.sol#L1532</a><br>\n<a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemistV2.sol#L899\">AlchemistV2.sol#L899</a><br>\n<a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemistV2.sol#L1625\">AlchemistV2.sol#L1625</a><br></p>\n<p>It is possible for the contract to become stuck and unable to perform any actions if the <code>totalShares</code> of a yield token fall to zero while there is some <code>pendingCredit</code> still to be paid.</p>\n<p>It will then be impossible to call deposit or withdraw functions, mints, burns, repay, liquidate, donate or harvest due to division by zero reverts in:</p>\n<ul>\n<li><code>_distributeCredit()</code></li>\n<li><code>_distributeUnlockedCredit()</code></li>\n<li><code>_calculateUnrealizedDebt()</code></li>\n<li><code>_convertSharesToYieldTokens()</code></li>\n<li><code>donate()</code></li>\n</ul>\n<p>Furthermore, any <code>pendingCredit</code> amount of tokens are still in the contract will become permanently stuck.</p>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This case may arise under the follow steps\na) <code>deposit()</code> is called by a user then time passes to earn some yield\nb) <code>harvest()</code> is called by the keeper which calls <code>_distributeCredit()</code> and increases <code>pendingCredit</code>\nc) <code>withdraw()</code> is called by the user to withdraw all funds</p>\n<p>Since there is <code>pendingCredit</code> the following will have a non-zero balance for <code>unlockedCredit</code> however <code>yieldTokenParams.totalShares</code> is zero and thus we get a division by zero which reverts the entire transaction.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_distributeUnlockedCredit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yieldToken</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">YieldTokenParams</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yieldTokenParams</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_yieldTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">yieldToken</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">unlockedCredit</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_calculateUnlockedCredit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yieldToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">unlockedCredit</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">yieldTokenParams</span><span class=\"mtk1\">.</span><span class=\"mtk12\">accruedWeight</span><span class=\"mtk1\">     += </span><span class=\"mtk12\">unlockedCredit</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">FIXED_POINT_SCALAR</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">yieldTokenParams</span><span class=\"mtk1\">.</span><span class=\"mtk12\">totalShares</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">yieldTokenParams</span><span class=\"mtk1\">.</span><span class=\"mtk12\">distributedCredit</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">unlockedCredit</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Each of the other listed functions will reach the same issue by attempting to divide some numerator by the <code>totalShares</code> which is zero.</p>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider preventing <code>totalShares</code> from over becoming zero once it is set. That is enforce a user to leave at least 1 unit if they are the last user to withdraw.</p>\n<p>Another option is to transfer the first 1000 shares to a “burn” account (e.g. 0x000…01), when the first user deposits.</p>\n<p>Alternatively, when the last user withdraws, transfer all pending credit to this user and set the required variables to zero to replicate the state before any users have deposited.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/104#issuecomment-1133988067\">0xfoobar (Alchemix) confirmed, disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Disagree with severity because given the depth of distinct users using Alchemix, it is unlikely this scenario would occur.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/104#issuecomment-1146196263\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This is an interesting issue. At the moment, it sits somewhere between medium and high risk, so I will need to think about this more before coming to a decision.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/104#issuecomment-1150102500\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>After further thought, I think this does not fit the criteria of high severity for the following reasons:</p>\n<ul>\n<li>The protocol can be DoS’d on new deployments via front-running, but it does not lead to lost funds by users. It’d only require a new deployment by the Alchemist team.</li>\n<li>If the protocol was to migrate to a new version of the protocol, a mass withdrawal event could lead to locked <code>pendingCredit</code>. However, because rewards are harvested by a keeper, I believe this to be unlikely as migrations will most certainly be coordinated by the protocol and its keepers. As such, users will be aware that they would miss out on rewards if the keeper does not harvest rewards prior to the migration.</li>\n<li>Rewards are regularly harvested by the keeper, and as such, the value at risk is somewhat negligible.</li>\n</ul>\n<p>For these reasons, I believe medium severity to be justified.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-17-debt-can-be-repaid-with-a-depegged-underlyingtoken-which-can-be-exploited-by-arbitrageurs-and-drives-the-market-price-of-altoken-to-match-the-worst-depegged-underlyingtoken\" style=\"position:relative;\"><a href=\"#m-17-debt-can-be-repaid-with-a-depegged-underlyingtoken-which-can-be-exploited-by-arbitrageurs-and-drives-the-market-price-of-altoken-to-match-the-worst-depegged-underlyingtoken\" aria-label=\"m 17 debt can be repaid with a depegged underlyingtoken which can be exploited by arbitrageurs and drives the market price of altoken to match the worst depegged underlyingtoken permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/161\">[M-17] Debt can be repaid with a depegged underlyingToken, which can be exploited by arbitrageurs and drives the market price of alToken to match the worst depegged underlyingToken</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemistV2.sol#L1679-L1682\">AlchemistV2.sol#L1679-L1682</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_normalizeUnderlyingTokensToDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">_underlyingTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">].</span><span class=\"mtk12\">conversionFactor</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemistV2.sol#L743-L786\">AlchemistV2.sol#L743-L786</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">repay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">lock</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">credit</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_normalizeUnderlyingTokensToDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlyingToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">actualAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Update the recipient&#39;s debt.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_updateDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, -</span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toInt256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">credit</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span></code></pre>\n<p>When repaying the debt with an <code>underlyingToken</code>, the amount in terms of the <code>underlyingToken</code> (adjusted for decimals) will always be taken in a 1:1 ratio/price for the subtrahend of the debt.</p>\n<p>We believe this design is flawed and be exploited by arbitrageurs and eventually drives the market price of alToken to match the worst depegged underlyingToken.</p>\n<p>Because if <code>alToken</code> is trading at a higher price against the depegged underlyingToken, the arbitrageur can always mint alToken and market sell for more depegged underlyingToken and repay the debt.</p>\n<h3 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Given:</p>\n<ul>\n<li>alUSD is trading at $1</li>\n<li>minimumCollateralization: 4/3</li>\n</ul>\n<h6 id=\"when-usdt-is-slightly-depegged-and-trading-at-09\" style=\"position:relative;\"><a href=\"#when-usdt-is-slightly-depegged-and-trading-at-09\" aria-label=\"when usdt is slightly depegged and trading at 09 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>When USDT is slightly depegged, and trading at <code>$0.9</code>:</h6>\n<p>An arbitrageur can:</p>\n<ol>\n<li>Deposit <code>100M USDC</code> as collateral and mint <code>75M alUSD</code> (100*0.75);</li>\n<li>Market buy <code>75M USDT</code> with <code>67.5M alUSD</code> (75*0.9) and repay the debt;</li>\n<li>Withdraw the <code>100M USDC</code> collateral;</li>\n<li>Dump the remaining <code>7.5M alUSD</code> (75-67.5) for profit.</li>\n</ol>\n<p>This can be repeated until the market price of alUSD drops to <code>$0.9</code>, the same price as USDT.</p>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Consider updating the <code>repay()</code> function and change to market buy using the underlyingToken to alToken and then <code>burn()</code> the alToken to reduce debt.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/161#issuecomment-1133953254\">0xfoobar (Alchemix) acknowledged, disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>This is a core design choice underlying the Alchemix system. Like-kind collateral and debt assumes that assets will hold their relationship. The onus lies on governance to choose safe collateral assets.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/161#issuecomment-1150112042\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I agree with what was raised by the warden but disagree with the associated severity. Because user’s assets are tied to the underlying collateral, it makes sense that the a depegged token would be reflected in the price of <code>alToken</code>. As a result, arbitrageurs are free to profit off this by driving the price of <code>alToken</code> down to its true value. </p>\n<p>I consider this to be medium risk because of an unlikely assumption made when considering the likelihood of a depeg event. Assets are not at direct risk, but value can be leaked under certain assumptions.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 46 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/228\">report highlighted below</a> by <strong>IllIllI</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/193\">GimelSec</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/103\">AuditsAreUS</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/86\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/119\">0xsomeone</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/201\">0xDjango</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/177\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/223\">TerrierLover</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/126\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/221\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/136\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/94\">robee</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/62\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/146\">shenwilly</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/165\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/46\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/70\">jayjonah8</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/50\">MaratCerby</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/215\">BowTiedWardens</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/218\">horsefacts</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/90\">sikorico</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/168\">tintin</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/142\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/211\">cryptphi</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/130\">ellahi</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/84\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/179\">Picodes</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/204\">throttle</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/116\">BouSalman</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/96\">0x4non</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/92\">bobirichman</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/167\">Cityscape</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/133\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/82\">mics</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/173\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/138\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/57\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/154\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/125\">0xkatana</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/65\">hake</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/226\">Hawkeye</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/212\">JC</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/200\">kebabsec</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/152\">kenta</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/101\">samruna</a>, and <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/175\">Waze</a>.</em></p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<h3 id=\"low-risk-issues\" style=\"position:relative;\"><a href=\"#low-risk-issues\" aria-label=\"low risk issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Issues</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th>Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td align=\"left\">Latent funds can be stolen</td>\n<td>1</td>\n</tr>\n<tr>\n<td>2</td>\n<td align=\"left\">Low level calls don’t check for contract existence</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3</td>\n<td align=\"left\">Set sane maximums for input parameters</td>\n<td>2</td>\n</tr>\n<tr>\n<td>4</td>\n<td align=\"left\">Behavior described by comment is incomplete</td>\n<td>1</td>\n</tr>\n<tr>\n<td>5</td>\n<td align=\"left\">Unsafe use of <code>transfer()</code>/<code>transferFrom()</code> with <code>IERC20</code></td>\n<td>4</td>\n</tr>\n<tr>\n<td>6</td>\n<td align=\"left\">Return values of <code>transfer()</code>/<code>transferFrom()</code> not checked</td>\n<td>2</td>\n</tr>\n<tr>\n<td>7</td>\n<td align=\"left\">Unused/empty <code>receive()</code> function</td>\n<td>2</td>\n</tr>\n<tr>\n<td>8</td>\n<td align=\"left\"><code>safeApprove()</code> is deprecated</td>\n<td>32</td>\n</tr>\n<tr>\n<td>9</td>\n<td align=\"left\">Missing checks for <code>address(0x0)</code> when assigning values to <code>address</code> state variables</td>\n<td>24</td>\n</tr>\n<tr>\n<td>10</td>\n<td align=\"left\"><code>abi.encodePacked()</code> should not be used with dynamic types when passing the result to a hash function such as <code>keccak256()</code></td>\n<td>1</td>\n</tr>\n<tr>\n<td>11</td>\n<td align=\"left\">Upgradeable contract is missing a <code>__gap[50]</code> storage variable to allow for new storage variables in later versions</td>\n<td>3</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 73 instances over 11 issues</p>\n<h3 id=\"non-critical-issues\" style=\"position:relative;\"><a href=\"#non-critical-issues\" aria-label=\"non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-critical Issues</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th>Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td align=\"left\">Adding a <code>return</code> statement when the function defines a named return variable, is redundant</td>\n<td>4</td>\n</tr>\n<tr>\n<td>2</td>\n<td align=\"left\"><code>override</code> function arguments that are unused should have the variable name removed or commented out to avoid compiler warnings</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3</td>\n<td align=\"left\"><code>public</code> functions not called by the contract should be declared <code>external</code> instead</td>\n<td>12</td>\n</tr>\n<tr>\n<td>4</td>\n<td align=\"left\"><code>2**&#x3C;n> - 1</code> should be re-written as <code>type(uint&#x3C;n>).max</code></td>\n<td>1</td>\n</tr>\n<tr>\n<td>5</td>\n<td align=\"left\"><code>constant</code>s should be defined rather than using magic numbers</td>\n<td>20</td>\n</tr>\n<tr>\n<td>6</td>\n<td align=\"left\">Redundant cast</td>\n<td>4</td>\n</tr>\n<tr>\n<td>7</td>\n<td align=\"left\">Numeric values having to do with time should use time units for readability</td>\n<td>1</td>\n</tr>\n<tr>\n<td>8</td>\n<td align=\"left\">Missing event for critical parameter change</td>\n<td>3</td>\n</tr>\n<tr>\n<td>9</td>\n<td align=\"left\">Use a more recent version of solidity</td>\n<td>12</td>\n</tr>\n<tr>\n<td>10</td>\n<td align=\"left\">Use a more recent version of solidity</td>\n<td>1</td>\n</tr>\n<tr>\n<td>11</td>\n<td align=\"left\">Use scientific notation (e.g. <code>1e18</code>) rather than exponentiation (e.g. <code>10**18</code>)</td>\n<td>2</td>\n</tr>\n<tr>\n<td>12</td>\n<td align=\"left\">Inconsistent spacing in comments</td>\n<td>11</td>\n</tr>\n<tr>\n<td>13</td>\n<td align=\"left\">Non-library/interface files should use fixed compiler versions, not floating ones</td>\n<td>16</td>\n</tr>\n<tr>\n<td>14</td>\n<td align=\"left\">Typos</td>\n<td>12</td>\n</tr>\n<tr>\n<td>15</td>\n<td align=\"left\">File does not contain an SPDX Identifier</td>\n<td>32</td>\n</tr>\n<tr>\n<td>16</td>\n<td align=\"left\">File is missing NatSpec</td>\n<td>27</td>\n</tr>\n<tr>\n<td>17</td>\n<td align=\"left\">NatSpec is incomplete</td>\n<td>17</td>\n</tr>\n<tr>\n<td>18</td>\n<td align=\"left\">Event is missing <code>indexed</code> fields</td>\n<td>111</td>\n</tr>\n<tr>\n<td>19</td>\n<td align=\"left\">Use allowlist/denylist rather than blacklist/whitelist</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 288 instances over 19 issues</p>\n<h2 id=\"l-01-latent-funds-can-be-stolen\" style=\"position:relative;\"><a href=\"#l-01-latent-funds-can-be-stolen\" aria-label=\"l 01 latent funds can be stolen permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Latent funds can be stolen</h2>\n<p>If someone manages, through either a bug or a mistake (self-destructing and sending funds to the contract), another user can claim the funds as their own. Measure the balance before and after, and use the difference, rather than measuring the total balance of the contract</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">-</span><span class=\"mtk12\">full</span><span class=\"mtk1\">/</span><span class=\"mtk12\">WETHGateway</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">70</span><span class=\"mtk1\">           </span><span class=\"mtk11\">IAlchemistV2</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alchemist</span><span class=\"mtk1\">).</span><span class=\"mtk11\">withdrawUnderlyingFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">yieldToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">minimumAmountOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">71</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">72</span><span class=\"mtk1\">           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">WETH</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">73</span><span class=\"mtk1\">           </span><span class=\"mtk12\">WETH</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">74</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">75</span><span class=\"mtk1\">:          (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">.</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">}(</span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/WETHGateway.sol#L70-L75\">https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/WETHGateway.sol#L70-L75</a></p>\n<h2 id=\"l-02-low-level-calls-dont-check-for-contract-existence\" style=\"position:relative;\"><a href=\"#l-02-low-level-calls-dont-check-for-contract-existence\" aria-label=\"l 02 low level calls dont check for contract existence permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Low level calls don’t check for contract existence</h2>\n<p>Low level calls return success if called on a destructed contract. See OpenZeppelin’s Address.so which checks address.code.length</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">-</span><span class=\"mtk12\">full</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TokenUtils</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">65</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">66</span><span class=\"mtk1\">           (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">call</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">67</span><span class=\"mtk1\">               </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC20Minimal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">transfer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">68</span><span class=\"mtk1\">:          );</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/libraries/TokenUtils.sol#L65-L68\">https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/libraries/TokenUtils.sol#L65-L68</a></p>\n<h2 id=\"l-03-set-sane-maximums-for-input-parameters\" style=\"position:relative;\"><a href=\"#l-03-set-sane-maximums-for-input-parameters\" aria-label=\"l 03 set sane maximums for input parameters permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Set sane maximums for input parameters</h2>\n<p>There should be an upper limit to reasonable fees</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<p><strong>For further details on this (and the warden’s other findings with multiple instances), please see their <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/228\">full report</a></strong></p>\n<h2 id=\"l-04-behavior-described-by-comment-is-incomplete\" style=\"position:relative;\"><a href=\"#l-04-behavior-described-by-comment-is-incomplete\" aria-label=\"l 04 behavior described by comment is incomplete permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Behavior described by comment is incomplete</h2>\n<p>The event is not emitted when the fee is updated the first time (in the constructor)</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">-</span><span class=\"mtk12\">full</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AlchemicTokenV2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">50</span><span class=\"mtk1\">     </span><span class=\"mtk3\">/// @notice An event which is emitted when the flash mint fee is updated.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">51</span><span class=\"mtk1\">     </span><span class=\"mtk3\">///</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">52</span><span class=\"mtk1\">     </span><span class=\"mtk3\">/// @param fee The new flash mint fee.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">53</span><span class=\"mtk1\">     </span><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SetFlashMintFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">54</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">55</span><span class=\"mtk1\">     </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_symbol</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_flashFee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_symbol</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">56</span><span class=\"mtk1\">       </span><span class=\"mtk11\">_setupRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ADMIN_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">57</span><span class=\"mtk1\">       </span><span class=\"mtk11\">_setupRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">SENTINEL_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">58</span><span class=\"mtk1\">       </span><span class=\"mtk11\">_setRoleAdmin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">SENTINEL_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ADMIN_ROLE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">       </span><span class=\"mtk11\">_setRoleAdmin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ADMIN_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ADMIN_ROLE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">60</span><span class=\"mtk1\">       </span><span class=\"mtk12\">flashMintFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_flashFee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">61</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemicTokenV2.sol#L50-L61\">https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemicTokenV2.sol#L50-L61</a></p>\n<h2 id=\"l-05-unsafe-use-of-transfertransferfrom-with-ierc20\" style=\"position:relative;\"><a href=\"#l-05-unsafe-use-of-transfertransferfrom-with-ierc20\" aria-label=\"l 05 unsafe use of transfertransferfrom with ierc20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] Unsafe use of <code>transfer()</code>/<code>transferFrom()</code> with <code>IERC20</code></h2>\n<p>Some tokens do not implement the ERC20 standard properly but are still accepted by most code that accepts ERC20 tokens.  For example Tether (USDT)‘s <code>transfer()</code> and <code>transferFrom()</code> functions do not return booleans as the specification requires, and instead have no return value. When these sorts of tokens are cast to <code>IERC20</code>, their function signatures do not match and therefore the calls made, revert. Use OpenZeppelin’s <code>SafeERC20</code>’s <code>safeTransfer()</code>/<code>safeTransferFrom()</code> instead</p>\n<p><em>There are 4 instances of this issue.</em></p>\n<h2 id=\"l-06-return-values-of-transfertransferfrom-not-checked\" style=\"position:relative;\"><a href=\"#l-06-return-values-of-transfertransferfrom-not-checked\" aria-label=\"l 06 return values of transfertransferfrom not checked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-06] Return values of <code>transfer()</code>/<code>transferFrom()</code> not checked</h2>\n<p>Not all <code>IERC20</code> implementations <code>revert()</code> when there’s a failure in <code>transfer()</code>/<code>transferFrom()</code>. The function signature has a <code>boolean</code> return value and they indicate errors that way instead. By not checking the return value, operations that should have marked as failed, may potentially go through without actually making a payment</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"l-07-unusedempty-receive-function\" style=\"position:relative;\"><a href=\"#l-07-unusedempty-receive-function\" aria-label=\"l 07 unusedempty receive function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-07] Unused/empty <code>receive()</code> function</h2>\n<p>If the intention is for the Ether to be used, the function should call another function, otherwise it should revert</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"l-08-safeapprove-is-deprecated\" style=\"position:relative;\"><a href=\"#l-08-safeapprove-is-deprecated\" aria-label=\"l 08 safeapprove is deprecated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-08] <code>safeApprove()</code> is deprecated</h2>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/bfff03c0d2a59bcd8e2ead1da9aed9edf0080d05/contracts/token/ERC20/utils/SafeERC20.sol#L38-L45\">Deprecated</a> in favor of <code>safeIncreaseAllowance()</code> and <code>safeDecreaseAllowance()</code>. If only setting the initial allowance to the value that means infinite, <code>safeIncreaseAllowance()</code> can be used instead</p>\n<p><em>There are 32 instances of this issue.</em></p>\n<h2 id=\"l-09-missing-checks-for-address0x0-when-assigning-values-to-address-state-variables\" style=\"position:relative;\"><a href=\"#l-09-missing-checks-for-address0x0-when-assigning-values-to-address-state-variables\" aria-label=\"l 09 missing checks for address0x0 when assigning values to address state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-09] Missing checks for <code>address(0x0)</code> when assigning values to <code>address</code> state variables</h2>\n<p><em>There are 24 instances of this issue.</em></p>\n<h2 id=\"l-10-abiencodepacked-should-not-be-used-with-dynamic-types-when-passing-the-result-to-a-hash-function-such-as-keccak256\" style=\"position:relative;\"><a href=\"#l-10-abiencodepacked-should-not-be-used-with-dynamic-types-when-passing-the-result-to-a-hash-function-such-as-keccak256\" aria-label=\"l 10 abiencodepacked should not be used with dynamic types when passing the result to a hash function such as keccak256 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-10] <code>abi.encodePacked()</code> should not be used with dynamic types when passing the result to a hash function such as <code>keccak256()</code></h2>\n<p>Use <code>abi.encode()</code> instead which will pad items to 32 bytes, which will <a href=\"https://docs.soliditylang.org/en/v0.8.13/abi-spec.html#non-standard-packed-mode\">prevent hash collisions</a> (e.g. <code>abi.encodePacked(0x123,0x456)</code> => <code>0x123456</code> => <code>abi.encodePacked(0x1,0x23456)</code>, but <code>abi.encode(0x123,0x456)</code> => <code>0x0...1230...456</code>). “Unless there is a compelling reason, <code>abi.encode</code> should be preferred”. If there is only one argument to <code>abi.encodePacked()</code> it can often be cast to <code>bytes()</code> or <code>bytes32()</code> <a href=\"https://ethereum.stackexchange.com/questions/30912/how-to-compare-strings-in-solidity#answer-82739\">instead</a>.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">-</span><span class=\"mtk12\">full</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RocketPool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">14</span><span class=\"mtk1\">:               </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;contract.address&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;rocketTokenRETH&quot;</span><span class=\"mtk1\">))</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/libraries/RocketPool.sol#L14\">https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/libraries/RocketPool.sol#L14</a></p>\n<h2 id=\"l-11-upgradeable-contract-is-missing-a-__gap50-storage-variable-to-allow-for-new-storage-variables-in-later-versions\" style=\"position:relative;\"><a href=\"#l-11-upgradeable-contract-is-missing-a-__gap50-storage-variable-to-allow-for-new-storage-variables-in-later-versions\" aria-label=\"l 11 upgradeable contract is missing a __gap50 storage variable to allow for new storage variables in later versions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-11] Upgradeable contract is missing a <code>__gap[50]</code> storage variable to allow for new storage variables in later versions</h2>\n<p>See <a href=\"https://docs.openzeppelin.com/contracts/4.x/upgradeable#storage_gaps\">this</a> link for a description of this storage variable. While some contracts may not currently be sub-classed, adding the variable now protects against forgetting to add it in the future.</p>\n<p><em>There are 3 instances of this issue.</em></p>\n<h2 id=\"n-01-adding-a-return-statement-when-the-function-defines-a-named-return-variable-is-redundant\" style=\"position:relative;\"><a href=\"#n-01-adding-a-return-statement-when-the-function-defines-a-named-return-variable-is-redundant\" aria-label=\"n 01 adding a return statement when the function defines a named return variable is redundant permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Adding a <code>return</code> statement when the function defines a named return variable, is redundant</h2>\n<p><em>There are 4 instances of this issue.</em></p>\n<h2 id=\"n-02-override-function-arguments-that-are-unused-should-have-the-variable-name-removed-or-commented-out-to-avoid-compiler-warnings\" style=\"position:relative;\"><a href=\"#n-02-override-function-arguments-that-are-unused-should-have-the-variable-name-removed-or-commented-out-to-avoid-compiler-warnings\" aria-label=\"n 02 override function arguments that are unused should have the variable name removed or commented out to avoid compiler warnings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] <code>override</code> function arguments that are unused should have the variable name removed or commented out to avoid compiler warnings</h2>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">-</span><span class=\"mtk12\">full</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AutoleverageCurveMetapool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">20</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_maybeConvertCurveOutput</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/AutoleverageCurveMetapool.sol#L20\">https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/AutoleverageCurveMetapool.sol#L20</a></p>\n<h2 id=\"n-03-public-functions-not-called-by-the-contract-should-be-declared-external-instead\" style=\"position:relative;\"><a href=\"#n-03-public-functions-not-called-by-the-contract-should-be-declared-external-instead\" aria-label=\"n 03 public functions not called by the contract should be declared external instead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] <code>public</code> functions not called by the contract should be declared <code>external</code> instead</h2>\n<p>Contracts <a href=\"https://docs.soliditylang.org/en/latest/contracts.html#function-overriding\">are allowed</a> to override their parents’ functions and change the visibility from <code>external</code> to <code>public</code>.</p>\n<p><em>There are 12 instances of this issue.</em></p>\n<h2 id=\"n-04-2n---1-should-be-re-written-as-typeuintnmax\" style=\"position:relative;\"><a href=\"#n-04-2n---1-should-be-re-written-as-typeuintnmax\" aria-label=\"n 04 2n   1 should be re written as typeuintnmax permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] <code>2**&#x3C;n> - 1</code> should be re-written as <code>type(uint&#x3C;n>).max</code></h2>\n<p>Earlier versions of solidity can use <code>uint&#x3C;n>(-1)</code> instead. Expressions not including the <code>- 1</code> can often be re-written to accomodate the change (e.g. by using a <code>></code> rather than a <code>>=</code>, which will also save some gas)</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">-</span><span class=\"mtk12\">full</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">13</span><span class=\"mtk1\">:       </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">y</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk7\">2</span><span class=\"mtk1\">**</span><span class=\"mtk7\">255</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/libraries/SafeCast.sol#L13\">https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/libraries/SafeCast.sol#L13</a></p>\n<h2 id=\"n-05-constants-should-be-defined-rather-than-using-magic-numbers\" style=\"position:relative;\"><a href=\"#n-05-constants-should-be-defined-rather-than-using-magic-numbers\" aria-label=\"n 05 constants should be defined rather than using magic numbers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-05] <code>constant</code>s should be defined rather than using magic numbers</h2>\n<p><em>There are 20 instances of this issue.</em></p>\n<h2 id=\"n-06-redundant-cast\" style=\"position:relative;\"><a href=\"#n-06-redundant-cast\" aria-label=\"n 06 redundant cast permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-06] Redundant cast</h2>\n<p>The type of the variable is the same as the type to which the variable is being cast</p>\n<p><em>There are 4 instances of this issue.</em></p>\n<h2 id=\"n-07-numeric-values-having-to-do-with-time-should-use-time-units-for-readability\" style=\"position:relative;\"><a href=\"#n-07-numeric-values-having-to-do-with-time-should-use-time-units-for-readability\" aria-label=\"n 07 numeric values having to do with time should use time units for readability permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-07] Numeric values having to do with time should use time units for readability</h2>\n<p>There are <a href=\"https://docs.soliditylang.org/en/latest/units-and-global-variables.html#time-units\">units</a> for seconds, minutes, hours, days, and weeks</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">-</span><span class=\"mtk12\">full</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Limiters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">12</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_COOLDOWN_BLOCKS</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">7200</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/libraries/Limiters.sol#L12\">https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/libraries/Limiters.sol#L12</a></p>\n<h2 id=\"n-08-missing-event-for-critical-parameter-change\" style=\"position:relative;\"><a href=\"#n-08-missing-event-for-critical-parameter-change\" aria-label=\"n 08 missing event for critical parameter change permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-08] Missing event for critical parameter change</h2>\n<p><em>There are 3 instances of this issue.</em></p>\n<h2 id=\"n-09-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#n-09-use-a-more-recent-version-of-solidity\" aria-label=\"n 09 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-09] Use a more recent version of solidity</h2>\n<p>Use a solidity version of at least 0.8.13 to get the ability to use <code>using for</code> with a list of free functions</p>\n<p><em>There are 12 instances of this issue.</em></p>\n<h2 id=\"n-10-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#n-10-use-a-more-recent-version-of-solidity\" aria-label=\"n 10 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-10] Use a more recent version of solidity</h2>\n<p>Use a solidity version of at least 0.8.4 to get <code>bytes.concat()</code> instead of <code>abi.encodePacked(&#x3C;bytes>,&#x3C;bytes>)</code>\nUse a solidity version of at least 0.8.12 to get <code>string.concat()</code> instead of <code>abi.encodePacked(&#x3C;str>,&#x3C;str>)</code></p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">-</span><span class=\"mtk12\">full</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RocketPool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.5</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/libraries/RocketPool.sol#L1\">https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/libraries/RocketPool.sol#L1</a></p>\n<h2 id=\"n-11-use-scientific-notation-eg-1e18-rather-than-exponentiation-eg-1018\" style=\"position:relative;\"><a href=\"#n-11-use-scientific-notation-eg-1e18-rather-than-exponentiation-eg-1018\" aria-label=\"n 11 use scientific notation eg 1e18 rather than exponentiation eg 1018 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-11] Use scientific notation (e.g. <code>1e18</code>) rather than exponentiation (e.g. <code>10**18</code>)</h2>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"n-12-inconsistent-spacing-in-comments\" style=\"position:relative;\"><a href=\"#n-12-inconsistent-spacing-in-comments\" aria-label=\"n 12 inconsistent spacing in comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-12] Inconsistent spacing in comments</h2>\n<p>Some lines use <code>// x</code> and some use <code>//x</code>. The instances below point out the usages that don’t follow the majority, within each file</p>\n<p><em>There are 11 instances of this issue.</em></p>\n<h2 id=\"n-13-non-libraryinterface-files-should-use-fixed-compiler-versions-not-floating-ones\" style=\"position:relative;\"><a href=\"#n-13-non-libraryinterface-files-should-use-fixed-compiler-versions-not-floating-ones\" aria-label=\"n 13 non libraryinterface files should use fixed compiler versions not floating ones permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-13] Non-library/interface files should use fixed compiler versions, not floating ones</h2>\n<p><em>There are 16 instances of this issue.</em></p>\n<h2 id=\"n-14-typos\" style=\"position:relative;\"><a href=\"#n-14-typos\" aria-label=\"n 14 typos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-14] Typos</h2>\n<p><em>There are 12 instances of this issue.</em></p>\n<h2 id=\"n-15-file-does-not-contain-an-spdx-identifier\" style=\"position:relative;\"><a href=\"#n-15-file-does-not-contain-an-spdx-identifier\" aria-label=\"n 15 file does not contain an spdx identifier permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-15] File does not contain an SPDX Identifier</h2>\n<p><em>There are 32 instances of this issue.</em></p>\n<h2 id=\"n-16-file-is-missing-natspec\" style=\"position:relative;\"><a href=\"#n-16-file-is-missing-natspec\" aria-label=\"n 16 file is missing natspec permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-16] File is missing NatSpec</h2>\n<p><em>There are 27 instances of this issue.</em></p>\n<h2 id=\"n-17-natspec-is-incomplete\" style=\"position:relative;\"><a href=\"#n-17-natspec-is-incomplete\" aria-label=\"n 17 natspec is incomplete permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-17] NatSpec is incomplete</h2>\n<p><em>There are 17 instances of this issue.</em></p>\n<h2 id=\"n-18-event-is-missing-indexed-fields\" style=\"position:relative;\"><a href=\"#n-18-event-is-missing-indexed-fields\" aria-label=\"n 18 event is missing indexed fields permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-18] Event is missing <code>indexed</code> fields</h2>\n<p>Each <code>event</code> should use three <code>indexed</code> fields if there are three or more fields</p>\n<p><em>There are 111 instances of this issue.</em></p>\n<h2 id=\"n-19-use-allowlistdenylist-rather-than-blacklistwhitelist\" style=\"position:relative;\"><a href=\"#n-19-use-allowlistdenylist-rather-than-blacklistwhitelist\" aria-label=\"n 19 use allowlistdenylist rather than blacklistwhitelist permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-19] Use allowlist/denylist rather than blacklist/whitelist</h2>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">-</span><span class=\"mtk12\">full</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AlchemicTokenV1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">110</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setBlacklist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlySentinel</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemicTokenV1.sol#L110\">https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemicTokenV1.sol#L110</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/228#issuecomment-1140785384\">0xfoobar (Alchemix) commented</a>:</strong></p>\n<blockquote>\n<p>Incredibly comprehensive, great writeup</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 46 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/28\">report highlighted below</a> by <strong>IllIllI</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/137\">BowTiedWardens</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/171\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/124\">0xkatana</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/32\">AlleyCat</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/81\">mics</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/164\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/95\">0x4non</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/56\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/139\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/220\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/93\">robee</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/100\">samruna</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/214\">sashik_eth</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/224\">TerrierLover</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/216\">_Adam</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/85\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/148\">0xf15ers</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/118\">0xsomeone</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/143\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/129\">ellahi</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/153\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/195\">GimelSec</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/172\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/83\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/145\">Tomio</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/202\">0xDjango</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/45\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/66\">hake</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/169\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/225\">Hawkeye</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/110\">ignacio</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/49\">MaratCerby</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/89\">sikorico</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/174\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/197\">0v3rf10w</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/188\">Fitraldys</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/219\">horsefacts</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/151\">kenta</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/176\">Randyyy</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/205\">throttle</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/196\">UnusualTurtle</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/105\">augustg</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/91\">bobirichman</a>, <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/170\">Cityscape</a>, and <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/213\">JC</a>.</em></p>\n<h2 id=\"g-01-remove-or-replace-unused-state-variables\" style=\"position:relative;\"><a href=\"#g-01-remove-or-replace-unused-state-variables\" aria-label=\"g 01 remove or replace unused state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Remove or replace unused state variables</h2>\n<p>Saves a storage slot. If the variable is assigned a non-zero value, saves Gsset (20000 gas). If it’s assigned a zero value, saves Gsreset (2900 gas). If the variable remains unassigned, there is no gas savings. If the state variable is overriding an interface’s public function, mark the variable as <code>constant</code> or <code>immutable</code> so that it does not use a storage slot, and manually add a getter function</p>\n<p><strong>For further details on this (and the warden’s other gas optimizations), please see their <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/28\">full report</a>.</strong></p>\n<h2 id=\"g-02-multiple-address-mappings-can-be-combined-into-a-single-mapping-of-an-address-to-a-struct-where-appropriate\" style=\"position:relative;\"><a href=\"#g-02-multiple-address-mappings-can-be-combined-into-a-single-mapping-of-an-address-to-a-struct-where-appropriate\" aria-label=\"g 02 multiple address mappings can be combined into a single mapping of an address to a struct where appropriate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Multiple <code>address</code> mappings can be combined into a single <code>mapping</code> of an <code>address</code> to a <code>struct</code>, where appropriate</h2>\n<p>Saves a storage slot for the mapping. Depending on the circumstances and sizes of types, can avoid a Gsset (20000 gas) per mapping combined. Reads and subsequent writes can also be cheaper when a function requires both values and they both fit in the same storage slot</p>\n<h2 id=\"g-03-state-variables-only-set-in-the-constructor-should-be-declared-immutable\" style=\"position:relative;\"><a href=\"#g-03-state-variables-only-set-in-the-constructor-should-be-declared-immutable\" aria-label=\"g 03 state variables only set in the constructor should be declared immutable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] State variables only set in the constructor should be declared <code>immutable</code></h2>\n<p>Avoids a Gsset (20000 gas) in the constructor, and replaces each Gwarmacces (100 gas) with a <code>PUSH32</code> (3 gas). If getters are still desired, ’_’ can be added to the variable name and the getter can be added manually</p>\n<h2 id=\"g-04-structs-can-be-packed-into-fewer-storage-slots\" style=\"position:relative;\"><a href=\"#g-04-structs-can-be-packed-into-fewer-storage-slots\" aria-label=\"g 04 structs can be packed into fewer storage slots permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Structs can be packed into fewer storage slots</h2>\n<p>Each slot saved can avoid an extra Gsset (20000 gas) for the first setting of the struct. Subsequent reads as well as writes have smaller gas savings</p>\n<h2 id=\"g-05-using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\" style=\"position:relative;\"><a href=\"#g-05-using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\" aria-label=\"g 05 using calldata instead of memory for read only arguments in external functions saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</h2>\n<p>When a function with a <code>memory</code> array is called externally, the <code>abi.decode()</code> step has to use a for-loop to copy each index of the <code>calldata</code> to the <code>memory</code> index. Each iteration of this for-loop costs at least 60 gas (i.e. <code>60 * &#x3C;mem_array>.length</code>). Using <code>calldata</code> directly, obliviates the need for such a loop in the contract code and runtime execution. Structs have the same overhead as an array of length one</p>\n<h2 id=\"g-06-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" style=\"position:relative;\"><a href=\"#g-06-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" aria-label=\"g 06 state variables should be cached in stack variables rather than re reading them from storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] State variables should be cached in stack variables rather than re-reading them from storage</h2>\n<p>The instances (outlined in the warden’s <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/228\">full report</a>) point to the second+ access of a state variable within a function. Caching will replace each Gwarmaccess (100 gas) with a much cheaper stack read.\nLess obvious fixes/optimizations include having local storage variables of mappings within state variable mappings or mappings within state variable structs, having local storage variables of structs within mappings, having local memory caches of state variable structs, or having local caches of state variable contracts/addresses.</p>\n<h2 id=\"g-07-the-result-of-external-function-calls-should-be-cached-rather-than-re-calling-the-function\" style=\"position:relative;\"><a href=\"#g-07-the-result-of-external-function-calls-should-be-cached-rather-than-re-calling-the-function\" aria-label=\"g 07 the result of external function calls should be cached rather than re calling the function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] The result of external function calls should be cached rather than re-calling the function</h2>\n<p>The instances (outlined in the warden’s <a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/228\">full report</a>) point to the second+ call of the function within a single function</p>\n<h2 id=\"g-08-x--y-costs-more-gas-than-x--x--y-for-state-variables\" style=\"position:relative;\"><a href=\"#g-08-x--y-costs-more-gas-than-x--x--y-for-state-variables\" aria-label=\"g 08 x  y costs more gas than x  x  y for state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] <code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</h2>\n<h2 id=\"g-09-internal-functions-only-called-once-can-be-inlined-to-save-gas\" style=\"position:relative;\"><a href=\"#g-09-internal-functions-only-called-once-can-be-inlined-to-save-gas\" aria-label=\"g 09 internal functions only called once can be inlined to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] <code>internal</code> functions only called once can be inlined to save gas</h2>\n<p>Not inlining costs 20 to 40 gas because of two extra <code>JUMP</code> instructions and additional stack operations needed for function calls.</p>\n<h2 id=\"g-10-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\" style=\"position:relative;\"><a href=\"#g-10-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\" aria-label=\"g 10 arraylength should not be looked up in every loop of a for loop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10] <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</h2>\n<p>The overheads outlined below are <em>PER LOOP</em>, excluding the first loop</p>\n<ul>\n<li>storage arrays incur a Gwarmaccess (100 gas)</li>\n<li>memory arrays use <code>MLOAD</code> (3 gas)</li>\n<li>calldata arrays use <code>CALLDATALOAD</code> (3 gas)</li>\n</ul>\n<p>Caching the length changes each of these to a <code>DUP&#x3C;N></code> (3 gas), and gets rid of the extra <code>DUP&#x3C;N></code> needed to store the stack offset</p>\n<h2 id=\"g-11-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\" style=\"position:relative;\"><a href=\"#g-11-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\" aria-label=\"g 11 ii should be uncheckediuncheckedi when it is not possible for them to overflow as is the case when used in for  and while loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-11] <code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{++i}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</h2>\n<p>The <code>unchecked</code> keyword is new in solidity version 0.8.0, so this only applies to that version or higher, which these instances are. This saves 30-40 gas <a href=\"https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#the-increment-in-for-loop-post-condition-can-be-made-unchecked\"><em>PER LOOP</em></a></p>\n<h2 id=\"g-12-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\" style=\"position:relative;\"><a href=\"#g-12-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\" aria-label=\"g 12 requirerevert strings longer than 32 bytes cost extra gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-12] <code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</h2>\n<h2 id=\"g-13-private-functions-not-called-by-the-contract-should-be-removed-to-save-deployment-gas\" style=\"position:relative;\"><a href=\"#g-13-private-functions-not-called-by-the-contract-should-be-removed-to-save-deployment-gas\" aria-label=\"g 13 private functions not called by the contract should be removed to save deployment gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-13] <code>private</code> functions not called by the contract should be removed to save deployment gas</h2>\n<h2 id=\"g-14-not-using-the-named-return-variables-when-a-function-returns-wastes-deployment-gas\" style=\"position:relative;\"><a href=\"#g-14-not-using-the-named-return-variables-when-a-function-returns-wastes-deployment-gas\" aria-label=\"g 14 not using the named return variables when a function returns wastes deployment gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-14] Not using the named return variables when a function returns, wastes deployment gas</h2>\n<h2 id=\"g-15-remove-unused-local-variable\" style=\"position:relative;\"><a href=\"#g-15-remove-unused-local-variable\" aria-label=\"g 15 remove unused local variable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-15] Remove unused local variable</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">-</span><span class=\"mtk12\">full</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TransmuterBuffer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">515</span><span class=\"mtk1\">           (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">availableShares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastAccruedWeight</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">IAlchemistV2</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alchemist</span><span class=\"mtk1\">).</span><span class=\"mtk11\">positions</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">token</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/TransmuterBuffer.sol#L515\">https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/TransmuterBuffer.sol#L515</a></p>\n<h2 id=\"g-16-using-bools-for-storage-incurs-overhead\" style=\"position:relative;\"><a href=\"#g-16-using-bools-for-storage-incurs-overhead\" aria-label=\"g 16 using bools for storage incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-16] Using <code>bool</code>s for storage incurs overhead</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Booleans are more expensive than uint256 or any type that takes up a full</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// word because each write operation emits an extra SLOAD to first read the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// slot&#39;s contents, replace the bits taken up by the boolean, and then write</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// back. This is the compiler&#39;s defense against contract upgrades and</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// pointer aliasing, and it cannot be disabled.</span></span></span></code></pre>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27</a><br>\nUse <code>uint256(1)</code> and <code>uint256(2)</code> for true/false</p>\n<h2 id=\"g-17-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#g-17-use-a-more-recent-version-of-solidity\" aria-label=\"g 17 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-17] Use a more recent version of solidity</h2>\n<p>Use a solidity version of at least 0.8.0 to get overflow protection without <code>SafeMath</code>\nUse a solidity version of at least 0.8.2 to get compiler automatic inlining\nUse a solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads\nUse a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than <code>revert()/require()</code> strings\nUse a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value</p>\n<h2 id=\"g-18-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#g-18-use-a-more-recent-version-of-solidity\" aria-label=\"g 18 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-18] Use a more recent version of solidity</h2>\n<p>Use a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">-</span><span class=\"mtk12\">full</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">   </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">4</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/libraries/SafeERC20.sol#L2\">https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/libraries/SafeERC20.sol#L2</a></p>\n<h2 id=\"g-19-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#g-19-use-a-more-recent-version-of-solidity\" aria-label=\"g 19 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-19] Use a more recent version of solidity</h2>\n<p>Use a solidity version of at least 0.8.2 to get compiler automatic inlining\nUse a solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads\nUse a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than <code>revert()/require()</code> strings\nUse a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">-</span><span class=\"mtk12\">full</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">external</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IProxyAdmin</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">3</span><span class=\"mtk1\">   </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/interfaces/external/IProxyAdmin.sol#L3\">https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/interfaces/external/IProxyAdmin.sol#L3</a></p>\n<h2 id=\"g-20-it-costs-more-gas-to-initialize-variables-to-zero-than-to-let-the-default-of-zero-be-applied\" style=\"position:relative;\"><a href=\"#g-20-it-costs-more-gas-to-initialize-variables-to-zero-than-to-let-the-default-of-zero-be-applied\" aria-label=\"g 20 it costs more gas to initialize variables to zero than to let the default of zero be applied permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-20] It costs more gas to initialize variables to zero than to let the default of zero be applied</h2>\n<h2 id=\"g-21-internal-functions-not-called-by-the-contract-should-be-removed-to-save-deployment-gas\" style=\"position:relative;\"><a href=\"#g-21-internal-functions-not-called-by-the-contract-should-be-removed-to-save-deployment-gas\" aria-label=\"g 21 internal functions not called by the contract should be removed to save deployment gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-21] <code>internal</code> functions not called by the contract should be removed to save deployment gas</h2>\n<p>If the functions are required by an interface, the contract should inherit from that interface and use the <code>override</code> keyword</p>\n<h2 id=\"g-22-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" style=\"position:relative;\"><a href=\"#g-22-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" aria-label=\"g 22 i costs less gas than i especially when its used in for loops   ii   too permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-22] <code>++i</code> costs less gas than <code>++i</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</h2>\n<p>Saves 6 gas <em>PER LOOP</em></p>\n<h2 id=\"g-23-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" style=\"position:relative;\"><a href=\"#g-23-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" aria-label=\"g 23 usage of uintsints smaller than 32 bytes 256 bits incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-23] Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</h2>\n<blockquote>\n<p>When using elements that are smaller than 32 bytes, your contract’s gas usage may be higher. This is because the EVM operates on 32 bytes at a time. Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.</p>\n</blockquote>\n<h2 id=\"g-24-abiencode-is-less-efficient-than-abiencodepacked\" style=\"position:relative;\"><a href=\"#g-24-abiencode-is-less-efficient-than-abiencodepacked\" aria-label=\"g 24 abiencode is less efficient than abiencodepacked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-24] <code>abi.encode()</code> is less efficient than <code>abi.encodePacked()</code></h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">-</span><span class=\"mtk12\">full</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AutoleverageBase</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">102</span><span class=\"mtk1\">           </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">params</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk11\">Details</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">103</span><span class=\"mtk12\">               pool:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">104</span><span class=\"mtk12\">               poolInputIndex:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolInputIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">105</span><span class=\"mtk12\">               poolOutputIndex:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolOutputIndex</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">106</span><span class=\"mtk12\">               alchemist:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">alchemist</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">107</span><span class=\"mtk12\">               yieldToken:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yieldToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">108</span><span class=\"mtk12\">               recipient:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">109</span><span class=\"mtk12\">               targetDebt:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targetDebt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">110</span><span class=\"mtk1\">           }));</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/AutoleverageBase.sol#L102-L110\">https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/AutoleverageBase.sol#L102-L110</a></p>\n<h2 id=\"g-25-expressions-for-constant-values-such-as-a-call-to-keccak256-should-use-immutable-rather-than-constant\" style=\"position:relative;\"><a href=\"#g-25-expressions-for-constant-values-such-as-a-call-to-keccak256-should-use-immutable-rather-than-constant\" aria-label=\"g 25 expressions for constant values such as a call to keccak256 should use immutable rather than constant permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-25] Expressions for constant values such as a call to <code>keccak256()</code>, should use <code>immutable</code> rather than <code>constant</code></h2>\n<p>See <a href=\"https://github.com/ethereum/solidity/issues/9232\">this</a> issue for a detail description of the issue</p>\n<h2 id=\"g-26-using-private-rather-than-public-for-constants-saves-gas\" style=\"position:relative;\"><a href=\"#g-26-using-private-rather-than-public-for-constants-saves-gas\" aria-label=\"g 26 using private rather than public for constants saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-26] Using <code>private</code> rather than <code>public</code> for constants, saves gas</h2>\n<p>If needed, the value can be read from the verified contract source code. Savings are due to the compiler not having to create non-payable getter functions for deployment calldata, and not adding another entry to the method ID table</p>\n<h2 id=\"g-27-dont-use-safemath-once-the-solidity-version-is-080-or-greater\" style=\"position:relative;\"><a href=\"#g-27-dont-use-safemath-once-the-solidity-version-is-080-or-greater\" aria-label=\"g 27 dont use safemath once the solidity version is 080 or greater permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-27] Don’t use <code>SafeMath</code> once the solidity version is 0.8.0 or greater</h2>\n<p>Version 0.8.0 introduces internal overflow checks, so using <code>SafeMath</code> is redundant and adds overhead</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">-</span><span class=\"mtk12\">full</span><span class=\"mtk1\">/</span><span class=\"mtk12\">TransmuterBuffer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">7</span><span class=\"mtk1\">   </span><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/utils/math/SafeMath.sol&quot;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/TransmuterBuffer.sol#L7\">https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/TransmuterBuffer.sol#L7</a></p>\n<h2 id=\"g-28-duplicated-requirerevert-checks-should-be-refactored-to-a-modifier-or-function\" style=\"position:relative;\"><a href=\"#g-28-duplicated-requirerevert-checks-should-be-refactored-to-a-modifier-or-function\" aria-label=\"g 28 duplicated requirerevert checks should be refactored to a modifier or function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-28] Duplicated <code>require()</code>/<code>revert()</code> checks should be refactored to a modifier or function</h2>\n<p>Saves deployment costs</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">-</span><span class=\"mtk12\">full</span><span class=\"mtk1\">/</span><span class=\"mtk12\">gALCX</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">107</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Transfer failed&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/gALCX.sol#L107\">https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/gALCX.sol#L107</a></p>\n<h2 id=\"g-29-multiplicationdivision-by-two-should-use-bit-shifting\" style=\"position:relative;\"><a href=\"#g-29-multiplicationdivision-by-two-should-use-bit-shifting\" aria-label=\"g 29 multiplicationdivision by two should use bit shifting permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-29] Multiplication/division by two should use bit shifting</h2>\n<p><code>&#x3C;x> * 2</code> is equivalent to <code>&#x3C;x> &#x3C;&#x3C; 1</code> and <code>&#x3C;x> / 2</code> is the same as <code>&#x3C;x> >> 1</code>. The <code>MUL</code> and <code>DIV</code> opcodes cost 5 gas, whereas <code>SHL</code> and <code>SHR</code> only cost 3 gas</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">-</span><span class=\"mtk12\">full</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ThreePoolAssetManager</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">355</span><span class=\"mtk1\">               </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">examineBalance</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">v</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maximum</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">v</span><span class=\"mtk1\">.</span><span class=\"mtk12\">minimum</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">) == </span><span class=\"mtk12\">previousBalance</span><span class=\"mtk1\">) </span><span class=\"mtk15\">break</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/ThreePoolAssetManager.sol#L355\">https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/ThreePoolAssetManager.sol#L355</a></p>\n<h2 id=\"g-30-empty-blocks-should-be-removed-or-emit-something\" style=\"position:relative;\"><a href=\"#g-30-empty-blocks-should-be-removed-or-emit-something\" aria-label=\"g 30 empty blocks should be removed or emit something permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-30] Empty blocks should be removed or emit something</h2>\n<p>The code should be refactored such that they no longer exist, or the block should do something useful, such as emitting an event or reverting. If the block is an empty if-statement block to avoid doing subsequent checks in the else-if/else conditions, the else-if/else conditions should be nested under the negation of the if-statement, because they involve different classes of checks, which may lead to the introduction of errors when the code is later modified (<code>if(x){}else if(y){...}else{...}</code> => <code>if(!x){if(y){...}else{...}}</code>)</p>\n<h2 id=\"g-31-use-custom-errors-rather-than-revertrequire-strings-to-save-deployment-gas\" style=\"position:relative;\"><a href=\"#g-31-use-custom-errors-rather-than-revertrequire-strings-to-save-deployment-gas\" aria-label=\"g 31 use custom errors rather than revertrequire strings to save deployment gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-31] Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save deployment gas</h2>\n<p>Custom errors are available from solidity version 0.8.4. The instances below match or exceed that version</p>\n<h2 id=\"g-32-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" style=\"position:relative;\"><a href=\"#g-32-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" aria-label=\"g 32 functions guaranteed to revert when called by normal users can be marked payable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-32] Functions guaranteed to revert when called by normal users can be marked <code>payable</code></h2>\n<p>If a function modifier such as <code>onlyOwner</code> is used, the function will revert if a normal user tries to pay the function. Marking the function as <code>payable</code> will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are\n<code>CALLVALUE</code>(2),<code>DUP1</code>(3),<code>ISZERO</code>(3),<code>PUSH2</code>(3),<code>JUMPI</code>(10),<code>PUSH1</code>(3),<code>DUP1</code>(3),<code>REVERT</code>(0),<code>JUMPDEST</code>(1),<code>POP</code>(2), which costs an average of about 21 gas per call to the function, in addition to the extra deployment cost</p>\n<h2 id=\"g-33-public-functions-not-called-by-the-contract-should-be-declared-external-instead\" style=\"position:relative;\"><a href=\"#g-33-public-functions-not-called-by-the-contract-should-be-declared-external-instead\" aria-label=\"g 33 public functions not called by the contract should be declared external instead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-33] <code>public</code> functions not called by the contract should be declared <code>external</code> instead</h2>\n<p>Contracts <a href=\"https://docs.soliditylang.org/en/latest/contracts.html#function-overriding\">are allowed</a> to override their parents’ functions and change the visibility from <code>external</code> to <code>public</code> and can save gas by doing so.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-alchemix-findings/issues/28#issuecomment-1140784192\">0xfoobar (Alchemix) commented</a>:</strong></p>\n<blockquote>\n<p>Incredibly comprehensive, great work with the explanations and detailed line number links</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#medium-risk-findings-17\">Medium Risk Findings (17)</a></p>\n<ul>\n<li><a href=\"#m-01-alchemist-can-mint-altokens-above-their-assigned-ceiling-by-calling-lowerhasminted\">[M-01] Alchemist can mint <code>AlTokens</code> above their assigned ceiling by calling <code>lowerHasMinted()</code></a></li>\n<li><a href=\"#m-02-transmuterbuffersol-calls-depositunderlying-with-no-slippage-bounds-\">[M-02] TransmuterBuffer.sol calls depositUnderlying with no slippage bounds </a></li>\n<li><a href=\"#m-03-dos-in-wrap-and-unwrap\">[M-03] DoS in wrap and unwrap</a></li>\n<li><a href=\"#m-04-yearntokenadapter-allows-a-maximum-loss-of-100-when-withdrawing\">[M-04] YearnTokenAdapter allows a maximum loss of 100% when withdrawing</a></li>\n<li><a href=\"#m-05-no-storage-gap-for-upgradeable-contract-might-lead-to-storage-slot-collision\">[M-05] No Storage Gap for Upgradeable Contract Might Lead to Storage Slot Collision</a></li>\n<li><a href=\"#m-06-ethassetmanager-and-threepoolassetmanager-dont-control-meta-tokens-decimals\">[M-06] EthAssetManager and ThreePoolAssetManager don’t control Meta tokens decimals</a></li>\n<li><a href=\"#m-07-autoleveragebase-must-approve-0-first\">[M-07] AutoleverageBase: Must approve 0 first</a></li>\n<li><a href=\"#m-08-yearntokenadapters-wrap-can-become-stuck-as-it-uses-one-step-approval-for-an-arbitrary-underlying\">[M-08] YearnTokenAdapter’s wrap can become stuck as it uses one step approval for an arbitrary underlying</a></li>\n<li><a href=\"#m-09-transmuterbuffers-setalchemist-will-freeze-deposited-funds\">[M-09] TransmuterBuffer’s setAlchemist will freeze deposited funds</a></li>\n<li><a href=\"#m-10-new-galcx-token-denomination-can-be-depressed-by-the-first-depositor\">[M-10] New gALCX token denomination can be depressed by the first depositor</a></li>\n<li><a href=\"#m-11-galcxsol-attacker-can-make-the-contract-unusable-when-totalsupply-is-0\">[M-11] [gALCX.sol] Attacker can make the contract unusable when totalSupply is 0</a></li>\n<li><a href=\"#m-12-registerasset-misuse-can-permanently-disable-transmuterbuffer-and-break-the-system\">[M-12] registerAsset misuse can permanently disable TransmuterBuffer and break the system</a></li>\n<li><a href=\"#m-13-transmuterbuffers-_alchemistwithdraw-use-hard-coded-slippage-that-can-lead-to-user-losses\">[M-13] TransmuterBuffer’s _alchemistWithdraw use hard coded slippage that can lead to user losses</a></li>\n<li><a href=\"#m-14-a-well-financed-attacker-could-prevent-any-other-users-from-minting-synthetic-tokens\">[M-14] A well financed attacker could prevent any other users from minting synthetic tokens</a></li>\n<li><a href=\"#m-15-lido-adapter-incorrectly-calculates-the-price-of-the-underlying-token\">[M-15] Lido adapter incorrectly calculates the price of the underlying token</a></li>\n<li><a href=\"#m-16-if-totalshares-for-a-token-falls-to-zero-while-there-is-pendingcredit-the-contract-will-become-stuck\">[M-16] If <code>totalShares</code> for a token falls to zero while there is <code>pendingCredit</code> the contract will become stuck</a></li>\n<li><a href=\"#m-17-debt-can-be-repaid-with-a-depegged-underlyingtoken-which-can-be-exploited-by-arbitrageurs-and-drives-the-market-price-of-altoken-to-match-the-worst-depegged-underlyingtoken\">[M-17] Debt can be repaid with a depegged underlyingToken, which can be exploited by arbitrageurs and drives the market price of alToken to match the worst depegged underlyingToken</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#l-01-latent-funds-can-be-stolen\">L-01 Latent funds can be stolen</a></li>\n<li><a href=\"#l-02-low-level-calls-dont-check-for-contract-existence\">L-02 Low level calls don’t check for contract existence</a></li>\n<li><a href=\"#l-03-set-sane-maximums-for-input-parameters\">L-03 Set sane maximums for input parameters</a></li>\n<li><a href=\"#l-04-behavior-described-by-comment-is-incomplete\">L-04 Behavior described by comment is incomplete</a></li>\n<li><a href=\"#l-05-unsafe-use-of-transfertransferfrom-with-ierc20\">L-05 Unsafe use of <code>transfer()</code>/<code>transferFrom()</code> with <code>IERC20</code></a></li>\n<li><a href=\"#l-06-return-values-of-transfertransferfrom-not-checked\">L-06 Return values of <code>transfer()</code>/<code>transferFrom()</code> not checked</a></li>\n<li><a href=\"#l-07-unusedempty-receive-function\">L-07 Unused/empty <code>receive()</code> function</a></li>\n<li><a href=\"#l-08-safeapprove-is-deprecated\">L-08 <code>safeApprove()</code> is deprecated</a></li>\n<li><a href=\"#l-09-missing-checks-for-address0x0-when-assigning-values-to-address-state-variables\">L-09 Missing checks for <code>address(0x0)</code> when assigning values to <code>address</code> state variables</a></li>\n<li><a href=\"#l-10-abiencodepacked-should-not-be-used-with-dynamic-types-when-passing-the-result-to-a-hash-function-such-as-keccak256\">L-10 <code>abi.encodePacked()</code> should not be used with dynamic types when passing the result to a hash function such as <code>keccak256()</code></a></li>\n<li><a href=\"#l-11-upgradeable-contract-is-missing-a-__gap50-storage-variable-to-allow-for-new-storage-variables-in-later-versions\">L-11 Upgradeable contract is missing a <code>__gap[50]</code> storage variable to allow for new storage variables in later versions</a></li>\n<li><a href=\"#n-01-adding-a-return-statement-when-the-function-defines-a-named-return-variable-is-redundant\">N-01 Adding a <code>return</code> statement when the function defines a named return variable, is redundant</a></li>\n<li><a href=\"#n-02-override-function-arguments-that-are-unused-should-have-the-variable-name-removed-or-commented-out-to-avoid-compiler-warnings\">N-02 <code>override</code> function arguments that are unused should have the variable name removed or commented out to avoid compiler warnings</a></li>\n<li><a href=\"#n-03-public-functions-not-called-by-the-contract-should-be-declared-external-instead\">N-03 <code>public</code> functions not called by the contract should be declared <code>external</code> instead</a></li>\n<li><a href=\"#n-04-2n---1-should-be-re-written-as-typeuintnmax\">N-04 <code>2**&#x3C;n> - 1</code> should be re-written as <code>type(uint&#x3C;n>).max</code></a></li>\n<li><a href=\"#n-05-constants-should-be-defined-rather-than-using-magic-numbers\">N-05 <code>constant</code>s should be defined rather than using magic numbers</a></li>\n<li><a href=\"#n-06-redundant-cast\">N-06 Redundant cast</a></li>\n<li><a href=\"#n-07-numeric-values-having-to-do-with-time-should-use-time-units-for-readability\">N-07 Numeric values having to do with time should use time units for readability</a></li>\n<li><a href=\"#n-08-missing-event-for-critical-parameter-change\">N-08 Missing event for critical parameter change</a></li>\n<li><a href=\"#n-09-use-a-more-recent-version-of-solidity\">N-09 Use a more recent version of solidity</a></li>\n<li><a href=\"#n-10-use-a-more-recent-version-of-solidity\">N-10 Use a more recent version of solidity</a></li>\n<li><a href=\"#n-11-use-scientific-notation-eg-1e18-rather-than-exponentiation-eg-1018\">N-11 Use scientific notation (e.g. <code>1e18</code>) rather than exponentiation (e.g. <code>10**18</code>)</a></li>\n<li><a href=\"#n-12-inconsistent-spacing-in-comments\">N-12 Inconsistent spacing in comments</a></li>\n<li><a href=\"#n-13-non-libraryinterface-files-should-use-fixed-compiler-versions-not-floating-ones\">N-13 Non-library/interface files should use fixed compiler versions, not floating ones</a></li>\n<li><a href=\"#n-14-typos\">N-14 Typos</a></li>\n<li><a href=\"#n-15-file-does-not-contain-an-spdx-identifier\">N-15 File does not contain an SPDX Identifier</a></li>\n<li><a href=\"#n-16-file-is-missing-natspec\">N-16 File is missing NatSpec</a></li>\n<li><a href=\"#n-17-natspec-is-incomplete\">N-17 NatSpec is incomplete</a></li>\n<li><a href=\"#n-18-event-is-missing-indexed-fields\">N-18 Event is missing <code>indexed</code> fields</a></li>\n<li><a href=\"#n-19-use-allowlistdenylist-rather-than-blacklistwhitelist\">N-19 Use allowlist/denylist rather than blacklist/whitelist</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-remove-or-replace-unused-state-variables\">G-01 Remove or replace unused state variables</a></li>\n<li><a href=\"#g-02-multiple-address-mappings-can-be-combined-into-a-single-mapping-of-an-address-to-a-struct-where-appropriate\">G-02 Multiple <code>address</code> mappings can be combined into a single <code>mapping</code> of an <code>address</code> to a <code>struct</code>, where appropriate</a></li>\n<li><a href=\"#g-03-state-variables-only-set-in-the-constructor-should-be-declared-immutable\">G-03 State variables only set in the constructor should be declared <code>immutable</code></a></li>\n<li><a href=\"#g-04-structs-can-be-packed-into-fewer-storage-slots\">G-04 Structs can be packed into fewer storage slots</a></li>\n<li><a href=\"#g-05-using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\">G-05 Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</a></li>\n<li><a href=\"#g-06-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\">G-06 State variables should be cached in stack variables rather than re-reading them from storage</a></li>\n<li><a href=\"#g-07-the-result-of-external-function-calls-should-be-cached-rather-than-re-calling-the-function\">G-07 The result of external function calls should be cached rather than re-calling the function</a></li>\n<li><a href=\"#g-08-x--y-costs-more-gas-than-x--x--y-for-state-variables\">G-08 <code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</a></li>\n<li><a href=\"#g-09-internal-functions-only-called-once-can-be-inlined-to-save-gas\">G-09 <code>internal</code> functions only called once can be inlined to save gas</a></li>\n<li><a href=\"#g-10-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\">G-10 <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</a></li>\n<li><a href=\"#g-11-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\">G-11 <code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{++i}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</a></li>\n<li><a href=\"#g-12-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\">G-12 <code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</a></li>\n<li><a href=\"#g-13-private-functions-not-called-by-the-contract-should-be-removed-to-save-deployment-gas\">G-13 <code>private</code> functions not called by the contract should be removed to save deployment gas</a></li>\n<li><a href=\"#g-14-not-using-the-named-return-variables-when-a-function-returns-wastes-deployment-gas\">G-14 Not using the named return variables when a function returns, wastes deployment gas</a></li>\n<li><a href=\"#g-15-remove-unused-local-variable\">G-15 Remove unused local variable</a></li>\n<li><a href=\"#g-16-using-bools-for-storage-incurs-overhead\">G-16 Using <code>bool</code>s for storage incurs overhead</a></li>\n<li><a href=\"#g-17-use-a-more-recent-version-of-solidity\">G-17 Use a more recent version of solidity</a></li>\n<li><a href=\"#g-18-use-a-more-recent-version-of-solidity\">G-18 Use a more recent version of solidity</a></li>\n<li><a href=\"#g-19-use-a-more-recent-version-of-solidity\">G-19 Use a more recent version of solidity</a></li>\n<li><a href=\"#g-20-it-costs-more-gas-to-initialize-variables-to-zero-than-to-let-the-default-of-zero-be-applied\">G-20 It costs more gas to initialize variables to zero than to let the default of zero be applied</a></li>\n<li><a href=\"#g-21-internal-functions-not-called-by-the-contract-should-be-removed-to-save-deployment-gas\">G-21 <code>internal</code> functions not called by the contract should be removed to save deployment gas</a></li>\n<li><a href=\"#g-22-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\">G-22 <code>++i</code> costs less gas than <code>++i</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</a></li>\n<li><a href=\"#g-23-usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\">G-23 Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</a></li>\n<li><a href=\"#g-24-abiencode-is-less-efficient-than-abiencodepacked\">G-24 <code>abi.encode()</code> is less efficient than <code>abi.encodePacked()</code></a></li>\n<li><a href=\"#g-25-expressions-for-constant-values-such-as-a-call-to-keccak256-should-use-immutable-rather-than-constant\">G-25 Expressions for constant values such as a call to <code>keccak256()</code>, should use <code>immutable</code> rather than <code>constant</code></a></li>\n<li><a href=\"#g-26-using-private-rather-than-public-for-constants-saves-gas\">G-26 Using <code>private</code> rather than <code>public</code> for constants, saves gas</a></li>\n<li><a href=\"#g-27-dont-use-safemath-once-the-solidity-version-is-080-or-greater\">G-27 Don’t use <code>SafeMath</code> once the solidity version is 0.8.0 or greater</a></li>\n<li><a href=\"#g-28-duplicated-requirerevert-checks-should-be-refactored-to-a-modifier-or-function\">G-28 Duplicated <code>require()</code>/<code>revert()</code> checks should be refactored to a modifier or function</a></li>\n<li><a href=\"#g-29-multiplicationdivision-by-two-should-use-bit-shifting\">G-29 Multiplication/division by two should use bit shifting</a></li>\n<li><a href=\"#g-30-empty-blocks-should-be-removed-or-emit-something\">G-30 Empty blocks should be removed or emit something</a></li>\n<li><a href=\"#g-31-use-custom-errors-rather-than-revertrequire-strings-to-save-deployment-gas\">G-31 Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save deployment gas</a></li>\n<li><a href=\"#g-32-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\">G-32 Functions guaranteed to revert when called by normal users can be marked <code>payable</code></a></li>\n<li><a href=\"#g-33-public-functions-not-called-by-the-contract-should-be-declared-external-instead\">G-33 <code>public</code> functions not called by the contract should be declared <code>external</code> instead</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the Alchemix smart contract system written in Solidity. The audit contest took place between May 5—May 18 2022.\n\n## Wardens\n\n74 Wardens contributed reports to the Alchemix contest:\n\n  1. hyh\n  1. AuditsAreUS\n  1. TerrierLover\n  1. [WatchPug](https://twitter.com/WatchPug_) ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n  1. cccz\n  1. [Ruhum](https://twitter.com/0xruhum)\n  1. 0x52\n  1. [CertoraInc](https://twitter.com/CertoraInc) (egjlmn1, [OriDabush](https://twitter.com/ori_dabush), ItayG, and shakedwinder)\n  1. 0x1337\n  1. dirk_y\n  1. [0xsomeone](https://github.com/alex-ppg)\n  1. IllIllI\n  1. tintin\n  1. GimelSec ([rayn](https://twitter.com/rayn731) and sces60107)\n  1. BowTiedWardens (BowTiedHeron and BowTiedPickle and [m4rio_eth](BowTiedETHernal) and [Dravee](https://twitter.com/JustDravee) and BowTiedFirefox)\n  1. [joestakey](https://twitter.com/JoeStakey)\n  1. 0x1f8b\n  1. 0xDjango\n  1. mics\n  1. 0xkatana\n  1. [fatherOfBlocks](https://twitter.com/father0fBl0cks)\n  1. robee\n  1. 0x4non\n  1. simon135\n  1. [0xNazgul](https://twitter.com/0xNazgul)\n  1. samruna\n  1. [MaratCerby](https://twitter.com/MaratCerby)\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. sikorico\n  1. horsefacts\n  1. [catchup](https://twitter.com/catchup22)\n  1. [ellahi](https://twitter.com/ellahinator)\n  1. oyc_109\n  1. [MiloTruck](https://milotruck.github.io/)\n  1. [Funen](https://instagram.com/vanensurya)\n  1. [throttle](https://twitter.com/Throt7le)\n  1. Cityscape\n  1. bobirichman\n  1. Hawkeye (0xwags and 0xmint)\n  1. Waze\n  1. hake\n  1. kenta\n  1. [JC](https://twitter.com/sm4rtcontr4ct)\n  1. [shenwilly](https://twitter.com/shenwilly_)\n  1. AlleyCat\n  1. jayjonah8\n  1. [Picodes](https://twitter.com/thePicodes)\n  1. cryptphi\n  1. [BouSalman](https://twitter.com/BouSalman)\n  1. delfin454000\n  1. kebabsec (okkothejawa and [FlameHorizon](https://twitter.com/FlameHorizon1))\n  1. sashik_eth\n  1. 0xf15ers (remora and twojoy)\n  1. [Tomio](https://twitter.com/meidhiwirara)\n  1. _Adam\n  1. [hansfriese](https://twitter.com/hansfriese)\n  1. [ignacio](https://twitter.com/igncarmona)\n  1. [0v3rf10w](https://twitter.com/_0v3rf10w)\n  1. [Fitraldys](https://twitter.com/fitraldys)\n  1. [Randyyy](https://twitter.com/randyyramadhan)\n  1. UnusualTurtle\n  1. [augustg](https://augustcomputing.com/)\n\nThis contest was judged by [0xleastwood](https://twitter.com/liam_eastwood13).\n\nFinal report assembled by [itsmetechjay](https://twitter.com/itsmetechjay).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 17 unique vulnerabilities. Of these vulnerabilities, 0 received a risk rating in the category of HIGH severity and 17 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 46 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 46 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 Alchemix contest repository](https://github.com/code-423n4/2022-05-alchemix), and is composed of 27 smart contracts written in the Solidity programming language and includes 7,000 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# Medium Risk Findings (17)\n## [[M-01] Alchemist can mint `AlTokens` above their assigned ceiling by calling `lowerHasMinted()`](https://github.com/code-423n4/2022-05-alchemix-findings/issues/166)\n_Submitted by tintin, also found by 0xsomeone, AuditsAreUS, and hyh_\n\n[AlchemicTokenV2Base.sol#L111-L124](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemicTokenV2Base.sol#L111-L124)<br>\n[AlchemicTokenV2Base.sol#L189-L191](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemicTokenV2Base.sol#L189-L191)<br>\n\nAn alchemist / user can mint more than their alloted amount of AlTokens by calling `lowerHasMinted()` before they reach their minting cap.\n\n### Proof of Concept\n\nFunction `mint()` in `AlchemicTokenV2Base.sol`\n\n```solidity\n  function mint(address recipient, uint256 amount) external onlyWhitelisted {\n    if (paused[msg.sender]) {\n      revert IllegalState();\n    }\n\n    uint256 total = amount + totalMinted[msg.sender];\n    if (total > mintCeiling[msg.sender]) {\n      revert IllegalState();\n    }\n\n    totalMinted[msg.sender] = total;\n\n    _mint(recipient, amount);\n  }\n```\n\nNote the require conditional check that `total > mintCeiling[msg.sender]`.\n\nIn the same contract, there is the function `lowerHasMinted()` with the same permission level as mint and is thus callable by the same user as well.\n\n```solidity\n  function lowerHasMinted(uint256 amount) external onlyWhitelisted {\n    totalMinted[msg.sender] = totalMinted[msg.sender] - amount;\n  }\n```\n\nIt is clear that a user can accumulate an infinite (within supply) amount of AlTokens by calling `lowerHasMinted()` before any action that would make them exceed their minting cap.\n\n### Tools Used\n\nManual review, VScode\n\n### Recommended Mitigation Steps\n\nChange the permissioning on `lowerHasMinted()` to be restricted to a higher permissioned role like `onlySentinel()` , or deprecate this function as I could not find any uses of it throughout the codebase or in tests.\n\n\n**[0xfoobar (Alchemix) confirmed](https://github.com/code-423n4/2022-05-alchemix-findings/issues/166#issuecomment-1140762092)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/166#issuecomment-1145217432):**\n > Great find! This would allow whitelisted account to mint any number of tokens. However, as this pertains to only whitelisted accounts, I think `medium` severity is justified and correct.\n\n\n\n***\n\n## [[M-02] TransmuterBuffer.sol calls depositUnderlying with no slippage bounds ](https://github.com/code-423n4/2022-05-alchemix-findings/issues/222)\n_Submitted by 0x52_\n\nLoss of funds in TransmuterBuffer\n\n### Proof of Concept\n\nIf the buffer is called during and unfavorable time then a large portion of deposited funds may be lost due to slippage because deposit is called with 0 as the minimum out allowing any level of slippage\n\n### Recommended Mitigation Steps\n\nImplement a slippage calculation similar to `\\_alchemistWithdraw` to protect against it\n\n\n**[0xfoobar (Alchemix) acknowledged, disagreed with severity and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/222#issuecomment-1133985891):**\n\n> This function is only called by keeper bots harvesting yields, which should not be subject to large slippage and could be sent through a private mempool if necessary. However, we acknowledge that a configurable parameter could enable greater protection, even if in practice the issue does not occur.\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/222#issuecomment-1146180192):**\n > Because this requires the keeper role to sandwich attack the protocol when yield is harvested, this better fits the criteria of a `medium` severity issue.\n\n\n\n***\n\n## [[M-03] DoS in wrap and unwrap](https://github.com/code-423n4/2022-05-alchemix-findings/issues/159)\n_Submitted by CertoraInc_\n\n[FuseTokenAdapterV1.sol#L76](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/adapters/fuse/FuseTokenAdapterV1.sol#L76)<br>\n[FuseTokenAdapterV1.sol#L98](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/adapters/fuse/FuseTokenAdapterV1.sol#L98)<br>\n\nThe code is doing wrong check, so when things will work it will revert.\n\n### Proof of Concept\n\nIn the function `wrap()` there is this lines:\n\n       if ((error = ICERC20(token).mint(amount)) != NO_ERROR) {\n                revert FuseError(error);\n            }\n\nbut `mint` returns the amount that minted, so when `error = amount` the check will fail even though it worked good.\n\nSame in `unwrap`:\n\n    if ((error = ICERC20(token).redeem(amount)) != NO_ERROR) {\n                revert FuseError(error);\n            }\n\nthe redeem returns the amount.\n\n### Recommended Mitigation Steps\n\nI recommend to change the lines like this:\nin wrap:\n`      if ((error = ICERC20(token).mint(amount)) != amount) {\n            revert FuseError(error);\n        }\n    `\nand in unwrap:\n`     if ((error = ICERC20(token).redeem(amount)) != amount) {\n            revert FuseError(error);\n        }\n    `\n\n**[0xfoobar (Alchemix) confirmed, disagreed with severity and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/159#issuecomment-1133987052):**\n > This would not cause any loss of user funds because the deposit function would revert, but it is a needed fix in the Fuse Adapter. So recommend a lower severity.\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/159#issuecomment-1146198103):**\n > As no assets are at risk, medium risk seems correct because only the availability of the protocol is impacted.\n\n\n\n***\n\n## [[M-04] YearnTokenAdapter allows a maximum loss of 100% when withdrawing](https://github.com/code-423n4/2022-05-alchemix-findings/issues/60)\n_Submitted by Ruhum_\n\n[YearnTokenAdapter.sol#L13](https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/adapters/yearn/YearnTokenAdapter.sol#L13)<br>\n[YearnTokenAdapter.sol#L43](https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/adapters/yearn/YearnTokenAdapter.sol#L43)<br>\n\nYearnTokenAdapter allows slippage of 100% when withdrawing from the vault which will cause a loss of funds.\n\nHere's the documentation straight from the vault contract: <https://github.com/yearn/yearn-vaults/blob/main/contracts/Vault.vy#L1025-L1073>\nIt allows the user to specify the `maxLoss` as the last parameter. It determines how many shares can be burned to fulfill the withdrawal. Currently, the contract uses 10.000 which is 100%. Meaning there is no slippage check at all. This is bound to cause a loss of funds.\n\nI'd suggest letting the user determine the slippage check themselves instead of hardcoding it.\n\n### Proof of Concept\n\nCurrent `maxLoss` value: <https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/adapters/yearn/YearnTokenAdapter.sol#L13>\n\ncall to Yearn vault's `withdraw()` function: <https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/adapters/yearn/YearnTokenAdapter.sol#L43>\n\n### Recommended Mitigation Steps\n\nAllow the user to specify the slippage value themselves:\n\n```sol\n    function unwrap(uint256 amount, address recipient, uint maxLoss) external override returns (uint256) {\n        TokenUtils.safeTransferFrom(token, msg.sender, address(this), amount);\n\n        uint256 balanceBefore = TokenUtils.safeBalanceOf(token, address(this));\n\n        uint256 amountWithdrawn = IYearnVaultV2(token).withdraw(amount, recipient, maxLoss);\n\n        uint256 balanceAfter = TokenUtils.safeBalanceOf(token, address(this));\n\n        // If the Yearn vault did not burn all of the shares then revert. This is critical in mathematical operations\n        // performed by the system because the system always expects that all of the tokens were unwrapped. In Yearn,\n        // this sometimes does not happen in cases where strategies cannot withdraw all of the requested tokens (an\n        // example strategy where this can occur is with Compound and AAVE where funds may not be accessible because\n        // they were lent out).\n        if (balanceBefore - balanceAfter != amount) {\n            revert IllegalState();\n        }\n\n        return amountWithdrawn;\n    }\n```\n\nIf you don't want to change the ITokenAdapter interface you can also leave the value blank. The vault will then use the default value (`0.01%`)\n\n\n**[0xfoobar (Alchemix) acknowledged, disagreed with severity and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/60#issuecomment-1133991312):**\n\n> This could be made more configurable by the end user but yearn vaults do not frequently experience high slippage. Slippage is handled upstream in the Alchemist contract. The reason why this slippage is set to 100% is so to permit handling of slippage in the Alchemist for all cases.\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/60#issuecomment-1146206028):**\n > Because we can't know how the yearn strategy implements withdrawals, its possible that it might contain custom swap logic which exposes itself to sandwich attacks. However, at face value, the current use of `MAXIMUM_SLIPPAGE` allows the contract to successfully unwrap their tokens under poor network conditions, but it makes sense for the user to have more control over this. Downgrading this to medium risk as I believe it is more in line with that.\n\n\n\n***\n\n## [[M-05] No Storage Gap for Upgradeable Contract Might Lead to Storage Slot Collision](https://github.com/code-423n4/2022-05-alchemix-findings/issues/44)\n_Submitted by 0x1337_\n\n[AlchemicTokenV2Base.sol#L20](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemicTokenV2Base.sol#L20)<br>\n[CrossChainCanonicalBase.sol#L12](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/CrossChainCanonicalBase.sol#L12)<br>\n[TransmuterV2.sol#L26](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/TransmuterV2.sol#L26)<br>\n[CrossChainCanonicalAlchemicTokenV2.sol#L7](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/CrossChainCanonicalAlchemicTokenV2.sol#L7)<br>\n\nFor upgradeable contracts, there must be storage gap to \"allow developers to freely add new state variables in the future without compromising the storage compatibility with existing deployments\" (quote OpenZeppelin). Otherwise it may be very difficult to write new implementation code. Without storage gap, the variable in child contract might be overwritten by the upgraded base contract if new variables are added to the base contract. This could have unintended and very serious consequences to the child contracts, potentially causing loss of user fund or cause the contract to malfunction completely.\n\nRefer to the bottom part of this article: <https://docs.openzeppelin.com/upgrades-plugins/1.x/writing-upgradeable>\n\n### Proof of Concept\n\nSeveral contracts are intended to be upgradeable contracts in the code base, including\n\n*   AlchemicTokenV2Base\n*   CrossChainCanonicalBase\n*   CrossChainCanonicalAlchemicTokenV2\n*   TransmuterV2\n\nHowever, none of these contracts contain storage gap. The storage gap is essential for upgradeable contract because \"It allows us to freely add new state variables in the future without compromising the storage compatibility with existing deployments\". Refer to the bottom part of this article:\n\n<https://docs.openzeppelin.com/contracts/3.x/upgradeable>\n\nAs an example, both the `AlchemicTokenV2Base` and the `CrossChainCanonicalBase` are intended to act as the base contracts in the project. If the contract inheriting the base contract contains additional variable, then the base contract cannot be upgraded to include any additional variable, because it would overwrite the variable declared in its child contract. This greatly limits contract upgradeability.\n\n### Recommended Mitigation Steps\n\nRecommend adding appropriate storage gap at the end of upgradeable contracts such as the below. Please reference OpenZeppelin upgradeable contract templates.\n\n```solidity\nuint256[50] private __gap;\n```\n\n**[0xfoobar (Alchemix) confirmed](https://github.com/code-423n4/2022-05-alchemix-findings/issues/44#issuecomment-1140765969)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/44#issuecomment-1153292612):**\n > Agree with warden and severity. Storage gaps are essential wherever inheritance is used by an upgradeable contract.\n\n\n\n***\n\n## [[M-06] EthAssetManager and ThreePoolAssetManager don't control Meta tokens decimals](https://github.com/code-423n4/2022-05-alchemix-findings/issues/63)\n_Submitted by hyh_\n\nBoth contracts treat meta assets as if they have fixed decimals of 18. Minting logic breaks when it's not the case. However, meta tokens decimals aren't controlled.\n\nIf actual meta assets have any other decimals, minting slippage control logic of both contracts will break up as `total` is calculated as a plain sum of token amounts.\n\nIn the higher token decimals case `minTotalAmount` will be magnitudes higher than actual amount Curve can provide and minting becomes unavailable.\n\nIn the lower token decimals case `minTotalAmount` will lack value and slippage control will be rendered void, which opens up a possibility of a fund loss from the excess slippage.\n\nSetting severity to medium as the contract can be used with various meta tokens (`_metaPoolAssetCache`  can be filled with any assets) and, whenever decimals differ from 18 `add_liquidity` uses, its logic be broken: the inability to mint violates the contract purpose, the lack of slippage control can lead to fund losses.\n\nI.e. this is system breaking impact conditional on a low probability assumption of different meta token decimals.\n\n### Proof of Concept\n\nMeta tokens decimals are de facto hard coded into the contract as plain amounts are used (L. 905):\n\n[ThreePoolAssetManager.sol#L896-L905](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/ThreePoolAssetManager.sol#L896-L905)<br>\n\n```solidity\n    function _mintMetaPoolTokens(\n        uint256[NUM_META_COINS] calldata amounts\n    ) internal returns (uint256 minted) {\n        IERC20[NUM_META_COINS] memory tokens = _metaPoolAssetCache;\n\n        uint256 total = 0;\n        for (uint256 i = 0; i < NUM_META_COINS; i++) {\n            if (amounts[i] == 0) continue;\n\n            total += amounts[i];\n```\n\n[ThreePoolAssetManager.sol#L915-L919](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/ThreePoolAssetManager.sol#L915-L919)<br>\n\n```solidity\n        uint256 expectedOutput    = total * CURVE_PRECISION / metaPool.get_virtual_price();\n        uint256 minimumMintAmount = expectedOutput * metaPoolSlippage / SLIPPAGE_PRECISION;\n\n        // Add the liquidity to the pool.\n        minted = metaPool.add_liquidity(amounts, minimumMintAmount);\n```\n\nThe same plain sum approach is used in EthAssetManager.\\_mintMetaPoolTokens:\n\n[EthAssetManager.sol#L566-L573](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/EthAssetManager.sol#L566-L573)<br>\n\n```solidity\n        uint256 total = 0;\n        for (uint256 i = 0; i < NUM_META_COINS; i++) {\n            // Skip over approving WETH since we are directly swapping ETH.\n            if (i == uint256(MetaPoolAsset.ETH)) continue;\n\n            if (amounts[i] == 0) continue;\n\n            total += amounts[i];\n```\n\nWhen this decimals assumption doesn't hold, the slippage logic will not hold too: either the mint be blocked or slippage control disabled.\n\nNotice, that ThreePoolAssetManager.calculateRebalance do query alUSD decimals (which is inconsistent with the above as it’s either fix and control on inception or do not fix and accommodate the logic):\n\n[ThreePoolAssetManager.sol#L338-L338](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/ThreePoolAssetManager.sol#L338-L338)<br>\n\n```solidity\ndecimals     = SafeERC20.expectDecimals(address(alUSD));\n```\n\n### Recommended Mitigation Steps\n\nIf meta assets are always supposed to have fixed decimals of 18, consider controlling it at the construction time.\n\nI.e. the decimals can be controlled in constructors:\n\n[EthAssetManager.sol#L214-L219](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/EthAssetManager.sol#L214-L219)<br>\n\n```solidity\n        for (uint256 i = 0; i < NUM_META_COINS; i++) {\n            _metaPoolAssetCache[i] = params.metaPool.coins(i);\n            if (_metaPoolAssetCache[i] == IERC20(0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE)) {\n                _metaPoolAssetCache[i] = weth;\n+           } else {\n+           \t// check the decimals\n\t\t\t\t}\n        }\n```\n\n[ThreePoolAssetManager.sol#L254-L256](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/ThreePoolAssetManager.sol#L254-L256)<br>\n\n```solidity\n        for (uint256 i = 0; i < NUM_META_COINS; i++) {\n            _metaPoolAssetCache[i] = params.metaPool.coins(i);\n+           // check the decimals            \n        }\n```\n\nIn this case further decimals reading as it's done in calculateRebalance() is redundant.\n\nOtherwise (which is less recommended as fixed decimals assumption is viable and simplify the logic) the meta token decimals can be added to calculations similarly to stables:\n\n[ThreePoolAssetManager.sol#L779-L779](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/ThreePoolAssetManager.sol#L779-L779)<br>\n\n```solidity\nnormalizedTotal += amounts[i] * 10**missingDecimals;\n```\n\n**[0xfoobar (Alchemix) confirmed](https://github.com/code-423n4/2022-05-alchemix-findings/issues/63#issuecomment-1141380260)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/63#issuecomment-1153292871):**\n > Agree with issue and its severity. `minTotalAmount` is affected by a change in a token's decimals, leading to improper handling by the contract. \n\n\n\n***\n\n## [[M-07] AutoleverageBase: Must approve 0 first](https://github.com/code-423n4/2022-05-alchemix-findings/issues/144)\n_Submitted by cccz_\n\nSome tokens (like USDT) do not work when changing the allowance from an existing non-zero allowance value.They must first be approved by zero and then the actual allowance must be approved.\n\n### Proof of Concept\n\n[AutoleverageBase.sol#L61-L63](https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/AutoleverageBase.sol#L61-L63)<br>\n\n[AutoleverageBase.sol#L147-L147](https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/AutoleverageBase.sol#L147-L147)<br>\n\n[AutoleverageBase.sol#L178-L179](https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/AutoleverageBase.sol#L178-L179)<br>\n\n### Recommended Mitigation Steps\n\n        function approve(address token, address spender) internal {\n        +  IERC20(token).approve(spender, 0);\n            IERC20(token).approve(spender, type(uint256).max);\n        }\n\n**[0xtao (Alchemix) confirmed and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/144#issuecomment-1134868843):**\n\n> This implementation will not work for tokens like USDT where the approval is not set to `0` initially\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/144#issuecomment-1146364549):**\n > It seems like `approve()` will fail to execute on non-standard tokens which require the approval amount to start from zero. This is valid and should be updated to handle such tokens.\n\n\n\n***\n\n## [[M-08] YearnTokenAdapter's wrap can become stuck as it uses one step approval for an arbitrary underlying](https://github.com/code-423n4/2022-05-alchemix-findings/issues/99)\n_Submitted by hyh_\n\nSome tokens do not allow for approval of positive amount when allowance is positive already (to handle approval race condition, most known example is USDT).\n\nThis can cause the function to stuck whenever a combination of such a token and leftover approval be met. The latter can be possible if, for example, yearn vault is becoming full on a particular wrap() call and accepts only a part of amount, not utilizing the approval fully.\n\nThen each next safeApprove will revert and wrap becomes permanently unavailable. Setting the severity to medium as depositing (wrapping) is core functionality for the contract and its availability is affected.\n\n### Proof of Concept\n\nwrap use one step approve:\n\n[YearnTokenAdapter.sol#L30-L32](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/adapters/yearn/YearnTokenAdapter.sol#L30-L32)<br>\n\n```solidity\n    function wrap(uint256 amount, address recipient) external override returns (uint256) {\n        TokenUtils.safeTransferFrom(underlyingToken, msg.sender, address(this), amount);\n        TokenUtils.safeApprove(underlyingToken, token, amount);\n```\n\nSome ERC20 forbid the approval of positive amount when the allowance is positive:\n\n<https://github.com/d-xo/weird-erc20#approval-race-protections>\n\nFor example, USDT is supported by Yearn and can be the underlying asset:\n\n<https://yearn.finance/#/vault/0x7Da96a3891Add058AdA2E826306D812C638D87a7>\n\n### Recommended Mitigation Steps\n\nAs the most general approach consider approving zero before doing so for the amount:\n\n```solidity\n    function wrap(uint256 amount, address recipient) external override returns (uint256) {\n        TokenUtils.safeTransferFrom(underlyingToken, msg.sender, address(this), amount);\n+      TokenUtils.safeApprove(underlyingToken, token, 0);\n        TokenUtils.safeApprove(underlyingToken, token, amount);\n```\n\n**[0xfoobar (Alchemix) confirmed](https://github.com/code-423n4/2022-05-alchemix-findings/issues/99#issuecomment-1141378852)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/99#issuecomment-1146364671):**\n > It seems like `approve()` will fail to execute on non-standard tokens which require the approval amount to start from zero. This is valid and should be updated to handle such tokens.\n\n\n\n***\n\n## [[M-09] TransmuterBuffer's setAlchemist will freeze deposited funds](https://github.com/code-423n4/2022-05-alchemix-findings/issues/117)\n_Submitted by hyh_\n\nCurrently setAlchemist doesn't check whether there are any open positions left with the old Alchemist before switching to the new one.\n\nAs this require a number of checks the probability of operational mistake isn't low and it's prudent to introduce the main controls directly to the code to minimize it. In the case if the system go on with new Alchemist before realizing that there are some funds left in the old one, tedious and error prone manual recovery will be needed. There is also going to be a corresponding reputational damage.\n\nSetting the severity to medium as while the function is admin only, the impact is up to massive user fund freeze, i.e. this is system breaking with external assumptions.\n\n### Proof of Concept\n\nAlchemist implementation change can happen while there are open deposits remaining with the current contract. As there looks to be no process to transfer them in the code, such TransmuterBuffer's funds will be frozen with old alchemist:\n\n[TransmuterBuffer.sol#L230-L232](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-hardhat/TransmuterBuffer.sol#L230-L232)<br>\n\n```solidity\n    function setAlchemist(address _alchemist) external override onlyAdmin {\n        sources[alchemist] = false;\n        sources[_alchemist] = true;\n```\n\n### Recommended Mitigation Steps\n\nConsider requiring that all exposure to the old Alchemist is closed, for example both `getAvailableFlow` and `getTotalCredit` is zero.\n\n[TransmuterBuffer.sol#L230-L231](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/TransmuterBuffer.sol#L230-L231)<br>\n\n```solidity\n    function setAlchemist(address _alchemist) external override onlyAdmin {\n+\t\t  require(getTotalCredit() == 0, \"Credit exists with old Alchemist\");\n+       for (uint256 j = 0; j < registeredUnderlyings.length; j++) {\n+           require(getTotalUnderlyingBuffered[registeredUnderlyings[j]] == 0, \"Buffer exists with old Alchemist\");\n+       }\n        sources[alchemist] = false;\n```\n\n**[0xfoobar (Alchemix) confirmed](https://github.com/code-423n4/2022-05-alchemix-findings/issues/117#issuecomment-1140762972)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/117#issuecomment-1153293529):**\n > This is useful in preventing loss of funds when changing the protocol's alchemist contract.\n\n\n\n***\n\n## [[M-10] New gALCX token denomination can be depressed by the first depositor](https://github.com/code-423n4/2022-05-alchemix-findings/issues/135)\n_Submitted by hyh, also found by 0xsomeone_\n\nAn attacker can become the first depositor for a recently created gALCX contract, providing a tiny amount of ALCX tokens by calling `stake(1)` (raw values here, `1` is `1 wei`, `1e18` is `1 ALCX`). Then the attacker can directly transfer, for example, `10^6 * 1e18 - 1` of ALCX to the gALCX contract and run bumpExchangeRate(), effectively setting the cost of `1` gALCX to be `10^6 * 1e18` of ALCX. The attacker will still own 100% of the gALCX's ALCX pool being the only depositor.\n\nAll subsequent depositors will have their ALCX token investments rounded to `10^6 * 1e18`, due to the lack of precision which initial tiny deposit caused, with the remainder divided between all current depositors, i.e. the subsequent depositors lose value to the attacker.\n\nFor example, if the second depositor brings in `1.9*10^6 * 1e18` of ALCX, only `1` of new vault to be issued as `1.9*10^6 * 1e18` divided by `10^6 * 1e18` will yield just `1`, which means that `2.9*10^6 * 1e18` total ALCX pool will be divided 50/50 between the second depositor and the attacker, as each will have `1 wei` of the total `2 wei` of vault tokens, i.e. the depositor lost and the attacker gained `0.45 * 10^6 * 1e18` of ALCX tokens.\n\nAs there are no penalties to exit with gALCX.unstake(), the attacker can remain staked for an arbitrary time, gathering the share of all new deposits' remainder amounts.\n\nPlacing severity to be medium as this is principal funds loss scenario for many users (most of depositors), easily executable, but only new gALCX contract instances are vulnerable.\n\n### Proof of Concept\n\ngAmount of gALCX to be minted is determined as a quotient of `amount` provided and `exchangeRate`:\n\n[gALCX.sol#L93-L94](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-hardhat/gALCX.sol#L93-L94)<br>\n\n```solidity\n        uint gAmount = amount * exchangeRatePrecision / exchangeRate;\n        _mint(msg.sender, gAmount);\n```\n\n[gALCX.sol#L15](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/gALCX.sol#L15)<br>\n\n```solidity\nuint public constant exchangeRatePrecision = 1e18;\n```\n\n`exchangeRate` accumulates balance increments relative to total gALCX supply:\n\n[gALCX.sol#L69-L76](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/gALCX.sol#L69-L76)<br>\n\n```solidity\n    function bumpExchangeRate() public {\n        // Claim from pool\n        pools.claim(poolId);\n        // Bump exchange rate\n        uint balance = alcx.balanceOf(address(this));\n\n        if (balance > 0) {\n            exchangeRate += (balance * exchangeRatePrecision) / totalSupply;\n```\n\nWhen gALCX contract is new, the very first stake -> bumpExchangeRate() yields nothing as the balance is empty, i.e. `exchangeRate` is still `1e18` and `gAmount == amount`:\n\n[gALCX.sol#L85-L93](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/gALCX.sol#L85-L93)<br>\n\n```solidity\n    function stake(uint amount) external {\n        // Get current exchange rate between ALCX and gALCX\n        bumpExchangeRate();\n        // Then receive new deposits\n        bool success = alcx.transferFrom(msg.sender, address(this), amount);\n        require(success, \"Transfer failed\");\n        pools.deposit(poolId, amount);\n        // gAmount always <= amount\n        uint gAmount = amount * exchangeRatePrecision / exchangeRate;\n```\n\nThis way, as there is no minimum amount or special treatment for the first deposit, the very first `gAmount` can be made `1 wei` with `stake(1)` call.\n\nThen, a combination of direct ALCX transfer and bumpExchangeRate() will make `exchangeRate` equal to the total amount provided by the attacker, say `10^6 * 1e18 * 1e18`, as totalSupply is `1 wei`.\n\nWhen a second depositor enters, the amount of gALCX to be minted is calculated as `amount * exchangeRatePrecision / exchangeRate`, which is `amount / (10^6 * 1e18)`, which will trunk the `amount` to the nearest divisor of `10^6 * 1e18`, effectively dividing the remainder between the depositor and the attacker.\n\nFor example, if the second depositor brings in `1.9*10^6` ALCX, only `1` (`1 wei`) of gALCX to be issued as `1.9*10^6 * 1e18 * 1e18 / (10^6 * 1e18 * 1e18)` = `1`.\n\nAs the attacker and depositor both have `1` of gALCX, each owns `(2.9 / 2)*10^6 * 1e18 = 1.45*10^6 * 1e18`, so the attacker effectively stole `0.45*10^6 * 1e18` from the depositor.\n\nAny deposit lower than total attacker's stake, `10^6 * 1e18`, will be fully stolen from the depositor as `0` gALCX tokens will be issued in this case.\n\n### References\n\nThe issue is similar to the `TOB-YEARN-003` one of the Trail of Bits audit of Yearn Finance:\n\n<https://github.com/yearn/yearn-security/tree/master/audits/20210719_ToB_yearn_vaultsv2>\n\n### Recommended Mitigation Steps\n\nA minimum for deposit value can drastically reduce the economic viability of the attack. I.e. stake() can require each amount to surpass the threshold, and then an attacker would have to provide too big direct investment to capture any meaningful share of the subsequent deposits.\n\nAn alternative is to require only the first depositor to freeze big enough initial amount of liquidity. This approach has been used long enough by various projects, for example in Uniswap V2:\n\n[Uniswap/UniswapV2Pair.sol#L119-L121](https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol#L119-L121)<br>\n\n**[0xfoobar (Alchemix) acknowledged, disagreed with severity and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/135#issuecomment-1140704865):**\n\n> Not a risk with current >400 tokenholders, but good to incorporated into future designs.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/135#issuecomment-1146370503):**\n > I think from the perspective of the contest, it is fair to assume that contracts are somewhat fresh. I'd be inclined to keep this as medium because it outlines a viable attack path that should be made public.\n\n\n\n***\n\n## [[M-11] [gALCX.sol] Attacker can make the contract unusable when totalSupply is 0](https://github.com/code-423n4/2022-05-alchemix-findings/issues/198)\n_Submitted by TerrierLover_\n\nAn attacker can make the contract unusable when totalSupply is 0. Specifically,  `bumpExchangeRate` function does not work correctly which results in making `stake`, `unstake` and `migrateSource` functions that do not work as expected.\n\n### Proof of Concept\n\nHere are steps on how the `gALCX` contract can be unusable.\n\n1.  `gALCX` contract is deployed\n\n2.  The attacker sends the `ALCX` token to the deployed `gALCX` contract directly instead of using `stake` function so that the following `balance` variable has value.\n\n[gALCX.sol#L73-L75](https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-hardhat/gALCX.sol#L73-L75)<br>\n    uint balance = alcx.balanceOf(address(this));\n\n    if (balance > 0) {\n\n3.  Since the `ALCX` token is given to the `gALCX` contract directly, `totalSupply == 0` and `alcx.balanceOf(address(this)) > 0` becomes true.\n\n[gALCX.sol#L76](https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-hardhat/gALCX.sol#L76)<br>\n\n    exchangeRate += (balance * exchangeRatePrecision) / totalSupply;\n\n4.  Non attackers try to call `stake` function, but `bumpExchangeRate` function fails because of `(balance * exchangeRatePrecision) / totalSupply` when totalSupply is 0.\n\n5.  Owner cannot call `migrateSource` function since `bumpExchangeRate` will be in the same situation mentioned in the step4 above\n\n### Recommended Mitigation Steps\n\nAdd handling when `totalSupply` is 0 but `alcx.balanceOf(address(this))` is more than 0.\n\n**[0xfoobar (Alchemix) acknowledged and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/198#issuecomment-1133996854):**\n > Given that the gALCX deployment has 412 unique tokenholders on mainnet, this series of events is extraordinarily unlikely to occur. But we will keep it in mind for future deployments.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/198#issuecomment-1146895463):**\n > Nice find! Early stakers can DoS new contract deployments, making it impossible for other users to participate in the protocol. As this does not lead to lost funds and is recoverable through redeployment, I believe medium severity to be justified by the warden.\n\n\n\n***\n\n## [[M-12] registerAsset misuse can permanently disable TransmuterBuffer and break the system](https://github.com/code-423n4/2022-05-alchemix-findings/issues/113)\n_Submitted by hyh_\n\nTransmuterBuffer's refreshStrategies() is the only way to actualize \\_yieldTokens array. The function requires registeredUnderlyings array to match current Alchemist's \\_supportedUnderlyingTokens. In the same time registeredUnderlyings can be only increased via registerAsset(): there is no way to reduce, remove or reconstruct the array.\n\nThis way if registerAsset() was mistakenly called extra time or alchemist was switched with setAlchemist to a new one with less supported assets, then the strategy refresh becomes impossible and the TransmuterBuffer be blocked as it cannot be properly used without synchronization with Alchemist.\n\nThe redeployment of the contract doesn't provide an easy fix as it holds the accounting data that needs to be recreated (flowAvailable, currentExchanged mappings).\n\n### Proof of Concept\n\nrefreshStrategies require registeredUnderlyings to be equal to Alchemist's supportedUnderlyingTokens:\n\n[TransmuterBuffer.sol#L377-L379](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/TransmuterBuffer.sol#L377-L379)<br>\n\n```solidity\n        if (registeredUnderlyings.length != supportedUnderlyingTokens.length) {\n            revert IllegalState();\n        }\n```\n\nIf registeredUnderlyings has length more than Alchemist's \\_supportedUnderlyingTokens it doesn't look to be fixable and prohibits the future use of the contract, i.e. breaks the system.\n\n### Recommended Mitigation Steps\n\nThe issue is that there is no way to unregister the asset, so consider introducing a function to remove the underlying or simply delete the array so it can be reconstructed with a sequence of registerAsset calls.\n\n**[thetechnocratic (Alchemix) acknowledged and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/113#issuecomment-1139901087):**\n\n> There is no way for `registerAsset` to be accidentally called too many times, and it reverts if an asset doesn't exist in the Alchemist or has already been registered.<br>\n> The TransmuterBuffer *could* be assigned a new Alchemist with fewer assets, but it is safe to assume that the operator will not make such a grand oversight.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/113#issuecomment-1153294243):**\n > Useful mitigation to prevent the TransmuterBuffer from being assigned a new Alchemist with fewer assets. In this event, the availability of the protocol is impacted. Valid medium.\n\n\n\n***\n\n## [[M-13] TransmuterBuffer's _alchemistWithdraw use hard coded slippage that can lead to user losses](https://github.com/code-423n4/2022-05-alchemix-findings/issues/127)\n_Submitted by hyh_\n\nexchange() -> \\_exchange() -> \\_alchemistWithdraw() is user funds utilizing call sequence and the slippage hard coded to 1% there can cause a range of issues.\n\nFor example, if there is not enough shares, the number of shares to withdraw will be unconditionally reduced to the number of the shares available. This can pass under 1% slippage and user will give away up to 1% without giving a consent to such a fee, which is big enough to notice.\n\nOn the other hand, in a similar situation when there is not enough shares available a user might knowingly want to execute with even bigger fee, but hard coded slippage will not be met and the withdraw be unavailable and funds frozen.\n\nSetting the severity to medium as the end impact is either modest user fund loss or exchange functionality unavailability.\n\n### Proof of Concept\n\n\\_alchemistWithdraw uses hard coded 1% slippage threshold and rewrites wantShares to be availableShares once TransmuterBuffer's position isn't big enough:\n\n[TransmuterBuffer.sol#L511-L524](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-hardhat/TransmuterBuffer.sol#L511-L524)<br>\n\n```solidity\n    function _alchemistWithdraw(address token, uint256 amountUnderlying) internal {\n        uint8 decimals = TokenUtils.expectDecimals(token);\n        uint256 pricePerShare = IAlchemistV2(alchemist).getUnderlyingTokensPerShare(token);\n        uint256 wantShares = amountUnderlying * 10**decimals / pricePerShare;\n        (uint256 availableShares, uint256 lastAccruedWeight) = IAlchemistV2(alchemist).positions(address(this), token);\n        if (wantShares > availableShares) {\n            wantShares = availableShares;\n        }\n        // Allow 1% slippage\n        uint256 minimumAmountOut = amountUnderlying - amountUnderlying * 100 / 10000;\n        if (wantShares > 0) {\n            IAlchemistV2(alchemist).withdrawUnderlying(token, wantShares, address(this), minimumAmountOut);\n        }\n    }\n```\n\nAlchemist's \\_unwrap will revert withdrawUnderlying call once minimumAmountOut isn't met:\n\n[AlchemistV2.sol#L1344-L1346](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemistV2.sol#L1344-L1346)<br>\n\n```solidity\n        if (amountUnwrapped < minimumAmountOut) {\n            revert SlippageExceeded(amountUnwrapped, minimumAmountOut);\n        }\n```\n\nThere are 2 use cases for the function:\n\nexchange (onlyKeeper) -> \\_exchange -> \\_alchemistWithdraw,\n\nsetFlowRate (onlyAdmin) -> \\_exchange -> \\_alchemistWithdraw\n\nexchange() is the most crucial as it should be able to fulfil various types of user funds exchange requests:\n\n[TransmuterBuffer.sol#L526-L546](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/TransmuterBuffer.sol#L526-L546)<br>\n\n```solidity\n    /// @notice Pull necessary funds from the Alchemist and exchange them.\n    ///\n    /// @param underlyingToken The underlying-token to exchange.\n    function _exchange(address underlyingToken) internal {\n        _updateFlow(underlyingToken);\n\n        uint256 totalUnderlyingBuffered = getTotalUnderlyingBuffered(underlyingToken);\n        uint256 initialLocalBalance = TokenUtils.safeBalanceOf(underlyingToken, address(this));\n        uint256 want = 0;\n        // Here we assume the invariant underlyingToken.balanceOf(address(this)) >= currentExchanged[underlyingToken].\n        if (totalUnderlyingBuffered < flowAvailable[underlyingToken]) {\n            // Pull the rest of the funds from the Alchemist.\n            want = totalUnderlyingBuffered - initialLocalBalance;\n        } else if (initialLocalBalance < flowAvailable[underlyingToken]) {\n            // totalUnderlyingBuffered > flowAvailable so we have funds available to pull.\n            want = flowAvailable[underlyingToken] - initialLocalBalance;\n        }\n\n        if (want > 0) {\n            _alchemistAction(want, underlyingToken, _alchemistWithdraw);\n        }\n```\n\nThis way, one issue here is that user can end up giving away the full 1% unconditionally to market situation because there are not enough shares available.\n\nAnother one is that knowing that the conditions are bad or that there are not enough shares available and willing to run the exchange with bigger slippage the user will not be able to as there are no means to control it and the functionality will end up unavailable, being reverted by Alchemist's \\_unwrap check.\n\n### Recommended Mitigation Steps\n\nConsider adding the function argument with a default value of 1%, so the slippage can be tuned when it is needed.\n\n**[thetechnocratic (Alchemix) acknowledged and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/127#issuecomment-1139827436):**\n > Allowing for a caller-defined slippage would enable more flexibility when using the `exchange()` and `setFlowRate()` calls.  However, the possibility of needing this flexibility at this time is very small, and because these functions are run by admins/keepers, there is room to modify the code if and when the flexibility becomes required.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/127#issuecomment-1153294479):**\n > Agree with warden. During periods of high volatility, assets will be locked within the contract. As this limits protocol availability, potentially leading to further loss of funds as users cannot freely exit the protocol and sell tokens, medium risk is justified.\n\n\n\n***\n\n## [[M-14] A well financed attacker could prevent any other users from minting synthetic tokens](https://github.com/code-423n4/2022-05-alchemix-findings/issues/155)\n_Submitted by dirk_y_\n\n[AlchemistV2.sol#L676-L683](https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/AlchemistV2.sol#L676-L683)<br>\n[AlchemistV2.sol#L704](https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/AlchemistV2.sol#L704)<br>\n[Limiters.sol#L84](https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/libraries/Limiters.sol#L84)<br>\n\nIn the `AlchemistV2` contract, users can deposit collateral to then borrow/mint the synthetic tokens offered by the protocol. The protocol also defines a minting limit that specifies how many synthetic tokens can be minted in a given time period. This exists to prevent unbounded minting of synthetic tokens.\n\nEvery time a user calls `mint`, the internal `_mint` method decreases the current mint limit. This works as intended. However, there is nothing stopping an attacker from immediately burning their synthetic tokens by calling `burn` and then calling `mint` again. This is possible because the debt position is updated during the `burn` phase, which lets the user then mint again against the same deposited collateral.\n\nIn most cases this probably wouldn't be a problem if the mint limit is sufficiently high. However, it is currently possible for a well financed attacker to grief the contract by repeatedly minting and burning synthetic tokens to keep the contract pegged at the mint limit. This will prevent any normal users from minting any synthetic tokens, and hence prevents the protocol from performing as it should.\n\n### Proof of Concept\n\nAn attacker can repeatedly call `mint` followed by `burn` after depositing some collateral with `deposit`. If this is appropriately sized and timed, it can cause the `mint` call to fail for another user due to the check [here](https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/AlchemistV2.sol#L1068) that is called during `mint` [here](https://github.com/code-423n4/2022-05-alchemix/blob/main/contracts-full/AlchemistV2.sol#L1192).\n\n### Tools Used\n\nVSCode\n\n### Recommended Mitigation Steps\n\nThere should be an additional method added to the `Limiters` library that can increment the mint limit. This method can then be called during a `burn` call in the `AlchemistV2` contract.\n\n    function increase(LinearGrowthLimiter storage self, uint256 amount) internal {\n      uint256 value = self.get();\n      self.lastValue = value + amount > self.maximum ? self.maximum : value + amount;\n    }\n\n**[0xfoobar (Alchemix) disputed and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/155#issuecomment-1134046370):**\n > If somebody griefed, let alone the insanely high capital requirements, governance could simply raise the mint limit.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/155#issuecomment-1147232259):**\n > As far as I can tell, this seems like a valid griefing attack. Assuming no fees are charged on mint/burn actions, it would be viable to use a flash loan to use up the entire mint limit, preventing other users from participating in the protocol. This could be mostly mitigated by charging a small fee on mints, which is sent to the protocol's governance contract or distributed to pre-existing stakers. Could you confirm this @0xfoobar ?\n\n**[0xfoobar (Alchemix) commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/155#issuecomment-1147991797):**\n > Upon further review the griefing action of\n> \n> 1. initiate flashloan\n> 2. deposit\n> 3. mint\n> 4. burn\n> 5. repay flashloan\n> \n> would be a valid approach to grief the protocol. No funds are at risk but we'll discuss internally how to best mitigate this.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/155#issuecomment-1149856681):**\n > Agreed, keeping this issue as is!\n> \n > This could have been upgraded to high risk if the ease of attack involved:\n>  - Limits on burning tokens.\n>  - The griefing attack is somewhat cheap, making it easy for attackers to maintain.\n> \n> But as the issue raised does not lead to a loss of user's funds, I believe medium risk to be justified.\n\n\n\n***\n\n## [[M-15] Lido adapter incorrectly calculates the price of the underlying token](https://github.com/code-423n4/2022-05-alchemix-findings/issues/97)\n_Submitted by AuditsAreUS_\n\nThe Lido adapter incorrectly calculates the price of WETH in terms of WstETH.\n\nThe function returns the price of WstETH in terms of stETH. The underlying token which we desire is WETH.\nSince stETH does not have the same value as WETH the output price incorrect.\n\nThe impact is severe as all the balance calculations require the price of the yield token converted to underlying. The incorrect price may over or understate the harvestable amount which is a core calculation in the protocol.\n\n### Proof of Concept\n\nThe function `IWstETH(token).getStETHByWstETH()` only converts WstETH to stETH. Thus, `price()` returns the value of WstETH in terms of stETH.\n\n```solidity\n    function price() external view returns (uint256) {\n        return IWstETH(token).getStETHByWstETH(10**SafeERC20.expectDecimals(token));\n    }\n```\n\n### Recommended Mitigation Steps\n\nAdd extra steps to `price()` to approximate the rate for converting stETH to ETH. This can be done using the same curve pool that is used to convert stETH to ETH in `unwrap()`.\n\n**[0xfoobar (Alchemix) disputed and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/97#issuecomment-1133989793):**\n \n> The design mechanism relies upon stETH reaching eventual 1:1 redeemability for ETH after the merge and shanghai enables withdrawals. This is core to out like-kind collateral/asset model. We will update the stETH token adapter at that time to do direct redemptions instead of Curve swaps. So in the meantime, the protocol accrues discounted assets.\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/97#issuecomment-1150012226):**\n > While the sponsor's comments suggest that this will be a non-issue after the merge/shanghai enables withdrawals, I believe there is legitimacy in the fact that the protocol will accrue discounted assets. It does not lead to the loss of assets, but value can be leaked if `WETH` is priced incorrectly. As such, I'm downgrading this to medium severity.\n\n\n\n***\n\n## [[M-16] If `totalShares` for a token falls to zero while there is `pendingCredit` the contract will become stuck](https://github.com/code-423n4/2022-05-alchemix-findings/issues/104)\n_Submitted by AuditsAreUS_\n\n[AlchemistV2.sol#L1290-L1300](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemistV2.sol#L1290-L1300)<br>\n[AlchemistV2.sol#L1268](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemistV2.sol#L1268)<br>\n[AlchemistV2.sol#L1532](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemistV2.sol#L1532)<br>\n[AlchemistV2.sol#L899](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemistV2.sol#L899)<br>\n[AlchemistV2.sol#L1625](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemistV2.sol#L1625)<br>\n\nIt is possible for the contract to become stuck and unable to perform any actions if the `totalShares` of a yield token fall to zero while there is some `pendingCredit` still to be paid.\n\nIt will then be impossible to call deposit or withdraw functions, mints, burns, repay, liquidate, donate or harvest due to division by zero reverts in:\n\n*   `_distributeCredit()`\n*   `_distributeUnlockedCredit()`\n*   `_calculateUnrealizedDebt()`\n*   `_convertSharesToYieldTokens()`\n*   `donate()`\n\nFurthermore, any `pendingCredit` amount of tokens are still in the contract will become permanently stuck.\n\n### Proof of Concept\n\nThis case may arise under the follow steps\na) `deposit()` is called by a user then time passes to earn some yield\nb) `harvest()` is called by the keeper which calls `_distributeCredit()` and increases `pendingCredit`\nc) `withdraw()` is called by the user to withdraw all funds\n\nSince there is `pendingCredit` the following will have a non-zero balance for `unlockedCredit` however `yieldTokenParams.totalShares` is zero and thus we get a division by zero which reverts the entire transaction.\n\n```solidity\n    function _distributeUnlockedCredit(address yieldToken) internal {\n        YieldTokenParams storage yieldTokenParams = _yieldTokens[yieldToken];\n\n\n        uint256 unlockedCredit = _calculateUnlockedCredit(yieldToken);\n        if (unlockedCredit == 0) {\n            return;\n        }\n\n\n        yieldTokenParams.accruedWeight     += unlockedCredit * FIXED_POINT_SCALAR / yieldTokenParams.totalShares;\n        yieldTokenParams.distributedCredit += unlockedCredit;\n    }\n```\n\nEach of the other listed functions will reach the same issue by attempting to divide some numerator by the `totalShares` which is zero.\n\n### Recommended Mitigation Steps\n\nConsider preventing `totalShares` from over becoming zero once it is set. That is enforce a user to leave at least 1 unit if they are the last user to withdraw.\n\nAnother option is to transfer the first 1000 shares to a \"burn\" account (e.g. 0x000...01), when the first user deposits.\n\nAlternatively, when the last user withdraws, transfer all pending credit to this user and set the required variables to zero to replicate the state before any users have deposited.\n\n**[0xfoobar (Alchemix) confirmed, disagreed with severity and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/104#issuecomment-1133988067):**\n > Disagree with severity because given the depth of distinct users using Alchemix, it is unlikely this scenario would occur.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/104#issuecomment-1146196263):**\n > This is an interesting issue. At the moment, it sits somewhere between medium and high risk, so I will need to think about this more before coming to a decision.\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/104#issuecomment-1150102500):**\n > After further thought, I think this does not fit the criteria of high severity for the following reasons:\n>  - The protocol can be DoS'd on new deployments via front-running, but it does not lead to lost funds by users. It'd only require a new deployment by the Alchemist team.\n>  - If the protocol was to migrate to a new version of the protocol, a mass withdrawal event could lead to locked `pendingCredit`. However, because rewards are harvested by a keeper, I believe this to be unlikely as migrations will most certainly be coordinated by the protocol and its keepers. As such, users will be aware that they would miss out on rewards if the keeper does not harvest rewards prior to the migration.\n>  - Rewards are regularly harvested by the keeper, and as such, the value at risk is somewhat negligible.\n> \n> For these reasons, I believe medium severity to be justified.\n\n\n\n***\n\n## [[M-17] Debt can be repaid with a depegged underlyingToken, which can be exploited by arbitrageurs and drives the market price of alToken to match the worst depegged underlyingToken](https://github.com/code-423n4/2022-05-alchemix-findings/issues/161)\n_Submitted by WatchPug_\n\n[AlchemistV2.sol#L1679-L1682](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemistV2.sol#L1679-L1682)<br>\n\n```solidity\nfunction _normalizeUnderlyingTokensToDebt(address underlyingToken, uint256 amount) internal view returns (uint256) {\n    return amount * _underlyingTokens[underlyingToken].conversionFactor;\n}\n```\n\n[AlchemistV2.sol#L743-L786](https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemistV2.sol#L743-L786)<br>\n\n```solidity\nfunction repay(address underlyingToken, uint256 amount, address recipient) external override lock returns (uint256) {\n    ...\n    uint256 credit = _normalizeUnderlyingTokensToDebt(underlyingToken, actualAmount);\n\n    // Update the recipient's debt.\n    _updateDebt(recipient, -SafeCast.toInt256(credit));\n    ...\n```\n\nWhen repaying the debt with an `underlyingToken`, the amount in terms of the `underlyingToken` (adjusted for decimals) will always be taken in a 1:1 ratio/price for the subtrahend of the debt.\n\nWe believe this design is flawed and be exploited by arbitrageurs and eventually drives the market price of alToken to match the worst depegged underlyingToken.\n\nBecause if `alToken` is trading at a higher price against the depegged underlyingToken, the arbitrageur can always mint alToken and market sell for more depegged underlyingToken and repay the debt.\n\n### Proof of Concept\n\nGiven:\n\n*   alUSD is trading at $1\n*   minimumCollateralization: 4/3\n\n###### When USDT is slightly depegged, and trading at `$0.9`:\n\nAn arbitrageur can:\n\n1.  Deposit `100M USDC` as collateral and mint `75M alUSD` (100\\*0.75);\n2.  Market buy `75M USDT` with `67.5M alUSD` (75\\*0.9) and repay the debt;\n3.  Withdraw the `100M USDC` collateral;\n4.  Dump the remaining `7.5M alUSD` (75-67.5) for profit.\n\nThis can be repeated until the market price of alUSD drops to `$0.9`, the same price as USDT.\n\n### Recommendation\n\nConsider updating the `repay()` function and change to market buy using the underlyingToken to alToken and then `burn()` the alToken to reduce debt.\n\n**[0xfoobar (Alchemix) acknowledged, disagreed with severity and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/161#issuecomment-1133953254):**\n\n> This is a core design choice underlying the Alchemix system. Like-kind collateral and debt assumes that assets will hold their relationship. The onus lies on governance to choose safe collateral assets.\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/161#issuecomment-1150112042):**\n > I agree with what was raised by the warden but disagree with the associated severity. Because user's assets are tied to the underlying collateral, it makes sense that the a depegged token would be reflected in the price of `alToken`. As a result, arbitrageurs are free to profit off this by driving the price of `alToken` down to its true value. \n> \n> I consider this to be medium risk because of an unlikely assumption made when considering the likelihood of a depeg event. Assets are not at direct risk, but value can be leaked under certain assumptions.\n\n\n\n***\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 46 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-05-alchemix-findings/issues/228) by **IllIllI** received the top score from the judge.\n\n*The following wardens also submitted reports: [GimelSec](https://github.com/code-423n4/2022-05-alchemix-findings/issues/193), [AuditsAreUS](https://github.com/code-423n4/2022-05-alchemix-findings/issues/103), [0x1f8b](https://github.com/code-423n4/2022-05-alchemix-findings/issues/86), [0xsomeone](https://github.com/code-423n4/2022-05-alchemix-findings/issues/119), [0xDjango](https://github.com/code-423n4/2022-05-alchemix-findings/issues/201), [joestakey](https://github.com/code-423n4/2022-05-alchemix-findings/issues/177), [TerrierLover](https://github.com/code-423n4/2022-05-alchemix-findings/issues/223), [cccz](https://github.com/code-423n4/2022-05-alchemix-findings/issues/126), [fatherOfBlocks](https://github.com/code-423n4/2022-05-alchemix-findings/issues/221), [hyh](https://github.com/code-423n4/2022-05-alchemix-findings/issues/136), [robee](https://github.com/code-423n4/2022-05-alchemix-findings/issues/94), [Ruhum](https://github.com/code-423n4/2022-05-alchemix-findings/issues/62), [shenwilly](https://github.com/code-423n4/2022-05-alchemix-findings/issues/146), [WatchPug](https://github.com/code-423n4/2022-05-alchemix-findings/issues/165), [csanuragjain](https://github.com/code-423n4/2022-05-alchemix-findings/issues/46), [jayjonah8](https://github.com/code-423n4/2022-05-alchemix-findings/issues/70), [MaratCerby](https://github.com/code-423n4/2022-05-alchemix-findings/issues/50), [BowTiedWardens](https://github.com/code-423n4/2022-05-alchemix-findings/issues/215), [horsefacts](https://github.com/code-423n4/2022-05-alchemix-findings/issues/218), [sikorico](https://github.com/code-423n4/2022-05-alchemix-findings/issues/90), [tintin](https://github.com/code-423n4/2022-05-alchemix-findings/issues/168), [catchup](https://github.com/code-423n4/2022-05-alchemix-findings/issues/142), [cryptphi](https://github.com/code-423n4/2022-05-alchemix-findings/issues/211), [ellahi](https://github.com/code-423n4/2022-05-alchemix-findings/issues/130), [oyc_109](https://github.com/code-423n4/2022-05-alchemix-findings/issues/84), [Picodes](https://github.com/code-423n4/2022-05-alchemix-findings/issues/179), [throttle](https://github.com/code-423n4/2022-05-alchemix-findings/issues/204), [BouSalman](https://github.com/code-423n4/2022-05-alchemix-findings/issues/116), [0x4non](https://github.com/code-423n4/2022-05-alchemix-findings/issues/96), [bobirichman](https://github.com/code-423n4/2022-05-alchemix-findings/issues/92), [Cityscape](https://github.com/code-423n4/2022-05-alchemix-findings/issues/167), [delfin454000](https://github.com/code-423n4/2022-05-alchemix-findings/issues/133), [mics](https://github.com/code-423n4/2022-05-alchemix-findings/issues/82), [MiloTruck](https://github.com/code-423n4/2022-05-alchemix-findings/issues/173), [simon135](https://github.com/code-423n4/2022-05-alchemix-findings/issues/138), [0xNazgul](https://github.com/code-423n4/2022-05-alchemix-findings/issues/57), [Funen](https://github.com/code-423n4/2022-05-alchemix-findings/issues/154), [0xkatana](https://github.com/code-423n4/2022-05-alchemix-findings/issues/125), [hake](https://github.com/code-423n4/2022-05-alchemix-findings/issues/65), [Hawkeye](https://github.com/code-423n4/2022-05-alchemix-findings/issues/226), [JC](https://github.com/code-423n4/2022-05-alchemix-findings/issues/212), [kebabsec](https://github.com/code-423n4/2022-05-alchemix-findings/issues/200), [kenta](https://github.com/code-423n4/2022-05-alchemix-findings/issues/152), [samruna](https://github.com/code-423n4/2022-05-alchemix-findings/issues/101), and [Waze](https://github.com/code-423n4/2022-05-alchemix-findings/issues/175).*\n\n## Summary\n\n### Low Risk Issues\n\n|    | Issue                                                                                                                       | Instances |\n| -- | :-------------------------------------------------------------------------------------------------------------------------- | ------- |\n| 1  | Latent funds can be stolen                                                                                                  |     1     |\n| 2  | Low level calls don't check for contract existence                                                                          |     1     |\n| 3  | Set sane maximums for input parameters                                                                                      |     2     |\n| 4  | Behavior described by comment is incomplete                                                                                 |     1     |\n| 5  | Unsafe use of `transfer()`/`transferFrom()` with `IERC20`                                                                   |     4     |\n| 6  | Return values of `transfer()`/`transferFrom()` not checked                                                                  |     2     |\n| 7  | Unused/empty `receive()` function                                                                                           |     2     |\n| 8  | `safeApprove()` is deprecated                                                                                               |     32    |\n| 9  | Missing checks for `address(0x0)` when assigning values to `address` state variables                                        |     24    |\n| 10 | `abi.encodePacked()` should not be used with dynamic types when passing the result to a hash function such as `keccak256()` |     1     |\n| 11 | Upgradeable contract is missing a `__gap[50]` storage variable to allow for new storage variables in later versions         |     3     |\n\nTotal: 73 instances over 11 issues\n\n### Non-critical Issues\n\n|    | Issue                                                                                                                           | Instances |\n| -- | :------------------------------------------------------------------------------------------------------------------------------ | ------- |\n| 1  | Adding a `return` statement when the function defines a named return variable, is redundant                                     |     4     |\n| 2  | `override` function arguments that are unused should have the variable name removed or commented out to avoid compiler warnings |     1     |\n| 3  | `public` functions not called by the contract should be declared `external` instead                                             |     12    |\n| 4  | `2**<n> - 1` should be re-written as `type(uint<n>).max`                                                                        |     1     |\n| 5  | `constant`s should be defined rather than using magic numbers                                                                   |     20    |\n| 6  | Redundant cast                                                                                                                  |     4     |\n| 7  | Numeric values having to do with time should use time units for readability                                                     |     1     |\n| 8  | Missing event for critical parameter change                                                                                     |     3     |\n| 9  | Use a more recent version of solidity                                                                                           |     12    |\n| 10 | Use a more recent version of solidity                                                                                           |     1     |\n| 11 | Use scientific notation (e.g. `1e18`) rather than exponentiation (e.g. `10**18`)                                                |     2     |\n| 12 | Inconsistent spacing in comments                                                                                                |     11    |\n| 13 | Non-library/interface files should use fixed compiler versions, not floating ones                                               |     16    |\n| 14 | Typos                                                                                                                           |     12    |\n| 15 | File does not contain an SPDX Identifier                                                                                        |     32    |\n| 16 | File is missing NatSpec                                                                                                         |     27    |\n| 17 | NatSpec is incomplete                                                                                                           |     17    |\n| 18 | Event is missing `indexed` fields                                                                                               |    111    |\n| 19 | Use allowlist/denylist rather than blacklist/whitelist                                                                          |     1     |\n\nTotal: 288 instances over 19 issues\n\n## [L-01] Latent funds can be stolen\n\nIf someone manages, through either a bug or a mistake (self-destructing and sending funds to the contract), another user can claim the funds as their own. Measure the balance before and after, and use the difference, rather than measuring the total balance of the contract\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: contracts-full/WETHGateway.sol   #1\n\n70           IAlchemistV2(alchemist).withdrawUnderlyingFrom(msg.sender, yieldToken, shares, address(this), minimumAmountOut);\n71   \n72           uint256 amount = WETH.balanceOf(address(this));\n73           WETH.withdraw(amount);\n74   \n75:          (bool success, ) = recipient.call{value: amount}(new bytes(0));\n```\n\n<https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/WETHGateway.sol#L70-L75>\n\n## [L-02] Low level calls don't check for contract existence\n\nLow level calls return success if called on a destructed contract. See OpenZeppelin's Address.so which checks address.code.length\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: contracts-full/libraries/TokenUtils.sol   #1\n\n65       function safeTransfer(address token, address recipient, uint256 amount) internal {\n66           (bool success, bytes memory data) = token.call(\n67               abi.encodeWithSelector(IERC20Minimal.transfer.selector, recipient, amount)\n68:          );\n```\n\n<https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/libraries/TokenUtils.sol#L65-L68>\n\n## [L-03] Set sane maximums for input parameters\n\nThere should be an upper limit to reasonable fees\n\n*There are 2 instances of this issue.*\n\n**For further details on this (and the warden's other findings with multiple instances), please see their [full report](https://github.com/code-423n4/2022-05-alchemix-findings/issues/228)**\n\n## [L-04] Behavior described by comment is incomplete\n\nThe event is not emitted when the fee is updated the first time (in the constructor)\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: contracts-full/AlchemicTokenV2.sol   #1\n\n50     /// @notice An event which is emitted when the flash mint fee is updated.\n51     ///\n52     /// @param fee The new flash mint fee.\n53     event SetFlashMintFee(uint256 fee);\n54   \n55     constructor(string memory _name, string memory _symbol, uint256 _flashFee) ERC20(_name, _symbol) {\n56       _setupRole(ADMIN_ROLE, msg.sender);\n57       _setupRole(SENTINEL_ROLE, msg.sender);\n58       _setRoleAdmin(SENTINEL_ROLE, ADMIN_ROLE);\n59       _setRoleAdmin(ADMIN_ROLE, ADMIN_ROLE);\n60       flashMintFee = _flashFee;\n61:    }\n```\n\n<https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemicTokenV2.sol#L50-L61>\n\n## [L-05] Unsafe use of `transfer()`/`transferFrom()` with `IERC20`\n\nSome tokens do not implement the ERC20 standard properly but are still accepted by most code that accepts ERC20 tokens.  For example Tether (USDT)'s `transfer()` and `transferFrom()` functions do not return booleans as the specification requires, and instead have no return value. When these sorts of tokens are cast to `IERC20`, their function signatures do not match and therefore the calls made, revert. Use OpenZeppelin’s `SafeERC20`'s `safeTransfer()`/`safeTransferFrom()` instead\n\n*There are 4 instances of this issue.*\n\n## [L-06] Return values of `transfer()`/`transferFrom()` not checked\n\nNot all `IERC20` implementations `revert()` when there's a failure in `transfer()`/`transferFrom()`. The function signature has a `boolean` return value and they indicate errors that way instead. By not checking the return value, operations that should have marked as failed, may potentially go through without actually making a payment\n\n*There are 2 instances of this issue.*\n\n## [L-07] Unused/empty `receive()` function\n\nIf the intention is for the Ether to be used, the function should call another function, otherwise it should revert\n\n*There are 2 instances of this issue.*\n\n## [L-08] `safeApprove()` is deprecated\n\n[Deprecated](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/bfff03c0d2a59bcd8e2ead1da9aed9edf0080d05/contracts/token/ERC20/utils/SafeERC20.sol#L38-L45) in favor of `safeIncreaseAllowance()` and `safeDecreaseAllowance()`. If only setting the initial allowance to the value that means infinite, `safeIncreaseAllowance()` can be used instead\n\n*There are 32 instances of this issue.*\n\n## [L-09] Missing checks for `address(0x0)` when assigning values to `address` state variables\n\n*There are 24 instances of this issue.*\n\n## [L-10] `abi.encodePacked()` should not be used with dynamic types when passing the result to a hash function such as `keccak256()`\n\nUse `abi.encode()` instead which will pad items to 32 bytes, which will [prevent hash collisions](https://docs.soliditylang.org/en/v0.8.13/abi-spec.html#non-standard-packed-mode) (e.g. `abi.encodePacked(0x123,0x456)` => `0x123456` => `abi.encodePacked(0x1,0x23456)`, but `abi.encode(0x123,0x456)` => `0x0...1230...456`). \"Unless there is a compelling reason, `abi.encode` should be preferred\". If there is only one argument to `abi.encodePacked()` it can often be cast to `bytes()` or `bytes32()` [instead](https://ethereum.stackexchange.com/questions/30912/how-to-compare-strings-in-solidity#answer-82739).\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: contracts-full/libraries/RocketPool.sol   #1\n\n14:               keccak256(abi.encodePacked(\"contract.address\", \"rocketTokenRETH\"))\n```\n\n<https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/libraries/RocketPool.sol#L14>\n\n## [L-11] Upgradeable contract is missing a `__gap[50]` storage variable to allow for new storage variables in later versions\n\nSee [this](https://docs.openzeppelin.com/contracts/4.x/upgradeable#storage_gaps) link for a description of this storage variable. While some contracts may not currently be sub-classed, adding the variable now protects against forgetting to add it in the future.\n\n*There are 3 instances of this issue.*\n\n## [N-01] Adding a `return` statement when the function defines a named return variable, is redundant\n\n*There are 4 instances of this issue.*\n\n## [N-02] `override` function arguments that are unused should have the variable name removed or commented out to avoid compiler warnings\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: contracts-full/AutoleverageCurveMetapool.sol   #1\n\n20:       function _maybeConvertCurveOutput(uint256 amountOut) internal override {}\n```\n\n<https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/AutoleverageCurveMetapool.sol#L20>\n\n## [N-03] `public` functions not called by the contract should be declared `external` instead\n\nContracts [are allowed](https://docs.soliditylang.org/en/latest/contracts.html#function-overriding) to override their parents' functions and change the visibility from `external` to `public`.\n\n*There are 12 instances of this issue.*\n\n## [N-04] `2**<n> - 1` should be re-written as `type(uint<n>).max`\n\nEarlier versions of solidity can use `uint<n>(-1)` instead. Expressions not including the `- 1` can often be re-written to accomodate the change (e.g. by using a `>` rather than a `>=`, which will also save some gas)\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: contracts-full/libraries/SafeCast.sol   #1\n\n13:       if (y >= 2**255) {\n```\n\n<https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/libraries/SafeCast.sol#L13>\n\n## [N-05] `constant`s should be defined rather than using magic numbers\n\n*There are 20 instances of this issue.*\n\n## [N-06] Redundant cast\n\nThe type of the variable is the same as the type to which the variable is being cast\n\n*There are 4 instances of this issue.*\n\n## [N-07] Numeric values having to do with time should use time units for readability\n\nThere are [units](https://docs.soliditylang.org/en/latest/units-and-global-variables.html#time-units) for seconds, minutes, hours, days, and weeks\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: contracts-full/libraries/Limiters.sol   #1\n\n12:       uint256 constant public MAX_COOLDOWN_BLOCKS = 7200;\n```\n\n<https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/libraries/Limiters.sol#L12>\n\n## [N-08] Missing event for critical parameter change\n\n*There are 3 instances of this issue.*\n\n## [N-09] Use a more recent version of solidity\n\nUse a solidity version of at least 0.8.13 to get the ability to use `using for` with a list of free functions\n\n*There are 12 instances of this issue.*\n\n## [N-10] Use a more recent version of solidity\n\nUse a solidity version of at least 0.8.4 to get `bytes.concat()` instead of `abi.encodePacked(<bytes>,<bytes>)`\nUse a solidity version of at least 0.8.12 to get `string.concat()` instead of `abi.encodePacked(<str>,<str>)`\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: contracts-full/libraries/RocketPool.sol   #1\n\n1:    pragma solidity >=0.5.0;\n```\n\n<https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/libraries/RocketPool.sol#L1>\n\n## [N-11] Use scientific notation (e.g. `1e18`) rather than exponentiation (e.g. `10**18`)\n\n*There are 2 instances of this issue.*\n\n## [N-12] Inconsistent spacing in comments\n\nSome lines use `// x` and some use `//x`. The instances below point out the usages that don't follow the majority, within each file\n\n*There are 11 instances of this issue.*\n\n## [N-13] Non-library/interface files should use fixed compiler versions, not floating ones\n\n*There are 16 instances of this issue.*\n\n## [N-14] Typos\n\n*There are 12 instances of this issue.*\n\n## [N-15] File does not contain an SPDX Identifier\n\n*There are 32 instances of this issue.*\n\n## [N-16] File is missing NatSpec\n\n*There are 27 instances of this issue.*\n\n## [N-17] NatSpec is incomplete\n\n*There are 17 instances of this issue.*\n\n## [N-18] Event is missing `indexed` fields\n\nEach `event` should use three `indexed` fields if there are three or more fields\n\n*There are 111 instances of this issue.*\n\n## [N-19] Use allowlist/denylist rather than blacklist/whitelist\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: contracts-full/AlchemicTokenV1.sol   #1\n\n110:   function setBlacklist(address minter) external onlySentinel {\n```\n\n<https://github.com/code-423n4/2022-05-alchemix/blob/de65c34c7b6e4e94662bf508e214dcbf327984f4/contracts-full/AlchemicTokenV1.sol#L110>\n\n**[0xfoobar (Alchemix) commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/228#issuecomment-1140785384):**\n > Incredibly comprehensive, great writeup\n\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 46 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-05-alchemix-findings/issues/28) by **IllIllI** received the top score from the judge.\n\n*The following wardens also submitted reports: [BowTiedWardens](https://github.com/code-423n4/2022-05-alchemix-findings/issues/137), [joestakey](https://github.com/code-423n4/2022-05-alchemix-findings/issues/171), [0xkatana](https://github.com/code-423n4/2022-05-alchemix-findings/issues/124), [AlleyCat](https://github.com/code-423n4/2022-05-alchemix-findings/issues/32), [mics](https://github.com/code-423n4/2022-05-alchemix-findings/issues/81), [WatchPug](https://github.com/code-423n4/2022-05-alchemix-findings/issues/164), [0x4non](https://github.com/code-423n4/2022-05-alchemix-findings/issues/95), [0xNazgul](https://github.com/code-423n4/2022-05-alchemix-findings/issues/56), [simon135](https://github.com/code-423n4/2022-05-alchemix-findings/issues/139), [fatherOfBlocks](https://github.com/code-423n4/2022-05-alchemix-findings/issues/220), [robee](https://github.com/code-423n4/2022-05-alchemix-findings/issues/93), [samruna](https://github.com/code-423n4/2022-05-alchemix-findings/issues/100), [sashik_eth](https://github.com/code-423n4/2022-05-alchemix-findings/issues/214), [TerrierLover](https://github.com/code-423n4/2022-05-alchemix-findings/issues/224), [_Adam](https://github.com/code-423n4/2022-05-alchemix-findings/issues/216), [0x1f8b](https://github.com/code-423n4/2022-05-alchemix-findings/issues/85), [0xf15ers](https://github.com/code-423n4/2022-05-alchemix-findings/issues/148), [0xsomeone](https://github.com/code-423n4/2022-05-alchemix-findings/issues/118), [catchup](https://github.com/code-423n4/2022-05-alchemix-findings/issues/143), [ellahi](https://github.com/code-423n4/2022-05-alchemix-findings/issues/129), [Funen](https://github.com/code-423n4/2022-05-alchemix-findings/issues/153), [GimelSec](https://github.com/code-423n4/2022-05-alchemix-findings/issues/195), [MiloTruck](https://github.com/code-423n4/2022-05-alchemix-findings/issues/172), [oyc_109](https://github.com/code-423n4/2022-05-alchemix-findings/issues/83), [Tomio](https://github.com/code-423n4/2022-05-alchemix-findings/issues/145), [0xDjango](https://github.com/code-423n4/2022-05-alchemix-findings/issues/202), [csanuragjain](https://github.com/code-423n4/2022-05-alchemix-findings/issues/45), [hake](https://github.com/code-423n4/2022-05-alchemix-findings/issues/66), [hansfriese](https://github.com/code-423n4/2022-05-alchemix-findings/issues/169), [Hawkeye](https://github.com/code-423n4/2022-05-alchemix-findings/issues/225), [ignacio](https://github.com/code-423n4/2022-05-alchemix-findings/issues/110), [MaratCerby](https://github.com/code-423n4/2022-05-alchemix-findings/issues/49), [sikorico](https://github.com/code-423n4/2022-05-alchemix-findings/issues/89), [Waze](https://github.com/code-423n4/2022-05-alchemix-findings/issues/174), [0v3rf10w](https://github.com/code-423n4/2022-05-alchemix-findings/issues/197), [Fitraldys](https://github.com/code-423n4/2022-05-alchemix-findings/issues/188), [horsefacts](https://github.com/code-423n4/2022-05-alchemix-findings/issues/219), [kenta](https://github.com/code-423n4/2022-05-alchemix-findings/issues/151), [Randyyy](https://github.com/code-423n4/2022-05-alchemix-findings/issues/176), [throttle](https://github.com/code-423n4/2022-05-alchemix-findings/issues/205), [UnusualTurtle](https://github.com/code-423n4/2022-05-alchemix-findings/issues/196), [augustg](https://github.com/code-423n4/2022-05-alchemix-findings/issues/105), [bobirichman](https://github.com/code-423n4/2022-05-alchemix-findings/issues/91), [Cityscape](https://github.com/code-423n4/2022-05-alchemix-findings/issues/170), and [JC](https://github.com/code-423n4/2022-05-alchemix-findings/issues/213).*\n\n## [G-01] Remove or replace unused state variables\n\nSaves a storage slot. If the variable is assigned a non-zero value, saves Gsset (20000 gas). If it's assigned a zero value, saves Gsreset (2900 gas). If the variable remains unassigned, there is no gas savings. If the state variable is overriding an interface's public function, mark the variable as `constant` or `immutable` so that it does not use a storage slot, and manually add a getter function\n\n**For further details on this (and the warden's other gas optimizations), please see their [full report](https://github.com/code-423n4/2022-05-alchemix-findings/issues/28).**\n\n## [G-02] Multiple `address` mappings can be combined into a single `mapping` of an `address` to a `struct`, where appropriate\n\nSaves a storage slot for the mapping. Depending on the circumstances and sizes of types, can avoid a Gsset (20000 gas) per mapping combined. Reads and subsequent writes can also be cheaper when a function requires both values and they both fit in the same storage slot\n\n## [G-03] State variables only set in the constructor should be declared `immutable`\n\nAvoids a Gsset (20000 gas) in the constructor, and replaces each Gwarmacces (100 gas) with a `PUSH32` (3 gas). If getters are still desired, '\\_' can be added to the variable name and the getter can be added manually\n\n## [G-04] Structs can be packed into fewer storage slots\n\nEach slot saved can avoid an extra Gsset (20000 gas) for the first setting of the struct. Subsequent reads as well as writes have smaller gas savings\n\n## [G-05] Using `calldata` instead of `memory` for read-only arguments in `external` functions saves gas\n\nWhen a function with a `memory` array is called externally, the `abi.decode()` step has to use a for-loop to copy each index of the `calldata` to the `memory` index. Each iteration of this for-loop costs at least 60 gas (i.e. `60 * <mem_array>.length`). Using `calldata` directly, obliviates the need for such a loop in the contract code and runtime execution. Structs have the same overhead as an array of length one\n\n## [G-06] State variables should be cached in stack variables rather than re-reading them from storage\n\nThe instances (outlined in the warden's [full report](https://github.com/code-423n4/2022-05-alchemix-findings/issues/228)) point to the second+ access of a state variable within a function. Caching will replace each Gwarmaccess (100 gas) with a much cheaper stack read.\nLess obvious fixes/optimizations include having local storage variables of mappings within state variable mappings or mappings within state variable structs, having local storage variables of structs within mappings, having local memory caches of state variable structs, or having local caches of state variable contracts/addresses.\n\n## [G-07] The result of external function calls should be cached rather than re-calling the function\n\nThe instances (outlined in the warden's [full report](https://github.com/code-423n4/2022-05-alchemix-findings/issues/228)) point to the second+ call of the function within a single function\n\n## [G-08] `<x> += <y>` costs more gas than `<x> = <x> + <y>` for state variables\n\n## [G-09] `internal` functions only called once can be inlined to save gas\n\nNot inlining costs 20 to 40 gas because of two extra `JUMP` instructions and additional stack operations needed for function calls.\n\n## [G-10] `<array>.length` should not be looked up in every loop of a `for`-loop\n\nThe overheads outlined below are *PER LOOP*, excluding the first loop\n\n*   storage arrays incur a Gwarmaccess (100 gas)\n*   memory arrays use `MLOAD` (3 gas)\n*   calldata arrays use `CALLDATALOAD` (3 gas)\n\nCaching the length changes each of these to a `DUP<N>` (3 gas), and gets rid of the extra `DUP<N>` needed to store the stack offset\n\n## [G-11] `++i`/`i++` should be `unchecked{++i}`/`unchecked{++i}` when it is not possible for them to overflow, as is the case when used in `for`- and `while`-loops\n\nThe `unchecked` keyword is new in solidity version 0.8.0, so this only applies to that version or higher, which these instances are. This saves 30-40 gas [*PER LOOP*](https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#the-increment-in-for-loop-post-condition-can-be-made-unchecked)\n\n## [G-12] `require()`/`revert()` strings longer than 32 bytes cost extra gas\n\n## [G-13] `private` functions not called by the contract should be removed to save deployment gas\n\n## [G-14] Not using the named return variables when a function returns, wastes deployment gas\n\n## [G-15] Remove unused local variable\n\n```solidity\nFile: contracts-full/TransmuterBuffer.sol   #1\n\n515           (uint256 availableShares, uint256 lastAccruedWeight) = IAlchemistV2(alchemist).positions(address(this), token);\n```\n\n<https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/TransmuterBuffer.sol#L515>\n\n## [G-16] Using `bool`s for storage incurs overhead\n\n```solidity\n    // Booleans are more expensive than uint256 or any type that takes up a full\n    // word because each write operation emits an extra SLOAD to first read the\n    // slot's contents, replace the bits taken up by the boolean, and then write\n    // back. This is the compiler's defense against contract upgrades and\n    // pointer aliasing, and it cannot be disabled.\n```\n\n<https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27><br>\nUse `uint256(1)` and `uint256(2)` for true/false\n\n## [G-17] Use a more recent version of solidity\n\nUse a solidity version of at least 0.8.0 to get overflow protection without `SafeMath`\nUse a solidity version of at least 0.8.2 to get compiler automatic inlining\nUse a solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads\nUse a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than `revert()/require()` strings\nUse a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value\n\n## [G-18] Use a more recent version of solidity\n\nUse a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value\n\n```solidity\nFile: contracts-full/libraries/SafeERC20.sol   #1\n\n2   pragma solidity >=0.8.4;\n```\n\n<https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/libraries/SafeERC20.sol#L2>\n\n## [G-19] Use a more recent version of solidity\n\nUse a solidity version of at least 0.8.2 to get compiler automatic inlining\nUse a solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads\nUse a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than `revert()/require()` strings\nUse a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value\n\n```solidity\nFile: contracts-full/interfaces/external/IProxyAdmin.sol   #1\n\n3   pragma solidity ^0.8.0;\n```\n\n<https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/interfaces/external/IProxyAdmin.sol#L3>\n\n## [G-20] It costs more gas to initialize variables to zero than to let the default of zero be applied\n\n## [G-21] `internal` functions not called by the contract should be removed to save deployment gas\n\nIf the functions are required by an interface, the contract should inherit from that interface and use the `override` keyword\n\n## [G-22] `++i` costs less gas than `++i`, especially when it's used in `for`-loops (`--i`/`i--` too)\n\nSaves 6 gas *PER LOOP*\n\n## [G-23] Usage of `uints`/`ints` smaller than 32 bytes (256 bits) incurs overhead\n\n> When using elements that are smaller than 32 bytes, your contract’s gas usage may be higher. This is because the EVM operates on 32 bytes at a time. Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.\n\n## [G-24] `abi.encode()` is less efficient than `abi.encodePacked()`\n\n```solidity\nFile: contracts-full/AutoleverageBase.sol   #1\n\n102           bytes memory params = abi.encode(Details({\n103               pool: pool,\n104               poolInputIndex: poolInputIndex,\n105               poolOutputIndex: poolOutputIndex,\n106               alchemist: alchemist,\n107               yieldToken: yieldToken,\n108               recipient: msg.sender,\n109               targetDebt: targetDebt\n110           }));\n```\n\n<https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/AutoleverageBase.sol#L102-L110>\n\n## [G-25] Expressions for constant values such as a call to `keccak256()`, should use `immutable` rather than `constant`\n\nSee [this](https://github.com/ethereum/solidity/issues/9232) issue for a detail description of the issue\n\n## [G-26] Using `private` rather than `public` for constants, saves gas\n\nIf needed, the value can be read from the verified contract source code. Savings are due to the compiler not having to create non-payable getter functions for deployment calldata, and not adding another entry to the method ID table\n\n## [G-27] Don't use `SafeMath` once the solidity version is 0.8.0 or greater\n\nVersion 0.8.0 introduces internal overflow checks, so using `SafeMath` is redundant and adds overhead\n\n```solidity\nFile: contracts-full/TransmuterBuffer.sol   #1\n\n7   import \"@openzeppelin/contracts/utils/math/SafeMath.sol\";\n```\n\n<https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/TransmuterBuffer.sol#L7>\n\n## [G-28] Duplicated `require()`/`revert()` checks should be refactored to a modifier or function\n\nSaves deployment costs\n\n```solidity\nFile: contracts-full/gALCX.sol   #1\n\n107           require(success, \"Transfer failed\");\n```\n\n<https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/gALCX.sol#L107>\n\n## [G-29] Multiplication/division by two should use bit shifting\n\n`<x> * 2` is equivalent to `<x> << 1` and `<x> / 2` is the same as `<x> >> 1`. The `MUL` and `DIV` opcodes cost 5 gas, whereas `SHL` and `SHR` only cost 3 gas\n\n```solidity\nFile: contracts-full/ThreePoolAssetManager.sol   #1\n\n355               if ((examineBalance = (v.maximum + v.minimum) / 2) == previousBalance) break;\n```\n\n<https://github.com/code-423n4/2022-05-alchemix/blob/71abbe683dfd5c0686b7e594fb4f78a14b668d8b/contracts-full/ThreePoolAssetManager.sol#L355>\n\n## [G-30] Empty blocks should be removed or emit something\n\nThe code should be refactored such that they no longer exist, or the block should do something useful, such as emitting an event or reverting. If the block is an empty if-statement block to avoid doing subsequent checks in the else-if/else conditions, the else-if/else conditions should be nested under the negation of the if-statement, because they involve different classes of checks, which may lead to the introduction of errors when the code is later modified (`if(x){}else if(y){...}else{...}` => `if(!x){if(y){...}else{...}}`)\n\n## [G-31] Use custom errors rather than `revert()`/`require()` strings to save deployment gas\n\nCustom errors are available from solidity version 0.8.4. The instances below match or exceed that version\n\n## [G-32] Functions guaranteed to revert when called by normal users can be marked `payable`\n\nIf a function modifier such as `onlyOwner` is used, the function will revert if a normal user tries to pay the function. Marking the function as `payable` will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are\n`CALLVALUE`(2),`DUP1`(3),`ISZERO`(3),`PUSH2`(3),`JUMPI`(10),`PUSH1`(3),`DUP1`(3),`REVERT`(0),`JUMPDEST`(1),`POP`(2), which costs an average of about 21 gas per call to the function, in addition to the extra deployment cost\n\n## [G-33] `public` functions not called by the contract should be declared `external` instead\n\nContracts [are allowed](https://docs.soliditylang.org/en/latest/contracts.html#function-overriding) to override their parents' functions and change the visibility from `external` to `public` and can save gas by doing so.\n\n**[0xfoobar (Alchemix) commented](https://github.com/code-423n4/2022-05-alchemix-findings/issues/28#issuecomment-1140784192):**\n > Incredibly comprehensive, great work with the explanations and detailed line number links\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}