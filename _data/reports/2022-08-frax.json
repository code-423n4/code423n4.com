{
  "circa": {
    "title": "Fraxlend (Frax Finance) contest",
    "sponsor": "Frax Finance",
    "slug": "2022-08-frax",
    "date": "2023-01-13",
    "findings": "https://github.com/code-423n4/2022-08-frax-findings/issues",
    "contest": 153
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Fraxlend (Frax Finance) smart contract system written in Solidity. The audit contest took place between August 12—August 17 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>136 Wardens contributed reports to the Fraxlend (Frax Finance) contest:</p>\n<ol>\n<li>0xA5DF</li>\n<li>Lambda</li>\n<li><a href=\"https://twitter.com/berndartmueller\">berndartmueller</a></li>\n<li>0x1f8b</li>\n<li>auditor0517</li>\n<li>CertoraInc (egjlmn1, <a href=\"https://twitter.com/ori_dabush\">OriDabush</a>, ItayG, shakedwinder and RoiEvenHaim)</li>\n<li>cccz</li>\n<li><a href=\"https://www.linkedin.com/in/pavel-anokhin/\">panprog</a></li>\n<li>IllIllI</li>\n<li>__141345__</li>\n<li>0x52</li>\n<li><a href=\"http://seanseefried.org/blog\">sseefried</a></li>\n<li>rbserver</li>\n<li>cryptphi</li>\n<li>brgltd</li>\n<li>reassor</li>\n<li>0xDjango</li>\n<li><a href=\"https://twitter.com/CAA1994\">carlitox477</a></li>\n<li>_Adam</li>\n<li>Rolezn</li>\n<li><a href=\"https://t.me/pfahard\">pfapostol</a></li>\n<li><a href=\"https://www.linkedin.com/in/minhquanym/\">minhquanym</a></li>\n<li>zzzitron</li>\n<li>minhtrng</li>\n<li><a href=\"https://twitter.com/Deivitto\">Deivitto</a></li>\n<li><a href=\"https://twitter.com/sm4rtcontr4ct\">JC</a></li>\n<li>yac (t4k, <a href=\"https://twitter.com/XianganH\">Peep</a>,  <a href=\"https://twitter.com/thebensams\">thebensams</a>, <a href=\"https://twitter.com/devtooligan\">devtooligan</a>, <a href=\"https://twitter.com/blockdeveth\">blockdev</a>,  <a href=\"https://twitter.com/usmannk\">usmannk</a>, sjkelleyjr, <a href=\"https://github.com/thraull\">thraull</a>, and NibblerExpress)</li>\n<li><a href=\"https://twitter.com/0xSmartContract\">0xSmartContract</a></li>\n<li><a href=\"https://twitter.com/0xNazgul\">0xNazgul</a></li>\n<li><a href=\"https://twitter.com/andyfeili\">oyc_109</a></li>\n<li>mics</li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li>Bnke0x0</li>\n<li><a href=\"https://twitter.com/ret2basic\">ret2basic</a></li>\n<li><a href=\"https://milotruck.github.io/\">MiloTruck</a></li>\n<li>robee</li>\n<li><a href=\"https://twitter.com/BowTiedDravee\">Dravee</a></li>\n<li><a href=\"https://www.linkedin.com/in/georgi-nikolaev-georgiev-978253219\">gogo</a></li>\n<li>ReyAdmirado</li>\n<li>Junnon</li>\n<li>Waze</li>\n<li><a href=\"https://github.com/Aymen1001\">Aymen0909</a></li>\n<li>erictee</li>\n<li>CodingNameKiki</li>\n<li><a href=\"https://twitter.com/ROHANJH56009256\">Rohan16</a></li>\n<li><a href=\"https://twitter.com/ElKu_crypto\">ElKu</a></li>\n<li><a href=\"https://github.com/lyciumlee\">durianSausage</a></li>\n<li><a href=\"https://mobile.twitter.com/tomj_bb\">TomJ</a></li>\n<li>kyteg</li>\n<li><a href=\"https://twitter.com/father0fBl0cks\">fatherOfBlocks</a></li>\n<li><a href=\"https://twitter.com/0xheynacho\">ignacio</a></li>\n<li>LeoS</li>\n<li>ballx</li>\n<li><a href=\"https://twitter.com/mehmeddukov\">medikko</a></li>\n<li>simon135</li>\n<li>Noah3o6</li>\n<li><a href=\"https://twitter.com/Sm4rty_\">Sm4rty</a></li>\n<li><a href=\"https://instagram.com/vanensurya\">Funen</a></li>\n<li>delfin454000</li>\n<li>sach1r0</li>\n<li><a href=\"https://twitter.com/SAPanahloo\">SaharAP</a></li>\n<li>sryysryy</li>\n<li>SooYa</li>\n<li><a href=\"https://twitter.com/a12jmx\">a12jmx</a></li>\n<li>cRat1st0s</li>\n<li>ak1</li>\n<li>asutorufos</li>\n<li><a href=\"https://chom.dev\">Chom</a></li>\n<li>djxploit</li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li>d3e4</li>\n<li>Yiko</li>\n<li>EthLedger</li>\n<li>ladboy233</li>\n<li>PaludoX0</li>\n<li><a href=\"https://twitter.com/bin2chen\">bin2chen</a></li>\n<li>ajtra</li>\n<li>RoiEvenHaim</li>\n<li><a href=\"https://twitter.com/tabishjshaikh\">tabish</a></li>\n<li>beelzebufo</li>\n<li>ayeslick</li>\n<li>yash90</li>\n<li>cryptonue</li>\n<li><a href=\"https://davidyat.es\">dy</a></li>\n<li><a href=\"https://twitter.com/0xhyh\">hyh</a></li>\n<li>0xsolstars (<a href=\"twitter.com/versatile_crypt\">Varun_Verma</a> and masterchief)</li>\n<li>0xmatt</li>\n<li>The_GUILD (<a href=\"https://twitter.com/davidpius10\">David_</a>, <a href=\"https://twitter.com/iamephraim_js\">Ephraim</a>,  LeoGold,  and greatsamist)</li>\n<li>0xNineDec</li>\n<li>dipp</li>\n<li><a href=\"https://twitter.com/dev_chinmayf\">Chinmay</a></li>\n<li>0xkatana</li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li><a href=\"https://t.me/Road220\">m_Rassska</a></li>\n<li>saian</li>\n<li>NoamYakov</li>\n<li>flyx</li>\n<li>Amithuddar</li>\n<li><a href=\"https://twitter.com/fitraldys\">Fitraldys</a></li>\n<li><a href=\"https://twitter.com/GerdusM\">gerdusx</a></li>\n<li>Metatron</li>\n<li>2997ms</li>\n<li>newfork01</li>\n<li>chrisdior4</li>\n<li>0xackermann</li>\n<li>jag</li>\n<li><a href=\"https://veranos.io\">mrpathfindr</a></li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>Diraco</li>\n<li><a href=\"https://twitter.com/randyyramadhan\">Randyyy</a></li>\n<li>zeesaw</li>\n<li>0xc0ffEE</li>\n<li><a href=\"https://twitter.com/AdonaiR6\">IgnacioB</a></li>\n<li><a href=\"https://twitter.com/im_Dharma09\">dharma09</a></li>\n<li><a href=\"https://www.twitter.com/hakerbaya\">hakerbaya</a></li>\n<li>nxrblsrpr</li>\n<li>0xbepresent</li>\n<li>find_a_bug</li>\n<li>francoHacker</li>\n<li>ltyu</li>\n</ol>\n<p>This contest was judged by <a href=\"https://github.com/gititGoro\">Justin Goro</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/itsmetechjay\">itsmetechjay</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 15 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 13 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 85 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 94 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-08-frax\">C4 Fraxlend (Frax Finance) contest repository</a>, and is composed of 9 smart contracts written in the Solidity programming language and includes 2,110 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-2\" style=\"position:relative;\"><a href=\"#high-risk-findings-2\" aria-label=\"high risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (2)</h1>\n<h2 id=\"h-01-any-borrower-with-bad-debt-can-be-liquidated-multiple-times-to-lock-funds-in-the-lending-pair\" style=\"position:relative;\"><a href=\"#h-01-any-borrower-with-bad-debt-can-be-liquidated-multiple-times-to-lock-funds-in-the-lending-pair\" aria-label=\"h 01 any borrower with bad debt can be liquidated multiple times to lock funds in the lending pair permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/102\">[H-01] Any borrower with bad debt can be liquidated multiple times to lock funds in the lending pair</a></h2>\n<p><em>Submitted by panprog, also found by 0xA5DF and Lambda</em></p>\n<p>Leftover shares in <code>liquidateClean</code> are only subtracted from pair totals, but not from user’s borrowed shares. This means that after <code>liquidateClean</code>, borrower’s shares will be greater than <code>0</code> (leftover shares after liquidations), but the user is still insolvent and can be liquidated again and again (with <code>_sharesToLiquidate</code> set to <code>0</code>). Each subsequent liquidation will write off the bad debt (reduce pair totals by borrower leftover shares/amounts), but doesn’t take anything from liquidator nor borrower (since <code>_sharesToLiquidate == 0</code>).</p>\n<p>This messes up the whole pair accounting, with total asset amounts reducing and total borrow amounts and shares reducing. This will make it impossible for borrowers to repay debt (or be liquidated), because borrow totals will underflow, and lenders amount to withdraw will reduce a lot (they will share non-existant huge bad debt).</p>\n<p>Reducing pair totals scenario:</p>\n<ol>\n<li>Alice borrows <code>1000 FRAX</code> (<code>1000</code> shares) against <code>1.5 ETH</code> collateral (<code>1 ETH = 1000</code>, <code>Max LTV</code> = <code>75%</code>)</li>\n<li>ETH drops to <code>500</code> very quickly with liquidators being unable to liquidate Alice due to network congestion</li>\n<li>At ETH = <code>500</code>, Alice collateral is worth <code>750</code> against <code>1000 FRAX</code> debt, making Alice insolvent and in a bad debt</li>\n<li>Liquidator calls <code>liquidateClean</code> for <code>800</code> shares, which cleans up all available collateral of <code>1.5 ETH</code>.</li>\n<li>At this point Alice has <code>200</code> shares debt with <code>0</code> collateral</li>\n<li>Liquidator repeatedly calls <code>liquidateClean</code> with <code>0</code> shares to liquidate. Each call pair totals are reduced by <code>200</code> shares (and total borrow amount by a corresponding amount).</li>\n<li>When pair totals reach close to <code>0</code>, the pool is effectively locked. Borrowers can’t repay, lenders can withdraw severly reduced amounts.</li>\n</ol>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Copy this to src/test/e2e/LiquidationBugTest.sol</p>\n<p><a href=\"https://gist.github.com/panprog/cbdc1658d63c30c9fe94127a4b4b7e72\">https://gist.github.com/panprog/cbdc1658d63c30c9fe94127a4b4b7e72</a></p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>After the line</p>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L1012\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L1012</a></p>\n<p>add</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    _sharesToLiquidate += _sharesToAdjust;</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/102#issuecomment-1230721732\">amirnader-ghazvini (Frax) marked as duplicate and commented</a>:</strong></p>\n<blockquote>\n<p>Duplicate of <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/112\">#112</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/102#issuecomment-1264719973\">gititGoro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Setting to original in set.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/102\">DrakeEvans (Frax) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-02-liquidate-doesnt-mark-off-bad-debt-leading-to-a-last-lender-to-withdraw-loses-scenario\" style=\"position:relative;\"><a href=\"#h-02-liquidate-doesnt-mark-off-bad-debt-leading-to-a-last-lender-to-withdraw-loses-scenario\" aria-label=\"h 02 liquidate doesnt mark off bad debt leading to a last lender to withdraw loses scenario permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/141\">[H-02] <code>liquidate()</code> doesn’t mark off bad debt, leading to a ‘last lender to withdraw loses’ scenario</a></h2>\n<p><em>Submitted by 0xA5DF, also found by cccz and Lambda</em></p>\n<p>When there’s bad debt which wasn’t marked off yet, the <code>totalAssets.amount</code> is higher than the actual (solvent) amount the pair has, meaning that lenders who redeem their tokens earlier will get more in return, at the expense of lenders who leave later.\nTherefore bad debt should be marked off as soon as possible, the later it’s done the more interest it accumulates and the higher the chances are that some of the lenders will notice and redeem their shares before the bad debt is subtracted from the total assets amount.</p>\n<p>Having the option to liquidate via the <code>liquidate()</code> function (which doesn’t mark off bad debt) can lead to users using that function and leaving bad debt alongside zero collateral or near-zero collateral (giving no motivation for other users to liquidate the rest).</p>\n<p>Marking off the remaining of the bad debt via <code>liquidateClean()</code> with 0 shares might be possible (not always, some tokens <a href=\"https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers\">don’t allow 0 transfers</a>), however there’s no motivation for outside users to do so. And as for the lenders - redeeming their tokens before the bad debt is subtracted from the total amount might be more profitable than staying and marking off the bad debt.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Some lenders might be able to dodge the loss of the bad debt (+ interest), while the last one(s) will have to absorb the lost of the lenders who left too.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Consider the following scenario:</p>\n<ul>\n<li>A pair has 10 lenders with 1K$ from each one (10K total)</li>\n<li>Borrower borrowed that 10K</li>\n<li>The collateral price went down and now it’s worth only 7K</li>\n<li>A liquidator notices that and liquidates it via <code>liquidate()</code></li>\n<li>The <code>totalAssets.amount</code> is 10K + interest, but the total asset amount is actually less than 7K (subtracting liquidator fees)</li>\n<li>6 lenders notice that and redeem their shares, getting back their money + interest</li>\n<li>The 7th lender to redeem will only be able to get back part of his money</li>\n<li>The remaining 3 lenders will loose all of their money</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Mark off bad debt when remaining collateral reaches zero or near-zero value.</p>\n<p>(if only <code>liquidateClean()</code> was available then there would be a motivation to not leave near-zero collateral, but as long as this isn’t the case consider marking off also in case of near-zero collateral left).</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/142\">DrakeEvans (Frax) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/141#issuecomment-1266170140\">gititGoro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Setting to original in set. Severity will be maintained as the wardens couldn’t know that only one liquidate function would be included in the final release.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-13\" style=\"position:relative;\"><a href=\"#medium-risk-findings-13\" aria-label=\"medium risk findings 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (13)</h1>\n<h2 id=\"m-01-penalty-rate-is-used-for-pre-maturity-date-as-well\" style=\"position:relative;\"><a href=\"#m-01-penalty-rate-is-used-for-pre-maturity-date-as-well\" aria-label=\"m 01 penalty rate is used for pre maturity date as well permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/111\">[M-01] Penalty rate is used for pre-maturity date as well</a></h2>\n<p><em>Submitted by 0xA5DF, also found by 0x52 and rbserver</em></p>\n<p>When <code>_addInterest()</code> is called post maturity, the penalty rate is applied since the last time <code>_addInterest()</code> was called, including the period before maturity.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Borrowers will be charged with higher interest rates, when maturity date passes. The longer the time since <code>_addInterest()</code> was last called before maturity date the more extra-interest they will be charged.</p>\n<p>Sidenote: I think this should be considered High, since it comes at the cost of the assets of the borrowers (even though it stems from unnecessary  fees being charged, similar to <a href=\"https://code4rena.com/reports/2022-06-putty#h-01-fee-is-being-deducted-when-put-is-expired-and-not-when-it-is-exercised\">this Putty bug</a>).</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The test compares 2 scenarios, the 1st one where <code>addInterest()</code> isn’t called for 30 days before maturity date, and in the 2nd it isn’t called just for 1 day before.</p>\n<p>The debt (<strong>not interest</strong>) in the first scenario would be ~50% higher than the second, see test output below.</p>\n<p>At <code>src/test/e2e/BorrowPairTest.t.sol</code> I’ve modified <code>_fuzzySetupBorrowToken()</code> to this and then ran <code>source .env &#x26;&#x26; forge test --fork-url $MAINNET_URL --fork-block-number $DEFAULT_FORK_BLOCK -m testFuzzyMaxLTVBorrowToken -vvv</code>.\nAnd I’ve also modified <code>src/test/e2e/BasePairTest.sol</code> a bit so that each pair can have a different name for salt (see diff below).</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_fuzzySetupBorrowToken</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_minInterest</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vertexInterest</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxInterest</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vertexUtilization</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_priceTop</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_priceDiv</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">asset</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FIL_ERC20</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MKR_ERC20</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">oracleMultiply</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">AggregatorV3Interface</span><span class=\"mtk1\">(</span><span class=\"mtk12\">CHAINLINK_MKR_ETH</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">oracleMultiply</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_priceTop</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">oracleDivide</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">AggregatorV3Interface</span><span class=\"mtk1\">(</span><span class=\"mtk12\">CHAINLINK_FIL_ETH</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">oracleDivide</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_priceDiv</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_oracleNormalization</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rateContract</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rateInitData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) = </span><span class=\"mtk11\">fuzzyRateCalculator</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk7\">2</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_minInterest</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_vertexInterest</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_maxInterest</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_vertexUtilization</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">startHoax</span><span class=\"mtk1\">(</span><span class=\"mtk12\">COMPTROLLER_ADDRESS</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">setWhitelistTrue</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_borrowerWhitelist</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">LTV_PRECISION</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ? </span><span class=\"mtk12\">users</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            : </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_lenderWhitelist</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">LTV_PRECISION</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ? </span><span class=\"mtk12\">users</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            : </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrowerDebtWrong</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// wrong calculation, when addInterest isn&#39;t called before maturity date (30 days)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">deployFraxlendCustom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_oracleNormalization</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_rateContract</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_rateInitData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">30</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">DEFAULT_INT</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_borrowerWhitelist</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_lenderWhitelist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateExchangeRate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_borrowTest</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">, </span><span class=\"mtk7\">15e20</span><span class=\"mtk1\">, </span><span class=\"mtk7\">15e23</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">29</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addInterest</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrower</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrowerShares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">userBorrowShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">borrowerDebtWrong</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toBorrowAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrowerShares</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">deploySaltName</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;asdf2&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrowerDebtRight</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// relatively correct calculation, when addInterest is called close to maturity date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">deployFraxlendCustom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_oracleNormalization</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_rateContract</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_rateInitData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">30</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">DEFAULT_INT</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_borrowerWhitelist</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_lenderWhitelist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateExchangeRate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_borrowTest</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">, </span><span class=\"mtk7\">15e20</span><span class=\"mtk1\">, </span><span class=\"mtk7\">15e23</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">29</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addInterest</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addInterest</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrower</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrowerShares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">userBorrowShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">borrowerDebtRight</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toBorrowAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrowerShares</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// compare final debt between both scenarios</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrowerDebtRight</span><span class=\"mtk1\">, </span><span class=\"mtk12\">borrowerDebtWrong</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/test/e2e/BasePairTest.sol b/src/test/e2e/BasePairTest.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 25114d9..27321dc 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/test/e2e/BasePairTest.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/test/e2e/BasePairTest.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -67,6 +67,8 @@ contract BasePairTest is FraxlendPairConstants, Scenarios, Test {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     PairAccounting public initial;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     PairAccounting public final_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     PairAccounting public net;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    string public deploySaltName = &quot;asdf&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Users</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     address[] public users = [vm.addr(1), vm.addr(2), vm.addr(3), vm.addr(4), vm.addr(5)];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -284,10 +286,12 @@ contract BasePairTest is FraxlendPairConstants, Scenarios, Test {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address[] memory _approvedLenders</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         startHoax(COMPTROLLER_ADDRESS);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             pair = FraxlendPair(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 deployer.deployCustom(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                    &quot;testname&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                    deploySaltName,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     _encodeConfigData(_normalization, _rateContractAddress, _initRateData),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     _maxLTV,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     _liquidationFee,</span></span></span></code></pre>\n<p>Output:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  Error: a == b not satisfied [uint]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Expected: 2135773332009600000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      Actual: 1541017987253789777725</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>When maturity date passes and the last time <code>_addInterest()</code> was called was before maturity date, calculate first the interest rate for that interval as normal interest rate, and then calculate penalty rate for the remaining time.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/111#issuecomment-1238095595\">DrakeEvans (Frax) disputed, disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>This is mitigated by borrower calling <code>addInterest()</code> this is the purpose of the public addInterest function.  Alternatively they can repay their loan on time as intended.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/111#issuecomment-1238266791\">0xA5DF (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Generally speaking, I think we should asses severity based on expected user behavior if the issue hasn’t been reported.\nSince there’s no warning to users to call <code>addInterest()</code> before maturity date, users would simply not do that and will be charged extra interest.</p>\n<blockquote>\n<p>Alternatively they can repay their loan on time as intended.</p>\n</blockquote>\n<p>It’s indeed a fine charged for not paying on time, but I don’t think you can wave off charging a higher fine than intended as non significant. A user might be a few minutes late and be charged a penalty rate for a few days/weeks.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/111\">DrakeEvans (Frax) acknowledged</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/111#issuecomment-1255524092\">gititGoro (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>It will create an unexpected user experience to be penalized for periods in which a penalty shouldn’t apply, especially during high gas eras.\nIf this is communicated to the user, then an acknowledged label is reasonable.</p>\n<p>If there was an incentive for keeper type users to addInterest such as issuing a small % of shares to users who call the public addInterest then this issue can be marked invalid.</p>\n<p>As for the severity, the existence of addInterest function as an intended mechanism to avoid this means that steps can be taken to avoid excessive interest charging. Indeed third parties can build on safe wrappers of these contracts in a downstream convex-like service. In other words, high interest charging on late debt is by no means an inevitable outcome.</p>\n<p>For these two reasons, I’m downgrading severity to 2 and NOT marking invalid.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-interest-can-be-significantly-lower-if-addinterest-isnt-called-frequently-enough-\" style=\"position:relative;\"><a href=\"#m-02-interest-can-be-significantly-lower-if-addinterest-isnt-called-frequently-enough-\" aria-label=\"m 02 interest can be significantly lower if addinterest isnt called frequently enough  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/145\">[M-02] Interest can be significantly lower if <code>addInterest</code> isn’t called frequently enough </a></h2>\n<p><em>Submitted by 0xA5DF, also found by sseefried</em></p>\n<p><code>addInterest()</code> always multiplies the interest rate by the time delta, and then multiplies the total borrow amount by the results (<code>newTotalBorrowAmount = interestRate * timeDelta * totalBorrowAmount</code>). This can lead to different interest amounts, depending on how frequently it’s called.</p>\n<p>This will mostly affect custom pairs with stable interest rates (e.g. using linear rate with same min/max/vertex interest) which don’t have much activity (e.g. whitelisted borrowers and lenders with long term loan).</p>\n<p>The higher the interest rate, the higher the difference will be, for example:</p>\n<ul>\n<li>15% annual rate would turn into 13.9% if called only once a year (compared to once a day)</li>\n<li>30% will turn into 26.2%</li>\n<li>50% will turn to 40%</li>\n<li>100% to ~70%</li>\n<li>200% to 110%</li>\n</ul>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Lenders might end up gaining less interest than expected.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following test shows a case of 50% annual rate, comparing calling it once in 3 days and only once after a year, the difference would be about 4.5% of the final debt.</p>\n<p>At <code>src/test/e2e/BorrowPairTest.t.sol</code> I’ve modified <code>_fuzzySetupBorrowToken()</code> to this and then ran <code>source .env &#x26;&#x26; forge test --fork-url $MAINNET_URL --fork-block-number $DEFAULT_FORK_BLOCK -m testFuzzyMaxLTVBorrowToken -vvv</code>.\nAnd I’ve also modified <code>src/test/e2e/BasePairTest.sol</code> a bit so that each pair can have a different name for salt (see diff below).</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_fuzzySetupBorrowToken</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_minInterest</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vertexInterest</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxInterest</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vertexUtilization</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_priceTop</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_priceDiv</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">asset</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FIL_ERC20</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MKR_ERC20</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">oracleMultiply</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">AggregatorV3Interface</span><span class=\"mtk1\">(</span><span class=\"mtk12\">CHAINLINK_MKR_ETH</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">oracleMultiply</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_priceTop</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">oracleDivide</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">AggregatorV3Interface</span><span class=\"mtk1\">(</span><span class=\"mtk12\">CHAINLINK_FIL_ETH</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">oracleDivide</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_priceDiv</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_oracleNormalization</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rateContract</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rateInitData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) = </span><span class=\"mtk11\">fuzzyRateCalculator</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk7\">2</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk7\">12864358183</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// ~ 50% annual rate - setting this is as min/max/vertex rate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk7\">12864358183</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk7\">12864358183</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_vertexUtilization</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">startHoax</span><span class=\"mtk1\">(</span><span class=\"mtk12\">COMPTROLLER_ADDRESS</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">setWhitelistTrue</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_borrowerWhitelist</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">LTV_PRECISION</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ? </span><span class=\"mtk12\">users</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            : </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_lenderWhitelist</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">LTV_PRECISION</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ? </span><span class=\"mtk12\">users</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            : </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrowerDebtWrong</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// wrong calculation, when addInterest isn&#39;t called before maturity date (30 days)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">deployFraxlendCustom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_oracleNormalization</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_rateContract</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_rateInitData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">DEFAULT_INT</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_borrowerWhitelist</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_lenderWhitelist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateExchangeRate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_borrowTest</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">, </span><span class=\"mtk7\">15e20</span><span class=\"mtk1\">, </span><span class=\"mtk7\">15e23</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> =</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">100</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">3</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addInterest</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrower</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrowerShares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">userBorrowShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">borrowerDebtWrong</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toBorrowAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrowerShares</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">deploySaltName</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;asdf2&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrowerDebtRight</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// relatively correct calculation, when addInterest is called close to maturity date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">deployFraxlendCustom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_oracleNormalization</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_rateContract</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_rateInitData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">DEFAULT_INT</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_borrowerWhitelist</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_lenderWhitelist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateExchangeRate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_borrowTest</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">, </span><span class=\"mtk7\">15e20</span><span class=\"mtk1\">, </span><span class=\"mtk7\">15e23</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> =</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">100</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">3</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addInterest</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addInterest</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrower</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrowerShares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">userBorrowShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">borrowerDebtRight</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toBorrowAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrowerShares</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// compare final debt between both scenarios</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrowerDebtRight</span><span class=\"mtk1\">, </span><span class=\"mtk12\">borrowerDebtWrong</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/test/e2e/BasePairTest.sol b/src/test/e2e/BasePairTest.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 25114d9..27321dc 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/test/e2e/BasePairTest.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/test/e2e/BasePairTest.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -67,6 +67,8 @@ contract BasePairTest is FraxlendPairConstants, Scenarios, Test {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     PairAccounting public initial;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     PairAccounting public final_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     PairAccounting public net;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    string public deploySaltName = &quot;asdf&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Users</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     address[] public users = [vm.addr(1), vm.addr(2), vm.addr(3), vm.addr(4), vm.addr(5)];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -284,10 +286,12 @@ contract BasePairTest is FraxlendPairConstants, Scenarios, Test {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address[] memory _approvedLenders</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         startHoax(COMPTROLLER_ADDRESS);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             pair = FraxlendPair(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 deployer.deployCustom(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                    &quot;testname&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                    deploySaltName,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     _encodeConfigData(_normalization, _rateContractAddress, _initRateData),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     _maxLTV,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                     _liquidationFee,</span></span></span></code></pre>\n<p>Output:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  Error: a == b not satisfied [uint]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Expected: 2000166246155040000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      Actual: 2092489655740553483735</span></span></code></pre>\n<p>Also, here’s a JS function I’ve used to calculate the rate depending on frequency:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">calculateInterest</span><span class=\"mtk1\">(</span><span class=\"mtk12\">annualRate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">frequency</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dailyRate</span><span class=\"mtk1\"> = (</span><span class=\"mtk7\">1</span><span class=\"mtk1\">+</span><span class=\"mtk12\">annualRate</span><span class=\"mtk1\">) ** (</span><span class=\"mtk7\">1</span><span class=\"mtk1\">/</span><span class=\"mtk7\">365</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ratePerFrequency</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">dailyRate</span><span class=\"mtk1\"> -</span><span class=\"mtk7\">1</span><span class=\"mtk1\">) * </span><span class=\"mtk7\">365</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">frequency</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">finalRate</span><span class=\"mtk1\"> = (</span><span class=\"mtk7\">1</span><span class=\"mtk1\">+</span><span class=\"mtk12\">ratePerFrequency</span><span class=\"mtk1\">) ** </span><span class=\"mtk12\">frequency</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">finalRate</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>Let the users know that in some cases not calling <code>addInterest()</code> frequently enough can lead to lower interest rates.</li>\n<li>Consider dividing the interest calculation into small period of times in case a long period has passed since last time <code>addInterest()</code> ran.</li>\n</ul>\n<p>Something along these lines (this shouldn’t cost much more gas, as it’s mostly math operations):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Calculate interest accrued</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_deltaTime</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">THRESHOLD</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">iterations</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">min</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MAX_ITERATIONS</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_deltaTime</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">THRESHOLD</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e36</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">iterations</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_</span><span class=\"mtk1\">   </span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\"> =  (</span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">_deltaTime</span><span class=\"mtk1\">  * </span><span class=\"mtk12\">_currentRateInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ratePerSec</span><span class=\"mtk1\">) / (</span><span class=\"mtk7\">1e18</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">iterations</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_interestEarned</span><span class=\"mtk1\"> = ( </span><span class=\"mtk12\">_totalBorrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">multiplier</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1e36</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span><span class=\"mtk15\">else</span><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_interestEarned</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">_deltaTime</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">_totalBorrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">_currentRateInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ratePerSec</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/145\">DrakeEvans (Frax) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"m-03-impossible-to-setcreationcode-with-code-size-less-than-13k\" style=\"position:relative;\"><a href=\"#m-03-impossible-to-setcreationcode-with-code-size-less-than-13k\" aria-label=\"m 03 impossible to setcreationcode with code size less than 13k permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/153\">[M-03] Impossible to <code>setCreationCode()</code> with code size less than 13K</a></h2>\n<p><em>Submitted by 0xA5DF</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/92a8d7d331cc718cd64de6b02515b554672fb0f3/src/contracts/FraxlendPairDeployer.sol#L170-L178\">https://github.com/code-423n4/2022-08-frax/blob/92a8d7d331cc718cd64de6b02515b554672fb0f3/src/contracts/FraxlendPairDeployer.sol#L170-L178</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/92a8d7d331cc718cd64de6b02515b554672fb0f3/src/contracts/FraxlendPairDeployer.sol#L207-L210\">https://github.com/code-423n4/2022-08-frax/blob/92a8d7d331cc718cd64de6b02515b554672fb0f3/src/contracts/FraxlendPairDeployer.sol#L207-L210</a></p>\n<h3 id=\"vulnerability-details\" style=\"position:relative;\"><a href=\"#vulnerability-details\" aria-label=\"vulnerability details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability Details</h3>\n<p>In case of setting the creation code to less than 13K the creation would fail at 2 points:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-08-frax/blob/92a8d7d331cc718cd64de6b02515b554672fb0f3/src/contracts/FraxlendPairDeployer.sol#L171\"><code>BytesLib.slice(_creationCode, 0, 13000)</code></a> would fail since <code>slice()</code> requires that <code>_bytes.length</code> would be at least <code>start + length</code>.</li>\n<li><a href=\"https://github.com/code-423n4/2022-08-frax/blob/92a8d7d331cc718cd64de6b02515b554672fb0f3/src/contracts/FraxlendPairDeployer.sol#L209\"><code>SSTORE2.read(contractAddress2)</code></a> at <code>_deployFirst()</code> would fail since calling this on address without code would cause a math underflow (due to <a href=\"https://github.com/code-423n4/2022-08-frax/blob/main/node_modules/@rari-capital/solmate/src/utils/SSTORE2.sol#L51\"><code>pointer.code.length - DATA_OFFSET</code></a>)</li>\n</ul>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>In case the code of the pair gets smaller (e.g. optimization, moving part of the code to a library etc.) to 13K or less, it’d be impossible to set it as the new creation code (or in the case of the 2nd issue, it’d be impossible to deploy it).</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In the following test I try to set creation code to a smaller mock pair.\nThe test was added to <code>src/test/e2e/FraxlendPairDeployerTest.sol</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testChangeCreationCodeBug</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Setup contracts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">setExternalContracts</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">startHoax</span><span class=\"mtk1\">(</span><span class=\"mtk12\">COMPTROLLER_ADDRESS</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">setWhitelistTrue</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">console2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Mock pair size:&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MockPair</span><span class=\"mtk1\">).</span><span class=\"mtk12\">creationCode</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">deployer</span><span class=\"mtk1\">.</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">deployer</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCreationCode</span><span class=\"mtk1\">(</span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MockPair</span><span class=\"mtk1\">).</span><span class=\"mtk12\">creationCode</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Set initial oracle prices</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rateInitData</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">defaultRateInitForLinear</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">deployer</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oracleMultiply</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oracleDivide</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk7\">1e10</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">linearRateContract</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_rateInitData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The mock pair was created as <code>src/contracts/audit/MockPair.sol</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: ISC</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">15</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/security/Pausable.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/access/Ownable.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/utils/math/SafeCast.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../FraxlendPairConstants.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../libraries/VaultAccount.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../libraries/SafeERC20.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../interfaces/IERC4626.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../interfaces/IFraxlendWhitelist.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../interfaces/IRateCalculator.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../interfaces/ISwapper.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @title FraxlendPairCore</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @author Drake Evans (Frax Finance) https://github.com/drakeevans</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @notice  An abstract contract which contains the core logic and storage for the FraxlendPair</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MockPair</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FraxlendPairConstants</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Ownable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Pausable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ReentrancyGuard</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">using</span><span class=\"mtk1\"> </span><span class=\"mtk12\">VaultAccountingLibrary</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">VaultAccount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">using</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">using</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">version</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;1.0.0&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ============================================================================================</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Settings set by constructor() &amp; initialize()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ============================================================================================</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Asset and collateral contracts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assetContract</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralContract</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Oracle wrapper contract and oracleData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oracleMultiply</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oracleDivide</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oracleNormalization</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// LTV Settings</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxLTV</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Liquidation Fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cleanLiquidationFee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dirtyLiquidationFee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Interest Rate Calculator Contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IRateCalculator</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rateContract</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// For complex rate calculations</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rateInitCallData</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// Optional extra data from init function to be passed to rate calculator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Swapper</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">swappers</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// approved swapper addresses</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Deployer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">DEPLOYER_ADDRESS</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Admin contracts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">CIRCUIT_BREAKER_ADDRESS</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">COMPTROLLER_ADDRESS</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">TIME_LOCK_ADDRESS</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Dependencies</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FRAXLEND_WHITELIST_ADDRESS</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ERC20 token name, accessible via name()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nameOfContract</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Maturity Date &amp; Penalty Interest Rate (per Sec)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturityDate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">penaltyRate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ============================================================================================</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Storage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ============================================================================================</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @notice Stores information about the current interest rate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @dev struct is packed to reduce SLOADs. feeToProtocolRate is 1e5 precision, ratePerSec is 1e18 precision</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">CurrentRateInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentRateInfo</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">CurrentRateInfo</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feeToProtocolRate</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// Fee amount 1e5 precision</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastTimestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ratePerSec</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @notice Stores information about the current exchange rate. Collateral:Asset ratio</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @dev Struct packed to save SLOADs. Amount of Collateral Token to buy 1e18 Asset Token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ExchangeRateInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">exchangeRateInfo</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ExchangeRateInfo</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastTimestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint224</span><span class=\"mtk1\"> </span><span class=\"mtk12\">exchangeRate</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// collateral:asset ratio. i.e. how much collateral to buy 1e18 asset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Contract Level Accounting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">VaultAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalAsset</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// amount = total amount of assets, shares = total shares outstanding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">VaultAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalBorrow</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// amount = total borrow amount with interest accrued, shares = total shares outstanding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalCollateral</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// total amount of collateral in contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// User Level Accounting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @notice Stores the balance of collateral for each user</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userCollateralBalance</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// amount of collateral each user is backed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @notice Stores the balance of borrow shares for each user</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userBorrowShares</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// represents the shares held by individuals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// NOTE: user shares of assets are represented as ERC-20 tokens and accessible via balanceOf()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Internal Whitelists</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrowerWhitelistActive</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">approvedBorrowers</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lenderWhitelistActive</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">approvedLenders</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Fine</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">line</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ============================================================================================</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Initialize</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ============================================================================================</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @notice The ```constructor``` function is called on deployment</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param _configData abi.encode(address _asset, address _collateral, address _oracleMultiply, address _oracleDivide, uint256 _oracleNormalization, address _rateContract, bytes memory _rateInitData)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param _maxLTV The Maximum Loan-To-Value for a borrower to be considered solvent (1e5 precision)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param _liquidationFee The fee paid to liquidators given as a % of the repayment (1e5 precision)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param _maturityDate The maturityDate date of the Pair</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param _penaltyRate The interest rate after maturity date</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param _isBorrowerWhitelistActive Enables borrower whitelist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param _isLenderWhitelistActive Enables lender whitelist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_immutables</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturityDate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_penaltyRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_isBorrowerWhitelistActive</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_isLenderWhitelistActive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )  </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Handle Immutables Configuration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_circuitBreaker</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_comptrollerAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_timeLockAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fraxlendWhitelistAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ) = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_immutables</span><span class=\"mtk1\">, (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Deployer contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">DEPLOYER_ADDRESS</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">CIRCUIT_BREAKER_ADDRESS</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_circuitBreaker</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">COMPTROLLER_ADDRESS</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_comptrollerAddress</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">TIME_LOCK_ADDRESS</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_timeLockAddress</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">FRAXLEND_WHITELIST_ADDRESS</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_fraxlendWhitelistAddress</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Fine</span><span class=\"mtk1\">(</span><span class=\"mtk7\">177</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_collateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_oracleMultiply</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_oracleDivide</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_oracleNormalization</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rateContract</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ) = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">, (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Pair Settings</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">assetContract</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">collateralContract</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_collateral</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">currentRateInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">feeToProtocolRate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">DEFAULT_PROTOCOL_FEE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">cleanLiquidationFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">dirtyLiquidationFee</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">9000</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">LIQ_PRECISION</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 90% of clean fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">LTV_PRECISION</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">_isBorrowerWhitelistActive</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BorrowerWhitelistRequired</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">maxLTV</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Swapper Settings</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">swappers</span><span class=\"mtk1\">[</span><span class=\"mtk12\">FRAXSWAP_ROUTER_ADDRESS</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Oracle Settings</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">IFraxlendWhitelist</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fraxlendWhitelist</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IFraxlendWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FRAXLEND_WHITELIST_ADDRESS</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// Check that oracles are on the whitelist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_oracleMultiply</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; !</span><span class=\"mtk12\">_fraxlendWhitelist</span><span class=\"mtk1\">.</span><span class=\"mtk11\">oracleContractWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_oracleMultiply</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NotOnWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_oracleMultiply</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_oracleDivide</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; !</span><span class=\"mtk12\">_fraxlendWhitelist</span><span class=\"mtk1\">.</span><span class=\"mtk11\">oracleContractWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_oracleDivide</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NotOnWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_oracleDivide</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// Write oracleData to storage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">oracleMultiply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_oracleMultiply</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">oracleDivide</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_oracleDivide</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">oracleNormalization</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_oracleNormalization</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// Rate Settings</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">_fraxlendWhitelist</span><span class=\"mtk1\">.</span><span class=\"mtk11\">rateContractWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_rateContract</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NotOnWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_rateContract</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">rateContract</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IRateCalculator</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_rateContract</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Fine</span><span class=\"mtk1\">(</span><span class=\"mtk7\">177</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Set approved borrowers whitelist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">borrowerWhitelistActive</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_isBorrowerWhitelistActive</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Set approved lenders whitlist active</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">lenderWhitelistActive</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_isLenderWhitelistActive</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Set maturity date &amp; penalty interest rate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">maturityDate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_maturityDate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">penaltyRate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_penaltyRate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_approvedBorrowers</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_approvedLenders</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rateInitCallData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>If creation code length is 13K or less:</p>\n<ul>\n<li>Don’t run <code>BytesLib.slice()</code></li>\n<li>At deployment read only from the first address</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/153\">DrakeEvans (Frax) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"m-04-wrong-percent-for-fraxlendpaircoredirtyliquidationfee\" style=\"position:relative;\"><a href=\"#m-04-wrong-percent-for-fraxlendpaircoredirtyliquidationfee\" aria-label=\"m 04 wrong percent for fraxlendpaircoredirtyliquidationfee permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/238\">[M-04] Wrong percent for <code>FraxlendPairCore.dirtyLiquidationFee</code>.</a></h2>\n<p><em>Submitted by auditor0517, also found by _Adam, 0xA5DF, cccz, minhquanym, minhtrng, and zzzitron</em></p>\n<p>After confirming with the sponsor, <code>dirtyLiquidationFee</code> is 90% of <code>cleanLiquidationFee</code> like the <a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L194\">comment</a>.</p>\n<p>But it uses <code>9% (9000 / 1e5 = 0.09)</code> and the fee calculation will be wrong <a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L988-L990\">here</a>.</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>We should change <code>9000</code> to <code>90000</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">dirtyLiquidationFee = (_liquidationFee * 90000) / LIQ_PRECISION; // 90% of clean fee</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/238#issuecomment-1238157712\">DrakeEvans (Frax) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Confirmed.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/238#issuecomment-1259011750\">gititGoro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This issue has a great many duplicates. Reason for setting this report as the original:</p>\n<ol>\n<li>It’s complete in that it charts the problem and gives a code based mitigation</li>\n<li>It’s short and to the point.</li>\n<li>The sponsor’s preference was factored in.</li>\n</ol>\n</blockquote>\n<hr>\n<h2 id=\"m-05-liquidator-might-end-up-paying-much-more-asset-than-collateral-received\" style=\"position:relative;\"><a href=\"#m-05-liquidator-might-end-up-paying-much-more-asset-than-collateral-received\" aria-label=\"m 05 liquidator might end up paying much more asset than collateral received permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/99\">[M-05] Liquidator might end up paying much more asset than collateral received</a></h2>\n<p><em>Submitted by 0xA5DF, also found by __141345__</em></p>\n<p><code>liquidateClean</code> doesn’t check that the amount of shares the liquidator repays are covered by the collateral available, if the user repays more shares than (equally worth) collateral available - he’ll get only the amount of collateral available.</p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Liquidator might end up paying assets that are worth much more than the collateral he’s received.</p>\n<p>Even though it’s also the liquidator’s responsibility to check that there’s enough collateral available, mistakes are commonly done (wrong calculation, typos, deadline too large) and the protocol should prevent those kinds of errors if possible.</p>\n<p>Otherwise users might lose trust in the protocol when they lose their funds due to errors.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following test was added to <code>src/test/e2e/LiquidationPairTest.sol</code>.\nIn this scenario the user ends up with collateral that’s worth only 1/3 of the asset-tokens he paid.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testCleanLiquidate</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Setup contracts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">defaultSetUp</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Sets price to 3200 USD per ETH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amountToBorrow</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">16e20</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 1.5k</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amountInPool</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">15e23</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 1.5m</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// collateral is 1.5 times borrow amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">oracleDivide</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setPrice</span><span class=\"mtk1\">(</span><span class=\"mtk7\">3200</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">mineBlocks</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_exchangeRate</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">exchangeRateInfo</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_collateralAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">_amountToBorrow</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">_exchangeRate</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">3</span><span class=\"mtk1\">) / (</span><span class=\"mtk7\">2</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">faucetFunds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amountInPool</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">faucetFunds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_collateralAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">lendTokenViaDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amountInPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">borrowToken</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amountToBorrow</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_collateralAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mxltv</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxLTV</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cleanLiquidationFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">cleanLiquidationFee</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidation_price</span><span class=\"mtk1\"> = ((((</span><span class=\"mtk7\">1e18</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">_exchangeRate</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">mxltv</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1e5</span><span class=\"mtk1\">) * (</span><span class=\"mtk7\">1e5</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">cleanLiquidationFee</span><span class=\"mtk1\">)) / </span><span class=\"mtk7\">1e5</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">liquidation_price</span><span class=\"mtk1\"> /= </span><span class=\"mtk7\">4</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// Collateral price goes down enough so that it doesn&#39;t cover the loan</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">oracleDivide</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidation_price</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">mineBlocks</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">userBorrowShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">toUint128</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">1</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addInterest</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">mineOneBlock</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addInterest</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">), </span><span class=\"mtk11\">toBorrowAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidatorBalanceBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralGained</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">liquidateClean</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidatorBalanceAfter</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceDiff</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">liquidatorBalanceBefore</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">liquidatorBalanceAfter</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">console2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Balance diff is: &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">balanceDiff</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">console2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;_exchangeRate is: &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_exchangeRate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">console2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;cleanLiquidationFee is: &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">cleanLiquidationFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (, </span><span class=\"mtk12\">_exchangeRate</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">exchangeRateInfo</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 11/10 is for liquidation fee, 1e18 is for exchange precision</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateralGained</span><span class=\"mtk1\">, </span><span class=\"mtk12\">balanceDiff</span><span class=\"mtk1\"> *  </span><span class=\"mtk12\">_exchangeRate</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">11</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">userBorrowShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">]), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Output:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  Balance diff is:  1600000011384589113999</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  _exchangeRate is:  863759326621800</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  cleanLiquidationFee is:  10000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Error: a == b not satisfied [uint]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Expected: 7394958035811125166</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      Actual: 2073022383892320000</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Check that the shares intended to be repaid are worth the collateral + fee, if not reduce the amount of shares to be repaid accordingly.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/99#issuecomment-1237997672\">DrakeEvans (Frax) acknowledged, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>This is by design, the deadline parameter can protect against this.  Liquidators are encouraged to provide values such that all collateral is cleared.  This does present the risk of slightly (a few wei) overpaying for the collateral.  However, they are compensated with a high liquidation fee.  They can protect themselves by inputting a deadline to the tx as well to prevent interest accruing and an old tx being replayed.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/99#issuecomment-1259060765\">gititGoro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>My concern is with transaction ordering. While the deadline can prevent stale transactions, nothing prevents a validator (or whoever orders transactions in the future) from inserting their repayment prior to a well calculated transaction. An MEV drain.</p>\n<p>What protects the victim in this case is the _totalBorrow parameter. It will be lower and so place a lower bound on the overpayment.</p>\n<p>Since liquidators can’t protect themselves from MEV, there is potential leakage. Leaving severity at Medium.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-fraxlendpairsettimelock-allows-the-owner-to-reset-timelockaddress\" style=\"position:relative;\"><a href=\"#m-06-fraxlendpairsettimelock-allows-the-owner-to-reset-timelockaddress\" aria-label=\"m 06 fraxlendpairsettimelock allows the owner to reset timelockaddress permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/129\">[M-06] FraxlendPair#setTimeLock: Allows the owner to reset TIME<em>LOCK</em>ADDRESS</a></h2>\n<p><em>Submitted by carlitox477, also found by 0xA5DF, 0xDjango, brgltd, IllIllI, and reassor</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L84-L86\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L84-L86</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L204-L207\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L204-L207</a></p>\n<h3 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Allows to reset <strong>TIME<em>LOCK</em>ADDRESS</strong> value multiple times by the owner. According to comments in FraxlendPairCore this should act as a constant/immutable value. Given that this value will be defined through function <strong>setTimeLock</strong> in <strong>FraxLendPair</strong> contract this value can be changed whenever the owner wants. This does not seem to be the expected behaviour.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The owner can call the function <strong>setTimeLock</strong> whenever they want, which resets the value of <strong>TIME<em>LOCK</em>ADDRESS</strong>.</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a bool which act as mutex if <strong>TIME<em>LOCK</em>ADDRESS</strong> has already been set, and modify <strong>setTimeLock</strong> function in FraxlendPair contract</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// In FraxlendPair contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timelockSetted</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setTimeLock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newAddress</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk12\">timelockSetted</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SetTimeLock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TIME_LOCK_ADDRESS</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_newAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">TIME_LOCK_ADDRESS</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_newAddress</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">timelockeSetted</span><span class=\"mtk1\">=</span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/129\">DrakeEvans (Frax) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-07-fraxlendpairchangefee-doesnt-update-interest-before-changing-fee\" style=\"position:relative;\"><a href=\"#m-07-fraxlendpairchangefee-doesnt-update-interest-before-changing-fee\" aria-label=\"m 07 fraxlendpairchangefee doesnt update interest before changing fee permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/236\">[M-07] FraxlendPair.changeFee() doesn’t update interest before changing fee.</a></h2>\n<p><em>Submitted by auditor0517</em></p>\n<p>This function is changing the protocol fee that is used during interest calculation <a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L477-L488\">here</a>.</p>\n<p>But it doesn’t update interest before changing the fee so the <code>_feesAmount</code> will be calculated wrongly.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>As we can see during <a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L326\">pause()</a> and <a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L335\">unpause()</a>, <code>_addInterest()</code> must be called before any changes.</p>\n<p>But with the <a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L215\">changeFee()</a>, it doesn’t update interest and the <code>_feesAmount</code> might be calculated wrongly.</p>\n<ul>\n<li>At time <code>T1</code>, <a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L477\">_currentRateInfo.feeToProtocolRate = F1</a>.</li>\n<li>At <code>T2</code>, the owner had changed the fee to <code>F2</code>.</li>\n<li>At <code>T3</code>, <a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L409\">_addInterest()</a> is called during <code>deposit()</code> or other functions.</li>\n<li>Then <a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L477-L488\">during this calculation</a>, <code>F1</code> should be applied from <code>T1</code> to <code>T2</code> and <code>F2</code> should be applied from <code>T2</code> and <code>T3</code>. But it uses <code>F2</code> from <code>T1</code> to <code>T2</code>.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Recommend modifying <code>changeFee()</code> like below.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function changeFee(uint32 _newFee) external whenNotPaused {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (msg.sender != TIME_LOCK_ADDRESS) revert OnlyTimeLock();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_newFee &gt; MAX_PROTOCOL_FEE) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        revert BadProtocolFee();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _addInterest(); //+++++++++++++++++++++++++++++++++</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    currentRateInfo.feeToProtocolRate = _newFee;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit ChangeFee(_newFee);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/236#issuecomment-1238159753\">DrakeEvans (Frax) confirmed, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Disagree with severity as it can be mitigated by calling <code>addInterest()</code> beforehand by admin or regular user.  But we will address it anyway for convenience. We assume admins are not malicious.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/236#issuecomment-1238249426\">0xA5DF (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Admins might not be malicious, but without knowing about the issue (i.e. if the warden hasn’t reported this) they wouldn’t call <code>addInterest()</code> beforehand, leading to higher interest than intended.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/236#issuecomment-1263082292\">gititGoro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Maintaining severity as it is a potential leakage.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-owner-of-fraxlendpair-can-set-arbitrary-time-lock-contract-address-to-circumvent-time-lock\" style=\"position:relative;\"><a href=\"#m-08-owner-of-fraxlendpair-can-set-arbitrary-time-lock-contract-address-to-circumvent-time-lock\" aria-label=\"m 08 owner of fraxlendpair can set arbitrary time lock contract address to circumvent time lock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/156\">[M-08] Owner of <code>FraxlendPair</code> can set arbitrary time lock contract address to circumvent time lock</a></h2>\n<p><em>Submitted by berndartmueller</em></p>\n<p>The ownership of a deployed Fraxlend pair is transferred to <code>COMPTROLLER_ADDRESS</code> on deployment via <code>FraxlendPairDeployer_deploySecond</code>. This very owner is able to change the currently used time lock contract address with the <code>FraxlendPair.setTimeLock</code> function. A time lock is enforced on the <code>FraxlendPair.changeFee</code> function whenever the protocol fee is adjusted.</p>\n<p>However, as the Fraxlend pair owner is able to change the time lock contract address to any other arbitrary (contract) address, it is possible to circumvent this timelock without users knowing. By using a custom smart contract without an enforced time lock, the protocol fee can be changed at any time without a proper time lock.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L206\">FraxlendPair.sol#L206</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @notice The ```setTimeLock``` function sets the TIME_LOCK address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @param _newAddress the new time lock address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setTimeLock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newAddress</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SetTimeLock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TIME_LOCK_ADDRESS</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_newAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">TIME_LOCK_ADDRESS</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_newAddress</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Currently, the owner <code>COMPTROLLER_ADDRESS</code> address is trustworthy, however, nothing prevents the above-described scenario. To protect users from sudden protocol fee changes, consider using a minimal time lock implementation directly implemented in the contract without trusting any external contract.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/156\">DrakeEvans (Frax) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-09-fraxlendpairsol-is-not-fully-eip-4626-compliant\" style=\"position:relative;\"><a href=\"#m-09-fraxlendpairsol-is-not-fully-eip-4626-compliant\" aria-label=\"m 09 fraxlendpairsol is not fully eip 4626 compliant permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/79\">[M-09] FraxlendPair.sol is not fully EIP-4626 compliant</a></h2>\n<p><em>Submitted by 0x52, also found by berndartmueller, cryptphi, and Lambda</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L136-L138\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L136-L138</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L140-L142\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L140-L142</a></p>\n<h3 id=\"impact-6\" style=\"position:relative;\"><a href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>FraxlendPair.sol is not EIP-4626 compliant, variation from the standard could break composability and potentially lead to loss of funds.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>According to EIP-4626 method specifications (<a href=\"https://eips.ethereum.org/EIPS/eip-4626\">https://eips.ethereum.org/EIPS/eip-4626</a>)</p>\n<p>For maxDeposit:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">MUST factor in both global and user-specific limits, like if deposits are entirely disabled (even temporarily) it MUST return 0.</span></span></code></pre>\n<p>For maxMint:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">MUST factor in both global and user-specific limits, like if mints are entirely disabled (even temporarily) it MUST return 0.</span></span></code></pre>\n<p>When FraxlendPair.sol is paused, deposit and mint are both disabled. This means that maxMint and maxDeposit should return 0 when the contract is paused.</p>\n<p>The current implementations of maxMint and maxDeposit do not follow this specification:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function maxDeposit(address) external pure returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return type(uint128).max;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function maxMint(address) external pure returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return type(uint128).max;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>No matter the state of the contract they always return uint128.max, but they should return 0 when the contract is paused.</p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>maxDeposit and maxMint should be updated to return 0 when contract is paused. Use of the whenNotPaused modifier is not appropriate because that would cause a revert and maxDeposit and maxMint should never revert according to EIP-4626.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/79\">DrakeEvans (Frax) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-10-decimals-limitation-limits-the-tokens-that-can-be-used\" style=\"position:relative;\"><a href=\"#m-10-decimals-limitation-limits-the-tokens-that-can-be-used\" aria-label=\"m 10 decimals limitation limits the tokens that can be used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/200\">[M-10] Decimals limitation limits the tokens that can be used</a></h2>\n<p><em>Submitted by CertoraInc</em></p>\n<p>Decimals limitation limits the tokens that can be used.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Let’s give some name to the decimals of certain numbers:\nn = decimals of numerator oracle.\nd =  decimals denominator oracle.\na = decimals of the asset.\nc= decimals of the collateral.</p>\n<p>Now, the <code>oracleNormalization = 10 ^(18 + n - d + a - c)</code>.</p>\n<p>And here: <a href=\"https://github.com/code-423n4/2022-08-frax/blob/main/src/contracts/FraxlendPairCore.sol#L536\">https://github.com/code-423n4/2022-08-frax/blob/main/src/contracts/FraxlendPairCore.sol#L536</a> , <code>price</code> has decimals of <code>36 + n -d</code>, so <code>here()</code> when we calculate <code>_exchangeRate = _price / oracleNormalization;</code> it would underflow and revert if <code>a >18 +c</code>.</p>\n<p>And that’s a pretty big limitation on the tokens options. We have USDC which have 6 decimals so all the tokens the their decimals &#x3C; 24 are not possible to use in this system (with USDC together).</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/200#issuecomment-1238077975\">DrakeEvans (Frax) disputed, disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Known issue, prevents certain combinations of tokens from being deployed.  No high risk as no deployment will occur.  No funds at risk, no incorrect functionality. Low at best.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/200#issuecomment-1266177019\">gititGoro (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>This hasn’t been listed as a known issue so it can’t be marked invalid but since deployments can’t occur, it’s a Medium severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-fraxlend-pair-deployment-can-be-front-run-by-a-custom-pair-deployment\" style=\"position:relative;\"><a href=\"#m-11-fraxlend-pair-deployment-can-be-front-run-by-a-custom-pair-deployment\" aria-label=\"m 11 fraxlend pair deployment can be front run by a custom pair deployment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/166\">[M-11] Fraxlend pair deployment can be front-run by a custom pair deployment</a></h2>\n<p><em>Submitted by berndartmueller, also found by IllIllI</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L205\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L205</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L329-L330\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L329-L330</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L253\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L253</a></p>\n<h3 id=\"impact-7\" style=\"position:relative;\"><a href=\"#impact-7\" aria-label=\"impact 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The <code>FraxlendPairDeployer</code> contract used to deploy Fraxlend pairs prevents deploying pairs with the same <code>salt</code> and <code>_configData</code>. This makes it vulnerable to front-running pair deployments and prevents deploying honest Fraxlend pairs.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L205\">FraxlendPairDeployer._deployFirst</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_deployFirst</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_saltSeed</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_immutables</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturityDate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_penaltyRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_isBorrowerWhitelistActive</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_isLenderWhitelistActive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// _saltSeed is the same for all public pairs so duplicates cannot be created</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">salt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_saltSeed</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">deployedPairsBySalt</span><span class=\"mtk1\">[</span><span class=\"mtk12\">salt</span><span class=\"mtk1\">] == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;FraxlendPairDeployer: Pair already deployed&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit-info Reverts if a pair with the same salt is already deployed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_creationCode</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">BytesLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">concat</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">SSTORE2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">read</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractAddress1</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">SSTORE2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">read</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractAddress2</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bytecode</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_creationCode</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_immutables</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_maturityDate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_penaltyRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_isBorrowerWhitelistActive</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">_isLenderWhitelistActive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            _pairAddress := </span><span class=\"mtk11\">create2</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytecode</span><span class=\"mtk1\">, </span><span class=\"mtk7\">32</span><span class=\"mtk1\">), </span><span class=\"mtk11\">mload</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytecode</span><span class=\"mtk1\">), </span><span class=\"mtk12\">salt</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;FraxlendPairDeployer: create2 failed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">deployedPairsBySalt</span><span class=\"mtk1\">[</span><span class=\"mtk12\">salt</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>A deployed Fraxlend pair address is stored in the <code>deployedPairsBySalt</code> mapping using a <code>salt</code> as the key. This salt is generated based on a seed <code>_saltSeed</code> and <code>_configData</code>. Deploying a standard Fraxlend pair with <code>FraxlendPairDeployer.deploy</code> uses <code>_saltSeed = keccak256(abi.encodePacked(\"public\"))</code> and user-defined <code>_configData</code>. The salt is the same for all standard deployments.</p>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L329-L330\">FraxlendPairDeployer.deploy</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_collateral</span><span class=\"mtk1\">, , , , </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rateContract</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_name</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">string</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;FraxlendV1 - &quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_collateral</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeName</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeName</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot; - &quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">IRateCalculator</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_rateContract</span><span class=\"mtk1\">).</span><span class=\"mtk11\">name</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot; - &quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">deployedPairsArray</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">toString</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_deployFirst</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;public&quot;</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">CIRCUIT_BREAKER_ADDRESS</span><span class=\"mtk1\">, </span><span class=\"mtk12\">COMPTROLLER_ADDRESS</span><span class=\"mtk1\">, </span><span class=\"mtk12\">TIME_LOCK_ADDRESS</span><span class=\"mtk1\">, </span><span class=\"mtk12\">FRAXLEND_WHITELIST_ADDRESS</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">DEFAULT_MAX_LTV</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">DEFAULT_LIQ_FEE</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">false</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_deploySecond</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">, </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_logDeploy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">, </span><span class=\"mtk12\">DEFAULT_MAX_LTV</span><span class=\"mtk1\">, </span><span class=\"mtk12\">DEFAULT_LIQ_FEE</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>A whitelisted (and potentially dishonest) user could watch the mempool for new Fraxlend pair deployments and front-run deployments with a custom pair deployment by calling <code>FraxlendPairDeployer.deployCustom</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L355-L388\">FraxlendPairDeployer.deployCustom</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deployCustom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturityDate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_penaltyRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_approvedBorrowers</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_approvedLenders</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">GLOBAL_MAX_LTV</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;FraxlendPairDeployer: _maxLTV is too large&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IFraxlendWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FRAXLEND_WHITELIST_ADDRESS</span><span class=\"mtk1\">).</span><span class=\"mtk11\">fraxlendDeployerWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;FraxlendPairDeployer: Only whitelisted addresses&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_deployFirst</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">CIRCUIT_BREAKER_ADDRESS</span><span class=\"mtk1\">, </span><span class=\"mtk12\">COMPTROLLER_ADDRESS</span><span class=\"mtk1\">, </span><span class=\"mtk12\">TIME_LOCK_ADDRESS</span><span class=\"mtk1\">, </span><span class=\"mtk12\">FRAXLEND_WHITELIST_ADDRESS</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_maturityDate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_penaltyRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_approvedBorrowers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_approvedLenders</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_deploySecond</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_approvedBorrowers</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_approvedLenders</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">deployedPairCustomStatusByAddress</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_logDeploy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_maturityDate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Internally the <code>FraxlendPairDeployer.deployCustom</code> uses the same <code>_deployFirst</code> function as a standard pair deployment uses. However, the salt is user-definable by using any <code>_name</code>, for instance <code>public</code>. Then the salt is the same as <code>_saltSeed = keccak256(abi.encodePacked(\"public\"))</code>. The user then uses the same <code>_configData</code> as the to be deployed pair. But, contrary to a standard pair deployment, a whitelisted user is also able to provide additional configuration, <code>_maxLTV</code>, <code>_liquidationFee</code> and so on.</p>\n<p>The whitelisted user is able to deploy a custom Fraxlend pair with the same salt and the same <code>_configData</code> but by using for instance a <code>_maturityDate &#x3C; block.timestamp</code>, this deployed custom pool is unusable (due to the modifier <code>isNotPastMaturity</code> reverting. This modifier is used by <code>FraxlendPairCore.deposit</code>, <code>FraxlendPairCore.mint</code>, <code>FraxlendPairCore.borrowAsset</code>, <code>FraxlendPairCore.addCollateral</code> and <code>FraxlendPairCore.leveragedPosition</code>).</p>\n<p>As <code>FraxlendPairDeployer._deployFirst</code> checks if a pair is already deployed with a given salt, the honest pair deployment that got front-run reverts. It is now not possible to deploy a pair with the same configuration.</p>\n<p><strong>NOTE:</strong> The same can be achieved by front-running a pair deployment transaction with a custom pair deployment and with the same name (<code>FraxlendPairDeployer.deployCustom</code> allows providing an arbitrary name . <code>FraxlendPairDeployer._deploySecond</code> checks the name of the pair and reverts if a pair with that name already exists:</p>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L253\">FraxlendPairDeployer._deploySecond</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_deploySecond</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_approvedBorrowers</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_approvedLenders</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (, , , , , , </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rateInitData</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">deployedPairsByName</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">] == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;FraxlendPairDeployer: Pair name must be unique&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit-info reverts if a pair with the same name exists already</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">deployedPairsByName</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">deployedPairsArray</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Set additional values for FraxlendPair</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IFraxlendPair</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fraxlendPair</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IFraxlendPair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_fraxlendPair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_approvedBorrowers</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_approvedLenders</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_rateInitData</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Transfer Ownership of FraxlendPair</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_fraxlendPair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferOwnership</span><span class=\"mtk1\">(</span><span class=\"mtk12\">COMPTROLLER_ADDRESS</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider validating the <code>_name</code> parameter in the <code>FraxlendPairDeployer.deployCustom</code> function to not equal the string <code>public</code>, thus preventing the usage of the same salt as a standard pair deployment.</p>\n<p>Additionally, consider prefixing the name of a custom pair deployment to also prevent front-running this way.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/166\">DrakeEvans (Frax) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"m-12-denial-of-service-in-globalpause-by-wrong-logic\" style=\"position:relative;\"><a href=\"#m-12-denial-of-service-in-globalpause-by-wrong-logic\" aria-label=\"m 12 denial of service in globalpause by wrong logic permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/76\">[M-12] Denial of service in globalPause by wrong logic</a></h2>\n<p><em>Submitted by 0x1f8b</em></p>\n<p>The method <code>globalPause</code> is not tested and it doesn’t work as expected.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Because the method returns an array (<code>_updatedAddresses</code>) and has never been initialized, when you want to set its value, it fails.</p>\n<p>Recipe:</p>\n<ul>\n<li>Call <code>globalPause</code> with any valid address.</li>\n<li>The transaction will FAULT.</li>\n</ul>\n<h4 id=\"affected-source-code\" style=\"position:relative;\"><a href=\"#affected-source-code\" aria-label=\"affected source code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected source code</h4>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L405\">FraxlendPairDeployer.sol#L405</a></li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Initialize the <code>_updatedAddresses</code> array like shown below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function globalPause(address[] memory _addresses) external returns (address[] memory _updatedAddresses) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        require(msg.sender == CIRCUIT_BREAKER_ADDRESS, &quot;Circuit Breaker only&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address _pairAddress;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 _lengthOfArray = _addresses.length;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       _updatedAddresses = new address[](_lengthOfArray);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        for (uint256 i = 0; i &lt; _lengthOfArray; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            _pairAddress = _addresses[i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            try IFraxlendPair(_pairAddress).pause() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                _updatedAddresses[i] = _addresses[i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } catch {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                i = i + 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/76#issuecomment-1238100769\">DrakeEvans (Frax) confirmed, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Valid, disagree with severity.  This is a convenience function.  Pause can still be called on the pairs themselves individually.  No user funds at risk, and no users can even touch this function, additionally no loss of functionality in the pairs themselves.  Only result is admin having to revert and spin up tx individually.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/76#issuecomment-1266162395\">gititGoro (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Well caught! But definitely a Medium severity, given the existence of per pair pausing.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-13-no-incentives-to-write-off-bad-debt-when-remaining-collateral-is-very-small\" style=\"position:relative;\"><a href=\"#m-13-no-incentives-to-write-off-bad-debt-when-remaining-collateral-is-very-small\" aria-label=\"m 13 no incentives to write off bad debt when remaining collateral is very small permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/38\">[M-13] No incentives to write off bad debt when remaining collateral is very small</a></h2>\n<p><em>Submitted by Lambda</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/b58c9b72f5fe8fab81f7436504e7daf60fd124e3/src/contracts/FraxlendPairCore.sol#L989\">https://github.com/code-423n4/2022-08-frax/blob/b58c9b72f5fe8fab81f7436504e7daf60fd124e3/src/contracts/FraxlendPairCore.sol#L989</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/b58c9b72f5fe8fab81f7436504e7daf60fd124e3/src/contracts/FraxlendPairCore.sol#L1002\">https://github.com/code-423n4/2022-08-frax/blob/b58c9b72f5fe8fab81f7436504e7daf60fd124e3/src/contracts/FraxlendPairCore.sol#L1002</a></p>\n<h3 id=\"impact-8\" style=\"position:relative;\"><a href=\"#impact-8\" aria-label=\"impact 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>When a position only has a bit of collateral left (e.g., because a previous <code>liquidateClean</code> call provided just too little shares or the exchange rate just changed), there is no incentive anymore to call <code>liquidateClean</code> again. The maximum amount that a user will get is the remaining collateral balance, which does not cover the gas fees in such cases.</p>\n<p>Therefore, the bad debt is never written off, meaning that the mechanism does not work in such cases and these pairs become toxic (as the last user will have to pay for the leftover borrow shares).</p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>To avoid such scenarios, it should not be possible to remove almost all of the collateral. Consider introducing an upper limit, e.g. 95%. Above this limit, no dirty liquidations would be allowed.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/38#issuecomment-1237964795\">DrakeEvans (Frax) acknowledged, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>This is inherent in high gas fee environments.  There are significant incentives to avoid this with the clean liquidation fee being 11% higher than the dirty liquidation fee.  To create this scenario the liquidator would need to do a dirty liquidation first.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/38#issuecomment-1264718707\">gititGoro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This sort of thing seems unavoidable when gas is present. Aave documentation refers to residual untouched balances as ‘dust’. If the pair is worth recapitalizing then the gas hit will be worth it. It doesn’t appear that there are problems with incentives here.</p>\n<p>And there isn’t an obvious QA improvement.</p>\n<p>The mitigation adds a gas overhead for rare, mostly harmless boundary cases which does not seem to be prudent when deploying to mainnet.</p>\n<p>Value is technically leaked but acknowledgement from sponsor seems appropriate in this case.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 85 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/191\">report highlighted below</a> by <strong>0x1f8b</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/143\">pfapostol</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/23\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/261\">yac</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/345\">brgltd</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/329\">Deivitto</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/211\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/246\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/16\">mics</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/8\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/197\">Bnke0x0</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/336\">reassor</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/269\">0xDjango</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/199\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/134\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/63\">robee</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/341\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/360\">rbserver</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/139\">Junnon</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/32\">gogo</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/28\">RoiEvenHaim</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/70\">ReyAdmirado</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/315\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/135\">tabish</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/316\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/60\">CodingNameKiki</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/241\">auditor0517</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/215\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/253\">beelzebufo</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/205\">kyteg</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/30\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/53\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/88\">ballx</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/106\">LeoS</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/157\">berndartmueller</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/6\">erictee</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/125\">ret2basic</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/337\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/80\">0x52</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/152\">ayeslick</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/196\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/107\">yash90</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/312\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/220\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/358\">JC</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/186\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/364\">medikko</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/231\">cryptonue</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/265\">cryptphi</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/222\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/214\">sach1r0</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/174\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/306\">Sm4rty</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/101\">sryysryy</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/55\">durianSausage</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/217\">dy</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/276\">minhquanym</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/310\">Rohan16</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/193\">zzzitron</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/359\">a12jmx</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/362\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/281\">ak1</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/338\">asutorufos</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/188\">CertoraInc</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/263\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/351\">0xsolstars</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/181\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/314\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/95\">djxploit</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/348\">SooYa</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/155\">_Adam</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/218\">0xmatt</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/72\">cRat1st0s</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/356\">The_GUILD</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/103\">Yiko</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/346\">EthLedger</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/275\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/3\">ignacio</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/97\">Noah3o6</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/357\">0xNineDec</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/343\">d3e4</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/308\">dipp</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/163\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/195\">PaludoX0</a>, and <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/123\">SaharAP</a>.</em></p>\n<h2 id=\"low-risk-issues\" style=\"position:relative;\"><a href=\"#low-risk-issues\" aria-label=\"low risk issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Issues</h2>\n<h2 id=\"l-01-outdated-compiler\" style=\"position:relative;\"><a href=\"#l-01-outdated-compiler\" aria-label=\"l 01 outdated compiler permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Outdated compiler</h2>\n<p>The pragma version used is:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">pragma solidity ^0.8.15;</span></span></code></pre>\n<p>The minimum required version must be <a href=\"https://github.com/ethereum/solidity/releases/tag/v0.8.16\">0.8.16</a>; otherwise, contracts will be affected by the following <strong>important bug fixes</strong>:</p>\n<p><a href=\"https://blog.soliditylang.org/2022/08/08/solidity-0.8.16-release-announcement/\">0.8.16</a></p>\n<ul>\n<li>Code Generation: Fix data corruption that affected ABI-encoding of calldata values represented by tuples: structs at any nesting level; argument lists of external functions, events and errors; return value lists of external functions. The 32 leading bytes of the first dynamically-encoded value in the tuple would get zeroed when the last component contained a statically-encoded array.</li>\n</ul>\n<p>Apart from these, there are several minor bug fixes and improvements.</p>\n<h2 id=\"l-02-safeerc20-mismatch-logics\" style=\"position:relative;\"><a href=\"#l-02-safeerc20-mismatch-logics\" aria-label=\"l 02 safeerc20 mismatch logics permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] <code>SafeERC20</code> mismatch logics</h2>\n<p>The <code>SafeERC20</code> library says:</p>\n<blockquote>\n<p>@title SafeERC20 provides helper functions for safe transfers as well as safe metadata access</p>\n</blockquote>\n<p>But the reality is that <em>metada access</em> is not secure.</p>\n<p>The <code>SafeERC20.safeTransfer</code> and <code>SafeERC20.safeTransferFrom</code> methods perform a safe check that the address to call is a contract by calling <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/2dc086563f2e51620ebc43d2237fc10ef201c4e6/contracts/token/ERC20/utils/SafeERC20.sol#L110\">functionCall</a>, this checks doesn’t appear in the methods <code>safeSymbol</code>, <code>safeName</code> and <code>safeDecimals</code>, so some of the <code>SafeERC20</code> library methods are prone to <a href=\"https://media.dedaub.com/phantom-functions-and-the-billion-dollar-no-op-c56f062ae49f\">phantom methods</a> attacks.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>If you try to call the <code>SafeERC20</code> methods with the following token <code>0x000000000000000000000000000000000000000000000</code> (or any EOA) you can see that the transaction is successful, you have to check that the address is a valid contract and maybe check that the call returns a certain data. Otherwise it is possible to call it and lose tokens or produce undesired errors.</p>\n<p>This reminds me of this attack <a href=\"https://certik.medium.com/qubit-bridge-collapse-exploited-to-the-tune-of-80-million-a7ab9068e1a0\">https://certik.medium.com/qubit-bridge-collapse-exploited-to-the-tune-of-80-million-a7ab9068e1a0</a> where we can see:</p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/libraries/SafeERC20.sol#L39-L58\">SafeERC20.sol#L39-L58</a></li>\n</ul>\n<h3 id=\"recommended-changes\" style=\"position:relative;\"><a href=\"#recommended-changes\" aria-label=\"recommended changes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended changes</h3>\n<ul>\n<li>Use <code>functionStaticCall</code> from OpenZeppelin.</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+import &quot;@openzeppelin/contracts/utils/Address.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">library SafeERC20 {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    using Address for address;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @notice Provides a safe ERC20.symbol version which returns &#39;???&#39; as fallback string.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param token The address of the ERC-20 token contract.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @return (string) Token symbol.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function safeSymbol(IERC20 token) internal view returns (string memory) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       (bool success, bytes memory data) = address(token).staticcall(abi.encodeWithSelector(SIG_SYMBOL));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       (bool success, bytes memory data) = address(token).functionStaticCall(abi.encodeWithSelector(SIG_SYMBOL));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        return success ? returnDataToString(data) : &quot;???&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @notice Provides a safe ERC20.name version which returns &#39;???&#39; as fallback string.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param token The address of the ERC-20 token contract.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @return (string) Token name.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function safeName(IERC20 token) internal view returns (string memory) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       (bool success, bytes memory data) = address(token).staticcall(abi.encodeWithSelector(SIG_NAME));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       (bool success, bytes memory data) = address(token).functionStaticCall(abi.encodeWithSelector(SIG_NAME));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        return success ? returnDataToString(data) : &quot;???&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @notice Provides a safe ERC20.decimals version which returns &#39;18&#39; as fallback value.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param token The address of the ERC-20 token contract.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @return (uint8) Token decimals.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function safeDecimals(IERC20 token) internal view returns (uint8) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       (bool success, bytes memory data) = address(token).staticcall(abi.encodeWithSelector(SIG_DECIMALS));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       (bool success, bytes memory data) = address(token).functionStaticCall(abi.encodeWithSelector(SIG_DECIMALS));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        return success &amp;&amp; data.length == 32 ? abi.decode(data, (uint8)) : 18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"l-03-lack-of-ack-during-owner-change\" style=\"position:relative;\"><a href=\"#l-03-lack-of-ack-during-owner-change\" aria-label=\"l 03 lack of ack during owner change permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Lack of ACK during owner change</h2>\n<p>It’s possible to lose the ownership under specific circumstances.</p>\n<p>Because of human error it’s possible to set a new invalid owner. When you want to change the owner’s address it’s better to propose a new owner, and then accept this ownership with the new wallet.</p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L30\">FraxlendWhitelist.sol#L30</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-08-frax/blob/main/src/contracts/FraxlendPairDeployer.sol#L44\">FraxlendPairDeployer.sol#L44</a></li>\n</ul>\n<h2 id=\"l-04-constant-salt\" style=\"position:relative;\"><a href=\"#l-04-constant-salt\" aria-label=\"l 04 constant salt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Constant salt</h2>\n<p>It’s not possible to use <code>public</code> as pair name, if you are using the same default values as was used in <code>deploy</code>.</p>\n<p>Becuase the salt for deploy is <em>“public”</em>, it is not possible to use the same as a name.</p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L329\">FraxlendPairDeployer.sol#L329</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L372\">FraxlendPairDeployer.sol#L372</a></li>\n</ul>\n<h3 id=\"recommended-changes-1\" style=\"position:relative;\"><a href=\"#recommended-changes-1\" aria-label=\"recommended changes 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended changes</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   keccak256(abi.encodePacked(_name)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   keccak256(abi.encodePacked(&quot;custom&quot;, _name)),</span></span></span></code></pre>\n<h2 id=\"l-05-bypass-timelock-restrictions\" style=\"position:relative;\"><a href=\"#l-05-bypass-timelock-restrictions\" aria-label=\"l 05 bypass timelock restrictions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] Bypass <code>TimeLock</code> restrictions</h2>\n<p>Esto permite que llamadas como la que se muestran a continuacion, que se encuentran limitadas al contrato de <code>TIME_LOCK_ADDRESS</code>, sea posible ser llamadas por el owner, evitando cualquier limitación de tiempo, debido a que en primer lugar no se comprueba que la direccion establecida en <code>setTimeLock</code> sea un contrato, y segundo, porque podria establecer cualquier contrato, y en la misma llamada hacer la llamada limitada al <code>TimeLock</code>.</p>\n<p>The <code>FraxlendPair</code> contract has a <code>setTimeLock</code> method that allows you to modify the <code>TimeLock</code> contract (<code>TIME_LOCK_ADDRESS</code>), this call is protected by the <code>onlyOwner</code> modifier.</p>\n<p>This allows the owner to call methods like the one shown below (<code>changeFee</code>), which are limited to the <code>TIME_LOCK_ADDRESS</code> contract, avoiding any time constraints, since the established address in <code>setTimeLock</code> is not checked to be a contract, you could set any contract, and in the same transaction you can call the protected method.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">changeFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newFee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenNotPaused</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">TIME_LOCK_ADDRESS</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">OnlyTimeLock</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>This can facilitate rogue pool attacks.</p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L204-L222\">FraxlendPair.sol#L204-L222</a></li>\n</ul>\n<h2 id=\"l-06-division-before-multiple-can-lead-to-precision-errors\" style=\"position:relative;\"><a href=\"#l-06-division-before-multiple-can-lead-to-precision-errors\" aria-label=\"l 06 division before multiple can lead to precision errors permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-06] Division before multiple can lead to precision errors</h2>\n<p>Because Solidity integer division may truncate, it is often preferable to do multiplication before division to prevent precision loss.</p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L315\">FraxlendPairCore.sol#L315</a></li>\n</ul>\n<h3 id=\"recommended-changes-2\" style=\"position:relative;\"><a href=\"#recommended-changes-2\" aria-label=\"recommended changes 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended changes</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 internal constant LTV_PRECISION = 1e5; // 5 decimals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 internal constant EXCHANGE_PRECISION = 1e18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   uint256 internal constant SOLVENT_PRECISION = EXCHANGE_PRECISION / LTV_PRECISION; // 1e13</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function _isSolvent(address _borrower, uint256 _exchangeRate) internal view returns (bool) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (maxLTV == 0) return true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 _borrowerAmount = totalBorrow.toAmount(userBorrowShares[_borrower], true);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (_borrowerAmount == 0) return true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 _collateralAmount = userCollateralBalance[_borrower];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (_collateralAmount == 0) return false;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       uint256 _ltv = (((_borrowerAmount * _exchangeRate) / EXCHANGE_PRECISION) * LTV_PRECISION) / _collateralAmount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       uint256 _ltv = (_borrowerAmount * _exchangeRate) / (_collateralAmount * SOLVENT_PRECISION);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        return _ltv &lt;= maxLTV;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"l-07-ownable-and-pausable\" style=\"position:relative;\"><a href=\"#l-07-ownable-and-pausable\" aria-label=\"l 07 ownable and pausable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-07] <code>Ownable</code> and <code>Pausable</code></h2>\n<p>The contract <code>FraxlendPairCore</code> is <code>Ownable</code> and <code>Pausable</code>, so the owner could resign while the contract is paused, causing a Denial of Service. Owner resignation while the contract is paused should be avoided.</p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L46\">FraxlendPairCore.sol#L46</a></li>\n</ul>\n<hr>\n<h2 id=\"non-critical-issues\" style=\"position:relative;\"><a href=\"#non-critical-issues\" aria-label=\"non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Issues</h2>\n<h2 id=\"n-01-use-encode-instead-of-encodepacked-for-hashig\" style=\"position:relative;\"><a href=\"#n-01-use-encode-instead-of-encodepacked-for-hashig\" aria-label=\"n 01 use encode instead of encodepacked for hashig permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Use <code>encode</code> instead of <code>encodePacked</code> for hashig</h2>\n<p>Use of <code>abi.encodePacked</code> is safe, but unnecessary and not recommended. <code>abi.encodePacked</code> can result in hash collisions when used with two dynamic arguments (string/bytes).</p>\n<p>There is also discussion of removing <code>abi.encodePacked</code> from future versions of Solidity (<a href=\"https://github.com/ethereum/solidity/issues/11593\">ethereum/solidity#11593</a>), so using <code>abi.encode</code> now will ensure compatibility in the future.</p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L204\">FraxlendPairDeployer.sol#L204</a></li>\n</ul>\n<h2 id=\"n-02-wrong-comment-of-toborrowamount-function\" style=\"position:relative;\"><a href=\"#n-02-wrong-comment-of-toborrowamount-function\" aria-label=\"n 02 wrong comment of toborrowamount function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] Wrong comment of <code>toBorrowAmount</code> function</h2>\n<p>The function <code>toBorrowAmount</code> is wrongly commented.</p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L187-L190\">FraxlendPair.sol#L187-L190</a></li>\n</ul>\n<h3 id=\"recommended-changes-3\" style=\"position:relative;\"><a href=\"#recommended-changes-3\" aria-label=\"recommended changes 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended changes</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   /// @notice The ```toBorrtoBorrowAmountowShares``` function converts a given amount of borrow debt into the number of shares</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   /// @notice The ```toBorrowAmount``` function converts a given number of shares into the amount of borrow debt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param _shares Shares of borrow</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param _roundUp Whether to roundup during division</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function toBorrowAmount(uint256 _shares, bool _roundUp) external view returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        return totalBorrow.toAmount(_shares, _roundUp);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"n-03-confusing-variables-as-to-how-they-are-stored\" style=\"position:relative;\"><a href=\"#n-03-confusing-variables-as-to-how-they-are-stored\" aria-label=\"n 03 confusing variables as to how they are stored permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] Confusing variables as to how they are stored</h2>\n<p>The <code>FraxlendPairCore</code> contract constructor takes two arguments, <code>_configData</code> and <code>_immutables</code>, however, there are immutables in <code>_configData</code> and variables in <code>_immutables</code>.</p>\n<p>This may seem confusing, since for example one expects the <code>TIME_LOCK_ADDRESS</code> to be immutable as it is defined in the <code>_immutables</code> variable, however it is possible to change it with <a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L204\">setTimeLock</a>.</p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L174\">FraxlendPairCore.sol#L174</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L190-L191\">FraxlendPairCore.sol#L190-L191</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L193-L197\">FraxlendPairCore.sol#L193-L197</a></li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/191#issuecomment-1269063966\">gititGoro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Very good report quality!\nThere were some invalid points:</p>\n<ul>\n<li>L-02. Misconfigured or misbehaving tokens are out of scope</li>\n<li>L-06. The precision cap is intentional. This issue was reported as a Medium risk bug by another warden and marked invalid.</li>\n<li>L-07. Owners resigning seems beyond the scope of the audit. FraxLend will be managed by a DAO like other Frax products. Even without explicit documentation, for a Frax product, this should be the assumed default. This is if you were unable to contact the sponsor and verify explicitly that a human controlled EOA would be the owner, a very uncommon circumstance for a large mainnet dapp.</li>\n</ul>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 94 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/245\">report highlighted below</a> by <strong>IllIllI</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/355\">JC</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/328\">Deivitto</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/149\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/320\">ajtra</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/190\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/350\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/7\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/121\">ret2basic</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/180\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/104\">Bnke0x0</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/173\">Chinmay</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/198\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/116\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/13\">0xkatana</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/69\">ReyAdmirado</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/31\">gogo</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/24\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/226\">Tomio</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/5\">erictee</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/304\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/133\">pfapostol</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/289\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/301\">Rohan16</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/54\">durianSausage</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/130\">_Adam</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/319\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/2\">ignacio</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/268\">0xDjango</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/324\">m_Rassska</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/344\">medikko</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/96\">Noah3o6</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/332\">rbserver</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/62\">robee</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/170\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/232\">LeoS</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/299\">Sm4rty</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/352\">brgltd</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/219\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/335\">reassor</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/297\">saian</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/210\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/17\">mics</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/202\">kyteg</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/302\">NoamYakov</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/144\">flyx</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/122\">SaharAP</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/309\">Amithuddar</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/29\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/323\">Fitraldys</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/87\">ballx</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/178\">gerdusx</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/138\">Junnon</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/326\">Metatron</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/58\">2997ms</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/128\">carlitox477</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/71\">cRat1st0s</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/216\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/68\">newfork01</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/300\">SooYa</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/100\">sryysryy</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/59\">chrisdior4</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/61\">CodingNameKiki</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/313\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/255\">0xackermann</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/272\">ak1</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/321\">asutorufos</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/342\">d3e4</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/94\">djxploit</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/271\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/131\">jag</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/137\">mrpathfindr</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/91\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/213\">sach1r0</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/208\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/26\">Diraco</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/260\">Randyyy</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/105\">Yiko</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/363\">a12jmx</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/74\">zeesaw</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/262\">0xc0ffEE</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/267\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/347\">EthLedger</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/27\">IgnacioB</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/34\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/67\">dharma09</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/66\">hakerbaya</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/160\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/124\">nxrblsrpr</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/194\">PaludoX0</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/114\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/25\">find_a_bug</a>, <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/127\">francoHacker</a>, and <a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/113\">ltyu</a>.</em></p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[G‑01]</td>\n<td align=\"left\">String should only be generated once, and saved</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[G‑02]</td>\n<td align=\"left\">Remove or replace unused state variables</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[G‑03]</td>\n<td align=\"left\">Multiple <code>address</code>/ID mappings can be combined into a single <code>mapping</code> of an <code>address</code>/ID to a <code>struct</code>, where appropriate</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[G‑04]</td>\n<td align=\"left\">Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</td>\n<td align=\"center\">11</td>\n</tr>\n<tr>\n<td>[G‑05]</td>\n<td align=\"left\">Using <code>storage</code> instead of <code>memory</code> for structs/arrays saves gas</td>\n<td align=\"center\">16</td>\n</tr>\n<tr>\n<td>[G‑06]</td>\n<td align=\"left\">State variables should be cached in stack variables rather than re-reading them from storage</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[G‑07]</td>\n<td align=\"left\"><code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[G‑08]</td>\n<td align=\"left\">Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>[G‑09]</td>\n<td align=\"left\"><code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</td>\n<td align=\"center\">7</td>\n</tr>\n<tr>\n<td>[G‑10]</td>\n<td align=\"left\"><code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</td>\n<td align=\"center\">8</td>\n</tr>\n<tr>\n<td>[G‑11]</td>\n<td align=\"left\"><code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</td>\n<td align=\"center\">8</td>\n</tr>\n<tr>\n<td>[G‑12]</td>\n<td align=\"left\">Optimize names to save gas</td>\n<td align=\"center\">6</td>\n</tr>\n<tr>\n<td>[G‑13]</td>\n<td align=\"left\">Using <code>bool</code>s for storage incurs overhead</td>\n<td align=\"center\">9</td>\n</tr>\n<tr>\n<td>[G‑14]</td>\n<td align=\"left\"><code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</td>\n<td align=\"center\">9</td>\n</tr>\n<tr>\n<td>[G‑15]</td>\n<td align=\"left\">Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>[G‑16]</td>\n<td align=\"left\">Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</td>\n<td align=\"center\">13</td>\n</tr>\n<tr>\n<td>[G‑17]</td>\n<td align=\"left\">Using <code>private</code> rather than <code>public</code> for constants, saves gas</td>\n<td align=\"center\">8</td>\n</tr>\n<tr>\n<td>[G‑18]</td>\n<td align=\"left\">Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</td>\n<td align=\"center\">9</td>\n</tr>\n<tr>\n<td>[G‑19]</td>\n<td align=\"left\">Functions guaranteed to revert when called by normal users can be marked <code>payable</code></td>\n<td align=\"center\">7</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 124 instances over 19 issues</p>\n<h2 id=\"g01--string-should-only-be-generated-once-and-saved\" style=\"position:relative;\"><a href=\"#g01--string-should-only-be-generated-once-and-saved\" aria-label=\"g01  string should only be generated once and saved permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑01]  String should only be generated once, and saved</h2>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPair</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">81</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">string</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;FraxlendV1 - &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateralContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeSymbol</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">&quot;/&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assetContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeSymbol</span><span class=\"mtk1\">()));</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L81\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L81</a></p>\n<h2 id=\"g02--remove-or-replace-unused-state-variables\" style=\"position:relative;\"><a href=\"#g02--remove-or-replace-unused-state-variables\" aria-label=\"g02  remove or replace unused state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑02]  Remove or replace unused state variables</h2>\n<p>Saves a storage slot. If the variable is assigned a non-zero value, saves Gsset (<strong>20000 gas</strong>). If it’s assigned a zero value, saves Gsreset (<strong>2900 gas</strong>). If the variable remains unassigned, there is no gas savings unless the variable is <code>public</code>, in which case the compiler-generated non-payable getter deployment cost is saved. If the state variable is overriding an interface’s public function, mark the variable as <code>constant</code> or <code>immutable</code> so that it does not use a storage slot</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">51</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">version</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;1.0.0&quot;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L51\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L51</a></p>\n<h2 id=\"g03--multiple-addressid-mappings-can-be-combined-into-a-single-mapping-of-an-addressid-to-a-struct-where-appropriate\" style=\"position:relative;\"><a href=\"#g03--multiple-addressid-mappings-can-be-combined-into-a-single-mapping-of-an-addressid-to-a-struct-where-appropriate\" aria-label=\"g03  multiple addressid mappings can be combined into a single mapping of an addressid to a struct where appropriate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑03]  Multiple <code>address</code>/ID mappings can be combined into a single <code>mapping</code> of an <code>address</code>/ID to a <code>struct</code>, where appropriate</h2>\n<p>Saves a storage slot for the mapping. Depending on the circumstances and sizes of types, can avoid a Gsset (<strong>20000 gas</strong>) per mapping combined. Reads and subsequent writes can also be cheaper when a function requires both values and they both fit in the same storage slot. Finally, if both fields are accessed in the same function, can save <strong>~42 gas per access</strong> due to <a href=\"https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0\">not having to recalculate the key’s keccak256 hash</a> (Gkeccak256 - 30 gas) and that calculation’s associated stack operations.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">127</span><span class=\"mtk1\">       </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userCollateralBalance</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// amount of collateral each user is backed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">128</span><span class=\"mtk1\">       </span><span class=\"mtk3\">/// @notice Stores the balance of borrow shares for each user</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">129</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userBorrowShares</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// represents the shares held by individuals</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L127-L129\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L127-L129</a></p>\n<h2 id=\"g04--using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\" style=\"position:relative;\"><a href=\"#g04--using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\" aria-label=\"g04  using calldata instead of memory for read only arguments in external functions saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑04]  Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</h2>\n<p>When a function with a <code>memory</code> array is called externally, the <code>abi.decode()</code> step has to use a for-loop to copy each index of the <code>calldata</code> to the <code>memory</code> index. <strong>Each iteration of this for-loop costs at least 60 gas</strong> (i.e. <code>60 * &#x3C;mem_array>.length</code>). Using <code>calldata</code> directly, obliviates the need for such a loop in the contract code and runtime execution. Note that even if an interface defines a function as having <code>memory</code> arguments, it’s still valid for implementation contracs to use <code>calldata</code> arguments instead.</p>\n<p>If the array is passed to an <code>internal</code> function which passes the array to another internal function where the array is modified and therefore <code>memory</code> is used in the <code>external</code> call, it’s still more gass-efficient to use <code>calldata</code> when the <code>external</code> function uses modifiers, since the modifiers may prevent the internal functions from being called. Structs have the same overhead as an array of length one</p>\n<p>Note that I’ve also flagged instances where the function is <code>public</code> but can be marked as <code>external</code> since it’s not called by the contract, and cases where a constructor is involved</p>\n<p><em>There are 11 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit _configData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit _immutables</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">151</span><span class=\"mtk1\">       </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">152</span><span class=\"mtk1\">           </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">153</span><span class=\"mtk1\">           </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_immutables</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">154</span><span class=\"mtk1\">           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">155</span><span class=\"mtk1\">           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">156</span><span class=\"mtk1\">           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturityDate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">157</span><span class=\"mtk1\">           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_penaltyRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">158</span><span class=\"mtk1\">           </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_isBorrowerWhitelistActive</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">159</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_isLenderWhitelistActive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit _path</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1062</span><span class=\"mtk1\">      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">leveragedPosition</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1063          </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_swapperAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1064          </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_borrowAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1065          </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_initialCollateralAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1066          </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amountCollateralOutMin</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1067          </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_path</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1068      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1069          </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1070          </span><span class=\"mtk11\">isNotPastMaturity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1071          </span><span class=\"mtk11\">nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1072          </span><span class=\"mtk11\">whenNotPaused</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1073          </span><span class=\"mtk11\">approvedBorrower</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1074          </span><span class=\"mtk11\">isSolvent</span><span class=\"mtk1\">(msg.sender)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1075:         </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalCollateralBalance</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L151-L159\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L151-L159</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairDeployer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit _configData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">310</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit _name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit _configData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit _approvedBorrowers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit _approvedLenders</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">355</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deployCustom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">356           </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">357           </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">358           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">359           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">360           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturityDate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">361           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_penaltyRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">362           </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_approvedBorrowers</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">363           </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_approvedLenders</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">364:      ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit _addresses</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">398</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">globalPause</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_addresses</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_updatedAddresses</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L310\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L310</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPair</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit _configData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit _immutables</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">45</span><span class=\"mtk1\">        </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">46</span><span class=\"mtk1\">            </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">47</span><span class=\"mtk1\">            </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_immutables</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">48</span><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">49</span><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">50</span><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maturityDate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">51</span><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_penaltyRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">52</span><span class=\"mtk1\">            </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_isBorrowerWhitelistActive</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">53</span><span class=\"mtk1\">            </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_isLenderWhitelistActive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">54</span><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">55</span><span class=\"mtk1\">            </span><span class=\"mtk11\">FraxlendPairCore</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">56</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">57</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_immutables</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">58</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_liquidationFee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">60</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_maturityDate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">61</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_penaltyRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">62</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_isBorrowerWhitelistActive</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">63</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_isLenderWhitelistActive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">64</span><span class=\"mtk1\">            )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">65</span><span class=\"mtk1\">            </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">66</span><span class=\"mtk1\">            </span><span class=\"mtk11\">Ownable</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">67</span><span class=\"mtk1\">:           </span><span class=\"mtk11\">Pausable</span><span class=\"mtk1\">()</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L45-L67\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L45-L67</a></p>\n<h2 id=\"g05--using-storage-instead-of-memory-for-structsarrays-saves-gas\" style=\"position:relative;\"><a href=\"#g05--using-storage-instead-of-memory-for-structsarrays-saves-gas\" aria-label=\"g05  using storage instead of memory for structsarrays saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑05]  Using <code>storage</code> instead of <code>memory</code> for structs/arrays saves gas</h2>\n<p>When fetching data from a storage location, assigning the data to a <code>memory</code> variable causes all fields of the struct/array to be read from storage, which incurs a Gcoldsload (<strong>2100 gas</strong>) for <em>each</em> field of the struct/array. If the fields are read from the new memory variable, they incur an additional <code>MLOAD</code> rather than a cheap stack read. Instead of declearing the variable with the <code>memory</code> keyword, declaring the variable with the <code>storage</code> keyword and caching any fields that need to be re-read in stack variables, will be much cheaper, only incuring the Gcoldsload for the fields actually read. The only time it makes sense to read the whole struct/array into a <code>memory</code> variable, is if the full struct/array is being returned by the function, is being passed to a function that requires <code>memory</code>, or if the array/struct is being read from another <code>memory</code> array/struct</p>\n<p><em>There are 16 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">419</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">CurrentRateInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_currentRateInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">currentRateInfo</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">426</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">VaultAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalAsset</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalAsset</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">427</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">VaultAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalBorrow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalBorrow</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">517</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">ExchangeRateInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_exchangeRateInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">exchangeRateInfo</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">592</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">VaultAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalAsset</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalAsset</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">611</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">VaultAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalAsset</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalAsset</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">666</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">VaultAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalAsset</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalAsset</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">682</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">VaultAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalAsset</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalAsset</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">708</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">VaultAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalBorrow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalBorrow</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">884</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">VaultAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalBorrow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalBorrow</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">926</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">VaultAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalBorrow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalBorrow</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">965</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">VaultAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalBorrow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalBorrow</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1204</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">VaultAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalBorrow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalBorrow</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L419\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L419</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairDeployer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">123</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">string</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deployedPairsArray</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">deployedPairsArray</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L123\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L123</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPair</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">236</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">VaultAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalAsset</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalAsset</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">237</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">VaultAccount</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalBorrow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalBorrow</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L236\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L236</a></p>\n<h2 id=\"g06--state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" style=\"position:relative;\"><a href=\"#g06--state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" aria-label=\"g06  state variables should be cached in stack variables rather than re reading them from storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑06]  State variables should be cached in stack variables rather than re-reading them from storage</h2>\n<p>The instances below point to the second+ access of a state variable within a function. Caching of a state variable replace each Gwarmaccess (<strong>100 gas</strong>) with a much cheaper stack read. Other less obvious fixes/optimizations include having local memory caches of state variable structs, or having local caches of state variable contracts/addresses.</p>\n<p><em>There are 2 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairDeployer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit DEFAULT_MAX_LTV on line 332</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit DEFAULT_LIQ_FEE on line 333</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">342</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">_logDeploy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_configData</span><span class=\"mtk1\">, </span><span class=\"mtk12\">DEFAULT_MAX_LTV</span><span class=\"mtk1\">, </span><span class=\"mtk12\">DEFAULT_LIQ_FEE</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L342\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L342</a></p>\n<h2 id=\"g07--x--y-costs-more-gas-than-x--x--y-for-state-variables\" style=\"position:relative;\"><a href=\"#g07--x--y-costs-more-gas-than-x--x--y-for-state-variables\" aria-label=\"g07  x  y costs more gas than x  x  y for state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑07]  <code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</h2>\n<p>Using the addition operator instead of plus-equals saves <strong><a href=\"https://gist.github.com/IllIllI000/cbbfb267425b898e5be734d4008d4fe8\">113 gas</a></strong></p>\n<p><em>There are 2 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">773</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">totalCollateral</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">_collateralAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">815</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">totalCollateral</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">_collateralAmount</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L773\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L773</a></p>\n<h2 id=\"g08--add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\" style=\"position:relative;\"><a href=\"#g08--add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\" aria-label=\"g08  add unchecked  for subtractions where the operands cannot underflow because of a previous require or if statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑08]  Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</h2>\n<p><code>require(a &#x3C;= b); x = b - a</code> => <code>require(a &#x3C;= b); unchecked { x = b - a }</code></p>\n<p><em>There are 3 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LinearInterestRate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit if-condition on line 86</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">88</span><span class=\"mtk1\">:               </span><span class=\"mtk12\">_newRatePerSec</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint64</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vertexInterest</span><span class=\"mtk1\"> + (((</span><span class=\"mtk12\">_utilization</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_vertexUtilization</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">_slope</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">UTIL_PREC</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L88\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L88</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VariableInterestRate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit if-condition on line 68</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">69</span><span class=\"mtk1\">:               </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deltaUtilization</span><span class=\"mtk1\"> = ((</span><span class=\"mtk12\">MIN_UTIL</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_utilization</span><span class=\"mtk1\">) * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">MIN_UTIL</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit if-condition on line 75</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">76</span><span class=\"mtk1\">:               </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_deltaUtilization</span><span class=\"mtk1\"> = ((</span><span class=\"mtk12\">_utilization</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">MAX_UTIL</span><span class=\"mtk1\">) * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">) / (</span><span class=\"mtk12\">UTIL_PREC</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">MAX_UTIL</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/VariableInterestRate.sol#L69\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/VariableInterestRate.sol#L69</a></p>\n<h2 id=\"g09--arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\" style=\"position:relative;\"><a href=\"#g09--arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\" aria-label=\"g09  arraylength should not be looked up in every loop of a for loop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑09]  <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</h2>\n<p>The overheads outlined below are <em>PER LOOP</em>, excluding the first loop</p>\n<ul>\n<li>storage arrays incur a Gwarmaccess (<strong>100 gas</strong>)</li>\n<li>memory arrays use <code>MLOAD</code> (<strong>3 gas</strong>)</li>\n<li>calldata arrays use <code>CALLDATALOAD</code> (<strong>3 gas</strong>)</li>\n</ul>\n<p>Caching the length changes each of these to a <code>DUP&#x3C;N></code> (<strong>3 gas</strong>), and gets rid of the extra <code>DUP&#x3C;N></code> needed to store the stack offset</p>\n<p><em>There are 7 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">265</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_approvedBorrowers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">270</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_approvedLenders</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L265\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L265</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPair</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">289</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_lenders</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">308</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_borrowers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L289\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L289</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendWhitelist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">51</span><span class=\"mtk1\">:           </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">66</span><span class=\"mtk1\">:           </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">81</span><span class=\"mtk1\">:           </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L51\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L51</a></p>\n<h2 id=\"g10--ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\" style=\"position:relative;\"><a href=\"#g10--ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\" aria-label=\"g10  ii should be uncheckediuncheckedi when it is not possible for them to overflow as is the case when used in for  and while loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑10]  <code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</h2>\n<p>The <code>unchecked</code> keyword is new in solidity version 0.8.0, so this only applies to that version or higher, which these instances are. This saves <strong>30-40 gas <a href=\"https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#the-increment-in-for-loop-post-condition-can-be-made-unchecked\">per loop</a></strong></p>\n<p><em>There are 8 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">265</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_approvedBorrowers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">270</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_approvedLenders</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L265\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L265</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPair</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">289</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_lenders</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">308</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_borrowers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L289\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L289</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendWhitelist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">51</span><span class=\"mtk1\">:           </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">66</span><span class=\"mtk1\">:           </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">81</span><span class=\"mtk1\">:           </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L51\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L51</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">27</span><span class=\"mtk1\">:               </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">32</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">data</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/libraries/SafeERC20.sol#L27\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/libraries/SafeERC20.sol#L27</a></p>\n<h2 id=\"g11--requirerevert-strings-longer-than-32-bytes-cost-extra-gas\" style=\"position:relative;\"><a href=\"#g11--requirerevert-strings-longer-than-32-bytes-cost-extra-gas\" aria-label=\"g11  requirerevert strings longer than 32 bytes cost extra gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑11]  <code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</h2>\n<p>Each extra memory word of bytes past the original 32 <a href=\"https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#consider-having-short-revert-strings\">incurs an MSTORE</a> which costs <strong>3 gas</strong></p>\n<p><em>There are 8 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairDeployer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">205</span><span class=\"mtk1\">:              </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">deployedPairsBySalt</span><span class=\"mtk1\">[</span><span class=\"mtk12\">salt</span><span class=\"mtk1\">] == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;FraxlendPairDeployer: Pair already deployed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">228</span><span class=\"mtk1\">:              </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;FraxlendPairDeployer: create2 failed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">253</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">deployedPairsByName</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">] == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;FraxlendPairDeployer: Pair name must be unique&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">365</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">GLOBAL_MAX_LTV</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;FraxlendPairDeployer: _maxLTV is too large&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">366</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">367</span><span class=\"mtk1\">               </span><span class=\"mtk11\">IFraxlendWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FRAXLEND_WHITELIST_ADDRESS</span><span class=\"mtk1\">).</span><span class=\"mtk11\">fraxlendDeployerWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">368</span><span class=\"mtk1\">               </span><span class=\"mtk8\">&quot;FraxlendPairDeployer: Only whitelisted addresses&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">369</span><span class=\"mtk1\">:          );</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L205\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L205</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LinearInterestRate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">57</span><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">58</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_minInterest</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">MAX_INT</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_minInterest</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">_vertexInterest</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_minInterest</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">MIN_INT</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">                </span><span class=\"mtk8\">&quot;LinearInterestRate: _minInterest &lt; MAX_INT &amp;&amp; _minInterest &lt;= _vertexInterest &amp;&amp; _minInterest &gt;= MIN_INT&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">60</span><span class=\"mtk1\">:           );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">61</span><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">62</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_maxInterest</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">MAX_INT</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_vertexInterest</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">_maxInterest</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_maxInterest</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">MIN_INT</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">63</span><span class=\"mtk1\">                </span><span class=\"mtk8\">&quot;LinearInterestRate: _maxInterest &lt;= MAX_INT &amp;&amp; _vertexInterest &lt;= _maxInterest &amp;&amp; _maxInterest &gt; MIN_INT&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">64</span><span class=\"mtk1\">:           );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">65</span><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">66</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_vertexUtilization</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">MAX_VERTEX_UTIL</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_vertexUtilization</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">67</span><span class=\"mtk1\">                </span><span class=\"mtk8\">&quot;LinearInterestRate: _vertexUtilization &lt; MAX_VERTEX_UTIL &amp;&amp; _vertexUtilization &gt; 0&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">68</span><span class=\"mtk1\">:           );</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L57-L60\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L57-L60</a></p>\n<h2 id=\"g12--optimize-names-to-save-gas\" style=\"position:relative;\"><a href=\"#g12--optimize-names-to-save-gas\" aria-label=\"g12  optimize names to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑12]  Optimize names to save gas</h2>\n<p><code>public</code>/<code>external</code> function names and <code>public</code> member variable names can be optimized to save gas. See <a href=\"https://gist.github.com/IllIllI000/a5d8b486a8259f9f77891a919febd1a9\">this</a> link for an example of how it works. Below are the interfaces/abstract contracts that can be optimized so that the most frequently-called functions use the least amount of gas possible during method lookup. Method IDs that have two leading zero bytes can save <strong>128 gas</strong> each during deployment, and renaming functions to have lower method IDs will save <strong>22 gas</strong> per call, <a href=\"https://medium.com/joyso/solidity-how-does-function-name-affect-gas-consumption-in-smart-contract-47d270d8ac92\">per sorted position shifted</a></p>\n<p><em>There are 6 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit initialize(), addInterest(), updateExchangeRate(), borrowAsset(), addCollateral(), removeCollateral(), repayAsset(), liquidate(), liquidateClean(), leveragedPosition(), repayAssetWithCollateral()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">46</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">abstract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FraxlendPairCore</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FraxlendPairConstants</span><span class=\"mtk1\">, </span><span class=\"mtk12\">IERC4626</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Ownable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Pausable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ReentrancyGuard</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L46\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L46</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairDeployer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit deployedPairsLength(), getAllPairAddresses(), getCustomStatuses(), setCreationCode(), deploy(), deployCustom(), globalPause()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">44</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FraxlendPairDeployer</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Ownable</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L44\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L44</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPair</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit assetsPerShare(), assetsOf(), getConstants(), toBorrowShares(), toBorrowAmount(), setTimeLock(), changeFee(), withdrawFees(), setSwapper(), setApprovedLenders(), setApprovedBorrowers(), pause(), unpause()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">41</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FraxlendPair</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FraxlendPairCore</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L41\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L41</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendWhitelist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit setOracleContractWhitelist(), setRateContractWhitelist(), setFraxlendDeployerWhitelist()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">30</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FraxlendWhitelist</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Ownable</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L30\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L30</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LinearInterestRate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit getConstants(), requireValidInitData(), getNewRate()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">32</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">LinearInterestRate</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IRateCalculator</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L32\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L32</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VariableInterestRate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit getConstants(), requireValidInitData(), getNewRate()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">33</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">VariableInterestRate</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IRateCalculator</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/VariableInterestRate.sol#L33\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/VariableInterestRate.sol#L33</a></p>\n<h2 id=\"g13--using-bools-for-storage-incurs-overhead\" style=\"position:relative;\"><a href=\"#g13--using-bools-for-storage-incurs-overhead\" aria-label=\"g13  using bools for storage incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑13]  Using <code>bool</code>s for storage incurs overhead</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Booleans are more expensive than uint256 or any type that takes up a full</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// word because each write operation emits an extra SLOAD to first read the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// slot&#39;s contents, replace the bits taken up by the boolean, and then write</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// back. This is the compiler&#39;s defense against contract upgrades and</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// pointer aliasing, and it cannot be disabled.</span></span></span></code></pre>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27</a><br>\nUse <code>uint256(1)</code> and <code>uint256(2)</code> for true/false to avoid a Gwarmaccess (<strong><a href=\"https://gist.github.com/IllIllI000/1b70014db712f8572a72378321250058\">100 gas</a></strong>) for the extra SLOAD, and to avoid Gsset (<strong>20000 gas</strong>) when changing from <code>false</code> to <code>true</code>, after having been <code>true</code> in the past</p>\n<p><em>There are 9 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">78</span><span class=\"mtk1\">:       </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">swappers</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// approved swapper addresses</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">133</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrowerWhitelistActive</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">134</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">approvedBorrowers</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">136</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lenderWhitelistActive</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">137</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">approvedLenders</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L78\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L78</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairDeployer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">94</span><span class=\"mtk1\">:       </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">deployedPairCustomStatusByAddress</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L94\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L94</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendWhitelist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">32</span><span class=\"mtk1\">:       </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oracleContractWhitelist</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">35</span><span class=\"mtk1\">:       </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rateContractWhitelist</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">38</span><span class=\"mtk1\">:       </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fraxlendDeployerWhitelist</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L32\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L32</a></p>\n<h2 id=\"g14--i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" style=\"position:relative;\"><a href=\"#g14--i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" aria-label=\"g14  i costs less gas than i especially when its used in for loops   ii   too permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑14]  <code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</h2>\n<p>Saves <strong>5 gas per loop</strong></p>\n<p><em>There are 9 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairDeployer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">130</span><span class=\"mtk1\">:                  </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">158</span><span class=\"mtk1\">:                  </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L130\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L130</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPair</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">289</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_lenders</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">308</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_borrowers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L289\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L289</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendWhitelist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">51</span><span class=\"mtk1\">:           </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">66</span><span class=\"mtk1\">:           </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">81</span><span class=\"mtk1\">:           </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L51\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L51</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">24</span><span class=\"mtk1\">:                   </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">27</span><span class=\"mtk1\">:               </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">32</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">data</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/libraries/SafeERC20.sol#L24\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/libraries/SafeERC20.sol#L24</a></p>\n<h2 id=\"g15--splitting-require-statements-that-use--saves-gas\" style=\"position:relative;\"><a href=\"#g15--splitting-require-statements-that-use--saves-gas\" aria-label=\"g15  splitting require statements that use  saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑15]  Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</h2>\n<p>See <a href=\"https://github.com/code-423n4/2022-01-xdefi-findings/issues/128\">this issue</a> which describes the fact that there is a larger deployment gas cost, but with enough runtime calls, the change ends up being cheaper by <strong>3 gas</strong></p>\n<p><em>There are 3 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LinearInterestRate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">57</span><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">58</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_minInterest</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">MAX_INT</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_minInterest</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">_vertexInterest</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_minInterest</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">MIN_INT</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">                </span><span class=\"mtk8\">&quot;LinearInterestRate: _minInterest &lt; MAX_INT &amp;&amp; _minInterest &lt;= _vertexInterest &amp;&amp; _minInterest &gt;= MIN_INT&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">60</span><span class=\"mtk1\">:           );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">61</span><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">62</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_maxInterest</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">MAX_INT</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_vertexInterest</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">_maxInterest</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_maxInterest</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">MIN_INT</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">63</span><span class=\"mtk1\">                </span><span class=\"mtk8\">&quot;LinearInterestRate: _maxInterest &lt;= MAX_INT &amp;&amp; _vertexInterest &lt;= _maxInterest &amp;&amp; _maxInterest &gt; MIN_INT&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">64</span><span class=\"mtk1\">:           );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">65</span><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">66</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_vertexUtilization</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">MAX_VERTEX_UTIL</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_vertexUtilization</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">67</span><span class=\"mtk1\">                </span><span class=\"mtk8\">&quot;LinearInterestRate: _vertexUtilization &lt; MAX_VERTEX_UTIL &amp;&amp; _vertexUtilization &gt; 0&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">68</span><span class=\"mtk1\">:           );</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L57-L60\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L57-L60</a></p>\n<h2 id=\"g16--usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" style=\"position:relative;\"><a href=\"#g16--usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" aria-label=\"g16  usage of uintsints smaller than 32 bytes 256 bits incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑16]  Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</h2>\n<blockquote>\n<p>When using elements that are smaller than 32 bytes, your contract’s gas usage may be higher. This is because the EVM operates on 32 bytes at a time. Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.</p>\n</blockquote>\n<p><a href=\"https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html\">https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html</a><br>\nEach operation involving a <code>uint8</code> costs an extra <a href=\"https://gist.github.com/IllIllI000/9388d20c70f9a4632eb3ca7836f54977\"><strong>22-28 gas</strong></a> (depending on whether the other operand is also a variable of type <code>uint8</code>) as compared to ones involving <code>uint256</code>, due to the compiler having to clear the higher bits of the memory word before operating on the <code>uint8</code>, as well as the associated stack operations of doing so. Use a larger size then downcast where needed</p>\n<p><em>There are 13 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uint64 _newRate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">421</span><span class=\"mtk1\">:              </span><span class=\"mtk12\">_newRate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_currentRateInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ratePerSec</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uint64 _newRate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">448</span><span class=\"mtk1\">:                  </span><span class=\"mtk12\">_newRate</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint64</span><span class=\"mtk1\">(</span><span class=\"mtk12\">penaltyRate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uint64 _newRate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">456</span><span class=\"mtk1\">:                  </span><span class=\"mtk12\">_newRate</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IRateCalculator</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rateContract</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getNewRate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_rateData</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rateInitCallData</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uint128 _amountToAdjust</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1005</span><span class=\"mtk1\">:                     </span><span class=\"mtk12\">_amountToAdjust</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">_totalBorrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_sharesToAdjust</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">toUint128</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L421\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L421</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPair</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uint64 _DEFAULT_INT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">175</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">_DEFAULT_INT</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">DEFAULT_INT</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uint16 _DEFAULT_PROTOCOL_FEE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">176</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">_DEFAULT_PROTOCOL_FEE</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">DEFAULT_PROTOCOL_FEE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uint128 _shares</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">240</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_shares</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)));</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L175\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L175</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SafeERC20</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uint8 i</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">27</span><span class=\"mtk1\">:               </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">32</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">data</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/libraries/SafeERC20.sol#L27\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/libraries/SafeERC20.sol#L27</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LinearInterestRate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uint64 _newRatePerSec</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">85</span><span class=\"mtk1\">:               </span><span class=\"mtk12\">_newRatePerSec</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint64</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_minInterest</span><span class=\"mtk1\"> + ((</span><span class=\"mtk12\">_utilization</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">_slope</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">UTIL_PREC</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uint64 _newRatePerSec</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">88</span><span class=\"mtk1\">:               </span><span class=\"mtk12\">_newRatePerSec</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint64</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vertexInterest</span><span class=\"mtk1\"> + (((</span><span class=\"mtk12\">_utilization</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_vertexUtilization</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">_slope</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">UTIL_PREC</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uint64 _newRatePerSec</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">90</span><span class=\"mtk1\">:               </span><span class=\"mtk12\">_newRatePerSec</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint64</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vertexInterest</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L85\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L85</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VariableInterestRate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uint64 _newRatePerSec</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">71</span><span class=\"mtk1\">:               </span><span class=\"mtk12\">_newRatePerSec</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint64</span><span class=\"mtk1\">((</span><span class=\"mtk12\">_currentRatePerSec</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">INT_HALF_LIFE</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">_decayGrowth</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uint64 _newRatePerSec</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">78</span><span class=\"mtk1\">:               </span><span class=\"mtk12\">_newRatePerSec</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint64</span><span class=\"mtk1\">((</span><span class=\"mtk12\">_currentRatePerSec</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">_decayGrowth</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">INT_HALF_LIFE</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/VariableInterestRate.sol#L71\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/VariableInterestRate.sol#L71</a></p>\n<h2 id=\"g17--using-private-rather-than-public-for-constants-saves-gas\" style=\"position:relative;\"><a href=\"#g17--using-private-rather-than-public-for-constants-saves-gas\" aria-label=\"g17  using private rather than public for constants saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑17]  Using <code>private</code> rather than <code>public</code> for constants, saves gas</h2>\n<p>If needed, the values can be read from the verified contract source code, or if there are multiple values there can be a single getter function that returns a tuple of the values of all currently-public constants. Saves <strong>3406-3606 gas</strong> in deployment gas due to the compiler not having to create non-payable getter functions for deployment calldata, not having to store the bytes of the value outside of where it’s used, and not adding another entry to the method ID table</p>\n<p><em>There are 8 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"73\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">64</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oracleNormalization</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">67</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxLTV</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">70</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cleanLiquidationFee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">71</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dirtyLiquidationFee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">95</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maturityDate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">96</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">penaltyRate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">133</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrowerWhitelistActive</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">136</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lenderWhitelistActive</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L64\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L64</a></p>\n<h2 id=\"g18--use-custom-errors-rather-than-revertrequire-strings-to-save-gas\" style=\"position:relative;\"><a href=\"#g18--use-custom-errors-rather-than-revertrequire-strings-to-save-gas\" aria-label=\"g18  use custom errors rather than revertrequire strings to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑18]  Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</h2>\n<p>Custom errors are available from solidity version 0.8.4. Custom errors save <a href=\"https://gist.github.com/IllIllI000/ad1bd0d29a0101b25e57c293b4b0c746\"><strong>~50 gas</strong></a> each time they’re hit by <a href=\"https://blog.soliditylang.org/2021/04/21/custom-errors/#errors-in-depth\">avoiding having to allocate and store the revert string</a>. Not defining the strings also save deployment gas</p>\n<p><em>There are 9 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"74\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairDeployer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">205</span><span class=\"mtk1\">:              </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">deployedPairsBySalt</span><span class=\"mtk1\">[</span><span class=\"mtk12\">salt</span><span class=\"mtk1\">] == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;FraxlendPairDeployer: Pair already deployed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">228</span><span class=\"mtk1\">:              </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pairAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;FraxlendPairDeployer: create2 failed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">253</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">deployedPairsByName</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">] == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;FraxlendPairDeployer: Pair name must be unique&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">365</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_maxLTV</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">GLOBAL_MAX_LTV</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;FraxlendPairDeployer: _maxLTV is too large&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">366</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">367</span><span class=\"mtk1\">               </span><span class=\"mtk11\">IFraxlendWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FRAXLEND_WHITELIST_ADDRESS</span><span class=\"mtk1\">).</span><span class=\"mtk11\">fraxlendDeployerWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">368</span><span class=\"mtk1\">               </span><span class=\"mtk8\">&quot;FraxlendPairDeployer: Only whitelisted addresses&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">369</span><span class=\"mtk1\">:          );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">399</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">CIRCUIT_BREAKER_ADDRESS</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Circuit Breaker only&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L205\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L205</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"75\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LinearInterestRate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">57</span><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">58</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_minInterest</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">MAX_INT</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_minInterest</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">_vertexInterest</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_minInterest</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">MIN_INT</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">                </span><span class=\"mtk8\">&quot;LinearInterestRate: _minInterest &lt; MAX_INT &amp;&amp; _minInterest &lt;= _vertexInterest &amp;&amp; _minInterest &gt;= MIN_INT&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">60</span><span class=\"mtk1\">:           );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">61</span><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">62</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_maxInterest</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">MAX_INT</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_vertexInterest</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">_maxInterest</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_maxInterest</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">MIN_INT</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">63</span><span class=\"mtk1\">                </span><span class=\"mtk8\">&quot;LinearInterestRate: _maxInterest &lt;= MAX_INT &amp;&amp; _vertexInterest &lt;= _maxInterest &amp;&amp; _maxInterest &gt; MIN_INT&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">64</span><span class=\"mtk1\">:           );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">65</span><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">66</span><span class=\"mtk1\">                </span><span class=\"mtk12\">_vertexUtilization</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">MAX_VERTEX_UTIL</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">_vertexUtilization</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">67</span><span class=\"mtk1\">                </span><span class=\"mtk8\">&quot;LinearInterestRate: _vertexUtilization &lt; MAX_VERTEX_UTIL &amp;&amp; _vertexUtilization &gt; 0&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">68</span><span class=\"mtk1\">:           );</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L57-L60\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L57-L60</a></p>\n<h2 id=\"g19--functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" style=\"position:relative;\"><a href=\"#g19--functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" aria-label=\"g19  functions guaranteed to revert when called by normal users can be marked payable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑19]  Functions guaranteed to revert when called by normal users can be marked <code>payable</code></h2>\n<p>If a function modifier such as <code>onlyOwner</code> is used, the function will revert if a normal user tries to pay the function. Marking the function as <code>payable</code> will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are\n<code>CALLVALUE</code>(2),<code>DUP1</code>(3),<code>ISZERO</code>(3),<code>PUSH2</code>(3),<code>JUMPI</code>(10),<code>PUSH1</code>(3),<code>DUP1</code>(3),<code>REVERT</code>(0),<code>JUMPDEST</code>(1),<code>POP</code>(2), which costs an average of about <strong>21 gas per call</strong> to the function, in addition to the extra deployment cost</p>\n<p><em>There are 7 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"76\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPairDeployer</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">170</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setCreationCode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_creationCode</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L170\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L170</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"77\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendPair</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">204</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setTimeLock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newAddress</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">234</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amountToTransfer</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">274</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setSwapper</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_swapper</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_approval</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L204\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L204</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"78\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">FraxlendWhitelist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">50</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setOracleContractWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_addresses</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_bool</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">65</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setRateContractWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_addresses</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_bool</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">80</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFraxlendDeployerWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_addresses</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_bool</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L50\">https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L50</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-frax-findings/issues/245#issuecomment-1272557460\">gititGoro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Very good report. Could have scored much higher if gas before and after numbers were provided.\nNothing invalid.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-2\">High Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#h-01-any-borrower-with-bad-debt-can-be-liquidated-multiple-times-to-lock-funds-in-the-lending-pair\">[H-01] Any borrower with bad debt can be liquidated multiple times to lock funds in the lending pair</a></li>\n<li><a href=\"#h-02-liquidate-doesnt-mark-off-bad-debt-leading-to-a-last-lender-to-withdraw-loses-scenario\">[H-02] <code>liquidate()</code> doesn’t mark off bad debt, leading to a ‘last lender to withdraw loses’ scenario</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-13\">Medium Risk Findings (13)</a></p>\n<ul>\n<li><a href=\"#m-01-penalty-rate-is-used-for-pre-maturity-date-as-well\">[M-01] Penalty rate is used for pre-maturity date as well</a></li>\n<li><a href=\"#m-02-interest-can-be-significantly-lower-if-addinterest-isnt-called-frequently-enough-\">[M-02] Interest can be significantly lower if <code>addInterest</code> isn’t called frequently enough </a></li>\n<li><a href=\"#m-03-impossible-to-setcreationcode-with-code-size-less-than-13k\">[M-03] Impossible to <code>setCreationCode()</code> with code size less than 13K</a></li>\n<li><a href=\"#m-04-wrong-percent-for-fraxlendpaircoredirtyliquidationfee\">[M-04] Wrong percent for <code>FraxlendPairCore.dirtyLiquidationFee</code>.</a></li>\n<li><a href=\"#m-05-liquidator-might-end-up-paying-much-more-asset-than-collateral-received\">[M-05] Liquidator might end up paying much more asset than collateral received</a></li>\n<li><a href=\"#m-06-fraxlendpairsettimelock-allows-the-owner-to-reset-timelockaddress\">[M-06] FraxlendPair#setTimeLock: Allows the owner to reset TIME<em>LOCK</em>ADDRESS</a></li>\n<li><a href=\"#m-07-fraxlendpairchangefee-doesnt-update-interest-before-changing-fee\">[M-07] FraxlendPair.changeFee() doesn’t update interest before changing fee.</a></li>\n<li><a href=\"#m-08-owner-of-fraxlendpair-can-set-arbitrary-time-lock-contract-address-to-circumvent-time-lock\">[M-08] Owner of <code>FraxlendPair</code> can set arbitrary time lock contract address to circumvent time lock</a></li>\n<li><a href=\"#m-09-fraxlendpairsol-is-not-fully-eip-4626-compliant\">[M-09] FraxlendPair.sol is not fully EIP-4626 compliant</a></li>\n<li><a href=\"#m-10-decimals-limitation-limits-the-tokens-that-can-be-used\">[M-10] Decimals limitation limits the tokens that can be used</a></li>\n<li><a href=\"#m-11-fraxlend-pair-deployment-can-be-front-run-by-a-custom-pair-deployment\">[M-11] Fraxlend pair deployment can be front-run by a custom pair deployment</a></li>\n<li><a href=\"#m-12-denial-of-service-in-globalpause-by-wrong-logic\">[M-12] Denial of service in globalPause by wrong logic</a></li>\n<li><a href=\"#m-13-no-incentives-to-write-off-bad-debt-when-remaining-collateral-is-very-small\">[M-13] No incentives to write off bad debt when remaining collateral is very small</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#low-risk-issues\">Low Risk Issues</a></li>\n<li><a href=\"#l-01-outdated-compiler\">L-01 Outdated compiler</a></li>\n<li><a href=\"#l-02-safeerc20-mismatch-logics\">L-02 <code>SafeERC20</code> mismatch logics</a></li>\n<li><a href=\"#l-03-lack-of-ack-during-owner-change\">L-03 Lack of ACK during owner change</a></li>\n<li><a href=\"#l-04-constant-salt\">L-04 Constant salt</a></li>\n<li><a href=\"#l-05-bypass-timelock-restrictions\">L-05 Bypass <code>TimeLock</code> restrictions</a></li>\n<li><a href=\"#l-06-division-before-multiple-can-lead-to-precision-errors\">L-06 Division before multiple can lead to precision errors</a></li>\n<li><a href=\"#l-07-ownable-and-pausable\">L-07 <code>Ownable</code> and <code>Pausable</code></a></li>\n<li><a href=\"#non-critical-issues\">Non-Critical Issues</a></li>\n<li><a href=\"#n-01-use-encode-instead-of-encodepacked-for-hashig\">N-01 Use <code>encode</code> instead of <code>encodePacked</code> for hashig</a></li>\n<li><a href=\"#n-02-wrong-comment-of-toborrowamount-function\">N-02 Wrong comment of <code>toBorrowAmount</code> function</a></li>\n<li><a href=\"#n-03-confusing-variables-as-to-how-they-are-stored\">N-03 Confusing variables as to how they are stored</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#g01--string-should-only-be-generated-once-and-saved\">G‑01  String should only be generated once, and saved</a></li>\n<li><a href=\"#g02--remove-or-replace-unused-state-variables\">G‑02  Remove or replace unused state variables</a></li>\n<li><a href=\"#g03--multiple-addressid-mappings-can-be-combined-into-a-single-mapping-of-an-addressid-to-a-struct-where-appropriate\">G‑03  Multiple <code>address</code>/ID mappings can be combined into a single <code>mapping</code> of an <code>address</code>/ID to a <code>struct</code>, where appropriate</a></li>\n<li><a href=\"#g04--using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\">G‑04  Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</a></li>\n<li><a href=\"#g05--using-storage-instead-of-memory-for-structsarrays-saves-gas\">G‑05  Using <code>storage</code> instead of <code>memory</code> for structs/arrays saves gas</a></li>\n<li><a href=\"#g06--state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\">G‑06  State variables should be cached in stack variables rather than re-reading them from storage</a></li>\n<li><a href=\"#g07--x--y-costs-more-gas-than-x--x--y-for-state-variables\">G‑07  <code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</a></li>\n<li><a href=\"#g08--add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\">G‑08  Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</a></li>\n<li><a href=\"#g09--arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\">G‑09  <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</a></li>\n<li><a href=\"#g10--ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\">G‑10  <code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</a></li>\n<li><a href=\"#g11--requirerevert-strings-longer-than-32-bytes-cost-extra-gas\">G‑11  <code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</a></li>\n<li><a href=\"#g12--optimize-names-to-save-gas\">G‑12  Optimize names to save gas</a></li>\n<li><a href=\"#g13--using-bools-for-storage-incurs-overhead\">G‑13  Using <code>bool</code>s for storage incurs overhead</a></li>\n<li><a href=\"#g14--i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\">G‑14  <code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</a></li>\n<li><a href=\"#g15--splitting-require-statements-that-use--saves-gas\">G‑15  Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</a></li>\n<li><a href=\"#g16--usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\">G‑16  Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</a></li>\n<li><a href=\"#g17--using-private-rather-than-public-for-constants-saves-gas\">G‑17  Using <code>private</code> rather than <code>public</code> for constants, saves gas</a></li>\n<li><a href=\"#g18--use-custom-errors-rather-than-revertrequire-strings-to-save-gas\">G‑18  Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</a></li>\n<li><a href=\"#g19--functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\">G‑19  Functions guaranteed to revert when called by normal users can be marked <code>payable</code></a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the Fraxlend (Frax Finance) smart contract system written in Solidity. The audit contest took place between August 12—August 17 2022.\n\n## Wardens\n\n136 Wardens contributed reports to the Fraxlend (Frax Finance) contest:\n\n  1. 0xA5DF\n  1. Lambda\n  1. [berndartmueller](https://twitter.com/berndartmueller)\n  1. 0x1f8b\n  1. auditor0517\n  1. CertoraInc (egjlmn1, [OriDabush](https://twitter.com/ori_dabush), ItayG, shakedwinder and RoiEvenHaim)\n  1. cccz\n  1. [panprog](https://www.linkedin.com/in/pavel-anokhin/)\n  1. IllIllI\n  1. \\_\\_141345\\_\\_\n  1. 0x52\n  1. [sseefried](http://seanseefried.org/blog)\n  1. rbserver\n  1. cryptphi\n  1. brgltd\n  1. reassor\n  1. 0xDjango\n  1. [carlitox477](https://twitter.com/CAA1994)\n  1. \\_Adam\n  1. Rolezn\n  1. [pfapostol](https://t.me/pfahard)\n  1. [minhquanym](https://www.linkedin.com/in/minhquanym/)\n  1. zzzitron\n  1. minhtrng\n  1. [Deivitto](https://twitter.com/Deivitto)\n  1. [JC](https://twitter.com/sm4rtcontr4ct)\n  1. yac (t4k, [Peep](https://twitter.com/XianganH),  [thebensams](https://twitter.com/thebensams), [devtooligan](https://twitter.com/devtooligan), [blockdev](https://twitter.com/blockdeveth),  [usmannk](https://twitter.com/usmannk), sjkelleyjr, [thraull](https://github.com/thraull), and NibblerExpress)\n  1. [0xSmartContract](https://twitter.com/0xSmartContract)\n  1. [0xNazgul](https://twitter.com/0xNazgul)\n  1. [oyc\\_109](https://twitter.com/andyfeili)\n  1. mics\n  1. [c3phas](https://twitter.com/c3ph_)\n  1. Bnke0x0\n  1. [ret2basic](https://twitter.com/ret2basic)\n  1. [MiloTruck](https://milotruck.github.io/)\n  1. robee\n  1. [Dravee](https://twitter.com/BowTiedDravee)\n  1. [gogo](https://www.linkedin.com/in/georgi-nikolaev-georgiev-978253219)\n  1. ReyAdmirado\n  1. Junnon\n  1. Waze\n  1. [Aymen0909](https://github.com/Aymen1001)\n  1. erictee\n  1. CodingNameKiki\n  1. [Rohan16](https://twitter.com/ROHANJH56009256)\n  1. [ElKu](https://twitter.com/ElKu_crypto)\n  1. [durianSausage](https://github.com/lyciumlee)\n  1. [TomJ](https://mobile.twitter.com/tomj_bb)\n  1. kyteg\n  1. [fatherOfBlocks](https://twitter.com/father0fBl0cks)\n  1. [ignacio](https://twitter.com/0xheynacho)\n  1. LeoS\n  1. ballx\n  1. [medikko](https://twitter.com/mehmeddukov)\n  1. simon135\n  1. Noah3o6\n  1. [Sm4rty](https://twitter.com/Sm4rty_)\n  1. [Funen](https://instagram.com/vanensurya)\n  1. delfin454000\n  1. sach1r0\n  1. [SaharAP](https://twitter.com/SAPanahloo)\n  1. sryysryy\n  1. SooYa\n  1. [a12jmx](https://twitter.com/a12jmx)\n  1. cRat1st0s\n  1. ak1\n  1. asutorufos\n  1. [Chom](https://chom.dev)\n  1. djxploit\n  1. [gzeon](https://twitter.com/gzeon)\n  1. d3e4\n  1. Yiko\n  1. EthLedger\n  1. ladboy233\n  1. PaludoX0\n  1. [bin2chen](https://twitter.com/bin2chen)\n  1. ajtra\n  1. RoiEvenHaim\n  1. [tabish](https://twitter.com/tabishjshaikh)\n  1. beelzebufo\n  1. ayeslick\n  1. yash90\n  1. cryptonue\n  1. [dy](https://davidyat.es)\n  1. [hyh](https://twitter.com/0xhyh)\n  1. 0xsolstars ([Varun_Verma](twitter.com/versatile_crypt) and masterchief)\n  1. 0xmatt\n  1. The\\_GUILD ([David\\_](https://twitter.com/davidpius10), [Ephraim](https://twitter.com/iamephraim_js),  LeoGold,  and greatsamist)\n  1. 0xNineDec\n  1. dipp\n  1. [Chinmay](https://twitter.com/dev_chinmayf)\n  1. 0xkatana\n  1. [Tomio](https://twitter.com/meidhiwirara)\n  1. [m\\_Rassska](https://t.me/Road220)\n  1. saian\n  1. NoamYakov\n  1. flyx\n  1. Amithuddar\n  1. [Fitraldys](https://twitter.com/fitraldys)\n  1. [gerdusx](https://twitter.com/GerdusM)\n  1. Metatron\n  1. 2997ms\n  1. newfork01\n  1. chrisdior4\n  1. 0xackermann\n  1. jag\n  1. [mrpathfindr](https://veranos.io)\n  1. [Ruhum](https://twitter.com/0xruhum)\n  1. Diraco\n  1. [Randyyy](https://twitter.com/randyyramadhan)\n  1. zeesaw\n  1. 0xc0ffEE\n  1. [IgnacioB](https://twitter.com/AdonaiR6)\n  1. [dharma09](https://twitter.com/im_Dharma09)\n  1. [hakerbaya](https://www.twitter.com/hakerbaya)\n  1. nxrblsrpr\n  1. 0xbepresent\n  1. find\\_a\\_bug\n  1. francoHacker\n  1. ltyu\n\nThis contest was judged by [Justin Goro](https://github.com/gititGoro).\n\nFinal report assembled by [itsmetechjay](https://twitter.com/itsmetechjay).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 15 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 13 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 85 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 94 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 Fraxlend (Frax Finance) contest repository](https://github.com/code-423n4/2022-08-frax), and is composed of 9 smart contracts written in the Solidity programming language and includes 2,110 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# High Risk Findings (2)\n## [[H-01] Any borrower with bad debt can be liquidated multiple times to lock funds in the lending pair](https://github.com/code-423n4/2022-08-frax-findings/issues/102)\n_Submitted by panprog, also found by 0xA5DF and Lambda_\n\nLeftover shares in `liquidateClean` are only subtracted from pair totals, but not from user's borrowed shares. This means that after `liquidateClean`, borrower's shares will be greater than `0` (leftover shares after liquidations), but the user is still insolvent and can be liquidated again and again (with `_sharesToLiquidate` set to `0`). Each subsequent liquidation will write off the bad debt (reduce pair totals by borrower leftover shares/amounts), but doesn't take anything from liquidator nor borrower (since `_sharesToLiquidate == 0`).\n\nThis messes up the whole pair accounting, with total asset amounts reducing and total borrow amounts and shares reducing. This will make it impossible for borrowers to repay debt (or be liquidated), because borrow totals will underflow, and lenders amount to withdraw will reduce a lot (they will share non-existant huge bad debt).\n\nReducing pair totals scenario:\n\n1.  Alice borrows `1000 FRAX` (`1000` shares) against `1.5 ETH` collateral (`1 ETH = 1000`, `Max LTV` = `75%`)\n2.  ETH drops to `500` very quickly with liquidators being unable to liquidate Alice due to network congestion\n3.  At ETH = `500`, Alice collateral is worth `750` against `1000 FRAX` debt, making Alice insolvent and in a bad debt\n4.  Liquidator calls `liquidateClean` for `800` shares, which cleans up all available collateral of `1.5 ETH`.\n5.  At this point Alice has `200` shares debt with `0` collateral\n6.  Liquidator repeatedly calls `liquidateClean` with `0` shares to liquidate. Each call pair totals are reduced by `200` shares (and total borrow amount by a corresponding amount).\n7.  When pair totals reach close to `0`, the pool is effectively locked. Borrowers can't repay, lenders can withdraw severly reduced amounts.\n\n### Proof of Concept\n\nCopy this to src/test/e2e/LiquidationBugTest.sol\n\n<https://gist.github.com/panprog/cbdc1658d63c30c9fe94127a4b4b7e72>\n\n### Recommended Mitigation Steps\n\nAfter the line\n\n<https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L1012>\n\nadd\n\n        _sharesToLiquidate += _sharesToAdjust;\n\n**[amirnader-ghazvini (Frax) marked as duplicate and commented](https://github.com/code-423n4/2022-08-frax-findings/issues/102#issuecomment-1230721732):**\n > Duplicate of [#112](https://github.com/code-423n4/2022-08-frax-findings/issues/112)\n\n**[gititGoro (judge) commented](https://github.com/code-423n4/2022-08-frax-findings/issues/102#issuecomment-1264719973):**\n > Setting to original in set.\n\n**[DrakeEvans (Frax) confirmed](https://github.com/code-423n4/2022-08-frax-findings/issues/102)**\n\n\n\n***\n\n## [[H-02] `liquidate()` doesn't mark off bad debt, leading to a 'last lender to withdraw loses' scenario](https://github.com/code-423n4/2022-08-frax-findings/issues/141)\n_Submitted by 0xA5DF, also found by cccz and Lambda_\n\nWhen there's bad debt which wasn't marked off yet, the `totalAssets.amount` is higher than the actual (solvent) amount the pair has, meaning that lenders who redeem their tokens earlier will get more in return, at the expense of lenders who leave later.\nTherefore bad debt should be marked off as soon as possible, the later it's done the more interest it accumulates and the higher the chances are that some of the lenders will notice and redeem their shares before the bad debt is subtracted from the total assets amount.\n\nHaving the option to liquidate via the `liquidate()` function (which doesn't mark off bad debt) can lead to users using that function and leaving bad debt alongside zero collateral or near-zero collateral (giving no motivation for other users to liquidate the rest).\n\nMarking off the remaining of the bad debt via `liquidateClean()` with 0 shares might be possible (not always, some tokens [don't allow 0 transfers](https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers)), however there's no motivation for outside users to do so. And as for the lenders - redeeming their tokens before the bad debt is subtracted from the total amount might be more profitable than staying and marking off the bad debt.\n\n### Impact\n\nSome lenders might be able to dodge the loss of the bad debt (+ interest), while the last one(s) will have to absorb the lost of the lenders who left too.\n\n### Proof of Concept\n\nConsider the following scenario:\n\n*   A pair has 10 lenders with 1K$ from each one (10K total)\n*   Borrower borrowed that 10K\n*   The collateral price went down and now it's worth only 7K\n*   A liquidator notices that and liquidates it via `liquidate()`\n*   The `totalAssets.amount` is 10K + interest, but the total asset amount is actually less than 7K (subtracting liquidator fees)\n*   6 lenders notice that and redeem their shares, getting back their money + interest\n*   The 7th lender to redeem will only be able to get back part of his money\n*   The remaining 3 lenders will loose all of their money\n\n### Recommended Mitigation Steps\n\nMark off bad debt when remaining collateral reaches zero or near-zero value.\n\n(if only `liquidateClean()` was available then there would be a motivation to not leave near-zero collateral, but as long as this isn't the case consider marking off also in case of near-zero collateral left).\n\n**[DrakeEvans (Frax) confirmed](https://github.com/code-423n4/2022-08-frax-findings/issues/142)**\n\n**[gititGoro (judge) commented](https://github.com/code-423n4/2022-08-frax-findings/issues/141#issuecomment-1266170140):**\n > Setting to original in set. Severity will be maintained as the wardens couldn't know that only one liquidate function would be included in the final release.\n\n\n\n***\n\n\n# Medium Risk Findings (13)\n## [[M-01] Penalty rate is used for pre-maturity date as well](https://github.com/code-423n4/2022-08-frax-findings/issues/111)\n_Submitted by 0xA5DF, also found by 0x52 and rbserver_\n\nWhen `_addInterest()` is called post maturity, the penalty rate is applied since the last time `_addInterest()` was called, including the period before maturity.\n\n### Impact\n\nBorrowers will be charged with higher interest rates, when maturity date passes. The longer the time since `_addInterest()` was last called before maturity date the more extra-interest they will be charged.\n\nSidenote: I think this should be considered High, since it comes at the cost of the assets of the borrowers (even though it stems from unnecessary  fees being charged, similar to [this Putty bug](https://code4rena.com/reports/2022-06-putty#h-01-fee-is-being-deducted-when-put-is-expired-and-not-when-it-is-exercised)).\n\n### Proof of Concept\n\nThe test compares 2 scenarios, the 1st one where `addInterest()` isn't called for 30 days before maturity date, and in the 2nd it isn't called just for 1 day before.\n\nThe debt (**not interest**) in the first scenario would be \\~50% higher than the second, see test output below.\n\nAt `src/test/e2e/BorrowPairTest.t.sol` I've modified `_fuzzySetupBorrowToken()` to this and then ran `source .env && forge test --fork-url $MAINNET_URL --fork-block-number $DEFAULT_FORK_BLOCK -m testFuzzyMaxLTVBorrowToken -vvv`.\nAnd I've also modified `src/test/e2e/BasePairTest.sol` a bit so that each pair can have a different name for salt (see diff below).\n\n```solidity\n    function _fuzzySetupBorrowToken(\n        uint256 _minInterest,\n        uint256 _vertexInterest,\n        uint256 _maxInterest,\n        uint256 _vertexUtilization,\n        uint256 _maxLTV,\n        uint256 _liquidationFee,\n        uint256 _priceTop,\n        uint256 _priceDiv\n    ) public {\n        asset = IERC20(FIL_ERC20);\n        collateral = IERC20(MKR_ERC20);\n        oracleMultiply = AggregatorV3Interface(CHAINLINK_MKR_ETH);\n        oracleMultiply.setPrice(_priceTop, 1e8, vm);\n        oracleDivide = AggregatorV3Interface(CHAINLINK_FIL_ETH);\n        oracleDivide.setPrice(_priceDiv, 1e8, vm);\n        uint256 _oracleNormalization = 1e18;\n        (\n            address _rateContract,\n            bytes memory _rateInitData\n        ) = fuzzyRateCalculator(\n                2,\n                _minInterest,\n                _vertexInterest,\n                _maxInterest,\n                _vertexUtilization\n            );\n        startHoax(COMPTROLLER_ADDRESS);\n        setWhitelistTrue();\n        vm.stopPrank();\n\n        address[] memory _borrowerWhitelist = _maxLTV >= LTV_PRECISION\n            ? users\n            : new address[](0);\n        address[] memory _lenderWhitelist = _maxLTV >= LTV_PRECISION\n            ? users\n            : new address[](0);\n\n        uint256 borrowerDebtWrong;\n        {\n            // wrong calculation, when addInterest isn't called before maturity date (30 days)\n            deployFraxlendCustom(\n                _oracleNormalization,\n                _rateContract,\n                _rateInitData,\n                _maxLTV,\n                _liquidationFee,\n                block.timestamp + 30 days,\n                1000 * DEFAULT_INT,\n                _borrowerWhitelist,\n                _lenderWhitelist\n            );\n            pair.updateExchangeRate();\n            _borrowTest(_maxLTV, 15e20, 15e23);\n            vm.roll(block.number + 1);\n\n\n            vm.warp(block.timestamp + 29 days);\n            vm.roll(block.number + 1);\n            vm.warp(block.timestamp + 2 days);\n            pair.addInterest();\n\n\n\n            address borrower = users[2];\n            uint256 borrowerShares = pair.userBorrowShares(borrower);\n            borrowerDebtWrong = pair.toBorrowAmount(borrowerShares, false);\n        }\n        deploySaltName = \"asdf2\";\n        uint256 borrowerDebtRight;\n        {\n            // relatively correct calculation, when addInterest is called close to maturity date\n            deployFraxlendCustom(\n                _oracleNormalization,\n                _rateContract,\n                _rateInitData,\n                _maxLTV,\n                _liquidationFee,\n                block.timestamp + 30 days,\n                1000 * DEFAULT_INT,\n                _borrowerWhitelist,\n                _lenderWhitelist\n            );\n            pair.updateExchangeRate();\n            _borrowTest(_maxLTV, 15e20, 15e23);\n            vm.roll(block.number + 1);\n\n            vm.warp(block.timestamp + 29 days);\n\n            pair.addInterest();\n\n            vm.roll(block.number + 1);\n            vm.warp(block.timestamp + 2 days);\n            pair.addInterest();\n\n\n            address borrower = users[2];\n            uint256 borrowerShares = pair.userBorrowShares(borrower);\n            borrowerDebtRight = pair.toBorrowAmount(borrowerShares, false);\n        }\n\n        // compare final debt between both scenarios\n        assertEq(borrowerDebtRight, borrowerDebtWrong);\n    }\n\n\n```\n\n```diff\ndiff --git a/src/test/e2e/BasePairTest.sol b/src/test/e2e/BasePairTest.sol\nindex 25114d9..27321dc 100644\n--- a/src/test/e2e/BasePairTest.sol\n+++ b/src/test/e2e/BasePairTest.sol\n@@ -67,6 +67,8 @@ contract BasePairTest is FraxlendPairConstants, Scenarios, Test {\n     PairAccounting public initial;\n     PairAccounting public final_;\n     PairAccounting public net;\n+    string public deploySaltName = \"asdf\";\n+\n\n     // Users\n     address[] public users = [vm.addr(1), vm.addr(2), vm.addr(3), vm.addr(4), vm.addr(5)];\n@@ -284,10 +286,12 @@ contract BasePairTest is FraxlendPairConstants, Scenarios, Test {\n         address[] memory _approvedLenders\n     ) public {\n         startHoax(COMPTROLLER_ADDRESS);\n+\n+\n         {\n             pair = FraxlendPair(\n                 deployer.deployCustom(\n-                    \"testname\",\n+                    deploySaltName,\n                     _encodeConfigData(_normalization, _rateContractAddress, _initRateData),\n                     _maxLTV,\n                     _liquidationFee,\n\n```\n\nOutput:\n\n```\n  Error: a == b not satisfied [uint]\n    Expected: 2135773332009600000000\n      Actual: 1541017987253789777725\n\n```\n\n### Recommended Mitigation Steps\n\nWhen maturity date passes and the last time `_addInterest()` was called was before maturity date, calculate first the interest rate for that interval as normal interest rate, and then calculate penalty rate for the remaining time.\n\n**[DrakeEvans (Frax) disputed, disagreed with severity and commented](https://github.com/code-423n4/2022-08-frax-findings/issues/111#issuecomment-1238095595):**\n > This is mitigated by borrower calling `addInterest()` this is the purpose of the public addInterest function.  Alternatively they can repay their loan on time as intended.\n\n**[0xA5DF (warden) commented](https://github.com/code-423n4/2022-08-frax-findings/issues/111#issuecomment-1238266791):**\n > Generally speaking, I think we should asses severity based on expected user behavior if the issue hasn't been reported.\n> Since there's no warning to users to call `addInterest()` before maturity date, users would simply not do that and will be charged extra interest.\n>\n> > Alternatively they can repay their loan on time as intended.\n>\n> It's indeed a fine charged for not paying on time, but I don't think you can wave off charging a higher fine than intended as non significant. A user might be a few minutes late and be charged a penalty rate for a few days/weeks.\n\n**[DrakeEvans (Frax) acknowledged](https://github.com/code-423n4/2022-08-frax-findings/issues/111)**\n\n**[gititGoro (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-08-frax-findings/issues/111#issuecomment-1255524092):**\n > It will create an unexpected user experience to be penalized for periods in which a penalty shouldn't apply, especially during high gas eras.\n> If this is communicated to the user, then an acknowledged label is reasonable.\n>\n> If there was an incentive for keeper type users to addInterest such as issuing a small % of shares to users who call the public addInterest then this issue can be marked invalid.\n>\n> As for the severity, the existence of addInterest function as an intended mechanism to avoid this means that steps can be taken to avoid excessive interest charging. Indeed third parties can build on safe wrappers of these contracts in a downstream convex-like service. In other words, high interest charging on late debt is by no means an inevitable outcome.\n>\n> For these two reasons, I'm downgrading severity to 2 and NOT marking invalid.\n\n\n\n***\n\n## [[M-02] Interest can be significantly lower if `addInterest` isn't called frequently enough ](https://github.com/code-423n4/2022-08-frax-findings/issues/145)\n_Submitted by 0xA5DF, also found by sseefried_\n\n`addInterest()` always multiplies the interest rate by the time delta, and then multiplies the total borrow amount by the results (`newTotalBorrowAmount = interestRate * timeDelta * totalBorrowAmount`). This can lead to different interest amounts, depending on how frequently it's called.\n\nThis will mostly affect custom pairs with stable interest rates (e.g. using linear rate with same min/max/vertex interest) which don't have much activity (e.g. whitelisted borrowers and lenders with long term loan).\n\nThe higher the interest rate, the higher the difference will be, for example:\n\n*   15% annual rate would turn into 13.9% if called only once a year (compared to once a day)\n*   30% will turn into 26.2%\n*   50% will turn to 40%\n*   100% to \\~70%\n*   200% to 110%\n\n### Impact\n\nLenders might end up gaining less interest than expected.\n\n### Proof of Concept\n\nThe following test shows a case of 50% annual rate, comparing calling it once in 3 days and only once after a year, the difference would be about 4.5% of the final debt.\n\nAt `src/test/e2e/BorrowPairTest.t.sol` I've modified `_fuzzySetupBorrowToken()` to this and then ran `source .env && forge test --fork-url $MAINNET_URL --fork-block-number $DEFAULT_FORK_BLOCK -m testFuzzyMaxLTVBorrowToken -vvv`.\nAnd I've also modified `src/test/e2e/BasePairTest.sol` a bit so that each pair can have a different name for salt (see diff below).\n\n```solidity\n function _fuzzySetupBorrowToken(\n        uint256 _minInterest,\n        uint256 _vertexInterest,\n        uint256 _maxInterest,\n        uint256 _vertexUtilization,\n        uint256 _maxLTV,\n        uint256 _liquidationFee,\n        uint256 _priceTop,\n        uint256 _priceDiv\n    ) public {\n        asset = IERC20(FIL_ERC20);\n        collateral = IERC20(MKR_ERC20);\n        oracleMultiply = AggregatorV3Interface(CHAINLINK_MKR_ETH);\n        oracleMultiply.setPrice(_priceTop, 1e8, vm);\n        oracleDivide = AggregatorV3Interface(CHAINLINK_FIL_ETH);\n        oracleDivide.setPrice(_priceDiv, 1e8, vm);\n        uint256 _oracleNormalization = 1e18;\n        (\n            address _rateContract,\n            bytes memory _rateInitData\n        ) = fuzzyRateCalculator(\n                2,\n                12864358183, // ~ 50% annual rate - setting this is as min/max/vertex rate\n                12864358183,\n                12864358183,\n                _vertexUtilization\n            );\n        startHoax(COMPTROLLER_ADDRESS);\n        setWhitelistTrue();\n        vm.stopPrank();\n\n        address[] memory _borrowerWhitelist = _maxLTV >= LTV_PRECISION\n            ? users\n            : new address[](0);\n        address[] memory _lenderWhitelist = _maxLTV >= LTV_PRECISION\n            ? users\n            : new address[](0);\n\n        uint256 borrowerDebtWrong;\n        {\n            // wrong calculation, when addInterest isn't called before maturity date (30 days)\n            deployFraxlendCustom(\n                _oracleNormalization,\n                _rateContract,\n                _rateInitData,\n                _maxLTV,\n                _liquidationFee,\n                0,\n                1000 * DEFAULT_INT,\n                _borrowerWhitelist,\n                _lenderWhitelist\n            );\n            pair.updateExchangeRate();\n            _borrowTest(_maxLTV, 15e20, 15e23);\n            vm.roll(block.number + 1);\n\n\n            for(uint256 i =0; i < 100; i++){\n                vm.warp(block.timestamp + 3 days);\n                vm.roll(block.number + 1);\n            }\n            pair.addInterest();\n\n\n\n            address borrower = users[2];\n            uint256 borrowerShares = pair.userBorrowShares(borrower);\n            borrowerDebtWrong = pair.toBorrowAmount(borrowerShares, false);\n        }\n        deploySaltName = \"asdf2\";\n        uint256 borrowerDebtRight;\n        {\n            // relatively correct calculation, when addInterest is called close to maturity date\n            deployFraxlendCustom(\n                _oracleNormalization,\n                _rateContract,\n                _rateInitData,\n                _maxLTV,\n                _liquidationFee,\n                0,\n                1000 * DEFAULT_INT,\n                _borrowerWhitelist,\n                _lenderWhitelist\n            );\n            pair.updateExchangeRate();\n            _borrowTest(_maxLTV, 15e20, 15e23);\n\n            for(uint256 i =0; i < 100; i++){\n                vm.warp(block.timestamp + 3 days);\n                pair.addInterest();\n                vm.roll(block.number + 1);\n\n            }\n            pair.addInterest();\n\n\n            address borrower = users[2];\n            uint256 borrowerShares = pair.userBorrowShares(borrower);\n            borrowerDebtRight = pair.toBorrowAmount(borrowerShares, false);\n        }\n\n        // compare final debt between both scenarios\n        assertEq(borrowerDebtRight, borrowerDebtWrong);\n    }\n\n```\n\n```diff\ndiff --git a/src/test/e2e/BasePairTest.sol b/src/test/e2e/BasePairTest.sol\nindex 25114d9..27321dc 100644\n--- a/src/test/e2e/BasePairTest.sol\n+++ b/src/test/e2e/BasePairTest.sol\n@@ -67,6 +67,8 @@ contract BasePairTest is FraxlendPairConstants, Scenarios, Test {\n     PairAccounting public initial;\n     PairAccounting public final_;\n     PairAccounting public net;\n+    string public deploySaltName = \"asdf\";\n+\n\n     // Users\n     address[] public users = [vm.addr(1), vm.addr(2), vm.addr(3), vm.addr(4), vm.addr(5)];\n@@ -284,10 +286,12 @@ contract BasePairTest is FraxlendPairConstants, Scenarios, Test {\n         address[] memory _approvedLenders\n     ) public {\n         startHoax(COMPTROLLER_ADDRESS);\n+\n+\n         {\n             pair = FraxlendPair(\n                 deployer.deployCustom(\n-                    \"testname\",\n+                    deploySaltName,\n                     _encodeConfigData(_normalization, _rateContractAddress, _initRateData),\n                     _maxLTV,\n                     _liquidationFee,\n\n```\n\nOutput:\n\n```\n  Error: a == b not satisfied [uint]\n    Expected: 2000166246155040000000\n      Actual: 2092489655740553483735\n\n```\n\nAlso, here's a JS function I've used to calculate the rate depending on frequency:\n\n```javascript\nfunction calculateInterest(annualRate, frequency){\n    let dailyRate = (1+annualRate) ** (1/365);\n    let ratePerFrequency = (dailyRate -1) * 365 / frequency;\n    let finalRate = (1+ratePerFrequency) ** frequency;\n    return finalRate - 1;\n}\n\n```\n\n### Recommended Mitigation Steps\n\n*   Let the users know that in some cases not calling `addInterest()` frequently enough can lead to lower interest rates.\n*   Consider dividing the interest calculation into small period of times in case a long period has passed since last time `addInterest()` ran.\n\nSomething along these lines (this shouldn't cost much more gas, as it's mostly math operations):\n\n```solidity\n            // Calculate interest accrued\n            if(_deltaTime > THRESHOLD){\n                uint256 iterations = min(MAX_ITERATIONS, _deltaTime / THRESHOLD);\n                uint256 multiplier = 1e36;\n                for(uint i=0; i < iterations; i++){\n                _   multiplier =  (multiplier * _deltaTime  * _currentRateInfo.ratePerSec) / (1e18 * iterations);\n                }\n                _interestEarned = ( _totalBorrow.amount * multiplier) / 1e36;\n\n            }else{\n                _interestEarned = (_deltaTime * _totalBorrow.amount * _currentRateInfo.ratePerSec) / 1e18;\n            }\n```\n\n**[DrakeEvans (Frax) acknowledged](https://github.com/code-423n4/2022-08-frax-findings/issues/145)**\n\n\n\n***\n\n## [[M-03] Impossible to `setCreationCode()` with code size less than 13K](https://github.com/code-423n4/2022-08-frax-findings/issues/153)\n_Submitted by 0xA5DF_\n\n<https://github.com/code-423n4/2022-08-frax/blob/92a8d7d331cc718cd64de6b02515b554672fb0f3/src/contracts/FraxlendPairDeployer.sol#L170-L178>\n\n<https://github.com/code-423n4/2022-08-frax/blob/92a8d7d331cc718cd64de6b02515b554672fb0f3/src/contracts/FraxlendPairDeployer.sol#L207-L210>\n\n### Vulnerability Details\n\nIn case of setting the creation code to less than 13K the creation would fail at 2 points:\n\n*   [`BytesLib.slice(_creationCode, 0, 13000)`](https://github.com/code-423n4/2022-08-frax/blob/92a8d7d331cc718cd64de6b02515b554672fb0f3/src/contracts/FraxlendPairDeployer.sol#L171) would fail since `slice()` requires that `_bytes.length` would be at least `start + length`.\n*   [`SSTORE2.read(contractAddress2)`](https://github.com/code-423n4/2022-08-frax/blob/92a8d7d331cc718cd64de6b02515b554672fb0f3/src/contracts/FraxlendPairDeployer.sol#L209) at `_deployFirst()` would fail since calling this on address without code would cause a math underflow (due to [`pointer.code.length - DATA_OFFSET`](https://github.com/code-423n4/2022-08-frax/blob/main/node_modules/@rari-capital/solmate/src/utils/SSTORE2.sol#L51))\n\n### Impact\n\nIn case the code of the pair gets smaller (e.g. optimization, moving part of the code to a library etc.) to 13K or less, it'd be impossible to set it as the new creation code (or in the case of the 2nd issue, it'd be impossible to deploy it).\n\n### Proof of Concept\n\nIn the following test I try to set creation code to a smaller mock pair.\nThe test was added to `src/test/e2e/FraxlendPairDeployerTest.sol`:\n\n```solidity\n    function testChangeCreationCodeBug() public {\n        // Setup contracts\n        setExternalContracts();\n        startHoax(COMPTROLLER_ADDRESS);\n        setWhitelistTrue();\n        vm.stopPrank();\n        console2.log(\"Mock pair size:\", type(MockPair).creationCode.length);\n\n        vm.startPrank(deployer.owner());\n        deployer.setCreationCode(type(MockPair).creationCode);\n\n        // Set initial oracle prices\n        bytes memory _rateInitData = defaultRateInitForLinear();\n        deployer.deploy(\n            abi.encode(\n                address(asset),\n                address(collateral),\n                address(oracleMultiply),\n                address(oracleDivide),\n                1e10,\n                address(linearRateContract),\n                _rateInitData\n            )\n        );\n\n    }\n```\n\nThe mock pair was created as `src/contracts/audit/MockPair.sol`:\n\n````solidity\n// SPDX-License-Identifier: ISC\npragma solidity ^0.8.15;\n\nimport \"@openzeppelin/contracts/token/ERC20/ERC20.sol\";\nimport \"@openzeppelin/contracts/token/ERC20/IERC20.sol\";\nimport \"@openzeppelin/contracts/security/ReentrancyGuard.sol\";\nimport \"@openzeppelin/contracts/security/Pausable.sol\";\nimport \"@openzeppelin/contracts/access/Ownable.sol\";\nimport \"@openzeppelin/contracts/utils/math/SafeCast.sol\";\nimport \"@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol\";\nimport \"../FraxlendPairConstants.sol\";\nimport \"../libraries/VaultAccount.sol\";\nimport \"../libraries/SafeERC20.sol\";\nimport \"../interfaces/IERC4626.sol\";\nimport \"../interfaces/IFraxlendWhitelist.sol\";\nimport \"../interfaces/IRateCalculator.sol\";\nimport \"../interfaces/ISwapper.sol\";\n\n/// @title FraxlendPairCore\n/// @author Drake Evans (Frax Finance) https://github.com/drakeevans\n/// @notice  An abstract contract which contains the core logic and storage for the FraxlendPair\ncontract MockPair is FraxlendPairConstants, ERC20, Ownable, Pausable, ReentrancyGuard {\n    using VaultAccountingLibrary for VaultAccount;\n    using SafeERC20 for IERC20;\n    using SafeCast for uint256;\n\n    string public version = \"1.0.0\";\n\n    // ============================================================================================\n    // Settings set by constructor() & initialize()\n    // ============================================================================================\n\n    // Asset and collateral contracts\n    IERC20 internal immutable assetContract;\n    IERC20 public immutable collateralContract;\n\n    // Oracle wrapper contract and oracleData\n    address public immutable oracleMultiply;\n    address public immutable oracleDivide;\n    uint256 public immutable oracleNormalization;\n\n    // LTV Settings\n    uint256 public immutable maxLTV;\n\n    // Liquidation Fee\n    uint256 public immutable cleanLiquidationFee;\n    uint256 public immutable dirtyLiquidationFee;\n\n    // Interest Rate Calculator Contract\n    IRateCalculator public immutable rateContract; // For complex rate calculations\n    bytes public rateInitCallData; // Optional extra data from init function to be passed to rate calculator\n\n    // Swapper\n    mapping(address => bool) public swappers; // approved swapper addresses\n\n    // Deployer\n    address public immutable DEPLOYER_ADDRESS;\n\n    // Admin contracts\n    address public immutable CIRCUIT_BREAKER_ADDRESS;\n    address public immutable COMPTROLLER_ADDRESS;\n    address public TIME_LOCK_ADDRESS;\n\n    // Dependencies\n    address public immutable FRAXLEND_WHITELIST_ADDRESS;\n\n    // ERC20 token name, accessible via name()\n    string internal nameOfContract;\n\n    // Maturity Date & Penalty Interest Rate (per Sec)\n    uint256 public immutable maturityDate;\n    uint256 public immutable penaltyRate;\n\n    // ============================================================================================\n    // Storage\n    // ============================================================================================\n\n    /// @notice Stores information about the current interest rate\n    /// @dev struct is packed to reduce SLOADs. feeToProtocolRate is 1e5 precision, ratePerSec is 1e18 precision\n    CurrentRateInfo public currentRateInfo;\n    struct CurrentRateInfo {\n        uint64 lastBlock;\n        uint64 feeToProtocolRate; // Fee amount 1e5 precision\n        uint64 lastTimestamp;\n        uint64 ratePerSec;\n    }\n\n    /// @notice Stores information about the current exchange rate. Collateral:Asset ratio\n    /// @dev Struct packed to save SLOADs. Amount of Collateral Token to buy 1e18 Asset Token\n    ExchangeRateInfo public exchangeRateInfo;\n    struct ExchangeRateInfo {\n        uint32 lastTimestamp;\n        uint224 exchangeRate; // collateral:asset ratio. i.e. how much collateral to buy 1e18 asset\n    }\n\n    // Contract Level Accounting\n    VaultAccount public totalAsset; // amount = total amount of assets, shares = total shares outstanding\n    VaultAccount public totalBorrow; // amount = total borrow amount with interest accrued, shares = total shares outstanding\n    uint256 public totalCollateral; // total amount of collateral in contract\n\n    // User Level Accounting\n    /// @notice Stores the balance of collateral for each user\n    mapping(address => uint256) public userCollateralBalance; // amount of collateral each user is backed\n    /// @notice Stores the balance of borrow shares for each user\n    mapping(address => uint256) public userBorrowShares; // represents the shares held by individuals\n    // NOTE: user shares of assets are represented as ERC-20 tokens and accessible via balanceOf()\n\n    // Internal Whitelists\n    bool public immutable borrowerWhitelistActive;\n    mapping(address => bool) public approvedBorrowers;\n\n    bool public immutable lenderWhitelistActive;\n    mapping(address => bool) public approvedLenders;\n    event Fine(uint256 line);\n    // ============================================================================================\n    // Initialize\n    // ============================================================================================\n\n    /// @notice The ```constructor``` function is called on deployment\n    /// @param _configData abi.encode(address _asset, address _collateral, address _oracleMultiply, address _oracleDivide, uint256 _oracleNormalization, address _rateContract, bytes memory _rateInitData)\n    /// @param _maxLTV The Maximum Loan-To-Value for a borrower to be considered solvent (1e5 precision)\n    /// @param _liquidationFee The fee paid to liquidators given as a % of the repayment (1e5 precision)\n    /// @param _maturityDate The maturityDate date of the Pair\n    /// @param _penaltyRate The interest rate after maturity date\n    /// @param _isBorrowerWhitelistActive Enables borrower whitelist\n    /// @param _isLenderWhitelistActive Enables lender whitelist\n    constructor(\n        bytes memory _configData,\n        bytes memory _immutables,\n        uint256 _maxLTV,\n        uint256 _liquidationFee,\n        uint256 _maturityDate,\n        uint256 _penaltyRate,\n        bool _isBorrowerWhitelistActive,\n        bool _isLenderWhitelistActive\n    )  ERC20(\"\", \"\") {\n        // Handle Immutables Configuration\n        {\n            (\n                address _circuitBreaker,\n                address _comptrollerAddress,\n                address _timeLockAddress,\n                address _fraxlendWhitelistAddress\n            ) = abi.decode(_immutables, (address, address, address, address));\n\n            // Deployer contract\n            DEPLOYER_ADDRESS = msg.sender;\n            CIRCUIT_BREAKER_ADDRESS = _circuitBreaker;\n            COMPTROLLER_ADDRESS = _comptrollerAddress;\n            TIME_LOCK_ADDRESS = _timeLockAddress;\n            FRAXLEND_WHITELIST_ADDRESS = _fraxlendWhitelistAddress;\n        }\n        emit Fine(177);\n        {\n            (\n                address _asset,\n                address _collateral,\n                address _oracleMultiply,\n                address _oracleDivide,\n                uint256 _oracleNormalization,\n                address _rateContract,\n\n            ) = abi.decode(_configData, (address, address, address, address, uint256, address, bytes));\n\n            // Pair Settings\n            assetContract = IERC20(_asset);\n            collateralContract = IERC20(_collateral);\n            currentRateInfo.feeToProtocolRate = DEFAULT_PROTOCOL_FEE;\n            cleanLiquidationFee = _liquidationFee;\n            dirtyLiquidationFee = (_liquidationFee * 9000) / LIQ_PRECISION; // 90% of clean fee\n\n            if (_maxLTV >= LTV_PRECISION && !_isBorrowerWhitelistActive) revert BorrowerWhitelistRequired();\n            maxLTV = _maxLTV;\n\n            // Swapper Settings\n            swappers[FRAXSWAP_ROUTER_ADDRESS] = true;\n\n            // Oracle Settings\n            {\n                IFraxlendWhitelist _fraxlendWhitelist = IFraxlendWhitelist(FRAXLEND_WHITELIST_ADDRESS);\n                // Check that oracles are on the whitelist\n                if (_oracleMultiply != address(0) && !_fraxlendWhitelist.oracleContractWhitelist(_oracleMultiply)) {\n                    revert NotOnWhitelist(_oracleMultiply);\n                }\n\n                if (_oracleDivide != address(0) && !_fraxlendWhitelist.oracleContractWhitelist(_oracleDivide)) {\n                    revert NotOnWhitelist(_oracleDivide);\n                }\n\n                // Write oracleData to storage\n                oracleMultiply = _oracleMultiply;\n                oracleDivide = _oracleDivide;\n                oracleNormalization = _oracleNormalization;\n\n                // Rate Settings\n                if (!_fraxlendWhitelist.rateContractWhitelist(_rateContract)) {\n                    revert NotOnWhitelist(_rateContract);\n                }\n            }\n\n            rateContract = IRateCalculator(_rateContract);\n        }\n        emit Fine(177);\n\n\n        // Set approved borrowers whitelist\n        borrowerWhitelistActive = _isBorrowerWhitelistActive;\n\n        // Set approved lenders whitlist active\n        lenderWhitelistActive = _isLenderWhitelistActive;\n\n        // Set maturity date & penalty interest rate\n        maturityDate = _maturityDate;\n        penaltyRate = _penaltyRate;\n    }\n\n\n    function initialize(\n        string calldata _name,\n        address[] calldata _approvedBorrowers,\n        address[] calldata _approvedLenders,\n        bytes calldata _rateInitCallData\n    ) external {\n    }\n\n}\n\n\n````\n\n### Recommended Mitigation Steps\n\nIf creation code length is 13K or less:\n\n*   Don't run `BytesLib.slice()`\n*   At deployment read only from the first address\n\n**[DrakeEvans (Frax) acknowledged](https://github.com/code-423n4/2022-08-frax-findings/issues/153)**\n\n\n\n***\n\n## [[M-04] Wrong percent for `FraxlendPairCore.dirtyLiquidationFee`.](https://github.com/code-423n4/2022-08-frax-findings/issues/238)\n*Submitted by auditor0517, also found by \\_Adam, 0xA5DF, cccz, minhquanym, minhtrng, and zzzitron*\n\nAfter confirming with the sponsor, `dirtyLiquidationFee` is 90% of `cleanLiquidationFee` like the [comment](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L194).\n\nBut it uses `9% (9000 / 1e5 = 0.09)` and the fee calculation will be wrong [here](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L988-L990).\n\n### Recommended Mitigation Steps\n\nWe should change `9000` to `90000`.\n\n    dirtyLiquidationFee = (_liquidationFee * 90000) / LIQ_PRECISION; // 90% of clean fee\n\n\n**[DrakeEvans (Frax) confirmed and commented](https://github.com/code-423n4/2022-08-frax-findings/issues/238#issuecomment-1238157712):**\n > Confirmed.\n\n**[gititGoro (judge) commented](https://github.com/code-423n4/2022-08-frax-findings/issues/238#issuecomment-1259011750):**\n > This issue has a great many duplicates. Reason for setting this report as the original:\n> 1. It's complete in that it charts the problem and gives a code based mitigation\n> 2. It's short and to the point.\n> 3. The sponsor's preference was factored in.\n\n\n\n***\n\n## [[M-05] Liquidator might end up paying much more asset than collateral received](https://github.com/code-423n4/2022-08-frax-findings/issues/99)\n*Submitted by 0xA5DF, also found by \\_\\_141345\\_\\_*\n\n`liquidateClean` doesn't check that the amount of shares the liquidator repays are covered by the collateral available, if the user repays more shares than (equally worth) collateral available - he'll get only the amount of collateral available.\n\n### Impact\n\nLiquidator might end up paying assets that are worth much more than the collateral he's received.\n\nEven though it's also the liquidator's responsibility to check that there's enough collateral available, mistakes are commonly done (wrong calculation, typos, deadline too large) and the protocol should prevent those kinds of errors if possible.\n\nOtherwise users might lose trust in the protocol when they lose their funds due to errors.\n\n### Proof of Concept\n\nThe following test was added to `src/test/e2e/LiquidationPairTest.sol`.\nIn this scenario the user ends up with collateral that's worth only 1/3 of the asset-tokens he paid.\n\n```solidity\n\n    function testCleanLiquidate() public {\n        // Setup contracts\n        defaultSetUp();\n        // Sets price to 3200 USD per ETH\n\n        uint256 _amountToBorrow = 16e20; // 1.5k\n        uint256 _amountInPool = 15e23; // 1.5m\n\n        // collateral is 1.5 times borrow amount\n        oracleDivide.setPrice(3200, 1, vm);\n        mineBlocks(1);\n        (, uint256 _exchangeRate) = pair.exchangeRateInfo();\n        uint256 _collateralAmount = (_amountToBorrow * _exchangeRate * 3) / (2 * 1e18);\n        faucetFunds(asset, _amountInPool);\n        faucetFunds(collateral, _collateralAmount);\n        lendTokenViaDeposit(_amountInPool, users[0]);\n        borrowToken(uint128(_amountToBorrow), _collateralAmount, users[2]);\n        uint256 mxltv = pair.maxLTV();\n        uint256 cleanLiquidationFee = pair.cleanLiquidationFee();\n        uint256 liquidation_price = ((((1e18 / _exchangeRate) * mxltv) / 1e5) * (1e5 + cleanLiquidationFee)) / 1e5;\n        liquidation_price /= 4; // Collateral price goes down enough so that it doesn't cover the loan\n        oracleDivide.setPrice(liquidation_price, 1, vm);\n        mineBlocks(1);\n        uint128 _shares = pair.userBorrowShares(users[2]).toUint128();\n        for (uint256 i = 0; i < 1; i++) {\n            pair.addInterest();\n            mineOneBlock();\n        }\n        vm.startPrank(users[1]);\n        pair.addInterest();\n        asset.approve(address(pair), toBorrowAmount(_shares, true));\n\n        uint256 liquidatorBalanceBefore = asset.balanceOf(users[1]);\n\n        uint256 collateralGained = pair.liquidateClean(_shares, block.timestamp, users[2]);\n\n        uint256 liquidatorBalanceAfter = asset.balanceOf(users[1]);\n\n        uint256 balanceDiff = liquidatorBalanceBefore - liquidatorBalanceAfter;\n\n        console2.log(\"Balance diff is: \", balanceDiff);\n        console2.log(\"_exchangeRate is: \", _exchangeRate);\n        console2.log(\"cleanLiquidationFee is: \", cleanLiquidationFee);\n\n        (, _exchangeRate) = pair.exchangeRateInfo();\n        // 11/10 is for liquidation fee, 1e18 is for exchange precision\n        assertEq(collateralGained, balanceDiff *  _exchangeRate * 11 / 10 / 1e18);\n\n        assertEq(pair.userBorrowShares(users[2]), 0);\n        vm.stopPrank();\n    }\n```\n\nOutput:\n\n```\n  Balance diff is:  1600000011384589113999\n  _exchangeRate is:  863759326621800\n  cleanLiquidationFee is:  10000\n  Error: a == b not satisfied [uint]\n    Expected: 7394958035811125166\n      Actual: 2073022383892320000\n\n```\n\n### Recommended Mitigation Steps\n\nCheck that the shares intended to be repaid are worth the collateral + fee, if not reduce the amount of shares to be repaid accordingly.\n\n**[DrakeEvans (Frax) acknowledged, but disagreed with severity and commented](https://github.com/code-423n4/2022-08-frax-findings/issues/99#issuecomment-1237997672):**\n > This is by design, the deadline parameter can protect against this.  Liquidators are encouraged to provide values such that all collateral is cleared.  This does present the risk of slightly (a few wei) overpaying for the collateral.  However, they are compensated with a high liquidation fee.  They can protect themselves by inputting a deadline to the tx as well to prevent interest accruing and an old tx being replayed.\n\n**[gititGoro (judge) commented](https://github.com/code-423n4/2022-08-frax-findings/issues/99#issuecomment-1259060765):**\n > My concern is with transaction ordering. While the deadline can prevent stale transactions, nothing prevents a validator (or whoever orders transactions in the future) from inserting their repayment prior to a well calculated transaction. An MEV drain.\n>\n> What protects the victim in this case is the _totalBorrow parameter. It will be lower and so place a lower bound on the overpayment.\n>\n> Since liquidators can't protect themselves from MEV, there is potential leakage. Leaving severity at Medium.\n\n\n\n***\n\n## [[M-06] FraxlendPair#setTimeLock: Allows the owner to reset TIME_LOCK_ADDRESS](https://github.com/code-423n4/2022-08-frax-findings/issues/129)\n_Submitted by carlitox477, also found by 0xA5DF, 0xDjango, brgltd, IllIllI, and reassor_\n\n<https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L84-L86>\n\n<https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L204-L207>\n\n### Impact\n\nAllows to reset **TIME_LOCK_ADDRESS** value multiple times by the owner. According to comments in FraxlendPairCore this should act as a constant/immutable value. Given that this value will be defined through function **setTimeLock** in **FraxLendPair** contract this value can be changed whenever the owner wants. This does not seem to be the expected behaviour.\n\n### Proof of Concept\n\nThe owner can call the function **setTimeLock** whenever they want, which resets the value of **TIME_LOCK_ADDRESS**.\n\n### Recommended Mitigation Steps\n\nAdd a bool which act as mutex if **TIME_LOCK_ADDRESS** has already been set, and modify **setTimeLock** function in FraxlendPair contract\n\n```solidity\n// In FraxlendPair contract\nbool public timelockSetted;\nfunction setTimeLock(address _newAddress) external onlyOwner {\n        require(!timelockSetted);\n        emit SetTimeLock(TIME_LOCK_ADDRESS, _newAddress);\n        TIME_LOCK_ADDRESS = _newAddress;\n        timelockeSetted=true;\n}\n```\n\n**[DrakeEvans (Frax) confirmed](https://github.com/code-423n4/2022-08-frax-findings/issues/129)**\n\n\n\n***\n\n## [[M-07] FraxlendPair.changeFee() doesn't update interest before changing fee.](https://github.com/code-423n4/2022-08-frax-findings/issues/236)\n_Submitted by auditor0517_\n\nThis function is changing the protocol fee that is used during interest calculation [here](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L477-L488).\n\nBut it doesn't update interest before changing the fee so the `_feesAmount` will be calculated wrongly.\n\n### Proof of Concept\n\nAs we can see during [pause()](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L326) and [unpause()](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L335), `_addInterest()` must be called before any changes.\n\nBut with the [changeFee()](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L215), it doesn't update interest and the `_feesAmount` might be calculated wrongly.\n\n*   At time `T1`, [\\_currentRateInfo.feeToProtocolRate = F1](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L477).\n*   At `T2`, the owner had changed the fee to `F2`.\n*   At `T3`, [\\_addInterest()](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L409) is called during `deposit()` or other functions.\n*   Then [during this calculation](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L477-L488), `F1` should be applied from `T1` to `T2` and `F2` should be applied from `T2` and `T3`. But it uses `F2` from `T1` to `T2`.\n\n### Recommended Mitigation Steps\n\nRecommend modifying `changeFee()` like below.\n\n    function changeFee(uint32 _newFee) external whenNotPaused {\n        if (msg.sender != TIME_LOCK_ADDRESS) revert OnlyTimeLock();\n        if (_newFee > MAX_PROTOCOL_FEE) {\n            revert BadProtocolFee();\n        }\n\n        _addInterest(); //+++++++++++++++++++++++++++++++++\n\n        currentRateInfo.feeToProtocolRate = _newFee;\n        emit ChangeFee(_newFee);\n    }\n\n**[DrakeEvans (Frax) confirmed, but disagreed with severity and commented](https://github.com/code-423n4/2022-08-frax-findings/issues/236#issuecomment-1238159753):**\n > Disagree with severity as it can be mitigated by calling `addInterest()` beforehand by admin or regular user.  But we will address it anyway for convenience. We assume admins are not malicious.\n\n**[0xA5DF (warden) commented](https://github.com/code-423n4/2022-08-frax-findings/issues/236#issuecomment-1238249426):**\n> Admins might not be malicious, but without knowing about the issue (i.e. if the warden hasn't reported this) they wouldn't call `addInterest()` beforehand, leading to higher interest than intended.\n\n**[gititGoro (judge) commented](https://github.com/code-423n4/2022-08-frax-findings/issues/236#issuecomment-1263082292):**\n > Maintaining severity as it is a potential leakage.\n\n\n\n***\n\n## [[M-08] Owner of `FraxlendPair` can set arbitrary time lock contract address to circumvent time lock](https://github.com/code-423n4/2022-08-frax-findings/issues/156)\n_Submitted by berndartmueller_\n\nThe ownership of a deployed Fraxlend pair is transferred to `COMPTROLLER_ADDRESS` on deployment via `FraxlendPairDeployer_deploySecond`. This very owner is able to change the currently used time lock contract address with the `FraxlendPair.setTimeLock` function. A time lock is enforced on the `FraxlendPair.changeFee` function whenever the protocol fee is adjusted.\n\nHowever, as the Fraxlend pair owner is able to change the time lock contract address to any other arbitrary (contract) address, it is possible to circumvent this timelock without users knowing. By using a custom smart contract without an enforced time lock, the protocol fee can be changed at any time without a proper time lock.\n\n### Proof of Concept\n\n[FraxlendPair.sol#L206](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L206)\n\n````solidity\n/// @notice The ```setTimeLock``` function sets the TIME_LOCK address\n/// @param _newAddress the new time lock address\nfunction setTimeLock(address _newAddress) external onlyOwner {\n    emit SetTimeLock(TIME_LOCK_ADDRESS, _newAddress);\n    TIME_LOCK_ADDRESS = _newAddress;\n}\n````\n\n### Recommended Mitigation Steps\n\nCurrently, the owner `COMPTROLLER_ADDRESS` address is trustworthy, however, nothing prevents the above-described scenario. To protect users from sudden protocol fee changes, consider using a minimal time lock implementation directly implemented in the contract without trusting any external contract.\n\n**[DrakeEvans (Frax) confirmed](https://github.com/code-423n4/2022-08-frax-findings/issues/156)**\n\n\n\n***\n\n## [[M-09] FraxlendPair.sol is not fully EIP-4626 compliant](https://github.com/code-423n4/2022-08-frax-findings/issues/79)\n_Submitted by 0x52, also found by berndartmueller, cryptphi, and Lambda_\n\n<https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L136-L138>\n\n<https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L140-L142>\n\n### Impact\n\nFraxlendPair.sol is not EIP-4626 compliant, variation from the standard could break composability and potentially lead to loss of funds.\n\n### Proof of Concept\n\nAccording to EIP-4626 method specifications (<https://eips.ethereum.org/EIPS/eip-4626>)\n\nFor maxDeposit:\n\n    MUST factor in both global and user-specific limits, like if deposits are entirely disabled (even temporarily) it MUST return 0.\n\nFor maxMint:\n\n    MUST factor in both global and user-specific limits, like if mints are entirely disabled (even temporarily) it MUST return 0.\n\nWhen FraxlendPair.sol is paused, deposit and mint are both disabled. This means that maxMint and maxDeposit should return 0 when the contract is paused.\n\nThe current implementations of maxMint and maxDeposit do not follow this specification:\n\n    function maxDeposit(address) external pure returns (uint256) {\n        return type(uint128).max;\n    }\n\n    function maxMint(address) external pure returns (uint256) {\n        return type(uint128).max;\n    }\n\nNo matter the state of the contract they always return uint128.max, but they should return 0 when the contract is paused.\n\n### Recommended Mitigation Steps\n\nmaxDeposit and maxMint should be updated to return 0 when contract is paused. Use of the whenNotPaused modifier is not appropriate because that would cause a revert and maxDeposit and maxMint should never revert according to EIP-4626.\n\n**[DrakeEvans (Frax) confirmed](https://github.com/code-423n4/2022-08-frax-findings/issues/79)**\n\n\n\n***\n\n## [[M-10] Decimals limitation limits the tokens that can be used](https://github.com/code-423n4/2022-08-frax-findings/issues/200)\n_Submitted by CertoraInc_\n\nDecimals limitation limits the tokens that can be used.\n\n### Proof of Concept\n\nLet's give some name to the decimals of certain numbers:\nn = decimals of numerator oracle.\nd =  decimals denominator oracle.\na = decimals of the asset.\nc= decimals of the collateral.\n\nNow, the `oracleNormalization = 10 ^(18 + n - d + a - c)`.\n\nAnd here: <https://github.com/code-423n4/2022-08-frax/blob/main/src/contracts/FraxlendPairCore.sol#L536> , `price` has decimals of `36 + n -d`, so `here()` when we calculate `_exchangeRate = _price / oracleNormalization;` it would underflow and revert if `a >18 +c`.\n\nAnd that's a pretty big limitation on the tokens options. We have USDC which have 6 decimals so all the tokens the their decimals < 24 are not possible to use in this system (with USDC together).\n\n**[DrakeEvans (Frax) disputed, disagreed with severity and commented](https://github.com/code-423n4/2022-08-frax-findings/issues/200#issuecomment-1238077975):**\n > Known issue, prevents certain combinations of tokens from being deployed.  No high risk as no deployment will occur.  No funds at risk, no incorrect functionality. Low at best.\n\n**[gititGoro (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-08-frax-findings/issues/200#issuecomment-1266177019):**\n > This hasn't been listed as a known issue so it can't be marked invalid but since deployments can't occur, it's a Medium severity.\n\n\n\n***\n\n## [[M-11] Fraxlend pair deployment can be front-run by a custom pair deployment](https://github.com/code-423n4/2022-08-frax-findings/issues/166)\n_Submitted by berndartmueller, also found by IllIllI_\n\n<https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L205>\n\n<https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L329-L330>\n\n<https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L253>\n\n### Impact\n\nThe `FraxlendPairDeployer` contract used to deploy Fraxlend pairs prevents deploying pairs with the same `salt` and `_configData`. This makes it vulnerable to front-running pair deployments and prevents deploying honest Fraxlend pairs.\n\n### Proof of Concept\n\n[FraxlendPairDeployer.\\_deployFirst](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L205)\n\n```solidity\nfunction _deployFirst(\n    bytes32 _saltSeed,\n    bytes memory _configData,\n    bytes memory _immutables,\n    uint256 _maxLTV,\n    uint256 _liquidationFee,\n    uint256 _maturityDate,\n    uint256 _penaltyRate,\n    bool _isBorrowerWhitelistActive,\n    bool _isLenderWhitelistActive\n) private returns (address _pairAddress) {\n    {\n        // _saltSeed is the same for all public pairs so duplicates cannot be created\n        bytes32 salt = keccak256(abi.encodePacked(_saltSeed, _configData));\n        require(deployedPairsBySalt[salt] == address(0), \"FraxlendPairDeployer: Pair already deployed\"); // @audit-info Reverts if a pair with the same salt is already deployed\n\n        bytes memory _creationCode = BytesLib.concat(\n            SSTORE2.read(contractAddress1),\n            SSTORE2.read(contractAddress2)\n        );\n        bytes memory bytecode = abi.encodePacked(\n            _creationCode,\n            abi.encode(\n                _configData,\n                _immutables,\n                _maxLTV,\n                _liquidationFee,\n                _maturityDate,\n                _penaltyRate,\n                _isBorrowerWhitelistActive,\n                _isLenderWhitelistActive\n            )\n        );\n\n        assembly {\n            _pairAddress := create2(0, add(bytecode, 32), mload(bytecode), salt)\n        }\n        require(_pairAddress != address(0), \"FraxlendPairDeployer: create2 failed\");\n\n        deployedPairsBySalt[salt] = _pairAddress;\n    }\n\n    return _pairAddress;\n}\n```\n\nA deployed Fraxlend pair address is stored in the `deployedPairsBySalt` mapping using a `salt` as the key. This salt is generated based on a seed `_saltSeed` and `_configData`. Deploying a standard Fraxlend pair with `FraxlendPairDeployer.deploy` uses `_saltSeed = keccak256(abi.encodePacked(\"public\"))` and user-defined `_configData`. The salt is the same for all standard deployments.\n\n[FraxlendPairDeployer.deploy](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L329-L330)\n\n```solidity\nfunction deploy(bytes memory _configData) external returns (address _pairAddress) {\n    (address _asset, address _collateral, , , , address _rateContract, ) = abi.decode(\n        _configData,\n        (address, address, address, address, uint256, address, bytes)\n    );\n    string memory _name = string(\n        abi.encodePacked(\n            \"FraxlendV1 - \",\n            IERC20(_collateral).safeName(),\n            \"/\",\n            IERC20(_asset).safeName(),\n            \" - \",\n            IRateCalculator(_rateContract).name(),\n            \" - \",\n            (deployedPairsArray.length + 1).toString()\n        )\n    );\n\n    _pairAddress = _deployFirst(\n        keccak256(abi.encodePacked(\"public\")),\n        _configData,\n        abi.encode(CIRCUIT_BREAKER_ADDRESS, COMPTROLLER_ADDRESS, TIME_LOCK_ADDRESS, FRAXLEND_WHITELIST_ADDRESS),\n        DEFAULT_MAX_LTV,\n        DEFAULT_LIQ_FEE,\n        0,\n        0,\n        false,\n        false\n    );\n\n    _deploySecond(_name, _pairAddress, _configData, new address[](0), new address[](0));\n\n    _logDeploy(_name, _pairAddress, _configData, DEFAULT_MAX_LTV, DEFAULT_LIQ_FEE, 0);\n}\n```\n\nA whitelisted (and potentially dishonest) user could watch the mempool for new Fraxlend pair deployments and front-run deployments with a custom pair deployment by calling `FraxlendPairDeployer.deployCustom`.\n\n[FraxlendPairDeployer.deployCustom](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L355-L388)\n\n```solidity\nfunction deployCustom(\n    string memory _name,\n    bytes memory _configData,\n    uint256 _maxLTV,\n    uint256 _liquidationFee,\n    uint256 _maturityDate,\n    uint256 _penaltyRate,\n    address[] memory _approvedBorrowers,\n    address[] memory _approvedLenders\n) external returns (address _pairAddress) {\n    require(_maxLTV <= GLOBAL_MAX_LTV, \"FraxlendPairDeployer: _maxLTV is too large\");\n    require(\n        IFraxlendWhitelist(FRAXLEND_WHITELIST_ADDRESS).fraxlendDeployerWhitelist(msg.sender),\n        \"FraxlendPairDeployer: Only whitelisted addresses\"\n    );\n\n    _pairAddress = _deployFirst(\n        keccak256(abi.encodePacked(_name)),\n        _configData,\n        abi.encode(CIRCUIT_BREAKER_ADDRESS, COMPTROLLER_ADDRESS, TIME_LOCK_ADDRESS, FRAXLEND_WHITELIST_ADDRESS),\n        _maxLTV,\n        _liquidationFee,\n        _maturityDate,\n        _penaltyRate,\n        _approvedBorrowers.length > 0,\n        _approvedLenders.length > 0\n    );\n\n    _deploySecond(_name, _pairAddress, _configData, _approvedBorrowers, _approvedLenders);\n\n    deployedPairCustomStatusByAddress[_pairAddress] = true;\n\n    _logDeploy(_name, _pairAddress, _configData, _maxLTV, _liquidationFee, _maturityDate);\n}\n```\n\nInternally the `FraxlendPairDeployer.deployCustom` uses the same `_deployFirst` function as a standard pair deployment uses. However, the salt is user-definable by using any `_name`, for instance `public`. Then the salt is the same as `_saltSeed = keccak256(abi.encodePacked(\"public\"))`. The user then uses the same `_configData` as the to be deployed pair. But, contrary to a standard pair deployment, a whitelisted user is also able to provide additional configuration, `_maxLTV`, `_liquidationFee` and so on.\n\nThe whitelisted user is able to deploy a custom Fraxlend pair with the same salt and the same `_configData` but by using for instance a `_maturityDate < block.timestamp`, this deployed custom pool is unusable (due to the modifier `isNotPastMaturity` reverting. This modifier is used by `FraxlendPairCore.deposit`, `FraxlendPairCore.mint`, `FraxlendPairCore.borrowAsset`, `FraxlendPairCore.addCollateral` and `FraxlendPairCore.leveragedPosition`).\n\nAs `FraxlendPairDeployer._deployFirst` checks if a pair is already deployed with a given salt, the honest pair deployment that got front-run reverts. It is now not possible to deploy a pair with the same configuration.\n\n**NOTE:** The same can be achieved by front-running a pair deployment transaction with a custom pair deployment and with the same name (`FraxlendPairDeployer.deployCustom` allows providing an arbitrary name . `FraxlendPairDeployer._deploySecond` checks the name of the pair and reverts if a pair with that name already exists:\n\n[FraxlendPairDeployer.\\_deploySecond](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L253)\n\n```solidity\nfunction _deploySecond(\n    string memory _name,\n    address _pairAddress,\n    bytes memory _configData,\n    address[] memory _approvedBorrowers,\n    address[] memory _approvedLenders\n) private {\n    (, , , , , , bytes memory _rateInitData) = abi.decode(\n        _configData,\n        (address, address, address, address, uint256, address, bytes)\n    );\n    require(deployedPairsByName[_name] == address(0), \"FraxlendPairDeployer: Pair name must be unique\"); // @audit-info reverts if a pair with the same name exists already\n    deployedPairsByName[_name] = _pairAddress;\n    deployedPairsArray.push(_name);\n\n    // Set additional values for FraxlendPair\n    IFraxlendPair _fraxlendPair = IFraxlendPair(_pairAddress);\n    _fraxlendPair.initialize(_name, _approvedBorrowers, _approvedLenders, _rateInitData);\n\n    // Transfer Ownership of FraxlendPair\n    _fraxlendPair.transferOwnership(COMPTROLLER_ADDRESS);\n}\n```\n\n### Recommended Mitigation Steps\n\nConsider validating the `_name` parameter in the `FraxlendPairDeployer.deployCustom` function to not equal the string `public`, thus preventing the usage of the same salt as a standard pair deployment.\n\nAdditionally, consider prefixing the name of a custom pair deployment to also prevent front-running this way.\n\n**[DrakeEvans (Frax) acknowledged](https://github.com/code-423n4/2022-08-frax-findings/issues/166)**\n\n\n\n***\n\n## [[M-12] Denial of service in globalPause by wrong logic](https://github.com/code-423n4/2022-08-frax-findings/issues/76)\n_Submitted by 0x1f8b_\n\nThe method `globalPause` is not tested and it doesn't work as expected.\n\n### Proof of Concept\n\nBecause the method returns an array (`_updatedAddresses`) and has never been initialized, when you want to set its value, it fails.\n\nRecipe:\n\n*   Call `globalPause` with any valid address.\n*   The transaction will FAULT.\n\n#### Affected source code\n\n*   [FraxlendPairDeployer.sol#L405](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L405)\n\n### Recommended Mitigation Steps\n\nInitialize the `_updatedAddresses` array like shown below:\n\n```diff\n    function globalPause(address[] memory _addresses) external returns (address[] memory _updatedAddresses) {\n        require(msg.sender == CIRCUIT_BREAKER_ADDRESS, \"Circuit Breaker only\");\n        address _pairAddress;\n        uint256 _lengthOfArray = _addresses.length;\n+       _updatedAddresses = new address[](_lengthOfArray);\n        for (uint256 i = 0; i < _lengthOfArray; ) {\n            _pairAddress = _addresses[i];\n            try IFraxlendPair(_pairAddress).pause() {\n                _updatedAddresses[i] = _addresses[i];\n            } catch {}\n            unchecked {\n                i = i + 1;\n            }\n        }\n    }\n```\n\n**[DrakeEvans (Frax) confirmed, but disagreed with severity and commented](https://github.com/code-423n4/2022-08-frax-findings/issues/76#issuecomment-1238100769):**\n > Valid, disagree with severity.  This is a convenience function.  Pause can still be called on the pairs themselves individually.  No user funds at risk, and no users can even touch this function, additionally no loss of functionality in the pairs themselves.  Only result is admin having to revert and spin up tx individually.\n\n**[gititGoro (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-08-frax-findings/issues/76#issuecomment-1266162395):**\n > Well caught! But definitely a Medium severity, given the existence of per pair pausing.\n\n\n\n***\n\n## [[M-13] No incentives to write off bad debt when remaining collateral is very small](https://github.com/code-423n4/2022-08-frax-findings/issues/38)\n_Submitted by Lambda_\n\n<https://github.com/code-423n4/2022-08-frax/blob/b58c9b72f5fe8fab81f7436504e7daf60fd124e3/src/contracts/FraxlendPairCore.sol#L989>\n\n<https://github.com/code-423n4/2022-08-frax/blob/b58c9b72f5fe8fab81f7436504e7daf60fd124e3/src/contracts/FraxlendPairCore.sol#L1002>\n\n### Impact\n\nWhen a position only has a bit of collateral left (e.g., because a previous `liquidateClean` call provided just too little shares or the exchange rate just changed), there is no incentive anymore to call `liquidateClean` again. The maximum amount that a user will get is the remaining collateral balance, which does not cover the gas fees in such cases.\n\nTherefore, the bad debt is never written off, meaning that the mechanism does not work in such cases and these pairs become toxic (as the last user will have to pay for the leftover borrow shares).\n\n### Recommended Mitigation Steps\n\nTo avoid such scenarios, it should not be possible to remove almost all of the collateral. Consider introducing an upper limit, e.g. 95%. Above this limit, no dirty liquidations would be allowed.\n\n**[DrakeEvans (Frax) acknowledged, but disagreed with severity and commented](https://github.com/code-423n4/2022-08-frax-findings/issues/38#issuecomment-1237964795):**\n > This is inherent in high gas fee environments.  There are significant incentives to avoid this with the clean liquidation fee being 11% higher than the dirty liquidation fee.  To create this scenario the liquidator would need to do a dirty liquidation first.\n\n**[gititGoro (judge) commented](https://github.com/code-423n4/2022-08-frax-findings/issues/38#issuecomment-1264718707):**\n > This sort of thing seems unavoidable when gas is present. Aave documentation refers to residual untouched balances as 'dust'. If the pair is worth recapitalizing then the gas hit will be worth it. It doesn't appear that there are problems with incentives here.\n>\n> And there isn't an obvious QA improvement.\n>\n> The mitigation adds a gas overhead for rare, mostly harmless boundary cases which does not seem to be prudent when deploying to mainnet.\n>\n> Value is technically leaked but acknowledgement from sponsor seems appropriate in this case.\n\n\n\n***\n\n\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 85 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-08-frax-findings/issues/191) by **0x1f8b** received the top score from the judge.\n\n*The following wardens also submitted reports: [pfapostol](https://github.com/code-423n4/2022-08-frax-findings/issues/143), [Rolezn](https://github.com/code-423n4/2022-08-frax-findings/issues/23), [yac](https://github.com/code-423n4/2022-08-frax-findings/issues/261), [brgltd](https://github.com/code-423n4/2022-08-frax-findings/issues/345), [Deivitto](https://github.com/code-423n4/2022-08-frax-findings/issues/329), [0xNazgul](https://github.com/code-423n4/2022-08-frax-findings/issues/211), [IllIllI](https://github.com/code-423n4/2022-08-frax-findings/issues/246), [mics](https://github.com/code-423n4/2022-08-frax-findings/issues/16), [oyc\\_109](https://github.com/code-423n4/2022-08-frax-findings/issues/8), [Bnke0x0](https://github.com/code-423n4/2022-08-frax-findings/issues/197), [reassor](https://github.com/code-423n4/2022-08-frax-findings/issues/336), [0xDjango](https://github.com/code-423n4/2022-08-frax-findings/issues/269), [MiloTruck](https://github.com/code-423n4/2022-08-frax-findings/issues/199), [bin2chen](https://github.com/code-423n4/2022-08-frax-findings/issues/134), [robee](https://github.com/code-423n4/2022-08-frax-findings/issues/63), [c3phas](https://github.com/code-423n4/2022-08-frax-findings/issues/341), [rbserver](https://github.com/code-423n4/2022-08-frax-findings/issues/360), [Junnon](https://github.com/code-423n4/2022-08-frax-findings/issues/139), [gogo](https://github.com/code-423n4/2022-08-frax-findings/issues/32), [RoiEvenHaim](https://github.com/code-423n4/2022-08-frax-findings/issues/28), [ReyAdmirado](https://github.com/code-423n4/2022-08-frax-findings/issues/70), [Waze](https://github.com/code-423n4/2022-08-frax-findings/issues/315), [tabish](https://github.com/code-423n4/2022-08-frax-findings/issues/135), [Aymen0909](https://github.com/code-423n4/2022-08-frax-findings/issues/316), [CodingNameKiki](https://github.com/code-423n4/2022-08-frax-findings/issues/60), [auditor0517](https://github.com/code-423n4/2022-08-frax-findings/issues/241), [ElKu](https://github.com/code-423n4/2022-08-frax-findings/issues/215), [beelzebufo](https://github.com/code-423n4/2022-08-frax-findings/issues/253), [kyteg](https://github.com/code-423n4/2022-08-frax-findings/issues/205), [fatherOfBlocks](https://github.com/code-423n4/2022-08-frax-findings/issues/30), [Lambda](https://github.com/code-423n4/2022-08-frax-findings/issues/53), [ballx](https://github.com/code-423n4/2022-08-frax-findings/issues/88), [LeoS](https://github.com/code-423n4/2022-08-frax-findings/issues/106), [berndartmueller](https://github.com/code-423n4/2022-08-frax-findings/issues/157), [erictee](https://github.com/code-423n4/2022-08-frax-findings/issues/6), [ret2basic](https://github.com/code-423n4/2022-08-frax-findings/issues/125), [TomJ](https://github.com/code-423n4/2022-08-frax-findings/issues/337), [0x52](https://github.com/code-423n4/2022-08-frax-findings/issues/80), [ayeslick](https://github.com/code-423n4/2022-08-frax-findings/issues/152), [cccz](https://github.com/code-423n4/2022-08-frax-findings/issues/196), [yash90](https://github.com/code-423n4/2022-08-frax-findings/issues/107), [Funen](https://github.com/code-423n4/2022-08-frax-findings/issues/312), [0xA5DF](https://github.com/code-423n4/2022-08-frax-findings/issues/220), [JC](https://github.com/code-423n4/2022-08-frax-findings/issues/358), [Dravee](https://github.com/code-423n4/2022-08-frax-findings/issues/186), [medikko](https://github.com/code-423n4/2022-08-frax-findings/issues/364), [cryptonue](https://github.com/code-423n4/2022-08-frax-findings/issues/231), [cryptphi](https://github.com/code-423n4/2022-08-frax-findings/issues/265), [delfin454000](https://github.com/code-423n4/2022-08-frax-findings/issues/222), [sach1r0](https://github.com/code-423n4/2022-08-frax-findings/issues/214), [simon135](https://github.com/code-423n4/2022-08-frax-findings/issues/174), [Sm4rty](https://github.com/code-423n4/2022-08-frax-findings/issues/306), [sryysryy](https://github.com/code-423n4/2022-08-frax-findings/issues/101), [durianSausage](https://github.com/code-423n4/2022-08-frax-findings/issues/55), [dy](https://github.com/code-423n4/2022-08-frax-findings/issues/217), [minhquanym](https://github.com/code-423n4/2022-08-frax-findings/issues/276), [Rohan16](https://github.com/code-423n4/2022-08-frax-findings/issues/310), [zzzitron](https://github.com/code-423n4/2022-08-frax-findings/issues/193), [a12jmx](https://github.com/code-423n4/2022-08-frax-findings/issues/359), [hyh](https://github.com/code-423n4/2022-08-frax-findings/issues/362), [ak1](https://github.com/code-423n4/2022-08-frax-findings/issues/281), [asutorufos](https://github.com/code-423n4/2022-08-frax-findings/issues/338), [CertoraInc](https://github.com/code-423n4/2022-08-frax-findings/issues/188), [Chom](https://github.com/code-423n4/2022-08-frax-findings/issues/263), [0xsolstars](https://github.com/code-423n4/2022-08-frax-findings/issues/351), [\\_\\_141345\\_\\_](https://github.com/code-423n4/2022-08-frax-findings/issues/181), [0xSmartContract](https://github.com/code-423n4/2022-08-frax-findings/issues/314), [djxploit](https://github.com/code-423n4/2022-08-frax-findings/issues/95), [SooYa](https://github.com/code-423n4/2022-08-frax-findings/issues/348), [\\_Adam](https://github.com/code-423n4/2022-08-frax-findings/issues/155), [0xmatt](https://github.com/code-423n4/2022-08-frax-findings/issues/218), [cRat1st0s](https://github.com/code-423n4/2022-08-frax-findings/issues/72), [The\\_GUILD](https://github.com/code-423n4/2022-08-frax-findings/issues/356), [Yiko](https://github.com/code-423n4/2022-08-frax-findings/issues/103), [EthLedger](https://github.com/code-423n4/2022-08-frax-findings/issues/346), [gzeon](https://github.com/code-423n4/2022-08-frax-findings/issues/275), [ignacio](https://github.com/code-423n4/2022-08-frax-findings/issues/3), [Noah3o6](https://github.com/code-423n4/2022-08-frax-findings/issues/97), [0xNineDec](https://github.com/code-423n4/2022-08-frax-findings/issues/357), [d3e4](https://github.com/code-423n4/2022-08-frax-findings/issues/343), [dipp](https://github.com/code-423n4/2022-08-frax-findings/issues/308), [ladboy233](https://github.com/code-423n4/2022-08-frax-findings/issues/163), [PaludoX0](https://github.com/code-423n4/2022-08-frax-findings/issues/195), and [SaharAP](https://github.com/code-423n4/2022-08-frax-findings/issues/123).*\n\n## Low Risk Issues\n\n## [L-01] Outdated compiler\n\nThe pragma version used is:\n\n```\npragma solidity ^0.8.15;\n```\n\nThe minimum required version must be [0.8.16](https://github.com/ethereum/solidity/releases/tag/v0.8.16); otherwise, contracts will be affected by the following **important bug fixes**:\n\n[0.8.16](https://blog.soliditylang.org/2022/08/08/solidity-0.8.16-release-announcement/)\n\n- Code Generation: Fix data corruption that affected ABI-encoding of calldata values represented by tuples: structs at any nesting level; argument lists of external functions, events and errors; return value lists of external functions. The 32 leading bytes of the first dynamically-encoded value in the tuple would get zeroed when the last component contained a statically-encoded array.\n\nApart from these, there are several minor bug fixes and improvements.\n\n## [L-02] `SafeERC20` mismatch logics\n\nThe `SafeERC20` library says:\n\n> @title SafeERC20 provides helper functions for safe transfers as well as safe metadata access\n\nBut the reality is that *metada access* is not secure.\n\nThe `SafeERC20.safeTransfer` and `SafeERC20.safeTransferFrom` methods perform a safe check that the address to call is a contract by calling [functionCall](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/2dc086563f2e51620ebc43d2237fc10ef201c4e6/contracts/token/ERC20/utils/SafeERC20.sol#L110), this checks doesn't appear in the methods `safeSymbol`, `safeName` and `safeDecimals`, so some of the `SafeERC20` library methods are prone to [phantom methods](https://media.dedaub.com/phantom-functions-and-the-billion-dollar-no-op-c56f062ae49f) attacks.\n\n### Proof of Concept\n\nIf you try to call the `SafeERC20` methods with the following token `0x000000000000000000000000000000000000000000000` (or any EOA) you can see that the transaction is successful, you have to check that the address is a valid contract and maybe check that the call returns a certain data. Otherwise it is possible to call it and lose tokens or produce undesired errors.\n\nThis reminds me of this attack https://certik.medium.com/qubit-bridge-collapse-exploited-to-the-tune-of-80-million-a7ab9068e1a0 where we can see:\n\n**Affected source code:**\n\n- [SafeERC20.sol#L39-L58](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/libraries/SafeERC20.sol#L39-L58)\n\n### Recommended changes\n\n- Use `functionStaticCall` from OpenZeppelin.\n\n```diff\n+import \"@openzeppelin/contracts/utils/Address.sol\";\n...\nlibrary SafeERC20 {\n+    using Address for address;\n\n    /// @notice Provides a safe ERC20.symbol version which returns '???' as fallback string.\n    /// @param token The address of the ERC-20 token contract.\n    /// @return (string) Token symbol.\n    function safeSymbol(IERC20 token) internal view returns (string memory) {\n-       (bool success, bytes memory data) = address(token).staticcall(abi.encodeWithSelector(SIG_SYMBOL));\n+       (bool success, bytes memory data) = address(token).functionStaticCall(abi.encodeWithSelector(SIG_SYMBOL));\n        return success ? returnDataToString(data) : \"???\";\n    }\n\n    /// @notice Provides a safe ERC20.name version which returns '???' as fallback string.\n    /// @param token The address of the ERC-20 token contract.\n    /// @return (string) Token name.\n    function safeName(IERC20 token) internal view returns (string memory) {\n-       (bool success, bytes memory data) = address(token).staticcall(abi.encodeWithSelector(SIG_NAME));\n+       (bool success, bytes memory data) = address(token).functionStaticCall(abi.encodeWithSelector(SIG_NAME));\n        return success ? returnDataToString(data) : \"???\";\n    }\n\n    /// @notice Provides a safe ERC20.decimals version which returns '18' as fallback value.\n    /// @param token The address of the ERC-20 token contract.\n    /// @return (uint8) Token decimals.\n    function safeDecimals(IERC20 token) internal view returns (uint8) {\n-       (bool success, bytes memory data) = address(token).staticcall(abi.encodeWithSelector(SIG_DECIMALS));\n+       (bool success, bytes memory data) = address(token).functionStaticCall(abi.encodeWithSelector(SIG_DECIMALS));\n        return success && data.length == 32 ? abi.decode(data, (uint8)) : 18;\n    }\n```\n\n## [L-03] Lack of ACK during owner change\n\nIt's possible to lose the ownership under specific circumstances.\n\nBecause of human error it's possible to set a new invalid owner. When you want to change the owner's address it's better to propose a new owner, and then accept this ownership with the new wallet.\n\n**Affected source code:**\n\n- [FraxlendWhitelist.sol#L30](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L30)\n- [FraxlendPairDeployer.sol#L44](https://github.com/code-423n4/2022-08-frax/blob/main/src/contracts/FraxlendPairDeployer.sol#L44)\n\n\n## [L-04] Constant salt\n\nIt's not possible to use `public` as pair name, if you are using the same default values as was used in `deploy`.\n\nBecuase the salt for deploy is *\"public\"*, it is not possible to use the same as a name.\n\n**Affected source code:**\n\n- [FraxlendPairDeployer.sol#L329](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L329)\n- [FraxlendPairDeployer.sol#L372](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L372)\n\n### Recommended changes\n\n```diff\n-   keccak256(abi.encodePacked(_name)),\n+   keccak256(abi.encodePacked(\"custom\", _name)),\n```\n\n## [L-05] Bypass `TimeLock` restrictions\n\nEsto permite que llamadas como la que se muestran a continuacion, que se encuentran limitadas al contrato de `TIME_LOCK_ADDRESS`, sea posible ser llamadas por el owner, evitando cualquier limitación de tiempo, debido a que en primer lugar no se comprueba que la direccion establecida en `setTimeLock` sea un contrato, y segundo, porque podria establecer cualquier contrato, y en la misma llamada hacer la llamada limitada al `TimeLock`.\n\nThe `FraxlendPair` contract has a `setTimeLock` method that allows you to modify the `TimeLock` contract (`TIME_LOCK_ADDRESS`), this call is protected by the `onlyOwner` modifier.\n\nThis allows the owner to call methods like the one shown below (`changeFee`), which are limited to the `TIME_LOCK_ADDRESS` contract, avoiding any time constraints, since the established address in `setTimeLock` is not checked to be a contract, you could set any contract, and in the same transaction you can call the protected method.\n\n```javascript\n    function changeFee(uint32 _newFee) external whenNotPaused {\n        if (msg.sender != TIME_LOCK_ADDRESS) revert OnlyTimeLock();\n```\n\nThis can facilitate rogue pool attacks.\n\n**Affected source code:**\n\n- [FraxlendPair.sol#L204-L222](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L204-L222)\n\n## [L-06] Division before multiple can lead to precision errors\n\nBecause Solidity integer division may truncate, it is often preferable to do multiplication before division to prevent precision loss.\n\n**Affected source code:**\n\n- [FraxlendPairCore.sol#L315](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L315)\n\n### Recommended changes\n\n```diff\n    uint256 internal constant LTV_PRECISION = 1e5; // 5 decimals\n    uint256 internal constant EXCHANGE_PRECISION = 1e18;\n    ...\n+   uint256 internal constant SOLVENT_PRECISION = EXCHANGE_PRECISION / LTV_PRECISION; // 1e13\n    ...\n\n    function _isSolvent(address _borrower, uint256 _exchangeRate) internal view returns (bool) {\n        if (maxLTV == 0) return true;\n        uint256 _borrowerAmount = totalBorrow.toAmount(userBorrowShares[_borrower], true);\n        if (_borrowerAmount == 0) return true;\n        uint256 _collateralAmount = userCollateralBalance[_borrower];\n        if (_collateralAmount == 0) return false;\n\n-       uint256 _ltv = (((_borrowerAmount * _exchangeRate) / EXCHANGE_PRECISION) * LTV_PRECISION) / _collateralAmount;\n+       uint256 _ltv = (_borrowerAmount * _exchangeRate) / (_collateralAmount * SOLVENT_PRECISION);\n        return _ltv <= maxLTV;\n    }\n```\n\n## [L-07] `Ownable` and `Pausable`\n\nThe contract `FraxlendPairCore` is `Ownable` and `Pausable`, so the owner could resign while the contract is paused, causing a Denial of Service. Owner resignation while the contract is paused should be avoided.\n\n**Affected source code:**\n\n- [FraxlendPairCore.sol#L46](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L46)\n\n----\n\n## Non-Critical Issues\n\n## [N-01] Use `encode` instead of `encodePacked` for hashig\n\nUse of `abi.encodePacked` is safe, but unnecessary and not recommended. `abi.encodePacked` can result in hash collisions when used with two dynamic arguments (string/bytes).\n\nThere is also discussion of removing `abi.encodePacked` from future versions of Solidity ([ethereum/solidity#11593](https://github.com/ethereum/solidity/issues/11593)), so using `abi.encode` now will ensure compatibility in the future.\n\n**Affected source code:**\n\n- [FraxlendPairDeployer.sol#L204](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L204)\n\n## [N-02] Wrong comment of `toBorrowAmount` function\n\nThe function `toBorrowAmount` is wrongly commented.\n\n**Affected source code:**\n\n- [FraxlendPair.sol#L187-L190](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L187-L190)\n\n### Recommended changes\n\n```diff\n-   /// @notice The ```toBorrtoBorrowAmountowShares``` function converts a given amount of borrow debt into the number of shares\n+   /// @notice The ```toBorrowAmount``` function converts a given number of shares into the amount of borrow debt\n    /// @param _shares Shares of borrow\n    /// @param _roundUp Whether to roundup during division\n    function toBorrowAmount(uint256 _shares, bool _roundUp) external view returns (uint256) {\n        return totalBorrow.toAmount(_shares, _roundUp);\n    }\n```\n\n## [N-03] Confusing variables as to how they are stored\n\nThe `FraxlendPairCore` contract constructor takes two arguments, `_configData` and `_immutables`, however, there are immutables in `_configData` and variables in `_immutables`.\n\nThis may seem confusing, since for example one expects the `TIME_LOCK_ADDRESS` to be immutable as it is defined in the `_immutables` variable, however it is possible to change it with [setTimeLock](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L204).\n\n**Affected source code:**\n\n- [FraxlendPairCore.sol#L174](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L174)\n- [FraxlendPairCore.sol#L190-L191](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L190-L191)\n- [FraxlendPairCore.sol#L193-L197](https://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L193-L197)\n\n\n**[gititGoro (judge) commented](https://github.com/code-423n4/2022-08-frax-findings/issues/191#issuecomment-1269063966):**\n > Very good report quality!\n> There were some invalid points:\n> - L-02. Misconfigured or misbehaving tokens are out of scope\n> - L-06. The precision cap is intentional. This issue was reported as a Medium risk bug by another warden and marked invalid.\n> - L-07. Owners resigning seems beyond the scope of the audit. FraxLend will be managed by a DAO like other Frax products. Even without explicit documentation, for a Frax product, this should be the assumed default. This is if you were unable to contact the sponsor and verify explicitly that a human controlled EOA would be the owner, a very uncommon circumstance for a large mainnet dapp.\n\n\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 94 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-08-frax-findings/issues/245) by **IllIllI** received the top score from the judge.\n\n*The following wardens also submitted reports: [JC](https://github.com/code-423n4/2022-08-frax-findings/issues/355), [Deivitto](https://github.com/code-423n4/2022-08-frax-findings/issues/328), [0xSmartContract](https://github.com/code-423n4/2022-08-frax-findings/issues/149), [ajtra](https://github.com/code-423n4/2022-08-frax-findings/issues/320), [0x1f8b](https://github.com/code-423n4/2022-08-frax-findings/issues/190), [c3phas](https://github.com/code-423n4/2022-08-frax-findings/issues/350), [oyc\\_109](https://github.com/code-423n4/2022-08-frax-findings/issues/7), [ret2basic](https://github.com/code-423n4/2022-08-frax-findings/issues/121), [\\_\\_141345\\_\\_](https://github.com/code-423n4/2022-08-frax-findings/issues/180), [Bnke0x0](https://github.com/code-423n4/2022-08-frax-findings/issues/104), [Chinmay](https://github.com/code-423n4/2022-08-frax-findings/issues/173), [MiloTruck](https://github.com/code-423n4/2022-08-frax-findings/issues/198), [Dravee](https://github.com/code-423n4/2022-08-frax-findings/issues/116), [0xkatana](https://github.com/code-423n4/2022-08-frax-findings/issues/13), [ReyAdmirado](https://github.com/code-423n4/2022-08-frax-findings/issues/69), [gogo](https://github.com/code-423n4/2022-08-frax-findings/issues/31), [Rolezn](https://github.com/code-423n4/2022-08-frax-findings/issues/24), [Tomio](https://github.com/code-423n4/2022-08-frax-findings/issues/226), [erictee](https://github.com/code-423n4/2022-08-frax-findings/issues/5), [Waze](https://github.com/code-423n4/2022-08-frax-findings/issues/304), [pfapostol](https://github.com/code-423n4/2022-08-frax-findings/issues/133), [Aymen0909](https://github.com/code-423n4/2022-08-frax-findings/issues/289), [Rohan16](https://github.com/code-423n4/2022-08-frax-findings/issues/301), [durianSausage](https://github.com/code-423n4/2022-08-frax-findings/issues/54), [\\_Adam](https://github.com/code-423n4/2022-08-frax-findings/issues/130), [TomJ](https://github.com/code-423n4/2022-08-frax-findings/issues/319), [ignacio](https://github.com/code-423n4/2022-08-frax-findings/issues/2), [0xDjango](https://github.com/code-423n4/2022-08-frax-findings/issues/268), [m\\_Rassska](https://github.com/code-423n4/2022-08-frax-findings/issues/324), [medikko](https://github.com/code-423n4/2022-08-frax-findings/issues/344), [Noah3o6](https://github.com/code-423n4/2022-08-frax-findings/issues/96), [rbserver](https://github.com/code-423n4/2022-08-frax-findings/issues/332), [robee](https://github.com/code-423n4/2022-08-frax-findings/issues/62), [simon135](https://github.com/code-423n4/2022-08-frax-findings/issues/170), [LeoS](https://github.com/code-423n4/2022-08-frax-findings/issues/232), [Sm4rty](https://github.com/code-423n4/2022-08-frax-findings/issues/299), [brgltd](https://github.com/code-423n4/2022-08-frax-findings/issues/352), [0xA5DF](https://github.com/code-423n4/2022-08-frax-findings/issues/219), [reassor](https://github.com/code-423n4/2022-08-frax-findings/issues/335), [saian](https://github.com/code-423n4/2022-08-frax-findings/issues/297), [0xNazgul](https://github.com/code-423n4/2022-08-frax-findings/issues/210), [mics](https://github.com/code-423n4/2022-08-frax-findings/issues/17), [kyteg](https://github.com/code-423n4/2022-08-frax-findings/issues/202), [NoamYakov](https://github.com/code-423n4/2022-08-frax-findings/issues/302), [flyx](https://github.com/code-423n4/2022-08-frax-findings/issues/144), [SaharAP](https://github.com/code-423n4/2022-08-frax-findings/issues/122), [Amithuddar](https://github.com/code-423n4/2022-08-frax-findings/issues/309), [fatherOfBlocks](https://github.com/code-423n4/2022-08-frax-findings/issues/29), [Fitraldys](https://github.com/code-423n4/2022-08-frax-findings/issues/323), [ballx](https://github.com/code-423n4/2022-08-frax-findings/issues/87), [gerdusx](https://github.com/code-423n4/2022-08-frax-findings/issues/178), [Junnon](https://github.com/code-423n4/2022-08-frax-findings/issues/138), [Metatron](https://github.com/code-423n4/2022-08-frax-findings/issues/326), [2997ms](https://github.com/code-423n4/2022-08-frax-findings/issues/58), [carlitox477](https://github.com/code-423n4/2022-08-frax-findings/issues/128), [cRat1st0s](https://github.com/code-423n4/2022-08-frax-findings/issues/71), [delfin454000](https://github.com/code-423n4/2022-08-frax-findings/issues/216), [newfork01](https://github.com/code-423n4/2022-08-frax-findings/issues/68), [SooYa](https://github.com/code-423n4/2022-08-frax-findings/issues/300), [sryysryy](https://github.com/code-423n4/2022-08-frax-findings/issues/100), [chrisdior4](https://github.com/code-423n4/2022-08-frax-findings/issues/59), [CodingNameKiki](https://github.com/code-423n4/2022-08-frax-findings/issues/61), [Funen](https://github.com/code-423n4/2022-08-frax-findings/issues/313), [0xackermann](https://github.com/code-423n4/2022-08-frax-findings/issues/255), [ak1](https://github.com/code-423n4/2022-08-frax-findings/issues/272), [asutorufos](https://github.com/code-423n4/2022-08-frax-findings/issues/321), [d3e4](https://github.com/code-423n4/2022-08-frax-findings/issues/342), [djxploit](https://github.com/code-423n4/2022-08-frax-findings/issues/94), [gzeon](https://github.com/code-423n4/2022-08-frax-findings/issues/271), [jag](https://github.com/code-423n4/2022-08-frax-findings/issues/131), [mrpathfindr](https://github.com/code-423n4/2022-08-frax-findings/issues/137), [Ruhum](https://github.com/code-423n4/2022-08-frax-findings/issues/91), [sach1r0](https://github.com/code-423n4/2022-08-frax-findings/issues/213), [ElKu](https://github.com/code-423n4/2022-08-frax-findings/issues/208), [Diraco](https://github.com/code-423n4/2022-08-frax-findings/issues/26), [Randyyy](https://github.com/code-423n4/2022-08-frax-findings/issues/260), [Yiko](https://github.com/code-423n4/2022-08-frax-findings/issues/105), [a12jmx](https://github.com/code-423n4/2022-08-frax-findings/issues/363), [zeesaw](https://github.com/code-423n4/2022-08-frax-findings/issues/74), [0xc0ffEE](https://github.com/code-423n4/2022-08-frax-findings/issues/262), [Chom](https://github.com/code-423n4/2022-08-frax-findings/issues/267), [EthLedger](https://github.com/code-423n4/2022-08-frax-findings/issues/347), [IgnacioB](https://github.com/code-423n4/2022-08-frax-findings/issues/27), [Lambda](https://github.com/code-423n4/2022-08-frax-findings/issues/34), [dharma09](https://github.com/code-423n4/2022-08-frax-findings/issues/67), [hakerbaya](https://github.com/code-423n4/2022-08-frax-findings/issues/66), [ladboy233](https://github.com/code-423n4/2022-08-frax-findings/issues/160), [nxrblsrpr](https://github.com/code-423n4/2022-08-frax-findings/issues/124), [PaludoX0](https://github.com/code-423n4/2022-08-frax-findings/issues/194), [0xbepresent](https://github.com/code-423n4/2022-08-frax-findings/issues/114), [find\\_a\\_bug](https://github.com/code-423n4/2022-08-frax-findings/issues/25), [francoHacker](https://github.com/code-423n4/2022-08-frax-findings/issues/127), and [ltyu](https://github.com/code-423n4/2022-08-frax-findings/issues/113).*\n\n## Summary\n\n| |Issue|Instances|\n|-|:-|:-:|\n| [G&#x2011;01] | String should only be generated once, and saved | 1 |\n| [G&#x2011;02] | Remove or replace unused state variables | 1 |\n| [G&#x2011;03] | Multiple `address`/ID mappings can be combined into a single `mapping` of an `address`/ID to a `struct`, where appropriate | 1 |\n| [G&#x2011;04] | Using `calldata` instead of `memory` for read-only arguments in `external` functions saves gas | 11 |\n| [G&#x2011;05] | Using `storage` instead of `memory` for structs/arrays saves gas | 16 |\n| [G&#x2011;06] | State variables should be cached in stack variables rather than re-reading them from storage | 2 |\n| [G&#x2011;07] | `<x> += <y>` costs more gas than `<x> = <x> + <y>` for state variables | 2 |\n| [G&#x2011;08] | Add `unchecked {}` for subtractions where the operands cannot underflow because of a previous `require()` or `if`-statement | 3 |\n| [G&#x2011;09] | `<array>.length` should not be looked up in every loop of a `for`-loop | 7 |\n| [G&#x2011;10] | `++i`/`i++` should be `unchecked{++i}`/`unchecked{i++}` when it is not possible for them to overflow, as is the case when used in `for`- and `while`-loops | 8 |\n| [G&#x2011;11] | `require()`/`revert()` strings longer than 32 bytes cost extra gas | 8 |\n| [G&#x2011;12] | Optimize names to save gas | 6 |\n| [G&#x2011;13] | Using `bool`s for storage incurs overhead | 9 |\n| [G&#x2011;14] | `++i` costs less gas than `i++`, especially when it's used in `for`-loops (`--i`/`i--` too) | 9 |\n| [G&#x2011;15] | Splitting `require()` statements that use `&&` saves gas | 3 |\n| [G&#x2011;16] | Usage of `uints`/`ints` smaller than 32 bytes (256 bits) incurs overhead | 13 |\n| [G&#x2011;17] | Using `private` rather than `public` for constants, saves gas | 8 |\n| [G&#x2011;18] | Use custom errors rather than `revert()`/`require()` strings to save gas | 9 |\n| [G&#x2011;19] | Functions guaranteed to revert when called by normal users can be marked `payable` | 7 |\n\nTotal: 124 instances over 19 issues\n\n## [G&#x2011;01]  String should only be generated once, and saved\n\n*There is 1 instance of this issue:*\n```solidity\nFile: /src/contracts/FraxlendPair.sol\n\n81:          return string(abi.encodePacked(\"FraxlendV1 - \", collateralContract.safeSymbol(), \"/\", assetContract.safeSymbol()));\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L81\n\n## [G&#x2011;02]  Remove or replace unused state variables\nSaves a storage slot. If the variable is assigned a non-zero value, saves Gsset (**20000 gas**). If it's assigned a zero value, saves Gsreset (**2900 gas**). If the variable remains unassigned, there is no gas savings unless the variable is `public`, in which case the compiler-generated non-payable getter deployment cost is saved. If the state variable is overriding an interface's public function, mark the variable as `constant` or `immutable` so that it does not use a storage slot\n\n*There is 1 instance of this issue:*\n```solidity\nFile: src/contracts/FraxlendPairCore.sol\n\n51:       string public version = \"1.0.0\";\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L51\n\n## [G&#x2011;03]  Multiple `address`/ID mappings can be combined into a single `mapping` of an `address`/ID to a `struct`, where appropriate\nSaves a storage slot for the mapping. Depending on the circumstances and sizes of types, can avoid a Gsset (**20000 gas**) per mapping combined. Reads and subsequent writes can also be cheaper when a function requires both values and they both fit in the same storage slot. Finally, if both fields are accessed in the same function, can save **~42 gas per access** due to [not having to recalculate the key's keccak256 hash](https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0) (Gkeccak256 - 30 gas) and that calculation's associated stack operations.\n\n*There is 1 instance of this issue:*\n```solidity\nFile: src/contracts/FraxlendPairCore.sol\n\n127       mapping(address => uint256) public userCollateralBalance; // amount of collateral each user is backed\n128       /// @notice Stores the balance of borrow shares for each user\n129:      mapping(address => uint256) public userBorrowShares; // represents the shares held by individuals\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L127-L129\n\n## [G&#x2011;04]  Using `calldata` instead of `memory` for read-only arguments in `external` functions saves gas\nWhen a function with a `memory` array is called externally, the `abi.decode()` step has to use a for-loop to copy each index of the `calldata` to the `memory` index. **Each iteration of this for-loop costs at least 60 gas** (i.e. `60 * <mem_array>.length`). Using `calldata` directly, obliviates the need for such a loop in the contract code and runtime execution. Note that even if an interface defines a function as having `memory` arguments, it's still valid for implementation contracs to use `calldata` arguments instead.\n\nIf the array is passed to an `internal` function which passes the array to another internal function where the array is modified and therefore `memory` is used in the `external` call, it's still more gass-efficient to use `calldata` when the `external` function uses modifiers, since the modifiers may prevent the internal functions from being called. Structs have the same overhead as an array of length one\n\nNote that I've also flagged instances where the function is `public` but can be marked as `external` since it's not called by the contract, and cases where a constructor is involved\n\n*There are 11 instances of this issue:*\n```solidity\nFile: src/contracts/FraxlendPairCore.sol\n\n/// @audit _configData\n/// @audit _immutables\n151       constructor(\n152           bytes memory _configData,\n153           bytes memory _immutables,\n154           uint256 _maxLTV,\n155           uint256 _liquidationFee,\n156           uint256 _maturityDate,\n157           uint256 _penaltyRate,\n158           bool _isBorrowerWhitelistActive,\n159:          bool _isLenderWhitelistActive\n\n/// @audit _path\n1062      function leveragedPosition(\n1063          address _swapperAddress,\n1064          uint256 _borrowAmount,\n1065          uint256 _initialCollateralAmount,\n1066          uint256 _amountCollateralOutMin,\n1067          address[] memory _path\n1068      )\n1069          external\n1070          isNotPastMaturity\n1071          nonReentrant\n1072          whenNotPaused\n1073          approvedBorrower\n1074          isSolvent(msg.sender)\n1075:         returns (uint256 _totalCollateralBalance)\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L151-L159\n\n```solidity\nFile: src/contracts/FraxlendPairDeployer.sol\n\n/// @audit _configData\n310:      function deploy(bytes memory _configData) external returns (address _pairAddress) {\n\n/// @audit _name\n/// @audit _configData\n/// @audit _approvedBorrowers\n/// @audit _approvedLenders\n355       function deployCustom(\n356           string memory _name,\n357           bytes memory _configData,\n358           uint256 _maxLTV,\n359           uint256 _liquidationFee,\n360           uint256 _maturityDate,\n361           uint256 _penaltyRate,\n362           address[] memory _approvedBorrowers,\n363           address[] memory _approvedLenders\n364:      ) external returns (address _pairAddress) {\n\n/// @audit _addresses\n398:      function globalPause(address[] memory _addresses) external returns (address[] memory _updatedAddresses) {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L310\n\n```solidity\nFile: src/contracts/FraxlendPair.sol\n\n/// @audit _configData\n/// @audit _immutables\n45        constructor(\n46            bytes memory _configData,\n47            bytes memory _immutables,\n48            uint256 _maxLTV,\n49            uint256 _liquidationFee,\n50            uint256 _maturityDate,\n51            uint256 _penaltyRate,\n52            bool _isBorrowerWhitelistActive,\n53            bool _isLenderWhitelistActive\n54        )\n55            FraxlendPairCore(\n56                _configData,\n57                _immutables,\n58                _maxLTV,\n59                _liquidationFee,\n60                _maturityDate,\n61                _penaltyRate,\n62                _isBorrowerWhitelistActive,\n63                _isLenderWhitelistActive\n64            )\n65            ERC20(\"\", \"\")\n66            Ownable()\n67:           Pausable()\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L45-L67\n\n## [G&#x2011;05]  Using `storage` instead of `memory` for structs/arrays saves gas\nWhen fetching data from a storage location, assigning the data to a `memory` variable causes all fields of the struct/array to be read from storage, which incurs a Gcoldsload (**2100 gas**) for *each* field of the struct/array. If the fields are read from the new memory variable, they incur an additional `MLOAD` rather than a cheap stack read. Instead of declearing the variable with the `memory` keyword, declaring the variable with the `storage` keyword and caching any fields that need to be re-read in stack variables, will be much cheaper, only incuring the Gcoldsload for the fields actually read. The only time it makes sense to read the whole struct/array into a `memory` variable, is if the full struct/array is being returned by the function, is being passed to a function that requires `memory`, or if the array/struct is being read from another `memory` array/struct\n\n*There are 16 instances of this issue:*\n```solidity\nFile: src/contracts/FraxlendPairCore.sol\n\n419:          CurrentRateInfo memory _currentRateInfo = currentRateInfo;\n\n426:          VaultAccount memory _totalAsset = totalAsset;\n\n427:          VaultAccount memory _totalBorrow = totalBorrow;\n\n517:          ExchangeRateInfo memory _exchangeRateInfo = exchangeRateInfo;\n\n592:          VaultAccount memory _totalAsset = totalAsset;\n\n611:          VaultAccount memory _totalAsset = totalAsset;\n\n666:          VaultAccount memory _totalAsset = totalAsset;\n\n682:          VaultAccount memory _totalAsset = totalAsset;\n\n708:          VaultAccount memory _totalBorrow = totalBorrow;\n\n884:          VaultAccount memory _totalBorrow = totalBorrow;\n\n926:          VaultAccount memory _totalBorrow = totalBorrow;\n\n965:          VaultAccount memory _totalBorrow = totalBorrow;\n\n1204:         VaultAccount memory _totalBorrow = totalBorrow;\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L419\n\n```solidity\nFile: src/contracts/FraxlendPairDeployer.sol\n\n123:          string[] memory _deployedPairsArray = deployedPairsArray;\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L123\n\n```solidity\nFile: src/contracts/FraxlendPair.sol\n\n236:          VaultAccount memory _totalAsset = totalAsset;\n\n237:          VaultAccount memory _totalBorrow = totalBorrow;\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L236\n\n## [G&#x2011;06]  State variables should be cached in stack variables rather than re-reading them from storage\nThe instances below point to the second+ access of a state variable within a function. Caching of a state variable replace each Gwarmaccess (**100 gas**) with a much cheaper stack read. Other less obvious fixes/optimizations include having local memory caches of state variable structs, or having local caches of state variable contracts/addresses.\n\n*There are 2 instances of this issue:*\n```solidity\nFile: src/contracts/FraxlendPairDeployer.sol\n\n/// @audit DEFAULT_MAX_LTV on line 332\n/// @audit DEFAULT_LIQ_FEE on line 333\n342:          _logDeploy(_name, _pairAddress, _configData, DEFAULT_MAX_LTV, DEFAULT_LIQ_FEE, 0);\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L342\n\n## [G&#x2011;07]  `<x> += <y>` costs more gas than `<x> = <x> + <y>` for state variables\nUsing the addition operator instead of plus-equals saves **[113 gas](https://gist.github.com/IllIllI000/cbbfb267425b898e5be734d4008d4fe8)**\n\n*There are 2 instances of this issue:*\n```solidity\nFile: src/contracts/FraxlendPairCore.sol\n\n773:          totalCollateral += _collateralAmount;\n\n815:          totalCollateral -= _collateralAmount;\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L773\n\n## [G&#x2011;08]  Add `unchecked {}` for subtractions where the operands cannot underflow because of a previous `require()` or `if`-statement\n`require(a <= b); x = b - a` => `require(a <= b); unchecked { x = b - a }`\n\n*There are 3 instances of this issue:*\n```solidity\nFile: src/contracts/LinearInterestRate.sol\n\n/// @audit if-condition on line 86\n88:               _newRatePerSec = uint64(_vertexInterest + (((_utilization - _vertexUtilization) * _slope) / UTIL_PREC));\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L88\n\n```solidity\nFile: src/contracts/VariableInterestRate.sol\n\n/// @audit if-condition on line 68\n69:               uint256 _deltaUtilization = ((MIN_UTIL - _utilization) * 1e18) / MIN_UTIL;\n\n/// @audit if-condition on line 75\n76:               uint256 _deltaUtilization = ((_utilization - MAX_UTIL) * 1e18) / (UTIL_PREC - MAX_UTIL);\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/VariableInterestRate.sol#L69\n\n## [G&#x2011;09]  `<array>.length` should not be looked up in every loop of a `for`-loop\nThe overheads outlined below are _PER LOOP_, excluding the first loop\n* storage arrays incur a Gwarmaccess (**100 gas**)\n* memory arrays use `MLOAD` (**3 gas**)\n* calldata arrays use `CALLDATALOAD` (**3 gas**)\n\nCaching the length changes each of these to a `DUP<N>` (**3 gas**), and gets rid of the extra `DUP<N>` needed to store the stack offset\n\n*There are 7 instances of this issue:*\n```solidity\nFile: src/contracts/FraxlendPairCore.sol\n\n265:          for (uint256 i = 0; i < _approvedBorrowers.length; ++i) {\n\n270:          for (uint256 i = 0; i < _approvedLenders.length; ++i) {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L265\n\n```solidity\nFile: src/contracts/FraxlendPair.sol\n\n289:          for (uint256 i = 0; i < _lenders.length; i++) {\n\n308:          for (uint256 i = 0; i < _borrowers.length; i++) {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L289\n\n```solidity\nFile: src/contracts/FraxlendWhitelist.sol\n\n51:           for (uint256 i = 0; i < _addresses.length; i++) {\n\n66:           for (uint256 i = 0; i < _addresses.length; i++) {\n\n81:           for (uint256 i = 0; i < _addresses.length; i++) {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L51\n\n## [G&#x2011;10]  `++i`/`i++` should be `unchecked{++i}`/`unchecked{i++}` when it is not possible for them to overflow, as is the case when used in `for`- and `while`-loops\nThe `unchecked` keyword is new in solidity version 0.8.0, so this only applies to that version or higher, which these instances are. This saves **30-40 gas [per loop](https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#the-increment-in-for-loop-post-condition-can-be-made-unchecked)**\n\n*There are 8 instances of this issue:*\n```solidity\nFile: src/contracts/FraxlendPairCore.sol\n\n265:          for (uint256 i = 0; i < _approvedBorrowers.length; ++i) {\n\n270:          for (uint256 i = 0; i < _approvedLenders.length; ++i) {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L265\n\n```solidity\nFile: src/contracts/FraxlendPair.sol\n\n289:          for (uint256 i = 0; i < _lenders.length; i++) {\n\n308:          for (uint256 i = 0; i < _borrowers.length; i++) {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L289\n\n```solidity\nFile: src/contracts/FraxlendWhitelist.sol\n\n51:           for (uint256 i = 0; i < _addresses.length; i++) {\n\n66:           for (uint256 i = 0; i < _addresses.length; i++) {\n\n81:           for (uint256 i = 0; i < _addresses.length; i++) {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L51\n\n```solidity\nFile: src/contracts/libraries/SafeERC20.sol\n\n27:               for (i = 0; i < 32 && data[i] != 0; i++) {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/libraries/SafeERC20.sol#L27\n\n## [G&#x2011;11]  `require()`/`revert()` strings longer than 32 bytes cost extra gas\nEach extra memory word of bytes past the original 32 [incurs an MSTORE](https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#consider-having-short-revert-strings) which costs **3 gas**\n\n*There are 8 instances of this issue:*\n```solidity\nFile: src/contracts/FraxlendPairDeployer.sol\n\n205:              require(deployedPairsBySalt[salt] == address(0), \"FraxlendPairDeployer: Pair already deployed\");\n\n228:              require(_pairAddress != address(0), \"FraxlendPairDeployer: create2 failed\");\n\n253:          require(deployedPairsByName[_name] == address(0), \"FraxlendPairDeployer: Pair name must be unique\");\n\n365:          require(_maxLTV <= GLOBAL_MAX_LTV, \"FraxlendPairDeployer: _maxLTV is too large\");\n\n366           require(\n367               IFraxlendWhitelist(FRAXLEND_WHITELIST_ADDRESS).fraxlendDeployerWhitelist(msg.sender),\n368               \"FraxlendPairDeployer: Only whitelisted addresses\"\n369:          );\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L205\n\n```solidity\nFile: src/contracts/LinearInterestRate.sol\n\n57            require(\n58                _minInterest < MAX_INT && _minInterest <= _vertexInterest && _minInterest >= MIN_INT,\n59                \"LinearInterestRate: _minInterest < MAX_INT && _minInterest <= _vertexInterest && _minInterest >= MIN_INT\"\n60:           );\n\n61            require(\n62                _maxInterest <= MAX_INT && _vertexInterest <= _maxInterest && _maxInterest > MIN_INT,\n63                \"LinearInterestRate: _maxInterest <= MAX_INT && _vertexInterest <= _maxInterest && _maxInterest > MIN_INT\"\n64:           );\n\n65            require(\n66                _vertexUtilization < MAX_VERTEX_UTIL && _vertexUtilization > 0,\n67                \"LinearInterestRate: _vertexUtilization < MAX_VERTEX_UTIL && _vertexUtilization > 0\"\n68:           );\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L57-L60\n\n## [G&#x2011;12]  Optimize names to save gas\n`public`/`external` function names and `public` member variable names can be optimized to save gas. See [this](https://gist.github.com/IllIllI000/a5d8b486a8259f9f77891a919febd1a9) link for an example of how it works. Below are the interfaces/abstract contracts that can be optimized so that the most frequently-called functions use the least amount of gas possible during method lookup. Method IDs that have two leading zero bytes can save **128 gas** each during deployment, and renaming functions to have lower method IDs will save **22 gas** per call, [per sorted position shifted](https://medium.com/joyso/solidity-how-does-function-name-affect-gas-consumption-in-smart-contract-47d270d8ac92)\n\n*There are 6 instances of this issue:*\n```solidity\nFile: src/contracts/FraxlendPairCore.sol\n\n/// @audit initialize(), addInterest(), updateExchangeRate(), borrowAsset(), addCollateral(), removeCollateral(), repayAsset(), liquidate(), liquidateClean(), leveragedPosition(), repayAssetWithCollateral()\n46:   abstract contract FraxlendPairCore is FraxlendPairConstants, IERC4626, ERC20, Ownable, Pausable, ReentrancyGuard {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L46\n\n```solidity\nFile: src/contracts/FraxlendPairDeployer.sol\n\n/// @audit deployedPairsLength(), getAllPairAddresses(), getCustomStatuses(), setCreationCode(), deploy(), deployCustom(), globalPause()\n44:   contract FraxlendPairDeployer is Ownable {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L44\n\n```solidity\nFile: src/contracts/FraxlendPair.sol\n\n/// @audit assetsPerShare(), assetsOf(), getConstants(), toBorrowShares(), toBorrowAmount(), setTimeLock(), changeFee(), withdrawFees(), setSwapper(), setApprovedLenders(), setApprovedBorrowers(), pause(), unpause()\n41:   contract FraxlendPair is FraxlendPairCore {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L41\n\n```solidity\nFile: src/contracts/FraxlendWhitelist.sol\n\n/// @audit setOracleContractWhitelist(), setRateContractWhitelist(), setFraxlendDeployerWhitelist()\n30:   contract FraxlendWhitelist is Ownable {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L30\n\n```solidity\nFile: src/contracts/LinearInterestRate.sol\n\n/// @audit getConstants(), requireValidInitData(), getNewRate()\n32:   contract LinearInterestRate is IRateCalculator {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L32\n\n```solidity\nFile: src/contracts/VariableInterestRate.sol\n\n/// @audit getConstants(), requireValidInitData(), getNewRate()\n33:   contract VariableInterestRate is IRateCalculator {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/VariableInterestRate.sol#L33\n\n## [G&#x2011;13]  Using `bool`s for storage incurs overhead\n```solidity\n    // Booleans are more expensive than uint256 or any type that takes up a full\n    // word because each write operation emits an extra SLOAD to first read the\n    // slot's contents, replace the bits taken up by the boolean, and then write\n    // back. This is the compiler's defense against contract upgrades and\n    // pointer aliasing, and it cannot be disabled.\n```\nhttps://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27<br>\nUse `uint256(1)` and `uint256(2)` for true/false to avoid a Gwarmaccess (**[100 gas](https://gist.github.com/IllIllI000/1b70014db712f8572a72378321250058)**) for the extra SLOAD, and to avoid Gsset (**20000 gas**) when changing from `false` to `true`, after having been `true` in the past\n\n*There are 9 instances of this issue:*\n```solidity\nFile: src/contracts/FraxlendPairCore.sol\n\n78:       mapping(address => bool) public swappers; // approved swapper addresses\n\n133:      bool public immutable borrowerWhitelistActive;\n\n134:      mapping(address => bool) public approvedBorrowers;\n\n136:      bool public immutable lenderWhitelistActive;\n\n137:      mapping(address => bool) public approvedLenders;\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L78\n\n```solidity\nFile: src/contracts/FraxlendPairDeployer.sol\n\n94:       mapping(address => bool) public deployedPairCustomStatusByAddress;\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L94\n\n```solidity\nFile: src/contracts/FraxlendWhitelist.sol\n\n32:       mapping(address => bool) public oracleContractWhitelist;\n\n35:       mapping(address => bool) public rateContractWhitelist;\n\n38:       mapping(address => bool) public fraxlendDeployerWhitelist;\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L32\n\n## [G&#x2011;14]  `++i` costs less gas than `i++`, especially when it's used in `for`-loops (`--i`/`i--` too)\nSaves **5 gas per loop**\n\n*There are 9 instances of this issue:*\n```solidity\nFile: src/contracts/FraxlendPairDeployer.sol\n\n130:                  i++;\n\n158:                  i++;\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L130\n\n```solidity\nFile: src/contracts/FraxlendPair.sol\n\n289:          for (uint256 i = 0; i < _lenders.length; i++) {\n\n308:          for (uint256 i = 0; i < _borrowers.length; i++) {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L289\n\n```solidity\nFile: src/contracts/FraxlendWhitelist.sol\n\n51:           for (uint256 i = 0; i < _addresses.length; i++) {\n\n66:           for (uint256 i = 0; i < _addresses.length; i++) {\n\n81:           for (uint256 i = 0; i < _addresses.length; i++) {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L51\n\n```solidity\nFile: src/contracts/libraries/SafeERC20.sol\n\n24:                   i++;\n\n27:               for (i = 0; i < 32 && data[i] != 0; i++) {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/libraries/SafeERC20.sol#L24\n\n## [G&#x2011;15]  Splitting `require()` statements that use `&&` saves gas\nSee [this issue](https://github.com/code-423n4/2022-01-xdefi-findings/issues/128) which describes the fact that there is a larger deployment gas cost, but with enough runtime calls, the change ends up being cheaper by **3 gas**\n\n*There are 3 instances of this issue:*\n```solidity\nFile: src/contracts/LinearInterestRate.sol\n\n57            require(\n58                _minInterest < MAX_INT && _minInterest <= _vertexInterest && _minInterest >= MIN_INT,\n59                \"LinearInterestRate: _minInterest < MAX_INT && _minInterest <= _vertexInterest && _minInterest >= MIN_INT\"\n60:           );\n\n61            require(\n62                _maxInterest <= MAX_INT && _vertexInterest <= _maxInterest && _maxInterest > MIN_INT,\n63                \"LinearInterestRate: _maxInterest <= MAX_INT && _vertexInterest <= _maxInterest && _maxInterest > MIN_INT\"\n64:           );\n\n65            require(\n66                _vertexUtilization < MAX_VERTEX_UTIL && _vertexUtilization > 0,\n67                \"LinearInterestRate: _vertexUtilization < MAX_VERTEX_UTIL && _vertexUtilization > 0\"\n68:           );\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L57-L60\n\n## [G&#x2011;16]  Usage of `uints`/`ints` smaller than 32 bytes (256 bits) incurs overhead\n> When using elements that are smaller than 32 bytes, your contract’s gas usage may be higher. This is because the EVM operates on 32 bytes at a time. Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.\n\nhttps://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html<br>\nEach operation involving a `uint8` costs an extra [**22-28 gas**](https://gist.github.com/IllIllI000/9388d20c70f9a4632eb3ca7836f54977) (depending on whether the other operand is also a variable of type `uint8`) as compared to ones involving `uint256`, due to the compiler having to clear the higher bits of the memory word before operating on the `uint8`, as well as the associated stack operations of doing so. Use a larger size then downcast where needed\n\n*There are 13 instances of this issue:*\n```solidity\nFile: src/contracts/FraxlendPairCore.sol\n\n/// @audit uint64 _newRate\n421:              _newRate = _currentRateInfo.ratePerSec;\n\n/// @audit uint64 _newRate\n448:                  _newRate = uint64(penaltyRate);\n\n/// @audit uint64 _newRate\n456:                  _newRate = IRateCalculator(rateContract).getNewRate(_rateData, rateInitCallData);\n\n/// @audit uint128 _amountToAdjust\n1005:                     _amountToAdjust = (_totalBorrow.toAmount(_sharesToAdjust, false)).toUint128();\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L421\n\n```solidity\nFile: src/contracts/FraxlendPair.sol\n\n/// @audit uint64 _DEFAULT_INT\n175:          _DEFAULT_INT = DEFAULT_INT;\n\n/// @audit uint16 _DEFAULT_PROTOCOL_FEE\n176:          _DEFAULT_PROTOCOL_FEE = DEFAULT_PROTOCOL_FEE;\n\n/// @audit uint128 _shares\n240:          if (_shares == 0) _shares = uint128(balanceOf(address(this)));\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L175\n\n```solidity\nFile: src/contracts/libraries/SafeERC20.sol\n\n/// @audit uint8 i\n27:               for (i = 0; i < 32 && data[i] != 0; i++) {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/libraries/SafeERC20.sol#L27\n\n```solidity\nFile: src/contracts/LinearInterestRate.sol\n\n/// @audit uint64 _newRatePerSec\n85:               _newRatePerSec = uint64(_minInterest + ((_utilization * _slope) / UTIL_PREC));\n\n/// @audit uint64 _newRatePerSec\n88:               _newRatePerSec = uint64(_vertexInterest + (((_utilization - _vertexUtilization) * _slope) / UTIL_PREC));\n\n/// @audit uint64 _newRatePerSec\n90:               _newRatePerSec = uint64(_vertexInterest);\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L85\n\n```solidity\nFile: src/contracts/VariableInterestRate.sol\n\n/// @audit uint64 _newRatePerSec\n71:               _newRatePerSec = uint64((_currentRatePerSec * INT_HALF_LIFE) / _decayGrowth);\n\n/// @audit uint64 _newRatePerSec\n78:               _newRatePerSec = uint64((_currentRatePerSec * _decayGrowth) / INT_HALF_LIFE);\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/VariableInterestRate.sol#L71\n\n## [G&#x2011;17]  Using `private` rather than `public` for constants, saves gas\nIf needed, the values can be read from the verified contract source code, or if there are multiple values there can be a single getter function that returns a tuple of the values of all currently-public constants. Saves **3406-3606 gas** in deployment gas due to the compiler not having to create non-payable getter functions for deployment calldata, not having to store the bytes of the value outside of where it's used, and not adding another entry to the method ID table\n\n*There are 8 instances of this issue:*\n```solidity\nFile: src/contracts/FraxlendPairCore.sol\n\n64:       uint256 public immutable oracleNormalization;\n\n67:       uint256 public immutable maxLTV;\n\n70:       uint256 public immutable cleanLiquidationFee;\n\n71:       uint256 public immutable dirtyLiquidationFee;\n\n95:       uint256 public immutable maturityDate;\n\n96:       uint256 public immutable penaltyRate;\n\n133:      bool public immutable borrowerWhitelistActive;\n\n136:      bool public immutable lenderWhitelistActive;\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairCore.sol#L64\n\n## [G&#x2011;18]  Use custom errors rather than `revert()`/`require()` strings to save gas\nCustom errors are available from solidity version 0.8.4. Custom errors save [**~50 gas**](https://gist.github.com/IllIllI000/ad1bd0d29a0101b25e57c293b4b0c746) each time they're hit by [avoiding having to allocate and store the revert string](https://blog.soliditylang.org/2021/04/21/custom-errors/#errors-in-depth). Not defining the strings also save deployment gas\n\n*There are 9 instances of this issue:*\n```solidity\nFile: src/contracts/FraxlendPairDeployer.sol\n\n205:              require(deployedPairsBySalt[salt] == address(0), \"FraxlendPairDeployer: Pair already deployed\");\n\n228:              require(_pairAddress != address(0), \"FraxlendPairDeployer: create2 failed\");\n\n253:          require(deployedPairsByName[_name] == address(0), \"FraxlendPairDeployer: Pair name must be unique\");\n\n365:          require(_maxLTV <= GLOBAL_MAX_LTV, \"FraxlendPairDeployer: _maxLTV is too large\");\n\n366           require(\n367               IFraxlendWhitelist(FRAXLEND_WHITELIST_ADDRESS).fraxlendDeployerWhitelist(msg.sender),\n368               \"FraxlendPairDeployer: Only whitelisted addresses\"\n369:          );\n\n399:          require(msg.sender == CIRCUIT_BREAKER_ADDRESS, \"Circuit Breaker only\");\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L205\n\n```solidity\nFile: src/contracts/LinearInterestRate.sol\n\n57            require(\n58                _minInterest < MAX_INT && _minInterest <= _vertexInterest && _minInterest >= MIN_INT,\n59                \"LinearInterestRate: _minInterest < MAX_INT && _minInterest <= _vertexInterest && _minInterest >= MIN_INT\"\n60:           );\n\n61            require(\n62                _maxInterest <= MAX_INT && _vertexInterest <= _maxInterest && _maxInterest > MIN_INT,\n63                \"LinearInterestRate: _maxInterest <= MAX_INT && _vertexInterest <= _maxInterest && _maxInterest > MIN_INT\"\n64:           );\n\n65            require(\n66                _vertexUtilization < MAX_VERTEX_UTIL && _vertexUtilization > 0,\n67                \"LinearInterestRate: _vertexUtilization < MAX_VERTEX_UTIL && _vertexUtilization > 0\"\n68:           );\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/LinearInterestRate.sol#L57-L60\n\n## [G&#x2011;19]  Functions guaranteed to revert when called by normal users can be marked `payable`\nIf a function modifier such as `onlyOwner` is used, the function will revert if a normal user tries to pay the function. Marking the function as `payable` will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are\n`CALLVALUE`(2),`DUP1`(3),`ISZERO`(3),`PUSH2`(3),`JUMPI`(10),`PUSH1`(3),`DUP1`(3),`REVERT`(0),`JUMPDEST`(1),`POP`(2), which costs an average of about **21 gas per call** to the function, in addition to the extra deployment cost\n\n*There are 7 instances of this issue:*\n```solidity\nFile: src/contracts/FraxlendPairDeployer.sol\n\n170:      function setCreationCode(bytes calldata _creationCode) external onlyOwner {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPairDeployer.sol#L170\n\n```solidity\nFile: src/contracts/FraxlendPair.sol\n\n204:      function setTimeLock(address _newAddress) external onlyOwner {\n\n234:      function withdrawFees(uint128 _shares, address _recipient) external onlyOwner returns (uint256 _amountToTransfer) {\n\n274:      function setSwapper(address _swapper, bool _approval) external onlyOwner {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendPair.sol#L204\n\n```solidity\nFile: src/contracts/FraxlendWhitelist.sol\n\n50:       function setOracleContractWhitelist(address[] calldata _addresses, bool _bool) external onlyOwner {\n\n65:       function setRateContractWhitelist(address[] calldata _addresses, bool _bool) external onlyOwner {\n\n80:       function setFraxlendDeployerWhitelist(address[] calldata _addresses, bool _bool) external onlyOwner {\n\n```\nhttps://github.com/code-423n4/2022-08-frax/blob/c4189a3a98b38c8c962c5ea72f1a322fbc2ae45f/src/contracts/FraxlendWhitelist.sol#L50\n\n**[gititGoro (judge) commented](https://github.com/code-423n4/2022-08-frax-findings/issues/245#issuecomment-1272557460):**\n > Very good report. Could have scored much higher if gas before and after numbers were provided.\n> Nothing invalid.\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}