{
  "circa": {
    "title": "Tribe Turbo contest",
    "sponsor": "Tribe",
    "slug": "2022-02-tribe-turbo",
    "date": "2022-04-19",
    "findings": "https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues",
    "contest": 92
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Tribe Turbo smart contract system written in Solidity. The audit contest took place between February 17—February 23 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>30 Wardens contributed reports to the Tribe Turbo contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li>CertoraInc (<a href=\"https://twitter.com/danbinnun\">danb</a>, egjlmn1, <a href=\"https://twitter.com/ori_dabush\">OriDabush</a>, ItayG, and shakedwinder)</li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li>cccz</li>\n<li>Picodes</li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li><a href=\"https://twitter.com/0xliumin\">0xliumin</a></li>\n<li>hyh</li>\n<li>nascent (<a href=\"https://twitter.com/brockjelmore\">brock</a>, <a href=\"https://twitter.com/andreasbigger\">0xAndreas</a>, and <a href=\"https://twitter.com/Chris_8086\">chris_nascent</a>)</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li>IllIllI</li>\n<li>samruna</li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li><a href=\"https://twitter.com/catchup22\">catchup</a></li>\n<li><a href=\"https://twitter.com/JustDravee\">Dravee</a></li>\n<li>robee</li>\n<li>kenta</li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"https://twitter.com/asgeir_eth\">asgeir</a></li>\n<li>0x1f8b</li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li><a href=\"https://twitter.com/_0v3rf10w\">0v3rf10w</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/GalloDaSballo\">Alex the Entreprenerd</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 7 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 5 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 17 reports by wardens detailing issues that fall under the risk rating of LOW severity or non-critical. There were also 14 reports by wardens recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo\">C4 Tribe Turbo contest repository</a>, and is composed of 9 smart contracts written in the Solidity programming language and includes 1205 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-2\" style=\"position:relative;\"><a href=\"#high-risk-findings-2\" aria-label=\"high risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (2)</h1>\n<h2 id=\"h-01-erc4626-mint-uses-wrong-amount\" style=\"position:relative;\"><a href=\"#h-01-erc4626-mint-uses-wrong-amount\" aria-label=\"h 01 erc4626 mint uses wrong amount permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/27\">[H-01] ERC4626 mint uses wrong <code>amount</code></a></h2>\n<p><em>Submitted by cmichel, also found by 0xliumin, CertoraInc, Picodes, and Ruhum</em></p>\n<blockquote>\n<p>The docs/video say <code>ERC4626.sol</code> is in scope as its part of <code>TurboSafe</code></p>\n</blockquote>\n<p>The <code>ERC4626.mint</code> function mints <code>amount</code> instead of <code>shares</code>.\nThis will lead to issues when the <code>asset &#x3C;> shares</code> are not 1-to-1 as will be the case for most vaults over time.\nUsually, the asset amount is larger than the share amount as vaults receive asset yield.\nTherefore, when minting, <code>shares</code> should be less than <code>amount</code>.\nUsers receive a larger share amount here which can be exploited to drain the vault assets.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">previewMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">shares</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// No need to check for rounding error, previewMint rounds up.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Need to transfer before minting or ERC777s could reenter.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">afterDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Assume <code>vault.totalSupply() = 1000</code>, <code>totalAssets = 1500</code></p>\n<ul>\n<li>call <code>mint(shares=1000)</code>. Only need to pay <code>1000</code> asset amount but receive <code>1000</code> shares => <code>vault.totalSupply() = 2000</code>, <code>totalAssets = 2500</code>.</li>\n<li>call <code>redeem(shares=1000)</code>. Receive <code>(1000 / 2000) * 2500 = 1250</code> amounts. Make a profit of <code>250</code> asset tokens.</li>\n<li>repeat until <code>shares &#x3C;> assets</code> are 1-to-1</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>In <code>deposit</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">function mint(uint256 shares, address to) public virtual returns (uint256 amount) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _mint(to, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    _mint(to, shares);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/27#issuecomment-1065919880\">Alex the Entreprenerd (judge)</a>:</strong></p>\n<blockquote>\n<p>The warden has identified what is most likely a small oversight, which would have drastic consequences in the internal accounting of the Vault.\nBecause of impact, I agree with high severity.</p>\n<p>The sponsor has mitigated.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-turborouter-deposit-mint-createsafeanddeposit-and-createsafeanddepositandboost-functions-do-not-work\" style=\"position:relative;\"><a href=\"#h-02-turborouter-deposit-mint-createsafeanddeposit-and-createsafeanddepositandboost-functions-do-not-work\" aria-label=\"h 02 turborouter deposit mint createsafeanddeposit and createsafeanddepositandboost functions do not work permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/16\">[H-02] TurboRouter: <code>deposit()</code>, <code>mint()</code>, <code>createSafeAndDeposit()</code> and <code>createSafeAndDepositAndBoost()</code> functions do not work</a></h2>\n<p><em>Submitted by cccz, also found by CertoraInc and WatchPug</em></p>\n<p>The TurboRouter contract inherits from the ERC4626RouterBase contract. When the user calls the deposit, mint, createSafeAndDeposit and createSafeAndDepositAndBoost functions of the TurboRouter contract, the deposit and mint functions of the ERC4626RouterBase contract are called.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IERC4626</span><span class=\"mtk1\"> </span><span class=\"mtk12\">safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minSharesOut</span><span class=\"mtk1\">) </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">authenticate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safe</span><span class=\"mtk1\">)) </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">super</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minSharesOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IERC4626</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">, </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minSharesOut</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sharesOut</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">sharesOut</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">)) &lt; </span><span class=\"mtk12\">minSharesOut</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MinAmountError</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The deposit and mint functions of the ERC4626RouterBase contract will call the deposit and mint functions of the TurboSafe contract. The TurboSafe contract inherits from the ERC4626 contract, that is, the deposit and mint functions of the ERC4626 contract will be called.</p>\n<p>The deposit and mint functions of the ERC4626 contract will call the safeTransferFrom function. Since the caller is the TurboRouter contract, msg.sender will be the TurboRouter contract. And because the user calls the deposit, mint, createSafeAndDeposit, and createSafeAndDepositAndBoost functions of the TurboRouter contract without transferring tokens to the TurboRouter contract and approving the TurboSafe contract to use the tokens, the call will fail.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Check for rounding error since we round down in previewDeposit.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">((</span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">previewDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">)) != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ZERO_SHARES&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Need to transfer before minting or ERC777s could reenter.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">afterDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo/blob/main/src/TurboRouter.sol\">TurboRouter.sol</a></p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>In the deposit, mint, createSafeAndDeposit, and createSafeAndDepositAndBoost functions of the TurboRouter contract, add code for the user to transfer tokens and approve the use of tokens in the TurboSafe contract.\nFor example:</p>\n<p>TurboRouter.sol</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safe</span><span class=\"mtk1\">.</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safe</span><span class=\"mtk1\">.</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safe</span><span class=\"mtk1\">,</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">super</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC4626</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safe</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minSharesOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safe</span><span class=\"mtk1\">.</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safe</span><span class=\"mtk1\">.</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safe</span><span class=\"mtk1\">,</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">super</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safe</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">maxAmountIn</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/16#issuecomment-1050172199\">Joeysantoro (Tribe Turbo) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Router uses Multicall and PeripheryPayments which can be combined to achieve the desired behaviors.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/16#issuecomment-1065915261\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@Joeysantoro I don’t quite understand your counter argument here for <code>createSafeAnd....</code> type functions.</p>\n<p>For Deposit and Mint, yes, you can create the safe, and then multicall the approvals, I agree with your counter, the functions don’t need the extra approve calls.</p>\n<p>However for the functions that deploy a new safe, am not quite sure where the approval happens, see <code>createSafeAndDeposit</code> below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">createSafeAndDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minSharesOut</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">TurboSafe</span><span class=\"mtk1\"> </span><span class=\"mtk12\">safe</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">master</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createSafe</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">super</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC4626</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safe</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minSharesOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">safe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>I believe your counter argument could apply if you were deploying new vaults via Create2 so you could deterministically pre-approve the new safe, however in this case you are deploying a new safe, to an unpredictable address and then calling <code>deposit</code> on it.\n<code>deposit</code> will <code>safeTransferFrom</code> from the router to the vault and I can’t quite see how this call won’t fail since the router never gave allowance to the <code>safe</code>.</p>\n<p>Can you please clarify your counter argument for this specific function?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/16#issuecomment-1065927852\">Joeysantoro (Tribe Turbo) commented</a>:</strong></p>\n<blockquote>\n<p>I was wrong, this issue is valid.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/16#issuecomment-1066142520\">Alex the Entreprenerd (judge) increased severity to High and commented</a>:</strong></p>\n<blockquote>\n<p>Per the sponsor reply, I believe the finding to be valid. Impact is that the code doesn’t work so I believe High Severity to be appropriate.</p>\n<p>Mitigation seems to be straightforward.</p>\n</blockquote>\n<p><strong>Please note: the following additional discussions took place approximately 3 weeks after judging and awarding were finalized. As such, this report will leave this finding in its originally assessed risk category as it simply reflects a snapshot in time.</strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/16#issuecomment-1098525075\">Joeysantoro (Tribe Turbo) commented</a>:</strong></p>\n<blockquote>\n<p>imo this is not high risk because the router is a periphery contract. Its medium at best from a security perspective, but an important find within the context of the correctness of the code.</p>\n<p>To clarify, the issue only exists for createSafe… not deposit or mint for the reason I stated.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/16#issuecomment-1100093539\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@Joeysantoro I think your perspective is valid and perhaps with more context, I would have indeed rated at a lower severity.</p>\n<p>My reasoning at the time was that because the code is broken, the severity should be high.\nOn the other hand, we can also argue that the impact is minimal, as any call to those functions simply reverts, no safes with “wrong allowance” are set, and ultimately the impact is just some wasted gas.</p>\n<p>The bug doesn’t cause a loss of funds nor bricks the protocol in any meaningful way (because this is just a periphery contract).</p>\n<p>I think you’re right in your logic, at the time of judging I simply focused on how the code didn’t work and thought that was reason to raise the severity</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-5\" style=\"position:relative;\"><a href=\"#medium-risk-findings-5\" aria-label=\"medium risk findings 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (5)</h1>\n<h2 id=\"m-01-erc4626routerbasewithdraw-should-use-a-max-shares-out-check\" style=\"position:relative;\"><a href=\"#m-01-erc4626routerbasewithdraw-should-use-a-max-shares-out-check\" aria-label=\"m 01 erc4626routerbasewithdraw should use a max shares out check permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/28\">[M-01] <code>ERC4626RouterBase.withdraw</code> should use a <strong>max</strong> shares out check</a></h2>\n<p><em>Submitted by cmichel, also found by CertoraInc and Picodes</em></p>\n<blockquote>\n<p>The docs/video say <code>ERC4626RouterBase.sol</code> is in scope as its part of <code>TurboRouter</code></p>\n</blockquote>\n<p>The <code>ERC4626RouterBase.withdraw</code> function withdraws the asset <code>amount</code> parameter by burning <code>shares</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IERC4626</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minSharesOut</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sharesOut</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit-info from = msg.sender</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">sharesOut</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">)) &lt; </span><span class=\"mtk12\">minSharesOut</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MinAmountError</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>It then checks that the burned shares <code>sharesOut</code> are not <em>less</em> than a <code>minSharesOut</code> amount.\nHowever, the user wants to be protected against burning <em>too many</em> shares for their specified <code>amount</code>, and therefore a <code>maxSharesBurned</code> amount parameter should be used.</p>\n<p>The user can lose their entire shares due to the wrong check.</p>\n<blockquote>\n<p>this extends to <code>TurboRouter.withdraw</code></p>\n</blockquote>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>User calls <code>Router.withdraw(amount=1100, minSharesOut=1000)</code> to protect against not burning more than <code>1000</code> shares for their <code>1100</code> asset amount.\nHowever, there’s an exploit in the vault which makes the <code>sharesOut = 100_000</code>, the entire user’s shares.\nThe check then passes as it only reverts if <code>100_000 &#x3C; 1000</code>.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">function withdraw(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    IERC4626 vault,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    address to,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 amount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256 minSharesOut</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 maxSharesIn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) public payable virtual override returns (uint256 sharesOut) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    if ((sharesOut = vault.withdraw(amount, to, msg.sender)) &lt; minSharesOut) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    if ((sharesOut = vault.withdraw(amount, to, msg.sender)) &gt; maxSharesIn) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        revert MinAmountError();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Also, rename the variable in <code>TurboRouter.withdraw</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/28#issuecomment-1050204357\">Joeysantoro (Tribe Turbo) disagreed with High severity and commented</a>:</strong></p>\n<blockquote>\n<p>This should be a medium severity issue. The function logic is correct, it’s just not a useful check in its current state.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/28#issuecomment-1052550608\">Joeysantoro (Tribe Turbo) resolved and commented</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/fei-protocol/ERC4626/pull/9\">https://github.com/fei-protocol/ERC4626/pull/9</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/28#issuecomment-1065918572\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I agree with both sides, ultimately the check doesn’t provide protection against loss of value, as such medium severity is appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-wrong-implementation-of-turbosafesolless-may-cause-boosted-record-value-in-turbomaster-bigger-than-actual-lead-to-boostcapforvault-and-boostcapforcollateral-to-be-permanently-occupied\" style=\"position:relative;\"><a href=\"#m-02-wrong-implementation-of-turbosafesolless-may-cause-boosted-record-value-in-turbomaster-bigger-than-actual-lead-to-boostcapforvault-and-boostcapforcollateral-to-be-permanently-occupied\" aria-label=\"m 02 wrong implementation of turbosafesolless may cause boosted record value in turbomaster bigger than actual lead to boostcapforvault and boostcapforcollateral to be permanently occupied permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/55\">[M-02] Wrong implementation of <code>TurboSafe.sol#less()</code> may cause boosted record value in TurboMaster bigger than actual lead to <code>BoostCapForVault</code> and <code>BoostCapForCollateral</code> to be permanently occupied</a></h2>\n<p><em>Submitted by WatchPug, also found by cmichel and hyh</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo/blob/66f27fe51083f49f7935e3fe594ab2380b75dee8/src/TurboSafe.sol#L225-L236\">TurboSafe.sol#L225-L236</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Get out current amount of Fei debt in the Turbo Fuse Pool.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feiDebt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feiTurboCToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">borrowBalanceCurrent</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// If our debt balance decreased, repay the minimum.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// The surplus Fei will accrue as fees and can be sweeped.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">feiAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">feiDebt</span><span class=\"mtk1\">) </span><span class=\"mtk12\">feiAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feiDebt</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Repay Fei debt in the Turbo Fuse Pool, unless we would repay nothing.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">feiAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">feiTurboCToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">repayBorrow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">feiAmount</span><span class=\"mtk1\">) == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;REPAY_FAILED&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Call the Master to allow it to update its accounting.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">master</span><span class=\"mtk1\">.</span><span class=\"mtk11\">onSafeLess</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">feiAmount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>In the current implementation, when calling <code>less()</code> to withdraw Fei from the Vault and use it to repay debt, if the amount of Fei is bigger than the debt balance, the <code>onSafeLess</code> hook will use <code>feiDebt</code> as <code>The amount of Fei withdrawn from the Vault</code>.</p>\n<p>As a result, <code>getTotalBoostedForVault[vault]</code> in TurboMaster will be larger than the actual total amount of Fei being used to boost the Vault.</p>\n<p>Since the <code>Turbo Gibber</code> may impound some of the Safe’s collateral and mint a certain amount of Fei and repay the Safe’s Fei debt with the newly minted Fei. In that case, the Safe’s debt balance can be less than the amount of Fei in Vault. Which constitutes the precondition for the <code>less()</code> call to case the distortion of <code>getTotalBoostedForVault[vault]</code>.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Given:</p>\n<ul>\n<li>1 WBTC = 100,000</li>\n<li><code>collateralFactor</code> of WBTC = 0.6</li>\n<li><code>getBoostCapForCollateral[WBTC]</code> = 300,000</li>\n<li><code>getBoostCapForVault[vault0]</code> = 300,000</li>\n<li>Alice create Safe and deposit <code>10 WBTC</code> and Boost <code>300,000 Fei</code> to <code>vault0</code></li>\n<li>Safe’s debt = 300,000</li>\n<li>Safe’s Fei in vault = 300,000</li>\n</ul>\n<p>On master:</p>\n<ul>\n<li>getTotalBoostedForVault[vault0] = 300,000</li>\n<li>getTotalBoostedAgainstCollateral[WBTC] = 300,000</li>\n</ul>\n<p>On safe:</p>\n<ul>\n<li>getTotalFeiBoostedForVault[vault0] = 300,000</li>\n<li>totalFeiBoosted = 300,000</li>\n<li>WBTC price drop to 50,000, <code>Turbo Gibber</code> impound <code>2 WBTC</code> and mint <code>100,000 Fei</code> to repay debt for Alice’s Safe.</li>\n<li>Safe’s debt = 200,000</li>\n<li>Safe’s Fei in vault0 = 300,000</li>\n<li>Alice call <code>less()</code> withdraw <code>300,000 Fei</code> from Vault and repay <code>200,000</code> debt, in the hook: <code>master.onSafeLess(WBTC, vault0, 200,000)</code></li>\n<li>Safe’s debt = 0</li>\n<li>Safe’s Fei in vault = 0</li>\n</ul>\n<p>On master:</p>\n<ul>\n<li>getTotalBoostedForVault[vault0] = 100,000</li>\n<li>getTotalBoostedAgainstCollateral[WBTC] = 100,000</li>\n</ul>\n<p>On Safe:</p>\n<ul>\n<li>getTotalFeiBoostedForVault[vault0] = 0</li>\n<li>totalFeiBoosted = 0</li>\n<li>Alice try deposit <code>20 WBTC</code> and Boost <code>300,000 Fei</code> will fail due to <code>BOOSTER_REJECTED</code>.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">less</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC4626</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feiAmount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">requiresLocalOrMasterAuth</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Update the total Fei deposited into the Vault proportionately.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">getTotalFeiBoostedForVault</span><span class=\"mtk1\">[</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">feiAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Decrease the boost total proportionately.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Cannot underflow because the total cannot be less than a single Vault.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">totalFeiBoosted</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">feiAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">VaultLessened</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">feiAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Withdraw the specified amount of Fei from the Vault.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">feiAmount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Call the Master to allow it to update its accounting.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">master</span><span class=\"mtk1\">.</span><span class=\"mtk11\">onSafeLess</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">feiAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Get out current amount of Fei debt in the Turbo Fuse Pool.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feiDebt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feiTurboCToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">borrowBalanceCurrent</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// If our debt balance decreased, repay the minimum.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// The surplus Fei will accrue as fees and can be sweeped.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">feiAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">feiDebt</span><span class=\"mtk1\">) </span><span class=\"mtk12\">feiAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feiDebt</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Repay Fei debt in the Turbo Fuse Pool, unless we would repay nothing.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">feiAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">feiTurboCToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">repayBorrow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">feiAmount</span><span class=\"mtk1\">) == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;REPAY_FAILED&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/55#issuecomment-1050191594\">transmissions11 (Tribe Turbo) commented</a>:</strong></p>\n<blockquote>\n<p>Good find</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/55#issuecomment-1066144673\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden identified a way to desynch the actual amounts of boostedFei for a vault and the system vs the amounts tracked in storage.</p>\n<p>Because of this discrepancy the availability of borrowable FEI in the system can be distorted, preventing new borrows.</p>\n<p>I do not believe this puts collateral at risk and also believe that the temporary “denial of borrowing” would be quickly fixed by raising caps.</p>\n<p>I want to commend the warden for finding a way to break the system invariants, while the system internal accounting has been broken, no meaningful leak of value, extended denial of service or funneling of funds happened.</p>\n<p>Liquidations can also still happen at the pool level.</p>\n<p>Because of these reasons, I agree with Medium Severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-slurp-can-be-frontrun-with-fee-increase\" style=\"position:relative;\"><a href=\"#m-03-slurp-can-be-frontrun-with-fee-increase\" aria-label=\"m 03 slurp can be frontrun with fee increase permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/29\">[M-03] Slurp can be frontrun with fee increase</a></h2>\n<p><em>Submitted by cmichel, also found by gzeon</em></p>\n<p>The <code>TurboSafe.slurp</code> function fetches the current fee from the <code>clerk()</code>.\nThis fee can be changed.\nThe <code>slurp</code> transaction can be frontrun with a fee increase (specifically targeted for the vault or the asset) by the clerk and steal the vault yield that should go to the user.</p>\n<p>Maybe the user would not want to <code>slurp</code> at the new fee rate and would rather wait as they expect the fees to decrease again in the future.\nOr they would rather create a new vault if the default fees are lower.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Right now there’s no good protection against this as the master can call <code>slurp</code> at any time.\n(They could even increase the fees to 100%, slurp, reset the fees.)\nThis mechanic would need to be addressed first if mitigation and better user protection are desired.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/29#issuecomment-1050202638\">Joeysantoro (Tribe Turbo) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Slurping is public, and fee increases will be behind governance timelocks. Users are sufficiently protected. Any more complete solution to this would dramatically increase the computational complexity of the architecture.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/29#issuecomment-1066146290\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I have to agree with the Warden here that this type of Admin Privilege is present in the system and can be used to raise fees up to 100%.</p>\n<p>I believe protocol users could get stronger security guarantees by having a MAX_FEE hardcoded variable to ensure fees can never go above a certain threshold.</p>\n<p>I recommend the sponsor to publicly disclose this potential risk to protocol users, and given that I believe that the timelock will provide a good base security guarantee to which I’d recommend adding a MAX_FEE.</p>\n<p>Because the finding is contingent on malicious governance I believe medium severity to be appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-erc4626-does-not-work-with-fee-on-transfer-tokens\" style=\"position:relative;\"><a href=\"#m-04-erc4626-does-not-work-with-fee-on-transfer-tokens\" aria-label=\"m 04 erc4626 does not work with fee on transfer tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/26\">[M-04] ERC4626 does not work with fee-on-transfer tokens</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<blockquote>\n<p>The docs/video say <code>ERC4626.sol</code> is in scope as its part of <code>TurboSafe</code></p>\n</blockquote>\n<p>The <code>ERC4626.deposit/mint</code> functions do not work well with fee-on-transfer tokens as the <code>amount</code> variable is the pre-fee amount, including the fee, whereas the <code>totalAssets</code> do not include the fee anymore.</p>\n<p>This can be abused to mint more shares than desired.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Check for rounding error since we round down in previewDeposit.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">((</span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">previewDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">)) != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ZERO_SHARES&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Need to transfer before minting or ERC777s could reenter.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">afterDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>A <code>deposit(1000)</code> should result in the same shares as two deposits of <code>deposit(500)</code> but it does not because <code>amount</code> is the pre-fee amount.\nAssume a fee-on-transfer of <code>20%</code>. Assume current <code>totalAmount = 1000</code>, <code>totalShares = 1000</code> for simplicity.</p>\n<ul>\n<li><code>deposit(1000) = 1000 / totalAmount * totalShares = 1000 shares</code></li>\n<li><code>deposit(500) = 500 / totalAmount * totalShares = 500 shares</code>. Now the <code>totalShares</code> increased by 500 but the <code>totalAssets</code> only increased by <code>(100% - 20%) * 500 = 400</code>. Therefore, the second <code>deposit(500) = 500 / (totalAmount + 400) * (newTotalShares) = 500 / (1400) * 1500 = 535.714285714 shares</code>.</li>\n</ul>\n<p>In total, the two deposits lead to <code>35</code> more shares than a single deposit of the sum of the deposits.</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p><code>amount</code> should be the amount excluding the fee, i.e., the amount the contract actually received.\nThis can be done by subtracting the pre-contract balance from the post-contract balance.\nHowever, this would create another issue with ERC777 tokens.</p>\n<p>Maybe <code>previewDeposit</code> should be overwritten by vaults supporting fee-on-transfer tokens to predict the post-fee <code>amount</code>. And do the shares computation on that, but then the <code>afterDeposit</code> is still called with the original <code>amount</code> and implementers need to be aware of this.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/26#issuecomment-1050199252\">Joeysantoro (Tribe Turbo) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>This is intended. Fee-on-transfer functions can be implemented in another base contract. This contract is only one implementation of the <a href=\"https://eips.ethereum.org/EIPS/eip-4626\">standard</a>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/26#issuecomment-1073036352\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Given no context, I would side with the sponsor as the ERC4626 standard is meant to work with ERC20 Standard tokens.</p>\n<p>However, in bringing the ERC4626 mixin into scope, the sponsor’s code has an explicit mention of ERC777 which does open up to the possibility of having fees on transfer.</p>\n<p>Because ultimately the warden didn’t stretch the scope (as that happened because of the mixin), and the warden showed a way to provide leakage of value or denial of service exclusively if the mixin code is used in conjunction with a <code>feeOnTransfer</code> token.</p>\n<p>Given that the mixin code comments explicitly mention attempting to support non-standard tokens.</p>\n<p>I believe medium severity to be valid as any type of misbehavior is contingent on deploying an ERC4626 mixin with a <code>feeOnTransfer</code> Token.</p>\n<p>Given the circumstances, the best recommendation for developers is to use the mixin with ERC20 Standard Tokens.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-gibber-can-take-any-amount-from-safes\" style=\"position:relative;\"><a href=\"#m-05-gibber-can-take-any-amount-from-safes\" aria-label=\"m 05 gibber can take any amount from safes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/62\">[M-05] Gibber can take any amount from safes</a></h2>\n<p><em>Submitted by gzeon</em></p>\n<p>Although Gibber is supposed to behind governance timelock, there are still significant “rug risk” when such privillaged user can remove all fund from a vault unconditionally.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo/blob/66f27fe51083f49f7935e3fe594ab2380b75dee8/src/TurboSafe.sol#L335\">TurboSafe.sol#L335</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">gib</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assetAmount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">requiresLocalOrMasterAuth</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SafeGibbed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assetAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Withdraw the specified amount of assets from the Turbo Fuse Pool.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assetTurboCToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">redeemUnderlying</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assetAmount</span><span class=\"mtk1\">) == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;REDEEM_FAILED&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Transfer the assets to the authorized caller.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assetAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Limit gib to certain collateral ratio.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/62#issuecomment-1050155715\">Joeysantoro (Tribe Turbo) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>This is intended behavior. There will be an extended immutable timelock behind the gibber, so Turbo users will have notice to less and withdraw. The only scenario where they can’t is when the boosted strategy is insolvent, which is intended behavior.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/62#issuecomment-1073038659\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>While there’s something to be appreciated about a simple architecture, I believe that the flexibility of the Fuse Pool would allow to account for insolvency in a trustless way through the Fuse Liquidation code.</p>\n<p>Additionally, while the code may be put behind timelock, we can only review the code that is in scope and that we can prove behaves in a certain way.</p>\n<p>In this case, the warden has identified that the system admin can move funds at any time, without limitation.</p>\n<p>Because this type of exploit is contingent on a malicious admin, I believe Medium Severity to be appropriate.</p>\n<p>The sponsor intends on using an immutable timelock so for end users of the protocol I highly recommend to verify that statement.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 17 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/13\">report highlighted below</a> by warden <strong>csanuragjain</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/44\">nascent</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/21\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/41\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/36\">samruna</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/66\">pauliax</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/73\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/58\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/39\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/53\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/35\">asgeir</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/31\">cmichel</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/65\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/2\">robee</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/14\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/75\">kenta</a>, and <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/71\">Picodes</a>.</em></p>\n<h2 id=\"l-01-missing-checks-on-new-boost-cap\" style=\"position:relative;\"><a href=\"#l-01-missing-checks-on-new-boost-cap\" aria-label=\"l 01 missing checks on new boost cap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Missing checks on new Boost Cap</h2>\n<ol>\n<li>setBoostCapForVault function at TurboBooster.sol#L59 is missing checks to see if newBoostCap>getBoostCapForVault[vault]</li>\n<li>This is required since vault might already be at old boost cap.</li>\n<li>Setting lower boost cap would mean that boosting is already overflowed in this vault</li>\n<li>In case if it is required to lower the boost cap then slurpAndLess function at TurboRouter.sol#L130 must be called to withdraw excess cap amount</li>\n</ol>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation:</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setBoostCapForVault</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC4626</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newBoostCap</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">requiresAuth</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newBoostCap</span><span class=\"mtk1\">&gt;</span><span class=\"mtk12\">getBoostCapForVault</span><span class=\"mtk1\">[</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">], </span><span class=\"mtk8\">&quot;Invalid boost&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Update the boost cap for the Vault.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">getBoostCapForVault</span><span class=\"mtk1\">[</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">newBoostCap</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BoostCapUpdatedForVault</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">newBoostCap</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 id=\"l-02-more-funds-extracted-than-required---lose-interest\" style=\"position:relative;\"><a href=\"#l-02-more-funds-extracted-than-required---lose-interest\" aria-label=\"l 02 more funds extracted than required   lose interest permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] More funds extracted than required - Lose Interest</h2>\n<ol>\n<li>Debt can be paid using less function at TurboSafe.sol</li>\n<li>But it was observed that User might call less function with higher feiAmount than required</li>\n<li>In case if feiDebt&#x3C;feiAmount, the difference feiAmount-feiDebt is kept as vault balance</li>\n<li>This causes interest loss over these funds and even sweep can withdraw only after getTotalFeiBoostedForVault[vault]=0</li>\n</ol>\n<h3 id=\"recommendation-1\" style=\"position:relative;\"><a href=\"#recommendation-1\" aria-label=\"recommendation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation:</h3>\n<p>Calculate the feiDebt first and only withdraw the min(feiAmount,feiDebt) so that only required amount is withdrawn</p>\n<h2 id=\"l-03-missing-zero-address-checks\" style=\"position:relative;\"><a href=\"#l-03-missing-zero-address-checks\" aria-label=\"l 03 missing zero address checks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Missing zero address checks</h2>\n<ol>\n<li>setBooster, setClerk, setDefaultSafeAuthority at TurboMaster.sol are not checking whether the supplied address!=0</li>\n</ol>\n<h2 id=\"n-01-emit-function-called-early\" style=\"position:relative;\"><a href=\"#n-01-emit-function-called-early\" aria-label=\"n 01 emit function called early permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Emit function called early</h2>\n<ol>\n<li>The emit function at multiple functions have been called before function end say emit VaultLessened at TurboSafe.sol#L220. This is incorrect since operation has not completed yet and function might revert based on condition ahead. Also this cause gas wastage</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/13\">Joeysantoro (Tribe Turbo) acknowledged</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/13#issuecomment-1073042117\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the first finding, not super sure about mitigation as it would make the system more bloated.</p>\n<p>Second finding definitely worth investigating.</p>\n<p>Zero checks -> Agree by convention.</p>\n<p>Emit functions are being emitted early as a way to avoid reEntrancy, so I’m ambivalent on this.</p>\n<p>Overall the report was short and sweet, no particular formatting was needed and it looks good.</p>\n<p>Wish the warden put links to the findings to make it easier to check.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/13#issuecomment-1073269098\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>In judging, am also adding issue #9 (<a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/9\">[L-04] Bypass Boosting cap set by Admin</a>).</p>\n<p>6/10</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/13#issuecomment-1073271316\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Bumping to 7 to make it the winner, 7/10.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/13#issuecomment-1079063099\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>After re-review I confirm 7/10. The simple formatting avoids confusion, and the Caps, Lose Interest, and #9 make the report unique.</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 14 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/43\">report highlighted below</a> by warden team <strong>nascent</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/22\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/52\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/47\">CertoraInc</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/72\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/63\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/68\">Picodes</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/77\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/8\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/74\">kenta</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/59\">Tomio</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/70\">0v3rf10w</a>, <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/3\">robee</a>, and <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/37\">samruna</a>.</em></p>\n<h2 id=\"g-01-slurp-sload-gas-optimization\" style=\"position:relative;\"><a href=\"#g-01-slurp-sload-gas-optimization\" aria-label=\"g 01 slurp sload gas optimization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] <code>slurp</code> SLOAD Gas Optimization</h2>\n<p><strong>Severity</strong>: <em>Gas Optimization</em><br>\n<strong>Likelihood</strong>: <em>High</em><br>\n<strong>Status</strong>: {Not Submitted}<br>\n<strong>Scope</strong>: <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo/blob/main/src/TurboSafe.sol#L255-L290\"><code>slurp()</code></a></p>\n<p>There are two <em>sloads</em> of <code>getTotalFeiBoostedForVault[vault]</code> that can be gas golfed using an <em>mload</em> to reduce gas by <code>100 - 3</code>.</p>\n<p><img src=\"https://i.imgur.com/J7MFU3c.png\" alt=\"slurp Gas Golf\"></p>\n<h2 id=\"g-02-save-sload-gas-optimization\" style=\"position:relative;\"><a href=\"#g-02-save-sload-gas-optimization\" aria-label=\"g 02 save sload gas optimization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] <code>save</code> SLOAD Gas Optimization</h2>\n<p><strong>Severity</strong>: <em>Gas Optimization</em><br>\n<strong>Likelihood</strong>: <em>Medium</em><br>\n<strong>Status</strong>: {Not Submitted}<br>\n<strong>Scope</strong>: <a href=\"https://github.com/code-423n4/2022-02-tribe-turbo/blob/main/src/modules/TurboSavior.sol#L96-L136\"><code>save()</code></a></p>\n<p>There are two calls of <code>pool.oracle()</code> that can be gas golfed using an <em>mload</em> to reduce gas by <code>100 - 3</code>.</p>\n<p><img src=\"https://i.imgur.com/S8ewc9B.png\" alt=\"TurboSavior save function\"></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/43#issuecomment-1050199540\">transmissions11 (Tribe Turbo) commented</a>:</strong></p>\n<blockquote>\n<p>good finds, ty</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/43#issuecomment-1060103021\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>G-01 Agree with finding, each time we’re reading from memory we’re saving 97 gas at the cost of 3 for the initial cache. -191</p>\n<p>G-02 Same idea -94</p>\n<p>285 gas saved</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-2\">High Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#h-01-erc4626-mint-uses-wrong-amount\">[H-01] ERC4626 mint uses wrong <code>amount</code></a></li>\n<li><a href=\"#h-02-turborouter-deposit-mint-createsafeanddeposit-and-createsafeanddepositandboost-functions-do-not-work\">[H-02] TurboRouter: <code>deposit()</code>, <code>mint()</code>, <code>createSafeAndDeposit()</code> and <code>createSafeAndDepositAndBoost()</code> functions do not work</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-5\">Medium Risk Findings (5)</a></p>\n<ul>\n<li><a href=\"#m-01-erc4626routerbasewithdraw-should-use-a-max-shares-out-check\">[M-01] <code>ERC4626RouterBase.withdraw</code> should use a <strong>max</strong> shares out check</a></li>\n<li><a href=\"#m-02-wrong-implementation-of-turbosafesolless-may-cause-boosted-record-value-in-turbomaster-bigger-than-actual-lead-to-boostcapforvault-and-boostcapforcollateral-to-be-permanently-occupied\">[M-02] Wrong implementation of <code>TurboSafe.sol#less()</code> may cause boosted record value in TurboMaster bigger than actual lead to <code>BoostCapForVault</code> and <code>BoostCapForCollateral</code> to be permanently occupied</a></li>\n<li><a href=\"#m-03-slurp-can-be-frontrun-with-fee-increase\">[M-03] Slurp can be frontrun with fee increase</a></li>\n<li><a href=\"#m-04-erc4626-does-not-work-with-fee-on-transfer-tokens\">[M-04] ERC4626 does not work with fee-on-transfer tokens</a></li>\n<li><a href=\"#m-05-gibber-can-take-any-amount-from-safes\">[M-05] Gibber can take any amount from safes</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#l-01-missing-checks-on-new-boost-cap\">L-01 Missing checks on new Boost Cap</a></li>\n<li><a href=\"#l-02-more-funds-extracted-than-required---lose-interest\">L-02 More funds extracted than required - Lose Interest</a></li>\n<li><a href=\"#l-03-missing-zero-address-checks\">L-03 Missing zero address checks</a></li>\n<li><a href=\"#n-01-emit-function-called-early\">N-01 Emit function called early</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-slurp-sload-gas-optimization\">G-01 <code>slurp</code> SLOAD Gas Optimization</a></li>\n<li><a href=\"#g-02-save-sload-gas-optimization\">G-02 <code>save</code> SLOAD Gas Optimization</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the Tribe Turbo smart contract system written in Solidity. The audit contest took place between February 17—February 23 2022.\n\n## Wardens\n\n30 Wardens contributed reports to the Tribe Turbo contest:\n\n  1. [cmichel](https://twitter.com/cmichelio)\n  1. CertoraInc ([danb](https://twitter.com/danbinnun), egjlmn1, [OriDabush](https://twitter.com/ori_dabush), ItayG, and shakedwinder)\n  1. [gzeon](https://twitter.com/gzeon)\n  1. WatchPug ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n  1. cccz\n  1. Picodes\n  1. [Ruhum](https://twitter.com/0xruhum)\n  1. [0xliumin](https://twitter.com/0xliumin)\n  1. hyh\n  1. nascent ([brock](https://twitter.com/brockjelmore), [0xAndreas](https://twitter.com/andreasbigger), and [chris_nascent](https://twitter.com/Chris_8086))\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. IllIllI\n  1. samruna\n  1. [pauliax](https://twitter.com/SolidityDev)\n  1. [catchup](https://twitter.com/catchup22)\n  1. [Dravee](https://twitter.com/JustDravee)\n  1. robee\n  1. kenta\n  1. [defsec](https://twitter.com/defsec_)\n  1. [asgeir](https://twitter.com/asgeir_eth)\n  1. 0x1f8b\n  1. [Tomio](https://twitter.com/meidhiwirara)\n  1. [0v3rf10w](https://twitter.com/_0v3rf10w)\n  \nThis contest was judged by [Alex the Entreprenerd](https://twitter.com/GalloDaSballo).\n\nFinal report assembled by [liveactionllama](https://twitter.com/liveactionllama).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 7 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 5 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 17 reports by wardens detailing issues that fall under the risk rating of LOW severity or non-critical. There were also 14 reports by wardens recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 Tribe Turbo contest repository](https://github.com/code-423n4/2022-02-tribe-turbo), and is composed of 9 smart contracts written in the Solidity programming language and includes 1205 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code423n4.com).\n\n# High Risk Findings (2)\n## [[H-01] ERC4626 mint uses wrong `amount`](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/27)\n_Submitted by cmichel, also found by 0xliumin, CertoraInc, Picodes, and Ruhum_\n\n> The docs/video say `ERC4626.sol` is in scope as its part of `TurboSafe`\n\nThe `ERC4626.mint` function mints `amount` instead of `shares`.\nThis will lead to issues when the `asset <> shares` are not 1-to-1 as will be the case for most vaults over time.\nUsually, the asset amount is larger than the share amount as vaults receive asset yield.\nTherefore, when minting, `shares` should be less than `amount`.\nUsers receive a larger share amount here which can be exploited to drain the vault assets.\n\n```solidity\nfunction mint(uint256 shares, address to) public virtual returns (uint256 amount) {\n    amount = previewMint(shares); // No need to check for rounding error, previewMint rounds up.\n\n    // Need to transfer before minting or ERC777s could reenter.\n    asset.safeTransferFrom(msg.sender, address(this), amount);\n    _mint(to, amount);\n\n    emit Deposit(msg.sender, to, amount, shares);\n\n    afterDeposit(amount, shares);\n}\n```\n\n### Proof of Concept\n\nAssume `vault.totalSupply() = 1000`, `totalAssets = 1500`\n\n*   call `mint(shares=1000)`. Only need to pay `1000` asset amount but receive `1000` shares => `vault.totalSupply() = 2000`, `totalAssets = 2500`.\n*   call `redeem(shares=1000)`. Receive `(1000 / 2000) * 2500 = 1250` amounts. Make a profit of `250` asset tokens.\n*   repeat until `shares <> assets` are 1-to-1\n\n### Recommended Mitigation Steps\n\nIn `deposit`:\n\n```diff\nfunction mint(uint256 shares, address to) public virtual returns (uint256 amount) {\n-    _mint(to, amount);\n+    _mint(to, shares);\n}\n```\n\n**[Alex the Entreprenerd (judge)](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/27#issuecomment-1065919880):**\n > The warden has identified what is most likely a small oversight, which would have drastic consequences in the internal accounting of the Vault.\n> Because of impact, I agree with high severity.\n> \n> The sponsor has mitigated.\n\n\n\n***\n\n## [[H-02] TurboRouter: `deposit()`, `mint()`, `createSafeAndDeposit()` and `createSafeAndDepositAndBoost()` functions do not work](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/16)\n_Submitted by cccz, also found by CertoraInc and WatchPug_\n\nThe TurboRouter contract inherits from the ERC4626RouterBase contract. When the user calls the deposit, mint, createSafeAndDeposit and createSafeAndDepositAndBoost functions of the TurboRouter contract, the deposit and mint functions of the ERC4626RouterBase contract are called.\n```solidity\nfunction deposit(IERC4626 safe, address to, uint256 amount, uint256 minSharesOut) \n    public \n    payable \n    override \n    authenticate(address(safe)) \n    returns (uint256) \n{\n    return super.deposit(safe, to, amount, minSharesOut);\n}\n...\nfunction deposit(\n    IERC4626 vault, \n    address to,\n    uint256 amount,\n    uint256 minSharesOut\n) public payable virtual override returns (uint256 sharesOut) {\n    if ((sharesOut = vault.deposit(amount, to)) < minSharesOut) {\n        revert MinAmountError();\n    }\n}\n```\n\nThe deposit and mint functions of the ERC4626RouterBase contract will call the deposit and mint functions of the TurboSafe contract. The TurboSafe contract inherits from the ERC4626 contract, that is, the deposit and mint functions of the ERC4626 contract will be called.\n\nThe deposit and mint functions of the ERC4626 contract will call the safeTransferFrom function. Since the caller is the TurboRouter contract, msg.sender will be the TurboRouter contract. And because the user calls the deposit, mint, createSafeAndDeposit, and createSafeAndDepositAndBoost functions of the TurboRouter contract without transferring tokens to the TurboRouter contract and approving the TurboSafe contract to use the tokens, the call will fail.\n```solidity\nfunction deposit(uint256 amount, address to) public virtual returns (uint256 shares) {\n    // Check for rounding error since we round down in previewDeposit.\n    require((shares = previewDeposit(amount)) != 0, \"ZERO_SHARES\");\n\n    // Need to transfer before minting or ERC777s could reenter.\n    asset.safeTransferFrom(msg.sender, address(this), amount);\n\n    _mint(to, shares);\n\n    emit Deposit(msg.sender, to, amount, shares);\n\n    afterDeposit(amount, shares);\n}\n```\n\n### Proof of Concept\n\n[TurboRouter.sol](https://github.com/code-423n4/2022-02-tribe-turbo/blob/main/src/TurboRouter.sol)\n\n### Recommended Mitigation Steps\n\nIn the deposit, mint, createSafeAndDeposit, and createSafeAndDepositAndBoost functions of the TurboRouter contract, add code for the user to transfer tokens and approve the use of tokens in the TurboSafe contract.\nFor example:\n\nTurboRouter.sol\n```solidity\n+        IERC20(safe.asset).safeTransferFrom(msg.sender,address(this),amount);\n+        IERC20(safe.asset).safeApprove(safe,amount);\n    super.deposit(IERC4626(address(safe)), to, amount, minSharesOut);\n\n...\n\n+        IERC20(safe.asset).safeTransferFrom(msg.sender,address(this),amount);\n+        IERC20(safe.asset).safeApprove(safe,amount);\n    super.mint(safe, to, shares, maxAmountIn);\n```\n\n**[Joeysantoro (Tribe Turbo) disputed and commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/16#issuecomment-1050172199):**\n > Router uses Multicall and PeripheryPayments which can be combined to achieve the desired behaviors.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/16#issuecomment-1065915261):**\n > @Joeysantoro I don't quite understand your counter argument here for `createSafeAnd....` type functions.\n> \n> For Deposit and Mint, yes, you can create the safe, and then multicall the approvals, I agree with your counter, the functions don't need the extra approve calls.\n> \n> However for the functions that deploy a new safe, am not quite sure where the approval happens, see `createSafeAndDeposit` below:\n> \n> ```solidity\n>     function createSafeAndDeposit(ERC20 underlying, address to, uint256 amount, uint256 minSharesOut) external {\n>         (TurboSafe safe, ) = master.createSafe(underlying);\n> \n>         super.deposit(IERC4626(address(safe)), to, amount, minSharesOut);\n> \n>         safe.setOwner(msg.sender);\n>     }\n> ```\n> \n> I believe your counter argument could apply if you were deploying new vaults via Create2 so you could deterministically pre-approve the new safe, however in this case you are deploying a new safe, to an unpredictable address and then calling `deposit` on it. \n> `deposit` will `safeTransferFrom` from the router to the vault and I can't quite see how this call won't fail since the router never gave allowance to the `safe`.\n> \n> Can you please clarify your counter argument for this specific function?\n> \n\n**[Joeysantoro (Tribe Turbo) commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/16#issuecomment-1065927852):**\n > I was wrong, this issue is valid.\n\n**[Alex the Entreprenerd (judge) increased severity to High and commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/16#issuecomment-1066142520):**\n > Per the sponsor reply, I believe the finding to be valid. Impact is that the code doesn't work so I believe High Severity to be appropriate.\n> \n> Mitigation seems to be straightforward.\n\n**Please note: the following additional discussions took place approximately 3 weeks after judging and awarding were finalized. As such, this report will leave this finding in its originally assessed risk category as it simply reflects a snapshot in time.**\n\n**[Joeysantoro (Tribe Turbo) commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/16#issuecomment-1098525075):**\n> imo this is not high risk because the router is a periphery contract. Its medium at best from a security perspective, but an important find within the context of the correctness of the code.\n> \n> To clarify, the issue only exists for createSafe... not deposit or mint for the reason I stated.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/16#issuecomment-1100093539):**\n> @Joeysantoro I think your perspective is valid and perhaps with more context, I would have indeed rated at a lower severity.\n> \n> My reasoning at the time was that because the code is broken, the severity should be high.\n> On the other hand, we can also argue that the impact is minimal, as any call to those functions simply reverts, no safes with \"wrong allowance\" are set, and ultimately the impact is just some wasted gas.\n> \n> The bug doesn't cause a loss of funds nor bricks the protocol in any meaningful way (because this is just a periphery contract).\n> \n> I think you're right in your logic, at the time of judging I simply focused on how the code didn't work and thought that was reason to raise the severity\n\n\n\n***\n \n# Medium Risk Findings (5)\n## [[M-01] `ERC4626RouterBase.withdraw` should use a **max** shares out check](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/28)\n_Submitted by cmichel, also found by CertoraInc and Picodes_\n\n> The docs/video say `ERC4626RouterBase.sol` is in scope as its part of `TurboRouter`\n\nThe `ERC4626RouterBase.withdraw` function withdraws the asset `amount` parameter by burning `shares`.\n\n```solidity\nfunction withdraw(\n    IERC4626 vault,\n    address to,\n    uint256 amount,\n    uint256 minSharesOut\n) public payable virtual override returns (uint256 sharesOut) {\n    // @audit-info from = msg.sender\n    if ((sharesOut = vault.withdraw(amount, to, msg.sender)) < minSharesOut) {\n        revert MinAmountError();\n    }\n}\n```\n\nIt then checks that the burned shares `sharesOut` are not *less* than a `minSharesOut` amount.\nHowever, the user wants to be protected against burning *too many* shares for their specified `amount`, and therefore a `maxSharesBurned` amount parameter should be used.\n\nThe user can lose their entire shares due to the wrong check.\n\n> this extends to `TurboRouter.withdraw`\n\n### Proof of Concept\n\nUser calls `Router.withdraw(amount=1100, minSharesOut=1000)` to protect against not burning more than `1000` shares for their `1100` asset amount.\nHowever, there's an exploit in the vault which makes the `sharesOut = 100_000`, the entire user's shares.\nThe check then passes as it only reverts if `100_000 < 1000`.\n\n### Recommended Mitigation Steps\n\n```diff\nfunction withdraw(\n    IERC4626 vault,\n    address to,\n    uint256 amount,\n-    uint256 minSharesOut\n+    uint256 maxSharesIn\n) public payable virtual override returns (uint256 sharesOut) {\n-    if ((sharesOut = vault.withdraw(amount, to, msg.sender)) < minSharesOut) {\n+    if ((sharesOut = vault.withdraw(amount, to, msg.sender)) > maxSharesIn) {\n        revert MinAmountError();\n    }\n}\n```\n\nAlso, rename the variable in `TurboRouter.withdraw`.\n\n**[Joeysantoro (Tribe Turbo) disagreed with High severity and commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/28#issuecomment-1050204357):**\n > This should be a medium severity issue. The function logic is correct, it's just not a useful check in its current state.\n\n**[Joeysantoro (Tribe Turbo) resolved and commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/28#issuecomment-1052550608):**\n > https://github.com/fei-protocol/ERC4626/pull/9\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/28#issuecomment-1065918572):**\n > I agree with both sides, ultimately the check doesn't provide protection against loss of value, as such medium severity is appropriate.\n\n\n\n***\n\n## [[M-02] Wrong implementation of `TurboSafe.sol#less()` may cause boosted record value in TurboMaster bigger than actual lead to `BoostCapForVault` and `BoostCapForCollateral` to be permanently occupied](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/55)\n_Submitted by WatchPug, also found by cmichel and hyh_\n\n[TurboSafe.sol#L225-L236](https://github.com/code-423n4/2022-02-tribe-turbo/blob/66f27fe51083f49f7935e3fe594ab2380b75dee8/src/TurboSafe.sol#L225-L236)\n\n```solidity\n// Get out current amount of Fei debt in the Turbo Fuse Pool.\nuint256 feiDebt = feiTurboCToken.borrowBalanceCurrent(address(this));\n\n// If our debt balance decreased, repay the minimum.\n// The surplus Fei will accrue as fees and can be sweeped.\nif (feiAmount > feiDebt) feiAmount = feiDebt;\n\n// Repay Fei debt in the Turbo Fuse Pool, unless we would repay nothing.\nif (feiAmount != 0) require(feiTurboCToken.repayBorrow(feiAmount) == 0, \"REPAY_FAILED\");\n\n// Call the Master to allow it to update its accounting.\nmaster.onSafeLess(asset, vault, feiAmount);\n```\n\nIn the current implementation, when calling `less()` to withdraw Fei from the Vault and use it to repay debt, if the amount of Fei is bigger than the debt balance, the `onSafeLess` hook will use `feiDebt` as `The amount of Fei withdrawn from the Vault`.\n\nAs a result, `getTotalBoostedForVault[vault]` in TurboMaster will be larger than the actual total amount of Fei being used to boost the Vault.\n\nSince the `Turbo Gibber` may impound some of the Safe's collateral and mint a certain amount of Fei and repay the Safe's Fei debt with the newly minted Fei. In that case, the Safe's debt balance can be less than the amount of Fei in Vault. Which constitutes the precondition for the `less()` call to case the distortion of `getTotalBoostedForVault[vault]`.\n\n### Proof of Concept\n\nGiven:\n\n*   1 WBTC = 100,000\n*   `collateralFactor` of WBTC = 0.6\n*   `getBoostCapForCollateral[WBTC]` = 300,000\n*   `getBoostCapForVault[vault0]` = 300,000\n\n1.  Alice create Safe and deposit `10 WBTC` and Boost `300,000 Fei` to `vault0`\n\n*   Safe's debt = 300,000\n*   Safe's Fei in vault = 300,000\n\nOn master:\n\n*   getTotalBoostedForVault\\[vault0] = 300,000\n*   getTotalBoostedAgainstCollateral\\[WBTC] = 300,000\n\nOn safe:\n\n*   getTotalFeiBoostedForVault\\[vault0] = 300,000\n*   totalFeiBoosted = 300,000\n\n2.  WBTC price drop to 50,000, `Turbo Gibber` impound `2 WBTC` and mint `100,000 Fei` to repay debt for Alice's Safe.\n\n*   Safe's debt = 200,000\n*   Safe's Fei in vault0 = 300,000\n\n3.  Alice call `less()` withdraw `300,000 Fei` from Vault and repay `200,000` debt, in the hook: `master.onSafeLess(WBTC, vault0, 200,000)`\n\n*   Safe's debt = 0\n*   Safe's Fei in vault = 0\n\nOn master:\n\n*   getTotalBoostedForVault\\[vault0] = 100,000\n*   getTotalBoostedAgainstCollateral\\[WBTC] = 100,000\n\nOn Safe:\n\n*   getTotalFeiBoostedForVault\\[vault0] = 0\n*   totalFeiBoosted = 0\n\n4.  Alice try deposit `20 WBTC` and Boost `300,000 Fei` will fail due to `BOOSTER_REJECTED`.\n\n### Recommended Mitigation Steps\n\nChange to:\n\n```solidity\nfunction less(ERC4626 vault, uint256 feiAmount) external nonReentrant requiresLocalOrMasterAuth {\n    // Update the total Fei deposited into the Vault proportionately.\n    getTotalFeiBoostedForVault[vault] -= feiAmount;\n\n    unchecked {\n        // Decrease the boost total proportionately.\n        // Cannot underflow because the total cannot be less than a single Vault.\n        totalFeiBoosted -= feiAmount;\n    }\n\n    emit VaultLessened(msg.sender, vault, feiAmount);\n\n    // Withdraw the specified amount of Fei from the Vault.\n    vault.withdraw(feiAmount, address(this), address(this));\n\n    // Call the Master to allow it to update its accounting.\n    master.onSafeLess(asset, vault, feiAmount);\n\n    // Get out current amount of Fei debt in the Turbo Fuse Pool.\n    uint256 feiDebt = feiTurboCToken.borrowBalanceCurrent(address(this));\n\n    // If our debt balance decreased, repay the minimum.\n    // The surplus Fei will accrue as fees and can be sweeped.\n    if (feiAmount > feiDebt) feiAmount = feiDebt;\n\n    // Repay Fei debt in the Turbo Fuse Pool, unless we would repay nothing.\n    if (feiAmount != 0) require(feiTurboCToken.repayBorrow(feiAmount) == 0, \"REPAY_FAILED\");\n}\n```\n\n**[transmissions11 (Tribe Turbo) commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/55#issuecomment-1050191594):**\n > Good find\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/55#issuecomment-1066144673):**\n > The warden identified a way to desynch the actual amounts of boostedFei for a vault and the system vs the amounts tracked in storage.\n> \n> Because of this discrepancy the availability of borrowable FEI in the system can be distorted, preventing new borrows.\n> \n> I do not believe this puts collateral at risk and also believe that the temporary \"denial of borrowing\" would be quickly fixed by raising caps.\n> \n> I want to commend the warden for finding a way to break the system invariants, while the system internal accounting has been broken, no meaningful leak of value, extended denial of service or funneling of funds happened.\n> \n> Liquidations can also still happen at the pool level.\n> \n> Because of these reasons, I agree with Medium Severity.\n\n\n\n***\n\n## [[M-03] Slurp can be frontrun with fee increase](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/29)\n_Submitted by cmichel, also found by gzeon_\n\nThe `TurboSafe.slurp` function fetches the current fee from the `clerk()`.\nThis fee can be changed.\nThe `slurp` transaction can be frontrun with a fee increase (specifically targeted for the vault or the asset) by the clerk and steal the vault yield that should go to the user.\n\nMaybe the user would not want to `slurp` at the new fee rate and would rather wait as they expect the fees to decrease again in the future.\nOr they would rather create a new vault if the default fees are lower.\n\n### Recommended Mitigation Steps\n\nRight now there's no good protection against this as the master can call `slurp` at any time.\n(They could even increase the fees to 100%, slurp, reset the fees.)\nThis mechanic would need to be addressed first if mitigation and better user protection are desired.\n\n**[Joeysantoro (Tribe Turbo) disputed and commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/29#issuecomment-1050202638):**\n > Slurping is public, and fee increases will be behind governance timelocks. Users are sufficiently protected. Any more complete solution to this would dramatically increase the computational complexity of the architecture.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/29#issuecomment-1066146290):**\n > I have to agree with the Warden here that this type of Admin Privilege is present in the system and can be used to raise fees up to 100%.\n> \n> I believe protocol users could get stronger security guarantees by having a MAX_FEE hardcoded variable to ensure fees can never go above a certain threshold.\n> \n> I recommend the sponsor to publicly disclose this potential risk to protocol users, and given that I believe that the timelock will provide a good base security guarantee to which I'd recommend adding a MAX_FEE.\n> \n> Because the finding is contingent on malicious governance I believe medium severity to be appropriate.\n\n\n\n***\n\n## [[M-04] ERC4626 does not work with fee-on-transfer tokens](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/26)\n_Submitted by cmichel_\n\n> The docs/video say `ERC4626.sol` is in scope as its part of `TurboSafe`\n\nThe `ERC4626.deposit/mint` functions do not work well with fee-on-transfer tokens as the `amount` variable is the pre-fee amount, including the fee, whereas the `totalAssets` do not include the fee anymore.\n\nThis can be abused to mint more shares than desired.\n\n```solidity\nfunction deposit(uint256 amount, address to) public virtual returns (uint256 shares) {\n    // Check for rounding error since we round down in previewDeposit.\n    require((shares = previewDeposit(amount)) != 0, \"ZERO_SHARES\");\n\n    // Need to transfer before minting or ERC777s could reenter.\n    asset.safeTransferFrom(msg.sender, address(this), amount);\n\n    _mint(to, shares);\n\n    emit Deposit(msg.sender, to, amount, shares);\n\n    afterDeposit(amount, shares);\n}\n```\n\n### Proof of Concept\n\nA `deposit(1000)` should result in the same shares as two deposits of `deposit(500)` but it does not because `amount` is the pre-fee amount.\nAssume a fee-on-transfer of `20%`. Assume current `totalAmount = 1000`, `totalShares = 1000` for simplicity.\n\n*   `deposit(1000) = 1000 / totalAmount * totalShares = 1000 shares`\n*   `deposit(500) = 500 / totalAmount * totalShares = 500 shares`. Now the `totalShares` increased by 500 but the `totalAssets` only increased by `(100% - 20%) * 500 = 400`. Therefore, the second `deposit(500) = 500 / (totalAmount + 400) * (newTotalShares) = 500 / (1400) * 1500 = 535.714285714 shares`.\n\nIn total, the two deposits lead to `35` more shares than a single deposit of the sum of the deposits.\n\n### Recommended Mitigation Steps\n\n`amount` should be the amount excluding the fee, i.e., the amount the contract actually received.\nThis can be done by subtracting the pre-contract balance from the post-contract balance.\nHowever, this would create another issue with ERC777 tokens.\n\nMaybe `previewDeposit` should be overwritten by vaults supporting fee-on-transfer tokens to predict the post-fee `amount`. And do the shares computation on that, but then the `afterDeposit` is still called with the original `amount` and implementers need to be aware of this.\n\n**[Joeysantoro (Tribe Turbo) disputed and commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/26#issuecomment-1050199252):**\n > This is intended. Fee-on-transfer functions can be implemented in another base contract. This contract is only one implementation of the [standard](https://eips.ethereum.org/EIPS/eip-4626).\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/26#issuecomment-1073036352):**\n > Given no context, I would side with the sponsor as the ERC4626 standard is meant to work with ERC20 Standard tokens.\n> \n> However, in bringing the ERC4626 mixin into scope, the sponsor's code has an explicit mention of ERC777 which does open up to the possibility of having fees on transfer.\n> \n> Because ultimately the warden didn't stretch the scope (as that happened because of the mixin), and the warden showed a way to provide leakage of value or denial of service exclusively if the mixin code is used in conjunction with a `feeOnTransfer` token.\n> \n> Given that the mixin code comments explicitly mention attempting to support non-standard tokens.\n> \n> I believe medium severity to be valid as any type of misbehavior is contingent on deploying an ERC4626 mixin with a `feeOnTransfer` Token.\n> \n> Given the circumstances, the best recommendation for developers is to use the mixin with ERC20 Standard Tokens.\n\n\n\n***\n\n## [[M-05] Gibber can take any amount from safes](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/62)\n_Submitted by gzeon_\n\nAlthough Gibber is supposed to behind governance timelock, there are still significant \"rug risk\" when such privillaged user can remove all fund from a vault unconditionally.\n\n### Proof of Concept\n\n[TurboSafe.sol#L335](https://github.com/code-423n4/2022-02-tribe-turbo/blob/66f27fe51083f49f7935e3fe594ab2380b75dee8/src/TurboSafe.sol#L335)<br>\n```solidity\nfunction gib(address to, uint256 assetAmount) external nonReentrant requiresLocalOrMasterAuth {\n    emit SafeGibbed(msg.sender, to, assetAmount);\n\n    // Withdraw the specified amount of assets from the Turbo Fuse Pool.\n    require(assetTurboCToken.redeemUnderlying(assetAmount) == 0, \"REDEEM_FAILED\");\n\n    // Transfer the assets to the authorized caller.\n    asset.safeTransfer(to, assetAmount);\n}\n```\n\n### Recommended Mitigation Steps\n\nLimit gib to certain collateral ratio.\n\n**[Joeysantoro (Tribe Turbo) disputed and commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/62#issuecomment-1050155715):**\n > This is intended behavior. There will be an extended immutable timelock behind the gibber, so Turbo users will have notice to less and withdraw. The only scenario where they can't is when the boosted strategy is insolvent, which is intended behavior.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/62#issuecomment-1073038659):**\n > While there's something to be appreciated about a simple architecture, I believe that the flexibility of the Fuse Pool would allow to account for insolvency in a trustless way through the Fuse Liquidation code.\n> \n> Additionally, while the code may be put behind timelock, we can only review the code that is in scope and that we can prove behaves in a certain way.\n> \n> In this case, the warden has identified that the system admin can move funds at any time, without limitation.\n> \n> Because this type of exploit is contingent on a malicious admin, I believe Medium Severity to be appropriate.\n> \n> The sponsor intends on using an immutable timelock so for end users of the protocol I highly recommend to verify that statement.\n\n\n\n***\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 17 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/13) by warden **csanuragjain** received the top score from the judge.\n\n_The following wardens also submitted reports: [nascent](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/44), [IllIllI](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/21), [hyh](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/41), [samruna](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/36), [pauliax](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/66), [catchup](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/73), [defsec](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/58), [Ruhum](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/39), [WatchPug](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/53), [asgeir](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/35), [cmichel](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/31), [Dravee](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/65), [robee](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/2), [0x1f8b](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/14), [kenta](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/75), and [Picodes](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/71)._\n\n## [L-01] Missing checks on new Boost Cap\n\n1.  setBoostCapForVault function at TurboBooster.sol#L59 is missing checks to see if newBoostCap>getBoostCapForVault\\[vault]\n\n2.  This is required since vault might already be at old boost cap.\n\n3.  Setting lower boost cap would mean that boosting is already overflowed in this vault\n\n4.  In case if it is required to lower the boost cap then slurpAndLess function at TurboRouter.sol#L130 must be called to withdraw excess cap amount\n\n### Recommendation:\n```solidity\nfunction setBoostCapForVault(ERC4626 vault, uint256 newBoostCap) external requiresAuth {\nrequire(newBoostCap>getBoostCapForVault[vault], \"Invalid boost\");\n    // Update the boost cap for the Vault.\n    getBoostCapForVault[vault] = newBoostCap;\n\n    emit BoostCapUpdatedForVault(msg.sender, vault, newBoostCap);\n}\n```\n\n## [L-02] More funds extracted than required - Lose Interest\n\n1.  Debt can be paid using less function at TurboSafe.sol\n2.  But it was observed that User might call less function with higher feiAmount than required\n3.  In case if feiDebt\\<feiAmount, the difference feiAmount-feiDebt is kept as vault balance\n4.  This causes interest loss over these funds and even sweep can withdraw only after getTotalFeiBoostedForVault\\[vault]=0\n\n### Recommendation:\nCalculate the feiDebt first and only withdraw the min(feiAmount,feiDebt) so that only required amount is withdrawn\n\n## [L-03] Missing zero address checks\n\n1.  setBooster, setClerk, setDefaultSafeAuthority at TurboMaster.sol are not checking whether the supplied address!=0\n\n## [N-01] Emit function called early\n\n1.  The emit function at multiple functions have been called before function end say emit VaultLessened at TurboSafe.sol#L220. This is incorrect since operation has not completed yet and function might revert based on condition ahead. Also this cause gas wastage\n\n**[Joeysantoro (Tribe Turbo) acknowledged](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/13)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/13#issuecomment-1073042117):**\n > Agree with the first finding, not super sure about mitigation as it would make the system more bloated.\n> \n> Second finding definitely worth investigating.\n> \n> Zero checks -> Agree by convention.\n> \n> Emit functions are being emitted early as a way to avoid reEntrancy, so I'm ambivalent on this.\n> \n> Overall the report was short and sweet, no particular formatting was needed and it looks good.\n> \n> Wish the warden put links to the findings to make it easier to check.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/13#issuecomment-1073269098):**\n > In judging, am also adding issue #9 ([[L-04] Bypass Boosting cap set by Admin](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/9)).\n> \n> 6/10\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/13#issuecomment-1073271316):**\n > Bumping to 7 to make it the winner, 7/10.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/13#issuecomment-1079063099):**\n > After re-review I confirm 7/10. The simple formatting avoids confusion, and the Caps, Lose Interest, and #9 make the report unique.\n\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 14 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/43) by warden team **nascent** received the top score from the judge.\n\n_The following wardens also submitted reports: [IllIllI](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/22), [WatchPug](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/52), [CertoraInc](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/47), [Dravee](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/72), [gzeon](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/63), [Picodes](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/68), [catchup](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/77), [csanuragjain](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/8), [kenta](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/74), [Tomio](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/59), [0v3rf10w](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/70), [robee](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/3), and [samruna](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/37)._\n\n## [G-01] `slurp` SLOAD Gas Optimization\n\n**Severity**: *Gas Optimization*<br>\n**Likelihood**: *High*<br>\n**Status**: {Not Submitted}<br>\n**Scope**: [`slurp()`](https://github.com/code-423n4/2022-02-tribe-turbo/blob/main/src/TurboSafe.sol#L255-L290)\n\nThere are two *sloads* of `getTotalFeiBoostedForVault[vault]` that can be gas golfed using an *mload* to reduce gas by `100 - 3`.\n\n![slurp Gas Golf](https://i.imgur.com/J7MFU3c.png)\n\n## [G-02] `save` SLOAD Gas Optimization\n\n**Severity**: *Gas Optimization*<br>\n**Likelihood**: *Medium*<br>\n**Status**: {Not Submitted}<br>\n**Scope**: [`save()`](https://github.com/code-423n4/2022-02-tribe-turbo/blob/main/src/modules/TurboSavior.sol#L96-L136)\n\nThere are two calls of `pool.oracle()` that can be gas golfed using an *mload* to reduce gas by `100 - 3`.\n\n![TurboSavior save function](https://i.imgur.com/S8ewc9B.png)\n\n**[transmissions11 (Tribe Turbo) commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/43#issuecomment-1050199540):**\n > good finds, ty\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-02-tribe-turbo-findings/issues/43#issuecomment-1060103021):**\n > G-01 Agree with finding, each time we're reading from memory we're saving 97 gas at the cost of 3 for the initial cache. -191\n> \n> G-02 Same idea -94\n> \n> 285 gas saved\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}