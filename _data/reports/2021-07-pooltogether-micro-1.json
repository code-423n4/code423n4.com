{
  "circa": {
    "title": "PoolTogether micro contest #1",
    "sponsor": "PoolTogether",
    "slug": "2021-07-pooltogether",
    "date": "2021-09-15",
    "findings": "https://github.com/code-423n4/2021-07-pooltogether-findings/issues",
    "contest": 24
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code 432n4 (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the code contest outlined in this document, C4 conducted an analysis of PoolTogether smart contract system written in Solidity. The code contest took place between July 28—July 31.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>12 Wardens contributed reports to the PoolTogether micro contest #1 code contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/0xRajeev\">0xRajeev</a></li>\n<li><a href=\"https://twitter.com/gpersoon\">gpersoon</a></li>\n<li><a href=\"https://twitter.com/HickupH\">hickuphh3</a></li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li><a href=\"https://twitter.com/gallodasballo\">GalloDaSballo</a></li>\n<li><a href=\"https://github.com/x9453\">shw</a></li>\n<li><a href=\"https://twitter.com/jonah1005w\">jonah1005</a></li>\n<li><a href=\"https://twitter.com/Tensors8\">tensors</a></li>\n<li><a href=\"https://twitter.com/_hrkrshnn\">hrkrshnn</a></li>\n<li><a href=\"https://twitter.com/MukeshJ_eth\">Jmukesh</a></li>\n<li>maplesyrup (<a href=\"https://github.com/heiho1\">heiho1</a> and <a href=\"https://twitter.com/eriksal1217\">thisguy__</a>)</li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/lsdan_defi\">LSDan</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/money_lego\">moneylegobatman</a> and <a href=\"https://twitter.com/_ninek_\">ninek</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 22 unique vulnerabilities. All of the issues presented here are linked back to their original finding</p>\n<p>Of these vulnerabilities, 4 received a risk rating in the category of HIGH severity, 4 received a risk rating in the category of MEDIUM severity, and 14 received a risk rating in the category of LOW severity.</p>\n<p>C4 analysis also identified 6 non-critical recommendations and 11 gas optimizations.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2021-07-pooltogether\">C4 PoolTogether micro contest #1 repository</a> is comprised of 2 smart contracts written in the Solidity programming language and includes ~275 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings\" style=\"position:relative;\"><a href=\"#high-risk-findings\" aria-label=\"high risk findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings</h1>\n<h2 id=\"h-01-onlyownerorassetmanager-can-swap-yield-source-in-swappableyieldsource-at-any-time-immediately-rugging-all-funds-from-old-yield-source\" style=\"position:relative;\"><a href=\"#h-01-onlyownerorassetmanager-can-swap-yield-source-in-swappableyieldsource-at-any-time-immediately-rugging-all-funds-from-old-yield-source\" aria-label=\"h 01 onlyownerorassetmanager can swap yield source in swappableyieldsource at any time immediately rugging all funds from old yield source permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/14\">[H-01] <code>onlyOwnerOrAssetManager</code> can swap Yield Source in <code>SwappableYieldSource</code> at any time, immediately rugging all funds from old yield source</a></h2>\n<p><em>Submitted by GalloDaSballo, also found by 0xRajeev and gpersoon</em></p>\n<p>The function <code>swapYieldSource</code> <a href=\"https://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/contracts/SwappableYieldSource.sol#L307\">SwappableYieldSource.sol` L307</a></p>\n<p>Can be called by the owner (deployer / initializer) or Asset Manager. The function will take all funds from the old Yield Source, and transfer them to the new Yield source. Any contract that implement the function <code>function depositToken() external returns (address)</code> will pass the check</p>\n<p>However, if either the owner or the <code>assetManager</code> have malicious intent, this function allows them to instantly rug all funds</p>\n<ol>\n<li>Create a contract that implements the <code>function depositToken() external returns (address)</code></li>\n<li>Be the Owner or <code>AssetManager</code></li>\n<li>Call <code>setYieldSource</code> while pointing at your malicious contract</li>\n<li>Profit</li>\n</ol>\n<p>I highly recommend checking that the <code>YieldSource</code> is from a trusted registry before allowing this swap.</p>\n<p>Alternatively forcing each <code>Owner</code> to be a <code>TimeLock</code> with at least 48 hours may provide enough security to allow this to be used in practice</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/14#issuecomment-897195417\">PierrickGT (PoolTogether) disputed</a>:</strong></p>\n<blockquote>\n<p>This is why we will use a multi sig owned by governance to deploy swappable yield sources and manage them. This way, we will avoid these kind of scenarios.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/14#issuecomment-904860248\">0xean (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with warden on the risk here. Will both the AssetManager and the Owner be owned by your governance?</p>\n<p>The YieldSource could easily extract user funds or send them back to the SwappableYieldSource contract and then remove them from there.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/14#issuecomment-908774312\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>We have removed the <code>AssetManager</code> role and <code>Owner</code> will be owned by governance who will vet any change of yield source before going through a vote.</p>\n</blockquote>\n<h2 id=\"h-02-redeemtoken-can-fail-for-certain-tokens\" style=\"position:relative;\"><a href=\"#h-02-redeemtoken-can-fail-for-certain-tokens\" aria-label=\"h 02 redeemtoken can fail for certain tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/61\">[H-02] <code>redeemToken</code> can fail for certain tokens</a></h2>\n<p><em>Submitted by cmichel, also found by hickuphh3, pauliax and jonah1005XXX</em></p>\n<p>The <code>SwappableYieldSource.redeemToken</code> function transfers tokens from the contract back to the sender, however, it uses the <code>ERC20.transferFrom(address(this), msg.sender, redeemableBalance)</code> function for this.\nSome deposit token implementations might fail as <code>transferFrom</code> checks if the contract approved itself for the <code>redeemableBalance</code> instead of skipping the allowance check in case the sender is the <code>from</code> address.</p>\n<p>This can make the transaction revert and the deposited funds will be unrecoverable for the user.</p>\n<p>It’s recommended to use <code>_depositToken.safeTransfer(msg.sender, redeemableBalance)</code> instead.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/61#issuecomment-894368935\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>Duplicate of <a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/25\">https://github.com/code-423n4/2021-07-pooltogether-findings/issues/25</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/61#issuecomment-904799020\">0xean (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>re-opening this issue and marking #25 as a duplicate of this issue which clearly articulates the potential severity of unrecoverable user funds.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/61#issuecomment-908446620\">PierrickGT (PoolTogether) resolved</a>:</strong></p>\n<blockquote>\n<p>This issue has been fixed and we are now using <code>safeTransfer</code>: <a href=\"https://github.com/pooltogether/swappable-yield-source/blob/bf943b3818b81d5f5cb9d8ecc6f13ffecd33a1ff/contracts/SwappableYieldSource.sol#L235\">https://github.com/pooltogether/swappable-yield-source/blob/bf943b3818b81d5f5cb9d8ecc6f13ffecd33a1ff/contracts/SwappableYieldSource.sol#L235</a></p>\n</blockquote>\n<h2 id=\"h-03-setyieldsource-leads-to-temporary-wrong-results\" style=\"position:relative;\"><a href=\"#h-03-setyieldsource-leads-to-temporary-wrong-results\" aria-label=\"h 03 setyieldsource leads to temporary wrong results permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/4\">[H-03] <code>setYieldSource</code> leads to temporary wrong results</a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<p>The use of <code>setYieldSource</code> leaves the contract in a temporary inconsistent state because it changes the underlying yield source,\nbut doesn’t (yet) transfer the underlying balances, while the shares stay the same.</p>\n<p>The function <code>balanceOfToken</code> will show the wrong results, because it is based on <code>_sharesToToken</code>, which uses <code>yieldSource.balanceOfToken(address(this))</code>, that isn’t updated yet.</p>\n<p>More importantly <code>supplyTokenTo</code> will give the wrong amount of shares back:\nFirst it supplies tokens to the <code>yieldsource</code>.\nThen is calls <code>_mintShares</code>, which calls <code>_tokenToShares</code>, which calculates the shares, using <code>yieldSource.balanceOfToken(address(this))</code>\nThis <code>yieldSource.balanceOfToken(address(this))</code> only contains the just supplied tokens, but doesn’t include the tokens from the previous <code>YieldSource</code>.\nSo the wrong amount of shares is given back to the user; they will be given more shares than appropriate which means they can drain funds later on (once <code>transferFunds</code> has been done).</p>\n<p>It is possible to make use of this problem in the following way:</p>\n<ul>\n<li>monitor the blockchain until you see <code>setYieldSource</code> has been done</li>\n<li>immediately call the function <code>supplyTokenTo</code> (which can be called because there is no access control on this function)</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// https://github.com/pooltogether/swappable-yield-source/blob/main/contracts/SwappableYieldSource.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setYieldSource</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IYieldSource</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newYieldSource</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> `</span><span class=\"mtk11\">onlyOwnerOrAssetManager</span><span class=\"mtk1\">` </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">_setYieldSource</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_newYieldSource</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_setYieldSource</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IYieldSource</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newYieldSource</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">yieldSource</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_newYieldSource</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">supplyTokenTo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">yieldSource</span><span class=\"mtk1\">.</span><span class=\"mtk11\">supplyTokenTo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mintShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_mintShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mintAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">`_tokenToShares`</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mintAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;SwappableYieldSource/shares-gt-zero&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_tokenToShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">exchangeMantissa</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FixedPoint</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculateMantissa</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\">, </span><span class=\"mtk12\">yieldSource</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOfToken</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">))); </span><span class=\"mtk3\">// based on incomplete yieldSource.balanceOfToken(address(this))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FixedPoint</span><span class=\"mtk1\">.</span><span class=\"mtk11\">multiplyUintByMantissa</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">exchangeMantissa</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">balanceOfToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_sharesToToken</span><span class=\"mtk1\">(</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_sharesToToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">exchangeMantissa</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FixedPoint</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculateMantissa</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yieldSource</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOfToken</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// based on incomplete yieldSource.balanceOfToken(address(this))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">tokens</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FixedPoint</span><span class=\"mtk1\">.</span><span class=\"mtk11\">multiplyUintByMantissa</span><span class=\"mtk1\">(</span><span class=\"mtk12\">shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">exchangeMantissa</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Reocommend removing the function <code>setYieldSource</code>  (e.g. only leave <code>swapYieldSource</code>)\nOr temporally disable actions like <code>supplyTokenTo</code>, <code>redeemToken</code> and balanceOfToken, after <code>setYieldSource</code> and until <code>transferFunds</code> has been done.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/4#issuecomment-896981238\">PierrickGT (PoolTogether) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/pooltogether/swappable-yield-source/pull/4\">https://github.com/pooltogether/swappable-yield-source/pull/4</a>\nWe’ve mitigated this issue by removing the <code>transferFunds</code> and <code>setYieldSource</code> external functions and making <code>swapYieldSource</code> callable only by the owner that will be a multi sig wallet for governance pools.</p>\n</blockquote>\n<h2 id=\"h-04-swappableyieldsource-missing-same-deposit-token-check-in-transferfunds\" style=\"position:relative;\"><a href=\"#h-04-swappableyieldsource-missing-same-deposit-token-check-in-transferfunds\" aria-label=\"h 04 swappableyieldsource missing same deposit token check in transferfunds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/29\">[H-04] <code>SwappableYieldSource</code>: Missing same deposit token check in <code>transferFunds()</code></a></h2>\n<p><em>Submitted by hickuphh3, also found by 0xRajeev</em></p>\n<p><code>transferFunds()</code> will transfer funds from a specified yield source <code>_yieldSource</code> to the current yield source set in the contract <code>_currentYieldSource</code>. However, it fails to check that the deposit tokens are the same. If the specified yield source’s assets are of a higher valuation, then a malicious owner or asset manager will be able to exploit and pocket the difference.</p>\n<p>Assumptions:</p>\n<ul>\n<li><code>_yieldSource</code> has a deposit token of WETH (18 decimals)</li>\n<li><code>_currentYieldSource</code> has a deposit token of DAI (18 decimals)</li>\n<li>1 WETH > 1 DAI (definitely true, I’d be really sad otherwise)</li>\n</ul>\n<p>Attacker does the following:</p>\n<ol>\n<li>Deposit 100 DAI into the swappable yield source contract</li>\n<li>\n<p>Call <code>transferFunds(_yieldSource, 100 * 1e18)</code></p>\n<ul>\n<li><code>_requireDifferentYieldSource()</code> passes</li>\n<li>\n<p><code>_transferFunds(_yieldSource, 100 * 1e18)</code> is called</p>\n<ul>\n<li><code>_yieldSource.redeemToken(_amount);</code> → This will transfer 100 WETH out of the <code>_yieldSource</code> into the contract</li>\n<li><code>uint256 currentBalance = IERC20Upgradeable(_yieldSource.depositToken()).balanceOf(address(this));</code> → This will equate to ≥ 100 WETH.</li>\n<li><code>require(_amount &#x3C;= currentBalance, \"SwappableYieldSource/transfer-amount-different\");</code> is true since both are <code>100 * 1e18</code></li>\n<li><code>_currentYieldSource.supplyTokenTo(currentBalance, address(this));</code> → This supplies the transferred 100 DAI from step 1 to the current yield source</li>\n</ul>\n</li>\n<li>We now have 100 WETH in the swappable yield source contract</li>\n</ul>\n</li>\n<li>Call <code>transferERC20(WETH, attackerAddress, 100 * 1e18)</code> to withdraw 100 WETH out of the contract to the attacker’s desired address.</li>\n</ol>\n<p><code>_requireDifferentYieldSource()</code> should also verify that the yield sources’ deposit token addresses are the same.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_requireDifferentYieldSource</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IYieldSource</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_yieldSource</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_yieldSource</span><span class=\"mtk1\">) != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yieldSource</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;SwappableYieldSource/same-yield-source&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_newYieldSource</span><span class=\"mtk1\">.</span><span class=\"mtk11\">depositToken</span><span class=\"mtk1\">() == </span><span class=\"mtk12\">yieldSource</span><span class=\"mtk1\">.</span><span class=\"mtk11\">depositToken</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">&quot;SwappableYieldSource/different-deposit-token&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/29#issuecomment-897208429\">PierrickGT (PoolTogether) acknowledged</a>:</strong></p>\n<blockquote>\n<p>This exploit was indeed possible when we had the <code>transferFunds</code> function but now that we have removed it and funds can only be moved by <code>swapYieldSource()</code>, this exploit is no longer possible since we check for the same <code>depositToken</code> in <code>_setYieldSource()</code>.</p>\n<p><a href=\"https://github.com/pooltogether/swappable-yield-source/pull/4\">https://github.com/pooltogether/swappable-yield-source/pull/4</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/29#issuecomment-904807211\">0xean (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Upgrading to 3 considering the potential for loss of funds</p>\n</blockquote>\n<h1 id=\"medium-risk-findings-4\" style=\"position:relative;\"><a href=\"#medium-risk-findings-4\" aria-label=\"medium risk findings 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (4)</h1>\n<h2 id=\"m-01-single-step-process-for-critical-ownership-transferrenounce-is-risky\" style=\"position:relative;\"><a href=\"#m-01-single-step-process-for-critical-ownership-transferrenounce-is-risky\" aria-label=\"m 01 single step process for critical ownership transferrenounce is risky permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/40\">[M-01] Single-step process for critical ownership transfer/renounce is risky</a></h2>\n<p><em>Submitted by 0xRajeev</em></p>\n<p>The <code>SwappableYieldSource</code> allows owners and asset managers to set/swap/transfer yield sources/funds. As such, the contract ownership plays a critical role in the protocol.</p>\n<p>Given that <code>AssetManager</code> is derived from <code>Ownable</code>, the ownership management of this contract defaults to <code>Ownable</code>’s <code>transferOwnership()</code> and <code>renounceOwnership()</code> methods which are not overridden here. Such critical address transfer/renouncing in one-step is very risky because it is irrecoverable from any mistakes.</p>\n<p>Scenario: If an incorrect address, e.g. for which the private key is not known, is used accidentally then it prevents the use of all the <code>onlyOwner()</code> functions forever, which includes the changing of various critical addresses and parameters. This use of incorrect address may not even be immediately apparent given that these functions are probably not used immediately. When noticed, due to a failing <code>onlyOwner()</code>  or <code>onlyOwnerOrAssetManager()</code> function call, it will force the redeployment of these contracts and require appropriate changes and notifications for switching from the old to new address. This will diminish trust in the protocol and incur a significant reputational damage.</p>\n<p>See similar <a href=\"https://github.com/trailofbits/publications/blob/master/reviews/hermez.pdf\">High Risk severity finding</a> from Trail-of-Bits Audit of Hermez.</p>\n<p>See similar<a href=\"https://github.com/Uniswap/uniswap-v3-core/blob/main/audits/tob/audit.pdf\"> Medium Risk severity</a> finding from Trail-of-Bits Audit of Uniswap V3:</p>\n<p>Recommend overriding the inherited methods to null functions and use separate functions for a two-step address change:</p>\n<ol>\n<li>Approve a new address as a <code>pendingOwner</code></li>\n<li>A transaction from the <code>pendingOwner</code> address claims the pending ownership change.</li>\n</ol>\n<p>This mitigates risk because if an incorrect address is used in step (1) then it can be fixed by re-approving the correct address. Only after a correct address is used in step (1) can step (2) happen and complete the address/ownership change.</p>\n<p>Also, consider adding a time-delay for such sensitive actions. And at a minimum, use a multisig owner address and not an EOA.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/40#issuecomment-897217286\">PierrickGT (PoolTogether) disputed</a>:</strong></p>\n<blockquote>\n<p>This isn’t a security issue but an improper use of the <code>initialize</code> function.\nWe do check for address zero so at least the risk of deploying the contract with address zero is excluded. Also, these contracts will be deployed by a multi sig owned by governance so the risk of a single human error is almost null.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/40#issuecomment-904802425\">0xean (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Disagree with sponsor.  A two step process would be a safer implementation.  A multi-sig does not remove human error or the potential risk here. It may be an acceptable risk to the team, but still worth highlighting with the given severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/40#issuecomment-908780172\">PierrickGT (PoolTogether) acknowledged</a>:</strong></p>\n<blockquote>\n<p>We have studied this solution and decided to not implement it since it would make it a pretty tedious process to deploy a swappable yield source, especially through the use of our builder which would mean that a user would have to manually <code>claimOwnership</code> after deploying a pool. Plus, this contract will be owned by governance so it will be very difficult to transfer it to another owner or renounce ownership.</p>\n</blockquote>\n<h2 id=\"m-02-use-of-safeapprove-will-always-cause-approvemax-to-revert\" style=\"position:relative;\"><a href=\"#m-02-use-of-safeapprove-will-always-cause-approvemax-to-revert\" aria-label=\"m 02 use of safeapprove will always cause approvemax to revert permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/47\">[M-02] Use of <code>safeApprove</code> will always cause <code>approveMax</code> to revert</a></h2>\n<p><em>Submitted by 0xRajeev, also found by pauliax, shw, and cmichel</em></p>\n<p>Unlike <code>SwappableYieldSource</code> which uses <code>safeIncreaseAllowance</code> to increase the allowance to <code>uint256.max</code>, <code>mStableYieldSource</code> uses OpenZeppelin’s <code>safeApprove()</code> which has been documented as (1) Deprecated because of approve-like race condition and (2) To be used only for initial setting of allowance <code>(current allowance == 0)</code> or resetting to 0 because it reverts otherwise.</p>\n<p>The usage here is intended to allow increase of allowance when it falls low similar to the documented usage in <code>SwappableYieldSource</code>. Using it for that scenario will not work as expected because it will always revert if current allowance is != 0. The initial allowance is already set as <code>uint256.max</code> in constructor. And once it gets reduced, it can never be increased using this function unless it is invoked when allowance is reduced completely to 0. See issue page for referenced code.</p>\n<p>Recommend Using logic similar to <code>SwappableYieldSource</code> instead of using <code>safeApprove()</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/47#issuecomment-898731351\">PierrickGT (PoolTogether) confirmed</a>:</strong></p>\n<blockquote>\n<p>This issue has been fixed in the following commit: <a href=\"https://github.com/pooltogether/pooltogether-mstable/pull/3/commits/156a990901e6ddff543897905e3ea3d09c78d817\">https://github.com/pooltogether/pooltogether-mstable/pull/3/commits/156a990901e6ddff543897905e3ea3d09c78d817</a></p>\n</blockquote>\n<h2 id=\"m-03-inconsistent-balance-when-supplying-transfer-on-fee-or-deflationary-tokens\" style=\"position:relative;\"><a href=\"#m-03-inconsistent-balance-when-supplying-transfer-on-fee-or-deflationary-tokens\" aria-label=\"m 03 inconsistent balance when supplying transfer on fee or deflationary tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/52\">[M-03] Inconsistent balance when supplying transfer-on-fee or deflationary tokens</a></h2>\n<p><em>Submitted by shw, also found by cmichel</em></p>\n<p>The <code>supplyTokenTo</code> function of <code>SwappableYieldSource</code> assumes that <code>amount</code> of <code>_depositToken</code> is transferred to itself after calling the <code>safeTransferFrom</code> function (and thus it supplies <code>amount</code> of token to the yield source). However, this may not be true if the <code>_depositToken</code> is a transfer-on-fee token or a deflationary/rebasing token, causing the received amount to be less than the accounted amount. <a href=\"https://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/contracts/SwappableYieldSource.sol#L211-L212\">SwappableYieldSource.sol L211-L212</a></p>\n<p>Recommend getting the actual received amount by calculating the difference of token balance before and after the transfer. For example, re-writing line 211-212 to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_depositToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">_depositToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receivedAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_depositToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) - </span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">yieldSource</span><span class=\"mtk1\">.</span><span class=\"mtk11\">supplyTokenTo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receivedAmount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/52#issuecomment-897951282\">PierrickGT (PoolTogether) confirmed</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/pooltogether/swappable-yield-source/pull/9\">https://github.com/pooltogether/swappable-yield-source/pull/9</a></p>\n</blockquote>\n<h2 id=\"m-04-old-yield-source-still-has-infinite-approval\" style=\"position:relative;\"><a href=\"#m-04-old-yield-source-still-has-infinite-approval\" aria-label=\"m 04 old yield source still has infinite approval permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/3\">[M-04] Old yield source still has infinite approval</a></h2>\n<p><em>Submitted by tensors, also found by hickuphh3, cmichel and GalloDaSballo</em></p>\n<p>After swapping a yield source, the old yield source still has infinite approval. Infinite approval has been used in large attacks if the yield source isn’t perfectly safe (<a href=\"https://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/contracts/SwappableYieldSource.sol#L268\">see furucombo</a>).</p>\n<p>Recommend decreasing approval after swapping the yield source.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/3#issuecomment-896357783\">PierrickGT (PoolTogether) confirmed</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/pooltogether/swappable-yield-source/pull/3\">https://github.com/pooltogether/swappable-yield-source/pull/3</a></p>\n</blockquote>\n<h1 id=\"low-risk-findings\" style=\"position:relative;\"><a href=\"#low-risk-findings\" aria-label=\"low risk findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Findings</h1>\n<h2 id=\"l-01-initialization-function-can-be-front-run-with-malicious-values\" style=\"position:relative;\"><a href=\"#l-01-initialization-function-can-be-front-run-with-malicious-values\" aria-label=\"l 01 initialization function can be front run with malicious values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/39\">[L-01] Initialization function can be front-run with malicious values</a></h2>\n<p><em>Submitted by 0xRajeev, also found by cmichel</em></p>\n<p>The <code>SwappableYieldSource.sol</code> has a public visibility initialization function that can be front-run, allowing an attacker to incorrectly initialize the contract, if the deployment of this contract does not safely handle initializations via a robust deployment script or a factory contract to prevent front-running.</p>\n<p>Impact: Initialization function can be front-run by attackers, allowing them to initialize the contract with malicious values. Also, if initializations are not done atomically with creation, all public/external functions can be accessed before initialization because there are no checks to confirm initializations in those functions.</p>\n<p>Reference: See <a href=\"https://github.com/trailofbits/publications/blob/master/reviews/AdvancedBlockchain.pdf\">similar High-severity Finding 9 of Trail of Bits audit of Advanced Blockchain</a> and <a href=\"https://github.com/trailofbits/publications/blob/master/reviews/hermez.pdf\">Finding 12 from Trail of Bits audit of Hermez Network</a>.</p>\n<p>Recommend ensuring atomic creation+deployment with script or factory contract. Add checks to confirm initialization in public/external functions.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/39#issuecomment-904813275\">0xean (Judge) disputed</a>:</strong></p>\n<blockquote>\n<p>The freeze function is not atomic with the deployment and the script does not enforce that that call is made before moving on to further deployments. The script could enforce that the contract has not been initialized which would at least somewhat mitigate the impacts of a potential front run.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/39#issuecomment-908820695\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>We are using a factory contract to deploy the Swappable Yield Source so there is no risk of front running: <a href=\"https://github.com/pooltogether/swappable-yield-source/blob/main/deploy/deploy.ts#L92\">https://github.com/pooltogether/swappable-yield-source/blob/main/deploy/deploy.ts#L92</a></p>\n</blockquote>\n<h2 id=\"l-02-missing-zero-address-checks\" style=\"position:relative;\"><a href=\"#l-02-missing-zero-address-checks\" aria-label=\"l 02 missing zero address checks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/41\">[L-02] Missing zero-address checks</a></h2>\n<p><em>Submitted by 0xRajeev</em></p>\n<p>Zero-address checks as input validation closest to the function beginning is a best-practice. There are two places where an explicit zero-address check is missing which may lead to a later revert, gas wastage or even token burn.</p>\n<ol>\n<li>Explicit zero-address check is missing <a href=\"https://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/contracts/SwappableYieldSource.sol#L269\">here</a> for <code>_newYieldSource</code>\nand will revert later down the control flow on <a href=\"https://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/contracts/SwappableYieldSource.sol#L256\">L256</a>.</li>\n<li>Missing zero-address check on ‘to’ address will lead to token burn because imBalances accounts it for the zero-address from which it can never be redeemed using <code>msg.sender</code>:\n<a href=\"https://github.com/pooltogether/pooltogether-mstable/blob/0bcbd363936fadf5830e9c48392415695896ddb5/contracts/yield-source/MStableYieldSource.sol#L85\"><code>MStableYieldSource.sol</code> L85</a></li>\n</ol>\n<p><a href=\"https://github.com/pooltogether/pooltogether-mstable/blob/0bcbd363936fadf5830e9c48392415695896ddb5/contracts/yield-source/MStableYieldSource.sol#L94\"><code>MStableYieldSource.sol</code> L94</a></p>\n<p>Recommend adding explicit zero-address checks closest to the function entry.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/41#issuecomment-898018680\">PierrickGT (PoolTogether) confirmed</a>:</strong></p>\n<blockquote>\n<p>Swappable Yield Source PR: <a href=\"https://github.com/pooltogether/swappable-yield-source/pull/13\">https://github.com/pooltogether/swappable-yield-source/pull/13</a></p>\n</blockquote>\n<h2 id=\"l-03-onlyowner-for-approvemaxamount-is-risky\" style=\"position:relative;\"><a href=\"#l-03-onlyowner-for-approvemaxamount-is-risky\" aria-label=\"l 03 onlyowner for approvemaxamount is risky permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/44\">[L-03] <code>onlyOwner</code> for <code>approveMaxAmount()</code> is risky</a></h2>\n<p><em>Submitted by 0xRajeev</em></p>\n<p><code>approveMaxAmount()</code> is <code>onlyOwner</code> while all other privileged functions use <code>onlyOwnerOrAssetManager</code>. This modifier should also be <code>onlyOwnerOrAssetManager</code> to prevent situations where owner has added asset managers and renounced ownership which will prevent accessing this approval function thereafter.</p>\n<p>Recommend change <code>onlyOwner</code> to <code>onlyOwnerOrAssetManager</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/44#issuecomment-897140604\">PierrickGT (PoolTogether) acknowledged</a>:</strong></p>\n<blockquote>\n<p>We have decided to only allow the owner to run <code>approveMaxAmount</code> for an added layer of security.\nFor Swappable Yield Sources handled by PoolTogether governance, a multi sig will be used to ensure that not a single person has control of it, this way we limit the risk of the owner renouncing ownership.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/44#issuecomment-904818194\">0xean (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The added security here is dubious given the privileges the asset manager currently has.  Would recommend rethinking this approach.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/44#issuecomment-908761542\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>After discussing with the team, we have decided to make <code>approveMaxAmount</code> public in the following commit, since this emergency function should only be called in the case the allowance would have dropped too low.\n<a href=\"https://github.com/pooltogether/swappable-yield-source/pull/9/commits/18e66ae53279d4ef008e271f57fd82500261823f\">https://github.com/pooltogether/swappable-yield-source/pull/9/commits/18e66ae53279d4ef008e271f57fd82500261823f</a></p>\n<p>Also, we have decided to only allow funds to me moved to the current yield source, so this function shouldn’t be used by a malicious actor to steal funds. The changes have been made in the following PR: <a href=\"https://github.com/pooltogether/swappable-yield-source/pull/15\">https://github.com/pooltogether/swappable-yield-source/pull/15</a></p>\n</blockquote>\n<h2 id=\"l-04-overly-permissive-access-control-lets-anyone-approve-max-amount\" style=\"position:relative;\"><a href=\"#l-04-overly-permissive-access-control-lets-anyone-approve-max-amount\" aria-label=\"l 04 overly permissive access control lets anyone approve max amount permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/46\">[L-04] Overly permissive access control lets anyone approve max amount</a></h2>\n<p><em>Submitted by0xRajeev</em></p>\n<p>Overly permissive access control to lets anyone approve max amount. This may be ok but is inconsistent with <code>SwappableYieldSource.sol</code> where the similar function is <code>onlyOwner</code>.\n<code>onlyOwner</code>. See issue page for referenced code.</p>\n<p>Recommend checking requirements/spec and ensure this is ok or else add <code>Ownable</code> inheritance to enforce <code>onlyOwner</code> for this function.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/46#issuecomment-898731678\">PierrickGT (PoolTogether) confirmed patched</a>:</strong></p>\n<blockquote>\n<p>This issue has been fixed in the following commit: <a href=\"https://github.com/pooltogether/pooltogether-mstable/pull/3/commits/41d75dde55fee20caf31b88d3fd61b38caf1663b\">https://github.com/pooltogether/pooltogether-mstable/pull/3/commits/41d75dde55fee20caf31b88d3fd61b38caf1663b</a></p>\n</blockquote>\n<h2 id=\"l-05-swappableyieldsource_requireyieldsource-is-not-a-guarantee-that-you-are-interacting-with-a-valid-yield-source\" style=\"position:relative;\"><a href=\"#l-05-swappableyieldsource_requireyieldsource-is-not-a-guarantee-that-you-are-interacting-with-a-valid-yield-source\" aria-label=\"l 05 swappableyieldsource_requireyieldsource is not a guarantee that you are interacting with a valid yield source permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/11\">[L-05] SwappableYieldSource._requireYieldSource is not a guarantee that you are interacting with a valid yield source</a></h2>\n<p><em>Submitted by GalloDaSballo</em></p>\n<p><a href=\"https://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/contracts/SwappableYieldSource.sol#L74\"><code>SwappableYieldSource.sol</code> L74</a> runs a few checks to see if the function <code>depositToken</code> is implemented.</p>\n<p>Notice that this is not a guarantee that the target is a valid Yield Source.</p>\n<p>This will simply verify that the contract has that method.</p>\n<p>Any malicious attacker could implement that function and then set up the Yield Source to steal funds</p>\n<p>In order to guarantee that the target is a valid Yield Source, you’d want to create a registry of know Yield Sources, perhaps controlled by governance or by the DAO, and check against that.</p>\n<p>Recommend either:</p>\n<ol>\n<li>Create any contract with just a <code>function depositToken returns (address)</code> and you’ll be able to add pass the check.</li>\n<li>Create an on-chain registry of known Yield Sources, either by committee or governance, and use a check against the registry, this will avoid griefing</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/11\">PierrickGT (PoolTogether) disputed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/11#issuecomment-897174512\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>Swappable Yield Sources will be deployed by a multi sig owned by governance, <code>_requireYieldSource</code> function does indeed simply performs a sanity check to be sure that the yield source address passed is implementing the <code>depositToken</code> function. This is to avoid any human error and deploying a swappable yield source that would be unusable cause the address passed wouldn’t be a yield source.</p>\n<p>Deployments of a new swappable yield source will be voted by governance, as will a change of yield source, so it would be pretty time and gas consuming to have also to add any new yield source we which to switch to to a registry,</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/11#issuecomment-904822644\">0xean (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with warden that these checks are not sufficient to deter a malicious implementation. Additionally, switching of the yield source looks to be feasible by the owner (presumably the above mentioned multisig) or the AssetManager which is unclear who controls this address. Leaving open.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/11#issuecomment-908774708\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>We have removed the <code>AssetManager</code> role and <code>Owner</code> will be owned by governance who will vet any change of yield source before going through a vote.</p>\n</blockquote>\n<h2 id=\"l-06-no-input-validation-for-while-setting-up-value-for-immutable-state-variables\" style=\"position:relative;\"><a href=\"#l-06-no-input-validation-for-while-setting-up-value-for-immutable-state-variables\" aria-label=\"l 06 no input validation for while setting up value for immutable state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/15\">[L-06] No input validation for while setting up value for immutable state variables</a></h2>\n<p><em>Submitted by JMukesh</em></p>\n<p>Since immutable state variable cant be change after initialization in constructor, their value should be checked before initialization\n<a href=\"https://github.com/pooltogether/pooltogether-mstable/blob/0bcbd363936fadf5830e9c48392415695896ddb5/contracts/yield-source/MStableYieldSource.sol#L45\"><code>MStableYieldSource.sol</code> L45</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ISavingsContractV2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_savings</span><span class=\"mtk1\">) </span><span class=\"mtk11\">ReentrancyGuard</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// @audit --&gt; there should be a input validation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// As immutable storage variables can not be accessed in the constructor,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// create in-memory variables that can be used instead.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mAssetMemory</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_savings</span><span class=\"mtk1\">.</span><span class=\"mtk11\">underlying</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// infinite approve Savings Contract to transfer mAssets from this contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">mAssetMemory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_savings</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// save to immutable storage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">savings</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_savings</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">mAsset</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">mAssetMemory</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Initialized</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_savings</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Recommend adding a require condition to validate input values.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/15#issuecomment-898769370\">PierrickGT (PoolTogether) confirmed and patched</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/pooltogether/pooltogether-mstable/pull/4\">https://github.com/pooltogether/pooltogether-mstable/pull/4</a></p>\n</blockquote>\n<h2 id=\"l-07-_requireyieldsource-does-not-check-return-value\" style=\"position:relative;\"><a href=\"#l-07-_requireyieldsource-does-not-check-return-value\" aria-label=\"l 07 _requireyieldsource does not check return value permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/60\">[L-07] <code>_requireYieldSource</code> does not check return value</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>_requireYieldSource</code> function performs a low-level status code and parses the return data even if the call failed as it does not check the first return value (<code>success</code>).\nIt could be the case that non-zero data is returned even though the call failed, and the function would return <code>true</code>.</p>\n<p>Check the return value or perform a high-level call using the <code>_yieldSource</code> interface.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/60#issuecomment-897980645\">PierrickGT (PoolTogether) disputed</a>:</strong></p>\n<blockquote>\n<p>As we noticed while testing the contract, <code>staticcall</code> will return the first return value <code>bool success</code> at <code>true</code>, even if we pass a random wallet address instead of a yield source.</p>\n<p><a href=\"https://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/test/SwappableYieldSource.test.ts#L100\">https://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/test/SwappableYieldSource.test.ts#L100</a></p>\n<p>That’s why we have decided to check for <code>depositTokenAddressData.length</code> and the address returned instead of simply relying on <code>success</code>.</p>\n<p><code>isValidYieldSource</code> being initialized at <code>false</code> and the fact that we check the return value, I doubt the function would return <code>true</code> if non zero data is returned from the staticcall and the call failed.</p>\n<p><a href=\"https://github.com/pooltogether/swappable-yield-source/blob/653449cfc94789453753007c5388882f418de32a/contracts/SwappableYieldSource.sol#L79\">https://github.com/pooltogether/swappable-yield-source/blob/653449cfc94789453753007c5388882f418de32a/contracts/SwappableYieldSource.sol#L79</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/60#issuecomment-904826461\">0xean (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>would recommend following best practices with <code>staticcall</code> regardless and still check the boolean return value. Its a trivial amount of gas in a function that wont be called frequently.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/60#issuecomment-908755738\">PierrickGT (PoolTogether) confirmed and patched</a>:</strong></p>\n<blockquote>\n<p>This issue has been fixed in the following commit: <a href=\"https://github.com/pooltogether/swappable-yield-source/pull/9/commits/f4cfedc4665dad4635e92a9f96ec9130055dd44d\">https://github.com/pooltogether/swappable-yield-source/pull/9/commits/f4cfedc4665dad4635e92a9f96ec9130055dd44d</a></p>\n</blockquote>\n<h2 id=\"l-08-_requireyieldsource-not-always-called\" style=\"position:relative;\"><a href=\"#l-08-_requireyieldsource-not-always-called\" aria-label=\"l 08 _requireyieldsource not always called permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/7\">[L-08] <code>_requireYieldSource</code> not always called</a></h2>\n<p><em>Submitted by gpersoon, also found by pauliax</em></p>\n<p>The function initialize of <code>SwappableYieldSource</code> checks that the yield source is valid via <code>_requireYieldSource</code>.\nWhen you change the yield source (via <code>swapYieldSource</code> or <code>setYieldSource</code>), then the function <code>_setYieldSource</code> is called.\nHowever <code>_setYieldSource</code>  doesn’t explicitly check the yield source via <code>_requireYieldSource</code>.</p>\n<p>The risk is low because there is an indirect check, by the following check, which only succeeds is <code>depositToken</code> is present in the new yield source:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_newYieldSource</span><span class=\"mtk1\">.</span><span class=\"mtk11\">depositToken</span><span class=\"mtk1\">() == </span><span class=\"mtk12\">yieldSource</span><span class=\"mtk1\">.</span><span class=\"mtk11\">depositToken</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">&quot;`SwappableYieldSource`/different-deposit-token&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>For maintenance purposes it is more logical to always call <code>_requireYieldSource</code>, especially if the check would be made more extensive in the future.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"98\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"99\"></span><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">( </span><span class=\"mtk12\">IYieldSource</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_yieldSource</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_decimals</span><span class=\"mtk1\">, </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_symbol</span><span class=\"mtk1\">, </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"100\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_requireYieldSource</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_yieldSource</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"101\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"102\"></span><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_requireYieldSource</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IYieldSource</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_yieldSource</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"103\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_yieldSource</span><span class=\"mtk1\">) != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;SwappableYieldSource/yieldSource-not-zero-address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"104\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    (, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositTokenAddressData</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_yieldSource</span><span class=\"mtk1\">).</span><span class=\"mtk11\">staticcall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_yieldSource</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"105\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isInvalidYieldSource</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"106\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">depositTokenAddressData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"107\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">      (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositTokenAddress</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositTokenAddressData</span><span class=\"mtk1\">, (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"108\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">isInvalidYieldSource</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">depositTokenAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"109\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"110\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">isInvalidYieldSource</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;SwappableYieldSource/invalid-yield-source&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"111\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"112\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"113\"></span><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_setYieldSource</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IYieldSource</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newYieldSource</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"114\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_requireDifferentYieldSource</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_newYieldSource</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"115\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_newYieldSource</span><span class=\"mtk1\">.</span><span class=\"mtk11\">depositToken</span><span class=\"mtk1\">() == </span><span class=\"mtk12\">yieldSource</span><span class=\"mtk1\">.</span><span class=\"mtk11\">depositToken</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">&quot;SwappableYieldSource/different-deposit-token&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"116\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"117\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"118\"></span><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_requireDifferentYieldSource</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IYieldSource</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_yieldSource</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"119\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_yieldSource</span><span class=\"mtk1\">) != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yieldSource</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;SwappableYieldSource/same-yield-source&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"120\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>Recommend adding the following statement to <code>_setYieldSource</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_requireYieldSource</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_newYieldSource</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/7#issuecomment-897160115\">PierrickGT (PoolTogether) disputed</a>:</strong></p>\n<blockquote>\n<p>The <code>_requireYieldSource</code> function is only used to verify that we setup the swappable yield source with an actual yield source.</p>\n<p>As noted, we already check that <code>depositToken()</code> exists in the new yield source, so it would be redundant to also add the <code>_requireYieldSource</code> function to perform the same kind of comparaison.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/7#issuecomment-904828034\">0xean (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Disagree with sponsor.  The current implementation doesn’t ensure a fully functional yield source is present.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/7#issuecomment-908775375\">PierrickGT (PoolTogether) commented</a>:</strong></p>\n<blockquote>\n<p>As previously stated, this contract will be owned by governance who will vet any change of yield source before going through a vote.</p>\n</blockquote>\n<h2 id=\"l-09-variable-name-or-isinvalidyieldsource-is-confusion\" style=\"position:relative;\"><a href=\"#l-09-variable-name-or-isinvalidyieldsource-is-confusion\" aria-label=\"l 09 variable name or isinvalidyieldsource is confusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/8\">[L-09] Variable name or <code>isInvalidYieldSource</code> is confusion</a></h2>\n<p><em>Submitted by gpersoon, also found by hickuphh3 and pauliax</em></p>\n<p>The function <code>_requireYieldSource</code> of the contract <code>SwappableYieldSource</code> has a state variable: <code>isInvalidYieldSource</code></p>\n<p>You would expect <code>isInvalidYieldSource</code> == true would mean the yield source is invalid\nHowever in the source code  <code>isInvalidYieldSource</code> == true mean the yield source is valid.</p>\n<p>This is confusing for readers and future maintainers. Future maintainers could easily make a mistake and thus introduce vulnerabilities.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"74\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"75\"></span><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_requireYieldSource</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IYieldSource</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_yieldSource</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"76\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_yieldSource</span><span class=\"mtk1\">) != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;SwappableYieldSource/yieldSource-not-zero-address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"77\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  (, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositTokenAddressData</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_yieldSource</span><span class=\"mtk1\">).</span><span class=\"mtk11\">staticcall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_yieldSource</span><span class=\"mtk1\">.</span><span class=\"mtk12\">depositToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"78\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isInvalidYieldSource</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"79\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">depositTokenAddressData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"80\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositTokenAddress</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">depositTokenAddressData</span><span class=\"mtk1\">, (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"81\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">isInvalidYieldSource</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">depositTokenAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"82\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"83\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">isInvalidYieldSource</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;SwappableYieldSource/invalid-yield-source&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"84\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Recommend changing <code>isInvalidYieldSource</code> to <code>isValidYieldSource</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/8#issuecomment-897740857\">PierrickGT (PoolTogether) confirmed and patched</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/pooltogether/swappable-yield-source/pull/5\">https://github.com/pooltogether/swappable-yield-source/pull/5</a></p>\n</blockquote>\n<h2 id=\"l-10-swappableyieldsourcesol-wrong-reporting-amount-in-fundstransferred-event\" style=\"position:relative;\"><a href=\"#l-10-swappableyieldsourcesol-wrong-reporting-amount-in-fundstransferred-event\" aria-label=\"l 10 swappableyieldsourcesol wrong reporting amount in fundstransferred event permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/28\">[L-10] <code>SwappableYieldSource.sol</code>: Wrong reporting amount in <code>FundsTransferred()</code> event</a></h2>\n<p><em>Submitted by hickuphh3, also found by shw</em></p>\n<p>The <code>FundsTransferred()</code> event in <code>_transferFunds()</code> will report a smaller amount than expected if <code>currentBalance > _amount</code>.</p>\n<p>This would affect applications utilizing event logs like subgraphs.</p>\n<p>Recommend Updating the event emission to <code>emit FundsTransferred(_yieldSource, currentBalance);</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/28#issuecomment-897127401\">PierrickGT (PoolTogether) confirmed and patched</a>:</strong></p>\n<blockquote>\n<p>This issue has been fixed in the following PR: <a href=\"https://github.com/pooltogether/swappable-yield-source/pull/4\">https://github.com/pooltogether/swappable-yield-source/pull/4</a></p>\n</blockquote>\n<h2 id=\"l-11-swappableyieldsource-setyieldsource-should-check-no-deposited-tokens-in-current-yield-source\" style=\"position:relative;\"><a href=\"#l-11-swappableyieldsource-setyieldsource-should-check-no-deposited-tokens-in-current-yield-source\" aria-label=\"l 11 swappableyieldsource setyieldsource should check no deposited tokens in current yield source permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/31\">[L-11] <code>SwappableYieldSource</code>: <code>setYieldSource()</code> should check no deposited tokens in current yield source</a></h2>\n<p><em>Submitted by hickuphh3</em></p>\n<p><code>setYieldSource()</code> changes the current yield source to a new yield source. It has similar functionality as <code>swapYieldSource()</code>, except that it doesn’t transfer deposited funds from the current to the new one. However, it fails to check that it does not have any remaining deposited funds in the current yield source before the transfer.</p>\n<p>It is highly recommended for this check to be in place so that funds aren’t forgotten / unintentionally lost.</p>\n<p>Recommend adding a require check:\n<code>require(yieldSource.balanceOfToken(address(this)); == 0, \"SwappableYieldSource/existing-funds-in-current-yield-source\")</code> **before calling `_setYieldSource()</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/31#issuecomment-897130001\">PierrickGT (PoolTogether) acknowledged</a>:</strong></p>\n<blockquote>\n<p>We have decided to remove <code>setYieldSource</code> and <code>transferFunds</code> functions. When using <code>swapYieldSource</code> to change of yield source, all funds from the old yield source will be moved to the new yield source in one transaction.\n<a href=\"https://github.com/pooltogether/swappable-yield-source/pull/4\">https://github.com/pooltogether/swappable-yield-source/pull/4</a></p>\n</blockquote>\n<h2 id=\"l-12-retrieve-stuck-tokens-from-mstableyieldsource\" style=\"position:relative;\"><a href=\"#l-12-retrieve-stuck-tokens-from-mstableyieldsource\" aria-label=\"l 12 retrieve stuck tokens from mstableyieldsource permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/73\">[L-12] Retrieve stuck tokens from <code>MStableYieldSource</code></a></h2>\n<p><em>Submitted by pauliax</em></p>\n<p>Tokens sent directly to the <code>MStableYieldSource</code> will be stuck forever. Consider adding a function that allows an admin to retrieve stuck tokens:</p>\n<ul>\n<li>Balance of <code>mAsset</code> - total deposited amount of <code>mAsset</code>;</li>\n<li>Similar with credit balances as credits are issued as a separate erc20 token.</li>\n<li>All the other tokens.</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/73#issuecomment-899899348\">PierrickGT (PoolTogether) confirmed</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/pooltogether/pooltogether-mstable/pull/8\">https://github.com/pooltogether/pooltogether-mstable/pull/8</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/73#issuecomment-899981799\">kamescg (PoolTogether commented</a>:</strong></p>\n<blockquote>\n<p>LGTM</p>\n</blockquote>\n<h2 id=\"l-13-validation\" style=\"position:relative;\"><a href=\"#l-13-validation\" aria-label=\"l 13 validation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/74\">[L-13] Validation</a></h2>\n<p><em>Submitted by pauliax</em></p>\n<p>Function <code>supplyTokenTo</code> should check that <code>mAssetAmount</code> and <code>creditsIssued</code> > 0 and to != address(0) or if empty to address is provided, it can replace it with msg.sender to prevent potential burn of funds. function <code>redeemToken</code> should check that <code>mAssetAmount</code> and <code>creditsBurned</code> > 0. function <code>transferERC20</code> should similarly validate erc20Token, to and amount parameters. function <code>_mintShares</code> requires that shares > 0, while <code>_burnShares</code> lacks such requirement.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/74#issuecomment-899810951\">PierrickGT (PoolTogether) disputed</a>:</strong></p>\n<blockquote>\n<p>This report barely describes which functions or contract should be fixed. This is why I disputed the issue.\nA proof of concept should have at least been written down and it would have been perfect if recommended mitigation steps were provided in a clear and precise manner.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/74#issuecomment-904785358\">0xean (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Issue is very poorly written. Warden should take time to clearly articulate the issue and impact.</p>\n<p>That being said, I do agree that a check on MStableYieldSource.supplyTokenTo to ensure the <code>to != address(0)</code> is reasonable.  The mAsset may or may not implement this check, but it would be useful to avoid potential loss of funds.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/74#issuecomment-908436173\">PierrickGT (PoolTogether) confirmed</a>:</strong></p>\n<blockquote>\n<p>This issue has been fixed in the following PR: <a href=\"https://github.com/pooltogether/pooltogether-mstable/pull/10\">https://github.com/pooltogether/pooltogether-mstable/pull/10</a></p>\n</blockquote>\n<h2 id=\"l-14-some-tokens-do-not-have-decimals\" style=\"position:relative;\"><a href=\"#l-14-some-tokens-do-not-have-decimals\" aria-label=\"l 14 some tokens do not have decimals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/2\">[L-14] Some tokens do not have decimals.</a></h2>\n<p><em>Submitted by tensors</em></p>\n<p>There are a few tokens out there that do not use any decimals. As far as I know none of them would be a good yield source, but just in case something comes out, you may want to include the possibility that decimals = 0.\n<a href=\"dhttps://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/contracts/SwappableYieldSource.sol#L116\"><code>SwappableYieldSource.sol</code> L116</a></p>\n<p>Recommend removing the require statement.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/2#issuecomment-896138968\">PierrickGT (PoolTogether) confirmed</a>:</strong></p>\n<blockquote>\n<p>PR: <a href=\"https://github.com/pooltogether/swappable-yield-source/pull/2\">https://github.com/pooltogether/swappable-yield-source/pull/2</a></p>\n</blockquote>\n<h1 id=\"non-critical-findings\" style=\"position:relative;\"><a href=\"#non-critical-findings\" aria-label=\"non critical findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Findings</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/1\">[N-01] Sponsored event not used</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/16\">[N-02] Amount should > 0 in <code>supplyToken()</code> and <code>RedeemToken()</code>  in <code>SwappableYieldSource.sol</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/17\">[N-03] Lack of zero address validation in _requireDifferentYieldSource()</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/69\">[N-04] Incorrect comment about memory</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/72\">[N-05] <code>approveMax</code> in the constructor</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/79\">[N-06] Possible enhancements to supply/redeem full balance</a></li>\n</ul>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/26\">[G-01] SwappableYieldSource.sol: Save depositToken as a storage variable</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/10\">[G-02] MStableYieldSource.sol Public functions that should be declared as external to save gas</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/33\">[G-03] Redundant zero-address check</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/19\">[G-04] MStableYieldSource.sol: <code>approveMax</code> can use mAsset instead of savings.underlying()</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/37\">[G-05] Adding unchecked directive can save gas</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/64\">[G-06] Gas: swapYieldSource</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/18\">[G-07] Increase Solc Optimiser Runs</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/21\">[G-08] MStableYieldSource.sol: Optimise balanceOf()</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/27\">[G-09] SwappableYieldSource.sol: Shorten revert messages</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/65\">[G-10] [Optimization] Use 0.8.4 in MStableYieldSource.sol</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-07-pooltogether-findings/issues/53\">[G-11] Use <code>abi.encodePacked</code> for gas optimization</a></li>\n</ul>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings\">High Risk Findings</a></p>\n<ul>\n<li><a href=\"#h-01-onlyownerorassetmanager-can-swap-yield-source-in-swappableyieldsource-at-any-time-immediately-rugging-all-funds-from-old-yield-source\">[H-01] <code>onlyOwnerOrAssetManager</code> can swap Yield Source in <code>SwappableYieldSource</code> at any time, immediately rugging all funds from old yield source</a></li>\n<li><a href=\"#h-02-redeemtoken-can-fail-for-certain-tokens\">[H-02] <code>redeemToken</code> can fail for certain tokens</a></li>\n<li><a href=\"#h-03-setyieldsource-leads-to-temporary-wrong-results\">[H-03] <code>setYieldSource</code> leads to temporary wrong results</a></li>\n<li><a href=\"#h-04-swappableyieldsource-missing-same-deposit-token-check-in-transferfunds\">[H-04] <code>SwappableYieldSource</code>: Missing same deposit token check in <code>transferFunds()</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-4\">Medium Risk Findings (4)</a></p>\n<ul>\n<li><a href=\"#m-01-single-step-process-for-critical-ownership-transferrenounce-is-risky\">[M-01] Single-step process for critical ownership transfer/renounce is risky</a></li>\n<li><a href=\"#m-02-use-of-safeapprove-will-always-cause-approvemax-to-revert\">[M-02] Use of <code>safeApprove</code> will always cause <code>approveMax</code> to revert</a></li>\n<li><a href=\"#m-03-inconsistent-balance-when-supplying-transfer-on-fee-or-deflationary-tokens\">[M-03] Inconsistent balance when supplying transfer-on-fee or deflationary tokens</a></li>\n<li><a href=\"#m-04-old-yield-source-still-has-infinite-approval\">[M-04] Old yield source still has infinite approval</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-findings\">Low Risk Findings</a></p>\n<ul>\n<li><a href=\"#l-01-initialization-function-can-be-front-run-with-malicious-values\">[L-01] Initialization function can be front-run with malicious values</a></li>\n<li><a href=\"#l-02-missing-zero-address-checks\">[L-02] Missing zero-address checks</a></li>\n<li><a href=\"#l-03-onlyowner-for-approvemaxamount-is-risky\">[L-03] <code>onlyOwner</code> for <code>approveMaxAmount()</code> is risky</a></li>\n<li><a href=\"#l-04-overly-permissive-access-control-lets-anyone-approve-max-amount\">[L-04] Overly permissive access control lets anyone approve max amount</a></li>\n<li><a href=\"#l-05-swappableyieldsource_requireyieldsource-is-not-a-guarantee-that-you-are-interacting-with-a-valid-yield-source\">[L-05] SwappableYieldSource._requireYieldSource is not a guarantee that you are interacting with a valid yield source</a></li>\n<li><a href=\"#l-06-no-input-validation-for-while-setting-up-value-for-immutable-state-variables\">[L-06] No input validation for while setting up value for immutable state variables</a></li>\n<li><a href=\"#l-07-_requireyieldsource-does-not-check-return-value\">[L-07] <code>_requireYieldSource</code> does not check return value</a></li>\n<li><a href=\"#l-08-_requireyieldsource-not-always-called\">[L-08] <code>_requireYieldSource</code> not always called</a></li>\n<li><a href=\"#l-09-variable-name-or-isinvalidyieldsource-is-confusion\">[L-09] Variable name or <code>isInvalidYieldSource</code> is confusion</a></li>\n<li><a href=\"#l-10-swappableyieldsourcesol-wrong-reporting-amount-in-fundstransferred-event\">[L-10] <code>SwappableYieldSource.sol</code>: Wrong reporting amount in <code>FundsTransferred()</code> event</a></li>\n<li><a href=\"#l-11-swappableyieldsource-setyieldsource-should-check-no-deposited-tokens-in-current-yield-source\">[L-11] <code>SwappableYieldSource</code>: <code>setYieldSource()</code> should check no deposited tokens in current yield source</a></li>\n<li><a href=\"#l-12-retrieve-stuck-tokens-from-mstableyieldsource\">[L-12] Retrieve stuck tokens from <code>MStableYieldSource</code></a></li>\n<li><a href=\"#l-13-validation\">[L-13] Validation</a></li>\n<li><a href=\"#l-14-some-tokens-do-not-have-decimals\">[L-14] Some tokens do not have decimals.</a></li>\n</ul>\n</li>\n<li><a href=\"#non-critical-findings\">Non-Critical Findings</a></li>\n<li><a href=\"#gas-optimizations\">Gas Optimizations</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode 432n4 (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the code contest outlined in this document, C4 conducted an analysis of PoolTogether smart contract system written in Solidity. The code contest took place between July 28—July 31.\n\n## Wardens\n\n12 Wardens contributed reports to the PoolTogether micro contest #1 code contest:\n\n1. [0xRajeev](https://twitter.com/0xRajeev)\n2. [gpersoon](https://twitter.com/gpersoon)\n3. [hickuphh3](https://twitter.com/HickupH)\n4. [cmichel](https://twitter.com/cmichelio)\n5. [pauliax](https://twitter.com/SolidityDev)\n6. [GalloDaSballo](https://twitter.com/gallodasballo)\n7. [shw](https://github.com/x9453)\n8. [jonah1005](https://twitter.com/jonah1005w)\n9. [tensors](https://twitter.com/Tensors8)\n10. [hrkrshnn](https://twitter.com/_hrkrshnn)\n11. [Jmukesh](https://twitter.com/MukeshJ_eth)\n12. maplesyrup ([heiho1](https://github.com/heiho1) and [thisguy__](https://twitter.com/eriksal1217))\n\nThis contest was judged by [LSDan](https://twitter.com/lsdan_defi).\n\nFinal report assembled by [moneylegobatman](https://twitter.com/money_lego) and [ninek](https://twitter.com/_ninek_).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 22 unique vulnerabilities. All of the issues presented here are linked back to their original finding\n\nOf these vulnerabilities, 4 received a risk rating in the category of HIGH severity, 4 received a risk rating in the category of MEDIUM severity, and 14 received a risk rating in the category of LOW severity.\n\nC4 analysis also identified 6 non-critical recommendations and 11 gas optimizations.\n\n# Scope\n\nThe code under review can be found within the [C4 PoolTogether micro contest #1 repository](https://github.com/code-423n4/2021-07-pooltogether) is comprised of 2 smart contracts written in the Solidity programming language and includes ~275 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code423n4.com).\n\n# High Risk Findings\n\n## [[H-01] `onlyOwnerOrAssetManager` can swap Yield Source in `SwappableYieldSource` at any time, immediately rugging all funds from old yield source](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/14)\n_Submitted by GalloDaSballo, also found by 0xRajeev and gpersoon_\n\nThe function `swapYieldSource` [SwappableYieldSource.sol` L307](https://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/contracts/SwappableYieldSource.sol#L307)\n\nCan be called by the owner (deployer / initializer) or Asset Manager. The function will take all funds from the old Yield Source, and transfer them to the new Yield source. Any contract that implement the function `function depositToken() external returns (address)` will pass the check\n\nHowever, if either the owner or the `assetManager` have malicious intent, this function allows them to instantly rug all funds\n\n1) Create a contract that implements the `function depositToken() external returns (address)`\n2) Be the Owner or `AssetManager`\n3) Call `setYieldSource` while pointing at your malicious contract\n4) Profit\n\nI highly recommend checking that the `YieldSource` is from a trusted registry before allowing this swap.\n\nAlternatively forcing each `Owner` to be a `TimeLock` with at least 48 hours may provide enough security to allow this to be used in practice\n\n**[PierrickGT (PoolTogether) disputed](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/14#issuecomment-897195417):**\n > This is why we will use a multi sig owned by governance to deploy swappable yield sources and manage them. This way, we will avoid these kind of scenarios.\n\n**[0xean (Judge) commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/14#issuecomment-904860248):**\n > Agree with warden on the risk here. Will both the AssetManager and the Owner be owned by your governance?\n>\n> The YieldSource could easily extract user funds or send them back to the SwappableYieldSource contract and then remove them from there.\n\n**[PierrickGT (PoolTogether) commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/14#issuecomment-908774312):**\n > We have removed the `AssetManager` role and `Owner` will be owned by governance who will vet any change of yield source before going through a vote.\n\n## [[H-02] `redeemToken` can fail for certain tokens](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/61)\n_Submitted by cmichel, also found by hickuphh3, pauliax and jonah1005XXX_\n\nThe `SwappableYieldSource.redeemToken` function transfers tokens from the contract back to the sender, however, it uses the `ERC20.transferFrom(address(this), msg.sender, redeemableBalance)` function for this.\nSome deposit token implementations might fail as `transferFrom` checks if the contract approved itself for the `redeemableBalance` instead of skipping the allowance check in case the sender is the `from` address.\n\nThis can make the transaction revert and the deposited funds will be unrecoverable for the user.\n\nIt's recommended to use `_depositToken.safeTransfer(msg.sender, redeemableBalance)` instead.\n\n**[PierrickGT (PoolTogether) commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/61#issuecomment-894368935):**\n > Duplicate of https://github.com/code-423n4/2021-07-pooltogether-findings/issues/25\n\n**[0xean (Judge) commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/61#issuecomment-904799020):**\n > re-opening this issue and marking #25 as a duplicate of this issue which clearly articulates the potential severity of unrecoverable user funds.\n\n**[PierrickGT (PoolTogether) resolved](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/61#issuecomment-908446620):**\n > This issue has been fixed and we are now using `safeTransfer`: https://github.com/pooltogether/swappable-yield-source/blob/bf943b3818b81d5f5cb9d8ecc6f13ffecd33a1ff/contracts/SwappableYieldSource.sol#L235\n\n\n## [[H-03] `setYieldSource` leads to temporary wrong results](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/4)\n_Submitted by gpersoon_\n\nThe use of `setYieldSource` leaves the contract in a temporary inconsistent state because it changes the underlying yield source,\nbut doesn't (yet) transfer the underlying balances, while the shares stay the same.\n\nThe function `balanceOfToken` will show the wrong results, because it is based on `_sharesToToken`, which uses `yieldSource.balanceOfToken(address(this))`, that isn't updated yet.\n\nMore importantly `supplyTokenTo` will give the wrong amount of shares back:\nFirst it supplies tokens to the `yieldsource`.\nThen is calls `_mintShares`, which calls `_tokenToShares`, which calculates the shares, using `yieldSource.balanceOfToken(address(this))`\nThis `yieldSource.balanceOfToken(address(this))` only contains the just supplied tokens, but doesn't include the tokens from the previous `YieldSource`.\nSo the wrong amount of shares is given back to the user; they will be given more shares than appropriate which means they can drain funds later on (once `transferFunds` has been done).\n\nIt is possible to make use of this problem in the following way:\n- monitor the blockchain until you see `setYieldSource` has been done\n- immediately call the function `supplyTokenTo` (which can be called because there is no access control on this function)\n\n```solidity\n// https://github.com/pooltogether/swappable-yield-source/blob/main/contracts/SwappableYieldSource.sol\nfunction setYieldSource(IYieldSource _newYieldSource) external `onlyOwnerOrAssetManager` returns (bool) {\n  _setYieldSource(_newYieldSource);\n\nfunction _setYieldSource(IYieldSource _newYieldSource) internal {\n..\n    yieldSource = _newYieldSource;\n\n function supplyTokenTo(uint256 amount, address to) external override nonReentrant {\n   ..\n    yieldSource.supplyTokenTo(amount, address(this));\n    _mintShares(amount, to);\n  }\n\n function _mintShares(uint256 mintAmount, address to) internal {\n    uint256 shares = `_tokenToShares`(mintAmount);\n    require(shares > 0, \"SwappableYieldSource/shares-gt-zero\");\n    _mint(to, shares);\n  }\n\n function _tokenToShares(uint256 tokens) internal returns (uint256) {\n    uint256 shares;\n    uint256 _totalSupply = totalSupply();\n..\n      uint256 exchangeMantissa = FixedPoint.calculateMantissa(_totalSupply, yieldSource.balanceOfToken(address(this))); // based on incomplete yieldSource.balanceOfToken(address(this))\n      shares = FixedPoint.multiplyUintByMantissa(tokens, exchangeMantissa);\n\n\nfunction balanceOfToken(address addr) external override returns (uint256) {\n    return _sharesToToken(balanceOf(addr));\n  }\n\n function _sharesToToken(uint256 shares) internal returns (uint256) {\n    uint256 tokens;\n    uint256 _totalSupply = totalSupply();\n..\n      uint256 exchangeMantissa = FixedPoint.calculateMantissa(yieldSource.balanceOfToken(address(this)), _totalSupply); // based on incomplete yieldSource.balanceOfToken(address(this))\n      tokens = FixedPoint.multiplyUintByMantissa(shares, exchangeMantissa);\n```\n\nReocommend removing the function `setYieldSource`  (e.g. only leave `swapYieldSource`)\nOr temporally disable actions like `supplyTokenTo`, `redeemToken` and balanceOfToken, after `setYieldSource` and until `transferFunds` has been done.\n\n**[PierrickGT (PoolTogether) confirmed and resolved](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/4#issuecomment-896981238):**\n > PR: https://github.com/pooltogether/swappable-yield-source/pull/4\n> We've mitigated this issue by removing the `transferFunds` and `setYieldSource` external functions and making `swapYieldSource` callable only by the owner that will be a multi sig wallet for governance pools.\n\n## [[H-04] `SwappableYieldSource`: Missing same deposit token check in `transferFunds()`](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/29)\n_Submitted by hickuphh3, also found by 0xRajeev_\n\n`transferFunds()` will transfer funds from a specified yield source `_yieldSource` to the current yield source set in the contract `_currentYieldSource`. However, it fails to check that the deposit tokens are the same. If the specified yield source's assets are of a higher valuation, then a malicious owner or asset manager will be able to exploit and pocket the difference.\n\nAssumptions:\n- `_yieldSource` has a deposit token of WETH (18 decimals)\n- `_currentYieldSource` has a deposit token of DAI (18 decimals)\n- 1 WETH > 1 DAI (definitely true, I'd be really sad otherwise)\n\nAttacker does the following:\n1. Deposit 100 DAI into the swappable yield source contract\n2. Call `transferFunds(_yieldSource, 100 * 1e18)`\n    - `_requireDifferentYieldSource()` passes\n    - `_transferFunds(_yieldSource, 100 * 1e18)` is called\n        - `_yieldSource.redeemToken(_amount);` → This will transfer 100 WETH out of the `_yieldSource` into the contract\n        - `uint256 currentBalance = IERC20Upgradeable(_yieldSource.depositToken()).balanceOf(address(this));` → This will equate to ≥ 100 WETH.\n        - `require(_amount <= currentBalance, \"SwappableYieldSource/transfer-amount-different\");` is true since both are `100 * 1e18`\n        - `_currentYieldSource.supplyTokenTo(currentBalance, address(this));` → This supplies the transferred 100 DAI from step 1 to the current yield source\n    - We now have 100 WETH in the swappable yield source contract\n3. Call `transferERC20(WETH, attackerAddress, 100 * 1e18)` to withdraw 100 WETH out of the contract to the attacker's desired address.\n\n`_requireDifferentYieldSource()` should also verify that the yield sources' deposit token addresses are the same.\n\n```jsx\nfunction _requireDifferentYieldSource(IYieldSource _yieldSource) internal view {\n    require(address(_yieldSource) != address(yieldSource), \"SwappableYieldSource/same-yield-source\");\n\t\trequire(_newYieldSource.depositToken() == yieldSource.depositToken(), \"SwappableYieldSource/different-deposit-token\");\n}\n```\n\n**[PierrickGT (PoolTogether) acknowledged](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/29#issuecomment-897208429):**\n > This exploit was indeed possible when we had the `transferFunds` function but now that we have removed it and funds can only be moved by `swapYieldSource()`, this exploit is no longer possible since we check for the same `depositToken` in `_setYieldSource()`.\n>\n> https://github.com/pooltogether/swappable-yield-source/pull/4\n\n**[0xean (Judge) commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/29#issuecomment-904807211):**\n > Upgrading to 3 considering the potential for loss of funds\n\n# Medium Risk Findings (4)\n\n## [[M-01] Single-step process for critical ownership transfer/renounce is risky](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/40)\n_Submitted by 0xRajeev_\n\nThe `SwappableYieldSource` allows owners and asset managers to set/swap/transfer yield sources/funds. As such, the contract ownership plays a critical role in the protocol.\n\nGiven that `AssetManager` is derived from `Ownable`, the ownership management of this contract defaults to `Ownable`’s `transferOwnership()` and `renounceOwnership()` methods which are not overridden here. Such critical address transfer/renouncing in one-step is very risky because it is irrecoverable from any mistakes.\n\nScenario: If an incorrect address, e.g. for which the private key is not known, is used accidentally then it prevents the use of all the `onlyOwner()` functions forever, which includes the changing of various critical addresses and parameters. This use of incorrect address may not even be immediately apparent given that these functions are probably not used immediately. When noticed, due to a failing `onlyOwner()`  or `onlyOwnerOrAssetManager()` function call, it will force the redeployment of these contracts and require appropriate changes and notifications for switching from the old to new address. This will diminish trust in the protocol and incur a significant reputational damage.\n\nSee similar [High Risk severity finding](https://github.com/trailofbits/publications/blob/master/reviews/hermez.pdf) from Trail-of-Bits Audit of Hermez.\n\nSee similar[ Medium Risk severity](https://github.com/Uniswap/uniswap-v3-core/blob/main/audits/tob/audit.pdf) finding from Trail-of-Bits Audit of Uniswap V3:\n\nRecommend overriding the inherited methods to null functions and use separate functions for a two-step address change:\n1) Approve a new address as a `pendingOwner`\n2) A transaction from the `pendingOwner` address claims the pending ownership change.\n\nThis mitigates risk because if an incorrect address is used in step (1) then it can be fixed by re-approving the correct address. Only after a correct address is used in step (1) can step (2) happen and complete the address/ownership change.\n\nAlso, consider adding a time-delay for such sensitive actions. And at a minimum, use a multisig owner address and not an EOA.\n\n**[PierrickGT (PoolTogether) disputed](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/40#issuecomment-897217286):**\n > This isn't a security issue but an improper use of the `initialize` function.\n> We do check for address zero so at least the risk of deploying the contract with address zero is excluded. Also, these contracts will be deployed by a multi sig owned by governance so the risk of a single human error is almost null.\n\n**[0xean (Judge) commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/40#issuecomment-904802425):**\n > Disagree with sponsor.  A two step process would be a safer implementation.  A multi-sig does not remove human error or the potential risk here. It may be an acceptable risk to the team, but still worth highlighting with the given severity.\n\n**[PierrickGT (PoolTogether) acknowledged](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/40#issuecomment-908780172):**\n > We have studied this solution and decided to not implement it since it would make it a pretty tedious process to deploy a swappable yield source, especially through the use of our builder which would mean that a user would have to manually `claimOwnership` after deploying a pool. Plus, this contract will be owned by governance so it will be very difficult to transfer it to another owner or renounce ownership.\n\n## [[M-02] Use of `safeApprove` will always cause `approveMax` to revert](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/47)\n_Submitted by 0xRajeev, also found by pauliax, shw, and cmichel_\n\nUnlike `SwappableYieldSource` which uses `safeIncreaseAllowance` to increase the allowance to `uint256.max`, `mStableYieldSource` uses OpenZeppelin’s `safeApprove()` which has been documented as (1) Deprecated because of approve-like race condition and (2) To be used only for initial setting of allowance `(current allowance == 0)` or resetting to 0 because it reverts otherwise.\n\nThe usage here is intended to allow increase of allowance when it falls low similar to the documented usage in `SwappableYieldSource`. Using it for that scenario will not work as expected because it will always revert if current allowance is != 0. The initial allowance is already set as `uint256.max` in constructor. And once it gets reduced, it can never be increased using this function unless it is invoked when allowance is reduced completely to 0. See issue page for referenced code.\n\nRecommend Using logic similar to `SwappableYieldSource` instead of using `safeApprove()`.\n\n**[PierrickGT (PoolTogether) confirmed](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/47#issuecomment-898731351):**\n > This issue has been fixed in the following commit: https://github.com/pooltogether/pooltogether-mstable/pull/3/commits/156a990901e6ddff543897905e3ea3d09c78d817\n\n## [[M-03] Inconsistent balance when supplying transfer-on-fee or deflationary tokens](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/52)\n_Submitted by shw, also found by cmichel_\n\nThe `supplyTokenTo` function of `SwappableYieldSource` assumes that `amount` of `_depositToken` is transferred to itself after calling the `safeTransferFrom` function (and thus it supplies `amount` of token to the yield source). However, this may not be true if the `_depositToken` is a transfer-on-fee token or a deflationary/rebasing token, causing the received amount to be less than the accounted amount. [SwappableYieldSource.sol L211-L212](https://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/contracts/SwappableYieldSource.sol#L211-L212)\n\nRecommend getting the actual received amount by calculating the difference of token balance before and after the transfer. For example, re-writing line 211-212 to:\n\n```solidity\nuint256 balanceBefore = _depositToken.balanceOf(address(this));\n_depositToken.safeTransferFrom(msg.sender, address(this), amount);\nuint256 receivedAmount = _depositToken.balanceOf(address(this)) - balanceBefore;\nyieldSource.supplyTokenTo(receivedAmount, address(this));\n```\n\n**[PierrickGT (PoolTogether) confirmed](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/52#issuecomment-897951282):**\n > PR: https://github.com/pooltogether/swappable-yield-source/pull/9\n\n## [[M-04] Old yield source still has infinite approval](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/3)\n_Submitted by tensors, also found by hickuphh3, cmichel and GalloDaSballo_\n\nAfter swapping a yield source, the old yield source still has infinite approval. Infinite approval has been used in large attacks if the yield source isn't perfectly safe ([see furucombo](https://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/contracts/SwappableYieldSource.sol#L268)).\n\nRecommend decreasing approval after swapping the yield source.\n\n**[PierrickGT (PoolTogether) confirmed](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/3#issuecomment-896357783):**\n > PR: https://github.com/pooltogether/swappable-yield-source/pull/3\n\n# Low Risk Findings\n\n## [[L-01] Initialization function can be front-run with malicious values](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/39)\n_Submitted by 0xRajeev, also found by cmichel_\n\nThe `SwappableYieldSource.sol` has a public visibility initialization function that can be front-run, allowing an attacker to incorrectly initialize the contract, if the deployment of this contract does not safely handle initializations via a robust deployment script or a factory contract to prevent front-running.\n\nImpact: Initialization function can be front-run by attackers, allowing them to initialize the contract with malicious values. Also, if initializations are not done atomically with creation, all public/external functions can be accessed before initialization because there are no checks to confirm initializations in those functions.\n\nReference: See [similar High-severity Finding 9 of Trail of Bits audit of Advanced Blockchain](https://github.com/trailofbits/publications/blob/master/reviews/AdvancedBlockchain.pdf) and [Finding 12 from Trail of Bits audit of Hermez Network](https://github.com/trailofbits/publications/blob/master/reviews/hermez.pdf).\n\nRecommend ensuring atomic creation+deployment with script or factory contract. Add checks to confirm initialization in public/external functions.\n\n**[0xean (Judge) disputed](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/39#issuecomment-904813275):**\n > The freeze function is not atomic with the deployment and the script does not enforce that that call is made before moving on to further deployments. The script could enforce that the contract has not been initialized which would at least somewhat mitigate the impacts of a potential front run.\n\n**[PierrickGT (PoolTogether) commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/39#issuecomment-908820695):**\n > We are using a factory contract to deploy the Swappable Yield Source so there is no risk of front running: https://github.com/pooltogether/swappable-yield-source/blob/main/deploy/deploy.ts#L92\n\n## [[L-02] Missing zero-address checks](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/41)\n_Submitted by 0xRajeev_\n\nZero-address checks as input validation closest to the function beginning is a best-practice. There are two places where an explicit zero-address check is missing which may lead to a later revert, gas wastage or even token burn.\n\n1. Explicit zero-address check is missing [here](https://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/contracts/SwappableYieldSource.sol#L269) for `_newYieldSource`\n and will revert later down the control flow on [L256](https://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/contracts/SwappableYieldSource.sol#L256).\n\n2. Missing zero-address check on ‘to’ address will lead to token burn because imBalances accounts it for the zero-address from which it can never be redeemed using `msg.sender`:\n[`MStableYieldSource.sol` L85](https://github.com/pooltogether/pooltogether-mstable/blob/0bcbd363936fadf5830e9c48392415695896ddb5/contracts/yield-source/MStableYieldSource.sol#L85)\n\n[`MStableYieldSource.sol` L94](https://github.com/pooltogether/pooltogether-mstable/blob/0bcbd363936fadf5830e9c48392415695896ddb5/contracts/yield-source/MStableYieldSource.sol#L94)\n\nRecommend adding explicit zero-address checks closest to the function entry.\n\n**[PierrickGT (PoolTogether) confirmed](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/41#issuecomment-898018680):**\n > Swappable Yield Source PR: https://github.com/pooltogether/swappable-yield-source/pull/13\n\n## [[L-03] `onlyOwner` for `approveMaxAmount()` is risky](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/44)\n_Submitted by 0xRajeev_\n\n`approveMaxAmount()` is `onlyOwner` while all other privileged functions use `onlyOwnerOrAssetManager`. This modifier should also be `onlyOwnerOrAssetManager` to prevent situations where owner has added asset managers and renounced ownership which will prevent accessing this approval function thereafter.\n\nRecommend change `onlyOwner` to `onlyOwnerOrAssetManager`.\n\n**[PierrickGT (PoolTogether) acknowledged](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/44#issuecomment-897140604):**\n > We have decided to only allow the owner to run `approveMaxAmount` for an added layer of security.\n> For Swappable Yield Sources handled by PoolTogether governance, a multi sig will be used to ensure that not a single person has control of it, this way we limit the risk of the owner renouncing ownership.\n\n**[0xean (Judge) commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/44#issuecomment-904818194):**\n > The added security here is dubious given the privileges the asset manager currently has.  Would recommend rethinking this approach.\n\n**[PierrickGT (PoolTogether) commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/44#issuecomment-908761542):**\n > After discussing with the team, we have decided to make `approveMaxAmount` public in the following commit, since this emergency function should only be called in the case the allowance would have dropped too low.\n> https://github.com/pooltogether/swappable-yield-source/pull/9/commits/18e66ae53279d4ef008e271f57fd82500261823f\n>\n> Also, we have decided to only allow funds to me moved to the current yield source, so this function shouldn't be used by a malicious actor to steal funds. The changes have been made in the following PR: https://github.com/pooltogether/swappable-yield-source/pull/15\n>\n\n## [[L-04] Overly permissive access control lets anyone approve max amount](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/46)\n_Submitted by0xRajeev_\n\nOverly permissive access control to lets anyone approve max amount. This may be ok but is inconsistent with `SwappableYieldSource.sol` where the similar function is `onlyOwner`.\n`onlyOwner`. See issue page for referenced code.\n\nRecommend checking requirements/spec and ensure this is ok or else add `Ownable` inheritance to enforce `onlyOwner` for this function.\n\n**[PierrickGT (PoolTogether) confirmed patched](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/46#issuecomment-898731678):**\n > This issue has been fixed in the following commit: https://github.com/pooltogether/pooltogether-mstable/pull/3/commits/41d75dde55fee20caf31b88d3fd61b38caf1663b\n\n## [[L-05] SwappableYieldSource._requireYieldSource is not a guarantee that you are interacting with a valid yield source](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/11)\n_Submitted by GalloDaSballo_\n\n[`SwappableYieldSource.sol` L74](https://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/contracts/SwappableYieldSource.sol#L74) runs a few checks to see if the function `depositToken` is implemented.\n\nNotice that this is not a guarantee that the target is a valid Yield Source.\n\nThis will simply verify that the contract has that method.\n\nAny malicious attacker could implement that function and then set up the Yield Source to steal funds\n\nIn order to guarantee that the target is a valid Yield Source, you'd want to create a registry of know Yield Sources, perhaps controlled by governance or by the DAO, and check against that.\n\nRecommend either:\n1. Create any contract with just a `function depositToken returns (address)` and you'll be able to add pass the check.\n2. Create an on-chain registry of known Yield Sources, either by committee or governance, and use a check against the registry, this will avoid griefing\n\n**[PierrickGT (PoolTogether) disputed](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/11)**\n\n**[PierrickGT (PoolTogether) commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/11#issuecomment-897174512):**\n > Swappable Yield Sources will be deployed by a multi sig owned by governance, `_requireYieldSource` function does indeed simply performs a sanity check to be sure that the yield source address passed is implementing the `depositToken` function. This is to avoid any human error and deploying a swappable yield source that would be unusable cause the address passed wouldn't be a yield source.\n>\n> Deployments of a new swappable yield source will be voted by governance, as will a change of yield source, so it would be pretty time and gas consuming to have also to add any new yield source we which to switch to to a registry,\n\n**[0xean (Judge) commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/11#issuecomment-904822644):**\n > Agree with warden that these checks are not sufficient to deter a malicious implementation. Additionally, switching of the yield source looks to be feasible by the owner (presumably the above mentioned multisig) or the AssetManager which is unclear who controls this address. Leaving open.\n\n**[PierrickGT (PoolTogether) commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/11#issuecomment-908774708):**\n > We have removed the `AssetManager` role and `Owner` will be owned by governance who will vet any change of yield source before going through a vote.\n\n## [[L-06] No input validation for while setting up value for immutable state variables](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/15)\n_Submitted by JMukesh_\n\nSince immutable state variable cant be change after initialization in constructor, their value should be checked before initialization\n[`MStableYieldSource.sol` L45](https://github.com/pooltogether/pooltogether-mstable/blob/0bcbd363936fadf5830e9c48392415695896ddb5/contracts/yield-source/MStableYieldSource.sol#L45)\n```solidity\nconstructor(ISavingsContractV2 _savings) ReentrancyGuard() {\n\n  // @audit --> there should be a input validation\n\n  // As immutable storage variables can not be accessed in the constructor,\n  // create in-memory variables that can be used instead.\n  IERC20 mAssetMemory = IERC20(_savings.underlying());\n\n  // infinite approve Savings Contract to transfer mAssets from this contract\n  mAssetMemory.safeApprove(address(_savings), type(uint256).max);\n\n  // save to immutable storage\n  savings = _savings;\n  mAsset = mAssetMemory;\n\n  emit Initialized(_savings);\n}\n```\n\nRecommend adding a require condition to validate input values.\n\n**[PierrickGT (PoolTogether) confirmed and patched](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/15#issuecomment-898769370):**\n > PR: https://github.com/pooltogether/pooltogether-mstable/pull/4\n\n## [[L-07] `_requireYieldSource` does not check return value](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/60)\n_Submitted by cmichel_\n\nThe `_requireYieldSource` function performs a low-level status code and parses the return data even if the call failed as it does not check the first return value (`success`).\nIt could be the case that non-zero data is returned even though the call failed, and the function would return `true`.\n\nCheck the return value or perform a high-level call using the `_yieldSource` interface.\n\n**[PierrickGT (PoolTogether) disputed](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/60#issuecomment-897980645):**\n > As we noticed while testing the contract, `staticcall` will return the first return value `bool success` at `true`, even if we pass a random wallet address instead of a yield source.\n>\n> https://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/test/SwappableYieldSource.test.ts#L100\n>\n> That's why we have decided to check for `depositTokenAddressData.length` and the address returned instead of simply relying on `success`.\n>\n> `isValidYieldSource` being initialized at `false` and the fact that we check the return value, I doubt the function would return `true` if non zero data is returned from the staticcall and the call failed.\n>\n> https://github.com/pooltogether/swappable-yield-source/blob/653449cfc94789453753007c5388882f418de32a/contracts/SwappableYieldSource.sol#L79\n\n**[0xean (Judge) commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/60#issuecomment-904826461):**\n > would recommend following best practices with `staticcall` regardless and still check the boolean return value. Its a trivial amount of gas in a function that wont be called frequently.\n\n**[PierrickGT (PoolTogether) confirmed and patched](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/60#issuecomment-908755738):**\n > This issue has been fixed in the following commit: https://github.com/pooltogether/swappable-yield-source/pull/9/commits/f4cfedc4665dad4635e92a9f96ec9130055dd44d\n\n## [[L-08] `_requireYieldSource` not always called](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/7)\n_Submitted by gpersoon, also found by pauliax_\n\nThe function initialize of `SwappableYieldSource` checks that the yield source is valid via `_requireYieldSource`.\nWhen you change the yield source (via `swapYieldSource` or `setYieldSource`), then the function `_setYieldSource` is called.\nHowever `_setYieldSource`  doesn't explicitly check the yield source via `_requireYieldSource`.\n\nThe risk is low because there is an indirect check, by the following check, which only succeeds is `depositToken` is present in the new yield source:\n```solidity\n     require(_newYieldSource.depositToken() == yieldSource.depositToken(), \"`SwappableYieldSource`/different-deposit-token\");\n```\nFor maintenance purposes it is more logical to always call `_requireYieldSource`, especially if the check would be made more extensive in the future.\n```solidity\n//https://github.com/pooltogether/swappable-yield-source/blob/main/contracts/SwappableYieldSource.sol#L98\nfunction initialize( IYieldSource _yieldSource, uint8 _decimals, string calldata _symbol, string calldata _name, address _owner) public initializer returns (bool) {\n    _requireYieldSource(_yieldSource);\n\n function _requireYieldSource(IYieldSource _yieldSource) internal view {\n    require(address(_yieldSource) != address(0), \"SwappableYieldSource/yieldSource-not-zero-address\");\n    (, bytes memory depositTokenAddressData) = address(_yieldSource).staticcall(abi.encode(_yieldSource.depositToken.selector));\n    bool isInvalidYieldSource;\n    if (depositTokenAddressData.length > 0) {\n      (address depositTokenAddress) = abi.decode(depositTokenAddressData, (address));\n      isInvalidYieldSource = depositTokenAddress != address(0);\n    }\n    require(isInvalidYieldSource, \"SwappableYieldSource/invalid-yield-source\");\n  }\n\n function _setYieldSource(IYieldSource _newYieldSource) internal {\n    _requireDifferentYieldSource(_newYieldSource);\n    require(_newYieldSource.depositToken() == yieldSource.depositToken(), \"SwappableYieldSource/different-deposit-token\");\n...\n\n function _requireDifferentYieldSource(IYieldSource _yieldSource) internal view {\n    require(address(_yieldSource) != address(yieldSource), \"SwappableYieldSource/same-yield-source\");\n  }\n```\n\nRecommend adding the following statement to `_setYieldSource`:\n```solidity\n_requireYieldSource(_newYieldSource);\n```\n\n**[PierrickGT (PoolTogether) disputed](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/7#issuecomment-897160115):**\n > The `_requireYieldSource` function is only used to verify that we setup the swappable yield source with an actual yield source.\n>\n> As noted, we already check that `depositToken()` exists in the new yield source, so it would be redundant to also add the `_requireYieldSource` function to perform the same kind of comparaison.\n\n**[0xean (Judge) commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/7#issuecomment-904828034):**\n > Disagree with sponsor.  The current implementation doesn't ensure a fully functional yield source is present.\n\n**[PierrickGT (PoolTogether) commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/7#issuecomment-908775375):**\n > As previously stated, this contract will be owned by governance who will vet any change of yield source before going through a vote.\n\n\n## [[L-09] Variable name or `isInvalidYieldSource` is confusion](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/8)\n_Submitted by gpersoon, also found by hickuphh3 and pauliax_\n\nThe function `_requireYieldSource` of the contract `SwappableYieldSource` has a state variable: `isInvalidYieldSource`\n\nYou would expect `isInvalidYieldSource` == true would mean the yield source is invalid\nHowever in the source code  `isInvalidYieldSource` == true mean the yield source is valid.\n\nThis is confusing for readers and future maintainers. Future maintainers could easily make a mistake and thus introduce vulnerabilities.\n\n```solidity\n// https://github.com/pooltogether/swappable-yield-source/blob/main/contracts/SwappableYieldSource.sol#L74\nfunction _requireYieldSource(IYieldSource _yieldSource) internal view {\n  require(address(_yieldSource) != address(0), \"SwappableYieldSource/yieldSource-not-zero-address\");\n  (, bytes memory depositTokenAddressData) = address(_yieldSource).staticcall(abi.encode(_yieldSource.depositToken.selector));\n  bool isInvalidYieldSource;\n  if (depositTokenAddressData.length > 0) {\n    (address depositTokenAddress) = abi.decode(depositTokenAddressData, (address));\n    isInvalidYieldSource = depositTokenAddress != address(0);\n  }\n  require(isInvalidYieldSource, \"SwappableYieldSource/invalid-yield-source\");\n}\n```\n\nRecommend changing `isInvalidYieldSource` to `isValidYieldSource`\n\n**[PierrickGT (PoolTogether) confirmed and patched](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/8#issuecomment-897740857):**\n > PR: https://github.com/pooltogether/swappable-yield-source/pull/5\n\n## [[L-10] `SwappableYieldSource.sol`: Wrong reporting amount in `FundsTransferred()` event](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/28)\n_Submitted by hickuphh3, also found by shw_\n\nThe `FundsTransferred()` event in `_transferFunds()` will report a smaller amount than expected if `currentBalance > _amount`.\n\nThis would affect applications utilizing event logs like subgraphs.\n\nRecommend Updating the event emission to `emit FundsTransferred(_yieldSource, currentBalance);`\n\n**[PierrickGT (PoolTogether) confirmed and patched](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/28#issuecomment-897127401):**\n > This issue has been fixed in the following PR: https://github.com/pooltogether/swappable-yield-source/pull/4\n\n## [[L-11] `SwappableYieldSource`: `setYieldSource()` should check no deposited tokens in current yield source](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/31)\n_Submitted by hickuphh3_\n\n`setYieldSource()` changes the current yield source to a new yield source. It has similar functionality as `swapYieldSource()`, except that it doesn't transfer deposited funds from the current to the new one. However, it fails to check that it does not have any remaining deposited funds in the current yield source before the transfer.\n\nIt is highly recommended for this check to be in place so that funds aren't forgotten / unintentionally lost.\n\nRecommend adding a require check:\n`require(yieldSource.balanceOfToken(address(this)); == 0, \"SwappableYieldSource/existing-funds-in-current-yield-source\")` **before calling `_setYieldSource()\n\n\n**[PierrickGT (PoolTogether) acknowledged](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/31#issuecomment-897130001):**\n > We have decided to remove `setYieldSource` and `transferFunds` functions. When using `swapYieldSource` to change of yield source, all funds from the old yield source will be moved to the new yield source in one transaction.\n> https://github.com/pooltogether/swappable-yield-source/pull/4\n\n## [[L-12] Retrieve stuck tokens from `MStableYieldSource`](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/73)\n_Submitted by pauliax_\n\nTokens sent directly to the `MStableYieldSource` will be stuck forever. Consider adding a function that allows an admin to retrieve stuck tokens:\n* Balance of `mAsset` - total deposited amount of `mAsset`;\n* Similar with credit balances as credits are issued as a separate erc20 token.\n* All the other tokens.\n\n**[PierrickGT (PoolTogether) confirmed](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/73#issuecomment-899899348):**\n > PR: https://github.com/pooltogether/pooltogether-mstable/pull/8\n\n**[kamescg (PoolTogether commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/73#issuecomment-899981799):**\n > LGTM\n\n## [[L-13] Validation](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/74)\n_Submitted by pauliax_\n\nFunction `supplyTokenTo` should check that `mAssetAmount` and `creditsIssued` > 0 and to != address(0) or if empty to address is provided, it can replace it with msg.sender to prevent potential burn of funds. function `redeemToken` should check that `mAssetAmount` and `creditsBurned` > 0. function `transferERC20` should similarly validate erc20Token, to and amount parameters. function `_mintShares` requires that shares > 0, while `_burnShares` lacks such requirement.\n\n**[PierrickGT (PoolTogether) disputed](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/74#issuecomment-899810951):**\n > This report barely describes which functions or contract should be fixed. This is why I disputed the issue.\n> A proof of concept should have at least been written down and it would have been perfect if recommended mitigation steps were provided in a clear and precise manner.\n\n**[0xean (Judge) commented](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/74#issuecomment-904785358):**\n > Issue is very poorly written. Warden should take time to clearly articulate the issue and impact.\n>\n> That being said, I do agree that a check on MStableYieldSource.supplyTokenTo to ensure the `to != address(0)` is reasonable.  The mAsset may or may not implement this check, but it would be useful to avoid potential loss of funds.\n>\n\n**[PierrickGT (PoolTogether) confirmed](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/74#issuecomment-908436173):**\n > This issue has been fixed in the following PR: https://github.com/pooltogether/pooltogether-mstable/pull/10\n\n## [[L-14] Some tokens do not have decimals.](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/2)\n_Submitted by tensors_\n\nThere are a few tokens out there that do not use any decimals. As far as I know none of them would be a good yield source, but just in case something comes out, you may want to include the possibility that decimals = 0.\n[`SwappableYieldSource.sol` L116](dhttps://github.com/pooltogether/swappable-yield-source/blob/89cf66a3e3f8df24a082e1cd0a0e80d08953049c/contracts/SwappableYieldSource.sol#L116)\n\nRecommend removing the require statement.\n\n**[PierrickGT (PoolTogether) confirmed](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/2#issuecomment-896138968):**\n > PR: https://github.com/pooltogether/swappable-yield-source/pull/2\n\n# Non-Critical Findings\n- [[N-01] Sponsored event not used](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/1)\n- [[N-02] Amount should > 0 in `supplyToken()` and `RedeemToken()`  in `SwappableYieldSource.sol`](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/16)\n- [[N-03] Lack of zero address validation in _requireDifferentYieldSource()](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/17)\n- [[N-04] Incorrect comment about memory](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/69)\n- [[N-05] `approveMax` in the constructor](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/72)\n- [[N-06] Possible enhancements to supply/redeem full balance](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/79)\n\n# Gas Optimizations\n- [[G-01] SwappableYieldSource.sol: Save depositToken as a storage variable](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/26)\n- [[G-02] MStableYieldSource.sol Public functions that should be declared as external to save gas](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/10)\n- [[G-03] Redundant zero-address check](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/33)\n- [[G-04] MStableYieldSource.sol: `approveMax` can use mAsset instead of savings.underlying()](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/19)\n- [[G-05] Adding unchecked directive can save gas](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/37)\n- [[G-06] Gas: swapYieldSource](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/64)\n- [[G-07] Increase Solc Optimiser Runs](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/18)\n- [[G-08] MStableYieldSource.sol: Optimise balanceOf()](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/21)\n- [[G-09] SwappableYieldSource.sol: Shorten revert messages](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/27)\n- [[G-10] [Optimization] Use 0.8.4 in MStableYieldSource.sol](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/65)\n- [[G-11] Use `abi.encodePacked` for gas optimization](https://github.com/code-423n4/2021-07-pooltogether-findings/issues/53)\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}