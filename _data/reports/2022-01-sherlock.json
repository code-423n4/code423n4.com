{
  "circa": {
    "title": "Sherlock contest",
    "sponsor": "Sherlock",
    "slug": "2022-01-sherlock",
    "date": "2022-05-17",
    "findings": "https://github.com/code-423n4/2022-01-sherlock-findings/issues",
    "contest": 76
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Sherlock smart contract system written in Solidity. The audit contest took place between January 20—January 26 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>40 Wardens contributed reports to the Sherlock contest:</p>\n<ol>\n<li>GreyArt (<a href=\"https://twitter.com/HickupH\">hickuphh3</a> and <a href=\"https://twitter.com/itsmeSTYJ\">itsmeSTYJ</a>)</li>\n<li><a href=\"https://twitter.com/ori_dabush\">OriDabush</a></li>\n<li>egjlmn1</li>\n<li><a href=\"https://twitter.com/kirkthebaird\">kirk-baird</a></li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li>hyh</li>\n<li>static</li>\n<li><a href=\"https://twitter.com/SirH4shalot\">sirhashalot</a></li>\n<li><a href=\"https://twitter.com/_ye0lde\">ye0lde</a></li>\n<li><a href=\"https://twitter.com/danbinnun\">danb</a></li>\n<li><a href=\"https://twitter.com/hack3r_0m\">hack3r-0m</a></li>\n<li>cccz</li>\n<li>harleythedog</li>\n<li><a href=\"https://twitter.com/KenzoAgada\">kenzo</a></li>\n<li><a href=\"https://twitter.com/JustDravee\">Dravee</a></li>\n<li>0x0x0x</li>\n<li>Jujic</li>\n<li>0x1f8b</li>\n<li>RamiRond</li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li><a href=\"https://twitter.com/VladToie/\">bobi</a></li>\n<li><a href=\"https://twitter.com/fitraldys\">Fitraldys</a></li>\n<li>haku</li>\n<li>robee</li>\n<li><a href=\"https://instagram.com/vanensurya\">Funen</a></li>\n<li>Afanasyevich</li>\n<li>p4st13r4 (<a href=\"https://github.com/0x69e8\">0x69e8</a> and 0xb4bb4)</li>\n<li><a href=\"https://twitter.com/wuwe19\">wuwe1</a></li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>pedroais</li>\n<li><a href=\"https://www.linkedin.com/in/yahia-chaabane/\">ych18</a></li>\n<li>byterocket (<a href=\"https://binbash.sh\">pseudorandom</a> and <a href=\"https://twitter.com/merkleplant_eth\">pmerkleplant</a>)</li>\n<li>saian</li>\n<li>ACai</li>\n<li>GeekyLumberjack</li>\n</ol>\n<p>This contest was judged by <a href=\"https://github.com/jack-the-pug\">Jack the Pug</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 14 unique vulnerabilities and 71 total findings. All of the issues presented here are linked back to their original finding.</p>\n<p>Of these vulnerabilities, 1 received a risk rating in the category of HIGH severity, 4 received a risk rating in the category of MEDIUM severity, and 9 received a risk rating in the category of LOW severity.</p>\n<p>C4 analysis also identified 33 non-critical recommendations and 24 gas optimizations.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-01-sherlock\">C4 Sherlock contest repository</a>, and is composed of 8 smart contracts written in the Solidity programming language and includes 612 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-1\" style=\"position:relative;\"><a href=\"#high-risk-findings-1\" aria-label=\"high risk findings 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (1)</h1>\n<h2 id=\"h-01-first-user-can-steal-everyone-elses-tokens\" style=\"position:relative;\"><a href=\"#h-01-first-user-can-steal-everyone-elses-tokens\" aria-label=\"h 01 first user can steal everyone elses tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/39\">[H-01] first user can steal everyone else’s tokens</a></h2>\n<p><em>Submitted by egjlmn1, also found by OriDabush</em></p>\n<p>A user who joins the systems first (stakes first) can steal everybody’s tokens by sending tokens to the system externally.\nThis attack is possible because you enable staking a small amount of tokens.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>See the following attack:</p>\n<ol>\n<li>the first user (user A) who enters the system stake 1 token</li>\n<li>another user (user B) is about to stake X tokens</li>\n<li>user A frontrun and transfer X tokens to the system via <code>ERC20.transfer</code></li>\n<li>user B stakes X tokens, and the shares he receives is:</li>\n</ol>\n<p><code>shares = (_amount * totalStakeShares_) / (totalTokenBalanceStakers() - _amount);</code>\n<code>shares = (X * 1) / (X + 1 + X - X) = X/(X+1) = 0</code> meaning all the tokens he staked got him no shares, and those tokens are now a part of the single share that user A holds\n5. user A can now redeem his shares and get the 1 token he staked, the X tokens user B staked, and the X tokens he <code>ERC20.transfer</code> to the system because all the money in the system is in a single share that user A holds.</p>\n<p>In general, since there is only a single share, for any user who is going to stake X tokens, if the system has X+1 tokens in its balance, the user won’t get any shares and all the money will go to the attacker.</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Force users to stake at least some amount in the system (Uniswap forces users to pay at least <code>1e18</code>)\nThat way the amount the attacker will need to ERC20.transfer to the system will be at least <code>X*1e18</code> instead of <code>X</code> which is unrealistic</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/39#issuecomment-1029438483\">Evert0x (Sherlock) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Thanks. I agree it’s an issue that could theoretically affect all deposits.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/39\">Evert0x (Sherlock) resolved</a></strong></p>\n<hr>\n<h1 id=\"medium-risk-findings-4\" style=\"position:relative;\"><a href=\"#medium-risk-findings-4\" aria-label=\"medium risk findings 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (4)</h1>\n<h2 id=\"m-01-sherlockclaimmanager-incorrect-amounts-needed-and-paid-for-escalated-claims-\" style=\"position:relative;\"><a href=\"#m-01-sherlockclaimmanager-incorrect-amounts-needed-and-paid-for-escalated-claims-\" aria-label=\"m 01 sherlockclaimmanager incorrect amounts needed and paid for escalated claims  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/230\">[M-01] <code>SherlockClaimManager</code>: Incorrect amounts needed and paid for escalated claims </a></h2>\n<p><em>Submitted by GreyArt, also found by static</em></p>\n<p>When escalating claims, <a href=\"https://docs.sherlock.xyz/claims/claims-process\">the documentation</a> states that the protocol agent is required to pay and stake a certain amount for the process. If the covered protocol is proven correct, then the amount specified by the claim will be paid out. <strong>They will also receive the stake amount back in full.</strong> If the covered protocol’s escalation is not successful, then the amount specified by the claim is not paid out and the stake amount is not returned.</p>\n<p>The protocol agent is reasonably expected to pay the following:</p>\n<ul>\n<li>The stake (<code>BOND</code>) and</li>\n<li>UMA’s final fee</li>\n</ul>\n<p>In reality, the protocol agent will end up paying more, as we shall see in the proof of concept.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Let us assume the following:</p>\n<ul>\n<li><code>BOND = 9600</code> as defined in <code>SherlockClaimManager</code></li>\n<li><code>umaFee = 400</code> (at the time of writing, this value has been updated to 1500 USDC: see <code>[Store.computeFinalFee(usdc)](https://etherscan.io/address/0x54f44eA3D2e7aA0ac089c4d8F7C93C27844057BF#readContract)</code>).</li>\n</ul>\n<p>On invoking <code>escalate()</code>, the following amounts are required:</p>\n<ol>\n<li><code>BOND + umaFee = 9600 + 400</code> will be transferred to UMA when invoking <code>requestAndProposePriceFor()</code></li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Taken from https://github.com/UMAprotocol/protocol/blob/master/packages/core/contracts/oracle/implementation/SkinnyOptimisticOracle.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Only relevant lines are referenced</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">finalFee</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getStore</span><span class=\"mtk1\">().</span><span class=\"mtk11\">computeFinalFee</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currency</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">rawValue</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">finalFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">finalFee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">totalBond</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bond</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">finalFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">totalBond</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">currency</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">totalBond</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<ol>\n<li>Another <code>BOND + umaFee = 9600 + 400</code> will be transfered when invoking <code>disputePriceFor()</code></li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"390\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"391\"></span><span class=\"grvsc-source\"><span class=\"mtk12\">totalBond</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bond</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">finalFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"392\"></span><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">totalBond</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">currency</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">totalBond</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>However, what’s important to note is that <strong>UMA will “burn” half of the BOND collected + final fee.</strong> This will go against the claim that the protocol agent will be able to reclaim his stake in full.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">StoreInterface</span><span class=\"mtk1\"> </span><span class=\"mtk12\">store</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getStore</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Avoids stack too deep compilation error.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Along with the final fee, &quot;burn&quot; part of the loser&#39;s bond to ensure that a larger bond always makes it</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// proportionally more expensive to delay the resolution even if the proposer and disputer are the same</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// party.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">burnedBond</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_computeBurnedBond</span><span class=\"mtk1\">(</span><span class=\"mtk12\">disputedRequest</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// The total fee is the burned bond and the final fee added together.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">finalFee</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">burnedBond</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">totalFee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">currency</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeIncreaseAllowance</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">store</span><span class=\"mtk1\">), </span><span class=\"mtk12\">totalFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_getStore</span><span class=\"mtk1\">().</span><span class=\"mtk11\">payOracleFeesErc20</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">currency</span><span class=\"mtk1\">), </span><span class=\"mtk12\">FixedPoint</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Unsigned</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalFee</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_computeBurnedBond</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Request</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">request</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// burnedBond = floor(bond / 2)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bond</span><span class=\"mtk1\">.</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>We finally note that on settlement, the eventual payout is</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Winner gets:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// - Their bond back.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// - The unburned portion of the loser&#39;s bond: proposal bond (not including final fee) - burned bond.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// - Their final fee back.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// - The request reward (if not already refunded -- if refunded, it will be set to 0).</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">payout</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bond</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bond</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sub</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_computeBurnedBond</span><span class=\"mtk1\">(</span><span class=\"mtk12\">settledRequest</span><span class=\"mtk1\">))).</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">finalFee</span><span class=\"mtk1\">).</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reward</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">currency</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">disputeSuccess</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">disputer</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">request</span><span class=\"mtk1\">.</span><span class=\"mtk12\">proposer</span><span class=\"mtk1\">, </span><span class=\"mtk12\">payout</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Hence, in reality, the protocol agent will only receive <code>9600 * 2 - 4800 + 400 = 14800</code> should the dispute be successful. We note that the burnt amount of <code>4800 / 2 + 400 = 5200</code> has been taken by UMA.</p>\n<p>One can further verify this behaviour by looking at a past resolution of another protocol:</p>\n<p><a href=\"https://dashboard.tenderly.co/tx/main/0x0f03f73a2093e385146791e8f2739dbc04b39145476d6940776680243460100f/debugger?trace=0.6.1\">https://dashboard.tenderly.co/tx/main/0x0f03f73a2093e385146791e8f2739dbc04b39145476d6940776680243460100f/debugger?trace=0.6.1</a></p>\n<p>The above example has a bond is <code>0.0075 ETH</code>, with UMA’s final fee being 0.2 ETH. We see that UMA takes <code>0.2 + 0.5 * 0.0075 = 0.02375 ETH</code>.</p>\n<p>Thus, we see that the protocol agent will be charged disproportionally to what is expected.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>We suggest changing the parameters of <code>requestAndProposePriceFor()</code> to</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"jsx\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">UMA</span><span class=\"mtk1\">.</span><span class=\"mtk11\">requestAndProposePriceFor</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">UMA_IDENTIFIER</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// Sherlock ID so UMA knows the request came from Sherlock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">claim</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// Timestamp to identify the request</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">claim</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ancillaryData</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// Ancillary data such as the coverage agreement</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">TOKEN</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// USDC</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">BOND</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// While sherlock handles rewards on its own, we use the BOND as the reward</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// because using it as UMA&#39;s bond would result in 0.5 * BOND charged by UMA excluding final fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// Ideally 0, but 0 = final fee used. Hence, we set it to the next lowest </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// possible value</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">LIVENESS</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// Proposal liveness</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sherlockCore</span><span class=\"mtk1\">), </span><span class=\"mtk3\">// Sherlock core address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>where <code>BOND</code> becomes the reward and the actual bond for UMA is <code>1</code>. Ideally, it should be set to 0, but if set as such, UMA interprets it to use the final fee as the bond amount instead.</p>\n<p><code>[request.bond = bond != 0 ? bond : finalFee;](https://github.com/UMAprotocol/protocol/blob/master/packages/core/contracts/oracle/implementation/SkinnyOptimisticOracle.sol#L321)</code></p>\n<p>This way, the actual amount required from the protocol agent is the <code>BOND + 2 * (USDC wei + umaFee)</code> for the process. He will additionally be returned his <code>BOND + umaFee</code> if his dispute is successful.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/230#issuecomment-1029404347\">Evert0x (Sherlock) disagreed with High severity and commented</a>:</strong></p>\n<blockquote>\n<p>Non critical as documentation is incorrect about this.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/230#issuecomment-1079638067\">Jack the Pug (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Downgrading to <code>Med</code> as it’s mostly because the documentation is incorrect.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/230#issuecomment-1079876687\">rcstanciu (Sherlock) commented</a>:</strong></p>\n<blockquote>\n<p>@jack-the-pug The docs have been updated to explain the correct burned amount.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/230#issuecomment-1086797167\">Jack the Pug (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Thank you @rcstanciu</p>\n<p>While I agreed that the issue only impacts a small sum of users and the impact is not significant. And the root cause of this issue may not be a wrong implementation but actual wrong documentation.</p>\n<p>However, I still tend to make this a <code>Med</code> rather than a <code>Low</code> for the following reasons:</p>\n<ol>\n<li>A wrong documentation is arguably indistinguishable from a wrong implementation that actually violates the intention of the design, especial from an outsider’s pov;</li>\n<li>This write-up indicates a dedicated and in-depth effort of the warden by digging into the documentation and trying to understand the intention and cross-compare with the actual implementation to find any differences. As a judge, part of my job is to make sure that the wardens’ findings are being rewarded in a just and fair manner.</li>\n</ol>\n<p>Therefore, I’m keeping this as a <code>Med</code> and I encourage the future wardens to continue finding the inconsistency between the documentation and the implementation.</p>\n<p>Keep up the good work! GreyArt is a great name btw.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-tokenbalanceofaddress-of-nftowner-becomes-permanently-incorrect-after-arbrestake\" style=\"position:relative;\"><a href=\"#m-02-tokenbalanceofaddress-of-nftowner-becomes-permanently-incorrect-after-arbrestake\" aria-label=\"m 02 tokenbalanceofaddress of nftowner becomes permanently incorrect after arbrestake permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/109\">[M-02] <code>tokenBalanceOfAddress</code> of <code>nftOwner</code> becomes permanently incorrect after <code>arbRestake</code></a></h2>\n<p><em>Submitted by hyh, also found by GreyArt and hack3r-0m</em></p>\n<p>Successful <code>arbRestake</code> performs <code>_redeemShares</code> for <code>arbRewardShares</code> amount to extract the arbitrager reward. This effectively reduces shares accounted for an NFT, but leaves untouched the <code>addressShares</code> of an <code>nftOwner</code>.</p>\n<p>As a result the <code>tokenBalanceOfAddress</code> function will report an old balance that existed before arbitrager reward was slashed away. This will persist if the owner will transfer the NFT to someone else as its new reduced shares value will be subtracted from <code>addressShares</code> in <code>_beforeTokenTransfer</code>, leaving the arbitrage removed shares permanently in <code>addressShares</code> of the NFT owner, essentially making all further reporting of his balance incorrectly inflated by the cumulative arbitrage reward shares from all arbRestakes happened to the owner’s NFTs.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>arbRestake</code> redeems <code>arbRewardShares</code>, which are a part of total shares of an NFT:</p>\n<p><a href=\"https://github.com/code-423n4/2022-01-sherlock/blob/main/contracts/Sherlock.sol#L673\">Sherlock.sol#L673</a></p>\n<p>This will effectively reduce the <code>stakeShares</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2022-01-sherlock/blob/main/contracts/Sherlock.sol#L491\">Sherlock.sol#L491</a></p>\n<p>But there is no mechanics in place to reduce <code>addressShares</code> of the owner apart from mint/burn/transfer, so <code>addressShares</code> will still correspond to NFT shares before arbitrage. This discrepancy will be accumulated further with arbitrage restakes.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a flag to <code>_redeemShares</code> indicating that it was called for a partial shares decrease, say <code>isPartialRedeem</code>, and do <code>addressShares[nftOwner] -= _stakeShares</code> when <code>isPartialRedeem == true</code>.</p>\n<p>Another option is to do bigger refactoring, making stakeShares and addressShares always change simultaneously.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/109#issuecomment-1034015588\">Evert0x (Sherlock) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This is a legit issue and needs to be addressed. I think we choose to delete this functionality all together.</p>\n<p>The function has some potential future benefit but it might be too little benefit to make these relatively complex changes that make the code harder to understand.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/109\">Evert0x (Sherlock) resolved</a></strong></p>\n<hr>\n<h2 id=\"m-03-updateyieldstrategy-will-freeze-some-funds-with-the-old-strategy-if-yieldstrategy-fails-to-withdraw-all-the-funds-because-of-liquidity-issues\" style=\"position:relative;\"><a href=\"#m-03-updateyieldstrategy-will-freeze-some-funds-with-the-old-strategy-if-yieldstrategy-fails-to-withdraw-all-the-funds-because-of-liquidity-issues\" aria-label=\"m 03 updateyieldstrategy will freeze some funds with the old strategy if yieldstrategy fails to withdraw all the funds because of liquidity issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/76\">[M-03] <code>updateYieldStrategy</code> will freeze some funds with the old Strategy if <code>yieldStrategy</code> fails to withdraw all the funds because of liquidity issues</a></h2>\n<p><em>Submitted by hyh, also found by harleythedog, GreyArt, and pauliax</em></p>\n<p>Part of the funds held with the strategy can be frozen if the current strategy has tight liquidity when <code>updateYieldStrategy</code> is run as this function makes an attempt to withdraw all the funds and then unconditionally removes the strategy.</p>\n<p>The Sherlock to YieldStrategy link will be broken as a result: Sherlock points to the new Strategy, while old Strategy still allows only this Sherlock contract to withdraw.</p>\n<p>This way back and forth switches will be required in the future to return the funds: withdraw all from new strategy and switch to old, withdraw all from old and point to new one again, reinvest there.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In peer-to-peer lending protocols it is not always possible for the token supplier to withdraw all what’s due. This happens on high utilization of the market (when it has a kind of liquidity crunch).</p>\n<p>This way yieldStrategy.withdrawAll is not guaranteed to obtain all the funds held with the strategy:</p>\n<p><a href=\"https://github.com/code-423n4/2022-01-sherlock/blob/main/contracts/Sherlock.sol#L286\">Sherlock.sol#L286</a></p>\n<p>The worst case scenario here seems to be the remainder funds to be left frozen within the strategy.</p>\n<p>For example, AaveV2Strategy <code>withdraw</code> and <code>withdrawAll</code> have <code>onlySherlockCore</code> modifier:</p>\n<p><a href=\"https://github.com/code-423n4/2022-01-sherlock/blob/main/contracts/managers/AaveV2Strategy.sol#L78-100\">AaveV2Strategy.sol#L78-100</a></p>\n<p>While Sherlock core is immutable for the Strategy by default:</p>\n<p><a href=\"https://github.com/code-423n4/2022-01-sherlock/blob/main/contracts/managers/Manager.sol#L26-41\">Manager.sol#L26-41</a></p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider implementing a new method that fails whenever a strategy cannot withdraw all what’s due now, and rename current implementation to, for example, <code>forceUpdateYieldStrategy</code>, to have a degree of flexibility around liquidity issues.</p>\n<p>Also, to avoid back and forth switching, a strategy argument can be introduced to <code>yieldStrategyWithdrawAll</code> to allow withdrawals from any (not only current) yieldStrategy:</p>\n<p><a href=\"https://github.com/code-423n4/2022-01-sherlock/blob/main/contracts/Sherlock.sol#L322\">Sherlock.sol#L322</a></p>\n<p>Now:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function yieldStrategyWithdrawAll() external override onlyOwner {</span></span></code></pre>\n<p>To be (if <code>_yieldStrategy</code> is zero then utilize current):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function yieldStrategyWithdrawAll(IStrategyManager _yieldStrategy) external override onlyOwner {</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/76#issuecomment-1033998402\">Evert0x (Sherlock) disagreed with Medium severity and commented</a>:</strong></p>\n<blockquote>\n<p>I think this should be low risk but it’s an interesting feature to add</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/76#issuecomment-1079724284\">Jack the Pug (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I think this worths a <code>Med</code>, the scenario is not impossible to happen, and the handling in the current implementation is quite rough.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-reenterancy-in-_sendsherrewardstoowner\" style=\"position:relative;\"><a href=\"#m-04-reenterancy-in-_sendsherrewardstoowner\" aria-label=\"m 04 reenterancy in _sendsherrewardstoowner permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/60\">[M-04] Reenterancy in <code>_sendSherRewardsToOwner()</code></a></h2>\n<p><em>Submitted by kirk-baird</em></p>\n<p>This is a reentrancy vulnerability that would allow the attacker to drain the entire SHER balance of the contract.</p>\n<p>Note: this attack requires gaining control of execution <code>sher.transfer()</code> which will depend on the implementation of the SHER token. Control may be gained by the attacker if the contract implements ERC777 or otherwise makes external calls during <code>transfer()</code>.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>See <a href=\"https://github.com/code-423n4/2022-01-sherlock/blob/main/contracts/Sherlock.sol#L442\">_sendSherRewards</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_sendSherRewardsToOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_nftOwner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sherReward</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">sherRewards_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">sherReward</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Transfers the SHER tokens associated with this NFT ID to the address of the NFT owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">sher</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_nftOwner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">sherReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Deletes the SHER reward mapping for this NFT ID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sherRewards_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>Here <code>sherRewards</code> are deleted after the potential external call is made in <code>sher.safeTransfer()</code>. As a result if an attacker reenters this function <code>sherRewards_</code> they will still maintain the original balance of rewards and again transfer the SHER tokens.</p>\n<p>As <code>_sendSherRewardsToOwner()</code> is <code>internal</code> the attack can be initiated through the <code>external</code> function <code>ownerRestake()</code> <a href=\"https://github.com/code-423n4/2022-01-sherlock/blob/main/contracts/Sherlock.sol#L595\">see here.</a></p>\n<p>Steps to produce the attack:</p>\n<ol>\n<li>Deploy attack contract to handle reenterancy</li>\n<li>Call <code>initialStake()</code> from the attack contract with the smallest <code>period</code></li>\n<li>Wait for <code>period</code> amount of time to pass</li>\n<li>Have the attack contract call <code>ownerRestake()</code>. The attack contract will gain control of the (See note above about control flow). This will recursively call <code>ownerRestake()</code> until the balance of <code>Sherlock</code> is 0 or less than the user’s reward amount. Then allow reentrancy loop to unwind and complete.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Reentrancy can be mitigated by one of two solutions.</p>\n<p>The first option is to add a reentrancy guard like <code>nonReentrant</code> the is used in <code>SherlockClaimManager.sol</code>.</p>\n<p>The second option is to use the checks-effects-interactions pattern. This would involve doing all validation checks and state changes before making any potential external calls. For example the above function could be modified as follows.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_sendSherRewardsToOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_nftOwner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sherReward</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">sherRewards_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">sherReward</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Deletes the SHER reward mapping for this NFT ID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sherRewards_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Transfers the SHER tokens associated with this NFT ID to the address of the NFT owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">sher</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_nftOwner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">sherReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>Additionally the following functions are not exploitable however should be updated to use the check-effects-interations pattern.</p>\n<ul>\n<li><code>Sherlock._redeemShares()</code> should do <code>_transferTokensOut()</code> last.</li>\n<li><code>Sherlock.initialStake()</code> should do <code>token.safeTransferFrom(msg.sender, address(this), _amount);</code> last</li>\n<li><code>SherClaim.add()</code> should do <code>sher.safeTransferFrom(msg.sender, address(this), _amount);</code> after updating <code>userClaims</code></li>\n<li><code>SherlockProtocolManager.depositToActiveBalance()</code> should do <code>token.safeTransferFrom(msg.sender, address(this), _amount);</code> after updating <code>activeBalances</code></li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/60#issuecomment-1029420896\">Evert0x (Sherlock) confirmed, but disagreed with High severity and commented</a>:</strong></p>\n<blockquote>\n<p>Good find. I think it’s med-risk as it depends on the implementation of SHER token (does it allow callbacks).</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/60#issuecomment-1064200957\">Jack the Pug (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Downgrade to <code>Med</code> as the SHER token is a known token that currently comes with no such hooks like ERC777.</p>\n</blockquote>\n<p> <strong><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/60\">Evert0x (Sherlock) resolved</a></strong></p>\n<hr>\n<h1 id=\"low-risk-findings-9\" style=\"position:relative;\"><a href=\"#low-risk-findings-9\" aria-label=\"low risk findings 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Findings (9)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/269\">[L-01] safeApprove will fail if the current approval is not 0</a> <em>Submitted by pauliax, also found by cccz and sirhashalot</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/270\">[L-02] Slippage parameter for SherBuy</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/171\">[L-03] Many <code>protocolUpdate()</code> calls erase historic previousCoverage</a> <em>Submitted by sirhashalot</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/222\">[L-04] SherBuy: SHER and USDC token addresses should be derived from _sherlockPosition</a> <em>Submitted by GreyArt, also found by cccz</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/225\">[L-05] Sherlock: Revert for non-existent ID in viewRewardForArbRestake</a> <em>Submitted by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/112\">[L-06] Wrong user input check of incoming USDC when escalating claim</a> <em>Submitted by kenzo, also found by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/280\">[L-07] missing whenNotPaused</a> <em>Submitted by danb</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/273\">[L-08] Pausable paused() is not enforced to be present</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/123\">[L-09] Missing parameter check or confusing comment in function protocolRemove (SherlockProtocolManager.sol)</a> <em>Submitted by ye0lde</em></li>\n</ul>\n<h1 id=\"non-critical-findings-33\" style=\"position:relative;\"><a href=\"#non-critical-findings-33\" aria-label=\"non critical findings 33 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Findings (33)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/100\">[N-01] No Transfer Ownership Pattern</a> <em>Submitted by cccz, also found by Afanasyevich and Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/188\">[N-02] USDC is upgradeable: received amount should be calculated</a> <em>Submitted by Dravee, also found by harleythedog</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/174\">[N-03] There is a deviation in the parameter value setting.</a> <em>Submitted by ACai</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/110\">[N-04] Use of the reserved keyword <code>error</code> as a variable name</a> <em>Submitted by Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/191\">[N-05] <code>SherlockProtocolManager.sol</code>: <code>setMinActiveBalance()</code> and <code>forceRemoveByActiveBalance()</code> should be put behind a timelock</a> <em>Submitted by Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/95\">[N-06] _isEscalateState Comment Improvement</a> <em>Submitted by GeekyLumberjack</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/267\">[N-07] Withrawals will fail if the market has high utilization</a> <em>Submitted by pedroais</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/271\">[N-08] Claim SHER on behalf of others</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/274\">[N-09] Re-entrancy protection</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/11\">[N-10] safeApprove of openZeppelin is deprecated</a> <em>Submitted by robee, also found by bobi, cccz, and byterocket</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/216\">[N-11] Spelling Errors</a> <em>Submitted by GreyArt, also found by 0x0x0x and p4st13r4</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/166\">[N-12] Bond price not controlled by Sherlock</a> <em>Submitted by sirhashalot, also found by kenzo</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/217\">[N-13] SherlockClaimManager: reentrancy comment for priceProposed() and priceDisputed() can be phrased better</a> <em>Submitted by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/201\">[N-14] Updating Manager contract could destruct Sherlock core functionalities   </a> <em>Submitted by ych18</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/245\">[N-15] Unnecessary typcasting</a> <em>Submitted by saian</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/66\">[N-16] Never-used ETH transfers in _sweep</a> <em>Submitted by p4st13r4</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/69\">[N-17] Use structs instead of three mappings in Sherlock.sol</a> <em>Submitted by p4st13r4</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/218\">[N-18] Inconsistent Acronym of UmaHaltOperator</a> <em>Submitted by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/219\">[N-19] Grammar</a> <em>Submitted by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/220\">[N-20] SherlockClaimManager: Clarify why sherlockCore is used as proposer in UMA.requestAndProposePriceFor()</a> <em>Submitted by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/226\">[N-21] SherlockClaimManager: startClaim() has outdated comment</a> <em>Submitted by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/228\">[N-22] SherlockClaimManager: Confusing comment on BOND</a> <em>Submitted by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/229\">[N-23] ISherlockClaimManager: Outdated example on claims process</a> <em>Submitted by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/239\">[N-24] Name collision in <code>SherlockProtocolManager</code></a> <em>Submitted by gzeon</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/141\">[N-25] yieldStrategyDeposit doesn’t check that there is enough USDC to deposit</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/169\">[N-26] Incorrect comment about callback call</a> <em>Submitted by sirhashalot</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/56\">[N-27] ISherlockGov.removeSherDistributionManager description is incorrect</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/88\">[N-28] Implementation is not align with documentation</a> <em>Submitted by wuwe1</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/154\">[N-29] Implementation is not align with documentation #2</a> <em>Submitted by wuwe1</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/90\">[N-30] Pause/unpause functions descriptions aren’t fully correct </a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/53\">[N-31] addressShares introduction made further shares accounting error prone</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/94\">[N-32] Incorrect comparison for prevCoverage in startClaim()</a> <em>Submitted by GeekyLumberjack</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/67\">[N-33] Hardhat references in Manager.sol code</a> <em>Submitted by p4st13r4</em></li>\n</ul>\n<h1 id=\"gas-optimizations-24\" style=\"position:relative;\"><a href=\"#gas-optimizations-24\" aria-label=\"gas optimizations 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations (24)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/253\">[G-01] Adding unchecked directive can save gas</a> <em>Submitted by defsec, also found by bobi, Dravee, ye0lde, Afanasyevich, OriDabush, Jujic, and pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/111\">[G-02] Gas: <code>++i</code> costs less gas compared to <code>i++</code></a> <em>Submitted by Dravee, also found by robee, p4st13r4, Afanasyevich, Funen, OriDabush, defsec, and pedroais</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/231\">[G-03] Cache array length in for loops can save gas</a> <em>Submitted by defsec, also found by robee, 0x0x0x, bobi, Dravee, OriDabush, byterocket, Jujic, GreyArt, gzeon, saian, and Fitraldys</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/77\">[G-04] Avoid unneeded SLOADs by caching values in memory</a> <em>Submitted by RamiRond, also found by kirk-baird, p4st13r4, Ruhum, and Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/44\">[G-05] <code>SherDistributionManager.sol#slopeRewardsAvailable</code> can be calculated later to save gas</a> <em>Submitted by 0x0x0x</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/146\">[G-06] Gas in <code>SherlockClaimManager.sol:priceDisputed():</code>: a value used only once shouldn’t get cached</a> <em>Submitted by Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/200\">[G-07] Saving gas by used length</a> <em>Submitted by Funen, also found by 0x1f8b and Tomio</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/249\">[G-08] Cheaper to use calldata than memory</a> <em>Submitted by Tomio, also found by Jujic and robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/132\">[G-09] Gas: Using the logical NOT operator <code>!</code> is cheaper than a comparison to the constant boolean value <code>false</code></a> <em>Submitted by Dravee, also found by 0x1f8b, 0x0x0x, ych18, ye0lde, haku, GreyArt, and Fitraldys</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/185\">[G-10] 10 ** 18 can be changed to 1e18 and save some gas</a> <em>Submitted by Jujic</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/211\">[G-11] Manager: Check non-zero ETH balance before sending</a> <em>Submitted by GreyArt, also found by Tomio</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/215\">[G-12] SherDistributionManager: Cheaper to assign than add _tvl</a> <em>Submitted by GreyArt</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/48\">[G-13] <code>Sherlock.sol#_beforeTokenTransfer()</code> has not needed if statements</a> <em>Submitted by 0x0x0x</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/31\">[G-14] gas saving III</a> <em>Submitted by 0x1f8b</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/130\">[G-15] If condition can be removed from SherlockClaimManager.cleanUp function</a> <em>Submitted by Afanasyevich, also found by ye0lde, sirhashalot, and wuwe1</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/113\">[G-16] Gas: “constants” expressions are expressions, not constants. Use “immutable” instead.</a> <em>Submitted by Dravee, also found by Jujic</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/116\">[G-17] Gas: Consider making some constants as non-public to save gas</a> <em>Submitted by Dravee, also found by haku</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/256\">[G-18] cheaper to calculate stakeShares first then do the transfer</a> <em>Submitted by Fitraldys, also found by OriDabush</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/142\">[G-19] saving gas on reverted transactions</a> <em>Submitted by OriDabush</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/78\">[G-20] Use return value of assignments to save gas</a> <em>Submitted by RamiRond</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/54\">[G-21] Function call can be done after required check.</a> <em>Submitted by bobi, also found by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/236\">[G-22] Gas Optimization: Struct layout</a> <em>Submitted by gzeon</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/276\">[G-23] debt = balance</a> <em>Submitted by pauliax, also found by Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2022-01-sherlock-findings/issues/193\">[G-24] Gas: Non-strict inequalities are cheaper than strict ones</a> <em>Submitted by Dravee</em></li>\n</ul>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-1\">High Risk Findings (1)</a></p>\n<ul>\n<li><a href=\"#h-01-first-user-can-steal-everyone-elses-tokens\">[H-01] first user can steal everyone else’s tokens</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-4\">Medium Risk Findings (4)</a></p>\n<ul>\n<li><a href=\"#m-01-sherlockclaimmanager-incorrect-amounts-needed-and-paid-for-escalated-claims-\">[M-01] <code>SherlockClaimManager</code>: Incorrect amounts needed and paid for escalated claims </a></li>\n<li><a href=\"#m-02-tokenbalanceofaddress-of-nftowner-becomes-permanently-incorrect-after-arbrestake\">[M-02] <code>tokenBalanceOfAddress</code> of <code>nftOwner</code> becomes permanently incorrect after <code>arbRestake</code></a></li>\n<li><a href=\"#m-03-updateyieldstrategy-will-freeze-some-funds-with-the-old-strategy-if-yieldstrategy-fails-to-withdraw-all-the-funds-because-of-liquidity-issues\">[M-03] <code>updateYieldStrategy</code> will freeze some funds with the old Strategy if <code>yieldStrategy</code> fails to withdraw all the funds because of liquidity issues</a></li>\n<li><a href=\"#m-04-reenterancy-in-_sendsherrewardstoowner\">[M-04] Reenterancy in <code>_sendSherRewardsToOwner()</code></a></li>\n</ul>\n</li>\n<li><a href=\"#low-risk-findings-9\">Low Risk Findings (9)</a></li>\n<li><a href=\"#non-critical-findings-33\">Non-Critical Findings (33)</a></li>\n<li><a href=\"#gas-optimizations-24\">Gas Optimizations (24)</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}