{
  "circa": {
    "title": "Anchor contest",
    "sponsor": "Anchor",
    "slug": "2022-02-anchor",
    "date": "2023-01-18",
    "findings": "https://github.com/code-423n4/2022-02-anchor-findings/issues",
    "contest": 82
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Anchor smart contract system written in Rust. The audit contest took place between February 24—March 9 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>20 Wardens contributed reports to the Anchor contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li><a href=\"https://twitter.com/jonathanjmak\">jmak</a></li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li>BondiPestControl (<a href=\"https://twitter.com/0xleastwood\">leastwood</a> and <a href=\"https://twitter.com/kirkthebaird\">kirk-baird</a>)</li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li>hubble (ksk2345 and shri4net)</li>\n<li>broccoli (<a href=\"https://github.com/x9453\">shw</a> and <a href=\"https://twitter.com/jonah1005w\">jonah1005</a>)</li>\n<li><a href=\"https://twitter.com/HickupH\">hickuphh3</a></li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li>0xwags</li>\n<li>robee</li>\n<li>IllIllI</li>\n<li><a href=\"https://twitter.com/0xliumin\">0xliumin</a></li>\n<li>cccz</li>\n<li><a href=\"https://twitter.com/_0v3rf10w\">0v3rf10w</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://github.com/albertchon\">Albert Chon</a>.</p>\n<p>Triage performed by <a href=\"https://twitter.com/GalloDaSballo\">Alex the Entreprenerd</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 15 unique vulnerabilities. Of these vulnerabilities, 3 received a risk rating in the category of HIGH severity and 12 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 13 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 8 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-02-anchor\">C4 Anchor contest repository</a>.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-3\" style=\"position:relative;\"><a href=\"#high-risk-findings-3\" aria-label=\"high risk findings 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (3)</h1>\n<h2 id=\"h-01-spend-limit-on-owner-can-be-bypassed\" style=\"position:relative;\"><a href=\"#h-01-spend-limit-on-owner-can-be-bypassed\" aria-label=\"h 01 spend limit on owner can be bypassed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/11\">[H-01] Spend limit on owner can be bypassed</a></h2>\n<p><em>Submitted by csanuragjain, also found by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/distributor/src/contract.rs#L140\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/distributor/src/contract.rs#L140</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/community/src/contract.rs#L69\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/community/src/contract.rs#L69</a><br></p>\n<p>It seems that the owner is only allowed to spend amount uptil config.spend_limit. However it was observed that this <code>config.spend_limit</code> is never decreased even if owner has spend an amount. This makes <code>config.spend_limit</code> useless as owner can simply send 2-multiple transactions each of <code>config.spend_limit</code> which will all pass and hence bypassing the spend limit placed on owner.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Assume spend limit of 100 is placed on owner</li>\n<li>Owner simply calls the spend function at either distributor or community contract with amount 100</li>\n<li>Ideally after this transaction owner should not be allowed to perform any more spend operation</li>\n<li>Since <code>config.spend_limit</code> remains unchanged, owner can call step 2 multiple times which will spend amount 100 several times bypassing spend limit</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>After successful spend, the <code>config.spend_limit</code> should be decreased by the amount spend.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/34#issuecomment-1250500683\">Albert Chon (judge) commented via duplicate issue #34</a>:</strong></p>\n<blockquote>\n<p>Indeed, this is a serious oversight, unless one expects the whitelisted addresses to not exceed the spend limit (which is not a good assumption to bake in). </p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-money-market-contractsoraclefeed_prices-delayed-transaction-may-disrupt-price-feeds\" style=\"position:relative;\"><a href=\"#h-02-money-market-contractsoraclefeed_prices-delayed-transaction-may-disrupt-price-feeds\" aria-label=\"h 02 money market contractsoraclefeed_prices delayed transaction may disrupt price feeds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/47\">[H-02] <code>money-market-contracts/oracle#feed_prices()</code> delayed transaction may disrupt price feeds</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/money-market-contracts/contracts/oracle/src/contract.rs#L106-L113\">https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/money-market-contracts/contracts/oracle/src/contract.rs#L106-L113</a></p>\n<p>The implementation only takes two attributes: <code>asset</code> and <code>price</code>. And the <code>last_updated_time</code> of the record will always be set to the current <code>block.time</code>.</p>\n<p>This makes it possible for the price feeds to be disrupted when the network is congested, or the endpoint is down for a while, or the <code>feeder</code> bot handled the message queue inappropriately, as a result, the transactions with stale prices get accepted as fresh prices.</p>\n<p>Since the price feeds are essential to the protocol, that can result in users’ positions being liquidated wrongfully and case fund loss to users.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Given:</p>\n<ul>\n<li><code>feeder</code> i connected to an endpoint currently experiencing degraded performance;</li>\n<li>ETH price is <code>$10,000</code>;</li>\n<li>The <code>max_ltv</code> ratio of ETH is <code>60%</code>.</li>\n<li>Alice borrowed <code>5,000 USDC</code> with <code>1 ETH</code> as collateral;</li>\n<li>ETH price dropped to <code>$9,000</code>, to avoid liquidation, Alice repaid <code>1,000 USD</code>;</li>\n<li>The price of ETH dropped to <code>$8,000</code>; <code>feeder</code> tries to <code>updateMainFeedData()</code> with the latest price: <code>$8,000</code>, however, since the network is congested, the transactions were not get packed timely;</li>\n<li>ETH price rebound to <code>$10,000</code>; Alice borrowed another <code>1,000 USDC</code>;</li>\n<li>The txs send by <code>feeder</code> at step 3 finally got packed, the protocol now believes the price of ETH has suddenly dropped to <code>$8,000</code>, as a result, Alice’s position got liquidated.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pub</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fn</span><span class=\"mtk1\"> </span><span class=\"mtk11\">feed_prices</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">deps</span><span class=\"mtk1\">: </span><span class=\"mtk12\">DepsMut</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">env</span><span class=\"mtk1\">: </span><span class=\"mtk12\">Env</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">info</span><span class=\"mtk1\">: </span><span class=\"mtk12\">MessageInfo</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">prices</span><span class=\"mtk1\">: </span><span class=\"mtk12\">Vec</span><span class=\"mtk1\">&lt;(</span><span class=\"mtk10\">String</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Decimal256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">u64</span><span class=\"mtk1\">)&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) -&gt; </span><span class=\"mtk12\">Result</span><span class=\"mtk1\">&lt;</span><span class=\"mtk12\">Response</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ContractError</span><span class=\"mtk1\">&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    let mut </span><span class=\"mtk12\">attributes</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vec</span><span class=\"mtk1\">![</span><span class=\"mtk11\">attr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;action&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;feed_prices&quot;</span><span class=\"mtk1\">)];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    let </span><span class=\"mtk12\">sender_raw</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">deps</span><span class=\"mtk1\">.</span><span class=\"mtk12\">api</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addr_canonicalize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">info</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">.</span><span class=\"mtk11\">as_str</span><span class=\"mtk1\">())?;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> </span><span class=\"mtk4\">in</span><span class=\"mtk1\"> </span><span class=\"mtk12\">prices</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        let </span><span class=\"mtk12\">asset:</span><span class=\"mtk1\"> </span><span class=\"mtk10\">String</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">price</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mut</span><span class=\"mtk1\"> </span><span class=\"mtk12\">updated_time</span><span class=\"mtk1\">: </span><span class=\"mtk12\">u64</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">price</span><span class=\"mtk1\">.</span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\">: </span><span class=\"mtk12\">Decimal256</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">price</span><span class=\"mtk1\">.</span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Check feeder permission</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feeder</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">read_feeder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">deps</span><span class=\"mtk1\">.</span><span class=\"mtk12\">storage</span><span class=\"mtk1\">, &amp;</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">)?;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">if</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feeder</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">sender_raw</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            return </span><span class=\"mtk11\">Err</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ContractError</span><span class=\"mtk1\">::</span><span class=\"mtk10\">Unauthorized</span><span class=\"mtk1\"> {});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">config</span><span class=\"mtk1\">: </span><span class=\"mtk12\">Config</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">read_config</span><span class=\"mtk1\">(</span><span class=\"mtk12\">deps</span><span class=\"mtk1\">.</span><span class=\"mtk12\">storage</span><span class=\"mtk1\">)?;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">if</span><span class=\"mtk1\"> </span><span class=\"mtk12\">env</span><span class=\"mtk1\">.</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">time</span><span class=\"mtk1\">.</span><span class=\"mtk11\">seconds</span><span class=\"mtk1\">() &gt; </span><span class=\"mtk12\">updated_time</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// reject stale price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            if env.block.time.seconds() - updated_time &gt; config.valid_period {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                return </span><span class=\"mtk11\">Err</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ContractError</span><span class=\"mtk1\">::</span><span class=\"mtk10\">InvalidInputs</span><span class=\"mtk1\"> {});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk12\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// reject future timestamp, graceFuturePeriod can be set to 3, which means &lt; 3s is allowed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            if updated_time - env.block.time.seconds() &gt; config.grace_future_period {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                return </span><span class=\"mtk11\">Err</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ContractError</span><span class=\"mtk1\">::</span><span class=\"mtk10\">InvalidInputs</span><span class=\"mtk1\"> {});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">updated_time</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">env</span><span class=\"mtk1\">.</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">time</span><span class=\"mtk1\">.</span><span class=\"mtk11\">seconds</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">attributes</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk11\">attr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;asset&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">to_string</span><span class=\"mtk1\">()));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">attributes</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk11\">attr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;price&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">price</span><span class=\"mtk1\">.</span><span class=\"mtk11\">to_string</span><span class=\"mtk1\">()));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">store_price</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">deps</span><span class=\"mtk1\">.</span><span class=\"mtk12\">storage</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            &amp;</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            &amp;</span><span class=\"mtk12\">PriceInfo</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">last_updated_time:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">updated_time</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">price</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )?;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">Ok</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Response</span><span class=\"mtk1\">::</span><span class=\"mtk4\">new</span><span class=\"mtk1\">().</span><span class=\"mtk11\">add_attributes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">attributes</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/47#issuecomment-1102992100\">bitn8 (Anchor) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>We currently have a mean shorting function that pulls multiple price feeds so that if one is stale it gets rejected. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/47#issuecomment-1205898865\">Alex the Entreprenerd (triage) commented</a>:</strong></p>\n<blockquote>\n<p>Seems like the warden has shown a specific scenario, contingent on external conditions.</p>\n<p>However, from the code, there seems to be no “mean shorting function”, at least in the code in scope.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/47#issuecomment-1251670569\">Albert Chon (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agreed with @Alex the Entreprenerd, oracle staleness is still an issue in this version of the code. </p>\n</blockquote>\n<hr>\n<h2 id=\"h-03-missing-access-control-for-fabricatemirclaim-and-fabricateancclaim\" style=\"position:relative;\"><a href=\"#h-03-missing-access-control-for-fabricatemirclaim-and-fabricateancclaim\" aria-label=\"h 03 missing access control for fabricatemirclaim and fabricateancclaim permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/58\">[H-03] Missing Access Control for <code>FabricateMIRClaim</code> and <code>FabricateANCClaim</code></a></h2>\n<p><em>Submitted by jmak</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_airdrop_registry/src/contract.rs#L109\">https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_airdrop_registry/src/contract.rs#L109</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_airdrop_registry/src/contract.rs#L71\">https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_airdrop_registry/src/contract.rs#L71</a><br></p>\n<p><code>FabricateMIRClaim</code> and <code>FabricateANCClaim</code> should only be issued by the Hub contract (the central hub for all minted bLuna managed by Lido). However, <code>execute_fabricate_anchor_claim</code> and <code>execute_fabricate_mir_claim</code> do not restrict the caller, allowing anyone to submit these msgs.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Recommended to add at least simple access control checks in the contract to ensure that these functions can only be called by the Hub and not by others.</p>\n<p>See a below for a potential code snippet.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// only hub contract can send this message.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">let config = read_config(deps.storage)?;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">let sender_raw = deps.api.addr_canonicalize(&amp;info.sender.to_string())?;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if sender_raw != config.hub_contract {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return Err(StdError::generic_err(&quot;unauthorized&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/58#issuecomment-1207280476\">Alex the Entreprenerd (triage) commented</a>:</strong></p>\n<blockquote>\n<p>The finding is correct in that anyone can call the function.</p>\n<p>The finding lacks any form of impact as to what would happen.</p>\n<p>I think these may be test functions also.</p>\n<p>Not convinced the report makes sense for high severity given the lack of detail.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-12\" style=\"position:relative;\"><a href=\"#medium-risk-findings-12\" aria-label=\"medium risk findings 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (12)</h1>\n<h2 id=\"m-01-when-transferring-tokens-not-in-whitelist-on-ethereum-to-terra-with-crossanchorbridgedepositstable-the-funds-may-get-frozen\" style=\"position:relative;\"><a href=\"#m-01-when-transferring-tokens-not-in-whitelist-on-ethereum-to-terra-with-crossanchorbridgedepositstable-the-funds-may-get-frozen\" aria-label=\"m 01 when transferring tokens not in whitelist on ethereum to terra with crossanchorbridgedepositstable the funds may get frozen permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/44\">[M-01] When transferring tokens not in <code>whitelist</code> on Ethereum to Terra with <code>CrossAnchorBridge.depositStable()</code>, the funds may get frozen</a></h2>\n<p><em>Submitted by WatchPug, also found by BondiPestControl, broccoli, and defsec</em></p>\n<p>In the current implementation of <code>CrossAnchorBridge</code>, all <code>require</code> that “Check that <code>token</code> is a whitelisted token” is commented out.</p>\n<p>As a result, users may send transcations with the non-whitelisted tokens and as they can not be processd properly on the Terra side, the funds can be frozen on the brige contract or on the Terra side.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L167-L175\">https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L167-L175</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">handleStableToken</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">opCode</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Check that `token` is a whitelisted stablecoin token.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// require(whitelistedStableTokens[token]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">handleToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">opCode</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L250-L253\">https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L250-L253</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">redeemStable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// require(whitelistedAnchorStableTokens[token]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">handleToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">OP_CODE_REDEEM_STABLE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L255-L258\">https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L255-L258</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">lockCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// require(whitelistedCollateralTokens[token]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">handleToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">OP_CODE_LOCK_COLLATERAL</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Uncomment the whitelist codes.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/44\">bitn8 (Anchor) disagreed with severity</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/44#issuecomment-1205878804\">Alex the Entreprenerd (triage) commented</a>:</strong></p>\n<blockquote>\n<p>Seems conditional, would recommend downgrading to Medium.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/44\">Albert Chon (judge) decreased severity to Medium</a></strong></p>\n<hr>\n<h2 id=\"m-02-beth-rewards-may-be-depleted-by-flashloans-or-whales\" style=\"position:relative;\"><a href=\"#m-02-beth-rewards-may-be-depleted-by-flashloans-or-whales\" aria-label=\"m 02 beth rewards may be depleted by flashloans or whales permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/24\">[M-02] <code>bEth</code> Rewards May Be Depleted By Flashloans or Whales</a></h2>\n<p><em>Submitted by BondiPestControl, also found by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bEth-contracts/contracts/anchor_beth_reward/src/user.rs#L187-L212\">https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bEth-contracts/contracts/anchor_beth_reward/src/user.rs#L187-L212</a></p>\n<p>Rewards are dispersed to users as a percentage of the user’s balance vs total balance (of <code>bEth</code>). Rewards are accumulated each time a user calls <code>execute_decrease_balance()</code>, <code>execute_increase_balance()</code> or <code>execute_claim_rewards()</code> as these functions will in term call <code>update_global_index()</code> before any balance adjustments.</p>\n<p>There is an attack vector where a user may arbitrarily increase their <code>bEth</code> balance either by flashloan of purchase of wormhole eth, then converting it bEth via <code>anchor_beth_converter</code>. The attacker may then have a significant portion of the total balance. This use can then call the contract which pushes rewards to <code>anchor_beth_reward</code> this will increase the <code>reward_balance</code> of the contract. Since the attacker controls a large portion of the bEth balance they will receive a higher portion of the rewards. They may then convert the bEth back to wormhole eth and close their position.</p>\n<p>The result is the user has not contributed anything to the system but still gained a high portion of the rewards.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The logic for <code>update_global_index()</code> does not account for users suddenly increasing the balance.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">fn update_global_index(state: &amp;mut State, reward_balance: Uint128) -&gt; StdResult&lt;()&gt; {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Zero staking balance check</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if state.total_balance.is_zero() {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // nothing balance, skip update</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return Ok(());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // No change check</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if state.prev_reward_balance == reward_balance {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // balance didnt change, skip update</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return Ok(());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // claimed_rewards = current_balance - prev_balance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    let claimed_rewards = reward_balance.checked_sub(state.prev_reward_balance)?;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // update state</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    state.prev_reward_balance = reward_balance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // global_index += claimed_rewards / total_balance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    state.global_index = decimal_summation_in_256(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        state.global_index,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Decimal::from_ratio(claimed_rewards, state.total_balance),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Ok(())</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Steps:<br>\na) Flashloan (or buy) a significant portion of wormhole Eth<br>\nb) Convert to Anchor bEth via <code>anchor_beth_converter</code><br>\nc) Push rewards on <code>anchor_beth_rewards</code><br>\nd) <code>anchor_beth_rewards::execute_claim_rewards()</code><br>\ne) Convert Anchor bEth to wormhole Eth<br>\nf) Repay flashloan (or sell wormhole eth)<br></p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>There are multiple possible mitigations to this issue.</p>\n<p>First, option is to only allow the <code>global_index</code> to be updated once per block. In addition to this, cap the amount of rewards that may be paid per block (keeping the remaining rewards for the next block). This would reduce the effectiveness of the attack and limit the amount they may earn per block.</p>\n<p>Another option is to induce a wait time before the user may begin earning rewards. However, this would require a second transaction from the user to begin collection their reward which may hurt UX.</p>\n<hr>\n<h2 id=\"m-03-governance-voting-dis-proportionally-favours-users-who-stake-and-vote-after-a-poll-has-been-created-and-had-its-snapshot-taken\" style=\"position:relative;\"><a href=\"#m-03-governance-voting-dis-proportionally-favours-users-who-stake-and-vote-after-a-poll-has-been-created-and-had-its-snapshot-taken\" aria-label=\"m 03 governance voting dis proportionally favours users who stake and vote after a poll has been created and had its snapshot taken permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/64\">[M-03] Governance Voting Dis-proportionally Favours Users Who Stake And Vote After A Poll Has Been Created And Had Its Snapshot Taken</a></h2>\n<p><em>Submitted by BondiPestControl</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/contract.rs#L543-L580\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/contract.rs#L543-L580</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/contract.rs#L582-L665\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/contract.rs#L582-L665</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/staking.rs#L15-L57\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/staking.rs#L15-L57</a><br>\n<a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/contract.rs#L364-L455\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/contract.rs#L364-L455</a><br></p>\n<p>Polls are created by targeting the <code>receive_cw20</code> function which is queried whenever the contract receives tokens. By setting the hook message to <code>Cw20HookMsg::CreatePoll</code>, the sender is able to create a poll, assuming the amount sent satisfies the minimum deposit amount for poll creation. Users can also choose to call <code>ExecuteMsg::SnapshotPoll</code> or have it handled automatically when a user casts a vote on the newly created poll.</p>\n<p>The snapshot simply sets <code>a_poll.staked_amount</code>, which represents the total staked amount within the governance contract at a given block. However, during the voting period, other users can stake tokens and effectively have an increasing influence over the outcome of a given poll. There are no check-pointed balances to ensure that a certain user had staked tokens at the time the poll had its snapshot taken.</p>\n<p>This can be abused to skew poll results in favour of users who stake their Anchor tokens after a poll has had its snapshot taken.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Let’s assume the share to token exchange rate is <code>1:1</code> such that if a user deposits 100 Anchor tokens, they receive 100 shares in return.</p>\n<p>Consider the following scenario:</p>\n<ul>\n<li>There are a total of 100 Anchor tokens in the Governance contract.</li>\n<li>Alice creates a poll and executes <code>ExecuteMsg::SnapshotPoll</code> such that <code>a_poll.staked_amount == 100</code>.</li>\n<li>Bob deposits 10 Anchor tokens through the <code>Cw20HookMsg::StakeVotingTokens</code> hook message which increases the contract’s total balance to 110 and shares to 110 as the exchange rate is <code>1:1</code> upon minting and redeeming shares.</li>\n<li>At this point, the target poll has a <code>a_poll.staked_amount == 100</code>, even though there are really 110 Anchor tokens staked.</li>\n<li>As a result, if Bob votes on a poll, they have a 10% degree of influence on the outcome of the poll, even though they have less than 10% of the total staked tokens (i.e. 10/110).</li>\n<li>Therefore, poll voters are actually incentivised to stake tokens after a poll has had its snapshot taken in order to maximise their voting power.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider implementing a check-pointing mechanism such that when a user casts a vote, the user’s staked balance is checked at the block height upon which the snapshot was taken instead of checking its most up-to-date staked balance. This check-pointing behaviour is implemented on Ethereum which has a more restrictive block space. The mechanism will simply store the staker’s balance on each stake/unstake action. When user’s wish to vote, the protocol will check the balance at a specific block (i.e. the snapshotted block). An example implementation can be found <a href=\"https://github.com/compound-finance/compound-protocol/blob/master/contracts/Governance/Comp.sol#L189-L221\">here</a>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/64#issuecomment-1103012664\">bitn8 (Anchor) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>I wouldn’t call this a critical bug. Nevertheless, this will be addressed with ve-ANC tokenomics where tokens have to lock for periods of time (curve lock tokenomics). </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/64#issuecomment-1207279376\">Alex the Entreprenerd (triage) commented</a>:</strong></p>\n<blockquote>\n<p>Loss of Yield = Medium seems appropriate</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-sandwich-attack-on-astroport-sweep\" style=\"position:relative;\"><a href=\"#m-04-sandwich-attack-on-astroport-sweep\" aria-label=\"m 04 sandwich attack on astroport sweep permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/33\">[M-04] Sandwich attack on astroport sweep</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts%2Fanchor-token-contracts%2Fcontracts%2Fcollector%2Fsrc%2Fcontract.rs#L130-L137\">https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts%2Fanchor-token-contracts%2Fcontracts%2Fcollector%2Fsrc%2Fcontract.rs#L130-L137</a></p>\n<p>The collector contract allows anyone to <code>sweep</code>, swapping an asset token to ANC through astro port.<br>\nNote that <code>belief_price</code> is not set and <code>config.max_spread</code> might not be set as well or misconfigured.</p>\n<p>This allows an attacker to create a contract to perform a sandwich attack to make a profit on this trade.</p>\n<blockquote>\n<p>A common attack in DeFi is the sandwich attack. Upon observing a trade of asset X for asset Y, an attacker frontruns the victim trade by also buying asset Y, lets the victim execute the trade, and then backruns (executes after) the victim by trading back the amount gained in the first trade. Intuitively, one uses the knowledge that someone’s going to buy an asset, and that this trade will increase its price, to make a profit. The attacker’s plan is to buy this asset cheap, let the victim buy at an increased price, and then sell the received amount again at a higher price afterwards.</p>\n</blockquote>\n<p>Trades can happen at a bad price and lead to receiving fewer tokens than at a fair market price.<br>\nThe attacker’s profit is the protocol’s loss.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Attacker creates a contract that triggers 3 messages for the sandwich attack:</p>\n<ul>\n<li>Astroport: buy ANC with asset</li>\n<li>Call <code>sweep</code> which trades at bad price</li>\n<li>Astroport: sell assets from the first message for profit</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider setting a ANC/asset <code>belief_price</code> from an oracle.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/33#issuecomment-1103023318\">bitn8 (Anchor) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>While it might certainly be possible to sandwich an attack like this, there is no risk to users’ funds outside a possible bad fill price. There are many other issues at work here too such as UNI v2 that Astro is built on and volatility. This assumes very illiquid markets or huge wallets to move prices like this. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/33#issuecomment-1207282229\">Alex the Entreprenerd (triage) commented</a>:</strong></p>\n<blockquote>\n<ul>\n<li>Anyone can call = can set up a price imbalance</li>\n<li>Is a sweep (prob dust amount)</li>\n</ul>\n<p>Looks valid but impact seems reduced.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-anchor_basset_reward-pending-yields-can-be-stolen\" style=\"position:relative;\"><a href=\"#m-05-anchor_basset_reward-pending-yields-can-be-stolen\" aria-label=\"m 05 anchor_basset_reward pending yields can be stolen permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/48\">[M-05] <code>anchor_basset_reward</code> pending yields can be stolen</a></h2>\n<p><em>Submitted by WatchPug, also found by csanuragjain</em></p>\n<p>For yield farming aggregators, if the pending yield on an underlying strategy can be harvested and cause a surge of rewards to all existing investors, especially if the harvest can be triggered permissionlessly. Then the attacker can amplify the attack using a flash loan.</p>\n<p>This is a well-known attack vector on Ethereum.</p>\n<p>The root cause for this attack vector is that the pending yield is not settled to the existing users before issuing shares to new deposits.</p>\n<p>In the current implementation of anchor_basset_reward/src/user.rs#execute_increase_balance() before L105, the <code>state.global_index</code> is not being upadted first.</p>\n<ul>\n<li>Expected: the pending rewards (current_global_index - state.global_index) belongs to old user balance,</li>\n<li>Current implementation: the pending rewards (current_global_index - state.global_index) will be multiplied by the new user balance after <code>increase_balance</code> when calculate rewards.</li>\n</ul>\n<p>Because new user balance > old user balance, the user will take a part of the rewards belonging to other existing users.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_basset_reward/src/user.rs#L80-L123\">https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_basset_reward/src/user.rs#L80-L123</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">pub</span><span class=\"mtk1\"> </span><span class=\"mtk4\">fn</span><span class=\"mtk1\"> </span><span class=\"mtk11\">execute_increase_balance</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    deps: DepsMut,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    _env: Env,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    info: MessageInfo,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    address: </span><span class=\"mtk4\">String</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    amount: Uint128,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) -&gt; StdResult&lt;Response&lt;TerraMsgWrapper&gt;&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> config = </span><span class=\"mtk11\">read_config</span><span class=\"mtk1\">(deps.storage)?;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> owner_human = deps.api.</span><span class=\"mtk11\">addr_humanize</span><span class=\"mtk1\">(&amp;config.hub_contract)?;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> address_raw = deps.api.</span><span class=\"mtk11\">addr_canonicalize</span><span class=\"mtk1\">(&amp;address)?;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> sender = info.sender;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> token_address = deps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .api</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .</span><span class=\"mtk11\">addr_humanize</span><span class=\"mtk1\">(&amp;</span><span class=\"mtk11\">query_token_contract</span><span class=\"mtk1\">(deps.</span><span class=\"mtk11\">as_ref</span><span class=\"mtk1\">(), owner_human)?)?;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Check sender is token contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> sender != token_address {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> Err(StdError::</span><span class=\"mtk11\">generic_err</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;unauthorized&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">mut</span><span class=\"mtk1\"> state: State = </span><span class=\"mtk11\">read_state</span><span class=\"mtk1\">(deps.storage)?;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">mut</span><span class=\"mtk1\"> holder: Holder = </span><span class=\"mtk11\">read_holder</span><span class=\"mtk1\">(deps.storage, &amp;address_raw)?;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// get decimals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> rewards = </span><span class=\"mtk11\">calculate_decimal_rewards</span><span class=\"mtk1\">(state.global_index, holder.index, holder.balance)?;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    holder.index = state.global_index;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    holder.pending_rewards = </span><span class=\"mtk11\">decimal_summation_in_256</span><span class=\"mtk1\">(rewards, holder.pending_rewards);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    holder.balance += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    state.total_balance += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">store_holder</span><span class=\"mtk1\">(deps.storage, &amp;address_raw, &amp;holder)?;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">store_state</span><span class=\"mtk1\">(deps.storage, &amp;state)?;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> attributes = </span><span class=\"mtk11\">vec!</span><span class=\"mtk1\">[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">attr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;action&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;increase_balance&quot;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">attr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;holder_address&quot;</span><span class=\"mtk1\">, address),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">attr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;amount&quot;</span><span class=\"mtk1\">, amount),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> res = Response::</span><span class=\"mtk11\">new</span><span class=\"mtk1\">().</span><span class=\"mtk11\">add_attributes</span><span class=\"mtk1\">(attributes);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Ok(res)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Given:</p>\n<ul>\n<li>the reward balance of <code>anchor_basset_reward</code> increased</li>\n</ul>\n<p>The attacker can:</p>\n<ol>\n<li><code>bond</code> a large amount of asset tokens</li>\n</ol>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">-   [anchor_basset_hub](https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_basset_hub/src/bond.rs#L88-L107) will trigger `anchor_basset_token` to mint basset tokens to the attacker</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-   [anchor_basset_token](https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_basset_token/src/handler.rs#L90-L98) will trigger `anchor_basset_reward` to IncreaseBalance for the attacker</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-   [anchor_basset_reward](https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_basset_reward/src/user.rs#L107) will use the old `state.global_index` to update the attacker&#39;s `holder.index`</span></span></code></pre>\n<ol start=\"2\">\n<li>\n<p><code>UpdateGlobalIndex</code> on anchor_basset_hub</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_basset_hub/src/contract.rs#L258-L262\"><code>anchor_basset_hub</code></a> will trigger anchor_basset_reward’s  <code>execute_update_global_index()</code> and increase <code>global_index</code> for all users</li>\n</ul>\n</li>\n</ol>\n<p>As of now, the attacker can get a large share of the pending yield. The attacker can claim the rewards and exit.</p>\n<p>This process can be done in one transaction by using a smart contract, and the impact can be amplified by using a flash loan.</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider changing to a similar approach like <a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bEth-contracts/contracts/anchor_beth_reward/src/user.rs#L114\"><code>anchor_beth_reward/src/user.rs#L114</code></a>, update <code>state.global_index</code> before changing the user’s balance.</p>\n<p>And/or, transfer rewards and update <code>global_index</code> in one transaction.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/48#issuecomment-1205896976\">Alex the Entreprenerd (triage) commented</a>:</strong></p>\n<blockquote>\n<p>Seems like loss of yield due to frontrun.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/48#issuecomment-1251627358\">Albert Chon (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Indeed a bug, although this bug can be mitigated in practice by continuously executing <code>UpdateGlobalIndex</code>, doing so shouldn’t necessarily be a requirement for the functioning of the system.  </p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-simple-interest-calculation-is-not-exact\" style=\"position:relative;\"><a href=\"#m-06-simple-interest-calculation-is-not-exact\" aria-label=\"m 06 simple interest calculation is not exact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/41\">[M-06] Simple interest calculation is not exact</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts%2Fmoney-market-contracts%2Fcontracts%2Fmarket%2Fsrc%2Fborrow.rs#L304\">https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts%2Fmoney-market-contracts%2Fcontracts%2Fmarket%2Fsrc%2Fborrow.rs#L304</a></p>\n<p>The borrow rate uses a simple interest formula to compute the accrued debt, instead of a compounding formula.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">pub</span><span class=\"mtk1\"> </span><span class=\"mtk4\">fn</span><span class=\"mtk1\"> </span><span class=\"mtk11\">compute_interest_raw</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    state: &amp;</span><span class=\"mtk4\">mut</span><span class=\"mtk1\"> State,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    block_height: </span><span class=\"mtk4\">u64</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    balance: Uint256,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    aterra_supply: Uint256,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    borrow_rate: Decimal256,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    target_deposit_rate: Decimal256,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// @audit simple interest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> passed_blocks = Decimal256::</span><span class=\"mtk11\">from_uint256</span><span class=\"mtk1\">(block_height - state.last_interest_updated);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> interest_factor = passed_blocks * borrow_rate;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> interest_accrued = state.total_liabilities * interest_factor;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This means the actual borrow rate and interest for suppliers depend on how often updates are made.<br>\nThis difference should be negligible in highly active markets, but it could lead to a lower borrow rate in low-activity markets, leading to suppliers losing out on interest.</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Ensure that the markets are accrued regularly, or switch to a compound interest formula (which has a higher computational cost due to exponentiation, but can be approximated, see Aave).</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/41#issuecomment-1207281281\">Alex the Entreprenerd (triage) commented</a>:</strong></p>\n<blockquote>\n<p>Without Code and explanation, I’m skeptical of Med (loss of yield), as it could just be dust amount, provided that interest is compounded roughly 1 per month or similar (see compound interest math, and how <code>e</code> limits max autocompounds to dust variation)</p>\n<p>Either way, the observation is correct.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-updating-the-hubs-token-contract-address-may-lead-to-incorrect-undelegation-amount\" style=\"position:relative;\"><a href=\"#m-07-updating-the-hubs-token-contract-address-may-lead-to-incorrect-undelegation-amount\" aria-label=\"m 07 updating the hubs token contract address may lead to incorrect undelegation amount permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/62\">[M-07] Updating the hub’s token contract address may lead to incorrect undelegation amount</a></h2>\n<p><em>Submitted by hubble</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_basset_hub/src/config.rs#L90-L97\">https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_basset_hub/src/config.rs#L90-L97</a></p>\n<p>The hub contract allows config updates to the <code>token_contract</code> config values in <code>anchor-bAsset-contracts/contracts/anchor_basset_hub/src/config.rs</code>.<br>\nSuch updates can cause wrong amounts of tokens to be calculated during processing of undelegations, since the amount of unbonded bLuna tokens is stored for batched unbonding as <code>requested_with_fee</code>.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Contract : anchor-bAsset-contracts/contracts/anchor_basset_hub/src/config.rs<br>\nFunction : pub fn execute_update_config(…)<br>\nLine 90 :<br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    if let Some(token) = token_contract {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        let token_raw = deps.api.addr_canonicalize(token.as_str())?;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        CONFIG.update(deps.storage, |mut last_config| -&gt; StdResult&lt;Config&gt; {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            last_config.token_contract = Some(token_raw);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            Ok(last_config)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        })?;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Its recommended to remove the ability to update <code>token_contract</code> config value, or asserting that <code>requested_with_fee</code> is zero before allowing an update of the <code>token_contract</code> address.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/62#issuecomment-1207279889\">Alex the Entreprenerd (triage) commented</a>:</strong></p>\n<blockquote>\n<p>Looks like Admin Privilege so Medium seems appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-unbonding-validator-random-selection-can-be-predicted\" style=\"position:relative;\"><a href=\"#m-08-unbonding-validator-random-selection-can-be-predicted\" aria-label=\"m 08 unbonding validator random selection can be predicted permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/29\">[M-08] Unbonding validator random selection can be predicted</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>When unbonding, the <code>pick_validator</code> function is supposed to choose a random validator to unstake from.<br>\nHowever, this randomness can be predicted knowing the block height which is very easy to predict.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">mut</span><span class=\"mtk1\"> iteration_index = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">while</span><span class=\"mtk1\"> claimed.</span><span class=\"mtk4\">u128</span><span class=\"mtk1\">() &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">mut</span><span class=\"mtk1\"> rng = XorShiftRng::</span><span class=\"mtk11\">seed_from_u64</span><span class=\"mtk1\">(block_height + iteration_index);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> random_index = rng.</span><span class=\"mtk11\">gen_range</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, deletable_delegations.</span><span class=\"mtk11\">len</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>As validators are paid rewards proportional to their stake, choosing where to bond and unbond from directly impacts validator rewards.<br>\nCombined with being able to choose the validator when bonding (see <a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_basset_hub/src/bond.rs#L15\"><code>execute_bond</code></a>) a validator can steal rewards and increase their own.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Validator A wishes to increase their rewards. They call <code>execute_bond(, validator = A)</code> with their validator.</li>\n<li>Validator A precomputes the randomness for unbonding if the block was mined at the next block height. If it’s a different validator, they call <code>unbond</code>. The stake is removed from some other validator and the user receives it back. Note that validator A’s stake did not decrease and contains the initial bond amount.</li>\n<li>They repeat this process until every single bond of the Anchor platform is now staked to validator A and they earn huge rewards while everyone else does not earn anything from Anchor bonds anymore.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>An <code>unbond</code> must always remove stake from the validator the stake was originally bonded to, otherwise, it’s exploitable by the attack above.<br>\nConsider keeping track of all bonds with a <code>bond_id</code> and create a map of <code>bond_id -> validator</code>.<br>\nIf a validator’s stake decreased due to slashing, take the remaining unstake amount proportionally from all other validators.<br></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/29\">bitn8 (Anchor) disagreed with severity</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/29#issuecomment-1207282803\">Alex the Entreprenerd (triage) commented</a>:</strong></p>\n<blockquote>\n<p>Looks like weak RNG, Medium or High seem proper.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/29#issuecomment-1251643195\">Albert Chon (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Indeed, block height should definitely not be used as a source of randomness. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-potential-lock-of-rewards-in-the-custody-contracts\" style=\"position:relative;\"><a href=\"#m-09-potential-lock-of-rewards-in-the-custody-contracts\" aria-label=\"m 09 potential lock of rewards in the custody contracts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/71\">[M-09] Potential lock of rewards in the custody contracts</a></h2>\n<p><em>Submitted by broccoli</em></p>\n<p>The <code>swap_to_stable_denom</code> function in the custody contracts swaps all other native tokens into a specific one. The function creates swap messages for all the other native tokens and adds them as sub-messages, and handles the reply only when the last sub-message succeeds. Upon receiving the reply, the contract sends the swapped tokens (i.e., rewards) to the overseer contract.</p>\n<p>In cases where the last sub-message fails, the custody contract will not receive a reply, and therefore the rewards are left in the contract. The rewards are locked in the contract until someone triggers <code>swap_to_stable_denom</code> again, and the last swap succeeds. However, if the last swap consistently fails in some period for any reason, the total rewards will be locked in the contract during that period. As a result, users cannot get the rewards they are supposed to receive in that period.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Referenced code:<br>\n<a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/custody_beth/src/distribution.rs#L110-L115\"><code>custody_beth/src/distribution.rs#L110-L115</code></a><br>\n<a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/custody_bluna/src/distribution.rs#L109-L114\"><code>custody_bluna/src/distribution.rs#L109-L114</code></a><br></p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider handling the reply on either success or failure, i.e., using <code>ReplyOn::Always</code>, to avoid the failure of the swap to cause tokens to be locked.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/71\">bitn8 (Anchor) disagreed with severity</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/71#issuecomment-1205890442\">Alex the Entreprenerd (triage) commented</a>:</strong></p>\n<blockquote>\n<p>Reliant on external conditions. Severity seems appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-possible-wrong-basset-rewardsborrow-limits-calculation\" style=\"position:relative;\"><a href=\"#m-10-possible-wrong-basset-rewardsborrow-limits-calculation\" aria-label=\"m 10 possible wrong basset rewardsborrow limits calculation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/9\">[M-10] Possible Wrong bAsset Rewards/Borrow limits Calculation</a></h2>\n<p><em>Submitted by defsec</em></p>\n<p>During the code review, It has been observed that reward calculation has been done with execute_epoch_operations function. However, the config are stored in the storage. When the anc_purchase_factor is updated by the owner, the execute_epoch_operations is not called.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Navigate to the following contract.</li>\n</ol>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"192\"></span><span class=\"grvsc-source\">https:</span></span></code></pre>\n<ol start=\"2\">\n<li>Config is updated with update_config function.</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    if let Some(threshold_deposit_rate) = threshold_deposit_rate {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        config.threshold_deposit_rate = threshold_deposit_rate;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if let Some(buffer_distribution_factor) = buffer_distribution_factor {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        config.buffer_distribution_factor = buffer_distribution_factor;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if let Some(anc_purchase_factor) = anc_purchase_factor {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        config.anc_purchase_factor = anc_purchase_factor;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if let Some(target_deposit_rate) = target_deposit_rate {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        config.target_deposit_rate = target_deposit_rate;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if let Some(epoch_period) = epoch_period {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        config.epoch_period = epoch_period;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if let Some(price_timeframe) = price_timeframe {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        config.price_timeframe = price_timeframe;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<ol start=\"3\">\n<li>After the update, execute_epoch_operations function is not called. That will cause to out-of-date data.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider calling execute_epoch_operations function after config update.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/9#issuecomment-1207420289\">Alex the Entreprenerd (triage) commented</a>:</strong></p>\n<blockquote>\n<p>Confirmed Lack of validation.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/9#issuecomment-1251666145\">Albert Chon (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Good catch.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-money-market-contractscontractsmarket-claim_rewards-may-revert-due-to-spend_limit-set-on-distributor-\" style=\"position:relative;\"><a href=\"#m-11-money-market-contractscontractsmarket-claim_rewards-may-revert-due-to-spend_limit-set-on-distributor-\" aria-label=\"m 11 money market contractscontractsmarket claim_rewards may revert due to spend_limit set on distributor  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/46\">[M-11] <code>money-market-contracts/contracts/market</code> <code>claim_rewards</code> may revert due to <code>spend_limit</code> set on <code>distributor</code> </a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p>While <code>claim_rewards</code> from the <code>money-market</code>, it calls the <code>distributor_contract#spend()</code> to send the rewards.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/money-market-contracts/contracts/market/src/borrow.rs#L216-L234\">https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/money-market-contracts/contracts/market/src/borrow.rs#L216-L234</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">let</span><span class=\"mtk1\"> messages: </span><span class=\"mtk4\">Vec</span><span class=\"mtk1\">&lt;CosmosMsg&gt; = </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> !claim_amount.</span><span class=\"mtk11\">is_zero</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">vec!</span><span class=\"mtk1\">[CosmosMsg::</span><span class=\"mtk11\">Wasm</span><span class=\"mtk1\">(WasmMsg::Execute {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        contract_addr: deps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .api</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">addr_humanize</span><span class=\"mtk1\">(&amp;config.distributor_contract)?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">to_string</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        funds: </span><span class=\"mtk11\">vec!</span><span class=\"mtk1\">[],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        msg: </span><span class=\"mtk11\">to_binary</span><span class=\"mtk1\">(&amp;FaucetExecuteMsg::Spend {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            recipient: </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> Some(to) = to {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                to.</span><span class=\"mtk11\">to_string</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                borrower.</span><span class=\"mtk11\">to_string</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            amount: claim_amount.</span><span class=\"mtk11\">into</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        })?,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">vec!</span><span class=\"mtk1\">[]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p>However, the <code>distributor_contract#spend()</code> function have a <code>spend_limit</code> config and it will revert if the amount is larger than the <code>spend_limit</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-token-contracts/contracts/distributor/src/contract.rs#L153-L155\">https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-token-contracts/contracts/distributor/src/contract.rs#L153-L155</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> config.spend_limit &lt; amount {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> Err(StdError::</span><span class=\"mtk11\">generic_err</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Cannot spend more than spend_limit&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>As a result, users won’t be able to claim their rewards anymore once the amount of the rewards excess the <code>spend_limit</code> config on <code>distributor_contract</code>.</p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider removing the <code>spend_limit</code> or allowing users to specify an amount when <code>claim_rewards</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/46#issuecomment-1207280811\">Alex the Entreprenerd (triage) commented</a>:</strong></p>\n<blockquote>\n<p>Loss of yield, conditional on reaching limit, consider reducing severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/46#issuecomment-1251668446\">Albert Chon (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Can be mitigated with a large spend limit, which likely exists to prevent catastrophic cases. The issue is correct though, that this is a bug. Downgrading to medium severity though, given the practicality. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-12-staking-tokens-can-be-stolen\" style=\"position:relative;\"><a href=\"#m-12-staking-tokens-can-be-stolen\" aria-label=\"m 12 staking tokens can be stolen permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/37\">[M-12] Staking tokens can be stolen</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-token-contracts/contracts/gov/src/staking.rs#L88\">https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-token-contracts/contracts/gov/src/staking.rs#L88</a></p>\n<p>The staking contract keeps track of <em>shares</em> of each user.<br>\nWhen withdrawing from the staking contract the <code>amount</code> parameter is converted to <code>shares</code> and this value is decreased (<code>shares = amount / total_balance * total_share</code>).<br>\nThis shares calculation rounds down which allows stealing tokens.<br></p>\n<p>The current code seems to try to protect against this by doing a maximum <code>std::cmp::max(v.multiply_ratio(total_share, total_balance).u128(), 1u128)</code> but this only works for the case where the shares would round down to zero. It’s still exploitable.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">let</span><span class=\"mtk1\"> withdraw_share = amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// @audit only rounds up when it&#39;d be zero, but should always round up</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk11\">map</span><span class=\"mtk1\">(|v| std::cmp::</span><span class=\"mtk11\">max</span><span class=\"mtk1\">(v.</span><span class=\"mtk11\">multiply_ratio</span><span class=\"mtk1\">(total_share, total_balance).</span><span class=\"mtk4\">u128</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">1u128</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// @audit sets it to the `amount` parameter if not `None`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">let</span><span class=\"mtk1\"> withdraw_amount = amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk11\">map</span><span class=\"mtk1\">(|v| v.</span><span class=\"mtk4\">u128</span><span class=\"mtk1\">())</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Assume <code>total_balance = 2e18</code> and <code>total_share=1e18</code>. Then withdrawing/burning one share should allow withdrawing <code>total_balance / total_share = 2</code> amount.<br>\nHowever, imagine someone owns 1 shares (bought for 2 amount). Then <code>withdraw_voting_tokens(amount=3)</code>. And <code>withdraw_share = std::cmp::max(v.multiply_ratio(total_share, total_balance).u128(), 1u128) = max(amount=3 * total_share=1e18 / total_balance=2e18, 1) = max(\"3/2\", 1) = 1</code><br>\nThe attacker made a profit.</p>\n<p>The attacker can make a profit by staking the least <code>amount</code> to receive one share, and then immediately withdrawing this one share by specifying the largest <code>amount</code> such that the integer rounding still rounds to this one share. They make a small profit. They can repeat this many times in a single transaction with many messages.<br>\nDepending on the token price, this can be profitable as <a href=\"https://blog.neodyme.io/posts/lending_disclosure\">similar attacks show</a>.</p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The protocol tries to protect against this attack but the <code>max(., 1)</code> is not enough mitigation. There are several ways to fix this:</p>\n<ol>\n<li>Always round up in <code>withdraw_share</code></li>\n<li>Always recompute the <code>withdraw_amount</code> with the new <code>withdraw_share</code> even if the <code>amount</code> parameter was set.</li>\n<li>Use a <code>share</code> parameter (instead of the <code>amount</code> parameter) and use it as <code>withdraw_share</code>. Rounding down on the resulting <code>withdraw_amount</code> is bad for the attacker as burning a share leads to fewer tokens.</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/37\">bitn8 (Anchor) disagreed with severity</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/37#issuecomment-1251646570\">Albert Chon (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The amount would be miniscule due to the initial share amount scale being equal to the staked tokens scale (1e6), but indeed, the attack could be applied infinite times, though it’s likely then that the gas costs incurred would exceed the profits gained.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 13 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/13\">report highlighted below</a> by <strong>hickuphh3</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/43\">cmichel</a>, <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/67\">hubble</a>, <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/78\">0xwags</a>, <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/59\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/4\">0xliumin</a>, <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/68\">broccoli</a>, <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/6\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/76\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/51\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/1\">robee</a>, <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/25\">gzeon</a>, and <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/23\">BondiPestControl</a>.</em></p>\n<h2 id=\"codebase-impressions--summary\" style=\"position:relative;\"><a href=\"#codebase-impressions--summary\" aria-label=\"codebase impressions  summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Codebase Impressions &#x26; Summary</h2>\n<p>This audit contest is probably the largest in codebase size to date, consisting of various components such as tokens, airdrop, governance, staking, liquidity mining, reward distributions, a money market and cross-chain bridge functionality. While these components aren’t complex when reviewed in isolation, the code complexity becomes a little higher because of the various interactions with each other.</p>\n<p>Overall, the codebase quality is very high. Inline comments provided are helpful in describing why some checks were not performed (mainly because they are done elsewhere).</p>\n<p>The level of documentation is also high, where the documentation portal and READMEs are adequate and kept up-to-date with the codebase.</p>\n<p>Tests ran without issues, and could be easily modified to test out POCs and potential vulnerabilities.</p>\n<p>The findings made involve the lack of sanity checks for some key config values (eg. their values should not exceed 100%). While the likelihood of the creation of governance polls to modify these values is low because the proposer loses his ANC deposit if quorum isn’t met, the impact of such polls, should they be successful, is high.</p>\n<h2 id=\"l-01-crossanchorbridge-decide-if-whitelisting-feature-is-to-be-kept-or-removed\" style=\"position:relative;\"><a href=\"#l-01-crossanchorbridge-decide-if-whitelisting-feature-is-to-be-kept-or-removed\" aria-label=\"l 01 crossanchorbridge decide if whitelisting feature is to be kept or removed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] CrossAnchorBridge: Decide if whitelisting feature is to be kept or removed</h2>\n<h3 id=\"line-references\" style=\"position:relative;\"><a href=\"#line-references\" aria-label=\"line references permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L125-L130\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L125-L130</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L147-L151\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L147-L151</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L172-L173\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L172-L173</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L251\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L251</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L256\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L256</a></p>\n<h3 id=\"description\" style=\"position:relative;\"><a href=\"#description\" aria-label=\"description permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>The whitelisted mappings are defined and set to <code>true</code> for certain token addresses, but the lines of code where they are used are commented out.</p>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Decide whether to keep the whitelisting requirement. Either comment out the remaining lines / remove them entirely, or uncomment the lines where they are used.</p>\n<h2 id=\"l-02-incorrect-opcode-specification-documentation\" style=\"position:relative;\"><a href=\"#l-02-incorrect-opcode-specification-documentation\" aria-label=\"l 02 incorrect opcode specification documentation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Incorrect opcode specification documentation</h2>\n<h3 id=\"line-references-1\" style=\"position:relative;\"><a href=\"#line-references-1\" aria-label=\"line references 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/README.md#op-code-specification\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/README.md#op-code-specification</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/terra/contracts/wormhole-bridge/src/contract.rs#L99-L125\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/terra/contracts/wormhole-bridge/src/contract.rs#L99-L125</a></p>\n<h3 id=\"description-1\" style=\"position:relative;\"><a href=\"#description-1\" aria-label=\"description 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>It is unclear if the full opcode values include the flags as well. If so, they should be 8 bits in length, which isn’t the case. Their decimal representations are also incorrect.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"markdown\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| Opcode | Flags | Full Opcode | Decimal |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">|:-------|:------|:------------|:-------|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| Deposit Stable | </span><span class=\"mtk8\">`FLAG_BOTH_TRANSFERS`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`0b110000`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`192`</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| Redeem Stable | </span><span class=\"mtk8\">`FLAG_BOTH_TRANSFERS`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`0b110001`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`193`</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| Repay Stable | </span><span class=\"mtk8\">`FLAG_INCOMING_TRANSFER`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`0b1000000`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`64`</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| Lock Collateral | </span><span class=\"mtk8\">`FLAG_INCOMING_TRANSFER`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`0b1000001`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`65`</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| Unlock Collateral | </span><span class=\"mtk8\">`FLAG_OUTGOING_TRANSFER`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`0b0100000`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`32`</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| Borrow Stable | </span><span class=\"mtk8\">`FlAG_OUTGOING_TRANSFER`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`0b0100001`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`33`</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| Claim Rewards | </span><span class=\"mtk8\">`FLAG_OUTGOING_TRANSFER`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`0b0100010`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`34`</span><span class=\"mtk1\"> |</span></span></span></code></pre>\n<p>The opcodes were also not updated in the comments of the wormhole bridge terra contract.</p>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Update the comments to reflect the latest changes.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"markdown\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| Opcode | Flags | Full Opcode | Decimal |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">|:-------|:------|:------------|:-------|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| Deposit Stable | </span><span class=\"mtk8\">`FLAG_BOTH_TRANSFERS`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`0b11000000`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`192`</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| Redeem Stable | </span><span class=\"mtk8\">`FLAG_BOTH_TRANSFERS`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`0b11000001`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`193`</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| Repay Stable | </span><span class=\"mtk8\">`FLAG_INCOMING_TRANSFER`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`0b10000000`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`128`</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| Lock Collateral | </span><span class=\"mtk8\">`FLAG_INCOMING_TRANSFER`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`0b10000001`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`129`</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| Unlock Collateral | </span><span class=\"mtk8\">`FLAG_OUTGOING_TRANSFER`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`0b01000000`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`64`</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| Borrow Stable | </span><span class=\"mtk8\">`FlAG_OUTGOING_TRANSFER`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`0b01000001`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`65`</span><span class=\"mtk1\"> |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| Claim Rewards | </span><span class=\"mtk8\">`FLAG_OUTGOING_TRANSFER`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`0b01000010`</span><span class=\"mtk1\"> | </span><span class=\"mtk8\">`66`</span><span class=\"mtk1\"> |</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/*</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">struct Instruction {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  uint8 op_code; // [1 byte]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  bytes32 sender_address; // [32 bytes]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  one_of {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    // [deposit_stable] opcode = 192</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    uint64 sequence; // [8 bytes]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    // [repay_stable] opcode = 128</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    uint64 sequence; // [8 bytes]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    // [unlock_collateral] opcode = 64</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    bytes32 collorateral_token_address; // [32 bytes]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    uint128 amount; // [16 bytes]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    // [borrow_stable] opcode = 65</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    uint256 amount; // [16 bytes]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    // [claim rewards] opcode = 66</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    // N/A for now</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    // [redeem_stable] opcode = 193</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    uint64 sequence; // [8 bytes]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    // [lock_collateral] opcode = 129</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    uint64 sequence; // [8 bytes]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">*/</span></span></span></code></pre>\n<h2 id=\"l-03-slightly-imprecise-tax-calculation\" style=\"position:relative;\"><a href=\"#l-03-slightly-imprecise-tax-calculation\" aria-label=\"l 03 slightly imprecise tax calculation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Slightly imprecise tax calculation</h2>\n<h3 id=\"line-references-2\" style=\"position:relative;\"><a href=\"#line-references-2\" aria-label=\"line references 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-bAsset-contracts/packages/basset/src/tax_querier.rs#L12-L15\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-bAsset-contracts/packages/basset/src/tax_querier.rs#L12-L15</a></p>\n<p><a href=\"https://docs.anchorprotocol.com/developers-ethereum/fees#terra-blockchain-tax\">https://docs.anchorprotocol.com/developers-ethereum/fees#terra-blockchain-tax</a></p>\n<h3 id=\"description-2\" style=\"position:relative;\"><a href=\"#description-2\" aria-label=\"description 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>The tax amount is calculated as <code>amount * DENOM / DENOM + tax_rate</code> instead of <code>amount * tax_rate / DENOM</code>, which means the tax percentage isn’t as precise (less tax is actually charged).</p>\n<p>We see this in the test case:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// normal tax</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">assert_eq!</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">deduct_tax</span><span class=\"mtk1\">(&amp;deps.</span><span class=\"mtk11\">as_mut</span><span class=\"mtk1\">().querier, Coin::</span><span class=\"mtk11\">new</span><span class=\"mtk1\">(</span><span class=\"mtk7\">50000000u128</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;uusd&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">unwrap</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Coin {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    denom: </span><span class=\"mtk8\">&quot;uusd&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk11\">to_string</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    amount: Uint128::</span><span class=\"mtk11\">new</span><span class=\"mtk1\">(</span><span class=\"mtk7\">49504950u128</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Given an amount of <code>50_000_000</code>, assuming a tax rate of 1%,the amount after tax would be <code>0.99 * 50_000_000 = 49500000</code>, but the calculated amount is <code>50_000_000 * 100 / 101 ~= 49504950</code>.</p>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Update the calculation to be</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(coin.amount.</span><span class=\"mtk11\">checked_sub</span><span class=\"mtk1\">(coin.amount.</span><span class=\"mtk11\">multiply_ratio</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Uint128::</span><span class=\"mtk11\">new</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">) * tax_rate,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    DECIMAL_FRACTION,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)))?,</span></span></span></code></pre>\n<h2 id=\"l-04-duplicate-vesting-schedules-can-be-added\" style=\"position:relative;\"><a href=\"#l-04-duplicate-vesting-schedules-can-be-added\" aria-label=\"l 04 duplicate vesting schedules can be added permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Duplicate vesting schedules can be added</h2>\n<h3 id=\"line-references-3\" style=\"position:relative;\"><a href=\"#line-references-3\" aria-label=\"line references 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/staking/src/contract.rs\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/staking/src/contract.rs</a></p>\n<h3 id=\"description-3\" style=\"position:relative;\"><a href=\"#description-3\" aria-label=\"description 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>In the LP staking contract, it is possible to instantiate /  add duplicate vesting schedules.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">#[test]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">fn</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_instantiate_duplicate_schedules</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">mut</span><span class=\"mtk1\"> deps = </span><span class=\"mtk11\">mock_dependencies</span><span class=\"mtk1\">(&amp;[]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> msg = InstantiateMsg {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    anchor_token: </span><span class=\"mtk8\">&quot;reward0000&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk11\">to_string</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    staking_token: </span><span class=\"mtk8\">&quot;staking0000&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk11\">to_string</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    distribution_schedule: </span><span class=\"mtk11\">vec!</span><span class=\"mtk1\">[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">mock_env</span><span class=\"mtk1\">().block.time.</span><span class=\"mtk11\">seconds</span><span class=\"mtk1\">() + </span><span class=\"mtk7\">100</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">mock_env</span><span class=\"mtk1\">().block.time.</span><span class=\"mtk11\">seconds</span><span class=\"mtk1\">() + </span><span class=\"mtk7\">200</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\tUint128::</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1000000u128</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">mock_env</span><span class=\"mtk1\">().block.time.</span><span class=\"mtk11\">seconds</span><span class=\"mtk1\">() + </span><span class=\"mtk7\">100</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">mock_env</span><span class=\"mtk1\">().block.time.</span><span class=\"mtk11\">seconds</span><span class=\"mtk1\">() + </span><span class=\"mtk7\">200</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\tUint128::</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1000000u128</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> info = </span><span class=\"mtk11\">mock_info</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;addr0000&quot;</span><span class=\"mtk1\">, &amp;[]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> _res = </span><span class=\"mtk11\">instantiate</span><span class=\"mtk1\">(deps.</span><span class=\"mtk11\">as_mut</span><span class=\"mtk1\">(), </span><span class=\"mtk11\">mock_env</span><span class=\"mtk1\">(), info, msg).</span><span class=\"mtk11\">unwrap</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>De-duplicate the new vesting schedules when it is added. It is easier done if the schedules are sorted prior.</p>\n<h2 id=\"n-01-money-market-contracts-market-max_borrow_factor-is-not-capped\" style=\"position:relative;\"><a href=\"#n-01-money-market-contracts-market-max_borrow_factor-is-not-capped\" aria-label=\"n 01 money market contracts market max_borrow_factor is not capped permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] money-market-contracts: Market max_borrow_factor is not capped</h2>\n<h3 id=\"line-references-4\" style=\"position:relative;\"><a href=\"#line-references-4\" aria-label=\"line references 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line References</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/market/src/contract.rs#L66\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/market/src/contract.rs#L66</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/market/src/contract.rs#L321-L323\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/market/src/contract.rs#L321-L323</a></p>\n<h3 id=\"description-4\" style=\"position:relative;\"><a href=\"#description-4\" aria-label=\"description 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>There is no check to ensure that <code>max_borrow_factor</code> is less than 100% (<code>Decimal::One()</code>). It is therefore possible to set a borrow factor of > 1. However, the consequence of it is negligible because it would be the same as setting the value to 100% (can’t borrow if there is no liquidity left).</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Change the instantiation and update config test values to a value greater than 100%, such as <code>Decimal256::MAX</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/market/src/testing/tests.rs#L36\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/market/src/testing/tests.rs#L36</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">let</span><span class=\"mtk1\"> msg = InstantiateMsg {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  owner_addr: </span><span class=\"mtk8\">&quot;owner&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk11\">to_string</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  stable_denom: </span><span class=\"mtk8\">&quot;uusd&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk11\">to_string</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  aterra_code_id: </span><span class=\"mtk7\">123u64</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  anc_emission_rate: Decimal256::</span><span class=\"mtk11\">one</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  max_borrow_factor: Decimal256::MAX,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/market/src/testing/tests.rs#L215\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/market/src/testing/tests.rs#L215</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">let</span><span class=\"mtk1\"> msg = ExecuteMsg::UpdateConfig {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  owner_addr: None,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  interest_model: Some(</span><span class=\"mtk8\">&quot;interest2&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk11\">to_string</span><span class=\"mtk1\">()),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  distribution_model: Some(</span><span class=\"mtk8\">&quot;distribution2&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk11\">to_string</span><span class=\"mtk1\">()),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  max_borrow_factor: Some(Decimal256::</span><span class=\"mtk11\">percent</span><span class=\"mtk1\">(</span><span class=\"mtk7\">120</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Ensure <code>max_borrow_factor</code> doesn’t exceed <code>Decimal256::one()</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk3\">// add error in market/src/error.rs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk4\">pub</span><span class=\"mtk1\"> </span><span class=\"mtk4\">enum</span><span class=\"mtk1\"> </span><span class=\"mtk10\">ContractError</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  #[error(</span><span class=\"mtk8\">&quot;Setting greater than theoretical borrow factor&quot;</span><span class=\"mtk1\">)]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  MaxTheoreticalBorrowFactorExceeded {},</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk3\">// in market/src/contract.rs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"54\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"55\"></span><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> msg.max_borrow_factor &gt; Decimal256::</span><span class=\"mtk11\">one</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"56\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> Err(ContractError::MaxTheoreticalBorrowFactorExceeded {});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"57\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"58\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"59\"></span><span class=\"grvsc-source\"><span class=\"mtk3\">// in update_config()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"60\"></span><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> Some(max_borrow_factor) = max_borrow_factor {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"61\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> max_borrow_factor &gt; Decimal256::</span><span class=\"mtk11\">one</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"62\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> Err(ContractError::MaxTheoreticalBorrowFactorExceeded {});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"63\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"64\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">  config.max_borrow_factor = max_borrow_factor;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"65\"></span><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 id=\"n-02-incorrect-description-of-safe-ratio-in-documentation\" style=\"position:relative;\"><a href=\"#n-02-incorrect-description-of-safe-ratio-in-documentation\" aria-label=\"n 02 incorrect description of safe ratio in documentation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] Incorrect description of <code>Safe Ratio</code> in documentation</h2>\n<h3 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h3>\n<p><a href=\"https://docs.anchorprotocol.com/protocol/anchor-governance/modify-liquidation-parameters\">https://docs.anchorprotocol.com/protocol/anchor-governance/modify-liquidation-parameters</a></p>\n<h3 id=\"description-5\" style=\"position:relative;\"><a href=\"#description-5\" aria-label=\"description 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>The docs say that</p>\n<p>“A <strong>low</strong> <code>Safe Ratio</code> value allows for the fast liquidation of collaterals while incurring a high price impact for the collateral, while a <strong>low</strong> <code>Safe Ratio</code> value enforces liquidations with lower collateral price impact, albeit with slower collateral liquidation.”</p>\n<p>The second statement describes a <strong>high</strong> safe ratio.</p>\n<h3 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change to “while a <strong>high</strong> <code>Safe Ratio</code> value enforces liquidations with lower collateral price impact, albeit with slower collateral liquidation.”</p>\n<h2 id=\"n-03-typos--grammar\" style=\"position:relative;\"><a href=\"#n-03-typos--grammar\" aria-label=\"n 03 typos  grammar permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] Typos / Grammar</h2>\n<h3 id=\"description-6\" style=\"position:relative;\"><a href=\"#description-6\" aria-label=\"description 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>Do a CMD / CTRL + F for the following statements.</p>\n<h3 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ol>\n<li>\n<p><code>form</code> → <code>from</code></p>\n<ul>\n<li><code>// load price form the oracle</code> → <code>// load price from the oracle</code></li>\n<li><code>// load balance form the token contract</code> → <code>// load price from the token contract</code></li>\n</ul>\n</li>\n<li>\n<p><code>WITHDARW</code> → <code>WITHDRAW</code></p>\n<ul>\n<li><code>ALICE CAN ONLY WITHDARW 40 UST</code> → <code>ALICE CAN ONLY WITHDRAW 40 UST</code></li>\n</ul>\n</li>\n<li><code>// cannot liquidation collaterals</code> → <code>// cannot liquidate collaterals</code></li>\n<li>\n<p><code>// if the token contract is already register we cannot change the address</code> → <code>// if the token contract is already registered we cannot change the address</code></p>\n<ul>\n<li>Note the double spacing between <code>is</code> and <code>already</code></li>\n</ul>\n</li>\n<li>\n<p><code>inistantiation</code> → <code>instantiation</code></p>\n<ul>\n<li><code>// cannot register the token at the inistantiation</code> → <code>// cannot register token at instantiation</code></li>\n</ul>\n</li>\n</ol>\n<h2 id=\"n-04-outstanding-todo\" style=\"position:relative;\"><a href=\"#n-04-outstanding-todo\" aria-label=\"n 04 outstanding todo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] Outstanding TODO</h2>\n<h3 id=\"line-reference\" style=\"position:relative;\"><a href=\"#line-reference\" aria-label=\"line reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Line Reference</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/overseer/src/contract.rs#L395\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/overseer/src/contract.rs#L395</a></p>\n<h3 id=\"description-7\" style=\"position:relative;\"><a href=\"#description-7\" aria-label=\"description 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>There’s 1 remaining TODO that may not have been resolved.</p>\n<p><code>// TODO: Should this become a reply? If so which SubMsg to make reply_on?</code></p>\n<h2 id=\"suggestion-01-change-interest-rate-model-to-jump-rate-model\" style=\"position:relative;\"><a href=\"#suggestion-01-change-interest-rate-model-to-jump-rate-model\" aria-label=\"suggestion 01 change interest rate model to jump rate model permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[Suggestion-01] Change interest rate model to jump rate model</h2>\n<h3 id=\"reference-1\" style=\"position:relative;\"><a href=\"#reference-1\" aria-label=\"reference 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h3>\n<p><a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/interest_model/src/contract.rs#L114-L135\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/interest_model/src/contract.rs#L114-L135</a></p>\n<p><a href=\"https://github.com/compound-finance/compound-protocol/blob/master/contracts/JumpRateModel.sol\">https://github.com/compound-finance/compound-protocol/blob/master/contracts/JumpRateModel.sol</a></p>\n<p><a href=\"https://docs.benqi.fi/benqi-liquidity-market/protocol-parameters\">https://docs.benqi.fi/benqi-liquidity-market/protocol-parameters</a></p>\n<h3 id=\"description-8\" style=\"position:relative;\"><a href=\"#description-8\" aria-label=\"description 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>The current interest rate model used is a simple model that scales linearly with market utilization. A better interest rate model that Compound and its forks are using is the jump rate model, because it is more efficient at incentivizing liquidity at higher utilization rates.</p>\n<h3 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change the interest rate model to the jump rate model, where a kink is introduced to increase the interest multiplier after a specified market utilization rate.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/13#issuecomment-1205884657\">Alex the Entreprenerd (triage) commented</a>:</strong></p>\n<blockquote>\n<p>This looks like the most complete report.</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 8 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/12\">report highlighted below</a> by <strong>csanuragjain</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/26\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/52\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/14\">hickuphh3</a>, <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/53\">0v3rf10w</a>, <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/60\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/2\">robee</a>, and <a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/74\">IllIllI</a>.</em></p>\n<h2 id=\"g-01-anchor_basset_hub-contract--execute_register_validator-function\" style=\"position:relative;\"><a href=\"#g-01-anchor_basset_hub-contract--execute_register_validator-function\" aria-label=\"g 01 anchor_basset_hub contract  execute_register_validator function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] anchor_basset_hub contract :: execute_register_validator function</h2>\n<p>Function: execute_register_validator</p>\n<p>Contract: <a href=\"https://github.com/Anchor-Protocol/anchor-bAsset-contracts/blob/master/contracts/anchor_basset_hub/src/config.rs#L114\">https://github.com/Anchor-Protocol/anchor-bAsset-contracts/blob/master/contracts/anchor_basset_hub/src/config.rs#L114</a></p>\n<p>Problem: If a Validator is already registered there is no need of further processing. Check for same is missing</p>\n<p>Recommendation: Add a check to verify if the given validator is already whitelisted in which case directly return. Use is_valid_validator in state.rs for this purpose</p>\n<h2 id=\"g-02-gov-contract--withdraw_voting_tokens-function\" style=\"position:relative;\"><a href=\"#g-02-gov-contract--withdraw_voting_tokens-function\" aria-label=\"g 02 gov contract  withdraw_voting_tokens function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] gov contract :: withdraw_voting_tokens function</h2>\n<p>Function: withdraw_voting_tokens</p>\n<p>Contract: <a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/staking.rs#L87\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/staking.rs#L87</a></p>\n<p>Problem: Gas is wasted if withdraw_share is computed as 0</p>\n<p>Recommendation: Add a check for withdraw_share>0, otherwise return</p>\n<h2 id=\"g-03-gov-contract--create_poll-function\" style=\"position:relative;\"><a href=\"#g-03-gov-contract--create_poll-function\" aria-label=\"g 03 gov contract  create_poll function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] gov contract :: create_poll function</h2>\n<p>Function: create_poll</p>\n<p>Contract: <a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/contract.rs#L281\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/contract.rs#L281</a></p>\n<p>Recommendation: Change <code>state.poll_count += 1;</code> to <code>state.poll_count = poll_id;</code> to perform gas saving</p>\n<h2 id=\"g-04-gov-contract--cast_vote\" style=\"position:relative;\"><a href=\"#g-04-gov-contract--cast_vote\" aria-label=\"g 04 gov contract  cast_vote permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] gov contract :: cast_vote</h2>\n<p>Function: cast_vote</p>\n<p>Contract: <a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/contract.rs#L582\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/contract.rs#L582</a></p>\n<p>Problem: If amount is 0 then user vote gets wasted and also cause gas wastage</p>\n<p>Recommendation: check <code>amount!=0</code></p>\n<h2 id=\"g-05-community-contract--execute-function\" style=\"position:relative;\"><a href=\"#g-05-community-contract--execute-function\" aria-label=\"g 05 community contract  execute function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] community contract :: execute function</h2>\n<p>Function: execute</p>\n<p>Contract: <a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/community/src/contract.rs#L35\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/community/src/contract.rs#L35</a></p>\n<p>Recommendation:\nSince both function require governance, governance check can be placed in execute instead of placing individually in UpdateConfig and Spend as done in <a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/vesting/src/contract.rs\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/vesting/src/contract.rs</a></p>\n<h2 id=\"g-06-anchor_basset_reward--execute_increase_balanceexecute_decrease_balance\" style=\"position:relative;\"><a href=\"#g-06-anchor_basset_reward--execute_increase_balanceexecute_decrease_balance\" aria-label=\"g 06 anchor_basset_reward  execute_increase_balanceexecute_decrease_balance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] anchor_basset_reward :: execute_increase_balance/execute_decrease_balance</h2>\n<p>Function: execute_increase_balance/execute_decrease_balance</p>\n<p>Contract:<br>\n<a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-bAsset-contracts/contracts/anchor_basset_reward/src/user.rs#L80\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-bAsset-contracts/contracts/anchor_basset_reward/src/user.rs#L80</a>\n<a href=\"https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-bAsset-contracts/contracts/anchor_basset_reward/src/user.rs#L125\">https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-bAsset-contracts/contracts/anchor_basset_reward/src/user.rs#L125</a></p>\n<p>Recommendation:<br>\nIn both the function add a check for <code>amount!=0</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-anchor-findings/issues/12#issuecomment-1205887536\">Alex the Entreprenerd (triage) commented</a>:</strong></p>\n<blockquote>\n<p>Probably most interesting report.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-3\">High Risk Findings (3)</a></p>\n<ul>\n<li><a href=\"#h-01-spend-limit-on-owner-can-be-bypassed\">[H-01] Spend limit on owner can be bypassed</a></li>\n<li><a href=\"#h-02-money-market-contractsoraclefeed_prices-delayed-transaction-may-disrupt-price-feeds\">[H-02] <code>money-market-contracts/oracle#feed_prices()</code> delayed transaction may disrupt price feeds</a></li>\n<li><a href=\"#h-03-missing-access-control-for-fabricatemirclaim-and-fabricateancclaim\">[H-03] Missing Access Control for <code>FabricateMIRClaim</code> and <code>FabricateANCClaim</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-12\">Medium Risk Findings (12)</a></p>\n<ul>\n<li><a href=\"#m-01-when-transferring-tokens-not-in-whitelist-on-ethereum-to-terra-with-crossanchorbridgedepositstable-the-funds-may-get-frozen\">[M-01] When transferring tokens not in <code>whitelist</code> on Ethereum to Terra with <code>CrossAnchorBridge.depositStable()</code>, the funds may get frozen</a></li>\n<li><a href=\"#m-02-beth-rewards-may-be-depleted-by-flashloans-or-whales\">[M-02] <code>bEth</code> Rewards May Be Depleted By Flashloans or Whales</a></li>\n<li><a href=\"#m-03-governance-voting-dis-proportionally-favours-users-who-stake-and-vote-after-a-poll-has-been-created-and-had-its-snapshot-taken\">[M-03] Governance Voting Dis-proportionally Favours Users Who Stake And Vote After A Poll Has Been Created And Had Its Snapshot Taken</a></li>\n<li><a href=\"#m-04-sandwich-attack-on-astroport-sweep\">[M-04] Sandwich attack on astroport sweep</a></li>\n<li><a href=\"#m-05-anchor_basset_reward-pending-yields-can-be-stolen\">[M-05] <code>anchor_basset_reward</code> pending yields can be stolen</a></li>\n<li><a href=\"#m-06-simple-interest-calculation-is-not-exact\">[M-06] Simple interest calculation is not exact</a></li>\n<li><a href=\"#m-07-updating-the-hubs-token-contract-address-may-lead-to-incorrect-undelegation-amount\">[M-07] Updating the hub’s token contract address may lead to incorrect undelegation amount</a></li>\n<li><a href=\"#m-08-unbonding-validator-random-selection-can-be-predicted\">[M-08] Unbonding validator random selection can be predicted</a></li>\n<li><a href=\"#m-09-potential-lock-of-rewards-in-the-custody-contracts\">[M-09] Potential lock of rewards in the custody contracts</a></li>\n<li><a href=\"#m-10-possible-wrong-basset-rewardsborrow-limits-calculation\">[M-10] Possible Wrong bAsset Rewards/Borrow limits Calculation</a></li>\n<li><a href=\"#m-11-money-market-contractscontractsmarket-claim_rewards-may-revert-due-to-spend_limit-set-on-distributor-\">[M-11] <code>money-market-contracts/contracts/market</code> <code>claim_rewards</code> may revert due to <code>spend_limit</code> set on <code>distributor</code> </a></li>\n<li><a href=\"#m-12-staking-tokens-can-be-stolen\">[M-12] Staking tokens can be stolen</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#codebase-impressions--summary\">Codebase Impressions &#x26; Summary</a></li>\n<li><a href=\"#l-01-crossanchorbridge-decide-if-whitelisting-feature-is-to-be-kept-or-removed\">L-01 CrossAnchorBridge: Decide if whitelisting feature is to be kept or removed</a></li>\n<li><a href=\"#l-02-incorrect-opcode-specification-documentation\">L-02 Incorrect opcode specification documentation</a></li>\n<li><a href=\"#l-03-slightly-imprecise-tax-calculation\">L-03 Slightly imprecise tax calculation</a></li>\n<li><a href=\"#l-04-duplicate-vesting-schedules-can-be-added\">L-04 Duplicate vesting schedules can be added</a></li>\n<li><a href=\"#n-01-money-market-contracts-market-max_borrow_factor-is-not-capped\">N-01 money-market-contracts: Market max_borrow_factor is not capped</a></li>\n<li><a href=\"#n-02-incorrect-description-of-safe-ratio-in-documentation\">N-02 Incorrect description of <code>Safe Ratio</code> in documentation</a></li>\n<li><a href=\"#n-03-typos--grammar\">N-03 Typos / Grammar</a></li>\n<li><a href=\"#n-04-outstanding-todo\">N-04 Outstanding TODO</a></li>\n<li><a href=\"#suggestion-01-change-interest-rate-model-to-jump-rate-model\">Suggestion-01 Change interest rate model to jump rate model</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-anchor_basset_hub-contract--execute_register_validator-function\">G-01 anchor_basset_hub contract :: execute_register_validator function</a></li>\n<li><a href=\"#g-02-gov-contract--withdraw_voting_tokens-function\">G-02 gov contract :: withdraw_voting_tokens function</a></li>\n<li><a href=\"#g-03-gov-contract--create_poll-function\">G-03 gov contract :: create_poll function</a></li>\n<li><a href=\"#g-04-gov-contract--cast_vote\">G-04 gov contract :: cast_vote</a></li>\n<li><a href=\"#g-05-community-contract--execute-function\">G-05 community contract :: execute function</a></li>\n<li><a href=\"#g-06-anchor_basset_reward--execute_increase_balanceexecute_decrease_balance\">G-06 anchor_basset_reward :: execute_increase_balance/execute_decrease_balance</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the Anchor smart contract system written in Rust. The audit contest took place between February 24—March 9 2022.\n\n## Wardens\n\n20 Wardens contributed reports to the Anchor contest:\n\n  1. [cmichel](https://twitter.com/cmichelio)\n  1. WatchPug ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n  1. [jmak](https://twitter.com/jonathanjmak)\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. BondiPestControl ([leastwood](https://twitter.com/0xleastwood) and [kirk-baird](https://twitter.com/kirkthebaird))\n  1. [defsec](https://twitter.com/defsec_)\n  1. hubble (ksk2345 and shri4net)\n  1. broccoli ([shw](https://github.com/x9453) and [jonah1005](https://twitter.com/jonah1005w))\n  1. [hickuphh3](https://twitter.com/HickupH)\n  1. [gzeon](https://twitter.com/gzeon)\n  1. 0xwags\n  1. robee\n  1. IllIllI\n  1. [0xliumin](https://twitter.com/0xliumin)\n  1. cccz\n  1. [0v3rf10w](https://twitter.com/_0v3rf10w)\n\nThis contest was judged by [Albert Chon](https://github.com/albertchon).\n\nTriage performed by [Alex the Entreprenerd](https://twitter.com/GalloDaSballo).\n\nFinal report assembled by [liveactionllama](https://twitter.com/liveactionllama).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 15 unique vulnerabilities. Of these vulnerabilities, 3 received a risk rating in the category of HIGH severity and 12 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 13 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 8 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 Anchor contest repository](https://github.com/code-423n4/2022-02-anchor).\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# High Risk Findings (3)\n## [[H-01] Spend limit on owner can be bypassed](https://github.com/code-423n4/2022-02-anchor-findings/issues/11)\n*Submitted by csanuragjain, also found by cmichel*\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/distributor/src/contract.rs#L140><br>\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/community/src/contract.rs#L69><br>\n\nIt seems that the owner is only allowed to spend amount uptil config.spend\\_limit. However it was observed that this `config.spend_limit` is never decreased even if owner has spend an amount. This makes `config.spend_limit` useless as owner can simply send 2-multiple transactions each of `config.spend_limit` which will all pass and hence bypassing the spend limit placed on owner.\n\n### Proof of Concept\n\n1.  Assume spend limit of 100 is placed on owner\n2.  Owner simply calls the spend function at either distributor or community contract with amount 100\n3.  Ideally after this transaction owner should not be allowed to perform any more spend operation\n4.  Since `config.spend_limit` remains unchanged, owner can call step 2 multiple times which will spend amount 100 several times bypassing spend limit\n\n### Recommended Mitigation Steps\n\nAfter successful spend, the `config.spend_limit` should be decreased by the amount spend.\n\n**[Albert Chon (judge) commented via duplicate issue #34](https://github.com/code-423n4/2022-02-anchor-findings/issues/34#issuecomment-1250500683):**\n > Indeed, this is a serious oversight, unless one expects the whitelisted addresses to not exceed the spend limit (which is not a good assumption to bake in). \n\n\n\n***\n\n## [[H-02] `money-market-contracts/oracle#feed_prices()` delayed transaction may disrupt price feeds](https://github.com/code-423n4/2022-02-anchor-findings/issues/47)\n*Submitted by WatchPug*\n\n<https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/money-market-contracts/contracts/oracle/src/contract.rs#L106-L113>\n\nThe implementation only takes two attributes: `asset` and `price`. And the `last_updated_time` of the record will always be set to the current `block.time`.\n\nThis makes it possible for the price feeds to be disrupted when the network is congested, or the endpoint is down for a while, or the `feeder` bot handled the message queue inappropriately, as a result, the transactions with stale prices get accepted as fresh prices.\n\nSince the price feeds are essential to the protocol, that can result in users' positions being liquidated wrongfully and case fund loss to users.\n\n### Proof of Concept\n\nGiven:\n\n*   `feeder` i connected to an endpoint currently experiencing degraded performance;\n*   ETH price is `$10,000`;\n*   The `max_ltv` ratio of ETH is `60%`.\n\n1.  Alice borrowed `5,000 USDC` with `1 ETH` as collateral;\n2.  ETH price dropped to `$9,000`, to avoid liquidation, Alice repaid `1,000 USD`;\n3.  The price of ETH dropped to `$8,000`; `feeder` tries to `updateMainFeedData()` with the latest price: `$8,000`, however, since the network is congested, the transactions were not get packed timely;\n4.  ETH price rebound to `$10,000`; Alice borrowed another `1,000 USDC`;\n5.  The txs send by `feeder` at step 3 finally got packed, the protocol now believes the price of ETH has suddenly dropped to `$8,000`, as a result, Alice's position got liquidated.\n\n### Recommended Mitigation Steps\n\nChange to:\n\n```solidity\npub fn feed_prices(\n    deps: DepsMut,\n    env: Env,\n    info: MessageInfo,\n    prices: Vec<(String, Decimal256, u64)>,\n) -> Result<Response, ContractError> {\n    let mut attributes = vec![attr(\"action\", \"feed_prices\")];\n    let sender_raw = deps.api.addr_canonicalize(info.sender.as_str())?;\n    for price in prices {\n        let asset: String = price.0;\n        let mut updated_time: u64 = price.2;\n        let price: Decimal256 = price.1;\n\n        // Check feeder permission\n        let feeder = read_feeder(deps.storage, &asset)?;\n        if feeder != sender_raw {\n            return Err(ContractError::Unauthorized {});\n        }\n\n        let config: Config = read_config(deps.storage)?;\n        if env.block.time.seconds() > updated_time {\n            // reject stale price\n            if env.block.time.seconds() - updated_time > config.valid_period {\n                return Err(ContractError::InvalidInputs {});\n            }\n        } else {\n            // reject future timestamp, graceFuturePeriod can be set to 3, which means < 3s is allowed\n            if updated_time - env.block.time.seconds() > config.grace_future_period {\n                return Err(ContractError::InvalidInputs {});\n            }\n            updated_time = env.block.time.seconds();\n        }\n\n        attributes.push(attr(\"asset\", asset.to_string()));\n        attributes.push(attr(\"price\", price.to_string()));\n\n        store_price(\n            deps.storage,\n            &asset,\n            &PriceInfo {\n                last_updated_time: updated_time,\n                price,\n            },\n        )?;\n    }\n\n    Ok(Response::new().add_attributes(attributes))\n}\n```\n\n**[bitn8 (Anchor) disputed and commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/47#issuecomment-1102992100):**\n > We currently have a mean shorting function that pulls multiple price feeds so that if one is stale it gets rejected. \n\n**[Alex the Entreprenerd (triage) commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/47#issuecomment-1205898865):**\n > Seems like the warden has shown a specific scenario, contingent on external conditions.\n> \n> However, from the code, there seems to be no \"mean shorting function\", at least in the code in scope.\n\n**[Albert Chon (judge) commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/47#issuecomment-1251670569):**\n > Agreed with @Alex the Entreprenerd, oracle staleness is still an issue in this version of the code. \n\n\n\n***\n\n## [[H-03] Missing Access Control for `FabricateMIRClaim` and `FabricateANCClaim`](https://github.com/code-423n4/2022-02-anchor-findings/issues/58)\n*Submitted by jmak*\n\n<https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_airdrop_registry/src/contract.rs#L109><br>\n<https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_airdrop_registry/src/contract.rs#L71><br>\n\n`FabricateMIRClaim` and `FabricateANCClaim` should only be issued by the Hub contract (the central hub for all minted bLuna managed by Lido). However, `execute_fabricate_anchor_claim` and `execute_fabricate_mir_claim` do not restrict the caller, allowing anyone to submit these msgs.\n\n### Recommended Mitigation Steps\n\nRecommended to add at least simple access control checks in the contract to ensure that these functions can only be called by the Hub and not by others.\n\nSee a below for a potential code snippet.\n\n    // only hub contract can send this message.\n    let config = read_config(deps.storage)?;\n    let sender_raw = deps.api.addr_canonicalize(&info.sender.to_string())?;\n    if sender_raw != config.hub_contract {\n        return Err(StdError::generic_err(\"unauthorized\"));\n    }\n\n**[Alex the Entreprenerd (triage) commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/58#issuecomment-1207280476):**\n > The finding is correct in that anyone can call the function.\n> \n> The finding lacks any form of impact as to what would happen.\n> \n> I think these may be test functions also.\n> \n> Not convinced the report makes sense for high severity given the lack of detail.\n\n\n\n***\n \n# Medium Risk Findings (12)\n## [[M-01] When transferring tokens not in `whitelist` on Ethereum to Terra with `CrossAnchorBridge.depositStable()`, the funds may get frozen](https://github.com/code-423n4/2022-02-anchor-findings/issues/44)\n*Submitted by WatchPug, also found by BondiPestControl, broccoli, and defsec*\n\nIn the current implementation of `CrossAnchorBridge`, all `require` that \"Check that `token` is a whitelisted token\" is commented out.\n\nAs a result, users may send transcations with the non-whitelisted tokens and as they can not be processd properly on the Terra side, the funds can be frozen on the brige contract or on the Terra side.\n\n<https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L167-L175>\n\n```solidity\nfunction handleStableToken(\n        address token,\n        uint256 amount,\n        uint8 opCode\n    ) internal {\n        // Check that `token` is a whitelisted stablecoin token.\n        // require(whitelistedStableTokens[token]);\n        handleToken(token, amount, opCode);\n    }\n```\n\n<https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L250-L253>\n\n```solidity\nfunction redeemStable(address token, uint256 amount) external {\n        // require(whitelistedAnchorStableTokens[token]);\n        handleToken(token, amount, OP_CODE_REDEEM_STABLE);\n    }\n```\n\n<https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L255-L258>\n\n```solidity\nfunction lockCollateral(address token, uint256 amount) external {\n        // require(whitelistedCollateralTokens[token]);\n        handleToken(token, amount, OP_CODE_LOCK_COLLATERAL);\n    }\n```\n\n### Recommended Mitigation Steps\n\nUncomment the whitelist codes.\n\n**[bitn8 (Anchor) disagreed with severity](https://github.com/code-423n4/2022-02-anchor-findings/issues/44)**\n\n**[Alex the Entreprenerd (triage) commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/44#issuecomment-1205878804):**\n > Seems conditional, would recommend downgrading to Medium.\n\n**[Albert Chon (judge) decreased severity to Medium](https://github.com/code-423n4/2022-02-anchor-findings/issues/44)**\n\n\n\n***\n\n## [[M-02] `bEth` Rewards May Be Depleted By Flashloans or Whales](https://github.com/code-423n4/2022-02-anchor-findings/issues/24)\n*Submitted by BondiPestControl, also found by cmichel*\n\n<https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bEth-contracts/contracts/anchor_beth_reward/src/user.rs#L187-L212>\n\nRewards are dispersed to users as a percentage of the user's balance vs total balance (of `bEth`). Rewards are accumulated each time a user calls `execute_decrease_balance()`, `execute_increase_balance()` or `execute_claim_rewards()` as these functions will in term call `update_global_index()` before any balance adjustments.\n\nThere is an attack vector where a user may arbitrarily increase their `bEth` balance either by flashloan of purchase of wormhole eth, then converting it bEth via `anchor_beth_converter`. The attacker may then have a significant portion of the total balance. This use can then call the contract which pushes rewards to `anchor_beth_reward` this will increase the `reward_balance` of the contract. Since the attacker controls a large portion of the bEth balance they will receive a higher portion of the rewards. They may then convert the bEth back to wormhole eth and close their position.\n\nThe result is the user has not contributed anything to the system but still gained a high portion of the rewards.\n\n### Proof of Concept\n\nThe logic for `update_global_index()` does not account for users suddenly increasing the balance.\n\n    fn update_global_index(state: &mut State, reward_balance: Uint128) -> StdResult<()> {\n        // Zero staking balance check\n        if state.total_balance.is_zero() {\n            // nothing balance, skip update\n            return Ok(());\n        }\n\n        // No change check\n        if state.prev_reward_balance == reward_balance {\n            // balance didnt change, skip update\n            return Ok(());\n        }\n\n        // claimed_rewards = current_balance - prev_balance;\n        let claimed_rewards = reward_balance.checked_sub(state.prev_reward_balance)?;\n\n        // update state\n        state.prev_reward_balance = reward_balance;\n        // global_index += claimed_rewards / total_balance;\n        state.global_index = decimal_summation_in_256(\n            state.global_index,\n            Decimal::from_ratio(claimed_rewards, state.total_balance),\n        );\n\n        Ok(())\n    }\n\nSteps:<br>\na) Flashloan (or buy) a significant portion of wormhole Eth<br>\nb) Convert to Anchor bEth via `anchor_beth_converter`<br>\nc) Push rewards on `anchor_beth_rewards`<br>\nd) `anchor_beth_rewards::execute_claim_rewards()`<br>\ne) Convert Anchor bEth to wormhole Eth<br>\nf) Repay flashloan (or sell wormhole eth)<br>\n\n### Recommended Mitigation Steps\n\nThere are multiple possible mitigations to this issue.\n\nFirst, option is to only allow the `global_index` to be updated once per block. In addition to this, cap the amount of rewards that may be paid per block (keeping the remaining rewards for the next block). This would reduce the effectiveness of the attack and limit the amount they may earn per block.\n\nAnother option is to induce a wait time before the user may begin earning rewards. However, this would require a second transaction from the user to begin collection their reward which may hurt UX.\n\n\n\n***\n\n## [[M-03] Governance Voting Dis-proportionally Favours Users Who Stake And Vote After A Poll Has Been Created And Had Its Snapshot Taken](https://github.com/code-423n4/2022-02-anchor-findings/issues/64)\n*Submitted by BondiPestControl*\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/contract.rs#L543-L580><br>\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/contract.rs#L582-L665><br>\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/staking.rs#L15-L57><br>\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/contract.rs#L364-L455><br>\n\nPolls are created by targeting the `receive_cw20` function which is queried whenever the contract receives tokens. By setting the hook message to `Cw20HookMsg::CreatePoll`, the sender is able to create a poll, assuming the amount sent satisfies the minimum deposit amount for poll creation. Users can also choose to call `ExecuteMsg::SnapshotPoll` or have it handled automatically when a user casts a vote on the newly created poll.\n\nThe snapshot simply sets `a_poll.staked_amount`, which represents the total staked amount within the governance contract at a given block. However, during the voting period, other users can stake tokens and effectively have an increasing influence over the outcome of a given poll. There are no check-pointed balances to ensure that a certain user had staked tokens at the time the poll had its snapshot taken.\n\nThis can be abused to skew poll results in favour of users who stake their Anchor tokens after a poll has had its snapshot taken.\n\n### Proof of Concept\n\nLet's assume the share to token exchange rate is `1:1` such that if a user deposits 100 Anchor tokens, they receive 100 shares in return.\n\nConsider the following scenario:\n\n*   There are a total of 100 Anchor tokens in the Governance contract.\n*   Alice creates a poll and executes `ExecuteMsg::SnapshotPoll` such that `a_poll.staked_amount == 100`.\n*   Bob deposits 10 Anchor tokens through the `Cw20HookMsg::StakeVotingTokens` hook message which increases the contract's total balance to 110 and shares to 110 as the exchange rate is `1:1` upon minting and redeeming shares.\n*   At this point, the target poll has a `a_poll.staked_amount == 100`, even though there are really 110 Anchor tokens staked.\n*   As a result, if Bob votes on a poll, they have a 10% degree of influence on the outcome of the poll, even though they have less than 10% of the total staked tokens (i.e. 10/110).\n*   Therefore, poll voters are actually incentivised to stake tokens after a poll has had its snapshot taken in order to maximise their voting power.\n\n### Recommended Mitigation Steps\n\nConsider implementing a check-pointing mechanism such that when a user casts a vote, the user's staked balance is checked at the block height upon which the snapshot was taken instead of checking its most up-to-date staked balance. This check-pointing behaviour is implemented on Ethereum which has a more restrictive block space. The mechanism will simply store the staker's balance on each stake/unstake action. When user's wish to vote, the protocol will check the balance at a specific block (i.e. the snapshotted block). An example implementation can be found [here](https://github.com/compound-finance/compound-protocol/blob/master/contracts/Governance/Comp.sol#L189-L221).\n\n**[bitn8 (Anchor) disagreed with severity and commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/64#issuecomment-1103012664):**\n > I wouldn't call this a critical bug. Nevertheless, this will be addressed with ve-ANC tokenomics where tokens have to lock for periods of time (curve lock tokenomics). \n\n**[Alex the Entreprenerd (triage) commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/64#issuecomment-1207279376):**\n > Loss of Yield = Medium seems appropriate\n\n\n\n***\n\n## [[M-04] Sandwich attack on astroport sweep](https://github.com/code-423n4/2022-02-anchor-findings/issues/33)\n*Submitted by cmichel*\n\n<https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts%2Fanchor-token-contracts%2Fcontracts%2Fcollector%2Fsrc%2Fcontract.rs#L130-L137>\n\nThe collector contract allows anyone to `sweep`, swapping an asset token to ANC through astro port.<br>\nNote that `belief_price` is not set and `config.max_spread` might not be set as well or misconfigured.\n\nThis allows an attacker to create a contract to perform a sandwich attack to make a profit on this trade.\n\n> A common attack in DeFi is the sandwich attack. Upon observing a trade of asset X for asset Y, an attacker frontruns the victim trade by also buying asset Y, lets the victim execute the trade, and then backruns (executes after) the victim by trading back the amount gained in the first trade. Intuitively, one uses the knowledge that someone’s going to buy an asset, and that this trade will increase its price, to make a profit. The attacker’s plan is to buy this asset cheap, let the victim buy at an increased price, and then sell the received amount again at a higher price afterwards.\n\nTrades can happen at a bad price and lead to receiving fewer tokens than at a fair market price.<br>\nThe attacker's profit is the protocol's loss.\n\n### Proof of Concept\n\nAttacker creates a contract that triggers 3 messages for the sandwich attack:\n\n*   Astroport: buy ANC with asset\n*   Call `sweep` which trades at bad price\n*   Astroport: sell assets from the first message for profit\n\n### Recommended Mitigation Steps\n\nConsider setting a ANC/asset `belief_price` from an oracle.\n\n**[bitn8 (Anchor) disagreed with severity and commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/33#issuecomment-1103023318):**\n > While it might certainly be possible to sandwich an attack like this, there is no risk to users' funds outside a possible bad fill price. There are many other issues at work here too such as UNI v2 that Astro is built on and volatility. This assumes very illiquid markets or huge wallets to move prices like this. \n\n**[Alex the Entreprenerd (triage) commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/33#issuecomment-1207282229):**\n > - Anyone can call = can set up a price imbalance\n> - Is a sweep (prob dust amount)\n> \n> Looks valid but impact seems reduced.\n\n\n\n***\n\n## [[M-05] `anchor_basset_reward` pending yields can be stolen](https://github.com/code-423n4/2022-02-anchor-findings/issues/48)\n*Submitted by WatchPug, also found by csanuragjain*\n\nFor yield farming aggregators, if the pending yield on an underlying strategy can be harvested and cause a surge of rewards to all existing investors, especially if the harvest can be triggered permissionlessly. Then the attacker can amplify the attack using a flash loan.\n\nThis is a well-known attack vector on Ethereum.\n\nThe root cause for this attack vector is that the pending yield is not settled to the existing users before issuing shares to new deposits.\n\nIn the current implementation of anchor\\_basset\\_reward/src/user.rs#execute\\_increase\\_balance() before L105, the `state.global_index` is not being upadted first.\n\n*   Expected: the pending rewards (current\\_global\\_index - state.global\\_index) belongs to old user balance,\n*   Current implementation: the pending rewards (current\\_global\\_index - state.global\\_index) will be multiplied by the new user balance after `increase_balance` when calculate rewards.\n\nBecause new user balance > old user balance, the user will take a part of the rewards belonging to other existing users.\n\n<https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_basset_reward/src/user.rs#L80-L123>\n\n```rust\npub fn execute_increase_balance(\n    deps: DepsMut,\n    _env: Env,\n    info: MessageInfo,\n    address: String,\n    amount: Uint128,\n) -> StdResult<Response<TerraMsgWrapper>> {\n    let config = read_config(deps.storage)?;\n    let owner_human = deps.api.addr_humanize(&config.hub_contract)?;\n    let address_raw = deps.api.addr_canonicalize(&address)?;\n    let sender = info.sender;\n\n    let token_address = deps\n        .api\n        .addr_humanize(&query_token_contract(deps.as_ref(), owner_human)?)?;\n\n    // Check sender is token contract\n    if sender != token_address {\n        return Err(StdError::generic_err(\"unauthorized\"));\n    }\n\n    let mut state: State = read_state(deps.storage)?;\n    let mut holder: Holder = read_holder(deps.storage, &address_raw)?;\n\n    // get decimals\n    let rewards = calculate_decimal_rewards(state.global_index, holder.index, holder.balance)?;\n\n    holder.index = state.global_index;\n    holder.pending_rewards = decimal_summation_in_256(rewards, holder.pending_rewards);\n    holder.balance += amount;\n    state.total_balance += amount;\n\n    store_holder(deps.storage, &address_raw, &holder)?;\n    store_state(deps.storage, &state)?;\n\n    let attributes = vec![\n        attr(\"action\", \"increase_balance\"),\n        attr(\"holder_address\", address),\n        attr(\"amount\", amount),\n    ];\n\n    let res = Response::new().add_attributes(attributes);\n    Ok(res)\n}\n```\n\n### Proof of Concept\n\nGiven:\n\n*   the reward balance of `anchor_basset_reward` increased\n\nThe attacker can:\n\n1.  `bond` a large amount of asset tokens\n\n<!---->\n\n    -   [anchor_basset_hub](https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_basset_hub/src/bond.rs#L88-L107) will trigger `anchor_basset_token` to mint basset tokens to the attacker\n    -   [anchor_basset_token](https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_basset_token/src/handler.rs#L90-L98) will trigger `anchor_basset_reward` to IncreaseBalance for the attacker\n    -   [anchor_basset_reward](https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_basset_reward/src/user.rs#L107) will use the old `state.global_index` to update the attacker's `holder.index`\n\n2.  `UpdateGlobalIndex` on anchor\\_basset\\_hub\n    *   [`anchor_basset_hub`](https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_basset_hub/src/contract.rs#L258-L262) will trigger anchor\\_basset\\_reward's  `execute_update_global_index()` and increase `global_index` for all users\n\nAs of now, the attacker can get a large share of the pending yield. The attacker can claim the rewards and exit.\n\nThis process can be done in one transaction by using a smart contract, and the impact can be amplified by using a flash loan.\n\n### Recommended Mitigation Steps\n\nConsider changing to a similar approach like [`anchor_beth_reward/src/user.rs#L114`](https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bEth-contracts/contracts/anchor_beth_reward/src/user.rs#L114), update `state.global_index` before changing the user's balance.\n\nAnd/or, transfer rewards and update `global_index` in one transaction.\n\n**[Alex the Entreprenerd (triage) commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/48#issuecomment-1205896976):**\n > Seems like loss of yield due to frontrun.\n\n**[Albert Chon (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/48#issuecomment-1251627358):**\n > Indeed a bug, although this bug can be mitigated in practice by continuously executing `UpdateGlobalIndex`, doing so shouldn't necessarily be a requirement for the functioning of the system.  \n\n\n\n***\n\n## [[M-06] Simple interest calculation is not exact](https://github.com/code-423n4/2022-02-anchor-findings/issues/41)\n*Submitted by cmichel*\n\n<https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts%2Fmoney-market-contracts%2Fcontracts%2Fmarket%2Fsrc%2Fborrow.rs#L304>\n\nThe borrow rate uses a simple interest formula to compute the accrued debt, instead of a compounding formula.\n\n```rust\npub fn compute_interest_raw(\n    state: &mut State,\n    block_height: u64,\n    balance: Uint256,\n    aterra_supply: Uint256,\n    borrow_rate: Decimal256,\n    target_deposit_rate: Decimal256,\n) {\n  // @audit simple interest\n    let passed_blocks = Decimal256::from_uint256(block_height - state.last_interest_updated);\n\n    let interest_factor = passed_blocks * borrow_rate;\n    let interest_accrued = state.total_liabilities * interest_factor;\n    // ...\n}\n```\n\nThis means the actual borrow rate and interest for suppliers depend on how often updates are made.<br>\nThis difference should be negligible in highly active markets, but it could lead to a lower borrow rate in low-activity markets, leading to suppliers losing out on interest.\n\n### Recommended Mitigation Steps\n\nEnsure that the markets are accrued regularly, or switch to a compound interest formula (which has a higher computational cost due to exponentiation, but can be approximated, see Aave).\n\n**[Alex the Entreprenerd (triage) commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/41#issuecomment-1207281281):**\n > Without Code and explanation, I'm skeptical of Med (loss of yield), as it could just be dust amount, provided that interest is compounded roughly 1 per month or similar (see compound interest math, and how `e` limits max autocompounds to dust variation)\n> \n> Either way, the observation is correct.\n\n\n\n***\n\n## [[M-07] Updating the hub’s token contract address may lead to incorrect undelegation amount](https://github.com/code-423n4/2022-02-anchor-findings/issues/62)\n*Submitted by hubble*\n\n<https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_basset_hub/src/config.rs#L90-L97>\n\nThe hub contract allows config updates to the `token_contract` config values in `anchor-bAsset-contracts/contracts/anchor_basset_hub/src/config.rs`.<br>\nSuch updates can cause wrong amounts of tokens to be calculated during processing of undelegations, since the amount of unbonded bLuna tokens is stored for batched unbonding as `requested_with_fee`.\n\n### Proof of Concept\n\nContract : anchor-bAsset-contracts/contracts/anchor\\_basset\\_hub/src/config.rs<br>\nFunction : pub fn execute\\_update\\_config(...)<br>\nLine 90 :<br>\n\n        if let Some(token) = token_contract {\n            let token_raw = deps.api.addr_canonicalize(token.as_str())?;\n\n            CONFIG.update(deps.storage, |mut last_config| -> StdResult<Config> {\n                last_config.token_contract = Some(token_raw);\n                Ok(last_config)\n            })?;\n        }\n\n### Recommended Mitigation Steps\n\nIts recommended to remove the ability to update `token_contract` config value, or asserting that `requested_with_fee` is zero before allowing an update of the `token_contract` address.\n\n**[Alex the Entreprenerd (triage) commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/62#issuecomment-1207279889):**\n > Looks like Admin Privilege so Medium seems appropriate.\n\n\n\n***\n\n## [[M-08] Unbonding validator random selection can be predicted](https://github.com/code-423n4/2022-02-anchor-findings/issues/29)\n*Submitted by cmichel*\n\nWhen unbonding, the `pick_validator` function is supposed to choose a random validator to unstake from.<br>\nHowever, this randomness can be predicted knowing the block height which is very easy to predict.\n\n```rust\nlet mut iteration_index = 0;\n\nwhile claimed.u128() > 0 {\n    let mut rng = XorShiftRng::seed_from_u64(block_height + iteration_index);\n    let random_index = rng.gen_range(0, deletable_delegations.len());\n    // ...\n}\n```\n\nAs validators are paid rewards proportional to their stake, choosing where to bond and unbond from directly impacts validator rewards.<br>\nCombined with being able to choose the validator when bonding (see [`execute_bond`](https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-bAsset-contracts/contracts/anchor_basset_hub/src/bond.rs#L15)) a validator can steal rewards and increase their own.\n\n### Proof of Concept\n\n1.  Validator A wishes to increase their rewards. They call ` execute_bond(, validator = A)  ` with their validator.\n2.  Validator A precomputes the randomness for unbonding if the block was mined at the next block height. If it's a different validator, they call `unbond`. The stake is removed from some other validator and the user receives it back. Note that validator A's stake did not decrease and contains the initial bond amount.\n3.  They repeat this process until every single bond of the Anchor platform is now staked to validator A and they earn huge rewards while everyone else does not earn anything from Anchor bonds anymore.\n\n### Recommended Mitigation Steps\n\nAn `unbond` must always remove stake from the validator the stake was originally bonded to, otherwise, it's exploitable by the attack above.<br>\nConsider keeping track of all bonds with a `bond_id` and create a map of `bond_id -> validator`.<br>\nIf a validator's stake decreased due to slashing, take the remaining unstake amount proportionally from all other validators.<br>\n\n**[bitn8 (Anchor) disagreed with severity](https://github.com/code-423n4/2022-02-anchor-findings/issues/29)**\n\n**[Alex the Entreprenerd (triage) commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/29#issuecomment-1207282803):**\n > Looks like weak RNG, Medium or High seem proper.\n\n**[Albert Chon (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/29#issuecomment-1251643195):**\n > Indeed, block height should definitely not be used as a source of randomness. \n\n\n\n***\n\n## [[M-09] Potential lock of rewards in the custody contracts](https://github.com/code-423n4/2022-02-anchor-findings/issues/71)\n*Submitted by broccoli*\n\nThe `swap_to_stable_denom` function in the custody contracts swaps all other native tokens into a specific one. The function creates swap messages for all the other native tokens and adds them as sub-messages, and handles the reply only when the last sub-message succeeds. Upon receiving the reply, the contract sends the swapped tokens (i.e., rewards) to the overseer contract.\n\nIn cases where the last sub-message fails, the custody contract will not receive a reply, and therefore the rewards are left in the contract. The rewards are locked in the contract until someone triggers `swap_to_stable_denom` again, and the last swap succeeds. However, if the last swap consistently fails in some period for any reason, the total rewards will be locked in the contract during that period. As a result, users cannot get the rewards they are supposed to receive in that period.\n\n### Proof of Concept\n\nReferenced code:<br>\n[`custody_beth/src/distribution.rs#L110-L115`](https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/custody_beth/src/distribution.rs#L110-L115)<br>\n[`custody_bluna/src/distribution.rs#L109-L114`](https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/custody_bluna/src/distribution.rs#L109-L114)<br>\n\n### Recommended Mitigation Steps\n\nConsider handling the reply on either success or failure, i.e., using `ReplyOn::Always`, to avoid the failure of the swap to cause tokens to be locked.\n\n**[bitn8 (Anchor) disagreed with severity](https://github.com/code-423n4/2022-02-anchor-findings/issues/71)**\n\n**[Alex the Entreprenerd (triage) commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/71#issuecomment-1205890442):**\n > Reliant on external conditions. Severity seems appropriate.\n\n\n\n***\n\n## [[M-10] Possible Wrong bAsset Rewards/Borrow limits Calculation](https://github.com/code-423n4/2022-02-anchor-findings/issues/9)\n*Submitted by defsec*\n\nDuring the code review, It has been observed that reward calculation has been done with execute\\_epoch\\_operations function. However, the config are stored in the storage. When the anc\\_purchase\\_factor is updated by the owner, the execute\\_epoch\\_operations is not called.\n\n### Proof of Concept\n\n1.  Navigate to the following contract.\n\n<!---->\n\n    https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/overseer/src/contract.rs#L192\n\n2.  Config is updated with update\\_config function.\n\n```\n\n    if let Some(threshold_deposit_rate) = threshold_deposit_rate {\n        config.threshold_deposit_rate = threshold_deposit_rate;\n    }\n\n    if let Some(buffer_distribution_factor) = buffer_distribution_factor {\n        config.buffer_distribution_factor = buffer_distribution_factor;\n    }\n\n    if let Some(anc_purchase_factor) = anc_purchase_factor {\n        config.anc_purchase_factor = anc_purchase_factor;\n    }\n\n    if let Some(target_deposit_rate) = target_deposit_rate {\n        config.target_deposit_rate = target_deposit_rate;\n    }\n\n    if let Some(epoch_period) = epoch_period {\n        config.epoch_period = epoch_period;\n    }\n\n    if let Some(price_timeframe) = price_timeframe {\n        config.price_timeframe = price_timeframe;\n    }\n```\n\n3.  After the update, execute\\_epoch\\_operations function is not called. That will cause to out-of-date data.\n\n### Recommended Mitigation Steps\n\nConsider calling execute\\_epoch\\_operations function after config update.\n\n**[Alex the Entreprenerd (triage) commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/9#issuecomment-1207420289):**\n > Confirmed Lack of validation.\n\n**[Albert Chon (judge) commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/9#issuecomment-1251666145):**\n > Good catch.\n\n\n\n***\n\n## [[M-11] `money-market-contracts/contracts/market` `claim_rewards` may revert due to `spend_limit` set on `distributor` ](https://github.com/code-423n4/2022-02-anchor-findings/issues/46)\n*Submitted by WatchPug*\n\nWhile `claim_rewards` from the `money-market`, it calls the `distributor_contract#spend()` to send the rewards.\n\n<https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/money-market-contracts/contracts/market/src/borrow.rs#L216-L234>\n\n```rust\nlet messages: Vec<CosmosMsg> = if !claim_amount.is_zero() {\n    vec![CosmosMsg::Wasm(WasmMsg::Execute {\n        contract_addr: deps\n            .api\n            .addr_humanize(&config.distributor_contract)?\n            .to_string(),\n        funds: vec![],\n        msg: to_binary(&FaucetExecuteMsg::Spend {\n            recipient: if let Some(to) = to {\n                to.to_string()\n            } else {\n                borrower.to_string()\n            },\n            amount: claim_amount.into(),\n        })?,\n    })]\n} else {\n    vec![]\n};\n```\n\nHowever, the `distributor_contract#spend()` function have a `spend_limit` config and it will revert if the amount is larger than the `spend_limit`.\n\n<https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-token-contracts/contracts/distributor/src/contract.rs#L153-L155>\n\n```rust\nif config.spend_limit < amount {\n    return Err(StdError::generic_err(\"Cannot spend more than spend_limit\"));\n}\n```\n\nAs a result, users won't be able to claim their rewards anymore once the amount of the rewards excess the `spend_limit` config on `distributor_contract`.\n\n### Recommended Mitigation Steps\n\nConsider removing the `spend_limit` or allowing users to specify an amount when `claim_rewards`.\n\n**[Alex the Entreprenerd (triage) commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/46#issuecomment-1207280811):**\n > Loss of yield, conditional on reaching limit, consider reducing severity.\n\n**[Albert Chon (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/46#issuecomment-1251668446):**\n > Can be mitigated with a large spend limit, which likely exists to prevent catastrophic cases. The issue is correct though, that this is a bug. Downgrading to medium severity though, given the practicality. \n\n\n\n***\n\n## [[M-12] Staking tokens can be stolen](https://github.com/code-423n4/2022-02-anchor-findings/issues/37)\n*Submitted by cmichel*\n\n<https://github.com/code-423n4/2022-02-anchor/blob/7af353e3234837979a19ddc8093dc9ad3c63ab6b/contracts/anchor-token-contracts/contracts/gov/src/staking.rs#L88>\n\nThe staking contract keeps track of *shares* of each user.<br>\nWhen withdrawing from the staking contract the `amount` parameter is converted to `shares` and this value is decreased (`shares = amount / total_balance * total_share`).<br>\nThis shares calculation rounds down which allows stealing tokens.<br>\n\nThe current code seems to try to protect against this by doing a maximum `std::cmp::max(v.multiply_ratio(total_share, total_balance).u128(), 1u128)` but this only works for the case where the shares would round down to zero. It's still exploitable.\n\n```rust\nlet withdraw_share = amount\n// @audit only rounds up when it'd be zero, but should always round up\n    .map(|v| std::cmp::max(v.multiply_ratio(total_share, total_balance).u128(), 1u128))\n// @audit sets it to the `amount` parameter if not `None`\nlet withdraw_amount = amount\n    .map(|v| v.u128())\n```\n\n### Proof of Concept\n\nAssume `total_balance = 2e18` and `total_share=1e18`. Then withdrawing/burning one share should allow withdrawing `total_balance / total_share = 2` amount.<br>\nHowever, imagine someone owns 1 shares (bought for 2 amount). Then `withdraw_voting_tokens(amount=3)`. And `withdraw_share = std::cmp::max(v.multiply_ratio(total_share, total_balance).u128(), 1u128) = max(amount=3 * total_share=1e18 / total_balance=2e18, 1) = max(\"3/2\", 1) = 1`<br>\nThe attacker made a profit.\n\nThe attacker can make a profit by staking the least `amount` to receive one share, and then immediately withdrawing this one share by specifying the largest `amount` such that the integer rounding still rounds to this one share. They make a small profit. They can repeat this many times in a single transaction with many messages.<br>\nDepending on the token price, this can be profitable as [similar attacks show](https://blog.neodyme.io/posts/lending_disclosure).\n\n### Recommended Mitigation Steps\n\nThe protocol tries to protect against this attack but the `max(., 1)` is not enough mitigation. There are several ways to fix this:\n\n1.  Always round up in `withdraw_share`\n2.  Always recompute the `withdraw_amount` with the new `withdraw_share` even if the `amount` parameter was set.\n3.  Use a `share` parameter (instead of the `amount` parameter) and use it as `withdraw_share`. Rounding down on the resulting `withdraw_amount` is bad for the attacker as burning a share leads to fewer tokens.\n\n**[bitn8 (Anchor) disagreed with severity](https://github.com/code-423n4/2022-02-anchor-findings/issues/37)**\n\n**[Albert Chon (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/37#issuecomment-1251646570):**\n > The amount would be miniscule due to the initial share amount scale being equal to the staked tokens scale (1e6), but indeed, the attack could be applied infinite times, though it's likely then that the gas costs incurred would exceed the profits gained.\n\n\n\n***\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 13 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-02-anchor-findings/issues/13) by **hickuphh3** received the top score from the judge.\n\n*The following wardens also submitted reports: [cmichel](https://github.com/code-423n4/2022-02-anchor-findings/issues/43), [hubble](https://github.com/code-423n4/2022-02-anchor-findings/issues/67), [0xwags](https://github.com/code-423n4/2022-02-anchor-findings/issues/78), [defsec](https://github.com/code-423n4/2022-02-anchor-findings/issues/59), [0xliumin](https://github.com/code-423n4/2022-02-anchor-findings/issues/4), [broccoli](https://github.com/code-423n4/2022-02-anchor-findings/issues/68), [cccz](https://github.com/code-423n4/2022-02-anchor-findings/issues/6), [IllIllI](https://github.com/code-423n4/2022-02-anchor-findings/issues/76), [WatchPug](https://github.com/code-423n4/2022-02-anchor-findings/issues/51), [robee](https://github.com/code-423n4/2022-02-anchor-findings/issues/1), [gzeon](https://github.com/code-423n4/2022-02-anchor-findings/issues/25), and [BondiPestControl](https://github.com/code-423n4/2022-02-anchor-findings/issues/23).*\n\n## Codebase Impressions & Summary\n\nThis audit contest is probably the largest in codebase size to date, consisting of various components such as tokens, airdrop, governance, staking, liquidity mining, reward distributions, a money market and cross-chain bridge functionality. While these components aren’t complex when reviewed in isolation, the code complexity becomes a little higher because of the various interactions with each other.\n\nOverall, the codebase quality is very high. Inline comments provided are helpful in describing why some checks were not performed (mainly because they are done elsewhere).\n\nThe level of documentation is also high, where the documentation portal and READMEs are adequate and kept up-to-date with the codebase.\n\nTests ran without issues, and could be easily modified to test out POCs and potential vulnerabilities.\n\nThe findings made involve the lack of sanity checks for some key config values (eg. their values should not exceed 100%). While the likelihood of the creation of governance polls to modify these values is low because the proposer loses his ANC deposit if quorum isn’t met, the impact of such polls, should they be successful, is high.\n\n## [L-01] CrossAnchorBridge: Decide if whitelisting feature is to be kept or removed\n\n### Line References\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L125-L130>\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L147-L151>\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L172-L173>\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L251>\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/ethereum/CrossAnchorBridge.sol#L256>\n\n### Description\n\nThe whitelisted mappings are defined and set to `true` for certain token addresses, but the lines of code where they are used are commented out.\n\n### Recommended Mitigation Steps\n\nDecide whether to keep the whitelisting requirement. Either comment out the remaining lines / remove them entirely, or uncomment the lines where they are used.\n\n## [L-02] Incorrect opcode specification documentation\n\n### Line References\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/README.md#op-code-specification>\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/cross-chain-contracts/terra/contracts/wormhole-bridge/src/contract.rs#L99-L125>\n\n### Description\n\nIt is unclear if the full opcode values include the flags as well. If so, they should be 8 bits in length, which isn’t the case. Their decimal representations are also incorrect.\n\n```markdown\n| Opcode | Flags | Full Opcode | Decimal |\n|:-------|:------|:------------|:-------|\n| Deposit Stable | `FLAG_BOTH_TRANSFERS` | `0b110000` | `192` |\n| Redeem Stable | `FLAG_BOTH_TRANSFERS` | `0b110001` | `193` |\n| Repay Stable | `FLAG_INCOMING_TRANSFER` | `0b1000000` | `64` |\n| Lock Collateral | `FLAG_INCOMING_TRANSFER` | `0b1000001` | `65` |\n| Unlock Collateral | `FLAG_OUTGOING_TRANSFER` | `0b0100000` | `32` |\n| Borrow Stable | `FlAG_OUTGOING_TRANSFER` | `0b0100001` | `33` |\n| Claim Rewards | `FLAG_OUTGOING_TRANSFER` | `0b0100010` | `34` |\n```\n\nThe opcodes were also not updated in the comments of the wormhole bridge terra contract.\n\n### Recommended Mitigation Steps\n\nUpdate the comments to reflect the latest changes.\n\n```markdown\n| Opcode | Flags | Full Opcode | Decimal |\n|:-------|:------|:------------|:-------|\n| Deposit Stable | `FLAG_BOTH_TRANSFERS` | `0b11000000` | `192` |\n| Redeem Stable | `FLAG_BOTH_TRANSFERS` | `0b11000001` | `193` |\n| Repay Stable | `FLAG_INCOMING_TRANSFER` | `0b10000000` | `128` |\n| Lock Collateral | `FLAG_INCOMING_TRANSFER` | `0b10000001` | `129` |\n| Unlock Collateral | `FLAG_OUTGOING_TRANSFER` | `0b01000000` | `64` |\n| Borrow Stable | `FlAG_OUTGOING_TRANSFER` | `0b01000001` | `65` |\n| Claim Rewards | `FLAG_OUTGOING_TRANSFER` | `0b01000010` | `66` |\n```\n\n```rust\n/*\nstruct Instruction {\n  uint8 op_code; // [1 byte]\n  bytes32 sender_address; // [32 bytes]\n  one_of {\n    // [deposit_stable] opcode = 192\n    uint64 sequence; // [8 bytes]\n\n    // [repay_stable] opcode = 128\n    uint64 sequence; // [8 bytes]\n\n    // [unlock_collateral] opcode = 64\n    bytes32 collorateral_token_address; // [32 bytes]\n    uint128 amount; // [16 bytes]\n\n    // [borrow_stable] opcode = 65\n    uint256 amount; // [16 bytes]\n\n    // [claim rewards] opcode = 66\n    // N/A for now\n\n    // [redeem_stable] opcode = 193\n    uint64 sequence; // [8 bytes]\n\n    // [lock_collateral] opcode = 129\n    uint64 sequence; // [8 bytes]\n  }\n}\n*/\n```\n\n## [L-03] Slightly imprecise tax calculation\n\n### Line References\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-bAsset-contracts/packages/basset/src/tax_querier.rs#L12-L15>\n\n<https://docs.anchorprotocol.com/developers-ethereum/fees#terra-blockchain-tax>\n\n### Description\n\nThe tax amount is calculated as `amount * DENOM / DENOM + tax_rate` instead of `amount * tax_rate / DENOM`, which means the tax percentage isn’t as precise (less tax is actually charged).\n\nWe see this in the test case:\n\n```rust\n// normal tax\nassert_eq!(\n  deduct_tax(&deps.as_mut().querier, Coin::new(50000000u128, \"uusd\")).unwrap(),\n  Coin {\n    denom: \"uusd\".to_string(),\n    amount: Uint128::new(49504950u128)\n  }\n);\n```\n\nGiven an amount of `50_000_000`, assuming a tax rate of 1%,the amount after tax would be `0.99 * 50_000_000 = 49500000`, but the calculated amount is `50_000_000 * 100 / 101 ~= 49504950`.\n\n### Recommended Mitigation Steps\n\nUpdate the calculation to be\n\n```rust\n(coin.amount.checked_sub(coin.amount.multiply_ratio(\n    Uint128::new(1) * tax_rate,\n    DECIMAL_FRACTION,\n)))?,\n```\n\n## [L-04] Duplicate vesting schedules can be added\n\n### Line References\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/staking/src/contract.rs>\n\n### Description\n\nIn the LP staking contract, it is possible to instantiate /  add duplicate vesting schedules.\n\n### Proof of Concept\n\n```rust\n#[test]\nfn test_instantiate_duplicate_schedules() {\n  let mut deps = mock_dependencies(&[]);\n\n  let msg = InstantiateMsg {\n    anchor_token: \"reward0000\".to_string(),\n    staking_token: \"staking0000\".to_string(),\n    distribution_schedule: vec![\n      (\n        mock_env().block.time.seconds() + 100,\n\tmock_env().block.time.seconds() + 200,\n\tUint128::from(1000000u128),\n      ),\n      (\n        mock_env().block.time.seconds() + 100,\n\tmock_env().block.time.seconds() + 200,\n\tUint128::from(1000000u128),\n      ),\n    ],\n  };\n\n  let info = mock_info(\"addr0000\", &[]);\n  let _res = instantiate(deps.as_mut(), mock_env(), info, msg).unwrap();\n}\n```\n\n### Recommended Mitigation Steps\n\nDe-duplicate the new vesting schedules when it is added. It is easier done if the schedules are sorted prior.\n\n## [N-01] money-market-contracts: Market max\\_borrow\\_factor is not capped\n\n### Line References\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/market/src/contract.rs#L66>\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/market/src/contract.rs#L321-L323>\n\n### Description\n\nThere is no check to ensure that `max_borrow_factor` is less than 100% (`Decimal::One()`). It is therefore possible to set a borrow factor of > 1. However, the consequence of it is negligible because it would be the same as setting the value to 100% (can’t borrow if there is no liquidity left).\n\n### Proof of Concept\n\nChange the instantiation and update config test values to a value greater than 100%, such as `Decimal256::MAX`.\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/market/src/testing/tests.rs#L36>\n\n```rust\nlet msg = InstantiateMsg {\n  owner_addr: \"owner\".to_string(),\n  stable_denom: \"uusd\".to_string(),\n  aterra_code_id: 123u64,\n  anc_emission_rate: Decimal256::one(),\n  max_borrow_factor: Decimal256::MAX,\n};\n```\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/market/src/testing/tests.rs#L215>\n\n```rust\nlet msg = ExecuteMsg::UpdateConfig {\n  owner_addr: None,\n  interest_model: Some(\"interest2\".to_string()),\n  distribution_model: Some(\"distribution2\".to_string()),\n  max_borrow_factor: Some(Decimal256::percent(120)),\n};\n```\n\n### Recommended Mitigation Steps\n\nEnsure `max_borrow_factor` doesn’t exceed `Decimal256::one()`.\n\n```rust\n// add error in market/src/error.rs\npub enum ContractError {\n  #[error(\"Setting greater than theoretical borrow factor\")]\n  MaxTheoreticalBorrowFactorExceeded {},\n  ...\n}\n\n// in market/src/contract.rs\n// before store_config() in L54\nif msg.max_borrow_factor > Decimal256::one() {\n  return Err(ContractError::MaxTheoreticalBorrowFactorExceeded {});\n}\n\n// in update_config()\nif let Some(max_borrow_factor) = max_borrow_factor {\n  if max_borrow_factor > Decimal256::one() {\n    return Err(ContractError::MaxTheoreticalBorrowFactorExceeded {});\n  }\n  config.max_borrow_factor = max_borrow_factor;\n}\n```\n\n## [N-02] Incorrect description of `Safe Ratio` in documentation\n\n### Reference\n\n<https://docs.anchorprotocol.com/protocol/anchor-governance/modify-liquidation-parameters>\n\n### Description\n\nThe docs say that\n\n“A **low** `Safe Ratio` value allows for the fast liquidation of collaterals while incurring a high price impact for the collateral, while a **low** `Safe Ratio` value enforces liquidations with lower collateral price impact, albeit with slower collateral liquidation.”\n\nThe second statement describes a **high** safe ratio.\n\n### Recommended Mitigation Steps\n\nChange to “while a **high** `Safe Ratio` value enforces liquidations with lower collateral price impact, albeit with slower collateral liquidation.”\n\n## [N-03] Typos / Grammar\n\n### Description\n\nDo a CMD / CTRL + F for the following statements.\n\n### Recommended Mitigation Steps\n\n1.  `form` → `from`\n    *   `// load price form the oracle` → `// load price from the oracle`\n    *   `// load balance form the token contract` → `// load price from the token contract`\n2.  `WITHDARW` → `WITHDRAW`\n    *   `ALICE CAN ONLY WITHDARW 40 UST` → `ALICE CAN ONLY WITHDRAW 40 UST`\n3.  `// cannot liquidation collaterals` → `// cannot liquidate collaterals`\n4.  `// if the token contract is  already register we cannot change the address` → `// if the token contract is already registered we cannot change the address`\n    *   Note the double spacing between `is` and `already`\n5.  `inistantiation` → `instantiation`\n    *   `// cannot register the token at the inistantiation` → `// cannot register token at instantiation`\n\n## [N-04] Outstanding TODO\n\n### Line Reference\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/overseer/src/contract.rs#L395>\n\n### Description\n\nThere’s 1 remaining TODO that may not have been resolved.\n\n`// TODO: Should this become a reply? If so which SubMsg to make reply_on?`\n\n## [Suggestion-01] Change interest rate model to jump rate model\n\n### Reference\n\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/money-market-contracts/contracts/interest_model/src/contract.rs#L114-L135>\n\n<https://github.com/compound-finance/compound-protocol/blob/master/contracts/JumpRateModel.sol>\n\n<https://docs.benqi.fi/benqi-liquidity-market/protocol-parameters>\n\n### Description\n\nThe current interest rate model used is a simple model that scales linearly with market utilization. A better interest rate model that Compound and its forks are using is the jump rate model, because it is more efficient at incentivizing liquidity at higher utilization rates.\n\n### Recommended Mitigation Steps\n\nChange the interest rate model to the jump rate model, where a kink is introduced to increase the interest multiplier after a specified market utilization rate.\n\n**[Alex the Entreprenerd (triage) commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/13#issuecomment-1205884657):**\n > This looks like the most complete report.\n\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 8 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-02-anchor-findings/issues/12) by **csanuragjain** received the top score from the judge.\n\n*The following wardens also submitted reports: [gzeon](https://github.com/code-423n4/2022-02-anchor-findings/issues/26), [WatchPug](https://github.com/code-423n4/2022-02-anchor-findings/issues/52), [hickuphh3](https://github.com/code-423n4/2022-02-anchor-findings/issues/14), [0v3rf10w](https://github.com/code-423n4/2022-02-anchor-findings/issues/53), [defsec](https://github.com/code-423n4/2022-02-anchor-findings/issues/60), [robee](https://github.com/code-423n4/2022-02-anchor-findings/issues/2), and [IllIllI](https://github.com/code-423n4/2022-02-anchor-findings/issues/74).*\n\n## [G-01] anchor\\_basset\\_hub contract :: execute\\_register\\_validator function\n\nFunction: execute\\_register\\_validator\n\nContract: <https://github.com/Anchor-Protocol/anchor-bAsset-contracts/blob/master/contracts/anchor_basset_hub/src/config.rs#L114>\n\nProblem: If a Validator is already registered there is no need of further processing. Check for same is missing\n\nRecommendation: Add a check to verify if the given validator is already whitelisted in which case directly return. Use is\\_valid\\_validator in state.rs for this purpose\n\n## [G-02] gov contract :: withdraw\\_voting\\_tokens function\n\nFunction: withdraw\\_voting\\_tokens\n\nContract: <https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/staking.rs#L87>\n\nProblem: Gas is wasted if withdraw\\_share is computed as 0\n\nRecommendation: Add a check for withdraw\\_share>0, otherwise return\n\n## [G-03] gov contract :: create\\_poll function\n\nFunction: create\\_poll\n\nContract: <https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/contract.rs#L281>\n\nRecommendation: Change `state.poll_count += 1;` to `state.poll_count = poll_id;` to perform gas saving\n\n## [G-04] gov contract :: cast\\_vote\n\nFunction: cast\\_vote\n\nContract: <https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/gov/src/contract.rs#L582>\n\nProblem: If amount is 0 then user vote gets wasted and also cause gas wastage\n\nRecommendation: check `amount!=0`\n\n## [G-05] community contract :: execute function\n\nFunction: execute\n\nContract: <https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/community/src/contract.rs#L35>\n\nRecommendation:\nSince both function require governance, governance check can be placed in execute instead of placing individually in UpdateConfig and Spend as done in <https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-token-contracts/contracts/vesting/src/contract.rs>\n\n## [G-06] anchor\\_basset\\_reward :: execute\\_increase\\_balance/execute\\_decrease\\_balance\n\nFunction: execute\\_increase\\_balance/execute\\_decrease\\_balance\n\nContract:<br>\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-bAsset-contracts/contracts/anchor_basset_reward/src/user.rs#L80>\n<https://github.com/code-423n4/2022-02-anchor/blob/main/contracts/anchor-bAsset-contracts/contracts/anchor_basset_reward/src/user.rs#L125>\n\nRecommendation:<br>\nIn both the function add a check for `amount!=0`\n\n**[Alex the Entreprenerd (triage) commented](https://github.com/code-423n4/2022-02-anchor-findings/issues/12#issuecomment-1205887536):**\n > Probably most interesting report.\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}