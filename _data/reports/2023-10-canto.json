{
  "circa": {
    "title": "Canto Liquidity Mining Protocol",
    "sponsor": "Canto",
    "slug": "2023-10-canto",
    "date": "2023-11-20",
    "findings": "https://github.com/code-423n4/2023-10-canto-findings/issues",
    "contest": 288
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the Canto Liquidity Mining Protocol smart contract system written in Solidity. The audit took place between October 3 — October 6 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>63 Wardens contributed reports to the Canto Liquidity Mining Protocol:</p>\n<ol>\n<li><a href=\"https://code4rena.com/@maanas\">maanas</a></li>\n<li><a href=\"https://code4rena.com/@ni8mare\">ni8mare</a></li>\n<li><a href=\"https://code4rena.com/@Satyam_Sharma\">Satyam_Sharma</a></li>\n<li><a href=\"https://code4rena.com/@Banditx0x\">Banditx0x</a></li>\n<li><a href=\"https://code4rena.com/@adriro\">adriro</a></li>\n<li><a href=\"https://code4rena.com/@HChang26\">HChang26</a></li>\n<li><a href=\"https://code4rena.com/@kutugu\">kutugu</a></li>\n<li><a href=\"https://code4rena.com/@sces60107\">sces60107</a></li>\n<li><a href=\"https://code4rena.com/@0xweb3boy\">0xweb3boy</a></li>\n<li><a href=\"https://code4rena.com/@0xDING99YA\">0xDING99YA</a></li>\n<li><a href=\"https://code4rena.com/@3docSec\">3docSec</a></li>\n<li><a href=\"https://code4rena.com/@0xWaitress\">0xWaitress</a></li>\n<li><a href=\"https://code4rena.com/@emerald7017\">emerald7017</a></li>\n<li><a href=\"https://code4rena.com/@twicek\">twicek</a></li>\n<li><a href=\"https://code4rena.com/@0xpiken\">0xpiken</a></li>\n<li><a href=\"https://code4rena.com/@hunter_w3b\">hunter_w3b</a></li>\n<li><a href=\"https://code4rena.com/@niser93\">niser93</a></li>\n<li><a href=\"https://code4rena.com/@radev_sw\">radev_sw</a></li>\n<li><a href=\"https://code4rena.com/@albahaca\">albahaca</a></li>\n<li><a href=\"https://code4rena.com/@0xAnah\">0xAnah</a></li>\n<li><a href=\"https://code4rena.com/@JCK\">JCK</a></li>\n<li><a href=\"https://code4rena.com/@hihen\">hihen</a></li>\n<li><a href=\"https://code4rena.com/@MatricksDeCoder\">MatricksDeCoder</a></li>\n<li><a href=\"https://code4rena.com/@JP_Courses\">JP_Courses</a></li>\n<li><a href=\"https://code4rena.com/@0xdice91\">0xdice91</a></li>\n<li><a href=\"https://code4rena.com/@cookedcookee\">cookedcookee</a></li>\n<li><a href=\"https://code4rena.com/@sandy\">sandy</a></li>\n<li><a href=\"https://code4rena.com/@ZanyBonzy\">ZanyBonzy</a></li>\n<li><a href=\"https://code4rena.com/@invitedtea\">invitedtea</a></li>\n<li><a href=\"https://code4rena.com/@naman1778\">naman1778</a></li>\n<li><a href=\"https://code4rena.com/@SAQ\">SAQ</a></li>\n<li><a href=\"https://code4rena.com/@SY_S\">SY_S</a></li>\n<li><a href=\"https://code4rena.com/@tabriz\">tabriz</a></li>\n<li><a href=\"https://code4rena.com/@shamsulhaq123\">shamsulhaq123</a></li>\n<li><a href=\"https://code4rena.com/@pipidu83\">pipidu83</a></li>\n<li><a href=\"https://code4rena.com/@Raihan\">Raihan</a></li>\n<li><a href=\"https://code4rena.com/@lsaudit\">lsaudit</a></li>\n<li><a href=\"https://code4rena.com/@Polaris_tow\">Polaris_tow</a></li>\n<li><a href=\"https://code4rena.com/@debo\">debo</a></li>\n<li><a href=\"https://code4rena.com/@Mike_Bello90\">Mike_Bello90</a></li>\n<li><a href=\"https://code4rena.com/@0xTheC0der\">0xTheC0der</a></li>\n<li><a href=\"https://code4rena.com/@Eurovickk\">Eurovickk</a></li>\n<li><a href=\"https://code4rena.com/@marqymarq10\">marqymarq10</a></li>\n<li><a href=\"https://code4rena.com/@orion\">orion</a></li>\n<li><a href=\"https://code4rena.com/@wahedtalash77\">wahedtalash77</a></li>\n<li><a href=\"https://code4rena.com/@xAriextz\">xAriextz</a></li>\n<li><a href=\"https://code4rena.com/@BoRonGod\">BoRonGod</a></li>\n<li><a href=\"https://code4rena.com/@gzeon\">gzeon</a></li>\n<li><a href=\"https://code4rena.com/@SovaSlava\">SovaSlava</a></li>\n<li><a href=\"https://code4rena.com/@matrix_0wl\">matrix_0wl</a></li>\n<li><a href=\"https://code4rena.com/@taner2344\">taner2344</a></li>\n<li><a href=\"https://code4rena.com/@Topmark\">Topmark</a></li>\n<li><a href=\"https://code4rena.com/@0x3b\">0x3b</a></li>\n<li><a href=\"https://code4rena.com/@100su\">100su</a></li>\n<li><a href=\"https://code4rena.com/@zpan\">zpan</a></li>\n<li>GKBG (<a href=\"https://code4rena.com/@KKat7531\">KKat7531</a> and <a href=\"https://code4rena.com/@Stoicov\">Stoicov</a>)</li>\n<li><a href=\"https://code4rena.com/@BRONZEDISC\">BRONZEDISC</a></li>\n<li><a href=\"https://code4rena.com/@lukejohn\">lukejohn</a></li>\n<li><a href=\"https://code4rena.com/@IceBear\">IceBear</a></li>\n<li><a href=\"https://code4rena.com/@0xAadi\">0xAadi</a></li>\n<li><a href=\"https://code4rena.com/@pep7siup\">pep7siup</a></li>\n<li><a href=\"https://code4rena.com/@tpiliposian\">tpiliposian</a></li>\n</ol>\n<p>This audit was judged by <a href=\"https://code4rena.com/@LSDan\">LSDan</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/brittfactorC4\">thebrittfactor</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 6 unique vulnerabilities. Of these vulnerabilities, 1 received a risk rating in the category of HIGH severity and 5 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 37 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 16 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-10-canto\">C4 Canto Liquidity Mining Protocol repository</a>, and is composed of 2 smart contracts written in the Solidity programming language and includes 145 lines of Solidity code.</p>\n<p>In addition to the known issues identified by the project team, a Code4rena bot race was conducted at the start of the audit. The winning bot, <strong>IllIllI-bot</strong> from warden IllIllI, generated the <a href=\"https://gist.github.com/code423n4/59002a10bbf69fc556e1c1dd8765c458\">Automated Findings report</a> and all findings therein were classified as out of scope.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"high-risk-findings-1\" style=\"position:relative;\"><a href=\"#high-risk-findings-1\" aria-label=\"high risk findings 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (1)</h1>\n<h2 id=\"h-01-array-length-of-ticktracking_-can-be-purposely-increased-to-brick-minting-and-burning-of-most-users-liquidity-positions\" style=\"position:relative;\"><a href=\"#h-01-array-length-of-ticktracking_-can-be-purposely-increased-to-brick-minting-and-burning-of-most-users-liquidity-positions\" aria-label=\"h 01 array length of ticktracking_ can be purposely increased to brick minting and burning of most users liquidity positions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/114\">[H-01] Array Length of <code>tickTracking_</code> can be purposely increased to Brick Minting and Burning of most users’ liquidity positions</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/114\">Banditx0x</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/82\">Banditx0x</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/276\">maanas</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/253\">emerald7017</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/235\">adriro</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/221\">twicek</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/215\">0xDING99YA</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/201\">0xpiken</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/68\">3docSec</a>, and <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/11\">0xWaitress</a></em></p>\n<h3 id=\"lines-of-code\" style=\"position:relative;\"><a href=\"#lines-of-code\" aria-label=\"lines of code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L24-L35\">https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L24-L35</a><br>\n<a href=\"https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L122\">https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L122</a></p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>A malicious user can brick minting, burning and harvesting of liquidity for almost all liquidity providers.</p>\n<p><em>Important NOTE</em>: This is a different vector from another gas issue, which is iterating over too many ticks in <code>(int24 i = lowerTick + 10; i &#x3C;= upperTick - 10; ++i)</code>. That issue affects wide liquidity positions, while this attack vector affects even liquidity positions with a relatively small number of ticks.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When <code>accrueConcentratedPositionTimeWeightedLiquidity</code> is called, under most conditions for every potentially eligible tick, it will iterate over every <code>tickTrackingData</code> in <code>tickTracking</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">while</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">time</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">tickTrackingIndex</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">numTickTracking</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p><code>tickTracking</code> is iterated by <code>tickTrackingIndex++;</code></p>\n<p>The array mapped by <code>tickTracking_</code> is increased by 1 for a tick every time a trade through the liquidity pool changes the price from a different tick to this tick. This is implemented in the <code>crossTicks</code> function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">crossTicks</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolIdx</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">int24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">exitTick</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">int24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">entryTick</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">numElementsExit</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">tickTracking_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolIdx</span><span class=\"mtk1\">][</span><span class=\"mtk12\">exitTick</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tickTracking_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolIdx</span><span class=\"mtk1\">][</span><span class=\"mtk12\">exitTick</span><span class=\"mtk1\">][</span><span class=\"mtk12\">numElementsExit</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk12\">exitTimestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">StorageLayout</span><span class=\"mtk1\">.</span><span class=\"mtk12\">TickTracking</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tickTrackingData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">StorageLayout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">TickTracking</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tickTracking_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolIdx</span><span class=\"mtk1\">][</span><span class=\"mtk12\">entryTick</span><span class=\"mtk1\">].</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tickTrackingData</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>A user could purposely increase the length of the <code>tickTracking_</code> array and cause the gas limit to be reached whenever the array is looped over.</p>\n<p>The price impact required to cross a tick is from 0 to 1 bps, with 1 bps as the tick width. This is already extremely small, but the attacker could have the swap amount be a very small fraction of a bps if they first swap to make the price end very close to a tick boundary, then execute multiple extremely small swaps which bounce the price back and forth over the tick boundary.</p>\n<p>Note that the CANTO liquidity rewards are targeted to stable pools. An attacker can be quite confident, for example, that a USDC/USDT pool will trade at around <code>$</code>1, and the ticks closest to <code>$</code>1 will always be eligible for rewards and therefore be looped over by all rewardable positions when <code>accrueConcentratedPositionTimeWeightedLiquidity</code> is called. Therefore, the attack can be targeted to just one or two ticks to affect almost every user.</p>\n<p><code>accrueConcentratedPositionTimeWeightedLiquidity</code> is called during minting, burning and harvesting liquidity positions. Therefore, this gas griefing attack will make all these functions revert for almost every user. This would basically break the functionality of concentrated liquidity pools on Ambient.</p>\n<p>Contrast the effect to the cost to the attacker: using the aforementioned attack vector the main cost to the attacker will be the gas costs of performing the swaps. This is far lower than the damage that is done to the protocol/users.</p>\n<p>One additional factor which makes this attack easy to execute, is that crossing ticks, even if the entry and exit is within the same <code>block.timestamp</code>, adds to the array length. Tracking this is unnecessary, because the tick was active for 0 blocks, and therefore, the time delta and allocated rewards is zero.</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>One immediate step would to <code>pop()</code> <code>tickTrackingData</code> as soon as the <code>exitTimestamp == entryTimestamp</code>. This happens to the last element of the array when <code>crossTicks</code> is called. Tracking this is unnecessary, because the tick was active for 0 blocks, and therefore, the time delta and allocated rewards is zero.</p>\n<p>The documentation stated that CANTO rewards are meant to be distributed for stable pools for this codebase. The term “stable” could have different interpretations, but this recommendation assumes that this refers to stablecoin-like or pegged asset pairs such as stETH/WETH, USDT/USDC etc.</p>\n<p>Instead of iterating through every tick, one could assume a range where the stable assets could lie and then reward all positions that lie within the specified range; in this case, +/- 10 ticks of the price tick.</p>\n<p>This makes an assumption that these “stable assets” will actually stay pegged to each other. However, the current accounting architecture has multiple problems:</p>\n<ul>\n<li>Given the high number of loops required by the current accounting mechanism, there are multiple reasons that gas could run out. This includes iterating through too many ticks or having too many tick entries/exits.</li>\n<li>The current mechanism increases the gas costs of all minting, burning and harvesting.</li>\n<li>DOS attacks like the one described in this issue are possible.</li>\n</ul>\n<p>Assuming a stable price has the downside of misallocating rewards if the stable assets depeg from each other. However, this may be a reasonable tradeoff to prevent this DOS attack.</p>\n<h3 id=\"assessed-type\" style=\"position:relative;\"><a href=\"#assessed-type\" aria-label=\"assessed type permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>DoS</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/114#issuecomment-1757196983\">OpenCoreCH (Canto) confirmed</a></strong></p>\n<p><em>Note: for full discussion, see <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/114\">here</a></em>.</p>\n<hr>\n<h1 id=\"medium-risk-findings-5\" style=\"position:relative;\"><a href=\"#medium-risk-findings-5\" aria-label=\"medium risk findings 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (5)</h1>\n<h2 id=\"m-01-the-liquidity-mining-callpath-sidecar-owner-can-pull-native-tokens-from-the-dex\" style=\"position:relative;\"><a href=\"#m-01-the-liquidity-mining-callpath-sidecar-owner-can-pull-native-tokens-from-the-dex\" aria-label=\"m 01 the liquidity mining callpath sidecar owner can pull native tokens from the dex permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/295\">[M-01] The Liquidity mining callpath sidecar owner can pull native tokens from the <code>Dex</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/295\">maanas</a></em></p>\n<p>The owner of the liquidity mining sidecar can pull the native coins that are stored in the <code>CrocSwapDex</code> to reward the users.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>setConcRewards</code> and <code>setAmbRewards</code> functions don’t check if the quoted amount of rewards are actually sent by the caller. This allows the owner to specify any total amount of native coin which are available in the <code>CrocSwapDex</code> from which the funds will be used when distributing the rewards.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setConcRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolIdx</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weekTo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeklyReward</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// require(msg.sender == governance_, &quot;Only callable by governance&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\"> % </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">weekTo</span><span class=\"mtk1\"> % </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid weeks&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">while</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">weekTo</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">concRewardPerWeek_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolIdx</span><span class=\"mtk1\">][</span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">weeklyReward</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L65C7-L72\">https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L65C7-L72</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setAmbRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolIdx</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weekTo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeklyReward</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// require(msg.sender == governance_, &quot;Only callable by governance&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\"> % </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">weekTo</span><span class=\"mtk1\"> % </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid weeks&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">while</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">weekTo</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">ambRewardPerWeek_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolIdx</span><span class=\"mtk1\">][</span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">weeklyReward</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L74-L81\">https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L74-L81</a></p>\n<p>According to <a href=\"https://docs.ambient.finance/developers/token-transfers#native-ethereum\">Ambient Docs</a> they allow for deposits in native tokens.</p>\n<h3 id=\"demo\" style=\"position:relative;\"><a href=\"#demo\" aria-label=\"demo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Demo</h3>\n<p>Update TestLiquidityMining.js:</p>\n<p>The funds added using <code>hardhat.setBalance()</code> is being used by the owner to distribute rewards</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/canto_ambient/test_canto/TestLiquidityMining.js b/canto_ambient/test_canto/TestLiquidityMining.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index bd21a32..b917308 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/canto_ambient/test_canto/TestLiquidityMining.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/canto_ambient/test_canto/TestLiquidityMining.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -7,6 +7,7 @@ const { time } = require(&quot;@nomicfoundation/hardhat-network-helpers&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> var keccak256 = require(&quot;@ethersproject/keccak256&quot;).keccak256;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> const chai = require(&quot;chai&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+const { network, ethers } = require(&quot;hardhat&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> const abi = new AbiCoder();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> const BOOT_PROXY_IDX = 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -218,7 +219,6 @@ describe(&quot;Liquidity Mining Tests&quot;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\ttx = await dex.userCmd(2, mintConcentratedLiqCmd, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t\tgasLimit: 6000000,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-\t\t\tvalue: ethers.utils.parseUnits(&quot;10&quot;, &quot;ether&quot;),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\tawait tx.wait();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -243,6 +243,17 @@ describe(&quot;Liquidity Mining Tests&quot;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t\tBigNumber.from(&quot;999898351768&quot;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\tlet dexBal = await ethers.provider.getBalance(dex.address);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\texpect(dexBal.eq(0)).to.be.eq(true);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t// dex gains native token from other methods</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\tawait network.provider.send(&quot;hardhat_setBalance&quot;, [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tdex.address,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tethers.utils.parseEther(&quot;2&quot;).toHexString(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t  ]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\tdexBal = await ethers.provider.getBalance(dex.address);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\texpect(dexBal.eq(ethers.utils.parseEther(&quot;2&quot;))).to.be.eq(true);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t//////////////////////////////////////////////////</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t// SET LIQUIDITY MINING REWARDS FOR CONCENTRATED LIQUIDITY</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t//////////////////////////////////////////////////</span></span></span></code></pre>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Hardhat</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a <code>msg.value</code> check in the rewards function to see that the total value is passed when call the functions.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol b/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index e6c63f7..44dd338 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -65,6 +65,7 @@ contract LiquidityMiningPath is LiquidityMining {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function setConcRewards(bytes32 poolIdx, uint32 weekFrom, uint32 weekTo, uint64 weeklyReward) public payable {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // require(msg.sender == governance_, &quot;Only callable by governance&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         require(weekFrom % WEEK == 0 &amp;&amp; weekTo % WEEK == 0, &quot;Invalid weeks&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        require((1 +(weekTo - weekFrom) / WEEK) * weeklyReward == msg.value);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         while (weekFrom &lt;= weekTo) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             concRewardPerWeek_[poolIdx][weekFrom] = weeklyReward;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             weekFrom += uint32(WEEK);</span></span></span></code></pre>\n<h3 id=\"assessed-type-1\" style=\"position:relative;\"><a href=\"#assessed-type-1\" aria-label=\"assessed type 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Rug-Pull</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/295#issuecomment-1792892349\">OpenCoreCH (Canto) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Rewards will be set and sent in the same Canto governance proposal.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-if-dt-is-not-updated-accurately-timeweightedweeklypositioninrangeconcliquidity_-might-be-updated-incorrectly\" style=\"position:relative;\"><a href=\"#m-02-if-dt-is-not-updated-accurately-timeweightedweeklypositioninrangeconcliquidity_-might-be-updated-incorrectly\" aria-label=\"m 02 if dt is not updated accurately timeweightedweeklypositioninrangeconcliquidity_ might be updated incorrectly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/290\">[M-02] If <code>dt</code> is not updated accurately, <code>timeWeightedWeeklyPositionInRangeConcLiquidity_</code> might be updated incorrectly</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/290\">ni8mare</a></em></p>\n<p>In the function <code>accrueConcentratedPositionTimeWeightedLiquidity</code>, inside the while block, <code>dt</code> is initialised as:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint32 dt = uint32(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       nextWeek &lt; block.timestamp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       ? nextWeek - time</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       : block.timestamp - time</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   );</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L98-L102\">https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L98-L102</a></p>\n<p>If <code>tickTracking.exitTimestamp != 0</code> then the following else block is executed on line 117:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   // Tick is no longer active</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   if (tickTracking.exitTimestamp &lt; nextWeek) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      // Exit was in this week, continue with next tick</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      tickActiveEnd = tickTracking.exitTimestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      tickTrackingIndex++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      dt = tickActiveEnd - tickActiveStart;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     // Exit was in next week, we need to consider the current tick there (i.e. not increase the index)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     tickActiveEnd = nextWeek;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> }</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L117-L128\">https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L117-L128</a></p>\n<p><code>dt</code> is now updated to <code>tickActiveEnd - tickActiveStart;</code> when <code>tickTracking.exitTimestamp &#x3C; nextWeek</code> as seen in the if block of the outer else block above.</p>\n<p>But, when <code>tickTracking.exitTimestamp > nextWeek</code>, in the inner else block the value of <code>dt</code> is not updated:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"> else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     // Exit was in next week, we need to consider the current tick there (i.e. not increase the index)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     tickActiveEnd = nextWeek;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     //@audit - No update on dt value</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Inside this else block as well, <code>dt</code> must equal <code>tickActiveEnd - tickActiveStart;</code>, where <code>tickActiveEnd = nextWeek;</code>. Without this update, if <code>tickTracking.exitTimestamp > nextWeek</code>, then <code>dt = nextWeek - time</code> or <code>dt = block.timestamp - time</code> as it was declared initially. For example, let’s say that it was the former, that is, <code>dt = nextWeek - time</code> (according to the initial declaration). Assume that <code>tickActiveStart = tickTracking.enterTimestamp</code> (this is possible when <a href=\"https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L110-L113\">tickTracking.enterTimestamp > time</a>). Had the else block above (check @audit tag), updated <code>dt</code>, then <code>dt = tickActiveEnd - tickActiveStart;</code> => <code>dt = nextWeek - tickTracking.enterTimestamp</code></p>\n<p>So, on comparing again, initially -> <code>dt = nextWeek - time</code> and had there been an update on <code>dt</code> at the audit tag, <code>dt</code> would now be -> <code>dt = nextWeek - tickTracking.enterTimestamp</code>. Note that here, <code>tickTracking.enterTimestamp > time</code> (check the above para). So, <code>nextWeek - tickTracking.enterTimestamp &#x3C; nextWeek - time</code>. That means <code>dt</code> would be a smaller value had it been equal to <code>nextWeek - tickTracking.enterTimestamp</code>. But, since it’s not updated, <code>dt</code> equals <code>nextWeek - time</code>, which is a bigger value.</p>\n<p><code>dt</code> is used to increase the value of time (used as an iterator in while loop). Since <code>dt</code> is a bigger value than required, the number of iterations of the while loop would be less than what it should be. This means that fewer iterations would be used to update <code>timeWeightedWeeklyPositionInRangeConcLiquidity_</code> on line <a href=\"https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L129\">129</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">timeWeightedWeeklyPositionInRangeConcLiquidity_[poolIdx][posKey][currWeek][i] +=</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            (tickActiveEnd - tickActiveStart) * liquidity;</span></span></code></pre>\n<p><code>timeWeightedWeeklyPositionInRangeConcLiquidity_</code> is used to calculate the <code>rewardsToSend</code> value in <code>claimConcentratedRewards</code> function. If <code>timeWeightedWeeklyPositionInRangeConcLiquidity_</code> is incorrect, then the rewards to be sent to the user will be calculated incorrectly.</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L181-L188\">https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L181-L188</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 overallInRangeLiquidity = timeWeightedWeeklyGlobalConcLiquidity_[poolIdx][week];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   if (overallInRangeLiquidity &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      uint256 inRangeLiquidityOfPosition;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      for (int24 j = lowerTick + 10; j &lt;= upperTick - 10; ++j) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         inRangeLiquidityOfPosition += timeWeightedWeeklyPositionInRangeConcLiquidity_[poolIdx][posKey][week][j];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       // Percentage of this weeks overall in range liquidity that was provided by the user times the overall weekly rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       rewardsToSend += inRangeLiquidityOfPosition * concRewardPerWeek_[poolIdx][week] / overallInRangeLiquidity; //@audit - rewards to send will be less</span></span></code></pre>\n<p>Also, due to fewer number of iterations, <code>tickTrackingIndexAccruedUpTo_</code> might not be updated correctly.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (tickTrackingIndex != origIndex) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i] = tickTrackingIndex;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    /// @notice Accrues the in-range time-weighted concentrated liquidity for a position by going over the tick entry / exit history</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /// @dev Needs to be called whenever a position is modified</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function accrueConcentratedPositionTimeWeightedLiquidity(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address payable owner,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes32 poolIdx,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        int24 lowerTick,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        int24 upperTick</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        RangePosition72 storage pos = lookupPosition(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            owner,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            poolIdx,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            lowerTick,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            upperTick</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes32 posKey = encodePosKey(owner, poolIdx, lowerTick, upperTick);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint32 lastAccrued = timeWeightedWeeklyPositionConcLiquidityLastSet_[</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            poolIdx</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ][posKey];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Only set time on first call</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (lastAccrued != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 liquidity = pos.liquidity_;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            for (int24 i = lowerTick + 10; i &lt;= upperTick - 10; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                uint32 tickTrackingIndex = tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                uint32 origIndex = tickTrackingIndex;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                uint32 numTickTracking = uint32(tickTracking_[poolIdx][i].length);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                uint32 time = lastAccrued;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                // Loop through all in-range time spans for the tick or up to the current time (if it is still in range)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                while (time &lt; block.timestamp &amp;&amp; tickTrackingIndex &lt; numTickTracking) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    TickTracking memory tickTracking = tickTracking_[poolIdx][i][tickTrackingIndex];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    uint32 currWeek = uint32((time / WEEK) * WEEK);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    uint32 nextWeek = uint32(((time + WEEK) / WEEK) * WEEK);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    uint32 dt = uint32(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        nextWeek &lt; block.timestamp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            ? nextWeek - time</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            : block.timestamp - time</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    uint32 tickActiveStart; // Timestamp to use for the liquidity addition</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    uint32 tickActiveEnd;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    if (tickTracking.enterTimestamp &lt; nextWeek) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        // Tick was active before next week, need to add the liquidity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        if (tickTracking.enterTimestamp &lt; time) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            // Tick was already active when last claim happened, only accrue from last claim timestamp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            tickActiveStart = time;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            // Tick has become active this week</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            tickActiveStart = tickTracking.enterTimestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        if (tickTracking.exitTimestamp == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            // Tick still active, do not increase index because we need to continue from here</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            tickActiveEnd = uint32(nextWeek &lt; block.timestamp ? nextWeek : block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            // Tick is no longer active</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            if (tickTracking.exitTimestamp &lt; nextWeek) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                // Exit was in this week, continue with next tick</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                tickActiveEnd = tickTracking.exitTimestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                tickTrackingIndex++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                dt = tickActiveEnd - tickActiveStart;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                // Exit was in next week, we need to consider the current tick there (i.e. not increase the index)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                tickActiveEnd = nextWeek;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        timeWeightedWeeklyPositionInRangeConcLiquidity_[poolIdx][posKey][currWeek][i] +=</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            (tickActiveEnd - tickActiveStart) * liquidity;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    time += dt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                if (tickTrackingIndex != origIndex) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i] = tickTrackingIndex;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            for (int24 i = lowerTick + 10; i &lt;= upperTick - 10; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                uint32 numTickTracking = uint32(tickTracking_[poolIdx][i].length);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                if (numTickTracking &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    if (tickTracking_[poolIdx][i][numTickTracking - 1].exitTimestamp == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        // Tick currently active</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i] = numTickTracking - 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i] = numTickTracking;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        timeWeightedWeeklyPositionConcLiquidityLastSet_[poolIdx][</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            posKey</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ] = uint32(block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add the line <code>dt = tickActiveEnd - tickActiveStart</code> in the place of the @audit tag, as shown above.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/290#issuecomment-1757581037\">OpenCoreCH (Canto) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Note that if the mentioned <code>else</code> branch is reached, <code>dt</code> is necessarily set to <code>nextWeek - time</code>, it cannot be <code>block.timestamp - time</code> (if the tick was exited in the next week, the next week cannot be in the future and greater than the block timestamp). So the only possible difference is regarding <code>tickActiveStart</code>, namely when <code>tickActiveStart = tickTracking.enterTimestamp</code> (in the other case, when <code>tickActiveStart = time</code>, we have <code>dt = nextWeek - time = tickActiveEnd - tickActiveStart</code>).</p>\n<p>I agree with the warden that in this particular case, the logic for updating <code>dt</code> is different in the <code>if</code> and <code>else</code> branch, which should not be the case. However, I think the logic in the <code>if</code> branch is wrong, not in the <code>else</code>: We want to set <code>dt</code> such that the next <code>time</code> value is equal to <code>tickActiveEnd</code> (because we accrued up to <code>tickActiveEnd</code>). To achieve this in all cases, we need to set <code>dt = tickActiveEnd - time</code> in the <code>if</code> block. Otherwise, when <code>tickTracking.enterTimestamp > time</code> we only add the time where the tick was in range to <code>time</code> (but not the time before that where the tick was out of range). Because we are also increasing the tick tracking index, this should not cause any problems in practice (the next enter timestamp will be greater than <code>time</code> by definition and we will only start accruing from there on again), but I think it should still be changed.</p>\n</blockquote>\n<p><em>Note: for full discussion, see <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/290\">here</a></em>.</p>\n<hr>\n<h2 id=\"m-03-rewards-cannot-be-transferred-when-calling-protocol-command\" style=\"position:relative;\"><a href=\"#m-03-rewards-cannot-be-transferred-when-calling-protocol-command\" aria-label=\"m 03 rewards cannot be transferred when calling protocol command permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/239\">[M-03] Rewards cannot be transferred when calling protocol command</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/239\">adriro</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/116\">HChang26</a></em></p>\n<p>Rewards are set up using protocol commands, but its entry point is not payable.</p>\n<p>Rewards can be set up by protocol authorities using the functions <code>setConcRewards()</code> and <code>setAmbRewards()</code> present in the LiquidityMiningPath contracts. These two are part of the “command” pattern used in the protocol: the main entry point receives <em>commands</em> which are then routed to the proper place using <em>codes</em>.</p>\n<p>The protocol command flow starts at the <code>CrocSwapDex</code> contract:</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/CrocSwapDex.sol#L103-L106\">https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/CrocSwapDex.sol#L103-L106</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">103</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">protocolCmd</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">callpath</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cmd</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sudo</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">104:         </span><span class=\"mtk11\">protocolOnly</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sudo</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">105</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">callProtocolCmd</span><span class=\"mtk1\">(</span><span class=\"mtk12\">callpath</span><span class=\"mtk1\">, </span><span class=\"mtk12\">cmd</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">106</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/mixins/ProxyCaller.sol#L22-L28\">https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/mixins/ProxyCaller.sol#L22-L28</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">22</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">callProtocolCmd</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxyIdx</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">input</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">23:         </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">24</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">assertProxy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proxyIdx</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">25</span><span class=\"mtk1\">:         (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">output</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">proxyPaths_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">proxyIdx</span><span class=\"mtk1\">].</span><span class=\"mtk11\">delegatecall</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">26</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSignature</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;protocolCmd(bytes)&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">input</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">27</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">verifyCallResult</span><span class=\"mtk1\">(</span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">output</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">28</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>The <code>protocolCmd()</code> function checks the call is properly authorized and calls <code>callProtocolCmd()</code>, which then executes a <code>delegatecall</code> to the corresponding implementation, in this case the <code>LiquidityMiningPath</code> contract:</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L26-L37\">https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L26-L37</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">26</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">protocolCmd</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cmd</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">27</span><span class=\"mtk1\">:         (</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">code</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weekTo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeklyReward</span><span class=\"mtk1\">) =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">28</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cmd</span><span class=\"mtk1\">, (</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint64</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">29</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">30</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">code</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">ProtocolCmd</span><span class=\"mtk1\">.</span><span class=\"mtk12\">SET_CONC_REWARDS_CODE</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">31</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">setConcRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\">, </span><span class=\"mtk12\">weekTo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">weeklyReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">32</span><span class=\"mtk1\">:         } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">code</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">ProtocolCmd</span><span class=\"mtk1\">.</span><span class=\"mtk12\">SET_AMB_REWARDS_CODE</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">33</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">setAmbRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\">, </span><span class=\"mtk12\">weekTo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">weeklyReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">34</span><span class=\"mtk1\">:         } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">35</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Invalid protocol command&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">36</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">37</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>While <code>CrocSwapDex::protocolCmd()</code> is payable, its counterpart in <code>LiquidityMiningPath</code> is not. This means that rewards cannot be transferred while setting them up, rejecting any command that has positive <code>callvalue</code>.</p>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Make <code>LiquidityMiningPath::protocolCmd()</code> payable.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   function protocolCmd(bytes calldata cmd) public virtual {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   function protocolCmd(bytes calldata cmd) public virtual payable {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (uint8 code, bytes32 poolHash, uint32 weekFrom, uint32 weekTo, uint64 weeklyReward) =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            abi.decode(cmd, (uint8, bytes32, uint32, uint32, uint64));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (code == ProtocolCmd.SET_CONC_REWARDS_CODE) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            setConcRewards(poolHash, weekFrom, weekTo, weeklyReward);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } else if (code == ProtocolCmd.SET_AMB_REWARDS_CODE) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            setAmbRewards(poolHash, weekFrom, weekTo, weeklyReward);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            revert(&quot;Invalid protocol command&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"assessed-type-2\" style=\"position:relative;\"><a href=\"#assessed-type-2\" aria-label=\"assessed type 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Payable</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/239#issuecomment-1752014651\">141345 (lookout) commented</a>:</strong></p>\n<blockquote>\n<p><code>protocolCmd()</code> should be payable.</p>\n<p>One walk around is to call <code>setAmbRewards()</code>/<code>setConcRewards()</code>directly to send funds. But seems the expected way is to use this contract through <code>delegatecall</code>, if the contract is deployed without this option, the described issue could be some problem.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/239#issuecomment-1757450727\">OpenCoreCH (Canto) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-04-accrued-liquidity-can-be-lost-and-never-be-recovered-for-a-given-tick-period-\" style=\"position:relative;\"><a href=\"#m-04-accrued-liquidity-can-be-lost-and-never-be-recovered-for-a-given-tick-period-\" aria-label=\"m 04 accrued liquidity can be lost and never be recovered for a given tick period  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/186\">[M-04] Accrued liquidity can be lost and never be recovered for a given tick period. </a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/186\">Satyam_Sharma</a></em></p>\n<p>Accrued liquidity can be lost and never be recovered for a given tick period due to not incrementing\n<code>tickTrackingIndex</code>, which sets the tick end timestamp to <code>nextweek</code> and will start accruing liquidity for next tick period.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>LiquidityMining.accrueConcentratedPositionTimeWeightedLiquidity</code> sets <code>tickActiveEnd = nextWeek</code> and doesn’t increment <code>tickTrackingIndex</code>, which makes current tick period to end by setting <code>tickActiveEnd = nextWeek</code> and moves to next tick period without incrementing <code>tickTrackingIndex</code>. When tick is no longer active that is <code>tickTracking.exitTimestamp &#x3C; nextWeek</code>, it means <code>tickTracking.exitTimestamp</code> should be strictly less than the <code>nextWeek</code> to set <code>tickActiveEnd = tickTracking.exitTimestamp</code> and then calculate <code>dt</code> based on the <code>tickActiveStart</code> and <code>tickActiveEnd</code> values.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            // Tick is no longer active</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            if (tickTracking.exitTimestamp &lt; nextWeek) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                // Exit was in this week, continue with next tick</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                tickActiveEnd = tickTracking.exitTimestamp;//1697068700</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                tickTrackingIndex++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                dt = tickActiveEnd - tickActiveStart;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                // Exit was in next week, we need to consider the current tick there (i.e. not increase the index)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                tickActiveEnd = nextWeek;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                            }</span></span></code></pre>\n<p>Now the issue here, is with the <code>if</code> statement; <code>if (tickTracking.exitTimestamp &#x3C; nextWeek)</code> calculates <code>dt</code> if\n<code>exitTimestamp</code> is strictly lesser than the <code>nextWeek</code>. Suppose there is a condition in which user <code>exitTimestamp = nextWeek</code> i.e.; user exits the concentrated liquidity position with some <code>X</code> poolIdx with the <code>nextWeek</code> timestamp. Meaning when the <code>nextWeek</code> is about to end, the user triggers an exit and as soon as the exit triggers, this <code>if</code> statement will revert and <code>tickTrackingIndex</code> will not be incremented for that user or poolId. <code>tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i]</code> and therefore, the accrued concentrated liquidity might be lost for a given tick period and will never be recovered due to setting <code>tickActiveEnd = nextWeek</code> in the <code>else</code> statement; which will declare the tick end and move to the next tick period to accrued liquidity .</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Edit the <code>if</code> statement for <code>exitTimestamp</code>, which increments <code>tickTrackingIndex</code> when <code>tickTracking.exitTimestamp == nextWeek</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"> - if (tickTracking.exitTimestamp &lt; nextWeek) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> +  if (tickTracking.exitTimestamp &lt;= nextWeek) { </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span></code></pre>\n<h3 id=\"assessed-type-3\" style=\"position:relative;\"><a href=\"#assessed-type-3\" aria-label=\"assessed type 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Error</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/186#issuecomment-1751976319\">141345 (lookout) commented</a>:</strong></p>\n<blockquote>\n<p>An edge case when <code>exitTimestamp == nextWeek</code>, rewards could be lost </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">canto_ambient</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">mixins</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LiquidityMining</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">24</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">crossTicks</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">29</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">numElementsExit</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">tickTracking_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolIdx</span><span class=\"mtk1\">][</span><span class=\"mtk12\">exitTick</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">30</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">tickTracking_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolIdx</span><span class=\"mtk1\">][</span><span class=\"mtk12\">exitTick</span><span class=\"mtk1\">][</span><span class=\"mtk12\">numElementsExit</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">31</span><span class=\"mtk1\">:             .</span><span class=\"mtk12\">exitTimestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Due to the low likelihood, high severity might not be appropriate.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/186#issuecomment-1757252292\">OpenCoreCH (Canto) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Good point, requires quite a few conditions to actually cause damage (exactly aligned <code>exitTimestamp</code> and even then, the accrual has to happen a few weeks later with additional ticks that were in range since then for it to cause skipping ticks), but will definitely be fixed.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/186#issuecomment-1769301330\">LSDan (judge) decreased severity to Medium</a></strong></p>\n<p><em>Note: for full discussion, see <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/186\">here</a></em>.</p>\n<hr>\n<h2 id=\"m-05-positions-that-are-not-eligible-for-rewards-will-affect-the-reward-income-of-eligible-positions\" style=\"position:relative;\"><a href=\"#m-05-positions-that-are-not-eligible-for-rewards-will-affect-the-reward-income-of-eligible-positions\" aria-label=\"m 05 positions that are not eligible for rewards will affect the reward income of eligible positions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/177\">[M-05] Positions that are not eligible for rewards will affect the reward income of eligible positions</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/177\">kutugu</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/165\">sces60107</a> and Banditx0x (<a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/98\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/94\">2</a>)</em></p>\n<h3 id=\"lines-of-code-1\" style=\"position:relative;\"><a href=\"#lines-of-code-1\" aria-label=\"lines of code 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L181\">https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L181</a><br>\n<a href=\"https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L188\">https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L188</a><br>\n<a href=\"https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L48\">https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L48</a></p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>When calculating reward distribution, the contract uses the current position’s liquidity time weight divided by the total liquidity time weight of the pool, instead of the total liquidity time weight of the pool that meets the reward conditions.\nThis means that if there is a large amount of liquidity in the pool that is not eligible for rewards, the total weekly reward distribution will be much less than the <code>rewardPerWeek</code>, which should not be expected.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/canto_ambient/test_canto/TestLiquidityMining.js b/canto_ambient/test_canto/TestLiquidityMining.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index bd21a32..617b070 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/canto_ambient/test_canto/TestLiquidityMining.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/canto_ambient/test_canto/TestLiquidityMining.js</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -32,7 +32,7 @@ chai.use(solidity);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> describe(&quot;Liquidity Mining Tests&quot;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \tit(&quot;deploy contracts and init pool&quot;, async function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-\t\tconst [owner] = await ethers.getSigners();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\tconst [owner, others] = await ethers.getSigners();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t////////////////////////////////////////////////</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t// DEPLOY AND MINT cNOTE and USDC</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -49,6 +49,14 @@ describe(&quot;Liquidity Mining Tests&quot;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t\towner.address,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t\tethers.utils.parseUnits(&quot;1000000&quot;, 6)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\tawait cNOTE.deposit(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tothers.address,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tethers.utils.parseEther(&quot;1000000&quot;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\tawait USDC.deposit(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tothers.address,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tethers.utils.parseUnits(&quot;1000000&quot;, 6)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t////////////////////////////////////////////////</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t// DEPLOY DEX CONTRACT AND ALL PROXIES</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -145,6 +153,17 @@ describe(&quot;Liquidity Mining Tests&quot;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\tawait approveCNOTE.wait();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\tapproveUSDC = await USDC.connect(others).approve(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tdex.address,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tBigNumber.from(10).pow(36)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\tawait approveUSDC.wait();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\tapproveCNOTE = await cNOTE.connect(others).approve(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tdex.address,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tBigNumber.from(10).pow(36)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\tawait approveCNOTE.wait();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t/* </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         /\t2. set new pool liquidity (amount to lock up for new pool)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         /\t   params = [code, liq]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -222,6 +241,40 @@ describe(&quot;Liquidity Mining Tests&quot;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\tawait tx.wait();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\tmintConcentratedLiqCmd = abi.encode(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\t&quot;uint8&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\t&quot;address&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\t&quot;address&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\t&quot;uint256&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\t&quot;int24&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\t&quot;int24&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\t&quot;uint128&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\t&quot;uint128&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\t&quot;uint128&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\t&quot;uint8&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\t&quot;address&quot;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\t11, // code (mint concentrated liquidity in base token liq)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\tcNOTE.address, // base token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\tUSDC.address, // quote token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\t36000, // poolIDX</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\tcurrentTick - 5, // tickLower</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\tcurrentTick + 5, // tickUpper</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\tBigNumber.from(&quot;100000000000000000000&quot;), // amount of base token to send</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\tBigNumber.from(&quot;16602069666338596454400000&quot;), // min price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\tBigNumber.from(&quot;20291418481080506777600000&quot;), // max price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\t0, // reserve flag</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\tZERO_ADDR, // lp conduit address (0 if not using)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\ttx = await dex.connect(others).userCmd(2, mintConcentratedLiqCmd, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tgasLimit: 6000000,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tvalue: ethers.utils.parseUnits(&quot;10&quot;, &quot;ether&quot;),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\tawait tx.wait();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t////////////////////////////////////////////////</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t// SAMPLE SWAP TEST (swaps 2 USDC for cNOTE)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t////////////////////////////////////////////////</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -300,9 +353,9 @@ describe(&quot;Liquidity Mining Tests&quot;, function () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\tconst dexBalAfter = await ethers.provider.getBalance(dex.address);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\tconst ownerBalAfter = await ethers.provider.getBalance(owner.address);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-\t\t// expect dex to have 2 less CANTO since we claimed for 2 weeks worth of rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t// @audit Expect to have less CANTO rewards due to additional and not eligible for rewards liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\texpect(dexBalBefore.sub(dexBalAfter)).to.equal(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-\t\t\tBigNumber.from(&quot;2000000000000000000&quot;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\tBigNumber.from(&quot;501412401683494542&quot;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> \t});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> });</span></span></span></code></pre>\n<p>In the pool, there is only one position that meets the reward conditions, and there is also one position that does not meet the conditions.</p>\n<p>According to common sense, weekly rewards should be distributed to the only position that meets the reward conditions based on <code>rewardPerWeek</code>. However, in reality, you can see that the rewards that should be distributed every week have been reduced to <code>1/4</code> due to the ineligible position.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Hardhat</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Since the reward distribution of concentrated type rewards is conditionally restricted, the conditional restrictions should also be taken into account when calculating the total weight, rather than directly counting the total amount of liquidity.</p>\n<h3 id=\"assessed-type-4\" style=\"position:relative;\"><a href=\"#assessed-type-4\" aria-label=\"assessed type 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Context</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/94#issuecomment-1761327402\">OpenCoreCH (Canto) disputed and commented via duplicate Issue #94</a>:</strong></p>\n<blockquote>\n<p>Responding to this and <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/98\">#98</a> here:</p>\n<p>The warden seems to assume that <code>curve.concLiq_</code> is influenced by the width of a position, which is not the case. If someone creates a position with range [0, 1000] and liq. 100 or [480, 520] with liq. 100, <code>curve.concLiq_</code> will be 100 in both cases when the active tick is 500 (and not 0.1 &#x26; 2.5, which seems to be the assumption of the warden). This  can be seen in <code>TradeMatcher</code>, <code>LevelBook</code>, and <code>LiquidityMath</code>. The logic is not that simple, but the high level summary is that we store for every tick the liquidity (lots) of positions that have the lower / upper tick here (<code>lvl.bidLots_</code>, <code>lvl.askLots_</code>). When a tick is then crossed, the whole liquidity is added or removed from <code>curve.concLiq_</code>.</p>\n<p>However, it can also be easily verified by looking at our test. If the assumption of the warden were true, the user in the test (that has a position with width 30) would not receive 100% of the rewards, but only <code>1/30</code>. Because <code>concLiq_</code> works this way, the recommendation of the warden would break the system.</p>\n<p>Something that is true is point 1 from <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/98\">#98</a>. If a user has a very narrow position (less than 21 ticks), it still contributes to <code>curve.concLiq_</code>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/177#issuecomment-1768244629\">LSDan (judge) commented</a>:</strong></p>\n<blockquote>\n<p>TL;DR - in some cases reward amounts may be miscalculated, resulting in lower than expected reward amounts.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 37 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/264\">report highlighted below</a> by <strong>adriro</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/297\">radev_sw</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/137\">albahaca</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/32\">MatricksDeCoder</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/306\">JP_Courses</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/294\">0xDING99YA</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/279\">0xdice91</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/269\">Mike_Bello90</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/244\">0xTheC0der</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/242\">Eurovickk</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/231\">marqymarq10</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/220\">orion</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/210\">sces60107</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/206\">wahedtalash77</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/185\">xAriextz</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/180\">BoRonGod</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/174\">gzeon</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/162\">SovaSlava</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/150\">matrix_0wl</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/148\">3docSec</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/123\">taner2344</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/122\">Topmark</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/119\">0x3b</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/111\">cookedcookee</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/110\">HChang26</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/105\">100su</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/104\">zpan</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/90\">GKBG</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/89\">BRONZEDISC</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/81\">lukejohn</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/75\">IceBear</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/71\">hunter_w3b</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/65\">0xAadi</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/64\">pep7siup</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/61\">kutugu</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/40\">tpiliposian</a>, and <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/9\">0xWaitress</a>.</em></p>\n<h2 id=\"low-issue-summary\" style=\"position:relative;\"><a href=\"#low-issue-summary\" aria-label=\"low issue summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Issue Summary</h2>\n<table>\n<thead>\n<tr>\n<th align=\"center\">ID</th>\n<th align=\"left\">Issue</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">[L-01]</td>\n<td align=\"left\"><code>claimConcentratedRewards()</code> and <code>claimAmbientRewards()</code> should be an internal function</td>\n</tr>\n<tr>\n<td align=\"center\">[L-02]</td>\n<td align=\"left\">Governance check is commented out</td>\n</tr>\n<tr>\n<td align=\"center\">[L-03]</td>\n<td align=\"left\">Rewards can be unintentionally overridden</td>\n</tr>\n<tr>\n<td align=\"center\">[L-04]</td>\n<td align=\"left\">Unused rewards cannot be claimed back</td>\n</tr>\n<tr>\n<td align=\"center\">[L-05]</td>\n<td align=\"left\">Missing week validation while claiming rewards</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"non-critical-issue-summary\" style=\"position:relative;\"><a href=\"#non-critical-issue-summary\" aria-label=\"non critical issue summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non Critical Issue Summary</h2>\n<table>\n<thead>\n<tr>\n<th align=\"center\">ID</th>\n<th align=\"left\">Issue</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">[N-01]</td>\n<td align=\"left\">Use Solidity time units</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"low-issues\" style=\"position:relative;\"><a href=\"#low-issues\" aria-label=\"low issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Issues</h2>\n<h2 id=\"l-01-claimconcentratedrewards-and-claimambientrewards-should-be-an-internal-function\" style=\"position:relative;\"><a href=\"#l-01-claimconcentratedrewards-and-claimambientrewards-should-be-an-internal-function\" aria-label=\"l 01 claimconcentratedrewards and claimambientrewards should be an internal function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] <code>claimConcentratedRewards()</code> and <code>claimAmbientRewards()</code> should be an internal function</h2>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L54\">https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L54</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L61\">https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L61</a></li>\n</ul>\n<p>Both of these functions present in the <code>LiquidityMiningPath</code> contract are intended to be called via user commands, whose entry point is the <code>userCmd()</code> function.</p>\n<p>Consider changing the visibility of <code>claimConcentratedRewards()</code> and <code>claimAmbientRewards()</code> to internal or private.</p>\n<h2 id=\"l-02-governance-check-is-commented-out\" style=\"position:relative;\"><a href=\"#l-02-governance-check-is-commented-out\" aria-label=\"l 02 governance check is commented out permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Governance check is commented out</h2>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L66\">https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L66</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L75\">https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L75</a></li>\n</ul>\n<p>Both <code>setConcRewards()</code> and <code>setAmbRewards()</code> have a privilege check that is commented out and currently ignored:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// require(msg.sender == governance_, &quot;Only callable by governance&quot;);</span></span></span></code></pre>\n<p>These functions are called as protocol commands, which undergo a privilege check in the entry point (see <a href=\"https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/CrocSwapDex.sol#L104\">here</a>), hence the low severity of this issue. </p>\n<p>However, it is not clear if there’s a missing additional check to ensure these are called by the governance. Consider either removing the lines or un-commenting the check.</p>\n<h2 id=\"l-03-rewards-can-be-unintentionally-overridden\" style=\"position:relative;\"><a href=\"#l-03-rewards-can-be-unintentionally-overridden\" aria-label=\"l 03 rewards can be unintentionally overridden permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Rewards can be unintentionally overridden</h2>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L65\">https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L65</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L74\">https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L74</a></li>\n</ul>\n<p>Lidiquity mining rewards are set up using <code>setConcRewards()</code> or <code>setAmbRewards()</code>. In both cases, the rewards are overridden instead of accumulated. Taking <code>setConcRewards()</code> as the <a href=\"https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/callpaths/LiquidityMiningPath.sol#L65-L72\">example</a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">65</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setConcRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">poolIdx</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weekTo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeklyReward</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">66</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">// require(msg.sender == governance_, &quot;Only callable by governance&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">67</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\"> % </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">weekTo</span><span class=\"mtk1\"> % </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid weeks&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">68</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">while</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">weekTo</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">69</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">concRewardPerWeek_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolIdx</span><span class=\"mtk1\">][</span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">weeklyReward</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">70</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">weekFrom</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">71</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">72</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>Line 69 assigns the new value <code>weeklyReward</code> to the storage mapping. If rewards were already set for this pool, i.e. <code>concRewardPerWeek_[poolIdx][weekFrom] != 0</code>, then the new assignment will override the existing value.</p>\n<h2 id=\"l-04-unused-rewards-cannot-be-claimed-back\" style=\"position:relative;\"><a href=\"#l-04-unused-rewards-cannot-be-claimed-back\" aria-label=\"l 04 unused rewards cannot be claimed back permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Unused rewards cannot be claimed back</h2>\n<p>Although highly unlikely, there is no provided mechanism to claim back unused rewards assigned to periods of time of inactivity in the pool.</p>\n<h2 id=\"l-05-missing-week-validation-while-claiming-rewards\" style=\"position:relative;\"><a href=\"#l-05-missing-week-validation-while-claiming-rewards\" aria-label=\"l 05 missing week validation while claiming rewards permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] Missing week validation while claiming rewards</h2>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/mixins/LiquidityMining.sol#L156\">https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/mixins/LiquidityMining.sol#L156</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/mixins/LiquidityMining.sol#L256\">https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/mixins/LiquidityMining.sol#L256</a></li>\n</ul>\n<p>In <code>claimConcentratedRewards()</code> and <code>claimAmbientRewards()</code>, the implementation takes an array of the weeks which are expected to be claimed. This is user input, and lacks any validation over the provided argument values.</p>\n<p>Using <code>claimConcentratedRewards()</code> as the example, we can see each element in <code>weeksToClaim</code> is not checked to be an actual <em>week</em>, i.e. that <code>week % WEEK == 0</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">174</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">weeksToClaim</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">175</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">uint32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">week</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">weeksToClaim</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">176</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">week</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Week not over yet&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">177</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">178</span><span class=\"mtk1\">:                 !</span><span class=\"mtk12\">concLiquidityRewardsClaimed_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolIdx</span><span class=\"mtk1\">][</span><span class=\"mtk12\">posKey</span><span class=\"mtk1\">][</span><span class=\"mtk12\">week</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">179</span><span class=\"mtk1\">:                 </span><span class=\"mtk8\">&quot;Already claimed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">180</span><span class=\"mtk1\">:             );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">181</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">overallInRangeLiquidity</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">timeWeightedWeeklyGlobalConcLiquidity_</span><span class=\"mtk1\">[</span><span class=\"mtk12\">poolIdx</span><span class=\"mtk1\">][</span><span class=\"mtk12\">week</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<p>Consider adding an explicit check to ensure the elements in <code>weeksToClaim</code> are valid weeks.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint32 week = weeksToClaim[i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    require(week + WEEK &lt; block.timestamp, &quot;Week not over yet&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   require(week % WEEK == 0, &quot;Invalid week&quot;);</span></span></span></code></pre>\n<h2 id=\"non-critical-issues\" style=\"position:relative;\"><a href=\"#non-critical-issues\" aria-label=\"non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non Critical Issues</h2>\n<h2 id=\"n-01-use-solidity-time-units\" style=\"position:relative;\"><a href=\"#n-01-use-solidity-time-units\" aria-label=\"n 01 use solidity time units permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Use Solidity time units</h2>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/mixins/LiquidityMining.sol#L13\">https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/mixins/LiquidityMining.sol#L13</a></li>\n</ul>\n<p>Instead of defining spans of time manually using seconds, consider using Solidity built-in <a href=\"https://docs.soliditylang.org/en/v0.8.21/units-and-global-variables.html#time-units\">time units</a>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/264#issuecomment-1761330903\">OpenCoreCH (Canto) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/264#issuecomment-1771375611\">LSDan (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I agree with all reported issues and their severity.</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this audit, 16 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/293\">report highlighted below</a> by <strong>niser93</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/282\">0xAnah</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/258\">JCK</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/233\">hihen</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/307\">naman1778</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/291\">SAQ</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/281\">SY_S</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/278\">tabriz</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/168\">shamsulhaq123</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/147\">pipidu83</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/141\">Raihan</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/92\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/70\">hunter_w3b</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/49\">MatricksDeCoder</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/42\">Polaris_tow</a>, and <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/19\">debo</a>.</em></p>\n<h2 id=\"gas-optimizations-1\" style=\"position:relative;\"><a href=\"#gas-optimizations-1\" aria-label=\"gas optimizations 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h2>\n<table>\n<thead>\n<tr>\n<th align=\"center\">ID</th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n<th align=\"center\">Total Gas Saved</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">[G-01]</td>\n<td align=\"left\">Remove ternary operator in order to use unchecked and <code>>=</code> instead of <code>&#x3C;</code></td>\n<td align=\"center\">1</td>\n<td align=\"center\">4526</td>\n</tr>\n<tr>\n<td align=\"center\">[G-02]</td>\n<td align=\"left\">State variable read in a loop</td>\n<td align=\"center\">5</td>\n<td align=\"center\">1908</td>\n</tr>\n<tr>\n<td align=\"center\">[G-03]</td>\n<td align=\"left\">Using ternary operator instead of <code>if/else</code></td>\n<td align=\"center\">1</td>\n<td align=\"center\">1896</td>\n</tr>\n<tr>\n<td align=\"center\">[G-04]</td>\n<td align=\"left\">Using a positive conditional flow to save a NOT opcode</td>\n<td align=\"center\">1</td>\n<td align=\"center\">2750</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 8 instances over 4 issues with <strong>11080 gas</strong> saved.</p>\n<p>Gas totals are estimates using <code>npx hardhat test</code> and <code>hardhat-gas-reporter</code>.</p>\n<h2 id=\"g-01-remove-ternary-operator-in-order-to-use-unchecked-and--instead-of-\" style=\"position:relative;\"><a href=\"#g-01-remove-ternary-operator-in-order-to-use-unchecked-and--instead-of-\" aria-label=\"g 01 remove ternary operator in order to use unchecked and  instead of  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Remove ternary operator in order to use unchecked and <code>>=</code> instead of <code>&#x3C;</code></h2>\n<p>Estimated saving:\n| Method call or Contract deployment | Before | After | After - Before | (After - Before) / Before |\n| :- | :-: | :-: | :-: | :-: |\n| <code>LiquidityMiningPath</code> | 1540432 | 1535906 | -4526 | -0.29% |</p>\n<p>There is 1 instance of this issue:</p>\n<p>[<a href=\"https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L53-L57\">53-57</a>]             </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: LiquidityMining.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   uint32 dt = uint32(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       nextWeek &lt; block.timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-           ? nextWeek - time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-           : block.timestamp - time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   uint32 dt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   if(nextWeek &gt;= block.timestamp) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       unchecked{dt = uint32(block.timestamp - time);}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   else{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       unchecked{dt = uint32(nextWeek - time);}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   }</span></span></span></code></pre>\n<h2 id=\"g-02-state-variable-read-in-a-loop\" style=\"position:relative;\"><a href=\"#g-02-state-variable-read-in-a-loop\" aria-label=\"g 02 state variable read in a loop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] State variable read in a loop</h2>\n<p>The state variable should be cached in a local variable rather than reading it on every iteration of the <code>for-loop</code>, which will replace each Gwarmaccess (<strong>100 gas</strong>) with a much cheaper stack read.</p>\n<p>Estimated saving:\n| Method call or Contract deployment | Before | After | After - Before | (After - Before) / Before |\n| :- | :-: | :-: | :-: | :-: |\n| <code>LiquidityMiningPath</code> | 1540432 | 1538524 | -1908 | -0.12% |</p>\n<p>There are 5 instances of this issue:</p>\n<p>[<a href=\"https://github.com/code-423n4/2023-10-canto/blob/29c92a926453a49c8935025a4d3de449150fc2ff/canto_ambient/contracts/mixins/LiquidityMining.sol#L87-L97\">87-97</a>]</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: LiquidityMining.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 liquidity = pos.liquidity_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   uint256 wweek = WEEK;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    for (int24 i = lowerTick + 10; i &lt;= upperTick - 10; ++i) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint32 tickTrackingIndex = tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint32 origIndex = tickTrackingIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint32 numTickTracking = uint32(tickTracking_[poolIdx][i].length);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint32 time = lastAccrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // Loop through all in-range time spans for the tick or up to the current time (if it is still in range)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        while (time &lt; block.timestamp &amp;&amp; tickTrackingIndex &lt; numTickTracking) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            TickTracking memory tickTracking = tickTracking_[poolIdx][i][tickTrackingIndex];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-              uint32 currWeek = uint32((time / WEEK) * WEEK);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-              uint32 nextWeek = uint32(((time + WEEK) / WEEK) * WEEK);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+               uint32 currWeek = uint32((time / WEEK) * WEEK);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+               uint32 nextWeek = uint32(((time + WEEK) / WEEK) * WEEK);</span></span></span></code></pre>\n<h2 id=\"g-03-using-ternary-operator-instead-of-ifelse\" style=\"position:relative;\"><a href=\"#g-03-using-ternary-operator-instead-of-ifelse\" aria-label=\"g 03 using ternary operator instead of ifelse permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Using ternary operator instead of <code>if/else</code></h2>\n<p>Estimated saving:\n| Method call or Contract deployment | Before | After | After - Before | (After - Before) / Before |\n| :- | :-: | :-: | :-: | :-: |\n| <code>LiquidityMiningPath</code> | 1540432 | 1538536 | -1896 | -0.12% |</p>\n<p>There is 1 instance of this issue:</p>\n<p>[<a href=\"https://github.com/code-423n4/2023-10-canto/blob/40edbe0c9558b478c84336aaad9b9626e5d99f34/canto_ambient/contracts/mixins/LiquidityMining.sol#L53-L57\">53-57</a>]</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: LiquidityMining.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   if (tickTracking.enterTimestamp &lt; time) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       // Tick was already active when last claim happened, only accrue from last claim timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       tickActiveStart = time;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       // Tick has become active this week</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       tickActiveStart = tickTracking.enterTimestamp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   tickActiveStart = tickTracking.enterTimestamp &gt;= time ? time : tickTracking.enterTimestamp;</span></span></span></code></pre>\n<h2 id=\"g-04-using-a-positive-conditional-flow-to-save-a-not-opcode\" style=\"position:relative;\"><a href=\"#g-04-using-a-positive-conditional-flow-to-save-a-not-opcode\" aria-label=\"g 04 using a positive conditional flow to save a not opcode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Using a positive conditional flow to save a NOT opcode</h2>\n<p>In order to save some gas (NOT opcode costing 3 gas), switch to a positive statement:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- if(!condition){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-     action1();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- }else{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-     action2();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ if(condition){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+     action2();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ }else{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+     action1();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ }</span></span></span></code></pre>\n<p>Estimated saving:\n| Method call or Contract deployment | Before | After | After - Before | (After - Before) / Before |\n| :- | :-: | :-: | :-: | :-: |\n| <code>LiquidityMiningPath</code> | 1540432 | 1537682 | -2750 | -0.18% |</p>\n<p>There is 1 instance of this issue:</p>\n<p>[<a href=\"https://github.com/code-423n4/2023-10-canto/blob/main/canto_ambient/contracts/mixins/LiquidityMining.sol#L86-L150\">86-150</a>]</p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: LiquidityMining.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  86           if (lastAccrued != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  87               uint256 liquidity = pos.liquidity_;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  88               for (int24 i = lowerTick + 10; i &lt;= upperTick - 10; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  89                   uint32 tickTrackingIndex = tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  90                   uint32 origIndex = tickTrackingIndex;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  91                   uint32 numTickTracking = uint32(tickTracking_[poolIdx][i].length);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  92                   uint32 time = lastAccrued;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  93                   // Loop through all in-range time spans for the tick or up to the current time (if it is still in range)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  94                   while (time &lt; block.timestamp &amp;&amp; tickTrackingIndex &lt; numTickTracking) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  95                       TickTracking memory tickTracking = tickTracking_[poolIdx][i][tickTrackingIndex];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  96                       uint32 currWeek = uint32((time / WEEK) * WEEK);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  97                       uint32 nextWeek = uint32(((time + WEEK) / WEEK) * WEEK);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  98                       uint32 dt = uint32(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  99                           nextWeek &lt; block.timestamp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  100                              ? nextWeek - time</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  101                              : block.timestamp - time</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  102                      );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  103                      uint32 tickActiveStart; // Timestamp to use for the liquidity addition</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  104                      uint32 tickActiveEnd;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  105                      if (tickTracking.enterTimestamp &lt; nextWeek) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  106                          // Tick was active before next week, need to add the liquidity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  107                          if (tickTracking.enterTimestamp &lt; time) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  108                              // Tick was already active when last claim happened, only accrue from last claim timestamp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  109                              tickActiveStart = time;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  110                          } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  111                              // Tick has become active this week</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  112                              tickActiveStart = tickTracking.enterTimestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  113                          }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  114                          if (tickTracking.exitTimestamp == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  115                              // Tick still active, do not increase index because we need to continue from here</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  116                              tickActiveEnd = uint32(nextWeek &lt; block.timestamp ? nextWeek : block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  117                          } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  118                              // Tick is no longer active</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  119                              if (tickTracking.exitTimestamp &lt; nextWeek) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  120                                  // Exit was in this week, continue with next tick</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  121                                  tickActiveEnd = tickTracking.exitTimestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  122                                  tickTrackingIndex++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  123                                  dt = tickActiveEnd - tickActiveStart;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  124                              } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  125                                  // Exit was in next week, we need to consider the current tick there (i.e. not increase the index)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  126                                  tickActiveEnd = nextWeek;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  127                              }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  128                          }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  129                          timeWeightedWeeklyPositionInRangeConcLiquidity_[poolIdx][posKey][currWeek][i] +=</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  130                              (tickActiveEnd - tickActiveStart) * liquidity;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  131                      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  132                      time += dt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  133                  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  134                  if (tickTrackingIndex != origIndex) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  135                      tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i] = tickTrackingIndex;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  136                  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  137              }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  138          } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  139              for (int24 i = lowerTick + 10; i &lt;= upperTick - 10; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  140                  uint32 numTickTracking = uint32(tickTracking_[poolIdx][i].length);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  141                  if (numTickTracking &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  142                      if (tickTracking_[poolIdx][i][numTickTracking - 1].exitTimestamp == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  143                          // Tick currently active</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  144                          tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i] = numTickTracking - 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  145                      } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  146                          tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i] = numTickTracking;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  147                      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  148                  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  149              }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  150          }</span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: LiquidityMining.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   86           if (lastAccrued != 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   87               uint256 liquidity = pos.liquidity_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   88               for (int24 i = lowerTick + 10; i &lt;= upperTick - 10; ++i) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   89                   uint32 tickTrackingIndex = tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   90                   uint32 origIndex = tickTrackingIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   91                   uint32 numTickTracking = uint32(tickTracking_[poolIdx][i].length);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   92                   uint32 time = lastAccrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   93                   // Loop through all in-range time spans for the tick or up to the current time (if it is still in range)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   94                   while (time &lt; block.timestamp &amp;&amp; tickTrackingIndex &lt; numTickTracking) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   95                       TickTracking memory tickTracking = tickTracking_[poolIdx][i][tickTrackingIndex];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   96                       uint32 currWeek = uint32((time / WEEK) * WEEK);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   97                       uint32 nextWeek = uint32(((time + WEEK) / WEEK) * WEEK);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   98                       uint32 dt = uint32(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   99                           nextWeek &lt; block.timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   100                              ? nextWeek - time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   101                              : block.timestamp - time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   102                      );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   103                      uint32 tickActiveStart; // Timestamp to use for the liquidity addition</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   104                      uint32 tickActiveEnd;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   105                      if (tickTracking.enterTimestamp &lt; nextWeek) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   106                          // Tick was active before next week, need to add the liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   107                          if (tickTracking.enterTimestamp &lt; time) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   108                              // Tick was already active when last claim happened, only accrue from last claim timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   109                              tickActiveStart = time;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   110                          } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   111                              // Tick has become active this week</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   112                              tickActiveStart = tickTracking.enterTimestamp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   113                          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   114                          if (tickTracking.exitTimestamp == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   115                              // Tick still active, do not increase index because we need to continue from here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   116                              tickActiveEnd = uint32(nextWeek &lt; block.timestamp ? nextWeek : block.timestamp);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   117                          } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   118                              // Tick is no longer active</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   119                              if (tickTracking.exitTimestamp &lt; nextWeek) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   120                                  // Exit was in this week, continue with next tick</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   121                                  tickActiveEnd = tickTracking.exitTimestamp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   122                                  tickTrackingIndex++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   123                                  dt = tickActiveEnd - tickActiveStart;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   124                              } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   125                                  // Exit was in next week, we need to consider the current tick there (i.e. not increase the index)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   126                                  tickActiveEnd = nextWeek;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   127                              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   128                          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   129                          timeWeightedWeeklyPositionInRangeConcLiquidity_[poolIdx][posKey][currWeek][i] +=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   130                              (tickActiveEnd - tickActiveStart) * liquidity;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   131                      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   132                      time += dt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   133                  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   134                  if (tickTrackingIndex != origIndex) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   135                      tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i] = tickTrackingIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   136                  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   137              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   138          } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   139              for (int24 i = lowerTick + 10; i &lt;= upperTick - 10; ++i) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   140                  uint32 numTickTracking = uint32(tickTracking_[poolIdx][i].length);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   141                  if (numTickTracking &gt; 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   142                      if (tickTracking_[poolIdx][i][numTickTracking - 1].exitTimestamp == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   143                          // Tick currently active</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   144                          tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i] = numTickTracking - 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   145                      } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   146                          tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i] = numTickTracking;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   147                      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   148                  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   149              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   150          }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   86             if (lastAccrued == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   87                 for (int24 i = lowerTick + 10; i &lt;= upperTick - 10; ++i) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   88                     uint32 numTickTracking = uint32(tickTracking_[poolIdx][i].length);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   89                     if (numTickTracking &gt; 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   90                         if (tickTracking_[poolIdx][i][numTickTracking - 1].exitTimestamp == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   91                             // Tick currently active</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   92                             tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i] = numTickTracking - 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   93                         } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   94                             tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i] = numTickTracking;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   95                         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   96                     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   97                 }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   98             } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   99                 uint256 liquidity = pos.liquidity_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   100                 for (int24 i = lowerTick + 10; i &lt;= upperTick - 10; ++i) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   101                     uint32 tickTrackingIndex = tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   102                     uint32 origIndex = tickTrackingIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   103                     uint32 numTickTracking = uint32(tickTracking_[poolIdx][i].length);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   104                     uint32 time = lastAccrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   105                     // Loop through all in-range time spans for the tick or up to the current time (if it is still in range)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   106                     while (time &lt; block.timestamp &amp;&amp; tickTrackingIndex &lt; numTickTracking) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   107                         TickTracking memory tickTracking = tickTracking_[poolIdx][i][tickTrackingIndex];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   108                         uint32 currWeek = uint32((time / WEEK) * WEEK);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   109                         uint32 nextWeek = uint32(((time + WEEK) / WEEK) * WEEK);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   110                         uint32 dt = uint32(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   111                             nextWeek &lt; block.timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   112                                 ? nextWeek - time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   113                                 : block.timestamp - time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   114                         );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   115                         uint32 tickActiveStart; // Timestamp to use for the liquidity addition</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   116                         uint32 tickActiveEnd;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   117                         if (tickTracking.enterTimestamp &lt; nextWeek) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   118                             // Tick was active before next week, need to add the liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   119                             if (tickTracking.enterTimestamp &lt; time) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   120                                 // Tick was already active when last claim happened, only accrue from last claim timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   121                                 tickActiveStart = time;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   122                             } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   123                                 // Tick has become active this week</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   124                                 tickActiveStart = tickTracking.enterTimestamp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   125                             }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   126                             if (tickTracking.exitTimestamp == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   127                                 // Tick still active, do not increase index because we need to continue from here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   128                                 tickActiveEnd = uint32(nextWeek &lt; block.timestamp ? nextWeek : block.timestamp);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   129                             } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   130                                 // Tick is no longer active</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   131                                 if (tickTracking.exitTimestamp &lt; nextWeek) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   132                                     // Exit was in this week, continue with next tick</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   133                                     tickActiveEnd = tickTracking.exitTimestamp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   134                                     tickTrackingIndex++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   135                                     dt = tickActiveEnd - tickActiveStart;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   136                                 } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   137                                     // Exit was in next week, we need to consider the current tick there (i.e. not increase the index)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   138                                     tickActiveEnd = nextWeek;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   139                                 }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   140                             }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   141                             timeWeightedWeeklyPositionInRangeConcLiquidity_[poolIdx][posKey][currWeek][i] +=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   142                                 (tickActiveEnd - tickActiveStart) * liquidity;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   143                         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   144                         time += dt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   145                     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   146                     if (tickTrackingIndex != origIndex) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   147                         tickTrackingIndexAccruedUpTo_[poolIdx][posKey][i] = tickTrackingIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   148                     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   149                 }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   150             }</span></span></span></code></pre>\n</details>\n<hr>\n<h1 id=\"audit-analysis\" style=\"position:relative;\"><a href=\"#audit-analysis\" aria-label=\"audit analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit Analysis</h1>\n<p>For this audit, 11 analysis reports were submitted by wardens. An analysis report examines the codebase as a whole, providing observations and advice on such topics as architecture, mechanism, or approach. The <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/230\">report highlighted below</a> by <strong>0xweb3boy</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/72\">hunter_w3b</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/304\">sandy</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/300\">0xdice91</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/299\">radev_sw</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/275\">Banditx0x</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/184\">JP_Courses</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/121\">ZanyBonzy</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/120\">cookedcookee</a>, <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/118\">albahaca</a>, and <a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/85\">invitedtea</a>.</em></p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<ol>\n<li>Executive Summary<br></li>\n<li>Code Audit Approach<br>\n2.1 Audit Documentation and Scope<br>\n2.2 Code review<br>\n2.3 Threat Modelling<br>\n2.4 Exploitation and Proofs of Concept<br>\n2.5 Report Issues<br></li>\n<li>Architecture overview<br>\n3.1 Overview of Liquidity Mining Feature by Canto for Ambient Finance<br>\n3.2  Key Contracts Introduced<br>\n3.3 Incentive Mechanism<br>\n3.4 Liquidity Mining Rewards<br>\n3.5 Reward Distribution Example<br>\n3.6 Setting Weekly Reward Rate<br></li>\n<li>Implementation Notes<br>\n4.1 General Impressions<br>\n4.2 Composition over Inheritance<br>\n4.3 Comments<br>\n4.4 Solidity Versions<br></li>\n<li>Conclusion</li>\n</ol>\n<h2 id=\"1-executive-summary\" style=\"position:relative;\"><a href=\"#1-executive-summary\" aria-label=\"1 executive summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Executive Summary</h2>\n<p>In focusing on the ongoing audit 2023-10-canto, my analysis starts by delineating the code audit methodology applied to the contracts within the defined scope. Subsequently, I provided insights into the architectural aspects, offering my perspective. Finally, I offered observations pertaining to the code implementation.</p>\n<p>I want to emphasize that unless expressly specified, any potential architectural risks or implementation concerns discussed in this document should not be construed as vulnerabilities or suggestions to modify the architecture or code based solely on this analysis. As an auditor, I recognize the necessity of a comprehensive evaluation of design choices in intricate projects, considering risks as only one component of a larger evaluative process. It’s essential to acknowledge that the project team may have already evaluated these risks and established the most appropriate approach to mitigate or coexist with them.</p>\n<h2 id=\"2-code-audit-approach\" style=\"position:relative;\"><a href=\"#2-code-audit-approach\" aria-label=\"2 code audit approach permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Code Audit Approach</h2>\n<h3 id=\"21-audit-documentation-and-scope\" style=\"position:relative;\"><a href=\"#21-audit-documentation-and-scope\" aria-label=\"21 audit documentation and scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 Audit Documentation and Scope</h3>\n<p>Commencing the analysis, the first phase entailed a thorough review of the <a href=\"https://github.com/code-423n4/2023-10-canto/tree/main\">repo</a> to fully grasp the fundamental concepts and limitations of the audit. This initial step was crucial in guiding the prioritization of my audit efforts. Notably, the README associated with this audit stands out for its excellent quality, offering valuable insights and actionable guidance that significantly streamline the onboarding process for auditors.</p>\n<h3 id=\"22-code-review\" style=\"position:relative;\"><a href=\"#22-code-review\" aria-label=\"22 code review permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 Code review</h3>\n<p>Initiating the code review, the starting point involved gaining a comprehensive understanding of “LiquidityMining.sol,” a pivotal component responsible for implementing a liquidity mining protocol for Ambient. Canto’s strategic intention is to leverage this sidecar mechanism to incentivize liquidity provision for Ambient pools deployed on their platform. This understanding of the core pattern significantly facilitated the comprehension of the protocol contracts and their interconnections. During this phase, meticulous documentation of observations and the formulation of pertinent questions regarding potential exploits were undertaken, striking a balance between depth and breadth of analysis.</p>\n<h3 id=\"23-threat-modelling\" style=\"position:relative;\"><a href=\"#23-threat-modelling\" aria-label=\"23 threat modelling permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 Threat Modelling</h3>\n<p>The initial step involved crafting precise assumptions that, if breached, could present notable security risks to the system. This approach serves to guide the identification of optimal exploitation strategies. Although not an exhaustive threat modeling exercise, it closely aligns with the essence of such an analysis.</p>\n<h3 id=\"24-exploitation-and-proofs-of-concept\" style=\"position:relative;\"><a href=\"#24-exploitation-and-proofs-of-concept\" aria-label=\"24 exploitation and proofs of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.4 Exploitation and Proofs of Concept</h3>\n<p>Progressing from this juncture, the primary methodology took the form of a cyclic process, conditionally encompassing steps 2.2, 2.3, and 2.4. This involved iterative attempts at exploitation and the subsequent creation of proofs of concept, occasionally aided by available documentation or the helpful community on Discord. The key focus during this phase was to challenge fundamental assumptions, generate novel ones in the process, and refine the approach by utilizing coded proofs of concept to hasten the development of successful exploits.</p>\n<h3 id=\"25-report-issues\" style=\"position:relative;\"><a href=\"#25-report-issues\" aria-label=\"25 report issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.5 Report Issues</h3>\n<p>While this particular stage might initially appear straightforward, it harbors subtleties worth considering. Hastily reporting vulnerabilities and subsequently overlooking them is not a prudent course of action. The optimal approach to augment the value delivered to sponsors (and ideally, to auditors as well) entails thoroughly documenting the potential gains from exploiting each vulnerability. This comprehensive assessment aids in the determination of whether these exploits could be strategically amalgamated to generate a more substantial impact on the system’s security. It’s important to recognize that seemingly minor and moderate issues, when skillfully leveraged, can compound into a critical vulnerability. This assessment must be weighed against the risks that users might encounter. Within the realm of Code4rena audits, a heightened level of caution and an expedited reporting channel are accorded to zero-day vulnerabilities or highly sensitive bugs impacting deployed contracts.</p>\n<h2 id=\"3-architecture-overview\" style=\"position:relative;\"><a href=\"#3-architecture-overview\" aria-label=\"3 architecture overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Architecture overview</h2>\n<h3 id=\"31-overview-of-liquidity-mining-feature-by-canto-for-ambient-finance\" style=\"position:relative;\"><a href=\"#31-overview-of-liquidity-mining-feature-by-canto-for-ambient-finance\" aria-label=\"31 overview of liquidity mining feature by canto for ambient finance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 Overview of Liquidity Mining Feature by Canto for Ambient Finance</h3>\n<p>Introduction to the Feature: Canto, in its pursuit of enhancing liquidity dynamics, has introduced a new liquidity mining feature tailored specifically for Ambient Finance, a targeted approach to bolster the platform’s liquidity infrastructure.</p>\n<p>Integration through Sidecar Contract: The implementation strategy involves the creation of a sidecar contract meticulously designed to integrate into the Ambient ecosystem. This integration is achieved through the utilization of Ambient’s proxy contract pattern, a structured approach to seamlessly amalgamate the new liquidity mining feature.</p>\n<h3 id=\"32-key-contracts-introduced\" style=\"position:relative;\"><a href=\"#32-key-contracts-introduced\" aria-label=\"32 key contracts introduced permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 Key Contracts Introduced</h3>\n<p>LiquidityMiningPath.sol: This contract is pivotal in providing the essential interfaces, enabling seamless interactions for users interacting with the liquidity mining protocol.</p>\n<p>LiquidityMining.sol: This contract forms the operational backbone, encapsulating the logic and functionalities necessary for the effective operation of the liquidity mining feature.</p>\n<p><strong>Understanding the LiquidityMining Sidecar</strong><br>\nObjective of the Sidecar: The LiquidityMining sidecar is meticulously engineered to realize a robust liquidity mining protocol within the Ambient ecosystem. Canto envisions utilizing this sidecar to stimulate and incentivize liquidity contributions to the Ambient pools hosted on Canto’s platform.</p>\n<h3 id=\"33-incentive-mechanism\" style=\"position:relative;\"><a href=\"#33-incentive-mechanism\" aria-label=\"33 incentive mechanism permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.3 Incentive Mechanism</h3>\n<p>The sidecar employs an incentivization mechanism targeting a specific width of liquidity, primarily based on the current tick. Focused on stabilizing liquidity pools, the incentivization range spans from the current tick minus 10 to the current tick plus 10.</p>\n<p>To qualify for incentives, a user’s liquidity range must encompass at least 21 ticks, inclusive of the current tick and 10 ticks on each side.\nAdditionally, users are advised to maintain a slight buffer on either side of the stipulated range to ensure uninterrupted rewards, particularly in response to minor price fluctuations.</p>\n<h3 id=\"34-liquidity-mining-rewards\" style=\"position:relative;\"><a href=\"#34-liquidity-mining-rewards\" aria-label=\"34 liquidity mining rewards permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.4 Liquidity Mining Rewards</h3>\n<p>The core idea behind the liquidity mining sidecar centers on tracking the time-weighted liquidity across global and per-user levels.\nThis tracking is conducted for both ambient and concentrated positions on a per-tick basis.</p>\n<p>The protocol calculates the user’s proportion of in-range liquidity over a specific time span, subsequently disbursing this percentage of the global rewards to the user.</p>\n<h3 id=\"35-reward-distribution-example\" style=\"position:relative;\"><a href=\"#35-reward-distribution-example\" aria-label=\"35 reward distribution example permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.5 Reward Distribution Example</h3>\n<p>For illustrative purposes, if the weekly rewards amount to 10 CANTO and only LP A is contributing liquidity, “LP A” will receive the entire 10 CANTO as their reward. However, if there are multiple liquidity providers, such as “LP A” and “LP B”, who contribute liquidity throughout the week, the rewards will be shared evenly. In this scenario, each provider will receive 5 CANTO.\nImplementation Insights</p>\n<h3 id=\"36-setting-weekly-reward-rate\" style=\"position:relative;\"><a href=\"#36-setting-weekly-reward-rate\" aria-label=\"36 setting weekly reward rate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.6 Setting Weekly Reward Rate</h3>\n<p>The liquidity mining sidecar incorporates functions dedicated to setting the weekly reward rate. The reward rates are determined by establishing a total disbursement amount per week, providing the governing body the flexibility to choose the number of weeks for which the reward rate will be set.</p>\n<p>Focus on LiquidityMining.sol: The critical aspect of the implementation lies within the LiquidityMining.sol contract, housing the core logic for reward accumulation and claim processes. Auditors and wardens are strongly advised to direct their primary focus towards this segment of the codebase, recognizing its pivotal role in the successful operation of the liquidity mining feature.</p>\n<h2 id=\"4-implementation-notes\" style=\"position:relative;\"><a href=\"#4-implementation-notes\" aria-label=\"4 implementation notes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Implementation Notes</h2>\n<p>During the course of the audit, several noteworthy implementation details were identified, and among these, a significant subset holds potential value for the ongoing analysis.</p>\n<h3 id=\"41-general-impressions\" style=\"position:relative;\"><a href=\"#41-general-impressions\" aria-label=\"41 general impressions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1 General Impressions</h3>\n<p><strong>Overview of Ambient</strong></p>\n<p>Ambient Finance: Ambient is a single-contract decentralized exchange (dex) designed to facilitate liquidity provision in a flexible manner. It allows liquidity providers to deposit liquidity in either the “ambient” style (similar to uniV2) or the “concentrated” style (similar to uniV3) into any token pair.</p>\n<p>Main Contract: The primary contract in Ambient Finance is called <code>CrocSwapDex</code>. Users interact with this contract, and it is the main interface for all actions related to the protocol.</p>\n<p><strong>Sidecar Contracts</strong></p>\n<p>Ambient utilizes modular proxy contracts called “sidecars,” each responsible for a unique function within the protocol.</p>\n<p>Here are the sidecar contracts:</p>\n<ul>\n<li>BootPath: Special sidecar used to install other sidecar contracts.</li>\n<li>ColdPath: Handles the creation of new pools.</li>\n<li>WarmPath: Manages liquidity operations like minting and burning.</li>\n<li>LiquidityMiningPath: New sidecar developed by Canto to handle liquidity mining for both ambient and concentrated liquidity.</li>\n<li>KnockoutPath: Manages logic for knockout liquidity.</li>\n<li>LongPath: Contains logic for parsing and executing arbitrarily long compound orders.</li>\n<li>MicroPaths: Contains functions related to single atomic actions within a longer compound action on a pre-loaded pool’s liquidity curve.</li>\n<li>SafeModePath: Reserved for emergency mode.</li>\n</ul>\n<p><strong>Interacting with Ambient Contracts</strong></p>\n<p>User and Protocol Commands: Interaction with Ambient contracts is facilitated through two main functions:</p>\n<ul>\n<li><code>userCmd(uint16 callpath, bytes calldata cmd)</code>: Used by users for various actions.</li>\n<li><code>protocolCmd(uint16 callpath, bytes calldata cmd, bool sudo)</code>: Utilized for governance-related actions.</li>\n</ul>\n<p><code>Callpath Parameter</code>: The callpath parameter determines which sidecar contract receives the command. Different values correspond to different sidecar contracts, each serving a specific purpose.</p>\n<p><code>Command Encoding (cmd)</code>: The cmd parameter is ABI encoded calldata fed to the specified sidecar contract. The code parameter within cmd specifies the function to be called within the sidecar contract based on the desired action.</p>\n<h3 id=\"42-composition-over-inheritance\" style=\"position:relative;\"><a href=\"#42-composition-over-inheritance\" aria-label=\"42 composition over inheritance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2 Composition over Inheritance</h3>\n<p>Canto has used inheritance over composition because inheritance is a  prevalent choice due to the need for standardized behaviors and code reusability. Smart contracts often adhere to established standards such as ERC-20 or ERC-721, and inheritance facilitates the straightforward integration of these standards, promoting interoperability and adherence to well-defined interfaces. By centralizing common functionalities in a base contract and allowing other contracts to inherit these functionalities, developers can streamline deployment, reduce redundancy, and simplify interactions. In addition, this approach aids in efficient gas usage, aligning with the limitations imposed by the Ethereum Virtual Machine (EVM) contract size. Moreover, inheritance supports logical code organization and maintenance, enabling easier updates and enhancing readability by segregating related functionalities into distinct contracts.</p>\n<h3 id=\"43-comments\" style=\"position:relative;\"><a href=\"#43-comments\" aria-label=\"43 comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.3 Comments</h3>\n<p><strong>Importance of Comments for Clarity</strong></p>\n<p>Comments serve a pivotal role in enhancing the understandability of the codebase. While the code is generally clean and logically structured, judiciously placed comments can provide valuable insights into the functionalities and intentions behind the code. They contribute to a better comprehension of the code’s purpose, especially for auditors and developers involved in the analysis.</p>\n<p><strong>Strategic Comment Placement</strong></p>\n<p>The codebase would greatly benefit from an increased presence of comments, particularly within the <code>LiquidityMining.sol</code> contract. Strategic placement of comments within this essential contract can significantly aid auditors in comprehending the implementation details. These comments should elucidate the logic, processes, and methodologies employed, promoting a seamless audit experience.</p>\n<p><strong>Facilitating Audits and Code Readability</strong></p>\n<p>Comprehensive comments in the <code>LiquidityMining.sol</code> contract can expedite the auditing process by allowing auditors to swiftly grasp the intended functionality of the code. This, in turn, enhances the readability of the functions and methods, making it easier for auditors to identify any inconsistencies or deviations between the documented intentions and the actual code implementation.</p>\n<p><strong>Detecting Discrepancies in Code Intentions</strong></p>\n<p>An important aspect of code review is discerning any mismatches between the documented intentions in the comments and the actual code implementation. Comments that accurately reflect the code’s purpose are crucial for auditors, as discrepancies between the two can be indicators of potential vulnerabilities or errors. The act of aligning comments with the true code behavior is fundamental to ensuring the reliability and security of the smart contract.</p>\n<h3 id=\"44-solidity-versions\" style=\"position:relative;\"><a href=\"#44-solidity-versions\" aria-label=\"44 solidity versions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.4 Solidity Versions</h3>\n<p>Though there are valid arguments both in support of and against adopting the latest Solidity version, I find that this discussion bears little significance for the current state of the project. Without a doubt, choosing the most up-to-date version is a far superior decision when compared to the potential risks associated with outdated versions.</p>\n<h2 id=\"5-conclusion\" style=\"position:relative;\"><a href=\"#5-conclusion\" aria-label=\"5 conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. Conclusion</h2>\n<h3 id=\"positive-audit-experience\" style=\"position:relative;\"><a href=\"#positive-audit-experience\" aria-label=\"positive audit experience permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Positive Audit Experience</h3>\n<p>The process of auditing this codebase and evaluating its architectural choices has been thoroughly enjoyable and enriching. Navigating through the intricacies and nuances of the project has been enlightening, presenting an opportunity to delve into the complexities of the system.</p>\n<h3 id=\"strategic-simplifications-for-complexity-management\" style=\"position:relative;\"><a href=\"#strategic-simplifications-for-complexity-management\" aria-label=\"strategic simplifications for complexity management permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Strategic Simplifications for Complexity Management</h3>\n<p>Inherent complexity is a characteristic of many systems, especially those in the realm of blockchain and smart contracts. The strategic introduction of simplifications within this project has proven to be a valuable approach. These simplifications are well-thought-out and strategically implemented, demonstrating an understanding of how to manage complexity effectively.</p>\n<h3 id=\"achieving-a-harmonious-balance\" style=\"position:relative;\"><a href=\"#achieving-a-harmonious-balance\" aria-label=\"achieving a harmonious balance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Achieving a Harmonious Balance</h3>\n<p>A notable achievement of this project is striking a harmonious balance between the imperative for simplicity and the challenge of managing inherent complexity. This equilibrium is crucial in ensuring that the codebase remains comprehensible, maintainable, and scalable, even as the system becomes more intricate.</p>\n<h3 id=\"importance-of-methodology-overview\" style=\"position:relative;\"><a href=\"#importance-of-methodology-overview\" aria-label=\"importance of methodology overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Importance of Methodology Overview</h3>\n<p>The overview provided regarding the methodology employed during the audit of the contracts within the defined scope is invaluable. It offers a clear and structured insight into the analytical approach undertaken, shedding light on the depth and rigor of the evaluation process.</p>\n<h3 id=\"relevance-for-project-team-and-stakeholders\" style=\"position:relative;\"><a href=\"#relevance-for-project-team-and-stakeholders\" aria-label=\"relevance for project team and stakeholders permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Relevance for Project Team and Stakeholders</h3>\n<p>The insights presented are not only beneficial for the project team but also extend to any party with an interest in analyzing this codebase. The detailed observations, considerations, and recommendations have the potential to guide and inform decision-making, contributing to the project’s overall improvement and security.</p>\n<h3 id=\"time-spent\" style=\"position:relative;\"><a href=\"#time-spent\" aria-label=\"time spent permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Time spent</h3>\n<p>16 hours</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-canto-findings/issues/230#issuecomment-1757583243\">OpenCoreCH (Canto) acknowledged</a></strong></p>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-1\">High Risk Findings (1)</a></p>\n<ul>\n<li><a href=\"#h-01-array-length-of-ticktracking_-can-be-purposely-increased-to-brick-minting-and-burning-of-most-users-liquidity-positions\">[H-01] Array Length of <code>tickTracking_</code> can be purposely increased to Brick Minting and Burning of most users’ liquidity positions</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-5\">Medium Risk Findings (5)</a></p>\n<ul>\n<li><a href=\"#m-01-the-liquidity-mining-callpath-sidecar-owner-can-pull-native-tokens-from-the-dex\">[M-01] The Liquidity mining callpath sidecar owner can pull native tokens from the <code>Dex</code></a></li>\n<li><a href=\"#m-02-if-dt-is-not-updated-accurately-timeweightedweeklypositioninrangeconcliquidity_-might-be-updated-incorrectly\">[M-02] If <code>dt</code> is not updated accurately, <code>timeWeightedWeeklyPositionInRangeConcLiquidity_</code> might be updated incorrectly</a></li>\n<li><a href=\"#m-03-rewards-cannot-be-transferred-when-calling-protocol-command\">[M-03] Rewards cannot be transferred when calling protocol command</a></li>\n<li><a href=\"#m-04-accrued-liquidity-can-be-lost-and-never-be-recovered-for-a-given-tick-period-\">[M-04] Accrued liquidity can be lost and never be recovered for a given tick period. </a></li>\n<li><a href=\"#m-05-positions-that-are-not-eligible-for-rewards-will-affect-the-reward-income-of-eligible-positions\">[M-05] Positions that are not eligible for rewards will affect the reward income of eligible positions</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#low-issue-summary\">Low Issue Summary</a></li>\n<li><a href=\"#non-critical-issue-summary\">Non Critical Issue Summary</a></li>\n<li><a href=\"#low-issues\">Low Issues</a></li>\n<li><a href=\"#l-01-claimconcentratedrewards-and-claimambientrewards-should-be-an-internal-function\">L-01 <code>claimConcentratedRewards()</code> and <code>claimAmbientRewards()</code> should be an internal function</a></li>\n<li><a href=\"#l-02-governance-check-is-commented-out\">L-02 Governance check is commented out</a></li>\n<li><a href=\"#l-03-rewards-can-be-unintentionally-overridden\">L-03 Rewards can be unintentionally overridden</a></li>\n<li><a href=\"#l-04-unused-rewards-cannot-be-claimed-back\">L-04 Unused rewards cannot be claimed back</a></li>\n<li><a href=\"#l-05-missing-week-validation-while-claiming-rewards\">L-05 Missing week validation while claiming rewards</a></li>\n<li><a href=\"#non-critical-issues\">Non Critical Issues</a></li>\n<li><a href=\"#n-01-use-solidity-time-units\">N-01 Use Solidity time units</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#gas-optimizations-1\">Gas Optimizations</a></li>\n<li><a href=\"#g-01-remove-ternary-operator-in-order-to-use-unchecked-and--instead-of-\">G-01 Remove ternary operator in order to use unchecked and <code>>=</code> instead of <code>&#x3C;</code></a></li>\n<li><a href=\"#g-02-state-variable-read-in-a-loop\">G-02 State variable read in a loop</a></li>\n<li><a href=\"#g-03-using-ternary-operator-instead-of-ifelse\">G-03 Using ternary operator instead of <code>if/else</code></a></li>\n<li><a href=\"#g-04-using-a-positive-conditional-flow-to-save-a-not-opcode\">G-04 Using a positive conditional flow to save a NOT opcode</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#audit-analysis\">Audit Analysis</a></p>\n<ul>\n<li><a href=\"#table-of-contents\">Table of Contents</a></li>\n<li><a href=\"#1-executive-summary\">1. Executive Summary</a></li>\n<li><a href=\"#2-code-audit-approach\">2. Code Audit Approach</a></li>\n<li><a href=\"#3-architecture-overview\">3. Architecture overview</a></li>\n<li><a href=\"#4-implementation-notes\">4. Implementation Notes</a></li>\n<li><a href=\"#5-conclusion\">5. Conclusion</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}